# 五行条形图 - 正确算法说明 ✅

## 🎯 算法逻辑

### 1. 统计每个五行的数量

假设从藏干统计中得到：

```
金：5 个
木：1 个
水：4 个
火：1 个
土：5 个
```

---

### 2. 找出最大值（满格基准）

```typescript
const maxCount = Math.max(5, 1, 4, 1, 5) = 5
```

这个 `maxCount` 就是每根柱子的"满格"基准。

---

### 3. 计算每根柱子的比例

```typescript
ratio = 该五行数量 / maxCount
```

代入示例：

| 五行 | 数量 | 计算 | 比例 | 视觉效果 |
|------|------|------|------|----------|
| 金 | 5 | 5/5 | 1.0 | ▓▓▓▓▓▓▓▓▓▓ (满格) |
| 木 | 1 | 1/5 | 0.2 | ▓▓░░░░░░░░ (很短) |
| 水 | 4 | 4/5 | 0.8 | ▓▓▓▓▓▓▓▓░░ (中偏长) |
| 火 | 1 | 1/5 | 0.2 | ▓▓░░░░░░░░ (很短) |
| 土 | 5 | 5/5 | 1.0 | ▓▓▓▓▓▓▓▓▓▓ (满格) |

---

### 4. 美化调整（可选）

为了更好的视觉效果：

```typescript
// 不让 0 变成完全没条
const minRatio = count > 0 ? 0.15 : 0;

// 不让满格真的贴边
const maxRatio = 0.95;

// 最终比例
const finalRatio = Math.max(Math.min(ratio, maxRatio), minRatio);

// 转成宽度百分比
const percent = finalRatio * 100;
```

**效果**：
- 数量为 5（最大）的柱子显示为 95%（接近满格，留一点边距）
- 数量为 1 的柱子显示为 15%（保证能看到一小截）
- 数量为 0 的柱子显示为 0%（完全不显示）

---

## ❌ 错误算法对比

### 错误算法：按总数百分比

```typescript
// ❌ 错误
const total = 金 + 木 + 水 + 火 + 土 = 5+1+4+1+5 = 16
const percent = count / total * 100

金：5/16 = 31.25%
木：1/16 = 6.25%
水：4/16 = 25%
火：1/16 = 6.25%
土：5/16 = 31.25%
```

**问题**：
- 所有柱子加起来是 100%
- 即使某个五行数量最多，也可能只显示 30% 左右
- 视觉上看不出"谁是最强的"

### 正确算法：按最大值比例

```typescript
// ✅ 正确
const maxCount = 5
const ratio = count / maxCount

金：5/5 = 100%（接近满格）→ 95%
木：1/5 = 20% → 20%
水：4/5 = 80% → 80%
火：1/5 = 20% → 20%
土：5/5 = 100%（接近满格）→ 95%
```

**优势**：
- ✅ 数量最多的直接到满格
- ✅ 其他的按比例缩放
- ✅ 视觉上一眼就能看出强弱对比

---

## 💻 代码实现

```typescript
// 1. 统计五行分布
const wuxingStats = useMemo(() => {
  const stats: Record<string, number> = { 
    '木': 0, '火': 0, '土': 0, '金': 0, '水': 0 
  };
  
  Object.entries(hiddenStems).forEach(([stem, count]) => {
    const wuxing = STEM_WUXING_MAP[stem];
    if (wuxing) {
      stats[wuxing] += count;
    }
  });
  
  return stats;
}, [hiddenStems]);

// 2. 找出最大值
const maxCount = Math.max(...Object.values(wuxingStats), 1); // 至少为 1，避免除以 0

// 3. 渲染条形图
{['木', '火', '土', '金', '水'].map((wuxing) => {
  const count = wuxingStats[wuxing] || 0;
  
  // 计算比例：该五行数量 / 最大值
  const ratio = count / maxCount;
  
  // 美化：最少 15%，最多 95%
  const finalRatio = Math.max(
    Math.min(ratio, 0.95), 
    count > 0 ? 0.15 : 0
  );
  
  const percent = finalRatio * 100;
  
  return (
    <View style={styles.barRow}>
      <Text>{wuxing}</Text>
      <View style={styles.barTrack}>
        <View style={[styles.barFill, { width: `${percent}%` }]} />
      </View>
      <Text>{count}</Text>
    </View>
  );
})}
```

---

## 📊 视觉示例

### 示例 1：金土最强

```
金 ▓▓▓▓▓▓▓▓▓░  5  ← 95%（满格）
木 ▓▓░░░░░░░░  1  ← 15%（保底）
水 ▓▓▓▓▓▓▓▓░░  4  ← 80%
火 ▓▓░░░░░░░░  1  ← 15%（保底）
土 ▓▓▓▓▓▓▓▓▓░  5  ← 95%（满格）
```

### 示例 2：水独大

```
金 ▓▓░░░░░░░░  1  ← 15%（保底）
木 ▓▓░░░░░░░░  1  ← 15%（保底）
水 ▓▓▓▓▓▓▓▓▓░  8  ← 95%（满格）
火 ▓░░░░░░░░░  0  ← 0%（不显示）
土 ▓▓▓▓░░░░░░  3  ← 37.5%
```

### 示例 3：五行平衡

```
金 ▓▓▓▓▓▓▓▓▓░  3  ← 95%（满格）
木 ▓▓▓▓▓▓▓░░░  2  ← 63%
水 ▓▓▓▓▓▓▓▓▓░  3  ← 95%（满格）
火 ▓▓▓▓▓▓▓░░░  2  ← 63%
土 ▓▓▓▓▓▓▓▓▓░  3  ← 95%（满格）
```

---

## ✅ 总结

| 项目 | 说明 |
|------|------|
| **基准值** | 五行中的最大数量 |
| **计算公式** | 该五行数量 / 最大值 |
| **美化范围** | 15% ~ 95% |
| **视觉效果** | 最强的接近满格，其他按比例显示 |
| **用户体验** | 一眼看出五行强弱对比 |

---

**更新时间**：2025-12-02  
**修改文件**：`app/src/components/bazi/HiddenStemsCard.tsx`


