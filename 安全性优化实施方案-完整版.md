# å°ä½© App å®‰å…¨æ€§ä¼˜åŒ–å®æ–½æ–¹æ¡ˆï¼ˆå®Œæ•´ç‰ˆï¼‰

## æ–‡æ¡£è¯´æ˜

**ç‰ˆæœ¬**ï¼šv2.0  
**æ—¥æœŸ**ï¼š2024-12-XX  
**ç›®æ ‡**ï¼šæä¾›å¯ç›´æ¥å®æ–½çš„å®‰å…¨ä¼˜åŒ–æ–¹æ¡ˆï¼Œç¡®ä¿å¼€å‘ç¯å¢ƒä¾¿åˆ©æ€§ä¸ç”Ÿäº§ç¯å¢ƒå®‰å…¨æ€§

**è®¾è®¡åŸåˆ™**ï¼š
1. **ç¯å¢ƒé©±åŠ¨çš„è¡Œä¸ºå·®å¼‚**ï¼šDev å¯å·æ‡’ï¼ŒProd å¿…é¡»ä¸¥æ ¼
2. **Fail Fast & Fail Closed**ï¼šç¼ºå°‘å…³é”®é…ç½®ç›´æ¥æ‹’ç»å¯åŠ¨
3. **é…ç½®é›†ä¸­ç®¡ç†**ï¼šæ‰€æœ‰å±é™©å¼€å…³ç»Ÿä¸€åœ¨ config å±‚

---

## ç›®å½•

1. [å½“å‰å®‰å…¨çŠ¶æ€è¯„ä¼°](#å½“å‰å®‰å…¨çŠ¶æ€è¯„ä¼°)
2. [æ ¸å¿ƒå®‰å…¨æœºåˆ¶è®¾è®¡](#æ ¸å¿ƒå®‰å…¨æœºåˆ¶è®¾è®¡)
3. [å®æ–½æ­¥éª¤ä¸ä»£ç æ”¹é€ ](#å®æ–½æ­¥éª¤ä¸ä»£ç æ”¹é€ )
4. [ç¯å¢ƒé…ç½®è§„èŒƒ](#ç¯å¢ƒé…ç½®è§„èŒƒ)
5. [å®‰å…¨æ£€æŸ¥æ¸…å•](#å®‰å…¨æ£€æŸ¥æ¸…å•)
6. [é™„å½•ï¼šå®Œæ•´ä»£ç å®ç°](#é™„å½•å®Œæ•´ä»£ç å®ç°)

---

## å½“å‰å®‰å…¨çŠ¶æ€è¯„ä¼°

### ğŸ”´ ä¸¥é‡é£é™©ï¼ˆP0 - å¿…é¡»ç«‹å³ä¿®å¤ï¼‰

| é£é™©é¡¹ | ä½ç½® | å½±å“ | çŠ¶æ€ |
|--------|------|------|------|
| JWT Secret ä½¿ç”¨é»˜è®¤å€¼ | `core/src/modules/auth/authService.ts:19` | Token å¯è¢«ä¼ªé€ ï¼Œæ”»å‡»è€…å¯å†’å……ä»»ä½•ç”¨æˆ· | ğŸ”´ æœªä¿®å¤ |
| å›ºå®šéªŒè¯ç  `123456` | `core/src/modules/auth/authService.ts:140` | ä»»ä½•äººéƒ½å¯ä»¥ç™»å½•ï¼Œå®Œå…¨ç»•è¿‡éªŒè¯ | ğŸ”´ æœªä¿®å¤ |
| Android Release ä½¿ç”¨ Debug Keystore | `app/android/app/build.gradle:115` | åº”ç”¨æ— æ³•æ›´æ–°ï¼Œç­¾åä¸å®‰å…¨ | ğŸ”´ æœªä¿®å¤ |
| Token æ˜æ–‡å­˜å‚¨ | `app/src/utils/tokenStorage.ts` | è®¾å¤‡ root/jailbreak åå¯è¯»å– | ğŸ”´ æœªä¿®å¤ |

### âš ï¸ é«˜é£é™©ï¼ˆP1 - å»ºè®®å°½å¿«ä¿®å¤ï¼‰

| é£é™©é¡¹ | ä½ç½® | å½±å“ | çŠ¶æ€ |
|--------|------|------|------|
| éªŒè¯ç æ˜æ–‡å­˜å‚¨ | æ•°æ®åº“ `verification_codes` è¡¨ | æ•°æ®åº“æ³„éœ²æ—¶éªŒè¯ç æš´éœ² | âš ï¸ æœªä¿®å¤ |
| å¼€å‘ç¯å¢ƒ CORS å®Œå…¨å¼€æ”¾ | `core/src/server.ts:31-34` | å¼€å‘ç¯å¢ƒå¯èƒ½è¢«æ»¥ç”¨ | âš ï¸ æœªä¿®å¤ |
| ProGuard è§„åˆ™ä¸è¶³ | `app/android/app/proguard-rules.pro` | ä»£ç å®¹æ˜“è¢«åç¼–è¯‘ | âš ï¸ æœªä¿®å¤ |
| éªŒè¯ç æ¥å£æ— é¢å¤–é™æµ | `core/src/routes/auth.ts:84` | å¯èƒ½è¢«æ»¥ç”¨å‘é€å¤§é‡éªŒè¯ç  | âš ï¸ æœªä¿®å¤ |
| ç™»å‡ºæ¥å£æœªå®ç° Token é»‘åå• | `core/src/routes/auth.ts:223` | ç™»å‡ºå Token ä»å¯ä½¿ç”¨ | âš ï¸ æœªä¿®å¤ |

### ğŸ“‹ ä¸­ä½é£é™©ï¼ˆP2 - å¯é€æ­¥ä¼˜åŒ–ï¼‰

- é™æµåŸºäºæ—¥æœŸï¼Œå¯èƒ½è¢«æ—¶åŒºç»•è¿‡
- é”™è¯¯ä¿¡æ¯å¯èƒ½æ³„éœ²å †æ ˆ
- æ—¥å¿—å¯èƒ½æ³„éœ²æ•æ„Ÿä¿¡æ¯
- API Base URL ç¡¬ç¼–ç 
- Android allowBackup å¼€å¯

---

## æ ¸å¿ƒå®‰å…¨æœºåˆ¶è®¾è®¡

### 1. ç¯å¢ƒé©±åŠ¨é…ç½®ç³»ç»Ÿ

#### 1.1 ç¯å¢ƒæ ‡è¯†æ¨¡å—

**æ–‡ä»¶**ï¼š`core/src/config/env.ts`ï¼ˆæ–°å»ºï¼‰

```typescript
/**
 * ç¯å¢ƒé…ç½®æ¨¡å—
 * 
 * ç»Ÿä¸€ç®¡ç†ç¯å¢ƒæ ‡è¯†ï¼Œç¡®ä¿æ‰€æœ‰æ¨¡å—ä½¿ç”¨ä¸€è‡´çš„ç¯å¢ƒåˆ¤æ–­
 */

export const ENV = {
  /**
   * å½“å‰ç¯å¢ƒ
   * development | staging | production
   */
  NODE_ENV: process.env.NODE_ENV || 'development',
  
  /**
   * æ˜¯å¦ä¸ºå¼€å‘ç¯å¢ƒ
   */
  isDev: process.env.NODE_ENV !== 'production' && process.env.NODE_ENV !== 'staging',
  
  /**
   * æ˜¯å¦ä¸ºé¢„å‘å¸ƒç¯å¢ƒ
   */
  isStage: process.env.NODE_ENV === 'staging',
  
  /**
   * æ˜¯å¦ä¸ºç”Ÿäº§ç¯å¢ƒ
   */
  isProd: process.env.NODE_ENV === 'production',
  
  /**
   * æ˜¯å¦å…è®¸å¼€å‘æ¨¡å¼ç‰¹æ€§
   * å¼€å‘ç¯å¢ƒï¼šå…è®¸å›ºå®šéªŒè¯ç ã€è¯¦ç»†æ—¥å¿—ç­‰
   */
  allowDevFeatures: process.env.NODE_ENV !== 'production',
} as const;

/**
 * ç¯å¢ƒéªŒè¯
 * åœ¨åº”ç”¨å¯åŠ¨æ—¶è°ƒç”¨ï¼Œç¡®ä¿ç¯å¢ƒé…ç½®æ­£ç¡®
 */
export function validateEnv(): void {
  const validEnvs = ['development', 'staging', 'production'];
  if (!validEnvs.includes(ENV.NODE_ENV)) {
    throw new Error(
      `[Env] Invalid NODE_ENV: ${ENV.NODE_ENV}. ` +
      `Must be one of: ${validEnvs.join(', ')}`
    );
  }
  
  console.log(`[Env] Environment: ${ENV.NODE_ENV}`);
  console.log(`[Env] isDev: ${ENV.isDev}, isStage: ${ENV.isStage}, isProd: ${ENV.isProd}`);
}
```

#### 1.2 è®¤è¯é…ç½®å¢å¼º

**æ–‡ä»¶**ï¼š`core/src/config/auth.ts`ï¼ˆä¿®æ”¹ï¼‰

```typescript
/**
 * è®¤è¯æ¨¡å—é…ç½®
 * 
 * åŸåˆ™ï¼š
 * 1. æ‰€æœ‰ç­–ç•¥å‚æ•°åŒ–é…ç½®ï¼Œä¸å†™æ­»åœ¨ä¸šåŠ¡ä»£ç ä¸­
 * 2. é…ç½®é¡¹åº”ä¸è®¾è®¡æ–‡æ¡£å¯¹åº”
 * 3. ä¿®æ”¹ç­–ç•¥æ—¶åªéœ€æ›´æ”¹æ­¤æ–‡ä»¶ï¼Œæ— éœ€æ”¹åŠ¨ä¸šåŠ¡é€»è¾‘
 * 4. ç”Ÿäº§ç¯å¢ƒå¼ºåˆ¶ä½¿ç”¨å®‰å…¨é…ç½®
 */

import { ENV } from './env';

// ===== OTP éªŒè¯ç ç­–ç•¥é…ç½® =====

/**
 * OTP éªŒè¯æ¨¡å¼
 * - fixed: å›ºå®šéªŒè¯ç ï¼ˆä»…å…è®¸ Dev/Stageï¼‰
 * - database: ä»æ•°æ®åº“éªŒè¯ï¼ˆç”Ÿäº§ç¯å¢ƒå¿…é¡»ï¼‰
 */
type OtpMode = 'fixed' | 'database';

/**
 * éªŒè¯ç é…ç½®
 */
export const otpConfig = {
  /**
   * OTP éªŒè¯æ¨¡å¼
   * ç¯å¢ƒå˜é‡ï¼šXIAOPEI_OTP_MODE
   * é»˜è®¤ï¼šfixedï¼ˆå¼€å‘ç¯å¢ƒï¼‰| databaseï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
   */
  mode: (process.env.XIAOPEI_OTP_MODE as OtpMode) || (ENV.isProd ? 'database' : 'fixed'),
  
  /**
   * å›ºå®šéªŒè¯ç ï¼ˆä»… fixed æ¨¡å¼ä½¿ç”¨ï¼‰
   * ç¯å¢ƒå˜é‡ï¼šXIAOPEI_OTP_FIXED_CODE
   * é»˜è®¤ï¼š123456
   * âš ï¸ ç”Ÿäº§ç¯å¢ƒç¦æ­¢ä½¿ç”¨
   */
  fixedCode: process.env.XIAOPEI_OTP_FIXED_CODE || '123456',
  
  /**
   * éªŒè¯ç é•¿åº¦
   */
  length: 6,
  
  /**
   * éªŒè¯ç å­—ç¬¦é›†
   */
  charset: '0123456789',
  
  /**
   * å‘é€é—´éš”ï¼ˆç§’ï¼‰
   */
  sendIntervalSeconds: 60,
  
  /**
   * æ¯æ—¥å‘é€æ¬¡æ•°é™åˆ¶
   */
  dailyLimit: 10,
  
  /**
   * éªŒè¯ç æœ‰æ•ˆæœŸï¼ˆåˆ†é’Ÿï¼‰
   */
  ttlMinutes: 10,
} as const;

/**
 * éªŒè¯ OTP é…ç½®
 * åœ¨åº”ç”¨å¯åŠ¨æ—¶è°ƒç”¨ï¼Œç¡®ä¿é…ç½®åˆæ³•
 */
export function validateOtpConfig(): void {
  // 1. éªŒè¯æ¨¡å¼
  if (!['fixed', 'database'].includes(otpConfig.mode)) {
    throw new Error(
      `[OTP Config] Invalid mode: ${otpConfig.mode}. ` +
      `Must be 'fixed' or 'database'`
    );
  }
  
  // 2. ç”Ÿäº§ç¯å¢ƒç¦æ­¢ fixed æ¨¡å¼
  if (ENV.isProd && otpConfig.mode === 'fixed') {
    throw new Error(
      '[Security] Fixed OTP mode is NOT allowed in production. ' +
      'Please set XIAOPEI_OTP_MODE=database and configure SMS service.'
    );
  }
  
  // 3. éªŒè¯ç é•¿åº¦
  if (otpConfig.length < 4 || otpConfig.length > 8) {
    throw new Error(
      `[OTP Config] Invalid length: ${otpConfig.length}. ` +
      `Must be between 4 and 8`
    );
  }
  
  // 4. å›ºå®šéªŒè¯ç é•¿åº¦æ£€æŸ¥
  if (otpConfig.mode === 'fixed' && otpConfig.fixedCode.length !== otpConfig.length) {
    throw new Error(
      `[OTP Config] Fixed code length (${otpConfig.fixedCode.length}) ` +
      `does not match configured length (${otpConfig.length})`
    );
  }
  
  console.log(`[OTP Config] Mode: ${otpConfig.mode}`);
  if (otpConfig.mode === 'fixed') {
    console.warn('[OTP Config] âš ï¸  Using FIXED mode (dev/stage only)');
  }
}

// ===== JWT Token é…ç½® =====

/**
 * JWT Token é…ç½®
 */
export const jwtConfig = {
  /**
   * Token æœ‰æ•ˆæœŸï¼ˆå¤©ï¼‰
   */
  expiresInDays: 30,
  
  /**
   * Token åˆ·æ–°é˜ˆå€¼ï¼ˆå¤©ï¼‰
   * å‰©ä½™æ—¶é—´å°äºæ­¤å€¼æ—¶å»ºè®®åˆ·æ–°
   */
  refreshThresholdDays: 7,
} as const;

/**
 * è·å– JWT Secret
 * å¼ºåˆ¶ä»ç¯å¢ƒå˜é‡è¯»å–ï¼Œç¼ºå¤±æ—¶æŠ›å‡ºé”™è¯¯
 */
export function getJwtSecret(): string {
  const secret = process.env.XIAOPEI_JWT_SECRET;
  
  if (!secret) {
    throw new Error(
      '[Security] XIAOPEI_JWT_SECRET is not configured. ' +
      'Please set it in environment variables. ' +
      'For production, use a strong random secret (at least 32 characters).'
    );
  }
  
  // ç”Ÿäº§ç¯å¢ƒæ£€æŸ¥å¯†é’¥å¼ºåº¦
  if (ENV.isProd && secret.length < 32) {
    console.warn(
      '[Security] âš ï¸  JWT Secret is too short for production. ' +
      'Recommended length: 32+ characters'
    );
  }
  
  // æ£€æŸ¥æ˜¯å¦ä¸ºé»˜è®¤å€¼
  if (secret === 'your-secret-key-change-me') {
    throw new Error(
      '[Security] JWT Secret is using default value. ' +
      'Please set XIAOPEI_JWT_SECRET to a strong random secret.'
    );
  }
  
  return secret;
}

// ===== é…ç½®éªŒè¯ =====

/**
 * éªŒè¯æ‰€æœ‰è®¤è¯é…ç½®
 */
export function validateAuthConfig(): void {
  validateOtpConfig();
  getJwtSecret(); // éªŒè¯ JWT Secret æ˜¯å¦å­˜åœ¨
  console.log('[Auth Config] âœ… All configurations validated');
}
```

### 2. JWT å®‰å…¨æœºåˆ¶

#### 2.1 å¼ºåˆ¶ç¯å¢ƒå˜é‡è¯»å–

**æ–‡ä»¶**ï¼š`core/src/modules/auth/authService.ts`ï¼ˆä¿®æ”¹ï¼‰

```typescript
/**
 * è®¤è¯æœåŠ¡
 * 
 * å®‰å…¨æ”¹è¿›ï¼š
 * 1. JWT Secret å¼ºåˆ¶ä»ç¯å¢ƒå˜é‡è¯»å–ï¼Œç¼ºå¤±æ—¶æŠ›å‡ºé”™è¯¯
 * 2. OTP éªŒè¯æ”¯æŒ fixed/database ä¸¤ç§æ¨¡å¼
 * 3. ç”Ÿäº§ç¯å¢ƒç¦æ­¢å›ºå®šéªŒè¯ç 
 */

import { v4 as uuidv4 } from 'uuid';
import jwt from 'jsonwebtoken';
import { getPool } from '../../database/connection';
import { FieldMapper } from '../../utils/fieldMapper';
import { otpConfig, jwtConfig, getJwtSecret } from '../../config/auth';
import { ENV } from '../../config/env';
import type { UserRow } from '../../types/database';
import type { UserDto, LoginResponseDto, RequestOtpResponseDto } from '../../types/dto';

// âœ… å¼ºåˆ¶ä»ç¯å¢ƒå˜é‡è¯»å–ï¼Œç¼ºå¤±æ—¶ç›´æ¥æŠ›å‡ºé”™è¯¯
const JWT_SECRET = getJwtSecret();
const JWT_EXPIRES_IN = `${jwtConfig.expiresInDays}d`;

/**
 * ç”Ÿæˆ JWT Token
 */
function generateToken(userId: string): string {
  return jwt.sign({ userId }, JWT_SECRET, { expiresIn: JWT_EXPIRES_IN });
}

/**
 * éªŒè¯ JWT Token
 */
export function verifyToken(token: string): { userId: string } {
  try {
    const decoded = jwt.verify(token, JWT_SECRET) as { userId: string };
    return decoded;
  } catch (error) {
    throw new Error('Invalid token');
  }
}

/**
 * ç™»å½•æˆ–æ³¨å†Œ
 * 
 * å®‰å…¨æ”¹è¿›ï¼š
 * - æ”¯æŒ fixed/database ä¸¤ç§ OTP æ¨¡å¼
 * - ç”Ÿäº§ç¯å¢ƒå¼ºåˆ¶ä½¿ç”¨ database æ¨¡å¼
 */
export async function loginOrRegister(params: {
  phone?: string;
  email?: string;
  code: string;
  channel: 'cn' | 'hk';
}): Promise<LoginResponseDto> {
  const { phone, email, code, channel } = params;
  
  const pool = getPool();
  
  // ===== 1. éªŒè¯éªŒè¯ç  =====
  
  if (otpConfig.mode === 'fixed') {
    // âœ… ä»…å…è®¸åœ¨éç”Ÿäº§ç¯å¢ƒ
    if (ENV.isProd) {
      throw new Error(
        '[Security] Fixed OTP mode is not allowed in production. ' +
        'This should never happen if configuration is correct.'
      );
    }
    
    // å›ºå®šéªŒè¯ç æ¨¡å¼
    if (code !== otpConfig.fixedCode) {
      throw new Error(`éªŒè¯ç é”™è¯¯ï¼ˆå›ºå®šéªŒè¯ç ï¼š${otpConfig.fixedCode}ï¼‰`);
    }
    
    // ä»…å¼€å‘ç¯å¢ƒæ‰“å°æ—¥å¿—
    if (ENV.isDev) {
      console.log('[Auth] âœ… OTP verified in FIXED mode (dev only)', {
        phone: phone ? `${phone.slice(0, 3)}****${phone.slice(-4)}` : undefined,
        email: email ? `${email.split('@')[0]}@***` : undefined,
      });
    }
    
  } else if (otpConfig.mode === 'database') {
    // âœ… çœŸå®æ¨¡å¼ï¼šä»æ•°æ®åº“éªŒè¯
    
    const [rows]: any = await pool.execute(
      `SELECT * FROM verification_codes
       WHERE (phone = ? OR email = ?)
         AND code = ?
         AND code_type = 'login'
         AND expires_at > NOW()
         AND is_used = FALSE
       ORDER BY created_at DESC
       LIMIT 1`,
      [phone || null, email || null, code]
    );
    
    if (rows.length === 0) {
      throw new Error('éªŒè¯ç é”™è¯¯æˆ–å·²è¿‡æœŸ');
    }
    
    const codeRecord = rows[0];
    
    // æ ‡è®°ä¸ºå·²ä½¿ç”¨
    await pool.execute(
      `UPDATE verification_codes
       SET is_used = TRUE, updated_at = NOW()
       WHERE code_id = ?`,
      [codeRecord.code_id]
    );
    
    console.log('[Auth] âœ… OTP verified in DATABASE mode', {
      codeId: codeRecord.code_id,
      phone: phone ? `${phone.slice(0, 3)}****${phone.slice(-4)}` : undefined,
      email: email ? `${email.split('@')[0]}@***` : undefined,
    });
    
  } else {
    throw new Error(`[Security] Unknown OTP mode: ${otpConfig.mode}`);
  }
  
  // ===== 2. æŸ¥æ‰¾æˆ–åˆ›å»ºç”¨æˆ· =====
  
  const [userRows]: any = await pool.execute(
    `SELECT * FROM users WHERE phone = ? OR email = ?`,
    [phone || null, email || null]
  );
  
  let userRow: UserRow;
  
  if (userRows.length > 0) {
    // ç”¨æˆ·å·²å­˜åœ¨ï¼šç™»å½•
    userRow = userRows[0];
  } else {
    // ç”¨æˆ·ä¸å­˜åœ¨ï¼šæ³¨å†Œ
    const userId = uuidv4();
    const nickname = phone ? `ç”¨æˆ·${phone.slice(-4)}` : `ç”¨æˆ·${email?.split('@')[0]}`;
    
    await pool.execute(
      `INSERT INTO users (user_id, nickname, phone, email, app_region, is_pro) 
       VALUES (?, ?, ?, ?, ?, FALSE)`,
      [userId, nickname, phone || null, email || null, channel.toUpperCase()]
    );
    
    // é‡æ–°æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯
    const [newUserRows]: any = await pool.execute(
      `SELECT * FROM users WHERE user_id = ?`,
      [userId]
    );
    userRow = newUserRows[0];
    
    // åˆ›å»ºç”¨æˆ·è®¾ç½®
    await pool.execute(
      `INSERT INTO user_settings (setting_id, user_id, language) 
       VALUES (?, ?, ?)`,
      [uuidv4(), userId, channel === 'cn' ? 'zh-CN' : 'zh-HK']
    );
  }
  
  // ===== 3. ç”Ÿæˆ JWT Token =====
  const token = generateToken(userRow.user_id);
  
  // âœ… ä½¿ç”¨ FieldMapper è½¬æ¢ä¸º DTO
  const userDto = FieldMapper.mapUser(userRow);
  
  return {
    token,
    user: userDto,
  };
}

// ... å…¶ä»–å‡½æ•°ä¿æŒä¸å˜ ...
```

### 3. æœåŠ¡å™¨å¯åŠ¨å®‰å…¨æ£€æŸ¥

**æ–‡ä»¶**ï¼š`core/src/server.ts`ï¼ˆä¿®æ”¹ï¼‰

```typescript
/**
 * Core åç«¯æœåŠ¡å…¥å£
 * 
 * å®‰å…¨æ”¹è¿›ï¼š
 * 1. å¯åŠ¨æ—¶è¿›è¡Œå®‰å…¨æ£€æŸ¥
 * 2. ç¯å¢ƒé…ç½®éªŒè¯
 * 3. CORS ç­–ç•¥æŒ‰ç¯å¢ƒåŒºåˆ†
 */

import express, { Application } from 'express';
import cors from 'cors';
import dotenv from 'dotenv';
import { createConnection } from './database/connection';
import { ENV, validateEnv } from './config/env';
import { validateAuthConfig } from './config/auth';

// åŠ è½½ç¯å¢ƒå˜é‡
dotenv.config();

// ===== å¯åŠ¨å‰å®‰å…¨æ£€æŸ¥ =====

try {
  // 1. éªŒè¯ç¯å¢ƒé…ç½®
  validateEnv();
  
  // 2. éªŒè¯è®¤è¯é…ç½®ï¼ˆåŒ…æ‹¬ JWT Secretã€OTP æ¨¡å¼ç­‰ï¼‰
  validateAuthConfig();
  
  console.log('[Server] âœ… Security checks passed');
} catch (error: any) {
  console.error('[Server] âŒ Security check failed:', error.message);
  console.error('[Server] Service will not start due to security configuration errors.');
  process.exit(1);
}

const app: Application = express();
const PORT = process.env.XIAOPEI_CORE_PORT || 3000;

// ===== ä¸­é—´ä»¶é…ç½® =====

// CORS é…ç½®ï¼ˆæŒ‰ç¯å¢ƒåŒºåˆ†ï¼‰
const allowedOrigins = (process.env.ALLOWED_ORIGINS || '')
  .split(',')
  .map(o => o.trim())
  .filter(Boolean);

app.use(cors({
  origin: (origin, callback) => {
    // å¼€å‘ç¯å¢ƒï¼šå…è®¸æ‰€æœ‰è¯·æ±‚ï¼ˆä½†è®°å½•æ—¥å¿—ï¼‰
    if (ENV.isDev) {
      if (origin) {
        console.log('[CORS] Dev mode - allowing origin:', origin);
      }
      return callback(null, true);
    }
    
    // ç”Ÿäº§ç¯å¢ƒï¼šä¸¥æ ¼ç™½åå•
    if (!origin) {
      // ç§»åŠ¨ç«¯ã€curl ç­‰æ²¡æœ‰ origin çš„è¯·æ±‚ï¼Œå…è®¸
      return callback(null, true);
    }
    
    const isAllowed = allowedOrigins.includes(origin);
    if (isAllowed) {
      return callback(null, true);
    }
    
    console.warn('[CORS] Blocked origin:', origin);
    callback(new Error('Not allowed by CORS'));
  },
  credentials: true,
}));

// Body è§£æ
app.use(express.json({ limit: '10mb' }));
app.use(express.urlencoded({ extended: true, limit: '10mb' }));

// è¯·æ±‚æ—¥å¿—ï¼ˆä»…å¼€å‘ç¯å¢ƒï¼‰
if (ENV.isDev) {
  app.use((req, _res, next) => {
    console.log(`[Request] ${req.method} ${req.path}`);
    next();
  });
}

// ... è·¯ç”±æ³¨å†Œä¿æŒä¸å˜ ...

// ===== é”™è¯¯å¤„ç† =====

// å…¨å±€é”™è¯¯å¤„ç†
app.use((err: any, _req: express.Request, res: express.Response, _next: express.NextFunction) => {
  console.error('[Error]', err);
  
  // ç”Ÿäº§ç¯å¢ƒä¸è¿”å›å †æ ˆä¿¡æ¯
  const details = ENV.isProd ? undefined : err.stack;
  
  res.status(err.status || 500).json({
    success: false,
    error: {
      code: err.code || 'INTERNAL_SERVER_ERROR',
      message: err.message || 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯',
      details,
    },
  });
});

// ... å¯åŠ¨æœåŠ¡å™¨é€»è¾‘ä¿æŒä¸å˜ ...
```

### 4. æ—¥å¿—è„±æ•æœºåˆ¶

**æ–‡ä»¶**ï¼š`core/src/utils/logger.ts`ï¼ˆæ–°å»ºï¼‰

```typescript
/**
 * å®‰å…¨æ—¥å¿—å·¥å…·
 * 
 * åŠŸèƒ½ï¼š
 * 1. ç”Ÿäº§ç¯å¢ƒç¦ç”¨è¯¦ç»†æ—¥å¿—
 * 2. è‡ªåŠ¨è„±æ•æ•æ„Ÿä¿¡æ¯ï¼ˆTokenã€éªŒè¯ç ã€å¯†ç ç­‰ï¼‰
 * 3. ç»Ÿä¸€æ—¥å¿—æ ¼å¼
 */

import { ENV } from '../config/env';

/**
 * è„±æ•æ•æ„Ÿä¿¡æ¯
 */
function sanitize(data: any): any {
  if (typeof data === 'string') {
    // Token è„±æ•ï¼ˆä¿ç•™å‰ 10 ä½å’Œå 4 ä½ï¼‰
    if (data.length > 20) {
      return `${data.substring(0, 10)}...${data.substring(data.length - 4)}`;
    }
    return '***';
  }
  
  if (typeof data === 'object' && data !== null) {
    const sanitized: any = Array.isArray(data) ? [] : {};
    const sensitiveKeys = ['token', 'password', 'code', 'secret', 'apiKey', 'api_key'];
    
    for (const key in data) {
      const lowerKey = key.toLowerCase();
      if (sensitiveKeys.some(sk => lowerKey.includes(sk))) {
        sanitized[key] = '***';
      } else {
        sanitized[key] = sanitize(data[key]);
      }
    }
    return sanitized;
  }
  
  return data;
}

export const logger = {
  /**
   * ä¿¡æ¯æ—¥å¿—ï¼ˆä»…å¼€å‘ç¯å¢ƒï¼‰
   */
  info: (...args: any[]) => {
    if (!ENV.isProd) {
      console.log('[INFO]', ...args.map(sanitize));
    }
  },
  
  /**
   * è­¦å‘Šæ—¥å¿—ï¼ˆæ‰€æœ‰ç¯å¢ƒï¼‰
   */
  warn: (...args: any[]) => {
    console.warn('[WARN]', ...args.map(sanitize));
  },
  
  /**
   * é”™è¯¯æ—¥å¿—ï¼ˆæ‰€æœ‰ç¯å¢ƒï¼‰
   */
  error: (...args: any[]) => {
    console.error('[ERROR]', ...args.map(sanitize));
  },
  
  /**
   * è°ƒè¯•æ—¥å¿—ï¼ˆä»…å¼€å‘ç¯å¢ƒï¼‰
   */
  debug: (...args: any[]) => {
    if (ENV.isDev) {
      console.log('[DEBUG]', ...args.map(sanitize));
    }
  },
};
```

### 5. å®¢æˆ·ç«¯å®‰å…¨æ”¹è¿›

#### 5.1 Token åŠ å¯†å­˜å‚¨ï¼ˆApp ç«¯ï¼‰

**æ–‡ä»¶**ï¼š`app/src/utils/tokenStorage.ts`ï¼ˆä¿®æ”¹ï¼‰

```typescript
/**
 * Token å­˜å‚¨ç®¡ç†ï¼ˆå®‰å…¨ç‰ˆæœ¬ï¼‰
 * 
 * æ”¹è¿›ï¼š
 * 1. ä½¿ç”¨ SecureStore åŠ å¯†å­˜å‚¨
 * 2. ç§»é™¤æ‰€æœ‰ Token æ—¥å¿—è¾“å‡º
 * 3. é”™è¯¯å¤„ç†ä¼˜åŒ–
 */

import * as SecureStore from 'expo-secure-store';

const TOKEN_STORAGE_KEY = '@xiaopei/auth_token';

export const tokenStorage = {
  /**
   * ä¿å­˜ Tokenï¼ˆåŠ å¯†å­˜å‚¨ï¼‰
   */
  async save(token: string): Promise<void> {
    try {
      await SecureStore.setItemAsync(TOKEN_STORAGE_KEY, token);
      // âœ… ä¸æ‰“å° Token å†…å®¹ï¼Œä»…è®°å½•æ“ä½œæˆåŠŸ
      if (__DEV__) {
        console.log('[TokenStorage] âœ… Token saved securely');
      }
    } catch (error) {
      console.error('[TokenStorage] âŒ Failed to save token:', error);
      throw error;
    }
  },

  /**
   * è¯»å– Token
   */
  async load(): Promise<string | null> {
    try {
      const token = await SecureStore.getItemAsync(TOKEN_STORAGE_KEY);
      if (token) {
        if (__DEV__) {
          console.log('[TokenStorage] âœ… Token loaded');
        }
      }
      return token;
    } catch (error) {
      console.error('[TokenStorage] âŒ Failed to load token:', error);
      return null;
    }
  },

  /**
   * æ¸…é™¤ Token
   */
  async clear(): Promise<void> {
    try {
      await SecureStore.deleteItemAsync(TOKEN_STORAGE_KEY);
      if (__DEV__) {
        console.log('[TokenStorage] âœ… Token cleared');
      }
    } catch (error) {
      console.error('[TokenStorage] âŒ Failed to clear token:', error);
      throw error;
    }
  },

  /**
   * æ£€æŸ¥ Token æ˜¯å¦å­˜åœ¨
   */
  async exists(): Promise<boolean> {
    try {
      const token = await SecureStore.getItemAsync(TOKEN_STORAGE_KEY);
      return token !== null;
    } catch (error) {
      console.error('[TokenStorage] âŒ Failed to check token:', error);
      return false;
    }
  },
};
```

**æ³¨æ„**ï¼šå¦‚æœä½¿ç”¨çº¯ React Nativeï¼ˆé Expoï¼‰ï¼Œä½¿ç”¨ `react-native-keychain`ï¼š

```typescript
import * as Keychain from 'react-native-keychain';

export const tokenStorage = {
  async save(token: string): Promise<void> {
    await Keychain.setGenericPassword('auth_token', token, {
      service: 'com.xiaopei.app',
      accessible: Keychain.ACCESSIBLE.WHEN_UNLOCKED,
    });
  },
  
  async load(): Promise<string | null> {
    const credentials = await Keychain.getGenericPassword({
      service: 'com.xiaopei.app',
    });
    return credentials ? credentials.password : null;
  },
  
  async clear(): Promise<void> {
    await Keychain.resetGenericPassword({ service: 'com.xiaopei.app' });
  },
  
  async exists(): Promise<boolean> {
    const credentials = await Keychain.getGenericPassword({
      service: 'com.xiaopei.app',
    });
    return credentials !== false;
  },
};
```

#### 5.2 API å®¢æˆ·ç«¯æ—¥å¿—è„±æ•

**æ–‡ä»¶**ï¼š`app/src/services/api/apiClient.ts`ï¼ˆä¿®æ”¹ï¼‰

```typescript
// ... å…¶ä»–ä»£ç ä¿æŒä¸å˜ ...

// ===== è¯·æ±‚æ‹¦æˆªå™¨ =====
apiClient.interceptors.request.use(
  (config) => {
    const { token, isAuthenticated } = useAuthStore.getState();
    
    if (token) {
      config.headers.Authorization = `Bearer ${token}`;
      // âœ… ä¸æ‰“å° Tokenï¼Œä»…è®°å½•æ˜¯å¦æœ‰ Token
      if (ENV.ENABLE_LOG) {
        console.log('[API Client] âœ… Token added to header');
      }
    } else {
      if (isAuthenticated) {
        console.error('[API Client] âŒ Authenticated but no token found');
      }
    }
    
    // ... å…¶ä»–é€»è¾‘ä¿æŒä¸å˜ ...
    
    // âœ… æ—¥å¿—ä¸­ä¸åŒ…å«æ•æ„Ÿæ•°æ®
    if (ENV.ENABLE_LOG) {
      const fullUrl = config.baseURL + config.url;
      console.log('[API Request]', config.method?.toUpperCase(), fullUrl, {
        hasToken: !!token,
        hasAuthHeader: !!config.headers.Authorization,
        // âŒ ä¸æ‰“å° dataï¼Œå¯èƒ½åŒ…å«æ•æ„Ÿä¿¡æ¯
      });
    }
    
    return config;
  },
  (error) => {
    console.error('[API Request Error]', error);
    return Promise.reject(error);
  }
);

// ... å…¶ä»–ä»£ç ä¿æŒä¸å˜ ...
```

---

## ç¯å¢ƒé…ç½®è§„èŒƒ

### å¼€å‘ç¯å¢ƒï¼ˆ.env.developmentï¼‰

```bash
# ç¯å¢ƒæ ‡è¯†
NODE_ENV=development

# æœåŠ¡å™¨é…ç½®
XIAOPEI_CORE_PORT=3000

# æ•°æ®åº“é…ç½®
XIAOPEI_MYSQL_HOST=localhost
XIAOPEI_MYSQL_PORT=3306
XIAOPEI_MYSQL_USER=root
XIAOPEI_MYSQL_PASSWORD=your_dev_password
XIAOPEI_MYSQL_DATABASE=xiaopei

# JWT é…ç½®ï¼ˆå¼€å‘ç¯å¢ƒå¯ä»¥ä½¿ç”¨ç®€å•å¯†é’¥ï¼Œä½†å»ºè®®ä½¿ç”¨éšæœºå¯†é’¥ï¼‰
XIAOPEI_JWT_SECRET=dev-secret-key-change-in-production-min-32-chars

# OTP é…ç½®ï¼ˆå¼€å‘ç¯å¢ƒå…è®¸å›ºå®šéªŒè¯ç ï¼‰
XIAOPEI_OTP_MODE=fixed
XIAOPEI_OTP_FIXED_CODE=123456

# CORS é…ç½®ï¼ˆå¼€å‘ç¯å¢ƒå…è®¸æ‰€æœ‰ï¼‰
ALLOWED_ORIGINS=http://localhost:19006,http://localhost:5173
```

### é¢„å‘å¸ƒç¯å¢ƒï¼ˆ.env.stagingï¼‰

```bash
# ç¯å¢ƒæ ‡è¯†
NODE_ENV=staging

# æœåŠ¡å™¨é…ç½®
XIAOPEI_CORE_PORT=3000

# æ•°æ®åº“é…ç½®ï¼ˆä½¿ç”¨é¢„å‘å¸ƒæ•°æ®åº“ï¼‰
XIAOPEI_MYSQL_HOST=staging-db.example.com
XIAOPEI_MYSQL_PORT=3306
XIAOPEI_MYSQL_USER=xiaopei_staging
XIAOPEI_MYSQL_PASSWORD=***ï¼ˆä» Secret Manager è¯»å–ï¼‰
XIAOPEI_MYSQL_DATABASE=xiaopei_staging

# JWT é…ç½®ï¼ˆå¿…é¡»ä½¿ç”¨å¼ºéšæœºå¯†é’¥ï¼‰
XIAOPEI_JWT_SECRET=***ï¼ˆè‡³å°‘ 32 å­—ç¬¦ï¼Œä» Secret Manager è¯»å–ï¼‰

# OTP é…ç½®ï¼ˆé¢„å‘å¸ƒç¯å¢ƒå»ºè®®ä½¿ç”¨ database æ¨¡å¼ï¼Œæµ‹è¯•çœŸå®æµç¨‹ï¼‰
XIAOPEI_OTP_MODE=database

# CORS é…ç½®ï¼ˆä»…å…è®¸é¢„å‘å¸ƒåŸŸåï¼‰
ALLOWED_ORIGINS=https://staging.xiaopei.com,https://admin-staging.xiaopei.com
```

### ç”Ÿäº§ç¯å¢ƒï¼ˆ.env.productionï¼‰

```bash
# ç¯å¢ƒæ ‡è¯†
NODE_ENV=production

# æœåŠ¡å™¨é…ç½®
XIAOPEI_CORE_PORT=3000

# æ•°æ®åº“é…ç½®ï¼ˆä½¿ç”¨ç”Ÿäº§æ•°æ®åº“ï¼‰
XIAOPEI_MYSQL_HOST=prod-db.example.com
XIAOPEI_MYSQL_PORT=3306
XIAOPEI_MYSQL_USER=xiaopei_prod
XIAOPEI_MYSQL_PASSWORD=***ï¼ˆä» Secret Manager è¯»å–ï¼‰
XIAOPEI_MYSQL_DATABASE=xiaopei_prod

# JWT é…ç½®ï¼ˆå¿…é¡»ä½¿ç”¨å¼ºéšæœºå¯†é’¥ï¼Œè‡³å°‘ 32 å­—ç¬¦ï¼‰
XIAOPEI_JWT_SECRET=***ï¼ˆä» Secret Manager è¯»å–ï¼Œå»ºè®® 64 å­—ç¬¦ï¼‰

# OTP é…ç½®ï¼ˆç”Ÿäº§ç¯å¢ƒå¼ºåˆ¶ä½¿ç”¨ database æ¨¡å¼ï¼‰
XIAOPEI_OTP_MODE=database

# CORS é…ç½®ï¼ˆä»…å…è®¸ç”Ÿäº§åŸŸåï¼‰
ALLOWED_ORIGINS=https://app.xiaopei.com,https://admin.xiaopei.com
```

### ç”Ÿæˆå¼ºéšæœºå¯†é’¥

```bash
# ç”Ÿæˆ 64 å­—ç¬¦çš„éšæœºå¯†é’¥ï¼ˆæ¨èï¼‰
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"

# ç”Ÿæˆ 32 å­—ç¬¦çš„éšæœºå¯†é’¥ï¼ˆæœ€ä½è¦æ±‚ï¼‰
node -e "console.log(require('crypto').randomBytes(16).toString('hex'))"
```

---

## å®‰å…¨æ£€æŸ¥æ¸…å•

### P0 - ä¸Šçº¿å‰å¿…é¡»å®Œæˆ

#### åç«¯å®‰å…¨

- [ ] **JWT Secret é…ç½®**
  - [ ] ç§»é™¤é»˜è®¤å€¼ `'your-secret-key-change-me'`
  - [ ] ç”Ÿäº§ç¯å¢ƒä½¿ç”¨å¼ºéšæœºå¯†é’¥ï¼ˆè‡³å°‘ 32 å­—ç¬¦ï¼‰
  - [ ] å¯†é’¥å­˜å‚¨åœ¨ Secret Managerï¼Œä¸æäº¤åˆ°ä»£ç åº“
  - [ ] å¯åŠ¨æ—¶éªŒè¯å¯†é’¥å­˜åœ¨ï¼Œç¼ºå¤±æ—¶æ‹’ç»å¯åŠ¨

- [ ] **OTP éªŒè¯ç æœºåˆ¶**
  - [ ] å®ç° `otpConfig.mode` é…ç½®ï¼ˆfixed/databaseï¼‰
  - [ ] ç”Ÿäº§ç¯å¢ƒå¼ºåˆ¶ä½¿ç”¨ `database` æ¨¡å¼
  - [ ] å¯åŠ¨æ—¶éªŒè¯ï¼šç”Ÿäº§ç¯å¢ƒç¦æ­¢ `fixed` æ¨¡å¼
  - [ ] ç§»é™¤æ‰€æœ‰å›ºå®šéªŒè¯ç ç¡¬ç¼–ç 

- [ ] **ç¯å¢ƒé…ç½®éªŒè¯**
  - [ ] åˆ›å»º `config/env.ts` ç»Ÿä¸€ç¯å¢ƒæ ‡è¯†
  - [ ] åˆ›å»º `config/auth.ts` å¢å¼ºé…ç½®
  - [ ] åœ¨ `server.ts` å¯åŠ¨æ—¶è°ƒç”¨ `validateEnv()` å’Œ `validateAuthConfig()`
  - [ ] é…ç½®é”™è¯¯æ—¶æ‹’ç»å¯åŠ¨

- [ ] **æ—¥å¿—è„±æ•**
  - [ ] åˆ›å»º `utils/logger.ts` ç»Ÿä¸€æ—¥å¿—å·¥å…·
  - [ ] ç§»é™¤æ‰€æœ‰ Token/éªŒè¯ç çš„æ˜æ–‡æ—¥å¿—
  - [ ] ç”Ÿäº§ç¯å¢ƒç¦ç”¨è¯¦ç»†æ—¥å¿—
  - [ ] æ•æ„Ÿä¿¡æ¯è‡ªåŠ¨è„±æ•

- [ ] **CORS ç­–ç•¥**
  - [ ] å¼€å‘ç¯å¢ƒå…è®¸æ‰€æœ‰ï¼ˆä½†è®°å½•æ—¥å¿—ï¼‰
  - [ ] ç”Ÿäº§ç¯å¢ƒä¸¥æ ¼ç™½åå•
  - [ ] é€šè¿‡ç¯å¢ƒå˜é‡ `ALLOWED_ORIGINS` é…ç½®

#### å®¢æˆ·ç«¯å®‰å…¨

- [ ] **Token åŠ å¯†å­˜å‚¨**
  - [ ] ä½¿ç”¨ `expo-secure-store` æˆ– `react-native-keychain`
  - [ ] ç§»é™¤ `AsyncStorage` æ˜æ–‡å­˜å‚¨
  - [ ] ç§»é™¤æ‰€æœ‰ Token æ—¥å¿—è¾“å‡º

- [ ] **Android ç­¾å**
  - [ ] ç”Ÿæˆæ­£å¼ keystore
  - [ ] Release æ„å»ºä½¿ç”¨æ­£å¼ç­¾å
  - [ ] ç§»é™¤ debug keystore é…ç½®

- [ ] **ä»£ç æ··æ·†**
  - [ ] å®Œå–„ `proguard-rules.pro`
  - [ ] å¯ç”¨ R8 ä»£ç å‹ç¼©
  - [ ] æ··æ·†ä¸šåŠ¡ä»£ç ç±»å

### P1 - ä¸Šçº¿å 1-2 ä¸ªç‰ˆæœ¬å†…å®Œæˆ

- [ ] **OTP çŸ­ä¿¡æœåŠ¡**
  - [ ] æ¥å…¥çœŸå®çŸ­ä¿¡æœåŠ¡å•†ï¼ˆé˜¿é‡Œäº‘/è…¾è®¯äº‘ç­‰ï¼‰
  - [ ] å®ç° `smsService.sendLoginCode()` æ¥å£
  - [ ] ç§»é™¤å›ºå®šéªŒè¯ç é€»è¾‘

- [ ] **éªŒè¯ç å®‰å…¨**
  - [ ] éªŒè¯ç ä½¿ç”¨å“ˆå¸Œå­˜å‚¨ï¼ˆbcrypt/SHA-256ï¼‰
  - [ ] å®šæœŸæ¸…ç†è¿‡æœŸéªŒè¯ç ï¼ˆå®šæ—¶ä»»åŠ¡ï¼‰
  - [ ] æ·»åŠ  IP ç»´åº¦é™æµ

- [ ] **Token é»‘åå•**
  - [ ] å®ç° Token é»‘åå•æœºåˆ¶ï¼ˆRedisï¼‰
  - [ ] ç™»å‡ºæ—¶æ·»åŠ  Token åˆ°é»‘åå•
  - [ ] éªŒè¯ Token æ—¶æ£€æŸ¥é»‘åå•

- [ ] **æ•°æ®åº“å®‰å…¨**
  - [ ] `users.phone` æ·»åŠ å”¯ä¸€ç´¢å¼•
  - [ ] `users.email` æ·»åŠ å”¯ä¸€ç´¢å¼•
  - [ ] æ•æ„Ÿå­—æ®µåŠ å¯†å­˜å‚¨ï¼ˆå¦‚éœ€è¦ï¼‰

- [ ] **é™æµä¼˜åŒ–**
  - [ ] ä½¿ç”¨ UTC æ—¶é—´å®ç°é™æµï¼ˆé¿å…æ—¶åŒºç»•è¿‡ï¼‰
  - [ ] è€ƒè™‘ä½¿ç”¨ Redis å®ç°åˆ†å¸ƒå¼é™æµ
  - [ ] æ·»åŠ  IP ç»´åº¦é™æµ

### P2 - é•¿æœŸä¼˜åŒ–

- [ ] **é”™è¯¯å¤„ç†**
  - [ ] ç”Ÿäº§ç¯å¢ƒå®Œå…¨éšè—é”™è¯¯å †æ ˆ
  - [ ] ç»Ÿä¸€é”™è¯¯ç ä½“ç³»
  - [ ] é”™è¯¯æ—¥å¿—é›†ä¸­æ”¶é›†

- [ ] **API å®‰å…¨**
  - [ ] API Base URL ä½¿ç”¨é…ç½®æœåŠ¡
  - [ ] å®ç° API ç‰ˆæœ¬æ§åˆ¶
  - [ ] æ·»åŠ è¯·æ±‚ç­¾åæœºåˆ¶ï¼ˆå¦‚éœ€è¦ï¼‰

- [ ] **ç›‘æ§ä¸å®¡è®¡**
  - [ ] å®ç°å®‰å…¨äº‹ä»¶æ—¥å¿—
  - [ ] å¼‚å¸¸ç™»å½•æ£€æµ‹
  - [ ] å®šæœŸå®‰å…¨å®¡è®¡

---

## é™„å½•ï¼šå®Œæ•´ä»£ç å®ç°

### 1. ç¯å¢ƒé…ç½®æ¨¡å—ï¼ˆå®Œæ•´ç‰ˆï¼‰

**æ–‡ä»¶**ï¼š`core/src/config/env.ts`

```typescript
/**
 * ç¯å¢ƒé…ç½®æ¨¡å—
 * 
 * ç»Ÿä¸€ç®¡ç†ç¯å¢ƒæ ‡è¯†ï¼Œç¡®ä¿æ‰€æœ‰æ¨¡å—ä½¿ç”¨ä¸€è‡´çš„ç¯å¢ƒåˆ¤æ–­
 */

export const ENV = {
  /**
   * å½“å‰ç¯å¢ƒ
   * development | staging | production
   */
  NODE_ENV: process.env.NODE_ENV || 'development',
  
  /**
   * æ˜¯å¦ä¸ºå¼€å‘ç¯å¢ƒ
   */
  isDev: process.env.NODE_ENV !== 'production' && process.env.NODE_ENV !== 'staging',
  
  /**
   * æ˜¯å¦ä¸ºé¢„å‘å¸ƒç¯å¢ƒ
   */
  isStage: process.env.NODE_ENV === 'staging',
  
  /**
   * æ˜¯å¦ä¸ºç”Ÿäº§ç¯å¢ƒ
   */
  isProd: process.env.NODE_ENV === 'production',
  
  /**
   * æ˜¯å¦å…è®¸å¼€å‘æ¨¡å¼ç‰¹æ€§
   * å¼€å‘ç¯å¢ƒï¼šå…è®¸å›ºå®šéªŒè¯ç ã€è¯¦ç»†æ—¥å¿—ç­‰
   */
  allowDevFeatures: process.env.NODE_ENV !== 'production',
} as const;

/**
 * ç¯å¢ƒéªŒè¯
 * åœ¨åº”ç”¨å¯åŠ¨æ—¶è°ƒç”¨ï¼Œç¡®ä¿ç¯å¢ƒé…ç½®æ­£ç¡®
 */
export function validateEnv(): void {
  const validEnvs = ['development', 'staging', 'production'];
  if (!validEnvs.includes(ENV.NODE_ENV)) {
    throw new Error(
      `[Env] Invalid NODE_ENV: ${ENV.NODE_ENV}. ` +
      `Must be one of: ${validEnvs.join(', ')}`
    );
  }
  
  console.log(`[Env] Environment: ${ENV.NODE_ENV}`);
  console.log(`[Env] isDev: ${ENV.isDev}, isStage: ${ENV.isStage}, isProd: ${ENV.isProd}`);
}
```

### 2. è®¤è¯é…ç½®æ¨¡å—ï¼ˆå®Œæ•´ç‰ˆï¼‰

**æ–‡ä»¶**ï¼š`core/src/config/auth.ts`

```typescript
/**
 * è®¤è¯æ¨¡å—é…ç½®
 * 
 * åŸåˆ™ï¼š
 * 1. æ‰€æœ‰ç­–ç•¥å‚æ•°åŒ–é…ç½®ï¼Œä¸å†™æ­»åœ¨ä¸šåŠ¡ä»£ç ä¸­
 * 2. é…ç½®é¡¹åº”ä¸è®¾è®¡æ–‡æ¡£å¯¹åº”
 * 3. ä¿®æ”¹ç­–ç•¥æ—¶åªéœ€æ›´æ”¹æ­¤æ–‡ä»¶ï¼Œæ— éœ€æ”¹åŠ¨ä¸šåŠ¡é€»è¾‘
 * 4. ç”Ÿäº§ç¯å¢ƒå¼ºåˆ¶ä½¿ç”¨å®‰å…¨é…ç½®
 */

import { ENV } from './env';

// ===== OTP éªŒè¯ç ç­–ç•¥é…ç½® =====

/**
 * OTP éªŒè¯æ¨¡å¼
 * - fixed: å›ºå®šéªŒè¯ç ï¼ˆä»…å…è®¸ Dev/Stageï¼‰
 * - database: ä»æ•°æ®åº“éªŒè¯ï¼ˆç”Ÿäº§ç¯å¢ƒå¿…é¡»ï¼‰
 */
type OtpMode = 'fixed' | 'database';

/**
 * éªŒè¯ç é…ç½®
 */
export const otpConfig = {
  /**
   * OTP éªŒè¯æ¨¡å¼
   * ç¯å¢ƒå˜é‡ï¼šXIAOPEI_OTP_MODE
   * é»˜è®¤ï¼šfixedï¼ˆå¼€å‘ç¯å¢ƒï¼‰| databaseï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
   */
  mode: (process.env.XIAOPEI_OTP_MODE as OtpMode) || (ENV.isProd ? 'database' : 'fixed'),
  
  /**
   * å›ºå®šéªŒè¯ç ï¼ˆä»… fixed æ¨¡å¼ä½¿ç”¨ï¼‰
   * ç¯å¢ƒå˜é‡ï¼šXIAOPEI_OTP_FIXED_CODE
   * é»˜è®¤ï¼š123456
   * âš ï¸ ç”Ÿäº§ç¯å¢ƒç¦æ­¢ä½¿ç”¨
   */
  fixedCode: process.env.XIAOPEI_OTP_FIXED_CODE || '123456',
  
  /**
   * éªŒè¯ç é•¿åº¦
   */
  length: 6,
  
  /**
   * éªŒè¯ç å­—ç¬¦é›†
   */
  charset: '0123456789',
  
  /**
   * å‘é€é—´éš”ï¼ˆç§’ï¼‰
   */
  sendIntervalSeconds: 60,
  
  /**
   * æ¯æ—¥å‘é€æ¬¡æ•°é™åˆ¶
   */
  dailyLimit: 10,
  
  /**
   * éªŒè¯ç æœ‰æ•ˆæœŸï¼ˆåˆ†é’Ÿï¼‰
   */
  ttlMinutes: 10,
} as const;

/**
 * éªŒè¯ OTP é…ç½®
 * åœ¨åº”ç”¨å¯åŠ¨æ—¶è°ƒç”¨ï¼Œç¡®ä¿é…ç½®åˆæ³•
 */
export function validateOtpConfig(): void {
  // 1. éªŒè¯æ¨¡å¼
  if (!['fixed', 'database'].includes(otpConfig.mode)) {
    throw new Error(
      `[OTP Config] Invalid mode: ${otpConfig.mode}. ` +
      `Must be 'fixed' or 'database'`
    );
  }
  
  // 2. ç”Ÿäº§ç¯å¢ƒç¦æ­¢ fixed æ¨¡å¼
  if (ENV.isProd && otpConfig.mode === 'fixed') {
    throw new Error(
      '[Security] Fixed OTP mode is NOT allowed in production. ' +
      'Please set XIAOPEI_OTP_MODE=database and configure SMS service.'
    );
  }
  
  // 3. éªŒè¯ç é•¿åº¦
  if (otpConfig.length < 4 || otpConfig.length > 8) {
    throw new Error(
      `[OTP Config] Invalid length: ${otpConfig.length}. ` +
      `Must be between 4 and 8`
    );
  }
  
  // 4. å›ºå®šéªŒè¯ç é•¿åº¦æ£€æŸ¥
  if (otpConfig.mode === 'fixed' && otpConfig.fixedCode.length !== otpConfig.length) {
    throw new Error(
      `[OTP Config] Fixed code length (${otpConfig.fixedCode.length}) ` +
      `does not match configured length (${otpConfig.length})`
    );
  }
  
  console.log(`[OTP Config] Mode: ${otpConfig.mode}`);
  if (otpConfig.mode === 'fixed') {
    console.warn('[OTP Config] âš ï¸  Using FIXED mode (dev/stage only)');
  }
}

// ===== JWT Token é…ç½® =====

/**
 * JWT Token é…ç½®
 */
export const jwtConfig = {
  /**
   * Token æœ‰æ•ˆæœŸï¼ˆå¤©ï¼‰
   */
  expiresInDays: 30,
  
  /**
   * Token åˆ·æ–°é˜ˆå€¼ï¼ˆå¤©ï¼‰
   * å‰©ä½™æ—¶é—´å°äºæ­¤å€¼æ—¶å»ºè®®åˆ·æ–°
   */
  refreshThresholdDays: 7,
} as const;

/**
 * è·å– JWT Secret
 * å¼ºåˆ¶ä»ç¯å¢ƒå˜é‡è¯»å–ï¼Œç¼ºå¤±æ—¶æŠ›å‡ºé”™è¯¯
 */
export function getJwtSecret(): string {
  const secret = process.env.XIAOPEI_JWT_SECRET;
  
  if (!secret) {
    throw new Error(
      '[Security] XIAOPEI_JWT_SECRET is not configured. ' +
      'Please set it in environment variables. ' +
      'For production, use a strong random secret (at least 32 characters).'
    );
  }
  
  // ç”Ÿäº§ç¯å¢ƒæ£€æŸ¥å¯†é’¥å¼ºåº¦
  if (ENV.isProd && secret.length < 32) {
    console.warn(
      '[Security] âš ï¸  JWT Secret is too short for production. ' +
      'Recommended length: 32+ characters'
    );
  }
  
  // æ£€æŸ¥æ˜¯å¦ä¸ºé»˜è®¤å€¼
  if (secret === 'your-secret-key-change-me') {
    throw new Error(
      '[Security] JWT Secret is using default value. ' +
      'Please set XIAOPEI_JWT_SECRET to a strong random secret.'
    );
  }
  
  return secret;
}

// ===== é…ç½®éªŒè¯ =====

/**
 * éªŒè¯æ‰€æœ‰è®¤è¯é…ç½®
 */
export function validateAuthConfig(): void {
  validateOtpConfig();
  getJwtSecret(); // éªŒè¯ JWT Secret æ˜¯å¦å­˜åœ¨
  console.log('[Auth Config] âœ… All configurations validated');
}
```

### 3. æ—¥å¿—å·¥å…·ï¼ˆå®Œæ•´ç‰ˆï¼‰

**æ–‡ä»¶**ï¼š`core/src/utils/logger.ts`

```typescript
/**
 * å®‰å…¨æ—¥å¿—å·¥å…·
 * 
 * åŠŸèƒ½ï¼š
 * 1. ç”Ÿäº§ç¯å¢ƒç¦ç”¨è¯¦ç»†æ—¥å¿—
 * 2. è‡ªåŠ¨è„±æ•æ•æ„Ÿä¿¡æ¯ï¼ˆTokenã€éªŒè¯ç ã€å¯†ç ç­‰ï¼‰
 * 3. ç»Ÿä¸€æ—¥å¿—æ ¼å¼
 */

import { ENV } from '../config/env';

/**
 * è„±æ•æ•æ„Ÿä¿¡æ¯
 */
function sanitize(data: any): any {
  if (typeof data === 'string') {
    // Token è„±æ•ï¼ˆä¿ç•™å‰ 10 ä½å’Œå 4 ä½ï¼‰
    if (data.length > 20) {
      return `${data.substring(0, 10)}...${data.substring(data.length - 4)}`;
    }
    return '***';
  }
  
  if (typeof data === 'object' && data !== null) {
    const sanitized: any = Array.isArray(data) ? [] : {};
    const sensitiveKeys = ['token', 'password', 'code', 'secret', 'apiKey', 'api_key'];
    
    for (const key in data) {
      const lowerKey = key.toLowerCase();
      if (sensitiveKeys.some(sk => lowerKey.includes(sk))) {
        sanitized[key] = '***';
      } else {
        sanitized[key] = sanitize(data[key]);
      }
    }
    return sanitized;
  }
  
  return data;
}

export const logger = {
  /**
   * ä¿¡æ¯æ—¥å¿—ï¼ˆä»…å¼€å‘ç¯å¢ƒï¼‰
   */
  info: (...args: any[]) => {
    if (!ENV.isProd) {
      console.log('[INFO]', ...args.map(sanitize));
    }
  },
  
  /**
   * è­¦å‘Šæ—¥å¿—ï¼ˆæ‰€æœ‰ç¯å¢ƒï¼‰
   */
  warn: (...args: any[]) => {
    console.warn('[WARN]', ...args.map(sanitize));
  },
  
  /**
   * é”™è¯¯æ—¥å¿—ï¼ˆæ‰€æœ‰ç¯å¢ƒï¼‰
   */
  error: (...args: any[]) => {
    console.error('[ERROR]', ...args.map(sanitize));
  },
  
  /**
   * è°ƒè¯•æ—¥å¿—ï¼ˆä»…å¼€å‘ç¯å¢ƒï¼‰
   */
  debug: (...args: any[]) => {
    if (ENV.isDev) {
      console.log('[DEBUG]', ...args.map(sanitize));
    }
  },
};
```

---

## å®æ–½æ—¶é—´è¡¨

### ç¬¬ 1 å‘¨ï¼šæ ¸å¿ƒå®‰å…¨æœºåˆ¶

- [ ] Day 1-2: åˆ›å»ºç¯å¢ƒé…ç½®æ¨¡å—å’Œè®¤è¯é…ç½®æ¨¡å—
- [ ] Day 3-4: ä¿®æ”¹ `authService.ts` å®ç° OTP æ¨¡å¼åˆ‡æ¢
- [ ] Day 5: ä¿®æ”¹ `server.ts` æ·»åŠ å¯åŠ¨å®‰å…¨æ£€æŸ¥
- [ ] Day 6-7: æµ‹è¯•å¼€å‘ç¯å¢ƒå’Œç”Ÿäº§ç¯å¢ƒé…ç½®

### ç¬¬ 2 å‘¨ï¼šæ—¥å¿—å’Œå®¢æˆ·ç«¯å®‰å…¨

- [ ] Day 1-2: åˆ›å»ºæ—¥å¿—å·¥å…·ï¼Œæ›¿æ¢æ‰€æœ‰ `console.log`
- [ ] Day 3-4: App ç«¯ Token å­˜å‚¨æ”¹ä¸º SecureStore
- [ ] Day 5: API å®¢æˆ·ç«¯æ—¥å¿—è„±æ•
- [ ] Day 6-7: å…¨é¢æµ‹è¯•å’Œä¿®å¤

### ç¬¬ 3 å‘¨ï¼šAndroid å’Œä¸Šçº¿å‡†å¤‡

- [ ] Day 1-2: ç”Ÿæˆæ­£å¼ Android keystore
- [ ] Day 3: å®Œå–„ ProGuard è§„åˆ™
- [ ] Day 4-5: ç¯å¢ƒå˜é‡é…ç½®å’Œæ–‡æ¡£
- [ ] Day 6-7: æœ€ç»ˆå®‰å…¨æ£€æŸ¥æ¸…å•éªŒè¯

---

## æ€»ç»“

æœ¬æ–¹æ¡ˆé€šè¿‡**æœºåˆ¶çº§çš„å®‰å…¨è®¾è®¡**ï¼Œç¡®ä¿ï¼š

1. âœ… **å¼€å‘ç¯å¢ƒä¾¿åˆ©æ€§**ï¼šå…è®¸ä½¿ç”¨å›ºå®šéªŒè¯ç ã€è¯¦ç»†æ—¥å¿—ç­‰
2. âœ… **ç”Ÿäº§ç¯å¢ƒå®‰å…¨æ€§**ï¼šå¼ºåˆ¶ä½¿ç”¨å®‰å…¨é…ç½®ï¼Œç¼ºå¤±æ—¶æ‹’ç»å¯åŠ¨
3. âœ… **é…ç½®é›†ä¸­ç®¡ç†**ï¼šæ‰€æœ‰å±é™©å¼€å…³ç»Ÿä¸€åœ¨ config å±‚
4. âœ… **Fail Fast**ï¼šé…ç½®é”™è¯¯æ—¶ç«‹å³å¤±è´¥ï¼Œä¸é»˜é»˜ä½¿ç”¨é»˜è®¤å€¼

**å…³é”®æ”¹è¿›ç‚¹**ï¼š
- JWT Secret å¼ºåˆ¶ä»ç¯å¢ƒå˜é‡è¯»å–ï¼Œç¼ºå¤±æ—¶æ‹’ç»å¯åŠ¨
- OTP æ¨¡å¼å¯é…ç½®ï¼Œç”Ÿäº§ç¯å¢ƒå¼ºåˆ¶ä½¿ç”¨ database æ¨¡å¼
- æ—¥å¿—è‡ªåŠ¨è„±æ•ï¼Œç”Ÿäº§ç¯å¢ƒç¦ç”¨è¯¦ç»†æ—¥å¿—
- Token ä½¿ç”¨åŠ å¯†å­˜å‚¨ï¼Œç§»é™¤æ‰€æœ‰æ˜æ–‡æ—¥å¿—

**ä¸‹ä¸€æ­¥**ï¼šæŒ‰ç…§å®æ–½æ—¶é—´è¡¨é€æ­¥æ¨è¿›ï¼Œä¼˜å…ˆå®Œæˆ P0 é¡¹ï¼Œç¡®ä¿ä¸Šçº¿å‰æ‰€æœ‰ä¸¥é‡é£é™©å·²ä¿®å¤ã€‚

---

**æ–‡æ¡£ç»´æŠ¤**ï¼šæœ¬æ–‡æ¡£åº”éšå®‰å…¨ç­–ç•¥è°ƒæ•´è€Œæ›´æ–°ï¼Œå»ºè®®æ¯å­£åº¦å®¡æŸ¥ä¸€æ¬¡ã€‚



