# 问题诊断与修复方案 - 紧急

## ❌ 当前问题

1. **协议打不开** - 显示错误"無法載入文檔,請檢查網絡連接"
2. **短信收不到** - 验证码发送失败
3. **Google 登录不工作** - 一键登录失败
4. **华为 Mate 40 优化未生效** - UI 适配问题

---

## 🔍 根本原因分析

### 问题 1：协议 PDF 加载失败

**原因**：
- 使用了 Google Docs Viewer，但可能无法访问（网络问题/CORS）
- 从测试看，Google Docs Viewer 连接超时

**修复方案**：
- ✅ 已修改：直接使用 PDF URL，不使用 Google Docs Viewer
- ✅ 如果直接加载失败，使用"在浏览器中打开"备用方案

### 问题 2：短信收不到

**可能原因**：
1. **API_BASE_URL 配置错误** - 生产包可能使用了 localhost
2. **请求参数不匹配** - `region` 参数可能未正确传递
3. **后端未收到请求** - 需要检查 Cloud Run 日志

**修复方案**：
- ✅ 已修复：`RequestOtpRequest` 类型添加 `region` 和 `countryCode` 字段
- ⚠️ 需要验证：API_BASE_URL 是否正确

### 问题 3：Google 登录不工作

**可能原因**：
1. **webClientId 配置错误** - 生产环境可能使用了错误的 Client ID
2. **Google Sign-In 未初始化** - 需要检查初始化逻辑
3. **需要 Development Build** - 生产包可能不支持

**需要检查**：
- `GOOGLE_CONFIG.webClientId` 是否正确
- Google Sign-In 初始化是否成功

### 问题 4：华为 Mate 40 优化未生效

**可能原因**：
- 代码修改未包含在构建中
- SafeAreaView 配置不正确

---

## ✅ 已完成的修复

### 1. PDF 加载修复

**修改文件**: `app/src/screens/Auth/PolicyViewerScreen.tsx`

**修改内容**：
```typescript
// ❌ 修复前：使用 Google Docs Viewer（可能无法访问）
const pdfUrl = `https://docs.google.com/viewer?url=${encodeURIComponent(rawPdfUrl)}&embedded=true`;

// ✅ 修复后：直接使用 PDF URL
const pdfUrl = rawPdfUrl;
```

**说明**：
- Android WebView 在某些版本支持直接加载 PDF
- 如果不支持，会触发错误处理，用户可以点击"在浏览器中打开"

### 2. 短信请求参数修复

**修改文件**: `app/src/types/user.ts`

**修改内容**：
```typescript
export interface RequestOtpRequest {
  phone?: string;
  email?: string;
  purpose?: 'login' | 'reset_password';
  region?: 'cn' | 'hk' | 'mo' | 'tw' | 'intl';  // ✅ 新增
  countryCode?: string;  // ✅ 新增
}
```

**说明**：
- 确保 `region` 和 `countryCode` 可以正确传递到后端

---

## 🔧 需要进一步检查的问题

### 1. API_BASE_URL 是否正确

**检查方法**：
```bash
# 在设备上查看日志
adb logcat | grep "ENV DIAGNOSTIC"
```

**预期输出**：
```
[ENV DIAGNOSTIC] 🔍 API_BASE_URL: https://xiaopei-core-343578696044.asia-east2.run.app
[ENV DIAGNOSTIC] 🔍 EXPO_PUBLIC_API_BASE_URL: https://xiaopei-core-343578696044.asia-east2.run.app
[ENV DIAGNOSTIC] 🔍 APP_ENV: production
```

**如果输出不正确**：
- 如果显示 `http://localhost:3000` → EAS 环境变量未正确注入
- 如果显示 `❌ 未设置` → 需要检查 `eas.json` 配置

### 2. Google Sign-In 配置

**检查文件**: `app/src/config/google.ts`

**需要确认**：
- `webClientId` 是否正确（生产环境）
- Google Sign-In 初始化是否成功

### 3. 构建是否包含最新代码

**检查方法**：
1. 查看构建日志，确认文件被上传
2. 检查版本号（应该是 1.0.2）
3. 本地测试代码修改是否生效

---

## 🚀 立即执行的修复步骤

### 步骤 1：验证代码修改

```bash
cd /Users/gaoxuxu/Desktop/xiaopei-app/app

# 检查 PDF 加载修复
grep -n "const pdfUrl = rawPdfUrl" src/screens/Auth/PolicyViewerScreen.tsx

# 检查类型定义修复
grep -n "region\?:" src/types/user.ts

# 检查环境变量诊断
grep -n "ENV DIAGNOSTIC" src/config/env.ts
```

### 步骤 2：重新构建（必须使用 --clear-cache）

```bash
cd /Users/gaoxuxu/Desktop/xiaopei-app/app

# 更新版本号（如果需要）
# 修改 app.json: version: "1.0.3"

# 清除缓存并构建
eas build --platform android --profile production --clear-cache --non-interactive
```

### 步骤 3：测试验证

1. **环境变量诊断**：
   ```bash
   adb logcat | grep "ENV DIAGNOSTIC"
   ```

2. **协议查看**：
   - 打开用户协议
   - 检查是否直接加载 PDF
   - 如果失败，测试"在浏览器中打开"

3. **短信发送**：
   - 输入手机号
   - 点击发送验证码
   - 查看 Cloud Run 日志确认是否收到请求

4. **Google 登录**：
   - 点击 Google 登录按钮
   - 检查是否有错误提示
   - 查看日志确认初始化状态

---

## 📋 问题排查清单

### 如果协议仍然打不开

1. **检查 PDF URL**：
   ```bash
   curl -I https://xiaopei-core-343578696044.asia-east2.run.app/public/docs/miaosuan_user_agreement_zh-HK.pdf
   ```

2. **检查 WebView 错误**：
   - 查看 React Native Debugger 日志
   - 搜索 "WebView" 或 "PDF" 相关错误

3. **测试备用方案**：
   - 点击"在浏览器中打开"
   - 确认是否能在浏览器中正常打开

### 如果短信仍然收不到

1. **检查 API_BASE_URL**：
   ```bash
   adb logcat | grep "ENV DIAGNOSTIC"
   ```

2. **检查请求参数**：
   - 查看发送验证码时的日志
   - 确认 `region` 和 `countryCode` 是否正确传递

3. **检查后端日志**：
   ```bash
   gcloud logging read \
     "resource.type=cloud_run_revision AND resource.labels.service_name=xiaopei-core" \
     --limit=50 \
     --format=json \
     --filter="textPayload=~'SMS|request-otp|验证码'"
   ```

### 如果 Google 登录仍然不工作

1. **检查配置**：
   - 查看 `app/src/config/google.ts`
   - 确认 `webClientId` 是否正确

2. **检查初始化**：
   - 查看日志中是否有 "Google Config" 输出
   - 确认 Google Sign-In 是否初始化成功

3. **检查错误信息**：
   - 查看是否有 "需要 Development Build" 提示
   - 查看是否有其他错误信息

---

## ⚠️ 关键修复点

1. **PDF 加载**：已改为直接加载，不使用 Google Docs Viewer
2. **短信参数**：已添加 `region` 和 `countryCode` 字段
3. **环境变量**：需要验证 API_BASE_URL 是否正确
4. **Google 登录**：需要检查配置和初始化

---

## 🎯 下一步

1. ✅ 代码修复已完成
2. ⏳ 需要重新构建（使用 --clear-cache）
3. ⏳ 需要测试验证
4. ⏳ 根据测试结果进一步修复

