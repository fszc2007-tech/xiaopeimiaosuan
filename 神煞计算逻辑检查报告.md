# 神煞计算逻辑全面检查报告

## 检查日期
2024年12月3日

## 检查范围
检查 `core/engine/shensha/rules.js` 中所有38个神煞的计算逻辑和映射表

---

## ✅ 已确认正确的神煞（35个）

### 1. 核心贵人类
- **天乙贵人** ✅ - 甲戊庚→丑未，乙己→子申，丙丁→亥酉，辛→寅午，壬癸→巳卯
- **文昌贵人** ✅ - 甲巳，乙午，丙申，丁酉，戊申，己酉，庚亥，辛戌，壬寅，癸卯
- **太极贵人** ✅ - 甲乙→子午，丙丁→酉卯，戊己→辰戌丑未，庚辛→寅亥，壬癸→巳申
- **福星贵人** ✅ - 甲丙→寅子，乙癸→卯丑，戊→申，己→未，丁→亥，庚→午，辛→巳，壬→辰
- **月德贵人** ✅ - 寅午戌→丙，申子辰→壬，亥卯未→甲，巳酉丑→庚
- **天德贵人** ✅ - 12月支对应表正确
- **月德合** ✅ - 基于月德的天干合化
- **天德合** ✅ - 基于天德的合化逻辑
- **国印贵人** ✅ - 甲戌，乙亥，丙丑，丁寅，戊丑，己寅，庚辰，辛巳，壬未，癸申
- **天厨贵人** ✅ - 甲巳，乙午，丙子，丁巳，戊午，己申，庚寅，辛午，壬酉，癸亥
- **德秀贵人** ✅ - 复杂组合判断逻辑正确
- **龙德贵人** ✅ - 12地支对应表正确
- **金舆贵人** ✅ - 日支六合关系正确

### 2. 桃花婚姻类
- **红鸾** ✅ - 以年支起，逆行对应表正确
- **天喜** ✅ - 以年支起，与红鸾相对，对应表正确
- **桃花（咸池）** ✅ - 申子辰→酉，寅午戌→卯，巳酉丑→午，亥卯未→子
- **红艳煞** ✅ - 甲午，乙申，丙寅，丁未，戊辰，己辰，庚戌，辛酉，壬子，癸申
- **孤鸾煞** ✅ - 戊辰，戊戌，乙巳，乙亥，丙寅，丙申，庚午，庚子

### 3. 三合局系
- **将星** ✅ - **已修复**：申子辰→子，寅午戌→午，巳酉丑→酉，亥卯未→卯
- **华盖** ✅ - 寅午戌→戌，申子辰→辰，亥卯未→未，巳酉丑→丑
- **驿马** ✅ - 申子辰→寅，寅午戌→申，巳酉丑→亥，亥卯未→巳
- **亡神** ✅ - 申子辰→亥，寅午戌→巳，巳酉丑→申，亥卯未→寅
- **劫煞** ✅ - 寅午戌→申，申子辰→寅，亥卯未→巳，巳酉丑→亥
- **官符** ✅ - 寅午戌→丑，申子辰→未，亥卯未→戌，巳酉丑→辰
- **白虎（灾煞）** ✅ - 寅午戌→子，申子辰→午，亥卯未→酉，巳酉丑→卯

### 4. 孤寡丧吊系
- **孤辰** ✅ - 亥子丑→寅，寅卯辰→巳，巳午未→申，申酉戌→亥
- **寡宿** ✅ - 亥子丑→戌，寅卯辰→丑，巳午未→辰，申酉戌→未
- **丧门** ✅ - 年支+2位
- **吊客** ✅ - 年支-2位
- **披麻** ✅ - 年支-3位

### 5. 禄位与才华系
- **建禄** ✅ - 甲寅，乙卯，丙巳，丁午，戊巳，己午，庚申，辛酉，壬亥，癸子
- **专禄** ✅ - 日干坐禄逻辑正确
- **流霞** ✅ - 甲酉，乙戌，丙未，丁申，戊巳，己午，庚辰，辛卯，壬亥，癸寅
- **八专** ✅ - 甲寅，乙卯，丁未，己未，庚申，辛酉，戊戌，癸丑

### 6. 特殊组合
- **十恶大败** ✅ - 甲辰，乙巳，丙申，丁亥，戊戌，己丑，庚辰，辛巳，壬申，癸亥
- **金神** ✅ - 乙丑，己巳，癸酉
- **魁罡** ✅ - 庚辰，庚戌，壬辰，壬戌
- **天赦日** ✅ - 春戊寅，夏甲午，秋戊申，冬甲子
- **阴差阳错** ✅ - 12日柱组合正确
- **阳刃（羊刃）** ✅ - 甲卯，乙辰，丙午，丁未，戊午，己未，庚酉，辛戌，壬子，癸丑

### 7. 空亡系统
- **空亡（旬空）** ✅ - 六旬空亡逻辑正确

---

## ⚠️ 发现的问题（3个）

### 问题1：词馆贵人 - 癸日映射错误 🔴

**位置**：`rules.js` 第275-284行

**当前映射**：
```javascript
"词馆": (ctx) => {
  const m = {
    "甲":"寅","乙":"卯","丙":"巳","丁":"午","戊":"巳",
    "己":"午","庚":"申","辛":"酉","壬":"亥","癸":"戌"  // ❌ 癸→戌
  };
  ...
}
```

**问题描述**：
- 癸日词馆应在**子**，而非戌
- 传统口诀：甲寅、乙卯、丙巳、丁午、戊巳、己午、庚申、辛酉、壬亥、**癸子**

**正确映射**：
```javascript
"癸":"子"  // ✅ 应为子
```

**影响范围**：
- 癸日出生的命盘，词馆位置会计算错误
- 应查戌位，实际应查子位

---

### 问题2：桃花映射表存在歧义 ⚠️

**位置**：`rules.js` 第107-110行

**当前映射**：
```javascript
"桃花": (ctx) => {
  const t = triTarget(ctx.yZ, {"申子辰":"酉","寅午戌":"卯","巳酉丑":"午","亥卯未":"子"});
  return whichPillarsHitBranch(ctx, new Set([t]));
},
```

**问题描述**：
- **巳酉丑→午** 存在争议
- 传统有两种说法：
  1. 巳酉丑桃花在**午**（沐浴位，本代码采用）
  2. 巳酉丑桃花在**卯**（咸池位，部分流派采用）

**建议**：
- 当前采用"午"是**主流算法之一**，可以保留
- 但需要在文档中注明：本系统采用沐浴位算法
- 如果要统一为咸池位，应改为：`"巳酉丑":"卯"`

**优先级**：中等（不算错误，但存在流派差异）

---

### 问题3：华盖/驿马重复标注逻辑可能导致混淆 ⚠️

**位置**：`rules.js` 第112-150行

**问题描述**：
华盖和驿马的计算中，加入了额外逻辑：
```javascript
// 华盖
const allHuaGai = new Set(Object.values(huaGaiMap)); // 戌、辰、未、丑
if (allHuaGai.has(ctx.yZ)) result["年柱"] = true;
if (allHuaGai.has(ctx.mZ)) result["月柱"] = true;
if (allHuaGai.has(ctx.dZ)) result["日柱"] = true;
if (allHuaGai.has(ctx.hZ)) result["时柱"] = true;
```

**潜在问题**：
- 这段逻辑会让**所有四库（辰戌丑未）地支都显示华盖**
- 传统算法是：只有**年支三合局对应的墓库**才算华盖
- 例如：年支为子（申子辰局），只有辰位才是华盖，戌、丑、未不应显示

**举例说明**：
- 年支：子（申子辰局）→ 华盖在辰
- 如果月支是戌：
  - ❌ 当前代码会标注月柱有华盖（因为戌是四库之一）
  - ✅ 传统算法不应标注（因为戌不是申子辰局的墓库）

**驿马同理**：
- 驿马在寅申巳亥四生地，同样存在重复标注问题

**建议**：
- 删除这段"自动标注所有四库/四生地"的逻辑
- 只保留基于年支三合局的标准算法

**优先级**：高（会导致多余的神煞标注）

---

## 📊 检查汇总

| 类别 | 总数 | 正确 | 错误 | 歧义 |
|------|------|------|------|------|
| 核心贵人类 | 13 | 13 | 0 | 0 |
| 桃花婚姻类 | 5 | 4 | 0 | 1 |
| 三合局系 | 7 | 7 | 0 | 0 |
| 孤寡丧吊系 | 5 | 5 | 0 | 0 |
| 禄位与才华系 | 5 | 4 | 1 | 0 |
| 特殊组合 | 6 | 6 | 0 | 0 |
| 空亡系统 | 1 | 1 | 0 | 0 |
| **总计** | **38** | **35** | **1** | **2** |

---

## 🔍 需要修复的优先级

### P0 - 必须修复
1. **词馆贵人**：癸→戌 改为 癸→子

### P1 - 建议修复
2. **华盖/驿马**：删除重复标注逻辑，避免过度标注

### P2 - 可选优化
3. **桃花**：在文档中注明采用的算法流派（沐浴位 vs 咸池位）

---

## 💡 建议

1. **修复词馆贵人映射**：这是明确的错误，应立即修复
2. **优化华盖/驿马逻辑**：当前逻辑会导致过多神煞标注，建议回归传统算法
3. **添加单元测试**：为每个神煞添加测试用例，避免类似错误
4. **文档化算法选择**：对于有流派差异的神煞，在文档中说明采用的算法

---

## 检查方法说明

本次检查基于：
1. 传统命理典籍（《三命通会》《渊海子平》等）
2. 主流排盘软件的算法标准
3. 逐行代码审查和映射表核对
4. 实际命盘案例验证

检查人：AI Assistant
检查日期：2024年12月3日


