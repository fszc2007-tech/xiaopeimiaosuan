# 腾讯云短信真实发送 - 实施完成报告

## 一、修改概述

已成功移除 mock 逻辑，集成真实的腾讯云短信服务，支持通过腾讯验证码登录。

## 二、主要修改内容

### 2.1 修改 `core/src/modules/auth/authService.ts`

#### 2.1.1 `requestOTP` 函数改造

**移除内容**：
- ❌ 移除开发模式判断（`NODE_ENV !== 'production'`）
- ❌ 移除固定验证码 123456 逻辑
- ❌ 移除基于 MySQL 的简单限流逻辑

**新增内容**：
- ✅ 集成 `phoneNormalizer` 规范化手机号（E.164 格式）
- ✅ 集成 `rateLimitService` 进行三层限流检查：
  - 1 分钟：1 条
  - 1 小时：5 条
  - 24 小时：10 条
  - IP 限流：1 小时 20 条
- ✅ 集成 `smsService` 调用腾讯云短信服务发送真实验证码
- ✅ 验证短信服务配置完整性
- ✅ 支持 `countryCode` 和 `clientIp` 参数

**流程**：
1. 规范化手机号（E.164 格式）
2. 验证短信服务配置
3. 限流检查（手机号 + IP）
4. 生成验证码并保存到 MySQL
5. 调用腾讯云短信服务发送
6. 如果发送失败，删除已保存的验证码

#### 2.1.2 `loginOrRegister` 函数改造

**移除内容**：
- ❌ 移除固定验证码 `123456` 的硬编码逻辑

**新增内容**：
- ✅ 从数据库查询验证码进行验证
- ✅ 验证码有效性检查（未使用、未过期、匹配）
- ✅ 标记验证码为已使用
- ✅ 支持 `countryCode` 参数
- ✅ 规范化手机号处理

**流程**：
1. 规范化手机号
2. 从数据库查询验证码
3. 验证有效性（未使用、未过期、匹配）
4. 标记为已使用
5. 查找或创建用户
6. 生成 JWT Token

### 2.2 修改 `core/src/routes/auth.ts`

#### 2.2.1 `/request-otp` 路由

**新增参数**：
- `countryCode`：国家代码（如 "+86", "+852"）
- `clientIp`：自动从请求头获取客户端 IP（用于限流）

**修改**：
- 移除邮箱登录支持，仅支持手机号登录
- 传递 `countryCode` 和 `clientIp` 给 `authService.requestOTP`

#### 2.2.2 `/login_or_register` 路由

**新增参数**：
- `countryCode`：国家代码

**修改**：
- 移除邮箱登录支持，仅支持手机号登录
- 传递 `countryCode` 给 `authService.loginOrRegister`
- 改进错误处理，支持验证码相关错误

### 2.3 修改 `core/src/config/auth.ts`

**新增配置**：
- `hourlyLimit: 5`：每小时发送次数限制（用于 rateLimitService）

## 三、环境变量配置要求

### 3.1 必需的环境变量

在 `core/.env` 文件中配置以下变量：

```bash
# ===== 腾讯云 API 密钥 =====
XIAOPEI_TENCENT_SECRET_ID=your_secret_id_here
XIAOPEI_TENCENT_SECRET_KEY=your_secret_key_here

# ===== 腾讯云短信配置 =====
XIAOPEI_TENCENT_SMS_APP_ID=your_sms_app_id_here
XIAOPEI_TENCENT_SMS_TEMPLATE_ID=2929187
XIAOPEI_TENCENT_SMS_REGION=ap-singapore  # 海外账户使用新加坡region

# ===== Redis 配置（用于限流）=====
XIAOPEI_REDIS_URL=redis://localhost:6379

# ===== 验证码安全配置 =====
XIAOPEI_SMS_CODE_SALT=your_random_salt_change_me_2024
```

### 3.2 配置说明

1. **腾讯云 API 密钥**：在腾讯云控制台 → 访问管理 → API 密钥管理 获取
2. **短信应用 ID**：在腾讯云短信控制台 → 应用管理 获取
3. **模板 ID**：已申请的模板 ID（2929187）
4. **Redis**：用于限流服务，必须配置
5. **验证码盐值**：用于哈希验证码的随机字符串（至少 32 位）

## 四、API 接口说明

### 4.1 发送验证码

**接口**：`POST /api/v1/auth/request-otp`

**请求参数**：
```json
{
  "phone": "91234567",        // 手机号（纯数字，无前缀）
  "countryCode": "+852",      // 国家代码（可选，默认根据 region 设置）
  "region": "hk"              // 地区（cn 或 hk）
}
```

**响应**：
```json
{
  "success": true,
  "data": {
    "message": "驗證碼已發送"  // 根据地区返回简体/繁体/英文
  }
}
```

**错误响应**：
```json
{
  "success": false,
  "error": {
    "code": "RATE_LIMITED_1M",
    "message": "發送過於頻繁，請 60 秒後重試"
  }
}
```

### 4.2 登录/注册

**接口**：`POST /api/v1/auth/login_or_register`

**请求参数**：
```json
{
  "phone": "91234567",        // 手机号（纯数字）
  "countryCode": "+852",      // 国家代码（可选）
  "code": "123456",           // 验证码（6 位数字）
  "channel": "hk"             // 地区（cn 或 hk）
}
```

**响应**：
```json
{
  "success": true,
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "user": {
      "userId": "xxx",
      "nickname": "用户4567",
      "phone": "+85291234567",
      ...
    }
  }
}
```

## 五、测试步骤

### 5.1 环境准备

1. **确保 Redis 服务运行**：
```bash
redis-cli ping
# 应返回 PONG
```

2. **检查环境变量**：
```bash
cd core
cat .env | grep XIAOPEI_TENCENT
cat .env | grep XIAOPEI_REDIS
```

3. **启动后端服务**：
```bash
cd core
npm run dev
```

### 5.2 测试发送验证码

**测试命令**：
```bash
curl -X POST http://localhost:3000/api/v1/auth/request-otp \
  -H "Content-Type: application/json" \
  -d '{
    "phone": "91234567",
    "countryCode": "+852",
    "region": "hk"
  }'
```

**预期结果**：
- ✅ 返回成功响应
- ✅ 手机收到真实验证码短信
- ✅ 验证码保存到数据库

### 5.3 测试登录

**测试命令**：
```bash
curl -X POST http://localhost:3000/api/v1/auth/login_or_register \
  -H "Content-Type: application/json" \
  -d '{
    "phone": "91234567",
    "countryCode": "+852",
    "code": "123456",
    "channel": "hk"
  }'
```

**预期结果**：
- ✅ 使用真实收到的验证码登录成功
- ✅ 返回 JWT Token 和用户信息
- ✅ 验证码标记为已使用

### 5.4 测试限流

**测试步骤**：
1. 连续发送 2 次验证码（间隔 < 60 秒）
2. 第 2 次应返回限流错误

**测试命令**：
```bash
# 第 1 次
curl -X POST http://localhost:3000/api/v1/auth/request-otp \
  -H "Content-Type: application/json" \
  -d '{"phone": "91234567", "countryCode": "+852", "region": "hk"}'

# 立即发送第 2 次（应被限流）
curl -X POST http://localhost:3000/api/v1/auth/request-otp \
  -H "Content-Type: application/json" \
  -d '{"phone": "91234567", "countryCode": "+852", "region": "hk"}'
```

**预期结果**：
- ✅ 第 1 次成功
- ✅ 第 2 次返回 `RATE_LIMITED_1M` 错误

### 5.5 测试验证码验证

**测试步骤**：
1. 发送验证码
2. 使用错误验证码登录（应失败）
3. 使用正确验证码登录（应成功）
4. 再次使用相同验证码登录（应失败，已使用）

## 六、注意事项

### 6.1 短信费用

- 真实短信发送会产生费用
- 港澳台短信费用约为大陆的 2 倍
- 建议在测试环境先验证功能

### 6.2 配置检查

- 启动前必须配置所有必需的环境变量
- 短信服务配置验证失败会阻止发送
- Redis 连接失败会导致限流功能失效

### 6.3 错误处理

- 短信发送失败时，已保存的验证码会被删除
- 验证码错误会返回明确的错误信息（根据地区返回简体/繁体/英文）
- 限流错误会返回重试等待时间

## 七、后续优化建议

1. **监控告警**：添加短信发送量监控和成本告警
2. **审计日志**：记录所有短信发送和验证码校验的审计日志
3. **验证码存储**：考虑使用 Redis Hash 存储验证码（当前使用 MySQL）
4. **签名申请**：申请腾讯云短信签名，提升短信送达率

## 八、完成状态

- ✅ 移除开发模式判断
- ✅ 集成真实短信服务
- ✅ 集成手机号规范化
- ✅ 集成限流服务
- ✅ 修改登录验证逻辑
- ✅ 更新路由支持新参数
- ✅ 添加配置验证

**状态**：✅ 已完成，可以开始测试真实短信发送

