# 数据库表结构比对报告

生成时间: 2025-12-26

## 开发环境表结构

### 表数量
- **总计**: 25 张表

### 关键表结构

#### 1. llm_api_configs (LLM API 配置表)
- **列数**: 15
- **索引数**: 2
- **列列表**:
  - config_id (varchar(36), PRIMARY KEY)
  - model (varchar(50), UNIQUE)
  - api_key_encrypted (text, NULL)
  - api_url (varchar(255), NOT NULL)
  - is_enabled (tinyint(1), NULL, DEFAULT 1)
  - thinking_mode (tinyint(1), NULL, DEFAULT 0)
  - created_at (datetime, NOT NULL)
  - updated_at (datetime, NOT NULL)
  - model_name (varchar(100), NULL)
  - enable_stream (tinyint(1), NULL, DEFAULT 1)
  - temperature (decimal(3,2), NULL, DEFAULT 0.70)
  - max_tokens (int, NULL, DEFAULT 4000)
  - is_default (tinyint(1), NULL, DEFAULT 0)
  - test_status (enum, NULL, DEFAULT 'not_tested')
  - test_message (text, NULL)

#### 2. conversations (对话表)
- **列数**: 11
- **索引数**: 4
- **列列表**:
  - conversation_id (varchar(36), PRIMARY KEY)
  - user_id (varchar(36), NOT NULL, INDEX)
  - chart_profile_id (varchar(36), NULL, INDEX)
  - topic (varchar(50), NULL)
  - first_question (text, NULL)
  - last_message_preview (text, NULL)
  - created_at (datetime, NOT NULL)
  - updated_at (datetime, NOT NULL)
  - title (varchar(255), NULL) ✅ **已添加**
  - source (varchar(50), NULL) ✅ **已添加**
  - last_message_at (datetime, NULL) ✅ **已添加**

#### 3. users (用户表)
- **列数**: 25
- **索引数**: 9
- **关键列**:
  - user_id (varchar(36), PRIMARY KEY)
  - phone (varchar(32), NULL, UNIQUE)
  - is_pro (tinyint(1), NULL, DEFAULT 0)
  - pro_expires_at (datetime, NULL, INDEX) ✅ **已添加**
  - pro_plan (enum, NULL) ✅ **已添加**
  - ai_calls_today (int, NOT NULL, DEFAULT 0)
  - ai_calls_date (varchar(10), NOT NULL, DEFAULT '')

#### 4. messages (消息表)
- **列数**: 6
- **索引数**: 3
- **列列表**:
  - message_id (varchar(36), PRIMARY KEY)
  - conversation_id (varchar(36), NOT NULL, INDEX)
  - role (enum, NOT NULL)
  - content (text, NOT NULL)
  - follow_ups (json, NULL)
  - created_at (datetime, NOT NULL)

#### 5. verification_codes (验证码表)
- **列数**: 7
- **索引数**: 8
- **列列表**:
  - code_id (varchar(36), PRIMARY KEY)
  - phone (varchar(32), NULL, INDEX) ✅ **已扩展为 VARCHAR(32)**
  - code (varchar(10), NOT NULL)
  - code_type (enum, NOT NULL)
  - expires_at (datetime, NOT NULL, INDEX)
  - is_used (tinyint(1), NULL, DEFAULT 0)
  - created_at (datetime, NOT NULL)

### 所有表列表

1. account_audit_logs (15 列)
2. admin_users (9 列)
3. admins (7 列)
4. auth_identities (9 列)
5. bazi_charts (7 列)
6. chart_profiles (12 列)
7. chat_message_feedback (12 列)
8. conversations (11 列) ✅ **已添加 source, title, last_message_at**
9. day_stem_readings (7 列)
10. feedbacks (10 列)
11. llm_api_config (15 列) ⚠️ **重复表？**
12. llm_api_configs (15 列)
13. llm_pricing_rules (11 列)
14. llm_usage_daily (11 列)
15. llm_usage_logs (17 列)
16. messages (6 列)
17. rate_limits (7 列)
18. readings (8 列)
19. shensha_readings (16 列)
20. shishen_readings (14 列)
21. subscriptions (11 列)
22. system_settings (5 列)
23. user_settings (7 列)
24. users (25 列) ✅ **已添加 pro_expires_at, pro_plan**
25. verification_codes (7 列) ✅ **phone 字段已扩展为 VARCHAR(32)**

## 发现的问题

### 1. DeepSeek API Key 配置问题
- **现象**: API Key 存在但解密失败
- **原因**: 加密密钥加载时机问题（模块加载时环境变量可能未加载）
- **修复**: 已修复 `encryption.ts`，改为延迟获取加密密钥

### 2. 数据库表不一致
- **现象**: 开发环境有 25 张表，生产环境表结构未知
- **需要**: 通过 Cloud SQL Proxy 查询生产环境表结构进行比对

### 3. 重复表名
- **发现**: `llm_api_config` 和 `llm_api_configs` 同时存在
- **建议**: 检查是否需要合并或删除其中一个

## 下一步行动

1. ✅ 修复加密密钥加载问题
2. ⏳ 查询生产环境表结构
3. ⏳ 比对表结构差异
4. ⏳ 执行必要的数据库迁移
5. ⏳ 验证 DeepSeek API Key 配置

