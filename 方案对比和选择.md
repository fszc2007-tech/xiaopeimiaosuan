# Token 丢失问题 - 解决方案对比

## 📋 用户提出的 8 个方案评估

### ✅ 方案 1：检查 AsyncStorage 读取时机
**状态**: 已实施
- 我们已经使用 `onRehydrateStorage` 和 `_hasHydrated` 状态
- `RootNavigator` 会等待 hydration 完成再渲染

### ⭐ 方案 2：手动管理 AsyncStorage【推荐立即实施】
**状态**: 待实施
**优先级**: 🔥 最高

**为什么选这个？**
1. ✅ 完全可控，不依赖 Zustand persist 的实现细节
2. ✅ 可以精确追踪每次读写操作
3. ✅ 避免 `migrate` 函数可能的问题
4. ✅ 代码简单明了，易于调试

**实施计划**：
```typescript
// 创建独立的 tokenStorage.ts
export const tokenStorage = {
  async save(token: string) {
    await AsyncStorage.setItem('xiaopei-token', token);
    console.log('[TokenStorage] ✅ Token 已保存');
  },
  
  async load(): Promise<string | null> {
    const token = await AsyncStorage.getItem('xiaopei-token');
    console.log('[TokenStorage] 读取 Token:', !!token);
    return token;
  },
  
  async clear() {
    await AsyncStorage.removeItem('xiaopei-token');
    console.log('[TokenStorage] ✅ Token 已清除');
  }
};

// 在 authStore.login 中调用
login: async (user, token) => {
  set({ user, token, isAuthenticated: true });
  await tokenStorage.save(token);  // 手动保存
},

// 在 App 启动时恢复
useEffect(() => {
  const restoreToken = async () => {
    const token = await tokenStorage.load();
    if (token) {
      useAuthStore.setState({ token, isAuthenticated: true });
    }
  };
  restoreToken();
}, []);
```

---

### ✅ 方案 3：调试日志和异步操作
**状态**: 已实施
- 已增强 `onRehydrateStorage` 日志
- 已在 `apiClient` 添加详细日志
- 已在 `MeScreen` 添加"查看 AsyncStorage"按钮

---

### ⚠️ 方案 4：检查 React Native 版本兼容性
**状态**: 待检查

需要查看：
- React Native 版本
- @react-native-async-storage/async-storage 版本
- Zustand 版本

---

### 🔒 方案 5：使用 React Native Secure Storage
**状态**: 保留作为备选
**优先级**: 低（安全性更高，但当前问题不是安全性）

**评估**：
- ✅ 优点：更安全（加密存储）
- ❌ 缺点：需要安装新依赖，增加复杂度
- 📝 建议：先解决当前问题，后续可考虑升级

---

### 🔄 方案 6：Token 自动刷新机制
**状态**: 未实施
**优先级**: 低（属于功能增强，不是当前问题的根本解决方案）

**评估**：
- 当前 Token 有效期是 30 天，暂时不需要刷新
- 应该在基础功能稳定后再考虑

---

### 🚪 方案 7：重启后提示重新登录
**状态**: 已实施（作为兜底方案）
**优先级**: 中

当前已有的兜底机制：
- `RootNavigator` 检测 `isAuthenticated`，未登录时显示登录页
- API 返回 401 时，前端会跳转到登录页

---

### 🔍 方案 8：进一步调试
**状态**: 正在进行
**优先级**: 高

**下一步**：
1. 查看重启后的日志，确认 `hasToken` 值
2. 如果 `hasToken: false`，立即实施方案 2

---

## 🎯 推荐执行顺序

### 立即执行（现在）
1. **用户测试**：重启 App，查看 `[authStore] ✅ 数据恢复完成` 日志
2. **如果失败**：立即实施方案 2（手动 AsyncStorage）

### 短期执行（今天内）
3. 检查版本兼容性（方案 4）
4. 验证修复效果

### 中期执行（本周内）
5. 考虑是否需要 Secure Storage（方案 5）
6. 优化错误提示（方案 7）

### 长期执行（未来迭代）
7. 实施 Token 自动刷新（方案 6）

---

## 🚀 立即实施方案 2 的理由

如果 Zustand persist 有问题，手动管理是最直接的解决方案：

**对比**：
| 方案 | Zustand persist | 手动 AsyncStorage |
|------|----------------|-------------------|
| 可控性 | ⚠️ 依赖第三方实现 | ✅ 完全可控 |
| 调试难度 | ⚠️ 难以追踪内部逻辑 | ✅ 每步可追踪 |
| 可靠性 | ⚠️ 可能有兼容性问题 | ✅ 原生 API，稳定 |
| 代码量 | ✅ 少（10行配置） | ⚠️ 多（50行实现） |
| 性能 | ✅ 自动序列化 | ⚠️ 需手动管理 |

**结论**：在当前 Token 丢失的情况下，**可靠性 > 代码简洁性**，应该立即实施方案 2。

---

## ❓ 等待用户反馈

**现在请告诉我：**
1. 你重启 App 了吗？
2. 控制台显示 `hasToken: true` 还是 `false`？

如果是 `false`，我会立即实施方案 2（预计 5 分钟完成）。

