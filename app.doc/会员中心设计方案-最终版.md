# 小佩會員中心（已訂閱用戶）最終設計稿

> **定位**：已訂閱用戶的「會員總覽 / 控制台」  
> **入口**：`Me → 小佩服務`  
> **設計時間**：2025-01-XX

---

## 1️⃣ 會員狀態 State Machine

### 狀態定義

統一使用枚舉狀態，供前端/後端/產品共用：

```ts
type MembershipState =
  | 'non_pro'         // 未訂閱
  | 'pro_active'      // 有效期內
  | 'pro_expiring'    // 距離到期 <= 7 天
  | 'pro_expired';    // 已過期
```

### 狀態判斷規則

```ts
function getMembershipState(isPro: boolean, proExpiresAt: string | null): MembershipState {
  if (!isPro || !proExpiresAt) {
    return 'non_pro';
  }
  
  const expiresAt = new Date(proExpiresAt);
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  
  if (expiresAt < today) {
    return 'pro_expired';
  }
  
  const daysUntilExpiry = Math.ceil((expiresAt.getTime() - today.getTime()) / (1000 * 60 * 60 * 24));
  
  if (daysUntilExpiry <= 7) {
    return 'pro_expiring';
  }
  
  return 'pro_active';
}
```

### 導航邏輯（綁定 State）

**所有頁面跳轉、UI 狀態，都只看 `membershipState`，不要到處自己算。**

```tsx
// MeScreen.tsx
const membershipState = getMembershipState(profile?.isPro, profile?.proExpiresAt);

<Cell
  icon={Crown}
  iconBg={membershipState === 'pro_active' || membershipState === 'pro_expiring' 
    ? colors.greenSoftBg 
    : '#FFF8F0'}
  iconColor={colors.primary}
  label={t('me.xiaopeiService')}
  desc={
    membershipState === 'pro_active' || membershipState === 'pro_expiring'
      ? '查看會員狀態與權益'
      : t('me.upgradeProDesc')
  }
  badge={
    membershipState === 'non_pro' || membershipState === 'pro_expired'
      ? t('me.recommended')
      : undefined
  }
  onPress={() => {
    if (membershipState === 'non_pro' || membershipState === 'pro_expired') {
      handleNavigate(SCREEN_NAMES.PRO_SUBSCRIPTION);
    } else {
      handleNavigate(SCREEN_NAMES.PRO_MEMBER_CENTER);
    }
  }}
/>
```

**導航規則**：
- `non_pro` / `pro_expired` → `ProSubscriptionScreen`（銷售頁）
- `pro_active` / `pro_expiring` → `ProMemberCenterScreen`（會員中心）

> **重要**：這樣就不會出現「其實已過期，但還能進會員中心」這種邊界情況。

---

## 2️⃣ 顯示條件 & 進入檢查

### 進入會員中心前的檢查

```tsx
// ProMemberCenterScreen.tsx
useEffect(() => {
  const checkMembershipState = async () => {
    const status = await proService.getStatus();
    const state = getMembershipState(status.isPro, status.proExpiresAt);
    
    // 如果已過期或未訂閱，直接跳轉銷售頁
    if (state === 'pro_expired' || state === 'non_pro') {
      navigation.replace(SCREEN_NAMES.PRO_SUBSCRIPTION);
      Toast.show(`你的小佩會員已於 ${formatDate(status.proExpiresAt)} 到期。`);
      return;
    }
    
    // 只有 pro_active 或 pro_expiring 才能進入會員中心
    setMembershipState(state);
    setStatus(status);
  };
  
  checkMembershipState();
}, []);
```

---

## 3️⃣ 整體頁面架構

`ProMemberCenterScreen` 包含 **4 個主要模組**：

1. **頂部狀態卡 `StatusCard`**
2. **使用情況卡 `UsageCard`**
3. **會員權益卡 `BenefitsCard`**
4. **訂閱管理卡 `ManagementCard`**

---

## 4️⃣ 模組詳解

### 4.1 頂部狀態卡 `StatusCard`

**目的**：一句話讓他知道「我現在是什麼會員、到什麼時候」。

#### 資料來源

```ts
interface MembershipStatus {
  isPro: boolean;
  proPlan: 'monthly' | 'quarterly' | 'yearly' | null;
  proExpiresAt: string | null; // ISO
  aiCallsToday: number;
  aiDailyLimit: number; // 後端配置，當前會員默認為 100
  maxCharts: number;    // 後端返回，非會員 10、會員無限制
}
```

#### 文案規則

**標題**（對應 `membershipState`）：
- `pro_active`：`小佩會員 · 使用中`
- `pro_expiring`：`小佩會員 · 即將到期`
- `pro_expired`：應該根本進不了這頁（直接跳銷售頁）

**會員標籤（Badge）**：
- `monthly`   → `月付會員`
- `quarterly` → `季付會員`
- `yearly`    → `年付會員`

**主文案**（兩行，固定）：
> 感謝你成為小佩會員。  
> 之後小佩會陪你一起看懂自己的節奏。

**底部小字**：
- P0 階段（更中性）：`本期至 {YYYY-MM-DD}`
- 未來接正式 IAP 後：可區分 `自動續訂中` / `已取消續訂`

**即將到期提示**（`pro_expiring` 時顯示）：
- 在 `StatusCard` 內最上方加一條黃底提示：
  > `⚠️ 距離本期到期還有 {n} 天，別忘了留意訂閱狀態。`

#### 按鈕顯示規則

**在會員中心頁**：
- **標準顯示**：只放 `管理訂閱`
- **恢復購買**：不在此頁顯示，建議放到銷售頁（非 Pro 用戶那頁）或設置頁

> **說明**：已是 Pro + 有效期內時，「恢復購買」幾乎沒用（restore 通常用在不是 Pro 但其實有付過錢的狀況）

#### 交互

* `管理訂閱` → 調用現有的「打開 iOS 訂閱管理頁」封裝方法  
  若沒有，就用 `Linking.openURL('https://apps.apple.com/account/subscriptions')`

---

### 4.2 使用情況卡 `UsageCard`

**目的**：讓用戶看到自己有在用，覺得「有值」。

#### 資料來源

```ts
interface MembershipStatus {
  aiCallsToday: number;
  aiDailyLimit: number; // 後端配置，當前會員默認為 100
}
```

#### UI 結構

* **標題**：`今日使用情況`
* **主數據**：`今日已使用 {aiCallsToday} / {aiDailyLimit} 次 AI 解讀`
* **進度條**：
  - 計算：`min(1, aiCallsToday / aiDailyLimit)`（處理邊界情況）
  - 顯示：`aiCallsToday / aiDailyLimit` 的百分比
* **小字**：`每日 00:00 自動重置`
* **底部一句鼓勵**：`問得越多，小佩越懂你。`
* **按鈕**：`去問小佩`（4 字 CTA）

#### 交互

* `去問小佩` → 跳轉到主要聊天/解讀入口（`ChatScreen` 或 `HomeScreen`）

---

### 4.3 會員權益卡 `BenefitsCard`

**目的**：用「已解鎖」的語氣強化價值感，而不是再賣一次。

#### 文案（固定列表）

* **標題**：`會員權益`

* **條目（✅ 列表）**：
  * `✅ 每天 {aiDailyLimit} 次 AI 解讀與問答`（數值由後端配置，前端只顯示）
  * `✅ 可使用全部八字功能與工具`
  * `✅ 可保存 {maxCharts} 個命盤`（maxCharts 由後端配置，前端只顯示。會員無限制）
  * `✅ 新功能會優先開放給小佩會員嘗鮮`（偏情緒價值）

* **小字**：
  > 後續有新功能會優先開放給小佩會員。

#### 按鈕

* P0 不需要按鈕（純展示即可）

---

### 4.4 訂閱管理卡 `ManagementCard`

**目的**：讓用戶對扣款資訊完全透明，有掌控感，反而降低負面情緒。

#### 資料來源

從 `MembershipStatus` + 訂閱接口取一次最近一筆訂閱資訊：

```ts
interface SubscriptionDto {
  plan: 'monthly' | 'quarterly' | 'yearly';
  status: 'active' | 'canceled' | 'expired';
  startedAt: string;
  expiresAt: string; // P0 階段：同時作為「本期結束日期 / 預計下一次扣款日」
}
```

#### UI 內容

* **區塊標題**：`訂閱管理`

* **行 1：當前方案**
  `目前為 季付方案 · HK$ 99 / 季`

  價格映射（固定文案）：
  * `monthly`   → `HK$ 39 / 月`
  * `quarterly` → `HK$ 99 / 季`
  * `yearly`    → `HK$ 348 / 年`

* **行 2：下一次扣款**
  `下一次扣款日：{expiresAt 的日期}`

  > **說明**：P0 階段，`expiresAt` 同時作為「本期結束日期 / 預計下一次扣款日」，展示文案統一為「下一次扣款日」。  
  > 未來接真實 IAP 後，將由後端提供更精確的字段（如 `renewalDate` / `gracePeriodEnd`）。

* **行 3：扣款平台**
  ```
  iOS：由 App Store 代扣款
  其他平台（預留）：由平台代扣款 / 由小佩收款
  ```
  
  > **說明**：讓 UI 預留一個 `platformLabel`，不要完全寫死。

* **小字提示**（可選）：
  > 若想調整或取消續訂，請在 App Store 的訂閱管理中操作。

* **按鈕（4 字）**：
  * `管理訂閱`（主）

> **不做**：升級方案、變更方案等複雜操作，P0 都先不實現。  
> **說明**：P0 不提供方案升級（例如月 → 季 / 年），到期後再重新訂閱即可。

---

## 5️⃣ 特殊狀態處理

### 5.1 即將到期（7 天內）

**判斷**：`membershipState === 'pro_expiring'`

**表現**：
* `StatusCard` 標題：改為 `小佩會員 · 即將到期`
* 在 `StatusCard` 內最上方加一條黃底提示：
  > `⚠️ 距離本期到期還有 {n} 天，別忘了留意訂閱狀態。`
* 按鈕：只顯示 `管理訂閱`

---

### 5.2 已過期

**判斷**：`membershipState === 'pro_expired'`

**行為**：
* 進入會員中心前就檢查
* 若已過期 → 直接導回 `ProSubscriptionScreen`（銷售頁）
* 可彈一個 Toast：`你的小佩會員已於 {日期} 到期。`

> **說明**：已過期狀態應該根本進不了會員中心頁，直接跳銷售頁，體驗更簡單。  
> 所以「已過期但還停留在此頁」的 UI 不實作，當作備用設計就好。

---

## 6️⃣ 技術要點（簡版）

### 6.1 API 需求

#### 1）會員狀態

沿用 / 擴充現有 `proService.getStatus()`，需至少包含：

```ts
MembershipStatus {
  isPro: boolean;
  proPlan: 'monthly' | 'quarterly' | 'yearly' | null;
  proExpiresAt: string | null;
  aiCallsToday: number;
  aiDailyLimit: number; // 由後端配置，當前會員默認為 100
  maxCharts: number;    // 由後端返回，非會員 10、會員無限制
}
```

#### 2）訂閱資訊（可共用現有接口）

```ts
SubscriptionDto {
  plan: 'monthly' | 'quarterly' | 'yearly';
  status: 'active' | 'canceled' | 'expired';
  startedAt: string;
  expiresAt: string;
}
```

前端只讀這兩個結構就夠畫畫面，不干涉具體計費邏輯。

---

### 6.2 iOS 操作

#### 管理訂閱

→ 調用現有的「打開 iOS 訂閱管理頁」封裝方法  
若沒有，就用 `Linking.openURL('https://apps.apple.com/account/subscriptions')`

#### 恢復購買

→ 調用 `POST /api/v1/pro/restore-purchase`，由後端根據歷史訂閱記錄決定新的起始時間與到期時間。  
前端只負責：調用 → 成功後刷新 `MembershipStatus` → 提示「恢復成功」。

> **說明**：恢復購買的具體邏輯（起始時間規則、訂購時間計算等）由後端處理，前端不做時間計算。  
> 詳細技術規格請參考後端專用文檔（如 `pro_subscription_restore_spec.md`）。

---

## 7️⃣ 非功能需求

### 7.1 Loading / Error 狀態

**Loading**：
- 使用骨架屏 / 整卡 Skeleton，不要白屏
- 顯示位置：各卡片區域

**Error**：
- 出錯時顯示「暫時無法獲取會員資訊」
- 提供一個小按鈕：`重試一次`（4 字）

---

### 7.2 統一 CTA 字數規則

**規範**：本頁所有主要按鈕文案，以 4 字為主。

**示例**：
- `管理訂閱` ✅
- `去問小佩` ✅
- `重試一次` ✅

**避免**：3 字、5 字按鈕亂飛。

---

### 7.3 埋點需求

**至少需要埋點**：

1. 進入 `ProMemberCenterScreen`
2. 點擊 `管理訂閱`
3. 點擊 `去問小佩`
4. （可選）點擊 `恢復購買`（如果顯示）

**目的**：計算「會員來這頁幹嘛」「誰會去 iOS 管理訂閱」等數據。

---

## 8️⃣ 不做項目（P0 明確砍掉）

為了讓這頁保持乾淨、開發量可控，以下暫不做：

* ❌ 「行為引導卡」（引導去看運勢 / 新增命盤等）
* ❌ 「升級方案」功能（改從月付 → 季付 / 年付）
* ❌ 獨立「續訂說明」功能（到期自動續訂，沒有續訂就到期了）
* ❌ 「恢復購買」按鈕在會員中心顯示（建議移到銷售頁或設定頁）
* ❌ 「已過期但還停留在此頁」的 UI（直接跳轉銷售頁）

之後如果真有需要，再另外開一版「成長引導 / Engagement 卡片」規格。

---

## 9️⃣ 組件結構

### 文件組織

```
app/src/screens/ProMemberCenter/
├── ProMemberCenterScreen.tsx      # 主頁面
├── utils/
│   └── membershipState.ts         # 狀態判斷工具函數
├── components/
│   ├── StatusCard.tsx             # 頂部狀態卡
│   ├── UsageCard.tsx               # 使用情況卡
│   ├── BenefitsCard.tsx            # 會員權益卡
│   └── ManagementCard.tsx         # 訂閱管理卡
```

### 數據流

```tsx
// ProMemberCenterScreen.tsx
import { getMembershipState } from './utils/membershipState';

const [status, setStatus] = useState<MembershipStatus | null>(null);
const [subscription, setSubscription] = useState<SubscriptionDto | null>(null);
const [membershipState, setMembershipState] = useState<MembershipState>('non_pro');
const [loading, setLoading] = useState(true);
const [error, setError] = useState<string | null>(null);

useEffect(() => {
  loadData();
}, []);

const loadData = async () => {
  try {
    setLoading(true);
    setError(null);
    
    // 1. 獲取會員狀態
    const statusData = await proService.getStatus();
    
    // 2. 判斷狀態
    const state = getMembershipState(statusData.isPro, statusData.proExpiresAt);
    
    // 3. 如果已過期或未訂閱，直接跳轉銷售頁
    if (state === 'pro_expired' || state === 'non_pro') {
      navigation.replace(SCREEN_NAMES.PRO_SUBSCRIPTION);
      Toast.show(`你的小佩會員已於 ${formatDate(statusData.proExpiresAt)} 到期。`);
      return;
    }
    
    // 4. 只有 pro_active 或 pro_expiring 才能進入會員中心
    setMembershipState(state);
    setStatus(statusData);
    
    // 5. 獲取訂閱資訊
    const subscriptions = await proService.getSubscriptionHistory();
    if (subscriptions.length > 0) {
      setSubscription(subscriptions[0]); // 取最近一筆
    }
  } catch (err) {
    setError('暫時無法獲取會員資訊');
    console.error('[ProMemberCenter] 加載失敗:', err);
  } finally {
    setLoading(false);
  }
};
```

---

## 🔟 實施檢查清單

### Phase 1: 基礎結構
- [ ] 創建 `ProMemberCenterScreen` 組件
- [ ] 實現 `membershipState` 工具函數
- [ ] 實現 `StatusCard` 組件
- [ ] 實現 `UsageCard` 組件
- [ ] 實現 `BenefitsCard` 組件
- [ ] 實現 `ManagementCard` 組件

### Phase 2: 數據與邏輯
- [ ] 集成 `proService.getStatus()` API
- [ ] 集成 `proService.getSubscriptionHistory()` API
- [ ] 實現狀態判斷邏輯（`getMembershipState`）
- [ ] 實現過期檢查邏輯（自動跳轉銷售頁）
- [ ] 實現即將到期判斷（7天內）

### Phase 3: 交互功能
- [ ] 實現「管理訂閱」按鈕（iOS 訂閱管理）
- [ ] 實現「去問小佩」按鈕（跳轉聊天頁）
- [ ] 實現 Loading 狀態（骨架屏）
- [ ] 實現 Error 狀態（錯誤提示 + 重試）

### Phase 4: 特殊狀態
- [ ] 實現即將到期提示（黃底警告）
- [ ] 實現已過期處理（Toast + 跳轉）

### Phase 5: 路由與導航
- [ ] 在 `MeScreen` 中實現條件跳轉邏輯（基於 `membershipState`）
- [ ] 註冊 `PRO_MEMBER_CENTER` 路由
- [ ] 測試導航流程（所有狀態）

### Phase 6: 非功能需求
- [ ] 實現統一 CTA 字數規則（4 字）
- [ ] 實現埋點（進入頁面、點擊按鈕）

---

## 📚 參考資料

- 現有組件：`app/src/screens/ProSubscription/ProSubscriptionScreen.tsx`
- API 服務：`app/src/services/api/proService.ts`
- 後端接口：`core/src/routes/pro.ts`
- 設計規範：`app.doc/UI_SPEC.md`（如果有的話）

---

## 📝 備註

* 所有文案以繁體中文為準
* 按鈕文字統一為 4 個字
* 價格固定為 HK$（港幣）
* 日期格式：`YYYY-MM-DD`
* 時間計算邏輯完全由後端處理，前端只負責顯示
* 所有狀態判斷統一使用 `membershipState`，不要到處自己算

---

## 📌 TODO / 待產品決策（不影響本版開發）

以下事項不影響當前版本的開發，後續如有需要再補充：

1. **是否需要獨立「續訂說明」彈窗？**（當前版本不做，使用小字提示即可）

2. **iOS 訂閱管理與恢復購買邏輯**，另見 `xxx_ios_iap_spec.md`（如果有的話）

3. **會員命盤數量限制**，最終以 `MembershipStatus.maxCharts` 接口返回為準
