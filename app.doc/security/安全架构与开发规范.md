# 安全架构与开发规范

> **版本**: v1.0  
> **创建日期**: 2024年11月  
> **适用范围**: 整个项目（前端 App + 后端 Core Service）  
> **文件类型**: 架构规范 / 开发规范（必须遵循）

---

## 一、安全架构原则

### 1.1 核心原则

**目标**: 确保核心算法、prompt 模板、计费逻辑等敏感信息永远不暴露给前端。

**架构分层**:
```
┌─────────────────────────────────────────┐
│  前端 App（壳）                          │
│  - 只负责 UI 和状态管理                  │
│  - 不包含任何算法逻辑                    │
│  - 不包含 prompt 文本                   │
│  - 不包含计费判断逻辑                    │
└──────────────┬──────────────────────────┘
               │ HTTP/HTTPS API
               │ (仅传递结构化数据)
┌──────────────▼──────────────────────────┐
│  后端 Core Service                      │
│  - 所有算法逻辑（八字引擎、blocks计算）  │
│  - 所有 prompt 模板                     │
│  - 计费判断逻辑                         │
│  - 意图识别逻辑                         │
└──────────────┬──────────────────────────┘
               │
┌──────────────▼──────────────────────────┐
│  数据库（MySQL）                        │
│  - 用户数据                             │
│  - 命盘数据                             │
│  - 对话历史                             │
└─────────────────────────────────────────┘
```

### 1.2 安全边界

**前端（壳 App）禁止包含**:
- ❌ 八字算法逻辑（即使是从 `core/engine` 复制）
- ❌ Prompt 模板文本
- ❌ Blocks 计算逻辑
- ❌ 计费判断逻辑
- ❌ 意图识别逻辑
- ❌ 任何硬编码的命理解读文本

**前端（壳 App）允许包含**:
- ✅ UI 组件和样式
- ✅ 状态管理（用户状态、UI 状态）
- ✅ API 调用（仅传递结构化数据）
- ✅ 数据展示和格式化
- ✅ 路由和导航

**后端（Core Service）必须包含**:
- ✅ 所有算法逻辑（八字引擎、blocks 计算）
- ✅ 所有 prompt 模板（存储在服务端，不通过 API 下发）
- ✅ 计费判断逻辑
- ✅ 意图识别逻辑
- ✅ 数据验证和业务规则

---

## 二、API 设计规范

### 2.1 API 响应数据规范

**原则**: API 只返回**结果数据**，不返回**内部实现细节**。

#### ✅ 允许返回的数据

```typescript
// 命盘结果（简化后的结果数据）
{
  "chart": {
    "id": "chart_123",
    "name": "自己",
    "pillars": {
      "yearStem": "甲",
      "yearBranch": "子",
      // ... 只返回结果，不返回计算过程
    }
  },
  "overview": {
    "day_master_strength": 0.7,
    "five_elements": { "wood": 0.3, "fire": 0.2, ... },
    "tags": ["偏强日主", "火旺土相"]
  }
}

// 解读结果（只返回最终文本和结构化数据）
{
  "display_text": "从命盘来看...",
  "json": {
    "summary": "感情中等偏好",
    "highlights": [...]
  }
}
```

#### ❌ 禁止返回的数据

```typescript
// ❌ 禁止返回 blocks_json 的原始内部结构
{
  "blocks_json": {
    "internal_calculation": "...",  // 内部计算细节
    "raw_engine_output": "..."      // 引擎原始输出
  }
}

// ❌ 禁止返回 prompt 模板
{
  "prompt": "你是小佩，一位命理分析师..."  // 绝对禁止
}

// ❌ 禁止返回算法参数
{
  "algorithm_params": {...},
  "calculation_steps": [...]
}
```

### 2.2 API 请求数据规范

**原则**: 前端只传递**用户输入**和**业务参数**，不传递算法相关参数。

#### ✅ 允许传递的数据

```typescript
// 创建命盘请求
{
  "name": "自己",
  "gender": "female",
  "birth": {
    "year": 1995,
    "month": 8,
    "day": 12,
    "hour": 14,
    "minute": 30,
    "timezone": "Asia/Shanghai",
    "useTrueSolarTime": true
  }
}

// 解读请求
{
  "scene": "chat_followup",
  "chartId": "chart_123",
  "message": "明年感情运怎么样？",
  "options": {
    "need_json": true,
    "need_text": true,
    "locale": "zh-CN"
  }
}
```

#### ❌ 禁止传递的数据

```typescript
// ❌ 禁止传递算法参数
{
  "algorithm": "daymaster_v2",
  "calculation_method": "subping",
  "engine_params": {...}
}

// ❌ 禁止传递 prompt 片段
{
  "custom_prompt": "请用以下方式解读..."
}

// ❌ 禁止传递内部计算参数
{
  "blocks_override": {...},
  "force_recalculate": true  // 这个可以，但其他算法参数不行
}
```

---

## 三、代码组织规范

### 3.1 前端代码组织

**目录结构**:
```
src/
├── screens/          # 页面组件（只负责 UI）
├── components/       # UI 组件（只负责展示）
├── navigation/       # 路由和导航
├── store/            # 状态管理（用户状态、UI 状态）
├── services/
│   └── api/          # API 调用层（只负责 HTTP 请求）
│       ├── client.ts
│       ├── chatService.ts
│       ├── chartService.ts
│       └── userService.ts
├── hooks/            # 自定义 Hooks
├── utils/            # 工具函数（格式化、验证等，不包含算法）
├── constants/        # 常量配置（UI 相关，不包含业务规则）
└── theme/            # 主题配置
```

**禁止在前端代码中出现**:
- ❌ `core/engine/` 目录的引用
- ❌ 任何算法计算函数
- ❌ Prompt 模板字符串
- ❌ Blocks 计算逻辑
- ❌ 计费判断逻辑

**检查方法**:
```bash
# 在前端代码中搜索，如果找到以下内容，说明违反了规范：
grep -r "core/engine" src/
grep -r "prompt" src/ --include="*.ts" --include="*.tsx"
grep -r "blocks_json" src/ --include="*.ts" --include="*.tsx"
grep -r "计费\|billing\|entitlement" src/ --include="*.ts" --include="*.tsx"
```

### 3.2 后端代码组织

**目录结构**:
```
core/
├── engine/           # 八字引擎（算法逻辑）
├── api/              # API 路由层
│   ├── routes/
│   │   ├── auth.js
│   │   ├── bazi.js
│   │   ├── reading.js
│   │   └── user.js
│   └── middleware/
│       ├── auth.js
│       └── rateLimit.js
├── services/
│   ├── baziEngine/   # 排盘引擎服务
│   ├── blocksEngine/ # Blocks 计算服务
│   ├── intentEngine/ # 意图识别服务
│   ├── readingEngine/# 解读编排服务
│   ├── promptTemplates/ # Prompt 模板管理
│   └── billing/      # 计费服务
├── models/           # 数据模型
└── utils/            # 工具函数
```

**必须在后端代码中包含**:
- ✅ 所有算法逻辑
- ✅ Prompt 模板（存储在 `promptTemplates/` 目录）
- ✅ 计费判断逻辑
- ✅ 数据验证和业务规则

---

## 四、开发流程规范

### 4.1 开发前检查清单

**前端开发**:
- [ ] 确认功能是否涉及算法逻辑（如果是，应该在后端实现）
- [ ] 确认是否需要 prompt 文本（如果是，应该在后端管理）
- [ ] 确认是否需要计费判断（如果是，应该调用后端 API）

**后端开发**:
- [ ] 确认算法逻辑是否在 `core/engine/` 或 `core/services/` 中
- [ ] 确认 prompt 模板是否在 `core/services/promptTemplates/` 中
- [ ] 确认 API 响应不包含内部实现细节

### 4.2 代码审查要点

**前端代码审查**:
- [ ] 是否引用了 `core/engine/` 目录？
- [ ] 是否包含 prompt 模板字符串？
- [ ] 是否包含算法计算逻辑？
- [ ] 是否包含计费判断逻辑？
- [ ] API 调用是否只传递业务参数？

**后端代码审查**:
- [ ] API 响应是否只返回结果数据？
- [ ] 是否包含 prompt 模板（应该包含）？
- [ ] 是否包含算法逻辑（应该包含）？
- [ ] 是否包含计费判断（应该包含）？

### 4.3 持续集成检查

**自动化检查脚本**（建议添加到 CI/CD）:

```bash
#!/bin/bash
# scripts/check-security.sh

echo "🔍 检查前端代码安全规范..."

# 检查是否引用了 core/engine
if grep -r "core/engine" src/ --include="*.ts" --include="*.tsx" 2>/dev/null; then
  echo "❌ 错误: 前端代码中引用了 core/engine，违反安全规范！"
  exit 1
fi

# 检查是否包含 prompt 模板
if grep -r "你是.*命理\|你是.*小佩\|prompt.*模板" src/ --include="*.ts" --include="*.tsx" 2>/dev/null; then
  echo "❌ 错误: 前端代码中包含 prompt 模板，违反安全规范！"
  exit 1
fi

# 检查是否包含算法计算逻辑（简单检查）
if grep -r "dayMasterStrength\|computeBlocks\|calculateBazi" src/ --include="*.ts" --include="*.tsx" 2>/dev/null; then
  echo "❌ 错误: 前端代码中包含算法计算逻辑，违反安全规范！"
  exit 1
fi

echo "✅ 前端代码安全检查通过"
```

---

## 五、Prompt 模板管理规范

### 5.1 Prompt 存储位置

**所有 prompt 模板必须存储在服务端**:
```
core/
└── services/
    └── promptTemplates/
        ├── segments/
        │   ├── roleIntro.ts      # 角色介绍
        │   ├── baziRules.ts      # 八字规则
        │   ├── outputStyle.ts    # 输出格式
        │   └── safetyRules.ts    # 安全规则
        ├── scenes/
        │   ├── chatFollowup.ts   # 聊天追问场景
        │   ├── liunianCard.ts    # 大运流年卡片
        │   ├── taohuaTopic.ts    # 桃花话题
        │   └── overviewCard.ts   # 命盘总览卡片
        └── index.ts              # 统一导出
```

### 5.2 Prompt 使用规范

**禁止**:
- ❌ 通过 API 将 prompt 模板返回给前端
- ❌ 在前端代码中硬编码 prompt 文本
- ❌ 将 prompt 模板存储在数据库（除非是动态配置）

**允许**:
- ✅ 在服务端代码中定义 prompt 模板
- ✅ 在服务端动态拼接 prompt
- ✅ 在服务端调用 LLM 时使用 prompt

### 5.3 Prompt 版本管理

**建议**:
- 使用 Git 版本控制管理 prompt 模板
- 重大修改时记录版本号和修改原因
- 支持 A/B 测试（在服务端实现）

---

## 六、API 安全规范

### 6.1 认证与授权

**所有 API 必须**:
- ✅ 要求用户认证（JWT Token）
- ✅ 验证用户权限
- ✅ 记录 API 调用日志（不记录敏感信息）

**API 请求格式**:
```http
POST /api/v1/bazi/reading
Authorization: Bearer <token>
Content-Type: application/json

{
  "scene": "chat_followup",
  "chartId": "chart_123",
  "message": "明年感情运怎么样？"
}
```

### 6.2 限流策略

**已确认的限流规则**:
- 非付费用户：排盘计算每天 5 次
- 验证码发送：60秒/次，10次/天
- 其他 API：根据业务需求设置

**实现位置**: 后端中间件（`core/api/middleware/rateLimit.js`）

### 6.3 数据脱敏

**API 响应中禁止包含**:
- ❌ 用户密码（即使是哈希值）
- ❌ 内部算法参数
- ❌ Prompt 模板
- ❌ 完整的 blocks_json 原始结构（只返回简化后的结果）

---

## 七、检查清单与工具

### 7.1 开发前检查清单

**前端开发**:
- [ ] 功能是否涉及算法？→ 应该在后端实现
- [ ] 是否需要 prompt？→ 应该在后端管理
- [ ] 是否需要计费判断？→ 应该调用后端 API
- [ ] API 调用是否只传递业务参数？

**后端开发**:
- [ ] 算法逻辑是否在服务端？
- [ ] Prompt 模板是否在服务端？
- [ ] API 响应是否只返回结果数据？
- [ ] 是否包含认证和限流？

### 7.2 代码审查检查清单

**前端代码**:
- [ ] 是否引用了 `core/engine/`？
- [ ] 是否包含 prompt 模板？
- [ ] 是否包含算法计算逻辑？
- [ ] 是否包含计费判断逻辑？

**后端代码**:
- [ ] API 响应是否包含内部实现细节？
- [ ] Prompt 模板是否在服务端？
- [ ] 算法逻辑是否在服务端？
- [ ] 是否包含认证和限流？

### 7.3 自动化检查工具

**建议在 CI/CD 中添加**:
```bash
# scripts/check-security.sh
# 检查前端代码是否违反安全规范

# 检查是否引用了 core/engine
# 检查是否包含 prompt 模板
# 检查是否包含算法计算逻辑
```

**建议在 Git Hooks 中添加**:
```bash
# .git/hooks/pre-commit
# 提交前自动检查
```

---

## 八、违规处理流程

### 8.1 发现违规

**如果发现以下情况，必须立即修复**:
1. 前端代码中引用了 `core/engine/`
2. 前端代码中包含 prompt 模板
3. 前端代码中包含算法计算逻辑
4. API 响应中包含了 prompt 模板或内部实现细节

### 8.2 修复流程

1. **立即修复**: 将违规代码移到后端
2. **代码审查**: 确保修复后符合规范
3. **文档更新**: 如有必要，更新相关文档

---

## 九、培训与文档

### 9.1 新成员入职培训

**必须告知新成员**:
1. 安全架构原则（前端只负责 UI，后端负责所有核心逻辑）
2. 禁止在前端代码中包含算法、prompt、计费逻辑
3. 代码审查时会检查这些规范

### 9.2 文档要求

**所有相关文档必须明确标注**:
- 哪些功能在前端实现
- 哪些功能在后端实现
- API 接口的请求/响应格式

---

## 十、实施建议

### 10.1 立即实施（P0）

1. **创建本规范文档** ✅（已完成）
2. **在项目 README 中引用本规范**
3. **在代码审查清单中添加安全检查项**
4. **创建自动化检查脚本**

### 10.2 短期实施（P1）

1. **在 CI/CD 中添加安全检查**
2. **在 Git Hooks 中添加提交前检查**
3. **培训团队成员**
4. **代码审查时严格执行**

### 10.3 长期维护（P2）

1. **定期审查和更新规范**
2. **根据实际情况调整检查规则**
3. **收集违规案例，完善规范**

---

## 十一、常见问题

### Q1: 前端需要格式化命盘数据怎么办？

**A**: 前端可以格式化**展示数据**，但不能计算**算法数据**。

- ✅ 允许：格式化日期显示、格式化数字显示
- ❌ 禁止：计算日主强弱、计算五行分布

### Q2: 前端需要验证用户输入怎么办？

**A**: 前端可以做**基础验证**（如格式验证），但**业务规则验证**应该在后端。

- ✅ 允许：验证手机号格式、验证日期格式
- ❌ 禁止：验证命盘是否有效、验证计费规则

### Q3: 前端需要缓存数据怎么办？

**A**: 前端可以缓存**API 响应数据**，但不能缓存**算法计算结果**。

- ✅ 允许：缓存命盘列表、缓存对话历史
- ❌ 禁止：缓存 blocks_json、缓存 prompt 模板

---

## 十二、总结

### 12.1 核心原则

1. **前端只负责 UI 和状态管理**
2. **所有核心逻辑在后端**
3. **API 只传递结构化数据，不传递实现细节**
4. **Prompt 模板永远不暴露给前端**

### 12.2 实施方式

1. **文档规范**: 本文档作为系统级规范
2. **代码审查**: 每次代码审查都检查
3. **自动化检查**: CI/CD 和 Git Hooks 自动检查
4. **持续培训**: 新成员入职时培训

### 12.3 检查频率

- **每次提交**: Git Hooks 自动检查
- **每次 PR**: CI/CD 自动检查
- **每次代码审查**: 人工检查
- **定期审查**: 每月审查一次整体合规性

---

**文档版本**: v1.0  
**最后更新**: 2024年11月  
**维护者**: 开发团队  
**审核状态**: 待团队审核确认

