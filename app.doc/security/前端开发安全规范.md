# 前端开发安全规范

> **版本**: v1.0  
> **适用范围**: 小佩 App 前端（React Native）所有开发  
> **性质**: **系统级要求，必须严格遵守**

---

## 一、核心原则

**前端（壳 App）的职责**:
- ✅ UI 渲染和用户交互
- ✅ 状态管理（Zustand）
- ✅ 路由导航
- ✅ HTTP API 调用
- ✅ 数据展示和格式化（仅展示层）

**前端禁止做的事情**:
- ❌ 命盘算法计算
- ❌ Prompt 模板存储或拼接
- ❌ Blocks_json 计算
- ❌ 计费判断（业务逻辑）
- ❌ 意图识别（业务逻辑）

---

## 二、禁止事项清单

### 2.1 禁止引入核心算法

**❌ 错误示例**:
```typescript
// ❌ 禁止这样做
import { BaziEngine } from '../../core/engine';
import { computeBazi } from '../../../core/engine/index.js';

// ❌ 禁止在前端调用排盘算法
const result = await engine.compute(birthInfo);
```

**✅ 正确做法**:
```typescript
// ✅ 必须通过 API 调用
import { chartService } from '@/services/api/chartService';

const result = await chartService.createChart({
  name: '自己',
  gender: 'female',
  birth: { ... }
});
```

**检查方法**:
- ESLint 规则：禁止导入 `**/core/engine/**`
- 代码审查：检查是否有 `import` 语句引入 `core/engine`

---

### 2.2 禁止存储 Prompt 模板

**❌ 错误示例**:
```typescript
// ❌ 禁止在前端定义 prompt 模板
const PROMPT_TEMPLATE = `你是"小佩"，一位命理分析师...`;

// ❌ 禁止在前端拼接 prompt
const prompt = `${PROMPT_TEMPLATE}\n${userQuestion}`;

// ❌ 禁止直接调用 LLM
const response = await callLLM(prompt);
```

**✅ 正确做法**:
```typescript
// ✅ 必须通过 API 调用解读接口
import { readingService } from '@/services/api/readingService';

const result = await readingService.getReading({
  scene: 'chat_followup',
  chartId: 'chart_123',
  message: '明年感情运怎么样？'
});
```

**检查方法**:
- 代码审查：检查是否有 prompt 相关的字符串常量
- 搜索关键词：`prompt`、`你是"小佩"`、`LLM`、`OpenAI` 等

---

### 2.3 禁止计算 Blocks_json

**❌ 错误示例**:
```typescript
// ❌ 禁止在前端计算 blocks
const blocks = computeBlocks(chart);
const dayMasterStrength = calculateDayMasterStrength(pillars);

// ❌ 禁止在前端进行命理分析
const yongshen = analyzeYongshen(chart);
```

**✅ 正确做法**:
```typescript
// ✅ 从 API 获取结果数据
const chartDetail = await chartService.getChartDetail(chartId);
// chartDetail.overview 包含已计算好的结果数据
```

**检查方法**:
- 代码审查：检查是否有 blocks 相关的计算函数
- 搜索关键词：`blocks_json`、`computeBlocks`、`calculate` 等

---

### 2.4 禁止进行计费判断（业务逻辑）

**❌ 错误示例**:
```typescript
// ❌ 禁止在前端判断是否 Pro 用户
if (user.isPro) {
  // 允许访问
} else {
  // 禁止访问
}

// ❌ 禁止在前端判断功能是否解锁
const canAccess = checkFeatureAccess(user, 'liunian_full');
```

**✅ 正确做法**:
```typescript
// ✅ 前端只根据 API 返回的 features 控制 UI 展示
const entitlements = await userService.getEntitlements();
// entitlements.features.liunian_full 用于控制按钮是否灰掉

// ✅ 真正的权限判断在后端 API 中
// 即使前端按钮可点击，后端 API 也会二次校验
```

**检查方法**:
- 代码审查：检查是否有计费相关的业务逻辑判断
- 搜索关键词：`isPro`、`checkFeatureAccess`、`canAccess` 等

---

### 2.5 禁止进行意图识别（业务逻辑）

**❌ 错误示例**:
```typescript
// ❌ 禁止在前端进行意图识别
const intent = analyzeIntent(userMessage);
const topic = extractTopic(userMessage);
```

**✅ 正确做法**:
```typescript
// ✅ 直接调用解读 API，意图识别在后端完成
const result = await readingService.getReading({
  scene: 'chat_followup',
  chartId: 'chart_123',
  message: userMessage  // 后端会进行意图识别
});
```

---

## 三、必须遵守的规范

### 3.1 API 调用规范

**统一使用 API Service**:
```typescript
// ✅ 所有 API 调用必须通过统一的 service
import { chartService } from '@/services/api/chartService';
import { readingService } from '@/services/api/readingService';
import { userService } from '@/services/api/userService';

// ❌ 禁止直接使用 fetch 或 axios
// const response = await fetch('/api/v1/bazi/chart', ...);
```

**必须携带 Token**:
```typescript
// ✅ API Service 自动处理 Token
// 在 apiService 中统一添加 Authorization header
```

**统一错误处理**:
```typescript
// ✅ 使用统一的错误处理
try {
  const result = await chartService.createChart(data);
} catch (error) {
  // 统一错误处理逻辑
  handleApiError(error);
}
```

---

### 3.2 数据展示规范

**只展示 API 返回的数据**:
```typescript
// ✅ 前端只负责展示
<Text>{chartDetail.overview.day_master_strength}</Text>

// ❌ 禁止在前端进行计算后再展示
// const strength = calculateStrength(chart); // ❌
```

**允许的格式化操作**:
```typescript
// ✅ 允许展示层的格式化
const formattedDate = formatDate(chart.birth.birthday);
const truncatedText = truncate(text, 100);

// ❌ 禁止业务逻辑计算
// const strength = calculateDayMasterStrength(chart); // ❌
```

---

### 3.3 状态管理规范

**只管理 UI 状态**:
```typescript
// ✅ 管理 UI 状态
interface UIState {
  isLoading: boolean;
  error: string | null;
  selectedTab: string;
}

// ❌ 禁止在状态中存储业务逻辑计算结果
// interface State {
//   blocks: BlocksJson;  // ❌
//   prompt: string;      // ❌
// }
```

---

## 四、项目结构要求

### 4.1 允许的目录结构

```
src/
├── screens/              # 页面组件（只负责 UI）
├── components/           # UI 组件（只负责展示）
├── navigation/           # 路由导航
├── store/                # 状态管理（只管理 UI 状态）
├── services/
│   └── api/              # API 调用层（统一封装）
│       ├── client.ts     # HTTP 客户端
│       ├── authService.ts
│       ├── chartService.ts
│       ├── readingService.ts
│       └── endpoints.ts  # API 路径常量
├── types/                # TypeScript 类型定义（只定义 API 返回的数据类型）
└── theme/                # UI 主题
```

### 4.2 禁止的目录和文件

**禁止在前端项目中包含**:
- ❌ `core/engine/` - 排盘算法
- ❌ `prompts/` - Prompt 模板
- ❌ `blocks/` - Blocks 计算逻辑
- ❌ `billing/` - 计费判断逻辑

---

## 五、代码审查检查清单

每次代码审查时，必须检查以下项：

### 5.1 导入检查
- [ ] 是否导入了 `core/engine` 相关模块？
- [ ] 是否导入了 prompt 相关模块？
- [ ] 是否导入了 blocks 计算相关模块？

### 5.2 代码检查
- [ ] 是否有 prompt 相关的字符串常量？
- [ ] 是否有排盘算法相关的计算函数？
- [ ] 是否有 blocks 计算相关的函数？
- [ ] 是否有计费判断的业务逻辑？

### 5.3 API 调用检查
- [ ] 所有 API 调用是否通过统一的 service？
- [ ] 是否所有 API 调用都携带了 Token？
- [ ] 是否有直接调用 LLM 的代码？

### 5.4 数据检查
- [ ] 是否在前端存储了敏感数据（prompt、算法配置）？
- [ ] 是否在前端进行了业务逻辑计算？

---

## 六、ESLint 规则配置

### 6.1 禁止导入 core/engine

```javascript
// .eslintrc.js
module.exports = {
  rules: {
    'no-restricted-imports': [
      'error',
      {
        patterns: [
          {
            group: ['**/core/engine/**', '**/../../core/engine/**'],
            message: '禁止在前端代码中引入 core/engine，所有排盘计算必须通过 API 调用。请使用 chartService.createChart() 代替。',
          },
        ],
      },
    ],
  },
};
```

### 6.2 禁止特定关键词（可选）

```javascript
// 可以配置禁止使用某些关键词（如 prompt、blocks_json 等）
// 但要注意不要误报，建议主要通过代码审查检查
```

---

## 七、常见场景示例

### 7.1 排盘场景

**需求**: 用户填写出生信息后，需要排盘

**❌ 错误实现**:
```typescript
import { BaziEngine } from '@/core/engine';

const handleSubmit = async () => {
  const engine = new BaziEngine();
  const result = await engine.compute(birthInfo);
  // ...
};
```

**✅ 正确实现**:
```typescript
import { chartService } from '@/services/api/chartService';

const handleSubmit = async () => {
  const result = await chartService.createChart({
    name: formData.name,
    gender: formData.gender,
    birth: {
      year: formData.year,
      month: formData.month,
      day: formData.day,
      hour: formData.hour,
      minute: formData.minute,
      timezone: formData.timezone,
      useTrueSolarTime: formData.useTrueSolarTime,
    },
  });
  // result.chart 包含排盘结果
};
```

---

### 7.2 聊天场景

**需求**: 用户发送消息，获取小佩的回复

**❌ 错误实现**:
```typescript
const PROMPT = `你是"小佩"，一位命理分析师...`;

const handleSendMessage = async () => {
  const prompt = `${PROMPT}\n用户问题：${message}`;
  const response = await callLLM(prompt);
  // ...
};
```

**✅ 正确实现**:
```typescript
import { readingService } from '@/services/api/readingService';

const handleSendMessage = async () => {
  const result = await readingService.getReading({
    scene: 'chat_followup',
    chartId: currentChartId,
    message: message,
    options: {
      need_json: true,
      need_text: true,
    },
  });
  // result.display_text 包含小佩的回复
  // result.json 包含结构化数据
};
```

---

### 7.3 权限控制场景

**需求**: 根据用户权限控制功能按钮的显示

**❌ 错误实现**:
```typescript
const canAccessFeature = (user: User, feature: string) => {
  if (user.isPro) {
    return true;
  }
  // 业务逻辑判断...
  return false;
};
```

**✅ 正确实现**:
```typescript
// 1. 从 API 获取权限信息
const entitlements = await userService.getEntitlements();

// 2. 根据 API 返回的 features 控制 UI
const canShowButton = entitlements.features.liunian_full;

// 3. 即使按钮显示，后端 API 也会二次校验
// 如果用户没有权限，API 会返回错误
```

---

## 八、违规处理

### 8.1 代码审查

如果发现违反安全规范的代码：
1. **立即拒绝合并**
2. **要求修改**
3. **说明违反的规范**
4. **提供正确的实现方式**

### 8.2 定期审计

定期（如每月）进行代码审计：
1. 搜索关键词（`core/engine`、`prompt`、`blocks_json` 等）
2. 检查是否有违规代码
3. 及时修复和整改

---

## 九、总结

### 9.1 核心要求

1. **前端只负责 UI，不包含核心逻辑**
2. **所有算法、prompt、计费判断都通过 API 调用**
3. **禁止在前端引入 `core/engine`**
4. **禁止在前端存储 prompt 模板**
5. **禁止在前端进行计费判断（业务逻辑）**

### 9.2 检查方式

1. **ESLint 规则**: 自动检查禁止的导入
2. **代码审查**: 使用检查清单
3. **定期审计**: 搜索关键词

---

**文档版本**: v1.0  
**最后更新**: 2024年11月  
**维护者**: 开发团队  
**性质**: **系统级要求，必须严格遵守**

