# 代码审查安全检查清单

> **版本**: v1.0  
> **适用范围**: 所有代码审查  
> **性质**: **必须检查项**

---

## 一、前端代码检查

### 1.1 导入检查

- [ ] **是否导入了 `core/engine` 相关模块？**
  - 搜索: `import.*core/engine`
  - 搜索: `import.*\.\.\/.*engine`
  - **如果发现**: 立即拒绝，要求改为 API 调用

- [ ] **是否导入了 prompt 相关模块？**
  - 搜索: `import.*prompt`
  - 搜索: `import.*template`
  - **如果发现**: 立即拒绝，要求改为 API 调用

- [ ] **是否导入了 blocks 计算相关模块？**
  - 搜索: `import.*blocks`
  - **如果发现**: 立即拒绝，要求改为 API 调用

---

### 1.2 代码逻辑检查

- [ ] **是否有 prompt 相关的字符串常量？**
  - 搜索: `const.*PROMPT`
  - 搜索: `你是"小佩"`
  - 搜索: `prompt.*=.*\``
  - **如果发现**: 立即拒绝，要求删除

- [ ] **是否有排盘算法相关的计算函数？**
  - 搜索: `computeBazi`
  - 搜索: `engine\.compute`
  - 搜索: `calculate.*bazi`
  - **如果发现**: 立即拒绝，要求改为 API 调用

- [ ] **是否有 blocks 计算相关的函数？**
  - 搜索: `computeBlocks`
  - 搜索: `calculateBlocks`
  - 搜索: `blocks_json`
  - **如果发现**: 立即拒绝，要求改为 API 调用

- [ ] **是否有计费判断的业务逻辑？**
  - 搜索: `if.*isPro`
  - 搜索: `checkFeatureAccess`
  - 搜索: `canAccess.*=`
  - **如果发现**: 检查是否只是 UI 控制，如果是业务逻辑判断则拒绝

- [ ] **是否有直接调用 LLM 的代码？**
  - 搜索: `callLLM`
  - 搜索: `openai`
  - 搜索: `anthropic`
  - **如果发现**: 立即拒绝，要求改为 API 调用

---

### 1.3 API 调用检查

- [ ] **所有 API 调用是否通过统一的 service？**
  - 检查: 是否有直接使用 `fetch` 或 `axios` 调用业务 API
  - **如果发现**: 要求改为使用统一的 `apiService`

- [ ] **是否所有 API 调用都携带了 Token？**
  - 检查: API 调用是否通过 `apiService`（自动处理 Token）
  - **如果发现**: 要求使用 `apiService`

---

### 1.4 数据检查

- [ ] **是否在前端存储了敏感数据？**
  - 搜索: `const.*PROMPT.*=`
  - 搜索: `blocks.*=.*\{`
  - 搜索: `algorithm.*config`
  - **如果发现**: 立即拒绝，要求删除

- [ ] **是否在前端进行了业务逻辑计算？**
  - 检查: 是否有命理相关的计算函数
  - **如果发现**: 要求改为 API 调用

---

## 二、后端代码检查

### 2.1 API 响应检查

- [ ] **API 响应是否包含 `prompt` 字段？**
  - 搜索: `res\.json.*prompt`
  - 搜索: `response\.prompt`
  - **如果发现**: 立即拒绝，要求移除

- [ ] **API 响应是否包含完整的 `blocks_json` 结构？**
  - 搜索: `res\.json.*blocks`
  - 搜索: `response\.blocks`
  - 搜索: `blocks_json`
  - **如果发现**: 检查是否返回了完整结构，如果是则要求改为返回结果数据

- [ ] **API 响应是否包含算法配置或代码？**
  - 搜索: `algorithm`
  - 搜索: `engine.*config`
  - **如果发现**: 立即拒绝，要求移除

- [ ] **返回的数据是否经过过滤？**
  - 检查: 是否使用了数据过滤函数
  - 检查: 是否只返回前端需要的数据
  - **如果发现**: 要求添加数据过滤

---

### 2.2 权限校验检查

- [ ] **所有业务 API 是否进行了用户鉴权？**
  - 检查: 路由是否使用了 `authenticate` 中间件
  - 检查: 是否验证了 JWT Token
  - **如果发现**: 要求添加鉴权中间件

- [ ] **计费功能是否进行了权限检查？**
  - 检查: 需要 Pro 权限的功能是否进行了检查
  - 检查: 是否使用了 `checkEntitlement` 中间件
  - **如果发现**: 要求添加权限检查

- [ ] **权限检查是否在后端进行？**
  - 检查: 是否有依赖前端进行权限判断的逻辑
  - **如果发现**: 要求改为后端检查

---

### 2.3 Prompt 管理检查

- [ ] **Prompt 模板是否只在服务端使用？**
  - 检查: Prompt 模板是否在 `prompt/` 模块中
  - 检查: 是否有通过 API 返回 prompt 的代码
  - **如果发现**: 要求移除 API 返回 prompt 的代码

- [ ] **是否有通过 API 返回 prompt 的代码？**
  - 搜索: `GET.*prompt`
  - 搜索: `POST.*prompt`
  - 搜索: `res\.json.*prompt`
  - **如果发现**: 立即拒绝，要求删除

- [ ] **Prompt 模板是否集中管理？**
  - 检查: Prompt 模板是否在统一的位置管理
  - **如果发现**: 要求集中管理

---

### 2.4 数据安全检查

- [ ] **敏感信息是否被正确过滤？**
  - 检查: API 响应是否包含敏感字段
  - 检查: 是否使用了数据过滤函数
  - **如果发现**: 要求添加数据过滤

- [ ] **日志中是否记录了敏感信息？**
  - 搜索: `logger.*prompt`
  - 搜索: `logger.*blocks`
  - 搜索: `console\.log.*prompt`
  - **如果发现**: 要求移除敏感信息

- [ ] **错误信息是否泄露了内部实现细节？**
  - 检查: 错误响应是否包含 `stack`、`internalCode` 等
  - **如果发现**: 要求只返回用户友好的错误信息

---

## 三、通用检查

### 3.1 代码结构检查

- [ ] **项目结构是否符合规范？**
  - 前端: 是否包含 `core/engine` 目录？
  - 后端: Prompt 模板是否在正确的位置？
  - **如果发现**: 要求调整项目结构

### 3.2 依赖检查

- [ ] **前端依赖是否包含核心算法库？**
  - 检查: `package.json` 中是否包含算法相关的依赖
  - **如果发现**: 要求移除

---

## 四、检查工具

### 4.1 自动化检查

**ESLint 规则**:
```javascript
// .eslintrc.js
module.exports = {
  rules: {
    'no-restricted-imports': [
      'error',
      {
        patterns: [
          {
            group: ['**/core/engine/**'],
            message: '禁止在前端代码中引入 core/engine',
          },
        ],
      },
    ],
  },
};
```

**Git Hooks**:
```bash
# .git/hooks/pre-commit
# 检查是否有禁止的导入
if grep -r "core/engine" src/; then
  echo "错误: 前端代码中禁止引入 core/engine"
  exit 1
fi
```

---

### 4.2 手动检查

**搜索关键词**:
```bash
# 前端代码中搜索
grep -r "core/engine" src/
grep -r "prompt" src/ | grep -v "apiService"
grep -r "blocks_json" src/
grep -r "isPro.*if" src/

# 后端代码中搜索
grep -r "res.json.*prompt" src/
grep -r "response.*blocks" src/
grep -r "logger.*prompt" src/
```

---

## 五、检查流程

### 5.1 代码提交前

1. **运行 ESLint**: 检查是否有禁止的导入
2. **运行 Git Hooks**: 自动检查
3. **手动搜索**: 使用关键词搜索

### 5.2 代码审查时

1. **使用检查清单**: 逐项检查
2. **搜索关键词**: 使用工具搜索
3. **检查 API 响应**: 查看 API 返回的数据结构

### 5.3 发现问题后

1. **立即拒绝合并**: 如果发现严重违规
2. **要求修改**: 说明违反的规范
3. **提供正确示例**: 给出正确的实现方式

---

## 六、检查清单模板

### 6.1 前端 PR 检查清单

```
## 前端代码安全检查

### 导入检查
- [ ] 是否导入了 `core/engine`？
- [ ] 是否导入了 prompt 相关模块？
- [ ] 是否导入了 blocks 计算相关模块？

### 代码逻辑检查
- [ ] 是否有 prompt 相关的字符串常量？
- [ ] 是否有排盘算法相关的计算函数？
- [ ] 是否有 blocks 计算相关的函数？
- [ ] 是否有计费判断的业务逻辑？
- [ ] 是否有直接调用 LLM 的代码？

### API 调用检查
- [ ] 所有 API 调用是否通过统一的 service？
- [ ] 是否所有 API 调用都携带了 Token？

### 数据检查
- [ ] 是否在前端存储了敏感数据？
- [ ] 是否在前端进行了业务逻辑计算？

**审查结果**: [ ] 通过 [ ] 需要修改 [ ] 拒绝
```

### 6.2 后端 PR 检查清单

```
## 后端代码安全检查

### API 响应检查
- [ ] API 响应是否包含 `prompt` 字段？
- [ ] API 响应是否包含完整的 `blocks_json` 结构？
- [ ] API 响应是否包含算法配置或代码？
- [ ] 返回的数据是否经过过滤？

### 权限校验检查
- [ ] 所有业务 API 是否进行了用户鉴权？
- [ ] 计费功能是否进行了权限检查？
- [ ] 权限检查是否在后端进行？

### Prompt 管理检查
- [ ] Prompt 模板是否只在服务端使用？
- [ ] 是否有通过 API 返回 prompt 的代码？
- [ ] Prompt 模板是否集中管理？

### 数据安全检查
- [ ] 敏感信息是否被正确过滤？
- [ ] 日志中是否记录了敏感信息？
- [ ] 错误信息是否泄露了内部实现细节？

**审查结果**: [ ] 通过 [ ] 需要修改 [ ] 拒绝
```

---

## 七、违规处理

### 7.1 严重违规（立即拒绝）

以下情况必须立即拒绝合并：
- ❌ 前端代码中引入了 `core/engine`
- ❌ 前端代码中包含了 prompt 模板
- ❌ 后端 API 返回了 prompt 模板
- ❌ 后端 API 返回了完整的 blocks_json 结构
- ❌ 后端 API 没有进行权限校验

### 7.2 一般违规（要求修改）

以下情况要求修改：
- ⚠️ 前端代码中进行了简单的业务逻辑计算
- ⚠️ 后端日志中记录了敏感信息
- ⚠️ 错误信息泄露了内部实现细节

---

## 八、总结

### 8.1 核心检查项

1. **前端**: 禁止引入 `core/engine`、禁止包含 prompt、禁止业务逻辑计算
2. **后端**: 禁止返回 prompt、禁止返回完整 blocks、必须权限校验

### 8.2 检查方式

1. **自动化**: ESLint、Git Hooks
2. **手动**: 代码审查、关键词搜索
3. **定期**: 代码审计

---

**文档版本**: v1.0  
**最后更新**: 2024年11月  
**维护者**: 开发团队  
**使用场景**: 所有代码审查必须使用此清单

