# 前端路由与页面结构设计文档

> **版本**: v1.0  
> **类型**: 系统级规范（横向）  
> **目的**: 统一路由命名、页面层级、导航结构，避免各页面各自为政  
> **适用范围**: 小佩 App 所有前端页面开发

---

## 文档说明

### 为什么需要这个文档？

- ✅ **统一路由命名**：避免出现 `Chat` / `ChatScreen` / `ChatPage` 混用
- ✅ **明确页面层级**：哪些页面全屏？哪些显示底部导航？
- ✅ **规范导航跳转**：统一使用 `ROUTES` 常量，禁止硬编码
- ✅ **清晰路由树**：所有开发者对架构有统一认知

### 相关文档

- **参考**: `APP开发文档.md` 3.3 路由命名规范
- **参考**: `底部导航设计文档.md` 3.1 路由结构
- **遵循**: `security/前端开发安全规范.md` 前端职责分离

---

## 一、路由命名规范（强制）

### 1.1 React Navigation Screen Name

**规则**: 使用 **PascalCase** 命名

| Screen Name | 说明 | 类型 |
|------------|------|------|
| `Auth` | 登录/注册页 | 全屏 |
| `Onboarding` | 用户引导页（新用户） | 全屏 |
| `MainTabs` | 底部导航主界面 | Tab Container |
| `ManualBazi` | 手动排盘页 | 全屏 |
| `ChatInput` | 聊天方式输入出生信息 | 全屏 |
| `Cases` | 檔案列表（命盘档案） | Tab |
| `XiaoPeiHome` | 小佩主页 | Tab |
| `Me` | 我的主页 | Tab |
| `Chat` | 聊天页 | 全屏 |
| `ChartDetail` | 命盘详情页 | 全屏 |
| `MyCharts` | 我的命盘列表 | 全屏 |
| `ChatHistory` | 聊天记录 | 全屏 |
| `MyReading` | 我的解读 | 全屏 |
| `ProSubscribe` | 小佩 Pro 订阅页 | 全屏 |
| `Settings` | 设置 | 全屏 |
| `Feedback` | 意见反馈 | 全屏 |
| `ContactSupport` | 联系客服 | 全屏 |
| `InviteFriends` | 邀请好友 | 全屏 |
| `About` | 关于 | 全屏 |

**使用示例**:
```typescript
// ✅ 正确
navigation.navigate('Chat', { conversationId: 'xxx' });
navigation.navigate('ManualBazi', { from: 'cases' });

// ❌ 错误（硬编码字符串，大小写不一致）
navigation.navigate('chat', { conversationId: 'xxx' });
navigation.navigate('manual-bazi', { from: 'cases' });
```

---

### 1.2 路由常量文件（强制使用）

**位置**: `src/constants/routes.ts`

**内容**:
```typescript
// src/constants/routes.ts
// 此文件定义所有路由常量，禁止在代码中硬编码路由名称

export const ROUTES = {
  // ===== Auth & Onboarding =====
  Auth: 'Auth',
  Onboarding: 'Onboarding',
  
  // ===== Main Tabs =====
  MainTabs: 'MainTabs',
  Cases: 'Cases',
  XiaoPeiHome: 'XiaoPeiHome',
  Me: 'Me',
  
  // ===== Full Screen Pages =====
  ManualBazi: 'ManualBazi',
  ChatInput: 'ChatInput',
  Chat: 'Chat',
  ChartDetail: 'ChartDetail',
  
  // ===== My Pages =====
  MyCharts: 'MyCharts',
  ChatHistory: 'ChatHistory',
  MyReading: 'MyReading',
  
  // ===== Pro & Settings =====
  ProSubscribe: 'ProSubscribe',
  Settings: 'Settings',
  Feedback: 'Feedback',
  ContactSupport: 'ContactSupport',
  InviteFriends: 'InviteFriends',
  About: 'About',
} as const;

// TypeScript 类型推导
export type RouteName = typeof ROUTES[keyof typeof ROUTES];
```

**使用规范**:
```typescript
import { ROUTES } from '@/constants/routes';

// ✅ 正确：使用常量
navigation.navigate(ROUTES.Chat, { conversationId: 'xxx' });
navigation.navigate(ROUTES.ManualBazi, { from: 'cases' });

// ❌ 错误：硬编码
navigation.navigate('Chat', { conversationId: 'xxx' });
```

---

### 1.3 DeepLink / Web Path（预留）

**规则**: 使用 **kebab-case** 命名

| DeepLink Path | 对应 Screen | 说明 |
|--------------|-------------|------|
| `/auth` | `Auth` | 登录/注册 |
| `/onboarding` | `Onboarding` | 用户引导 |
| `/manual-bazi` | `ManualBazi` | 手动排盘 |
| `/chat` | `Chat` | 聊天页 |
| `/chart/:chartId` | `ChartDetail` | 命盘详情 |
| `/my/charts` | `MyCharts` | 我的命盘 |
| `/my/reading` | `MyReading` | 我的解读 |
| `/my/chat-history` | `ChatHistory` | 聊天记录 |
| `/pro/subscribe` | `ProSubscribe` | Pro 订阅 |
| `/settings` | `Settings` | 设置 |
| `/feedback` | `Feedback` | 意见反馈 |

---

## 二、路由树结构（完整架构）

### 2.1 整体架构图

```
RootStack (Stack Navigator)
│
├─ Auth (登录/注册页)                          [全屏]
├─ Onboarding (用户引导页)                     [全屏]
│
├─ MainTabs (Tab Navigator) ─────────────────> [显示底部导航]
│  │
│  ├─ Cases (檔案列表)                         [Tab 1]
│  ├─ XiaoPeiHome (小佩主页)                   [Tab 2 - 中间悬浮按钮]
│  └─ Me (我的主页)                            [Tab 3]
│
├─ ManualBazi (手動排盤)                       [全屏，无底部导航]
├─ ChatInput (聊天方式输入出生信息)            [全屏，无底部导航]
├─ Chat (聊天页)                               [全屏，无底部导航]
├─ ChartDetail (命盘详情页)                   [全屏，无底部导航]
│
├─ MyCharts (我的命盘列表)                     [全屏，无底部导航]
├─ ChatHistory (聊天记录)                     [全屏，无底部导航]
├─ MyReading (我的解读)                       [全屏，无底部导航]
│
├─ ProSubscribe (小佩 Pro 订阅页)             [全屏，无底部导航]
├─ Settings (设置)                            [全屏，无底部导航]
├─ Feedback (意见反馈)                        [全屏，无底部导航]
├─ ContactSupport (联系客服)                  [全屏，无底部导航]
├─ InviteFriends (邀请好友)                   [全屏，无底部导航]
└─ About (关于)                               [全屏，无底部导航]
```

---

### 2.2 MainTabs（底部导航）详细结构

```typescript
// MainTabs 包含 3 个实际 Screen（排盤 Tab 是快捷跳转）
MainTabs (Tab.Navigator)
├─ Cases (Tab 1: 檔案)
│  └─ CasesScreen.tsx
│
├─ XiaoPeiHome (Tab 2: 小佩 - 中间悬浮按钮)
│  └─ XiaoPeiHomeScreen.tsx
│
└─ Me (Tab 3: 我的)
   └─ MeScreen.tsx

注意：
- 「排盤」Tab 不是真正的 Screen，点击后跳转到 RootStack 的 ManualBazi
- 底部导航由 XiaoPeiTabBar 自定义组件实现
```

---

### 2.3 页面层级明细表

| Screen | 层级 | 底部导航 | 顶部栏 | 返回方式 |
|--------|------|---------|--------|---------|
| `Auth` | Root | ❌ 不显示 | ❌ 无 | 系统返回 |
| `Onboarding` | Root | ❌ 不显示 | ❌ 无 | 不可返回 |
| `MainTabs` | Root | ✅ 显示 | ✅ 各 Tab 自定义 | Tab 切换 |
| `Cases` | Tab | ✅ 显示 | ✅ 搜索/筛选 | Tab 切换 |
| `XiaoPeiHome` | Tab | ✅ 显示 | ✅ 标题 | Tab 切换 |
| `Me` | Tab | ✅ 显示 | ✅ 标题 | Tab 切换 |
| `ManualBazi` | Root | ❌ 不显示 | ✅ 返回按钮 + 标题 | 左上角返回 |
| `ChatInput` | Root | ❌ 不显示 | ✅ 返回按钮 + 标题 | 左上角返回 |
| `Chat` | Root | ❌ 不显示 | ✅ 返回按钮 + 标题 | 左上角返回 |
| `ChartDetail` | Root | ❌ 不显示 | ✅ 返回按钮 + Tabs | 左上角返回 |
| `MyCharts` | Root | ❌ 不显示 | ✅ 返回按钮 + 标题 | 左上角返回 |
| `ChatHistory` | Root | ❌ 不显示 | ✅ 返回按钮 + 标题 | 左上角返回 |
| `MyReading` | Root | ❌ 不显示 | ✅ 返回按钮 + 标题 | 左上角返回 |
| `ProSubscribe` | Root | ❌ 不显示 | ✅ 返回按钮 + 标题 | 左上角返回 |
| `Settings` | Root | ❌ 不显示 | ✅ 返回按钮 + 标题 | 左上角返回 |
| `Feedback` | Root | ❌ 不显示 | ✅ 返回按钮 + 标题 | 左上角返回 |

---

## 三、导航跳转规范

### 3.1 跳转方法统一

**规则**: 统一使用 `navigation.navigate()`，禁止使用 `push` / `replace`（除非特殊场景）

```typescript
import { ROUTES } from '@/constants/routes';
import { useNavigation } from '@react-navigation/native';
import type { NavigationProp } from '@react-navigation/native';
import type { RootStackParamList } from '@/types/navigation';

// ✅ 正确：使用类型化的 navigation
const navigation = useNavigation<NavigationProp<RootStackParamList>>();

// 基本跳转
navigation.navigate(ROUTES.Chat, { conversationId: 'xxx' });

// 跳转到 Tab
navigation.navigate(ROUTES.MainTabs, { screen: ROUTES.XiaoPeiHome });

// 返回
navigation.goBack();

// ❌ 错误：硬编码
navigation.navigate('Chat');
```

---

### 3.2 常见跳转场景

#### 3.2.1 从小佩主页跳转到聊天页

```typescript
// XiaoPeiHomeScreen.tsx
import { ROUTES } from '@/constants/routes';

// 点击话题按钮
const handleTopicPress = (topic: TopicKey, question: string) => {
  navigation.navigate(ROUTES.Chat, {
    topic,
    question,
    source: 'xiaopei_topic_button',
    masterId: currentMasterId,
  });
};
```

#### 3.2.2 从命盘档案跳转到命盘详情

```typescript
// CasesScreen.tsx
import { ROUTES } from '@/constants/routes';

const handleChartPress = (chartId: string) => {
  navigation.navigate(ROUTES.ChartDetail, {
    chartId,
    masterId: currentMasterId,
  });
};
```

#### 3.2.3 从我的页面跳转到聊天记录

```typescript
// MeScreen.tsx
import { ROUTES } from '@/constants/routes';

const handleChatHistoryPress = () => {
  navigation.navigate(ROUTES.ChatHistory);
};
```

#### 3.2.4 点击底部导航「排盤」Tab

```typescript
// XiaoPeiTabBar.tsx
import { ROUTES } from '@/constants/routes';

const handlePaipanPress = () => {
  navigation.navigate(ROUTES.ManualBazi, { from: 'tab' });
};
```

---

### 3.3 路由参数类型定义

**位置**: `src/types/navigation.ts`

```typescript
// src/types/navigation.ts
import type { TopicKey, ChatEntrySource } from './chat';
import type { RelationType } from './chart';

export type RootStackParamList = {
  // Auth & Onboarding
  Auth: undefined;
  Onboarding: undefined;
  
  // Main Tabs
  MainTabs: {
    screen?: 'Cases' | 'XiaoPeiHome' | 'Me';
    params?: any;
  };
  
  // Full Screen Pages
  ManualBazi: {
    from: 'tab' | 'cases' | 'account' | 'onboarding';
    relation?: RelationType;
    initialData?: Partial<BirthInfo>;
  };
  
  ChatInput: {
    from: 'onboarding';
  };
  
  Chat: {
    conversationId?: string | null;
    topic?: TopicKey | null;
    question?: string;
    source?: ChatEntrySource;
    masterId?: string;
    sectionKey?: string;
    shenShaCode?: string;
    pillarType?: 'year' | 'month' | 'day' | 'hour';
  };
  
  ChartDetail: {
    chartId: string;
    masterId: string;
    initialTab?: 'basic' | 'overview' | 'fortune';
  };
  
  // My Pages
  MyCharts: undefined;
  ChatHistory: undefined;
  MyReading: undefined;
  
  // Pro & Settings
  ProSubscribe: undefined;
  Settings: undefined;
  Feedback: undefined;
  ContactSupport: undefined;
  InviteFriends: undefined;
  About: undefined;
};

export type MainTabsParamList = {
  Cases: undefined;
  XiaoPeiHome: undefined;
  Me: undefined;
};
```

---

## 四、页面配置规范

### 4.1 Screen Options 统一配置

```typescript
// src/navigation/screenOptions.ts
import { colors } from '@/theme';

// 全屏页面通用配置
export const fullScreenOptions = {
  headerShown: true,
  headerBackTitle: '返回',
  headerStyle: {
    backgroundColor: colors.bg,
    borderBottomWidth: 1,
    borderBottomColor: colors.border,
  },
  headerTintColor: colors.ink,
  headerTitleStyle: {
    fontWeight: '600',
    fontSize: 16,
  },
  animation: 'slide_from_right' as const,
};

// Tab 页面通用配置
export const tabScreenOptions = {
  headerShown: true,
  headerStyle: {
    backgroundColor: colors.bg,
    borderBottomWidth: 1,
    borderBottomColor: colors.border,
  },
  headerTitleStyle: {
    fontWeight: '600',
    fontSize: 16,
  },
};

// 无头部页面配置
export const noHeaderOptions = {
  headerShown: false,
};
```

---

### 4.2 页面级配置示例

```typescript
// src/navigation/RootNavigator.tsx
import { ROUTES } from '@/constants/routes';
import { fullScreenOptions, noHeaderOptions } from './screenOptions';

<Stack.Navigator>
  <Stack.Screen 
    name={ROUTES.Auth} 
    component={AuthScreen}
    options={noHeaderOptions}
  />
  
  <Stack.Screen 
    name={ROUTES.Chat} 
    component={ChatScreen}
    options={{
      ...fullScreenOptions,
      title: '小佩',
    }}
  />
  
  <Stack.Screen 
    name={ROUTES.ManualBazi} 
    component={ManualBaziScreen}
    options={{
      ...fullScreenOptions,
      title: '手动排盘',
    }}
  />
</Stack.Navigator>
```

---

## 五、开发检查清单

### 5.1 新增页面时必须检查

- [ ] 路由名称使用 `PascalCase`（如 `MyCharts`，不是 `myCharts` 或 `my-charts`）
- [ ] 路由名称已添加到 `src/constants/routes.ts`
- [ ] 路由参数类型已添加到 `src/types/navigation.ts` 的 `RootStackParamList`
- [ ] 页面是否显示底部导航已明确（Tab 页面显示，全屏页面不显示）
- [ ] 页面顶部栏配置已设置（有无返回按钮、标题等）
- [ ] 所有跳转使用 `ROUTES` 常量，无硬编码字符串

### 5.2 代码审查检查点

- [ ] ❌ 不允许：`navigation.navigate('Chat')`（硬编码）
- [ ] ✅ 必须：`navigation.navigate(ROUTES.Chat)`（使用常量）
- [ ] ❌ 不允许：路由名称大小写不一致
- [ ] ✅ 必须：路由参数符合 `RootStackParamList` 类型定义
- [ ] ❌ 不允许：在 Tab 页面内再嵌套 Stack Navigator（除非有明确设计）
- [ ] ✅ 必须：全屏页面必须在 `RootStack` 层级，不在 `MainTabs` 内

---

## 六、特殊场景处理

### 6.1 底部导航「排盤」Tab 的处理

**问题**: 「排盤」Tab 点击后跳转到全屏页面，而不是 Tab 内的 Screen

**解决方案**:
```typescript
// XiaoPeiTabBar.tsx
const handleTabPress = (routeName: string) => {
  if (routeName === 'paipan') {
    // 特殊处理：跳转到全屏手动排盘页
    navigation.navigate(ROUTES.ManualBazi, { from: 'tab' });
  } else {
    // 正常 Tab 切换
    navigation.navigate(routeName);
  }
};
```

### 6.2 聊天页历史快捷入口（第一期不实现）

**预留**: 聊天页顶部栏右侧预留图标位置，将来作为「历史快捷入口」

```typescript
// ChatScreen.tsx - 预留代码
const headerRight = () => (
  <Pressable onPress={handleHistoryPress}>
    {/* TODO: 历史快捷入口图标 */}
  </Pressable>
);
```

### 6.3 从聊天页返回的智能处理

**规则**: 根据 `source` 参数决定返回行为

```typescript
// ChatScreen.tsx
const handleBack = () => {
  const { source } = route.params;
  
  if (source === 'xiaopei_topic_button' || source === 'xiaopei_free_input') {
    // 从小佩主页进入 → 返回小佩主页
    navigation.navigate(ROUTES.MainTabs, { screen: ROUTES.XiaoPeiHome });
  } else if (source === 'history') {
    // 从聊天记录进入 → 返回聊天记录
    navigation.navigate(ROUTES.ChatHistory);
  } else {
    // 其他情况 → 默认返回
    navigation.goBack();
  }
};
```

---

## 七、与其他规范文档的关系

### 7.1 与 UI_SPEC.md 的关系

- **UI_SPEC.md** 定义样式规范（颜色、字体、间距）
- **本文档** 定义路由结构和导航规范
- **协同**: 页面组件使用 UI_SPEC 的 Design Tokens，路由跳转使用本文档的 ROUTES 常量

### 7.2 与 状态管理与数据模型规范.md 的关系

- **状态管理规范** 定义数据流和 store 结构
- **本文档** 定义页面结构和路由参数
- **协同**: 路由参数类型（如 `chartId`, `conversationId`）对应 store 中的数据模型

### 7.3 与 API 调用与错误处理规范.md 的关系

- **API 调用规范** 定义如何调用后端接口
- **本文档** 定义页面如何跳转和传参
- **协同**: 页面跳转时携带的参数（如 `chartId`）用于 API 调用

---

## 八、常见问题 FAQ

### Q1: 为什么要用 ROUTES 常量而不是直接写字符串？

**A**: 
- ✅ TypeScript 类型检查（拼写错误会被检测）
- ✅ 重构时只需修改一处
- ✅ 避免大小写不一致导致的 bug
- ✅ IDE 自动补全

### Q2: 什么时候用 `navigate`？什么时候用 `push`？

**A**: 
- **navigate**: 95% 的场景，跳转到已存在的页面或新建页面
- **push**: 需要在栈中多次打开同一页面（如多层命盘详情）
- **replace**: 登录成功后替换登录页（防止返回）

### Q3: Tab 页面可以再嵌套 Stack Navigator 吗？

**A**: 
- **不建议**：会导致路由结构复杂，难以维护
- **推荐**：所有全屏页面放在 `RootStack` 层级
- **例外**：如果某个 Tab 确实需要多层导航，需在文档中明确说明

### Q4: 如何处理页面间的数据传递？

**A**: 
1. **简单数据**: 通过路由参数传递（如 `chartId`, `conversationId`）
2. **复杂数据**: 存入 Zustand store，页面间共享
3. **临时数据**: 使用 `route.params`（不要滥用）

---

## 九、更新记录

| 版本 | 日期 | 更新内容 | 更新人 |
|------|------|---------|--------|
| v1.0 | 2024-11-18 | 初始版本，定义完整路由结构和命名规范 | 开发团队 |

---

**文档版本**: v1.0  
**最后更新**: 2024-11-18  
**维护者**: 开发团队  
**相关文档**: `APP开发文档.md`, `底部导航设计文档.md`, `状态管理与数据模型规范.md`

