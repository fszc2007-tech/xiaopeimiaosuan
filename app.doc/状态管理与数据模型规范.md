# 状态管理与数据模型规范

> **版本**: v1.0  
> **类型**: 系统级规范（横向）  
> **目的**: 统一状态管理结构、命名规则、数据流，避免重复定义和混乱  
> **适用范围**: 小佩 App 所有状态管理相关代码

---

## 文档说明

### 为什么需要这个文档？

- ✅ **统一 store 切片**：避免出现 `useUserStore` / `userStore` / `useAuth` 混用
- ✅ **规范 action 命名**：避免 `setUser` / `updateUser` / `saveUser` 语义混乱
- ✅ **明确数据所有权**：哪些数据存 store？哪些存 local storage？
- ✅ **统一数据模型**：与后端 API 响应格式保持一致

### 相关文档

- **参考**: `APP开发文档.md` 6.7 状态管理模块
- **参考**: `API接口统一规范.md` 响应格式
- **遵循**: `security/前端开发安全规范.md` 前端不存储敏感算法

---

## 一、技术选型

### 1.1 状态管理库

**选择**: **Zustand 4.x**（首选）

**理由**:
- ✅ 轻量级（~1KB）
- ✅ 无需 Provider 包裹
- ✅ TypeScript 支持好
- ✅ API 简洁易懂
- ✅ 支持中间件（persist、devtools）

**备选**: Redux Toolkit（如果项目需要更复杂的状态管理）

---

### 1.2 持久化方案

**选择**: `zustand/middleware` + `AsyncStorage`

```typescript
import AsyncStorage from '@react-native-async-storage/async-storage';
import { persist, createJSONStorage } from 'zustand/middleware';

const storage = createJSONStorage(() => AsyncStorage);
```

---

## 二、Store 切片定义（强制规范）

### 2.1 Store 命名规则

**规则**: 使用 `useXxxStore` 格式（React Hook 命名）

| Store 名称 | 职责 | 持久化 |
|-----------|------|--------|
| `useAuthStore` | 用户认证、登录状态 | ✅ 是 |
| `useChartStore` | 命盘数据、当前命主 | ✅ 是 |
| `useChatStore` | 聊天会话、消息列表 | ❌ 否 |
| `useProStore` | Pro 状态、订阅信息 | ✅ 是 |
| `useUIStore` | UI 状态（主题、语言） | ✅ 是 |

**禁止的命名**:
- ❌ `userStore`（缺少 `use` 前缀）
- ❌ `useUser`（太简略，不明确）
- ❌ `authSlice`（Redux 风格，不适用 Zustand）

---

### 2.2 Store 切片详细定义

#### 2.2.1 useAuthStore（认证状态）

**位置**: `src/store/useAuthStore.ts`

**职责**:
- 用户信息管理
- 登录状态管理
- Token 管理
- app_region（CN/HK）管理

**数据结构**:
```typescript
// src/store/useAuthStore.ts
import { create } from 'zustand';
import { persist, createJSONStorage } from 'zustand/middleware';
import AsyncStorage from '@react-native-async-storage/async-storage';
import type { User } from '@/types/user';

interface AuthState {
  // ===== State =====
  user: User | null;
  token: string | null;
  appRegion: 'CN' | 'HK';
  isAuthenticated: boolean;
  
  // ===== Actions =====
  // 登录
  login: (user: User, token: string) => void;
  
  // 登出
  logout: () => void;
  
  // 更新用户信息
  updateUser: (user: Partial<User>) => void;
  
  // 设置 app_region
  setAppRegion: (region: 'CN' | 'HK') => void;
  
  // 设置 token
  setToken: (token: string | null) => void;
  
  // 清空所有数据
  reset: () => void;
}

const initialState = {
  user: null,
  token: null,
  appRegion: 'CN' as const,
  isAuthenticated: false,
};

export const useAuthStore = create<AuthState>()(
  persist(
    (set) => ({
      ...initialState,
      
      login: (user, token) => set({
        user,
        token,
        isAuthenticated: true,
      }),
      
      logout: () => set(initialState),
      
      updateUser: (userData) => set((state) => ({
        user: state.user ? { ...state.user, ...userData } : null,
      })),
      
      setAppRegion: (region) => set({ appRegion: region }),
      
      setToken: (token) => set({ token }),
      
      reset: () => set(initialState),
    }),
    {
      name: 'xiaopei-auth-storage',
      storage: createJSONStorage(() => AsyncStorage),
    }
  )
);
```

**使用示例**:
```typescript
import { useAuthStore } from '@/store/useAuthStore';

// 组件内使用
const user = useAuthStore((state) => state.user);
const login = useAuthStore((state) => state.login);
const logout = useAuthStore((state) => state.logout);

// 登录
await login(userData, token);

// 登出
logout();
```

---

#### 2.2.2 useChartStore（命盘状态）

**位置**: `src/store/useChartStore.ts`

**职责**:
- 当前命主管理
- 命盘档案列表
- 当前命盘数据

**数据结构**:
```typescript
// src/store/useChartStore.ts
import { create } from 'zustand';
import { persist, createJSONStorage } from 'zustand/middleware';
import AsyncStorage from '@react-native-async-storage/async-storage';
import type { ChartProfile, BaziChart } from '@/types/chart';

interface ChartState {
  // ===== State =====
  currentMasterId: string | null;           // 当前命主 ID
  profiles: ChartProfile[];                 // 命盘档案列表
  currentChart: BaziChart | null;           // 当前命盘完整数据
  
  // ===== Actions =====
  // 设置当前命主
  setCurrentMaster: (masterId: string) => void;
  
  // 设置命盘列表
  setProfiles: (profiles: ChartProfile[]) => void;
  
  // 添加新命盘
  addProfile: (profile: ChartProfile) => void;
  
  // 更新命盘信息
  updateProfile: (chartId: string, data: Partial<ChartProfile>) => void;
  
  // 删除命盘
  deleteProfile: (chartId: string) => void;
  
  // 设置当前命盘数据
  setCurrentChart: (chart: BaziChart | null) => void;
  
  // 清空所有数据
  reset: () => void;
}

const initialState = {
  currentMasterId: null,
  profiles: [],
  currentChart: null,
};

export const useChartStore = create<ChartState>()(
  persist(
    (set) => ({
      ...initialState,
      
      setCurrentMaster: (masterId) => set({ currentMasterId: masterId }),
      
      setProfiles: (profiles) => set({ profiles }),
      
      addProfile: (profile) => set((state) => ({
        profiles: [profile, ...state.profiles],
      })),
      
      updateProfile: (chartId, data) => set((state) => ({
        profiles: state.profiles.map(p => 
          p.chartId === chartId ? { ...p, ...data } : p
        ),
      })),
      
      deleteProfile: (chartId) => set((state) => ({
        profiles: state.profiles.filter(p => p.chartId !== chartId),
        currentMasterId: state.currentMasterId === chartId ? null : state.currentMasterId,
      })),
      
      setCurrentChart: (chart) => set({ currentChart: chart }),
      
      reset: () => set(initialState),
    }),
    {
      name: 'xiaopei-chart-storage',
      storage: createJSONStorage(() => AsyncStorage),
      // 只持久化基本信息，完整命盘数据不持久化
      partialize: (state) => ({
        currentMasterId: state.currentMasterId,
        profiles: state.profiles,
      }),
    }
  )
);
```

---

#### 2.2.3 useChatStore（聊天状态）

**位置**: `src/store/useChatStore.ts`

**职责**:
- 当前会话管理
- 消息列表管理
- 加载状态管理
- 追问建议管理

**数据结构**:
```typescript
// src/store/useChatStore.ts
import { create } from 'zustand';
import type { ChatMessage, FollowUpSuggestion } from '@/types/chat';

interface ChatState {
  // ===== State =====
  currentConversationId: string | null;     // 当前会话 ID
  messages: ChatMessage[];                  // 消息列表
  isThinking: boolean;                      // 小佩是否正在思考
  followUpSuggestions: FollowUpSuggestion[]; // 追问建议
  error: string | null;                     // 错误信息
  
  // ===== Actions =====
  // 设置当前会话 ID
  setCurrentConversation: (conversationId: string | null) => void;
  
  // 设置消息列表
  setMessages: (messages: ChatMessage[]) => void;
  
  // 添加用户消息
  addUserMessage: (content: string) => void;
  
  // 添加小佩消息
  addAssistantMessage: (content: string, metadata?: any) => void;
  
  // 设置思考状态
  setThinking: (isThinking: boolean) => void;
  
  // 设置追问建议
  setFollowUpSuggestions: (suggestions: FollowUpSuggestion[]) => void;
  
  // 设置错误
  setError: (error: string | null) => void;
  
  // 清空当前会话
  clearConversation: () => void;
  
  // 重置所有状态
  reset: () => void;
}

const initialState = {
  currentConversationId: null,
  messages: [],
  isThinking: false,
  followUpSuggestions: [],
  error: null,
};

export const useChatStore = create<ChatState>((set) => ({
  ...initialState,
  
  setCurrentConversation: (conversationId) => set({ 
    currentConversationId: conversationId,
  }),
  
  setMessages: (messages) => set({ messages }),
  
  addUserMessage: (content) => set((state) => ({
    messages: [
      ...state.messages,
      {
        id: `msg_${Date.now()}`,
        role: 'user',
        content,
        timestamp: new Date().toISOString(),
      },
    ],
  })),
  
  addAssistantMessage: (content, metadata) => set((state) => ({
    messages: [
      ...state.messages,
      {
        id: `msg_${Date.now()}`,
        role: 'assistant',
        content,
        timestamp: new Date().toISOString(),
        metadata,
      },
    ],
  })),
  
  setThinking: (isThinking) => set({ isThinking }),
  
  setFollowUpSuggestions: (suggestions) => set({ followUpSuggestions: suggestions }),
  
  setError: (error) => set({ error }),
  
  clearConversation: () => set({
    currentConversationId: null,
    messages: [],
    followUpSuggestions: [],
    error: null,
  }),
  
  reset: () => set(initialState),
}));
```

**注意**: `useChatStore` 不持久化，会话数据从服务器获取

---

#### 2.2.4 useProStore（Pro 状态）

**位置**: `src/store/useProStore.ts`

**职责**:
- Pro 用户状态
- 订阅计划信息
- 功能权限管理

**数据结构**:
```typescript
// src/store/useProStore.ts
import { create } from 'zustand';
import { persist, createJSONStorage } from 'zustand/middleware';
import AsyncStorage from '@react-native-async-storage/async-storage';
import type { ProPlan } from '@/types/pro';

interface ProState {
  // ===== State =====
  isPro: boolean;
  plan: ProPlan | null;                     // 'yearly' | 'monthly' | 'lifetime' | null
  expiresAt: string | null;                 // ISO 8601 时间戳
  features: string[];                       // Pro 功能列表
  
  // ===== Actions =====
  // 设置 Pro 状态
  setProStatus: (isPro: boolean, plan?: ProPlan, expiresAt?: string) => void;
  
  // 刷新 Pro 状态（从服务器）
  refreshProStatus: () => Promise<void>;
  
  // 检查功能权限
  hasFeature: (feature: string) => boolean;
  
  // 检查是否过期
  isExpired: () => boolean;
  
  // 重置状态
  reset: () => void;
}

const initialState = {
  isPro: false,
  plan: null,
  expiresAt: null,
  features: [],
};

export const useProStore = create<ProState>()(
  persist(
    (set, get) => ({
      ...initialState,
      
      setProStatus: (isPro, plan, expiresAt) => set({
        isPro,
        plan: plan || null,
        expiresAt: expiresAt || null,
      }),
      
      refreshProStatus: async () => {
        // TODO: 调用 API 获取最新 Pro 状态
        // const status = await proApi.getStatus();
        // set(status);
      },
      
      hasFeature: (feature) => {
        const state = get();
        return state.isPro && state.features.includes(feature);
      },
      
      isExpired: () => {
        const state = get();
        if (state.plan === 'lifetime') return false;
        if (!state.expiresAt) return true;
        return new Date() > new Date(state.expiresAt);
      },
      
      reset: () => set(initialState),
    }),
    {
      name: 'xiaopei-pro-storage',
      storage: createJSONStorage(() => AsyncStorage),
    }
  )
);
```

---

#### 2.2.5 useUIStore（UI 状态）

**位置**: `src/store/useUIStore.ts`

**职责**:
- 主题管理（预留）
- 语言管理
- 底部抽屉状态
- 全局 UI 状态

**数据结构**:
```typescript
// src/store/useUIStore.ts
import { create } from 'zustand';
import { persist, createJSONStorage } from 'zustand/middleware';
import AsyncStorage from '@react-native-async-storage/async-storage';

interface UIState {
  // ===== State =====
  theme: 'light' | 'dark';                  // 主题（预留）
  language: 'zh-CN' | 'zh-HK';              // 语言
  bottomSheetVisible: boolean;              // 底部抽屉是否可见
  bottomSheetContent: 'filter' | 'menu' | null; // 底部抽屉内容类型
  
  // ===== Actions =====
  // 设置主题
  setTheme: (theme: 'light' | 'dark') => void;
  
  // 设置语言
  setLanguage: (language: 'zh-CN' | 'zh-HK') => void;
  
  // 显示底部抽屉
  showBottomSheet: (content: 'filter' | 'menu') => void;
  
  // 隐藏底部抽屉
  hideBottomSheet: () => void;
  
  // 重置状态
  reset: () => void;
}

const initialState = {
  theme: 'light' as const,
  language: 'zh-CN' as const,
  bottomSheetVisible: false,
  bottomSheetContent: null,
};

export const useUIStore = create<UIState>()(
  persist(
    (set) => ({
      ...initialState,
      
      setTheme: (theme) => set({ theme }),
      
      setLanguage: (language) => set({ language }),
      
      showBottomSheet: (content) => set({ 
        bottomSheetVisible: true, 
        bottomSheetContent: content,
      }),
      
      hideBottomSheet: () => set({ 
        bottomSheetVisible: false,
        bottomSheetContent: null,
      }),
      
      reset: () => set(initialState),
    }),
    {
      name: 'xiaopei-ui-storage',
      storage: createJSONStorage(() => AsyncStorage),
    }
  )
);
```

---

## 三、Action 命名规范

### 3.1 统一的 Action 命名模式

| 前缀 | 用途 | 示例 |
|------|------|------|
| `set` | 直接设置值 | `setUser`, `setToken`, `setMessages` |
| `add` | 添加单个项 | `addProfile`, `addUserMessage` |
| `update` | 更新已有项 | `updateUser`, `updateProfile` |
| `delete` | 删除项 | `deleteProfile`, `deleteMessage` |
| `fetch` | 从 API 获取数据 | `fetchProfiles`, `fetchMessages` |
| `refresh` | 刷新数据 | `refreshProStatus`, `refreshMessages` |
| `clear` | 清空数据 | `clearConversation`, `clearCache` |
| `reset` | 重置为初始状态 | `reset` |

**示例**:
```typescript
// ✅ 正确
setUser(user)           // 直接设置
addProfile(profile)     // 添加
updateUser(userData)    // 更新
deleteProfile(id)       // 删除
fetchProfiles()         // 获取
refreshProStatus()      // 刷新
clearConversation()     // 清空
reset()                 // 重置

// ❌ 错误（命名不一致）
saveUser(user)          // 应该用 setUser
createProfile(profile)  // 应该用 addProfile
removeProfile(id)       // 应该用 deleteProfile
loadProfiles()          // 应该用 fetchProfiles
```

---

### 3.2 异步 Action 规范

**规则**: 异步 action 必须返回 `Promise`

```typescript
// ✅ 正确
refreshProStatus: async () => {
  try {
    const status = await proApi.getStatus();
    set(status);
  } catch (error) {
    console.error('Failed to refresh Pro status:', error);
  }
},

// 使用
await refreshProStatus();
```

---

## 四、数据模型定义

### 4.1 类型定义位置

**位置**: `src/types/`

| 文件 | 内容 |
|------|------|
| `user.ts` | User、UserPreferences |
| `chart.ts` | ChartProfile、BaziChart、RelationType |
| `chat.ts` | ChatMessage、Conversation、TopicKey、ChatEntrySource |
| `pro.ts` | ProPlan、ProStatus、SubscriptionPlan |
| `navigation.ts` | RootStackParamList、MainTabsParamList |

---

### 4.2 数据模型示例

#### 4.2.1 User（用户）

```typescript
// src/types/user.ts
export interface User {
  userId: string;
  phone?: string;
  email?: string;
  nickname: string;
  avatarUrl?: string;
  appRegion: 'CN' | 'HK';
  isPro: boolean;
  proExpiresAt?: string;
  proPlan?: 'yearly' | 'monthly' | 'lifetime';
  inviteCode: string;
  createdAt: string;
  updatedAt: string;
}
```

#### 4.2.2 ChartProfile（命盘档案）

```typescript
// src/types/chart.ts
export type RelationType = 
  | 'self'      // 本人
  | 'spouse'    // 伴侣
  | 'child'     // 子女
  | 'parent'    // 父母
  | 'friend'    // 朋友
  | 'other';    // 其他

export interface ChartProfile {
  chartId: string;
  userId: string;
  name: string;
  nickname?: string;
  relation: RelationType;
  birthDate: string;           // ISO 8601
  birthTime: string;           // HH:mm
  birthPlace: string;
  gender: 'male' | 'female';
  useRealSolarTime: boolean;
  isDefault: boolean;          // 是否为当前命主
  createdAt: string;
  updatedAt: string;
}
```

#### 4.2.3 ChatMessage（聊天消息）

```typescript
// src/types/chat.ts
export interface ChatMessage {
  id: string;
  conversationId: string;
  role: 'user' | 'assistant';
  content: string;
  timestamp: string;
  metadata?: {
    topic?: TopicKey;
    sectionKey?: string;
    shenShaCode?: string;
    suggestedQuestions?: string[];
  };
}
```

---

## 五、数据流规范

### 5.1 数据流向图

```
┌─────────────┐
│   UI 组件   │
└──────┬──────┘
       │ dispatch action
       ▼
┌─────────────┐
│   Store     │ ◄──── persist middleware
└──────┬──────┘
       │ update state
       ▼
┌─────────────┐
│  UI 重新渲染 │
└─────────────┘
```

---

### 5.2 Store 与 API 的协作

**规则**: Store 不直接调用 API，由组件或 service 调用 API 后更新 Store

```typescript
// ❌ 错误：在 store 内部调用 API
const useChartStore = create((set) => ({
  fetchProfiles: async () => {
    const profiles = await chartApi.getProfiles(); // ❌ 不推荐
    set({ profiles });
  },
}));

// ✅ 正确：在组件或 service 中调用 API，然后更新 store
const fetchProfiles = async () => {
  const profiles = await chartApi.getProfiles();
  useChartStore.getState().setProfiles(profiles);
};
```

---

### 5.3 Store 间的依赖

**规则**: Store 之间可以相互引用，但要避免循环依赖

```typescript
// ✅ 正确：useAuthStore 清空时，同时清空其他 store
import { useChartStore } from './useChartStore';
import { useChatStore } from './useChatStore';
import { useProStore } from './useProStore';

export const useAuthStore = create((set) => ({
  logout: () => {
    set(initialState);
    // 清空其他 store
    useChartStore.getState().reset();
    useChatStore.getState().reset();
    useProStore.getState().reset();
  },
}));
```

---

## 六、开发检查清单

### 6.1 新增 Store 时必须检查

- [ ] Store 名称使用 `useXxxStore` 格式
- [ ] State 接口命名为 `XxxState`
- [ ] 所有 action 使用统一前缀（`set`, `add`, `update`, `delete`, `fetch`, `clear`, `reset`）
- [ ] 异步 action 返回 `Promise`
- [ ] 需要持久化的 store 使用 `persist` middleware
- [ ] 初始状态定义为 `initialState` 常量
- [ ] 提供 `reset` action 用于清空状态

### 6.2 代码审查检查点

- [ ] ❌ 不允许：Store 名称不规范（如 `chartStore` 而非 `useChartStore`）
- [ ] ❌ 不允许：Action 命名不一致（如 `saveUser` 而非 `setUser`）
- [ ] ❌ 不允许：在 store 内部直接调用 API（应在组件/service 中调用）
- [ ] ❌ 不允许：Store 间循环依赖
- [ ] ✅ 必须：所有 TypeScript 类型完整，无 `any`

---

## 七、与其他规范文档的关系

### 7.1 与 前端路由与页面结构设计文档.md 的关系

- **路由文档** 定义路由参数类型（如 `chartId`, `conversationId`）
- **本文档** 定义 store 中存储这些数据的结构
- **协同**: 路由参数 → 组件 → 调用 API → 更新 Store → UI 重新渲染

### 7.2 与 API 调用与错误处理规范.md 的关系

- **API 调用规范** 定义如何调用后端接口
- **本文档** 定义如何存储 API 返回的数据
- **协同**: API 响应 → DTO 转换 → 更新 Store

### 7.3 与 UI_SPEC.md 的关系

- **UI_SPEC.md** 定义视觉样式
- **本文档** 定义数据结构和状态管理
- **协同**: Store 中的数据驱动 UI 组件的渲染

---

## 八、常见问题 FAQ

### Q1: 什么数据应该存 Store？什么数据应该存组件 state？

**A**:
- **Store**: 需要跨页面共享的数据（用户、命盘、Pro 状态）
- **组件 state**: 仅在单个组件内使用的数据（表单输入、UI 临时状态）

### Q2: 为什么 useChatStore 不持久化？

**A**: 
- 聊天消息由服务器管理，刷新时从 API 获取
- 避免本地缓存与服务器数据不一致
- 减少本地存储空间占用

### Q3: 如何在组件外部访问 Store？

**A**:
```typescript
// 组件内部
const user = useAuthStore((state) => state.user);

// 组件外部（如 API client）
const token = useAuthStore.getState().token;
```

### Q4: 如何监听 Store 变化？

**A**:
```typescript
// 使用 zustand 的 subscribe
useAuthStore.subscribe((state) => {
  console.log('User changed:', state.user);
});
```

---

## 九、更新记录

| 版本 | 日期 | 更新内容 | 更新人 |
|------|------|---------|--------|
| v1.0 | 2024-11-18 | 初始版本，定义完整 Store 结构和命名规范 | 开发团队 |

---

**文档版本**: v1.0  
**最后更新**: 2024-11-18  
**维护者**: 开发团队  
**相关文档**: `APP开发文档.md`, `前端路由与页面结构设计文档.md`, `API 调用与错误处理规范.md`

