# 开发准备清单分析与建议

> **版本**: v1.1  
> **创建日期**: 2024年11月  
> **最后更新**: 2024年11月  
> **状态**: 分析完成，所有问题已确认，等待最终开发指令

---

## 一、总体评估

开发准备清单整体与现有系统设计**高度一致**，经过分析和确认，以下问题已明确：

### ✅ 已确认的决策

1. **命名统一**: 统一使用 `core`（不是 `core-api`），API 路径统一使用 `/api/v1/...`
2. **登录方式**: 支持手机号（CN）和邮箱（HK）
3. **错误响应格式**: 统一使用包含 `success` 字段的格式
4. **模型路由**: 明确支持三个模型（DeepSeek、ChatGPT、Qwen），没有其他模型，如有需要再另外增加

以下是详细分析。

---

## 二、需要明确的命名问题

### 2.1 后端服务命名

**清单中提到**: "后端 core-api（是不是叫 core-api 还是叫 core 需要你明确一下）"

**现有设计**: 
- 文档中统一使用 `core`（与项目目录 `core/` 保持一致）
- 参考：`app.doc/security/Core架构与安全策略方案.md`

**建议**: 
- ✅ **统一使用 `core`**，不要使用 `core-api`
- 理由：与项目目录结构一致，与现有文档命名一致
- 在代码和文档中统一使用 `core` 或 `core-service`（服务运行时名称）

---

## 三、与现有设计的一致性检查

### 3.1 底部导航结构 ✅ 一致

**清单描述**:
- 四个入口：排盤、檔案、小佩、我的
- 小佩为居中悬浮按钮
- 全屏页面隐藏底部 TabBar

**设计文档**: `features/底部导航设计文档.md`
- ✅ 完全一致
- 底部导航包含 4 个 Tab
- 小佩为悬浮按钮（或作为 Tab，根据最新设计）

**建议**: 
- 确认小佩是"悬浮按钮"还是"Tab"（根据 `底部导航设计文档.md` 最新版本）

---

### 3.2 登录/注册流程 ✅ 基本一致

**清单描述**:
- 手机号 + 验证码登录
- 合并登录/注册页面
- 支持忘记密码（预留）

**设计文档**: `features/注册登录设计文档.md`
- ✅ 基本一致
- 支持手机号/邮箱登录（根据区域）
- 验证码登录/注册合并流程

**已确认**:
- ✅ 支持手机号登录（CN 区域）
- ✅ 支持邮箱登录（HK 区域）
- ✅ 根据 `app_region` 自动选择登录方式

**接口路径**（已统一）:
- ✅ 统一使用 `/api/v1/auth/login_or_register`
- ✅ 统一使用 `/api/v1/auth/request-otp`
- ✅ 所有 API 路径统一使用 `/api/v1/...` 前缀

---

### 3.3 首次首页 & 出生信息采集 ✅ 一致

**清单描述**:
- 引导首页
- 两个入口：聊天排盘、手动排盘

**设计文档**: 
- `features/用户引导页设计文档.md` ✅
- `features/出生信息輸入-聊天.md` ✅
- `features/出生信息輸入-手動排盤.md` ✅

**完全一致**，按设计文档实现即可。

---

### 3.4 手动排盘页 ✅ 一致

**清单描述**:
- 字段：姓名、性别、出生日期时间、出生地点、真太阳时
- 接口：`POST /api/baZi/calc`

**设计文档**: `features/出生信息輸入-手動排盤.md`
- ✅ 字段完全一致
- ✅ 交互流程一致

**接口路径**（已统一）:
- ✅ 统一使用 `POST /api/v1/bazi/chart`（与设计文档一致，符合 RESTful 规范）

---

### 3.5 命盘页面三大 Tab ✅ 一致

**清单描述**:
- 基本信息（命盤檔案）
- 命盤總覽
- 大運流年

**设计文档**:
- `features/基本信息设计文档.md` ✅
- `features/命盤總覽设计文档.md` ✅
- 大運流年（在命盤總覽中提及）✅

**接口路径**（已统一）:
- ✅ 统一使用 `GET /api/v1/bazi/charts/:chartId`（获取单个命盘）
- ✅ 统一使用 `GET /api/v1/bazi/charts`（获取命盘列表）
- ✅ 统一使用 `chartId` 作为路径参数（不是 `id` 或 `mingpanId`）

---

### 3.6 檔案 - 命盘列表 ✅ 一致

**清单描述**:
- 命盘列表展示
- 点击进入命盘页面
- 新增命盘按钮

**设计文档**: `features/檔案－命盤列表設計文檔.md`
- ✅ 完全一致

---

### 3.7 小佩 Tab & 聊天系统 ✅ 基本一致

**清单描述**:
- 小佩主页（推荐话题卡片）
- 专题页（如桃花）
- 聊天页（通用组件）
- 历史对话管理在「我的 → 聊天记录」

**设计文档**:
- `features/小佩主页设计文档.md` ✅
- `features/聊天页设计文档（公共组件版）.md` ✅
- `features/我的-二级-内容查看页面设计文档.md` ✅（聊天记录）

**接口路径**（已统一）:
- ✅ 解读接口：`POST /api/v1/bazi/reading`（获取命理解读）
- ✅ 对话相关接口：`GET /api/v1/chat/conversations`、`POST /api/v1/chat/conversations/:conversationId/messages` 等
- ✅ 明确区分"解读"和"对话"的接口用途

---

### 3.8 我的 Tab ✅ 一致

**清单描述**:
- 账号信息、Pro 权益、聊天记录、意见反馈、设置等

**设计文档**: 
- `features/我的-一级设计文档.md` ✅
- `features/我的-二级-内容查看页面设计文档.md` ✅
- `features/我的-二级-邀请好友和设置设计文档.md` ✅
- `features/我的-二级-意见反馈和客服设计文档.md` ✅

**完全一致**。

---

### 3.9 后端接口 ✅ 需要统一路径

**清单中的接口**:
- `POST /api/baZi/calc` → 应改为 `POST /api/v1/bazi/chart`
- `GET /api/mingpan/:id` → 应改为 `GET /api/v1/bazi/charts/:chartId`
- `GET /api/mingpan` → 应改为 `GET /api/v1/bazi/charts`
- `POST /api/chat` → 需要明确是 `/api/v1/chat/...` 还是 `/api/v1/bazi/reading`

**设计文档中的接口**:
- 参考 `app.doc/数据库与API设计方案.md`
- 统一使用 `/api/v1/...` 前缀
- 使用 RESTful 风格

**建议**: 
- ✅ 统一使用 `/api/v1/...` 前缀
- ✅ 统一使用 `chartId` 而不是 `id` 或 `mingpanId`
- ✅ 统一使用 `snake_case` 路径（如 `bazi` 而不是 `baZi`）

---

### 3.10 国际化 ✅ 一致

**清单描述**:
- 简体：zh-CN（中国大陆）
- 繁体：zh-HK（香港/海外）
- 使用 i18n 资源文件

**设计文档**: `features/注册登录设计文档.md`
- ✅ 完全一致
- 使用 `app_region` 区分 CN/HK
- 语言绑定规则一致

---

### 3.11 Admin 后台 ✅ 一致

**清单描述**:
- 登录、用户管理、大模型 API 配置、Pro 开关管理

**设计文档**: `admin.doc/Admin后台最小需求功能文档.md`
- ✅ 完全一致
- 功能模块对应

---

## 四、需要补充和明确的内容

### 4.1 API 接口路径统一（已确认）✅

**统一为**:
```typescript
// 认证相关
POST /api/v1/auth/login_or_register
POST /api/v1/auth/request-otp
POST /api/v1/auth/refresh
POST /api/v1/auth/logout

// 命盘相关
POST /api/v1/bazi/chart              // 创建命盘（排盘）
GET /api/v1/bazi/charts              // 获取命盘列表
GET /api/v1/bazi/charts/:chartId     // 获取命盘详情
PUT /api/v1/bazi/charts/:chartId     // 更新命盘档案
DELETE /api/v1/bazi/charts/:chartId  // 删除命盘

// 解读相关
POST /api/v1/bazi/reading            // 获取命理解读

// 对话相关
GET /api/v1/chat/conversations       // 获取对话列表
GET /api/v1/chat/conversations/:conversationId/messages  // 获取消息列表
POST /api/v1/chat/conversations/:conversationId/messages // 发送消息
DELETE /api/v1/chat/conversations/:conversationId        // 删除对话

// 用户相关
GET /api/v1/me/entitlements          // 获取用户权益
```

---

### 4.2 参数命名统一

**建议**:
- 路径参数：使用 `chartId` 而不是 `id` 或 `mingpanId`
- 请求体：使用 `camelCase`（前端）→ 后端转换为 `snake_case`
- 响应体：后端返回 `snake_case` → 前端转换为 `camelCase`

---

### 4.3 错误响应格式

**已确认**（统一格式）:
```typescript
// 成功响应
{
  success: true,
  data: T
}

// 错误响应
{
  success: false,
  error: {
    code: string,
    message: string,
    details?: any
  }
}
```

**说明**:
- ✅ 所有 API 响应统一使用此格式
- ✅ 前端可以统一判断 `response.success`
- ✅ 成功时返回 `data`，失败时返回 `error`

---

### 4.4 模型路由逻辑

**已确认**:
- ✅ 支持三个模型：**DeepSeek**、**ChatGPT**、**Qwen**
- ✅ 没有其他模型，如有需要再另外增加（先不开发）
- ✅ 支持模型切换和备用模型配置（通过 Admin 后台配置）
- ✅ 支持 DeepSeek 思考模式切换（通过 Admin 后台配置）
- ✅ 模型路由策略：国内默认 DeepSeek，香港/海外默认 ChatGPT，可通过 Admin 后台调整

---

### 4.5 历史对话管理

**清单描述**: "历史聊天列表不在聊天页内展示，单独页面：我的 → 聊天记录"

**设计文档**: `features/聊天页设计文档（公共组件版）.md`
- ✅ 完全一致
- 采用"集中管理方案"
- 聊天页只处理当前会话

---

## 五、开发顺序建议

清单中的开发顺序**合理**，建议微调：

### 推荐顺序（微调版）

1. ✅ **搭建项目骨架**
   - 创建 `app/`、`admin/`、`core/` 目录
   - 配置 TypeScript、ESLint、Prettier
   - **注意**: 确保 ESLint 规则禁止导入 `core/engine`

2. ✅ **实现 UI 基础与主题**
   - 根据 `UI_SPEC.md` 建立 Theme/Token 系统
   - 实现基础组件

3. ✅ **实现 App 底部导航 + 小佩悬浮按钮**
   - 参考 `features/底部导航设计文档.md`

4. ✅ **登录/注册流程 + 国际化**
   - 参考 `features/注册登录设计文档.md`
   - 支持手机号（CN）和邮箱（HK）

5. ✅ **手动排盘页 & 排盘流程**
   - 参考 `features/出生信息輸入-手動排盤.md`
   - 接口：`POST /api/v1/bazi/chart`

6. ✅ **命盘页面三大 Tab**
   - 参考 `features/基本信息设计文档.md` 和 `features/命盤總覽设计文档.md`
   - 接口：`GET /api/v1/bazi/charts/:chartId`

7. ✅ **檔案 Tab（命盘列表）**
   - 参考 `features/檔案－命盤列表設計文檔.md`
   - 接口：`GET /api/v1/bazi/charts`

8. ✅ **小佩主页 + 聊天系统**
   - 参考 `features/小佩主页设计文档.md`
   - 参考 `features/聊天页设计文档（公共组件版）.md`
   - 接口：`POST /api/v1/bazi/reading`

9. ✅ **我的 Tab + 聊天记录 + Pro 页面**
   - 参考 `features/我的-一级设计文档.md` 及相关二级文档

10. ✅ **Admin 后台最小功能**
    - 参考 `admin.doc/Admin后台最小需求功能文档.md`

11. ✅ **优化与收尾**

---

## 六、关键注意事项

### 6.1 安全规范

**必须遵守**:
- ❌ 前端禁止引入 `core/engine`
- ❌ 前端禁止包含 prompt 模板
- ❌ 前端禁止进行计费判断（业务逻辑）
- ✅ 所有业务逻辑通过 API 调用
- ✅ 参考 `app.doc/security/前端开发安全规范.md`

### 6.2 API 调用规范

**必须遵守**:
- ✅ 所有 API 调用通过统一的 `apiService`
- ✅ 必须携带 JWT Token
- ✅ 统一错误处理
- ✅ 使用 `/api/v1/...` 前缀

### 6.3 国际化规范

**必须遵守**:
- ✅ 使用 i18n 资源文件，不在代码中写死中文
- ✅ 根据 `app_region` 设置默认语言
- ✅ 支持 zh-CN 和 zh-HK

### 6.4 UI 规范

**必须遵守**:
- ✅ 所有颜色、字体、间距使用 Design Tokens
- ✅ 禁止硬编码"奇怪颜色"
- ✅ 参考 `UI_SPEC.md`

---

## 七、冲突与不一致总结

### 7.1 已统一的命名 ✅

| 清单中的命名 | 已统一为 | 状态 |
|------------|----------|------|
| `core-api` | `core` | ✅ 已确认 |
| `POST /api/baZi/calc` | `POST /api/v1/bazi/chart` | ✅ 已确认 |
| `GET /api/mingpan/:id` | `GET /api/v1/bazi/charts/:chartId` | ✅ 已确认 |
| `GET /api/mingpan` | `GET /api/v1/bazi/charts` | ✅ 已确认 |
| `POST /api/chat` | `POST /api/v1/bazi/reading`（解读） | ✅ 已确认 |
| `POST /api/auth/login` | `POST /api/v1/auth/login_or_register` | ✅ 已确认 |

### 7.2 已补充和确认的内容 ✅

1. ✅ **登录方式**: 已确认支持手机号（CN 区域）和邮箱（HK 区域）
2. ✅ **错误响应格式**: 已统一为包含 `success` 字段的格式
3. ✅ **模型路由**: 已明确支持三个模型（DeepSeek、ChatGPT、Qwen），没有其他模型
4. ✅ **参数命名**: 已统一使用 `chartId` 而不是 `id` 或 `mingpanId`

### 7.3 完全一致的部分

- ✅ 底部导航结构
- ✅ 首次首页和出生信息采集
- ✅ 手动排盘页字段和交互
- ✅ 命盘页面三大 Tab
- ✅ 檔案 Tab 功能
- ✅ 小佩主页和聊天系统
- ✅ 我的 Tab 功能
- ✅ Admin 后台功能
- ✅ 国际化方案

---

## 八、最终建议

### 8.1 已确认的调整 ✅

1. ✅ **统一后端服务命名**: 使用 `core`（不是 `core-api`）
2. ✅ **统一 API 路径**: 使用 `/api/v1/...` 前缀和 RESTful 风格
3. ✅ **统一参数命名**: 使用 `chartId`（不是 `id` 或 `mingpanId`）
4. ✅ **补充登录方式**: 支持手机号（CN）和邮箱（HK）
5. ✅ **统一错误响应格式**: 包含 `success` 字段
6. ✅ **明确模型路由**: 支持三个模型（DeepSeek、ChatGPT、Qwen），没有其他模型

### 8.2 开发前确认（已完成）✅

1. ✅ **小佩按钮形式**: 根据设计文档，小佩作为 Tab（居中悬浮按钮样式）
2. ✅ **聊天接口**: 解读接口使用 `POST /api/v1/bazi/reading`，对话接口使用 `/api/v1/chat/...`
3. ✅ **模型路由**: 已确认支持 Qwen 和备用模型配置（通过 Admin 后台）

### 8.3 开发中注意

1. **严格遵循安全规范**: 参考 `app.doc/security/` 目录下的规范文档
2. **使用 Design Tokens**: 参考 `UI_SPEC.md`
3. **国际化**: 所有文案使用 i18n，不在代码中写死

---

## 九、最终确认清单

### ✅ 已确认的决策

1. **后端服务命名**: 统一使用 `core`（不是 `core-api`）
2. **API 路径**: 统一使用 `/api/v1/...` 前缀
3. **参数命名**: 统一使用 `chartId`（不是 `id` 或 `mingpanId`）
4. **登录方式**: 支持手机号（CN）和邮箱（HK）
5. **错误响应格式**: 统一使用包含 `success` 字段的格式
6. **模型支持**: 仅支持三个模型（DeepSeek、ChatGPT、Qwen），没有其他模型
7. **模型路由**: 支持默认模型和备用模型配置（通过 Admin 后台）

### 📋 开发前检查清单

- [x] 确认所有 API 路径使用 `/api/v1/...` 前缀 ✅
- [x] 确认所有路径参数使用 `chartId` 而不是 `id` ✅
- [x] 确认登录支持手机号（CN）和邮箱（HK） ✅
- [x] 确认错误响应格式包含 `success` 字段 ✅
- [x] 确认模型配置仅支持三个模型（DeepSeek、ChatGPT、Qwen） ✅
- [x] 确认遵循安全规范（前端不引入 `core/engine`） ✅

**状态**: ✅ 所有检查项已确认，等待最终开发指令

### 📚 参考文档

- **API 接口规范**: `app.doc/API接口统一规范.md`（新创建）
- **安全规范**: `app.doc/security/` 目录
- **功能设计**: `app.doc/features/` 目录
- **Admin 后台**: `admin.doc/Admin后台最小需求功能文档.md`

---

**文档版本**: v1.1  
**最后更新**: 2024年11月  
**更新内容**:
- v1.0: 初始分析版本
- v1.1: 确认所有决策，更新为最终版本
  - 确认命名统一方案（`core`、`/api/v1/...`、`chartId`）
  - 确认登录方式（手机号+邮箱）
  - 确认错误响应格式（包含 `success` 字段）
  - 确认模型路由（仅三个模型：DeepSeek、ChatGPT、Qwen）
  - 创建 `API接口统一规范.md` 文档
**维护者**: 开发团队

