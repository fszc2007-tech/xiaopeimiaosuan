# 底部导航设计文档

## 页面概述

### 组件名称
底部导航 / Bottom Tab Bar / XiaoPeiTabBar

### 组件定位
- **组件类型**: 导航组件
- **使用场景**: 应用主界面底部导航
- **层级**: 全局导航组件
- **访问条件**: 用户在主界面时始终显示（聊天页除外）

### 整体目标
- 底部固定导航：**「排盤 / 檔案 / 小佩 / 我的」四個 Tab**
- 中間「小佩」Tab 為**略大、帶動效的懸浮按鈕**，點擊進入小佩主页
- **小佩主页显示底部導航**，從主页可跳转到聊天頁
- **聊天頁全屏，不顯示底部導航**，只保留左上角返回
- 風格偏專業工具，**簡潔、穩重，不花哨**

---

## 功能需求

### 2.1 核心功能

#### 2.1.1 底部 Tab 导航
- 四个主要 Tab：排盤、檔案、小佩、我的
- 「排盤」Tab：点击跳转到手動排盤頁面（`ManualBaziScreen`）
- 「檔案」「小佩」「我的」Tab：在 MainTabs 内切换
- 当前 Tab 高亮显示

#### 2.1.2 小佩 Tab（懸浮按鈕样式）
- 中间位置，悬浮按钮样式
- 点击进入小佩主页（`XiaoPeiHomeScreen`）
- 进场动画和点击动画
- 从小佩主页可跳转到聊天页

#### 2.1.3 路由管理
- 聊天页和手動排盤頁全屏显示，不显示底部导航
- MainTabs 内的页面（檔案、小佩、我的）显示底部导航
- 当在手動排盤頁时，「排盤」Tab 显示为激活状态（通过父导航器状态判断）

---

## 信息架构与路由

### 3.1 路由结构

使用一个 Root Stack：

```
RootStack
├── MainTabs（包含底部導航：排盤 / 檔案 / 小佩 / 我的）
│   ├── CasesScreen（檔案頁）
│   ├── XiaoPeiHomeScreen（小佩主页）
│   └── MeScreen（我的頁）
├── ManualBaziScreen（手動排盤頁，點擊「排盤」Tab 跳轉）
└── ChatScreen（小佩聊天頁，全屏，從小佩主页跳轉）
```

**逻辑**:
- 用户平时在 `MainTabs` 里切换「檔案」「小佩」「我的」三个主頁
- 点击底部「排盤」Tab → `navigation.navigate('ManualBazi')`（跳转到手動排盤頁面）
- 点底部中间「小佩」Tab → `navigation.navigate('XiaoPeiHome')`（跳转到小佩主页）
- 从小佩主页选择话题/问题后 → `navigation.navigate('Chat')`（跳转到聊天页）
- `ChatScreen` 和 `ManualBaziScreen` 里**不顯示底欄**，只顯示一個返回按鈕
- `XiaoPeiHomeScreen` 显示底部导航

---

## 设计规范

### 4.1 底部导航设计规范

#### 4.1.1 高度与背景

**容器样式**:
- 底欄容器高度 = `56dp + safeArea.bottom`
- 背景色: `colors.bg`（#FFFFFF）
- 頂部邊線:
  - `borderTopWidth: StyleSheet.hairlineWidth`
  - `borderTopColor: colors.border`（#E5E7EB）

**安全区域处理**:
```typescript
const insets = useSafeAreaInsets();
const bottomInset = Math.max(insets.bottom, 8);
```

#### 4.1.2 3 個 Tab（排盤 / 檔案 / 我的）

**每个 Tab 规范**:
- 可點擊高度: `56dp`
- Icon 大小: `24 x 24dp`（暂时可用 placeholder 圆形）
- Icon 與文字之間: `spacing.xs`（2–4dp）
- 字體:
  - 字號: `fontSizes.xs`（11–12sp）
  - 未選中顏色: `colors.textSecondary`（#6b7280）
  - 選中顏色: `colors.ink`（#32343a）

**当前 Tab 高亮效果**:
- 文字顏色: `colors.ink`（主文字色）
- Icon 仍然是線框，但可略微加深顏色（可選）
- 在 Tab 頂部加一條小高亮條:
  - 宽度: `16dp`
  - 高度: `2dp`
  - 圆角: `radius.sm`（1dp）
  - 背景色: `colors.brandGreen`（粉綠主色 #83cbac）
  - 位置: `position: 'absolute'`，`top: 4dp`

> 注意：**Tab 不用膠囊背景**，避免和中間大按鈕搶視覺重心。

---

### 4.2 中間「小佩」懸浮按鈕（FAB）

#### 4.2.1 視覺規範

**样式**:
- 形狀: 圓形
- 尺寸: **直徑 56dp**（略大於 Tab icon）
- 背景色: `colors.brandGreen`（粉綠 #83cbac）
- 文字: 「小佩」
  - 字號: `fontSizes.sm`（14sp）
  - 顏色: 白色（#FFFFFF）
  - 字重: `fontWeights.semibold`（600，Medium / Semi-bold）

**位置**:
- `position: 'absolute'`
- `alignSelf: 'center'`
- `bottom: safeArea.bottom + 30dp`（大致讓按鈕下沿壓在底欄上方一點）

**陰影**:
- iOS:
  - `shadowColor: '#000'`
  - `shadowOpacity: 0.18`
  - `shadowRadius: 8`
  - `shadowOffset: { width: 0, height: 4 }`
- Android:
  - `elevation: 6`

---

### 4.3 小佩懸浮按鈕動效設計

#### 4.3.1 進場動畫（TabBar 初次顯示時）

**触发条件**: `XiaoPeiTabBar` 掛載時

**動畫屬性**:
- `scale: 0.9 → 1.0`
- `opacity: 0 → 1`

**動畫參數**:
- 時長: `220ms`
- 緩動: `Easing.out(Easing.quad)`

#### 4.3.2 點擊手感動畫

**按下動畫** (`onPressIn`):
- `scale: 1.0 → 0.94`
- 時長: `約 90ms`

**釋放動畫** (`onPressOut`):
- `scale: 0.94 → 1.0`
- 時長: `約 140ms`
- 緩動: `Easing.out(Easing.back(2))`（輕微回彈）

#### 4.3.3 觸覺反饋

**觸覺反饋時機**: 用戶按下小佩按鈕時

**反饋類型**: `react-native-haptic-feedback` 的 `impactLight`

**交互流程**:
1. 用戶按下小佩按鈕
2. 按鈕微縮放（`scale: 1.0 → 0.94`）
3. 觸發輕微觸覺反饋（`impactLight`）
4. 按鈕回彈（`scale: 0.94 → 1.0`）
5. 進入聊天頁

> 注意：不做呼吸燈 / 常駐閃爍。只在**進場**和**按下時**有動效，保持專業、克制。

---

## 技术实现

### 5.1 组件结构

#### 5.1.1 自定義 TabBar：`XiaoPeiTabBar.tsx`

**文件位置**: `src/components/layout/XiaoPeiTabBar.tsx`

**Props 接口**:
```typescript
type TabKey = 'bazi' | 'cases' | 'xiaopei' | 'me';

interface XiaoPeiTabBarProps {
  activeTab: TabKey;
  onTabPress: (key: TabKey) => void;
  onXiaoPeiPress: () => void; // 點「小佩」跳轉到小佩主页
}
```

**主要功能**:
- 渲染四个 Tab 按钮（排盤、檔案、小佩、我的）
- 渲染中间小佩悬浮按钮（样式特殊）
- 处理进场动画
- 处理点击动画和触觉反馈
- 处理安全区域

#### 5.1.2 Tab 子组件：`TabItem`

**Props 接口**:
```typescript
interface TabItemProps {
  label: string;
  isActive: boolean;
  onPress: () => void;
}
```

**功能**:
- 显示 Tab 图标（暂时用 placeholder）
- 显示 Tab 标签
- 显示选中状态高亮条

---

### 5.2 实现代码示例

#### 5.2.1 XiaoPeiTabBar 组件

```typescript
// src/components/layout/XiaoPeiTabBar.tsx
import React, { useEffect, useRef } from 'react';
import {
  View,
  Text,
  TouchableOpacity,
  StyleSheet,
  Platform,
  Animated,
  Easing,
} from 'react-native';
import { useSafeAreaInsets } from 'react-native-safe-area-context';
import ReactNativeHapticFeedback from 'react-native-haptic-feedback';
import { colors, fontSizes, fontWeights, spacing, radius } from '@/theme';

type TabKey = 'bazi' | 'cases' | 'xiaopei' | 'me';

interface XiaoPeiTabBarProps {
  activeTab: TabKey;
  onTabPress: (key: TabKey) => void;
  onXiaoPeiPress: () => void; // 点击小佩按钮跳转到小佩主页
}

export const XiaoPeiTabBar: React.FC<XiaoPeiTabBarProps> = ({
  activeTab,
  onTabPress,
  onXiaoPeiPress,
}) => {
  const insets = useSafeAreaInsets();
  const bottomInset = Math.max(insets.bottom, 8);

  // 小佩按鈕動畫
  const scale = useRef(new Animated.Value(0.9)).current;
  const opacity = useRef(new Animated.Value(0)).current;

  // 進場動畫
  useEffect(() => {
    Animated.parallel([
      Animated.timing(scale, {
        toValue: 1,
        duration: 220,
        easing: Easing.out(Easing.quad),
        useNativeDriver: true,
      }),
      Animated.timing(opacity, {
        toValue: 1,
        duration: 220,
        easing: Easing.out(Easing.quad),
        useNativeDriver: true,
      }),
    ]).start();
  }, [scale, opacity]);

  // 按下動畫
  const handleXiaoPeiPressIn = () => {
    Animated.timing(scale, {
      toValue: 0.94,
      duration: 90,
      easing: Easing.out(Easing.quad),
      useNativeDriver: true,
    }).start();

    // 觸覺反饋
    ReactNativeHapticFeedback.trigger('impactLight', {
      enableVibrateFallback: true,
      ignoreAndroidSystemSettings: false,
    });
  };

  // 釋放動畫
  const handleXiaoPeiPressOut = () => {
    Animated.timing(scale, {
      toValue: 1,
      duration: 140,
      easing: Easing.out(Easing.back(2)),
      useNativeDriver: true,
    }).start();
  };

  // 點擊處理
  const handleXiaoPeiPress = () => {
    // 先回彈，再導航
    handleXiaoPeiPressOut();
    onXiaoPeiPress();
  };

  return (
    <View style={[styles.container, { paddingBottom: bottomInset }]}>
      {/* 底部四個 Tab */}
      <View style={styles.tabRow}>
        <TabItem
          label="排盘"
          isActive={activeTab === 'bazi'}
          onPress={() => onTabPress('bazi')}
        />
        <TabItem
          label="档案"
          isActive={activeTab === 'cases'}
          onPress={() => onTabPress('cases')}
        />
        {/* 小佩 Tab：使用悬浮按钮样式 */}
        <View style={styles.xiaopeiTabPlaceholder} />
        <TabItem
          label="我的"
          isActive={activeTab === 'me'}
          onPress={() => onTabPress('me')}
        />
      </View>

      {/* 中間懸浮小佩按鈕 */}
      <Animated.View
        style={[
          styles.fabWrapper,
          {
            bottom: bottomInset + 30,
            transform: [{ scale }],
            opacity,
          },
        ]}
      >
        <TouchableOpacity
          activeOpacity={0.9}
          onPressIn={handleXiaoPeiPressIn}
          onPressOut={handleXiaoPeiPressOut}
          onPress={handleXiaoPeiPress}
          style={[
            styles.fab,
            activeTab === 'xiaopei' && styles.fabActive,
          ]}
        >
          <Text style={styles.fabText}>小佩</Text>
        </TouchableOpacity>
      </Animated.View>
    </View>
  );
};

// Tab 子组件
const TabItem: React.FC<{
  label: string;
  isActive: boolean;
  onPress: () => void;
}> = ({ label, isActive, onPress }) => {
  return (
    <TouchableOpacity
      style={styles.tabItem}
      activeOpacity={0.8}
      onPress={onPress}
    >
      {/* 當前頁上方高亮條 */}
      {isActive && <View style={styles.activeBar} />}

      {/* TODO: 之後替換為真實 icon */}
      <View style={styles.iconPlaceholder} />

      <Text style={[styles.tabLabel, isActive && styles.tabLabelActive]}>
        {label}
      </Text>
    </TouchableOpacity>
  );
};

const styles = StyleSheet.create({
  container: {
    borderTopWidth: StyleSheet.hairlineWidth,
    borderTopColor: colors.border,
    backgroundColor: colors.bg,
  },
  tabRow: {
    flexDirection: 'row',
    height: 56,
    position: 'relative',
  },
  tabItem: {
    flex: 1,
    alignItems: 'center',
    justifyContent: 'center',
  },
  xiaopeiTabPlaceholder: {
    flex: 1, // 占位，保持四个 Tab 的布局平衡
  },
  iconPlaceholder: {
    width: 24,
    height: 24,
    borderRadius: 12,
    borderWidth: 1,
    borderColor: colors.border,
    marginBottom: spacing.xs,
  },
  tabLabel: {
    fontSize: fontSizes.xs,
    color: colors.textSecondary,
  },
  tabLabelActive: {
    color: colors.ink,
  },
  activeBar: {
    position: 'absolute',
    top: 4,
    width: 16,
    height: 2,
    borderRadius: radius.sm,
    backgroundColor: colors.brandGreen,
  },
  fabWrapper: {
    position: 'absolute',
    alignSelf: 'center',
  },
  fab: {
    width: 56,
    height: 56,
    borderRadius: 28,
    justifyContent: 'center',
    alignItems: 'center',
    backgroundColor: colors.brandGreen,
    ...Platform.select({
      ios: {
        shadowColor: '#000',
        shadowOpacity: 0.18,
        shadowRadius: 8,
        shadowOffset: { width: 0, height: 4 },
      },
      android: {
        elevation: 6,
      },
    }),
  },
  fabActive: {
    // 激活状态可以添加额外的视觉反馈（可选）
    // 例如：稍微放大或改变阴影
  },
  fabText: {
    color: '#FFFFFF',
    fontSize: fontSizes.sm,
    fontWeight: fontWeights.semibold,
  },
});
```

#### 5.2.2 在導航裡使用

```typescript
// src/navigation/RootNavigator.tsx
import { createBottomTabNavigator } from '@react-navigation/bottom-tabs';
import { createNativeStackNavigator } from '@react-navigation/native-stack';
import { XiaoPeiTabBar } from '@/components/layout/XiaoPeiTabBar';
import { CasesScreen } from '@/screens/Cases/CasesScreen';
import { XiaoPeiHomeScreen } from '@/screens/XiaoPeiHome/XiaoPeiHomeScreen';
import { MeScreen } from '@/screens/Me/MeScreen';
import { ManualBaziScreen } from '@/screens/ManualBazi/ManualBaziScreen';
import { ChatScreen } from '@/screens/Chat/ChatScreen';

const Tab = createBottomTabNavigator();
const Stack = createNativeStackNavigator();

function MainTabs() {
  return (
    <Tab.Navigator
      screenOptions={{ headerShown: false }}
      tabBar={({ navigation, state }) => {
        const route = state.routes[state.index];
        // 判断当前激活的 Tab
        // 如果当前在 ManualBazi 页面，需要通过父导航器的状态来判断
        const parentState = navigation.getParent()?.getState();
        const isManualBazi = parentState?.routes[parentState.index]?.name === 'ManualBazi';
        
        const activeTab = isManualBazi
          ? 'bazi'
          : (route.name === 'Cases'
            ? 'cases'
            : route.name === 'XiaoPeiHome'
            ? 'xiaopei'
            : 'me') as 'bazi' | 'cases' | 'xiaopei' | 'me';

        return (
          <XiaoPeiTabBar
            activeTab={activeTab}
            onTabPress={key => {
              if (key === 'bazi') {
                // 跳转到手動排盤頁面
                navigation.getParent()?.navigate('ManualBazi');
              } else if (key === 'cases') {
                navigation.navigate('Cases');
              } else if (key === 'xiaopei') {
                navigation.navigate('XiaoPeiHome');
              } else if (key === 'me') {
                navigation.navigate('Me');
              }
            }}
            onXiaoPeiPress={() => {
              // 跳轉到小佩主页
              navigation.navigate('XiaoPeiHome');
            }}
          />
        );
      }}
    >
      <Tab.Screen name="Cases" component={CasesScreen} />
      <Tab.Screen name="XiaoPeiHome" component={XiaoPeiHomeScreen} />
      <Tab.Screen name="Me" component={MeScreen} />
    </Tab.Navigator>
  );
}

export function RootNavigator() {
  return (
    <Stack.Navigator>
      <Stack.Screen
        name="MainTabs"
        component={MainTabs}
        options={{ headerShown: false }}
      />
      <Stack.Screen
        name="ManualBazi"
        component={ManualBaziScreen}
        options={{ 
          title: '手動排盤',
          headerShown: true, // 顯示返回按鈕
        }}
      />
      <Stack.Screen
        name="Chat"
        component={ChatScreen}
        options={{ 
          title: '小佩',
          headerShown: true, // 顯示返回按鈕
        }}
      />
    </Stack.Navigator>
  );
}
```

---

### 5.3 依赖包

#### 5.3.1 必需依赖
- `@react-navigation/bottom-tabs`: 底部导航
- `@react-navigation/native-stack`: 堆栈导航
- `react-native-safe-area-context`: 安全区域处理
- `react-native-haptic-feedback`: 触觉反馈

#### 5.3.2 安装命令
```bash
npm install @react-navigation/bottom-tabs @react-navigation/native-stack
npm install react-native-safe-area-context
npm install react-native-haptic-feedback
```

---

## 交互流程

### 6.1 用户操作流程（更新版）

#### 6.1.1 进入 App / 主界面

1. **默认选中「小佩」Tab**
   - 中间区域显示「小佩主页」内容（话题推荐、常用问法等）
   - 显示底部导航栏
   - 小佩悬浮按钮执行进场动画（仅在冷启动或重新打开 App 时播放）

---

#### 6.1.2 在主界面切换 Tab（MainTabs 内）

1. **点击「小佩」Tab**
   - 回到小佩主页内容
   - 底部导航栏保持显示
   - 按下按钮 → 按钮缩放 + 触觉反馈
   - 释放按钮 → 按钮回弹

2. **点击「檔案」Tab**
   - 主区域切换为命盘档案列表页
   - 底部导航栏保持显示

3. **点击「我的」Tab**
   - 主区域切换为个人中心页
   - 底部导航栏保持显示

4. **Tab 切换时的视觉反馈**
   - 当前 Tab 顶部显示高亮条
   - 「小佩」Tab 使用悬浮按钮样式，高亮状态通过按钮样式体现激活

---

#### 6.1.3 从底部导航进入全屏功能页

1. **点击底部导航中的「排盤」Tab**
   - 以 push 方式跳转到【手動排盤頁面】
   - 手動排盤頁面为全屏页，不显示底部导航

2. **在小佩主页中选择话题 / 问题**
   - push 进入【聊天页】
   - 聊天页为全屏页，不显示底部导航

3. **（可选）从「檔案」进入命盘详情**
   - 点击档案列表某条记录 → push 进入【命盘详情页】
   - 命盘详情为全屏页，不显示底部导航

---

#### 6.1.4 从全屏页返回主界面

1. **全屏页左上角固定显示返回按钮**

2. **用户点击返回**
   - 关闭当前全屏页
   - 回到离开前所在的 Tab 页面（例如从小佩主页进聊天页，返回后回到小佩主页）
   - 底部导航栏重新显示，并保持原 Tab 为选中状态

### 6.2 动画流程

#### 6.2.1 进场动画
```
组件挂载
  ↓
scale: 0.9 → 1.0 (220ms)
opacity: 0 → 1 (220ms)
  ↓
动画完成
```

#### 6.2.2 点击动画
```
用户按下
  ↓
scale: 1.0 → 0.94 (90ms)
触发触觉反馈 (impactLight)
  ↓
用户释放
  ↓
scale: 0.94 → 1.0 (140ms, 轻微回弹)
  ↓
跳转页面
```

---

## 设计规范

### 7.1 视觉设计

- **遵循 UI_SPEC.md 中的设计规范**
- 使用 Design Tokens（colors, typography, layout）
- 整体背景为纯白色
- 顶部边框使用分割线颜色
- 保持简洁、稳重的专业工具风格

### 7.2 交互设计

- Tab 切换有明确的视觉反馈
- 小佩按钮有进场和点击动画
- 触觉反馈增强交互体验
- 动画流畅，不花哨

### 7.3 响应式设计

- 适配不同屏幕尺寸
- 正确处理安全区域（刘海屏、底部手势区）
- 小佩按钮位置自适应

---

## 文件结构

### 8.1 组件文件

```
src/
├── components/
│   └── layout/
│       └── XiaoPeiTabBar.tsx          # 底部导航组件
└── navigation/
    └── RootNavigator.tsx              # 根导航器
```

### 8.2 相关页面

```
src/
├── screens/
│   ├── Cases/
│   │   └── CasesScreen.tsx           # 檔案頁
│   ├── XiaoPeiHome/
│   │   └── XiaoPeiHomeScreen.tsx     # 小佩主页
│   ├── Me/
│   │   └── MeScreen.tsx              # 我的頁
│   ├── ManualBazi/
│   │   └── ManualBaziScreen.tsx      # 手動排盤頁（全屏）
│   └── Chat/
│       └── ChatScreen.tsx            # 聊天頁（全屏）
```

---

## 待确认事项

- [x] 底部导航布局和样式（已确认）
- [x] 小佩悬浮按钮设计（已确认）
- [x] 动画效果设计（已确认）
- [x] 触觉反馈设计（已确认）
- [x] 小佩 Tab 跳转到小佩主页（已确认）
- [ ] Tab 图标设计（当前使用 placeholder）
- [ ] 聊天页返回按钮样式
- [ ] 是否需要 Tab 切换动画
- [ ] 是否需要未读消息角标（档案/我的 Tab）
- [ ] 小佩 Tab 激活状态的视觉反馈（当前使用悬浮按钮样式）

---

## 更新记录

- **创建日期**: 2024年11月
- **文档版本**: v1.1.0
- **最后更新**: 2024年11月
- **更新内容**: 
  - v1.0.0: 初始版本，包含完整的底部导航设计、小佩悬浮按钮和动画设计、触觉反馈设计
  - v1.1.0: 更新小佩按钮行为，从直接跳转聊天页改为跳转小佩主页；更新路由结构，将小佩主页加入 MainTabs；更新 Tab 数量为四个（排盤、檔案、小佩、我的）
- **维护者**: 开发团队

