# 出生信息輸入 - 聊天页面设计文档

## 页面概述

### 页面名称
和小佩聊天 · 填写出生信息 / Chat - Birth Info Input

### 页面定位
- **页面类型**: 信息收集/聊天页面
- **用户类型**: 新用户（首次填写出生信息）
- **页面层级**: 从首页「方式一」进入
- **访问条件**: 用户点击首页「進入聊天填寫」按钮

### 页面目的
用自然語言收集用户的出生信息（出生年月日、時間、性別、曆法），支持可選補充出生城市。用戶可以一句說完，也可以分幾句慢慢說；系統自動解析並二次確認。

---

## 功能需求

### 2.1 核心功能

#### 2.1.1 自然语言输入
- 支持用户用自然语言描述出生信息
- 支持一次性说完或分多次输入
- 自动识别和提取关键信息

#### 2.1.2 信息解析与确认
- 后端/LLM 解析用户输入
- 返回结构化数据
- 以卡片形式展示解析结果
- 支持用户修改和补充

#### 2.1.3 字段验证
- 验证必填字段完整性
- 提示缺失字段
- 提供填写示例

#### 2.1.4 信息提交
- 所有必填字段齐全后显示提交按钮
- 提交后开始排盘流程

---

## 页面设计

### 3.1 整体布局

页面采用聊天界面布局，从上到下依次包含：

1. 顶部栏（固定）
2. 说明区（灰色卡片）
3. 小佩提示区（聊天气泡样式卡片）
4. 用户输入区（聊天列表 + 解析回执，可滚动）
5. 底部输入框（固定）

整体背景为纯白色，聊天区域支持垂直滚动。

---

### 3.2 详细模块设计

#### 3.2.1 顶部栏

**位置**: 页面最顶部（固定）

**样式**:
- 背景: `colors.bg`（白色）
- 高度: 约 56px
- 底部边框: `colors.border`（1px 细线）

**内容**:
- **返回按钮**（左侧）
  - 图标: 左箭头
  - 点击行为: 返回上一页
  - 尺寸: 44x44px（最小可点击区域）

- **标题**（居中）
  - 文案: 「和小佩聊天 · 填寫出生信息」
  - 字体大小: `fontSizes.lg`
  - 字体粗细: `fontWeights.semibold`
  - 文字颜色: `colors.ink`

- **副标题**（标题下方）
  - 文案: 「用自然語言告訴我，我會自動提取並排盤。」
  - 字体大小: `fontSizes.sm`
  - 字体粗细: `fontWeights.regular`
  - 文字颜色: `colors.textSecondary`

**布局**:
- 返回按钮左侧留白: `spacing.md`
- 标题和副标题垂直居中
- 副标题与标题间距: `spacing.xs`

---

#### 3.2.2 说明区（灰色卡片）

**位置**: 顶部栏下方

**样式**:
- 背景: `colors.disabledBg`（#f3f4f6，浅灰色）
- 圆角: `radius.lg`
- 内边距: `spacing.lg`
- 上下间距: `spacing.md`
- 左右内边距: `spacing.lg`

**内容**:

1. **标题**: 「第一步 · 先把你的出生信息告訴我」
   - 字体大小: `fontSizes.base`
   - 字体粗细: `fontWeights.medium`
   - 文字颜色: `colors.ink`
   - 底部间距: `spacing.sm`

2. **说明文案**（两行）:
   - **第一行**: 「可以一次說完，也可以分幾條慢慢說。」
   - **第二行**: 「**出生年月日、時間、性別、曆法（公曆/農曆）都是必填**；想更完整可以加上 **出生城市（可選）**。」
   - 字体大小: `fontSizes.sm`
   - 字体粗细: `fontWeights.regular`
   - 文字颜色: `colors.textSecondary`
   - 行高: `lineHeights.normal`

**重点字段标记**:
- 以下字段在文案中用品牌色（`colors.brandBlue`）标记：
  - 「出生年月日」
  - 「時間」
  - 「性別」
  - 「曆法（公曆/農曆）」
  - 「出生城市」

**布局**:
- 卡片上下间距: `spacing.md`
- 文案行间距: `spacing.xs`

---

#### 3.2.3 小佩提示区（聊天气泡样式卡片）

**位置**: 说明区下方

**样式**:
- 背景: `colors.brandBlue`（品牌主色）
- 圆角: `radius.lg`（右侧圆角较大，左侧小角）
- 内边距: `spacing.md`
- 上下间距: `spacing.md`
- 左右内边距: `spacing.lg`
- 靠左对齐

**内容**:

1. **发送者标识**:
   - 文案: 「小佩」
   - 字体大小: `fontSizes.xs`
   - 字体粗细: `fontWeights.medium`
   - 文字颜色: 白色（带透明度 0.8）
   - 底部间距: `spacing.xs`

2. **提示文案**:
   - 文案: 「嗨，我們先來記錄你的出生信息吧～你可以這樣說：」
   - 字体大小: `fontSizes.base`
   - 字体粗细: `fontWeights.regular`
   - 文字颜色: 白色
   - 行高: `lineHeights.normal`
   - 底部间距: `spacing.sm`

3. **示例 Tag 区域**:
   - 包含 2 个圆角 Tag（**可点击**）
   - Tag 样式:
     - 背景: 白色（带透明度 0.2 或使用 `colors.blueSoftBg`）
     - 文字颜色: 白色
     - 圆角: `radius.pill`
     - 内边距: 左右 `spacing.md`，上下 `spacing.xs`
     - 字体大小: `fontSizes.sm`
     - Tag 之间间距: `spacing.sm`
     - 垂直排列
   
   - **Tag 1**（公曆示例）:
     - 文案: 「我是女生，公曆 1998 年 1 月 1 日中午 12 點，在廣州出生。」
     - 点击行为: 将文本填入输入框（不自动发送）
   
   - **Tag 2**（農曆示例）:
     - 文案: 「我是男生，農曆 1995 年正月初一早上 8 點，在北京出生。」
     - 点击行为: 将文本填入输入框（不自动发送）

**布局**:
- 气泡左侧留白: `spacing.lg`
- 气泡右侧留白: `spacing.xl`（留出空间）
- Tag 区域顶部间距: `spacing.sm`

---

#### 3.2.4 用户输入区（聊天列表 + 解析回执）

**位置**: 小佩提示区下方，底部输入框上方（可滚动区域）

**样式**:
- 背景: `colors.bg`（白色）
- 使用 `ScrollView` 或 `FlatList` 实现滚动
- 内容区域左右内边距: `spacing.lg`

**内容结构**:

##### 3.2.4.1 用户消息气泡

**样式**:
- 背景: `colors.brandBlue`（品牌主色）
- 圆角: `radius.lg`（右侧圆角较大，左侧小角）
- 内边距: `spacing.md`
- 靠右对齐
- 最大宽度: 屏幕宽度的 75%

**内容**:
- 用户输入的自然语言文本
- 字体大小: `fontSizes.base`
- 字体粗细: `fontWeights.regular`
- 文字颜色: 白色
- 行高: `lineHeights.normal`

**布局**:
- 气泡右侧留白: `spacing.lg`
- 气泡左侧留白: `spacing.xl`
- 消息之间间距: `spacing.md`

##### 3.2.4.2 小佩解析回执卡片

**样式**:
- 背景: `colors.cardBg`（白色）
- 圆角: `radius.lg`
- 边框: `colors.border`（细线）
- 阴影: `shadows.card`
- 内边距: `spacing.lg`
- 靠左对齐
- 最大宽度: 屏幕宽度的 85%

**内容结构**:

1. **小佩文案**:
   - 文案: 「我幫你整理了一下剛才的信息：」
   - 字体大小: `fontSizes.base`
   - 字体粗细: `fontWeights.regular`
   - 文字颜色: `colors.ink`
   - 底部间距: `spacing.md`

2. **字段列表**（条列显示）:
   - 每个字段一行，格式: `字段名：值`
   - 字体大小: `fontSizes.base`
   - 字体粗细: `fontWeights.regular`
   - 行高: `lineHeights.normal`
   - 字段之间间距: `spacing.sm`
   
   **字段显示规则**:
   - **有值**: 正常显示，字段名用 `colors.ink`，值用 `colors.brandBlue` 标记
   - **缺失**: 显示「暫未填寫」，用 `colors.error`（红色）或 `colors.brandOrange`（高亮）标记
   
   **字段列表**:
   - 出生日期：`YYYY-MM-DD` 或 「暫未填寫」
   - 出生時間：`HH:mm（时间段描述）` 或 「暫未填寫」
   - 性別：`男生/女生` 或 「暫未填寫」
   - 曆法：`公曆/農曆` 或 「暫未填寫」
   - 出生城市：`城市名` 或 「暫未填寫（可選）」

3. **提示文案**:
   - 文案: 「如果有任何不對，你可以直接用自然語言改，比如：『不是中午，是晚上 8 點』，或『其實是農曆』。」
   - 字体大小: `fontSizes.sm`
   - 字体粗细: `fontWeights.regular`
   - 文字颜色: `colors.textSecondary`
   - 行高: `lineHeights.normal`
   - 顶部间距: `spacing.md`
   - 底部间距: `spacing.md`（如果有按钮）或 `spacing.lg`（如果没有按钮）

4. **主按钮**（条件显示）:
   - **显示条件**: 所有必填字段都有值
   - **文案**: 「信息沒問題，開始排盤」
   - 按钮类型: `PrimaryButton`
   - 背景: `colors.brandBlue`
   - 文字颜色: 白色
   - 圆角: `radius.lg`
   - 高度: 48px
   - 宽度: 100%（填满卡片宽度）
   - 顶部间距: `spacing.md`
   - 点击行为: `onPress => handleConfirmAndStartBazi()`

5. **缺失字段提示**（条件显示）:
   - **显示条件**: 缺少任意必填字段
   - **文案示例**: 「我還差一點信息就能幫你排盤了：目前缺少 **性別** 和 **曆法（公曆/農曆）**。你可以直接告訴我：『我是女生』 或 『是農曆』。」
   - 字体大小: `fontSizes.sm`
   - 字体粗细: `fontWeights.regular`
   - 文字颜色: `colors.textSecondary`
   - 行高: `lineHeights.normal`
   - 顶部间距: `spacing.md`
   - 缺失字段名称用 `colors.brandOrange` 或 `colors.error` 标记

**布局**:
- 卡片左侧留白: `spacing.lg`
- 卡片右侧留白: `spacing.xl`
- 卡片之间间距: `spacing.md`

---

#### 3.2.5 底部输入框

**位置**: 页面最底部（固定）

**样式**:
- 背景: `colors.bg`（白色）
- 顶部边框: `colors.border`（1px 细线）
- 内边距: 上下 `spacing.md`，左右 `spacing.lg`
- 使用 `SafeAreaView` 处理底部安全区域

**内容**:

1. **输入框**:
   - 背景: `colors.cardBg`（白色）
   - 边框: `colors.border`，圆角 `radius.md`
   - 聚焦时边框色: `colors.brandBlue`
   - 内边距: 左右 `spacing.md`，上下 `spacing.sm`
   - 高度: 约 44px
   - 占位文案: 「例如：我是女生，公曆 1998 年 1 月 1 日中午 12 點，在廣州出生。」
   - 占位文字颜色: `colors.textSecondary`
   - 输入文字颜色: `colors.ink`
   - 字体大小: `fontSizes.base`
   - 支持多行输入（可选）

2. **发送按钮**:
   - 位置: 输入框右侧
   - 文案: 「發送」
   - 文字颜色: `colors.brandBlue`
   - 字体大小: `fontSizes.base`
   - 字体粗细: `fontWeights.medium`
   - 点击行为: 发送消息并触发解析
   - 禁用状态: 输入框为空时禁用，文字颜色变为 `colors.disabledText`

**布局**:
- 输入框和发送按钮水平排列
- 输入框占据剩余空间
- 发送按钮固定宽度: 约 60px
- 输入框和按钮之间间距: `spacing.sm`

---

### 3.3 整体风格要求

#### 3.3.1 背景与布局
- **整体背景**: 纯白色（`colors.bg`）
- **聊天区域**: 使用 `ScrollView` 或 `FlatList`，支持垂直滚动
- **安全区域**: 使用 `SafeAreaView` 包裹，避免底部遮挡
- **页面内边距**: 左右 `spacing.lg`

#### 3.3.2 卡片样式
- **说明区卡片**: 浅灰色背景（`colors.disabledBg`）
- **解析回执卡片**: 白色背景（`colors.cardBg`），圆角、边框、阴影
- **圆角**: `radius.lg`（12px）
- **边框**: `colors.border`（细线，1px）
- **阴影**: `shadows.card`（轻微阴影）

#### 3.3.3 气泡样式
- **小佩提示气泡**（初始提示区）: `colors.brandBlue` 背景，白色文字，靠左对齐
- **小佩消息气泡**（解析回执）: 白色背景（`colors.cardBg`），边框（`colors.border`），`colors.ink` 文字，靠左对齐
- **用户消息气泡**: `colors.brandBlue` 背景，白色文字，靠右对齐
- **圆角**: 左侧气泡右侧圆角大，左侧小角；右侧气泡左侧圆角大，右侧小角

#### 3.3.4 文字颜色
- **主文字**: `colors.ink`（#32343a）
- **次要文字**: `colors.textSecondary`（#6b7280）
- **重点字段标记**: `colors.brandBlue`（#648e93）
- **缺失字段标记**: `colors.error`（#f97373）或 `colors.brandOrange`（#f9723d）

#### 3.3.5 按钮样式
- **主按钮**（开始排盘）:
  - 背景: `colors.brandBlue`（#648e93）
  - 文字: 白色
  - 按下状态: `colors.brandBluePressed`（#50747a）

#### 3.3.6 Tag 样式
- **示例 Tag**（小佩气泡内）:
  - 背景: 白色（带透明度）或 `colors.blueSoftBg`
  - 文字: 白色
  - 圆角: `radius.pill`（9999px）
  - 内边距: 左右 `spacing.md`，上下 `spacing.xs`
  - 字体大小: `fontSizes.sm`
  - **可点击**: 点击后将文本填入输入框

---

## 数据需求

### 4.1 解析字段要求（给后端/LLM）

#### 4.1.1 必填字段（六项）

1. **`birth_year`**: 数字（YYYY）
   - 示例: `1998`

2. **`birth_month`**: 数字（1-12）
   - 示例: `1`

3. **`birth_day`**: 数字（1-31）
   - 示例: `1`

4. **`birth_time`**: HH:mm（允许模糊时间，但仍要映射到一个小时段）
   - 示例: `12:00`（中午）、`08:00`（早上）、`23:00`（晚上）

5. **`gender`**: `male` / `female`
   - 示例: `female`（女生）、`male`（男生）

6. **`calendar_type`**: `solar`（公曆） / `lunar`（農曆）
   - 示例: `solar`（公曆）、`lunar`（農曆）

#### 4.1.2 可选字段

1. **`birth_city`**: 城市名称（字符串）
   - 示例: `"廣州"`、`"北京"`

2. **`city_id`**: 如可匹配城市库则带上
   - 示例: `"440100"`（广州的城市ID）

3. **`time_accuracy`**: `exact` | `rough`（大致早上/晚上）
   - 示例: `exact`（精确时间）、`rough`（大致时间）

4. **`raw_text`**: 用户原始输入（方便日后 debug）
   - 示例: `"我是女生，公曆 1998 年 1 月 1 日中午 12 點，在廣州出生。"`

#### 4.1.3 数据逻辑

**字段更新规则**:
- 多轮输入时，字段以「覆盖合并」方式更新
- 新轮中提到的字段覆盖旧值
- 没提到的字段沿用已知值

**返回数据结构**:
```typescript
interface ParseResult {
  // 当前已知字段
  fields: {
    birth_year?: number;
    birth_month?: number;
    birth_day?: number;
    birth_time?: string; // HH:mm
    gender?: 'male' | 'female';
    calendar_type?: 'solar' | 'lunar';
    birth_city?: string;
    city_id?: string;
    time_accuracy?: 'exact' | 'rough';
    raw_text?: string;
  };
  // 缺失字段列表
  missing_fields: string[]; // 例如: ['gender', 'calendar_type']
  // 解析状态
  status: 'complete' | 'incomplete';
}
```

---

### 4.2 前端状态管理

#### 4.2.1 页面状态
- 用户输入的消息列表
- 当前解析结果（结构化数据）
- 缺失字段列表
- 输入框内容
- 加载状态（解析中）

#### 4.2.2 数据流转
1. 用户输入自然语言 → 发送到后端/LLM
2. 后端解析 → 返回结构化数据
3. 前端更新状态 → 显示解析结果卡片
4. 用户继续输入或修改 → 重复流程
5. 所有必填字段齐全 → 显示「开始排盘」按钮
6. 用户点击按钮 → 提交数据并跳转

---

## 交互流程

### 5.1 用户操作流程

1. **进入页面**
   - 从首页「方式一」点击「進入聊天填寫」进入
   - 显示说明区和小佩提示区

2. **查看提示**
   - 用户阅读说明区文案
   - 查看小佩提示区的示例 Tag
   - （可选）点击示例 Tag 填入输入框

3. **输入信息**
   - 用户在底部输入框输入自然语言
   - 点击「發送」按钮
   - 显示用户消息气泡

4. **查看解析结果**
   - 系统解析用户输入
   - 显示小佩解析回执卡片
   - 展示已识别字段和缺失字段

5. **补充或修改信息**
   - 如果信息不完整，根据提示补充
   - 如果信息有误，用自然语言修改
   - 重复步骤 3-4

6. **确认并排盘**
   - 所有必填字段齐全后，显示「信息沒問題，開始排盤」按钮
   - 用户点击按钮
   - 提交数据并开始排盘流程

### 5.2 交互细节

#### 5.2.1 示例 Tag 点击
- 点击 Tag 后，将 Tag 文案填入输入框
- **不自动发送**，用户可编辑后再发送
- 输入框获得焦点，光标定位在文本末尾

#### 5.2.2 消息发送
- 点击「發送」按钮发送消息
- 发送后清空输入框
- 显示加载状态（可选）
- 滚动到底部显示最新消息

#### 5.2.3 解析结果展示
- 每次解析后更新解析结果卡片
- 已填写的字段正常显示
- 缺失的字段用红色/橙色标记
- 自动滚动到最新解析结果

#### 5.2.4 按钮显示逻辑
- **显示「开始排盘」按钮**:
  - 条件: `birth_year`、`birth_month`、`birth_day`、`birth_time`、`gender`、`calendar_type` 六项都有值
  - 位置: 解析结果卡片底部
  
- **显示缺失字段提示**:
  - 条件: 缺少任意必填字段
  - 内容: 明确列出缺失字段，提供填写示例

### 5.3 异常处理

- **解析失败**: 显示错误提示，允许用户重新输入
- **网络错误**: 显示错误提示，允许重试
- **输入为空**: 发送按钮禁用，不允许发送
- **字段格式错误**: 在解析结果中标记，提示用户修改

---

## 显示与交互规则

### 6.1 字段完整性判断

#### 6.1.1 必填字段检查
当以下六项都有值时，视为信息完整：
- `birth_year`（出生年份）
- `birth_month`（出生月份）
- `birth_day`（出生日期）
- `birth_time`（出生时间）
- `gender`（性别）
- `calendar_type`（曆法）

#### 6.1.2 显示规则

**信息完整时**:
- ✅ 显示「信息沒問題，開始排盤」主按钮
- ✅ 所有字段正常显示（用品牌色标记字段名）
- ✅ 隐藏缺失字段提示

**信息不完整时**:
- ❌ 不显示「开始排盘」按钮
- ⚠️ 显示缺失字段提示
- ⚠️ 缺失字段用红色/橙色标记
- 💡 提供自然语言填写示例

### 6.2 缺失字段提示规则

#### 6.2.1 提示文案格式
「我還差一點信息就能幫你排盤了：目前缺少 **字段1** 和 **字段2**。你可以直接告訴我：『示例1』 或 『示例2』。」

#### 6.2.2 字段名称映射
- `birth_year` → 「出生年份」
- `birth_month` → 「出生月份」
- `birth_day` → 「出生日期」
- `birth_time` → 「出生時間」
- `gender` → 「性別」
- `calendar_type` → 「曆法（公曆/農曆）」

#### 6.2.3 填写示例
根据缺失字段提供相应的自然语言示例：
- 缺失性别: 「我是女生」/「我是男生」
- 缺失曆法: 「是公曆」/「是農曆」
- 缺失时间: 「時間大概晚上 9 點左右」/「中午 12 點」
- 缺失日期: 「1998 年 1 月 1 日」/「農曆正月初一」

---

## 技术实现（预留）

### 7.1 技术要点

- 聊天界面实现（消息列表、气泡样式）
- 自然语言解析接口调用
- 字段状态管理和更新逻辑
- 滚动控制和自动滚动
- 输入框焦点管理
- 按钮显示/隐藏逻辑

### 7.2 相关文件结构

```
src/
├── screens/
│   └── Chat/
│       ├── ChatScreen.tsx                # 主页面组件
│       ├── ChatScreen.styles.ts          # 页面样式
│       └── components/
│           ├── ChatMessage.tsx           # 消息气泡组件
│           ├── ParseResultCard.tsx       # 解析结果卡片组件
│           ├── ExampleTag.tsx            # 示例 Tag 组件
│           └── ChatInput.tsx             # 底部输入框组件
├── services/
│   └── api/
│       └── birthInfoParser.ts            # 出生信息解析 API
└── types/
    └── birthInfo.ts                      # 出生信息类型定义
```

### 7.3 API 接口设计（预留）

```typescript
// 解析出生信息接口
interface ParseBirthInfoRequest {
  text: string;                    // 用户输入的自然语言
  existing_fields?: Partial<BirthInfoFields>; // 已有字段（用于合并）
}

interface ParseBirthInfoResponse {
  fields: BirthInfoFields;         // 解析后的字段
  missing_fields: string[];        // 缺失字段列表
  status: 'complete' | 'incomplete';
  suggestions?: string[];          // 填写建议（可选）
}
```

---

## 设计规范

### 8.1 视觉设计

- **遵循 UI_SPEC.md 中的设计规范**
- 使用 Design Tokens（colors, typography, layout）
- 整体背景为纯白色
- 卡片使用圆角、边框、阴影区分层级
- 保持充足的留白

### 8.2 交互设计

- 消息发送有明确的视觉反馈
- 解析结果展示清晰
- 按钮点击有反馈动画
- 页面滚动流畅
- 输入框聚焦状态明显

### 8.3 响应式设计

- 适配不同屏幕尺寸
- 消息气泡最大宽度限制
- 内容在小屏设备上可正常滚动
- 保持按钮的最小可点击区域（44x44px）

---

## 待确认事项

- [x] 页面布局和模块设计（已确认）
- [x] 聊天界面样式（已确认）
- [x] 解析结果展示方式（已确认）
- [x] 字段验证逻辑（已确认）
- [ ] 后端/LLM 解析接口具体实现
- [ ] 城市库匹配逻辑
- [ ] 模糊时间处理规则（如「早上」「晚上」的具体时间映射）
- [ ] 是否需要支持语音输入-不支持
- [ ] 是否需要消息历史记录-排班的话不需要历史记录，排版结果存储到个人档案中
- [ ] 是否需要支持撤回消息-不需要

---

## 更新记录

- **创建日期**: 2024年11月
- **文档版本**: v1.0.0
- **维护者**: 开发团队

