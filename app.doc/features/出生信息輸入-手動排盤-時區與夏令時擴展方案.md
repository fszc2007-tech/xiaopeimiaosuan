# 出生信息輸入 - 時區與夏令時擴展方案

> **版本**: v1.0  
> **创建日期**: 2024年12月  
> **状态**: 实施方案  
> **关联文档**: `出生信息輸入-手動排盤.md`

---

## 一、背景与目标

### 1.1 背景

当前手动排盘页面的出生日期和时间选择存在以下问题：

1. **操作路径复杂**：用户需要分别点击「出生日期」和「出生时间」两个输入框，操作步骤多
2. **时区支持缺失**：当前仅支持通过「出生城市」间接计算时区，无法直接指定时区和夏令时
3. **历法切换体验分散**：历法选择在基础信息页，与日期时间选择器分离，体验不连贯

### 1.2 目标

**核心目标**：
- 简化用户操作路径，在一个弹窗内完成「历法选择 → 年月日时分选择 → 时区与夏令时设置」
- 保留滚轮式联动选择体验（参考图 2/图 3 的半屏弹窗设计）
- 支持时区和夏令时字段，为后续国际化扩展做准备

**产品策略**：
- **V1（本期）**：时区固定为东八区（UTC+8），UI 显示「东八区（北京时间）」，用户可开关夏令时
  * V1 端上行为：
    - `timezone_offset_minutes` 固定传 `480`
    - UI 只展示文本「东八区（北京时间）」，不弹出时区选择器
    - 仅提供一个夏令时开关，控制 `is_dst`（默认 `false`）
- **V2（后续）**：如需支持全球用户，再开放时区选择器（图 4 样式），后端沿用同一字段即可
  * V2 端上行为（未来）：
    - 在同一位置增加「选择时区」入口，点开时区列表
    - 列表选择结果写入 `timezone_offset_minutes`，与现有后端字段兼容

---

## 二、交互改动点

### 2.1 基础信息页改动

**当前设计**（`出生信息輸入-手動排盤.md` 3.2.2.3）：
- 两个独立输入框：「出生日期」「出生时间」
- 点击任一输入框弹出 Bottom Sheet

**新设计**：
- 保持两个输入框的展示形式不变
- **点击「出生日期」或「出生时间」任一输入框，都打开同一个「出生信息选择」底部弹窗**
- 历法选择 Chip 与弹窗内的历法 Tab **双向联动**：
  - 在基础信息页切换历法 → 打开弹窗时按此历法展示
  - 在弹窗内切换历法 → 关闭后基础信息页同步更新

### 2.2 出生信息选择弹窗（新增）

**触发方式**：
- 点击「出生日期」或「出生时间」输入框

**弹窗结构**（参考图 2/图 3，半屏设计）：

1. **标题栏**
   - 左：`返回`（或 `取消`）
   - 中：`选择出生信息`
   - 右：`确定` 按钮（高亮）

2. **历法切换 Tab**
   - 两个 Tab：`公曆` | `農曆`
   - 默认根据基础信息页当前选择决定
   - 高亮当前使用的历法
   - **四柱入口已移除**：
     * 出生信息选择弹窗仅保留「公历 / 农历」两个 Tab，原有「四柱」入口彻底移除
     * 四柱信息由后端排盘计算，不再由用户手工输入

3. **滚轮区域（核心）**
   - 五列滚轮：年、月、日、时、分
   - 当前选中行在中间高亮，其他行上下虚化
   - **联动逻辑**：
     - 切换年/月时，自动调整「日」的范围（考虑闰年、农历大月小月、闰月）
     - 如果当前日超过新月份最大日，自动回退到该月最大日
   - **农历闰月交互规范**：
     * 当 `calendar_type = 'lunar'` 且该年存在闰月时，月份滚轮需要同时展示对应闰月，例如：`正月、二月、闰二月、三月…`
     * 用户选择农历日期（含是否闰月）后，前端立即转换为公历时间，再按当前方案传给后端
     * 后端不需要额外的「闰月」字段，所有闰月信息在转换阶段处理完毕

4. **快速「今」按钮**
   - 位置：滚轮区域右上角
   - 点击后：
     - 将日期设为当前设备日期，时间设为当前时间
     - 历法与当前选中历法同步转换（公历 tab 用当前公历日期，农历 tab 用当前日期转农历）

5. **时区 & 夏令时区域（弹窗底部）**
   - **左侧**：时区显示
     - V1：固定显示 `东八区（北京时间）`
     - V2：可点击打开「选择时区」弹窗（图 4 样式）
   - **右侧**：夏令时开关
     - 文案：`夏令时`
     - Switch 组件，默认 **关闭**
     - 右侧小问号 `?` 图标，点击显示说明：「若出生地当时实行夏令时，请打开」

### 2.3 选择时区弹窗（V2 功能，本期预留）

**触发方式**：
- V1：不开放（UI 显示固定「东八区」）
- V2：点击时区显示区域打开

**弹窗结构**（参考图 4）：

1. **标题栏**
   - 左：`返回`
   - 中：`选择时区`
   - 右：`确定`

2. **时区列表**
   - 按 UTC 偏移排序
   - 格式：`UTC+8 东八区（北京 / 香港 / 新加坡）`
   - 当前选中项用对勾标记，浅色背景

3. **默认值**
   - 默认选中：`UTC+8 东八区（Asia/Shanghai）`

---

## 三、数据结构设计

### 3.1 前端 ViewModel

```typescript
export type CalendarType = 'solar' | 'lunar';

export interface BirthInputVM {
  calendarType: CalendarType;           // 公历 / 农历
  year: number;                          // 年份
  month: number;                         // 1-12
  day: number;                           // 1-31
  hour: number;                           // 0-23
  minute: number;                         // 0-59
  timezoneOffsetMinutes: number;          // 时区偏移（分钟），东八区 = 480
  timezoneLabel: string;                 // 时区标签，如 "东八区（北京时间）"
  isDst: boolean;                         // 夏令时开关
}
```

**默认值**：
```typescript
const DEFAULT_BIRTH_INPUT: BirthInputVM = {
  calendarType: 'solar',
  year: 1990,
  month: 1,
  day: 1,
  hour: 0,
  minute: 0,
  timezoneOffsetMinutes: 480,             // 东八区
  timezoneLabel: '东八区（北京时间）',
  isDst: false,
};
```

### 3.2 历法切换内部逻辑

**核心原则**：**内部用公历记账，农历只是展示层**

- 内部统一维护一个 **公历时间戳**（或公历 `DateTime`）
- 当用户切换「公历 / 农历」tab：
  - 将当前内部公历值转换成目标历法的年月日展示
- 用户在农历下修改年月日时：
  - 先得到农历年月日 + 是否闰月
  - 转换为公历时间并更新内部公历值
  - 其他地方（如基础信息页）统一使用公历时间计算
- **农历闰月处理**：
  * 当用户选择农历日期时，如果该年存在闰月，月份滚轮需展示闰月选项（如：`正月、二月、闰二月、三月…`）
  * 用户选择含闰月的日期后，前端立即转换为公历时间
  * 后端接口不需要额外的「闰月」字段，所有闰月信息在前端转换阶段处理完毕

---

## 四、API 接口扩展

### 4.1 CreateChartRequest 最终版接口定义

**设计决策**：
- 接口统一使用 `snake_case`（与后端数据库字段一致）
- 新增字段均为**可选**，带默认值，保证旧客户端兼容
- `calendar_type` 放在 `birth` 对象内，与其他出生信息字段统一

```typescript
export interface CreateChartRequest {
  // 现有字段（保持不变）
  name: string;
  nickname?: string;
  relation: 'self' | 'spouse' | 'child' | 'parent' | 'friend' | 'other';
  gender: 'male' | 'female';
  
  // 出生信息（扩展）
  birth: {
    year: number;
    month: number;
    day: number;
    hour: number;
    minute: number;
    calendar_type: 'solar' | 'lunar';    // ✅ 新增：历法类型
  };
  
  // 时区与夏令时（新增）
  timezone_offset_minutes?: number;       // ✅ 新增：时区偏移（分钟），默认 480
  is_dst?: boolean;                      // ✅ 新增：夏令时开关，默认 false
  
  // 真太阳时相关（保留）
  birth_place?: string;                   // ✅ 保留：城市名称（用于显示和真太阳时计算）
  use_real_solar_time?: boolean;         // ✅ 保留：真太阳时开关
}
```

### 4.2 字段说明

| 字段 | 类型 | 必填 | 默认值 | 说明 |
|------|------|------|--------|------|
| `birth.calendar_type` | `'solar' \| 'lunar'` | 否 | `'solar'` | 历法类型：公历 / 农历 |
| `timezone_offset_minutes` | `number` | 否 | `480` | 时区偏移（分钟），东八区 = 480 |
| `is_dst` | `boolean` | 否 | `false` | 夏令时开关 |
| `birth_place` | `string` | 否 | `null` | 出生城市名称（保留，用于真太阳时计算） |
| `use_real_solar_time` | `boolean` | 否 | `false` | 真太阳时开关（保留） |

### 4.3 请求示例

**V1 版本（固定东八区）**：
```json
{
  "name": "命主",
  "gender": "male",
  "relation": "self",
  "birth": {
    "year": 1990,
    "month": 1,
    "day": 1,
    "hour": 0,
    "minute": 0,
    "calendar_type": "solar"
  },
  "timezone_offset_minutes": 480,
  "is_dst": false,
  "birth_place": "北京",
  "use_real_solar_time": true
}
```

**旧版本客户端（兼容）**：
```json
{
  "name": "命主",
  "gender": "male",
  "relation": "self",
  "birth": {
    "year": 1990,
    "month": 1,
    "day": 1,
    "hour": 0,
    "minute": 0
  },
  "birth_place": "北京",
  "use_real_solar_time": true
}
```
> 后端处理：`calendar_type` 默认 `'solar'`，`timezone_offset_minutes` 默认 `480`，`is_dst` 默认 `false`

---

## 五、真太阳时计算规则

### 5.1 计算顺序（后端实现）

**后端负责最终换算逻辑**，计算顺序如下：

1. **本地标准时** = 用户选择的年月日时分（`birth.year/month/day/hour/minute`）

2. **夏令时修正**（若 `is_dst = true`）：
   ```
   本地标准时 + 1 小时
   ```

3. **真太阳时修正**（若 `use_real_solar_time = true` 且 `birth_place` 存在）：
   ```
   根据 birth_place 的经度计算时差，修正本地标准时
   ```

4. **UTC 转换**：
   ```
   使用 timezone_offset_minutes 将本地时间转换为 UTC
   ```

5. **排盘计算**：
   ```
   使用 UTC 时间进行八字排盘计算
   ```

### 5.2 前端职责

前端只负责：
- 提供 `timezone_offset_minutes`（V1 固定为 480）
- 提供 `is_dst`（由用户手动开关）
- 提供 `birth_place`（可选，用于真太阳时计算）
- 提供 `use_real_solar_time`（可选，真太阳时开关）

**前端不参与时间换算计算**，所有计算逻辑在后端完成。

---

## 六、兼容策略

### 6.1 客户端版本兼容

**旧版本 App（不传新字段）**：
- 不传 `birth.calendar_type` → 后端默认 `'solar'`
- 不传 `timezone_offset_minutes` → 后端默认 `480`（东八区）
- 不传 `is_dst` → 后端默认 `false`
- 行为与当前版本完全一致，**无破坏性变更**

**新版本 App（传全字段）**：
- 传递所有新字段，支持历法选择、时区、夏令时

### 6.2 服务器端兼容

**设计原则**：服务器端不区分客户端版本，只看字段是否存在

**处理逻辑**：
```typescript
// 后端伪代码示例
const calendarType = req.body.birth?.calendar_type || 'solar';
const timezoneOffset = req.body.timezone_offset_minutes ?? 480;
const isDst = req.body.is_dst ?? false;
```

### 6.3 数据库兼容

**决策**：新增字段存储在 `chart_profiles` 表，旧记录字段为 `NULL` 时使用默认值

**字段映射**：
- `calendar_type` → `calendar_type` (VARCHAR, 默认 'solar')
- `timezone_offset_minutes` → `timezone_offset_minutes` (INT, 默认 480)
- `is_dst` → `is_dst` (BOOLEAN, 默认 false)

---

## 七、开发拆分建议

### 7.1 组件拆分

#### 7.1.1 新增通用组件：`BirthDateTimePickerSheet`

**位置**：`app/src/components/birth/BirthDateTimePickerSheet.tsx`

**Props**：
```typescript
interface BirthDateTimePickerSheetProps {
  visible: boolean;
  initialValue: BirthInputVM;
  onConfirm: (value: BirthInputVM) => void;
  onCancel: () => void;
}
```

**功能**：
- 标题栏（返回/确定）
- 历法 Tab 切换
- 五列滚轮（年月日时分）
- 「今」按钮
- 时区显示 + 夏令时开关（V1 固定东八区）

#### 7.1.2 新增通用组件：`TimezonePickerSheet`（V2 预留）

**位置**：`app/src/components/birth/TimezonePickerSheet.tsx`

**Props**：
```typescript
interface TimezonePickerSheetProps {
  visible: boolean;
  value: number;  // timezoneOffsetMinutes
  onConfirm: (offset: number, label: string) => void;
  onCancel: () => void;
}
```

**功能**：
- 时区列表展示
- 时区选择
- V1 不实现，仅预留接口

#### 7.1.3 修改现有组件：`ManualBaziScreen`

**位置**：`app/src/screens/ManualBazi/ManualBaziScreen.tsx`

**改动**：
- 点击「出生日期」或「出生时间」输入框，打开 `BirthDateTimePickerSheet`
- 历法 Chip 与弹窗内 Tab 双向联动
- 提交时使用新的 `CreateChartRequest` 接口

### 7.2 类型定义

**新增文件**：`app/src/types/birth.ts`

```typescript
export type CalendarType = 'solar' | 'lunar';

export interface BirthInputVM {
  calendarType: CalendarType;
  year: number;
  month: number;
  day: number;
  hour: number;
  minute: number;
  timezoneOffsetMinutes: number;
  timezoneLabel: string;
  isDst: boolean;
}

export interface CreateChartRequest {
  // ... 见 4.1 节
}
```

### 7.3 API Service 更新

**修改文件**：`app/src/services/api/chartService.ts`

**改动**：
- 更新 `CreateChartRequest` 类型定义
- 提交时进行字段映射（前端 `camelCase` → 后端 `snake_case`）

### 7.4 开发阶段划分

**Phase 1：核心功能（V1）**
1. 实现 `BirthDateTimePickerSheet` 组件（不含时区选择器）
2. 修改 `ManualBaziScreen` 接入新弹窗
3. 实现历法双向联动
4. 实现滚轮联动逻辑（公历/农历）
5. 前端固定 `timezoneOffsetMinutes = 480`，UI 显示「东八区」
6. 实现夏令时开关
7. 更新 API 调用，传递新字段

**Phase 2：后端支持**
1. 后端接口扩展（新增字段支持）
2. 真太阳时计算逻辑更新（支持 `timezone_offset_minutes` 和 `is_dst`）
3. 数据库迁移（新增字段）

**Phase 3：时区选择器（V2，后续）**
1. 实现 `TimezonePickerSheet` 组件
2. 时区列表数据准备
3. 接入 `BirthDateTimePickerSheet`

---

## 八、文档更新清单

### 8.1 需要更新的文档

1. **`app.doc/features/出生信息輸入-手動排盤.md`**
   - 更新 3.2.2.3 节「出生日期 & 时间选择」交互设计
   - 更新 4.1 节字段定义，新增 `calendar_type`、`timezone_offset_minutes`、`is_dst`
   - 更新 4.2.1 节提交 Payload 示例

2. **`app.doc/API调用与错误处理规范.md`**
   - 更新 `CreateChartRequest` 接口定义（7.1 节）

3. **`app.doc/API接口统一规范.md`**
   - 更新 3.2 节「命盘模块」API 说明，补充新字段说明

### 8.2 新增文档

- **本文档**：`app.doc/features/出生信息輸入-手動排盤-時區與夏令時擴展方案.md`

---

## 九、设计决策总结

### 9.1 已确定的决策

1. **接口命名**：统一使用 `snake_case`（`calendar_type`、`timezone_offset_minutes`、`is_dst`）
2. **字段位置**：`calendar_type` 放在 `birth` 对象内
3. **默认值策略**：所有新字段均为可选，带默认值（`calendar_type = 'solar'`，`timezone_offset_minutes = 480`，`is_dst = false`）
4. **兼容性**：旧客户端不传新字段时，后端按默认值处理，无破坏性变更
5. **计算职责**：前端只负责收集数据，所有时间换算逻辑在后端完成
6. **产品策略**：V1 固定东八区，V2 再开放时区选择器

### 9.2 后续扩展点

- **V2 时区选择器**：全球时区支持
- **自动时区推荐**：根据用户定位自动推荐时区
- **时间不详模式**：对不清楚具体时间的用户，支持「时间不详」「大致几点」模式

---

## 十、待确认事项

- [ ] 后端接口扩展开发排期
- [ ] 数据库迁移脚本准备
- [ ] 真太阳时计算逻辑验证（后端）
- [ ] UI 设计稿确认（弹窗样式、滚轮交互）

---

## 更新记录

- **创建日期**: 2024年12月
- **文档版本**: v1.0
- **维护者**: 开发团队

