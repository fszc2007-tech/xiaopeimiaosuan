# 我的-二级-命盘相关设计文档

## 页面概述

### 页面名称
我的命盘 / My Charts / 命主列表

### 页面定位
- **页面类型**: 二级页面
- **用户类型**: 所有用户
- **页面层级**: 从「我的」主页进入
- **访问条件**: 用户登录后可见

### 页面目的
管理用户的命主列表，支持查看命盘、添加新命主等功能。**添加新命主直接调用手动排盤页面**，复用已有组件。

---

## 功能需求

### 2.1 核心功能

#### 2.1.1 命主列表展示
- 显示所有命主信息
- 标识默认命主
- 支持查看命盘

#### 2.1.2 添加新命主
- 点击「添加新的命主」按钮
- **直接调用手动排盤页面**（复用已有组件）
- 传递参数 `from=account` 区分入口

#### 2.1.3 查看命盘
- 点击「查看命盘」按钮
- 跳转到命盘总览页面

---

## 页面设计

### 3.1 整体布局

页面采用垂直滚动布局（ScrollView），整体背景为纯白色。从上到下依次包含：

1. 页面标题和说明
2. 命主列表
3. 添加新命主按钮

---

### 3.2 详细区块设计

#### 3.2.1 页面标题和说明

**位置**: 页面最顶部

**样式**:
- 背景: `colors.bg`（白色）
- 内边距: 左右 `spacing.lg`，顶部 `spacing.lg`
- 底部间距: `spacing.md`

**标题**:
- 文案: 「命主列表」
- 字体大小: `fontSizes.lg`
- 字体粗细: `fontWeights.semibold`
- 文字颜色: `colors.ink`
- 底部间距: `spacing.xs`

**说明文字**:
- 文案: 「在这里管理你的命主，点击可进入对应的命盘总览页面。」
- 字体大小: `fontSizes.sm`
- 文字颜色: `colors.textSecondary`
- 行高: `lineHeights.normal`

---

#### 3.2.2 命主列表

**位置**: 标题和说明下方

**卡片样式**:
- 背景: `colors.cardBg`（白色）
- 圆角: `radius.lg`
- 阴影: `shadows.card`
- 内边距: `spacing.lg`
- 上下间距: `spacing.md`

**列表项样式**:

每个命主一个列表项：

```
┌─────────────────────────────────────────┐
│  旭（默认命主）              [查看命盘] │
│  公历 1995-08-08 · 男                   │
└─────────────────────────────────────────┘
```

**列表项内容**:

1. **命主昵称**:
   - 显示: `chart_name`（命主昵称）
   - 如果是默认命主，显示: `chart_name（默认命主）`
   - 字体大小: `fontSizes.base`
   - 字体粗细: `fontWeights.medium`
   - 文字颜色: `colors.ink`
   - 底部间距: `spacing.xs`

2. **命主信息**:
   - 显示: 「公历 {{gregorian_date}} · {{gender}}」
   - 字体大小: `fontSizes.sm`
   - 文字颜色: `colors.textSecondary`

3. **查看命盘按钮**（右侧）:
   - 文案: 「查看命盘」
   - 按钮类型: `GhostButton`（文字按钮）
   - 文字颜色: `colors.brandBlue`
   - 字体大小: `fontSizes.sm`
   - 点击行为: 跳转到命盘总览页面

**列表项样式**:
- 背景: `colors.disabledBg`（浅灰色，可选）或 `colors.cardBg`（白色）
- 圆角: `radius.md`
- 内边距: `spacing.md`
- 列表项之间间距: `spacing.sm`
- 点击反馈: `activeOpacity: 0.7`

**空状态**:
- 如果没有命主，显示空状态提示
- 文案: 「还没有命主，点击下方按钮添加第一个命主吧」
- 字体大小: `fontSizes.sm`
- 文字颜色: `colors.textSecondary`
- 居中显示
- 顶部间距: `spacing.xl`

---

#### 3.2.3 添加新命主按钮

**位置**: 命主列表下方

**按钮样式**:
- 按钮类型: `SecondaryButton`（次要按钮）或虚线边框按钮
- 背景: `colors.bg`（白色）
- 边框: `colors.border`（虚线，2px）
- 圆角: `radius.lg`
- 内边距: `spacing.md`
- 宽度: 100%
- 顶部间距: `spacing.md`

**按钮内容**:
- 文案: 「+ 添加新的命主」
- 字体大小: `fontSizes.base`
- 文字颜色: `colors.brandBlue`
- 图标: 「+」符号（左侧）
- 图标颜色: `colors.brandBlue`
- 图标大小: `fontSizes.lg`

**点击行为**:
- 跳转到手动排盤页面
- 传递参数: `from=account`（区分入口）
- 路由: `/manual-bazi?from=account` 或 `navigation.navigate('ManualBazi', { from: 'account' })`

**复用说明**:
- **直接调用手动排盤页面**（`出生信息輸入-手動排盤.md` 中已定义）
- 复用已有的表单组件和逻辑
- 通过 `from` 参数区分入口，控制提交后的跳转行为

---

### 3.3 添加命主后的处理

#### 3.3.1 提交成功后的行为

根据 `from` 参数决定跳转：

**方案 A（推荐）**: 直接进入新命主的命盘总览页
- 用户能立刻看到结果
- 路由: `/chart/:chartId/overview`

**方案 B**: 返回命主列表，显示 Toast 提示
- Toast 文案: 「已为「{{chart_name}}」生成命盘」
- 用户可以在列表中点击查看

**实现逻辑**:
```typescript
// 在手动排盤页面提交成功后
if (from === 'account') {
  // 方案 A: 直接进入命盘总览
  navigation.navigate('ChartOverview', { chartId: newChartId });
  
  // 或方案 B: 返回列表并显示 Toast
  // navigation.goBack();
  // showToast(`已为「${chartName}」生成命盘`);
}
```

---

## 数据需求

### 4.1 命主列表接口

#### 4.1.1 获取命主列表

**接口**: `GET /api/charts/list`

**请求参数**: 无（从 token 中获取用户 ID）

**响应**:
```typescript
interface GetChartsListResponse {
  charts: ChartItem[];
  default_chart_id?: string; // 默认命主 ID
}

interface ChartItem {
  chart_id: string;
  chart_name: string;         // 命主昵称
  gender: 'male' | 'female';
  gregorian_date: string;     // 公历日期，格式: YYYY-MM-DD
  relationship?: string;      // 与我的关系
  is_default: boolean;        // 是否为默认命主
  created_at: string;         // 创建时间
}
```

#### 4.1.2 设置默认命主

**接口**: `PUT /api/charts/:chartId/set-default`

**请求参数**:
```typescript
interface SetDefaultChartRequest {
  chart_id: string;
}
```

**响应**:
```typescript
interface SetDefaultChartResponse {
  success: boolean;
  message: string;
}
```

#### 4.1.3 删除命主

**接口**: `DELETE /api/charts/:chartId`

**请求参数**: 无（从 URL 中获取 chart_id）

**响应**:
```typescript
interface DeleteChartResponse {
  success: boolean;
  message: string;
}
```

---

## 交互流程

### 5.1 用户操作流程

1. **进入页面**
   - 用户从「我的」主页点击「我的命盘」
   - 页面加载命主列表并展示

2. **查看命盘**
   - 点击「查看命盘」按钮
   - 跳转到对应命主的命盘总览页面

3. **添加新命主**
   - 点击「+ 添加新的命主」按钮
   - 跳转到手动排盤页面（传递 `from=account` 参数）
   - 填写命主信息并提交
   - 提交成功后根据方案 A 或 B 处理

4. **管理命主**（可选功能）
   - 长按命主项显示操作菜单
   - 支持设置为默认命主
   - 支持删除命主（需确认）

---

## 技术实现

### 6.1 技术要点

- 列表展示（FlatList 或 ScrollView）
- 路由跳转（手动排盤页面、命盘总览页面）
- 参数传递（`from=account`）
- 数据加载和错误处理
- 空状态处理

### 6.2 相关文件结构

```
src/
├── screens/
│   └── Me/
│       ├── MyChartsScreen.tsx        # 我的命盘页面
│       └── components/
│           ├── ChartListItem.tsx     # 命主列表项组件
│           └── EmptyState.tsx        # 空状态组件
├── screens/
│   └── ManualBazi/
│       └── ManualBaziScreen.tsx      # 手动排盤页面（复用）
├── services/
│   └── api/
│       └── chartService.ts           # 命主 API
└── types/
    └── chart.ts                      # 命主类型定义
```

### 6.3 路由跳转示例

```typescript
// 跳转到手动排盤页面（添加命主）
const handleAddChart = () => {
  navigation.navigate('ManualBazi', {
    from: 'account',  // 标识从个人中心进入
  });
};

// 跳转到命盘总览页面
const handleViewChart = (chartId: string) => {
  navigation.navigate('ChartOverview', {
    chartId: chartId,
  });
};
```

---

## 设计规范

### 7.1 视觉设计

- **遵循 UI_SPEC.md 中的设计规范**
- 使用 Design Tokens（colors, typography, layout）
- 整体背景为纯白色
- 列表项使用卡片样式
- 保持充足的留白

### 7.2 交互设计

- 列表滚动流畅
- 点击反馈明确
- 跳转动画平滑

### 7.3 响应式设计

- 适配不同屏幕尺寸
- 列表在小屏设备上可正常滚动

---

## 与手动排盤页面的集成

### 8.1 复用说明

- **直接调用手动排盤页面**（`出生信息輸入-手動排盤.md` 中已完整定义）
- 复用所有表单组件、验证逻辑、提交逻辑
- 通过 `from` 参数区分入口

### 8.2 参数传递

**跳转时传递的参数**:
```typescript
{
  from: 'account',  // 标识从个人中心进入
}
```

**手动排盤页面接收参数**:
```typescript
// 在 ManualBaziScreen 中
const { from } = route.params || {};

// 提交成功后的处理
const handleSubmit = async (data: ManualBaziFormData) => {
  // ... 提交逻辑
  
  if (from === 'account') {
    // 从个人中心进入，提交后跳转到命盘总览或返回列表
    navigation.navigate('ChartOverview', { chartId: newChartId });
  } else {
    // 从首页进入，提交后跳转到命盘总览
    navigation.navigate('ChartOverview', { chartId: newChartId });
  }
};
```

### 8.3 表单字段

手动排盤页面的表单字段（已在 `出生信息輸入-手動排盤.md` 中定义）：
1. 性别（必填）
2. 曆法（必填）
3. 出生日期 & 时间（必填）
4. 出生城市（可选）
5. 真太陽時（可选，自动计算）
6. 案例名称（可选，对应命主昵称）
7. 关系（可选，对应与我的关系）
8. 选择分析主题（可选）

**在添加命主场景中**:
- 「案例名称」字段对应「命主昵称」
- 「关系」字段对应「与我的关系」
- 其他字段保持一致

---

## 待确认事项

- [x] 页面布局和区块设计（已确认）
- [x] 添加命主调用手动排盤页面（已确认）
- [ ] 提交成功后的跳转方案（方案 A 或 B）
- [ ] 是否需要支持编辑命主信息
- [ ] 是否需要支持删除命主
- [ ] 是否需要支持设置默认命主

---

## 更新记录

- **创建日期**: 2024年11月
- **文档版本**: v1.0.0
- **最后更新**: 2024年11月
- **更新内容**: 
  - 初始版本
  - 包含命主列表和添加命主功能
  - 明确复用手动排盤页面
- **维护者**: 开发团队

