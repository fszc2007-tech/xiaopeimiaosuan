# 小佩命盘选择功能设计方案（v1 精简版）

> **版本**: v1.0  
> **创建日期**: 2024年12月  
> **状态**: 待实现  
> **适用范围**: 小佩 App 主页场景卡片分析功能

---

## 📋 功能摘要（可直接给团队）

**小佩命盘选择 & 分析（v1 范围）**

- 小佩首页顶部新增「当前命盘」组件，复用现有排盘 / 命盘列表功能。
- 通过全局 `currentChartId` 记录用户当前使用的命盘。
- 用户点击任一场景卡片（恋爱、考研、婚姻、工作、婆媳、投资）时：
  - 如无命盘：弹窗提示并引导去新建命盘；
  - 如有命盘：携带 `currentChartId` 调用 `/api/v1/xiaopei/analyze`，做单人解读。
- 分析接口 v1 只需：`topic + chart_id + question`（或 `main_chart_id`），结构上为后续合盘保留扩展字段，但暂不启用。

---

## 一、前端实现约定

### 1.1 全局状态设计

**位置**: 扩展 `useChartStore`（`src/store/useChartStore.ts`）

**新增字段**:
```typescript
interface ChartState {
  // ... 现有字段 ...
  
  // 新增：当前命盘 ID（用于小佩场景分析）
  currentChartId: string | null;
  
  // 新增：设置当前命盘
  setCurrentChartId: (chartId: string | null) => void;
}
```

**状态初始化逻辑**:
- 应用启动时，从 `localStorage` 读取 `currentChartId`
- 校验：如果读取的 ID 不在 `charts` 列表里，则置为 `null`
- 如果 `charts` 列表为空，则 `currentChartId` 为 `null`

**持久化**: ✅ 是（使用 `persist` middleware）

---

### 1.2 当前命盘组件设计

**位置**: `src/screens/Xiaopei/CurrentChartSelector.tsx`（新建组件）

#### 1.2.1 有命盘状态

**UI 布局**:
```
┌─────────────────────────────────────┐
│ 当前命盘                            │
│                                     │
│ 我的命盘 · 男 · 1995-08-12 · 生肖猪 │
│ 当前以「我的命盘」为准              │
│                                     │
│                    [切换命盘 →]     │
└─────────────────────────────────────┘
```

**字段说明**:
- 标题：`当前命盘`（14px，粗体）
- 主信息：`{name} · {gender} · {birthDate} · {zodiac}`（16px，深灰）
- 提示文字：`当前以「{name}」为准，切换后下面的分析也会跟着改变`（12px，浅灰）
- 按钮：`切换命盘`（主色，右侧对齐）

**交互流程**:
1. 点击「切换命盘」→ 底部弹出命盘选择器（高度 60%）
2. 选择器内容：
   - 顶部：`选择命盘`（标题栏，带关闭按钮）
   - 列表项：从 `useChartStore.charts` 读取，显示 `{name} · {gender} · {birthDate} · {zodiac}`
   - 当前命盘标注：「当前使用」标识
   - 底部固定按钮：`+ 新建命盘`
3. 选择后：
   - 调用 `setCurrentChartId(selectedChartId)`
   - 关闭选择器
   - 刷新组件显示
   - 提示：`已切换到「{name}」`（Toast，2秒）

#### 1.2.2 无命盘状态

**UI 布局**:
```
┌─────────────────────────────────────┐
│ 当前命盘                            │
│                                     │
│         [图标：命盘占位图]           │
│                                     │
│      你还没有命盘～                 │
│      先创建一个命盘，后面的解读      │
│      才会更准                        │
│                                     │
│      [一键新建命盘]                 │
└─────────────────────────────────────┘
```

**字段说明**:
- 标题：`当前命盘`（14px，粗体）
- 主文案：`你还没有命盘～`（16px，深灰）
- 说明文字：`先创建一个命盘，后面的解读才会更准`（14px，浅灰，2行）
- 按钮：`一键新建命盘`（主色按钮，居中）

**交互流程**:
1. 点击「一键新建命盘」→ 跳转 `/chart/create?returnTo=/xiaopei`
2. 排盘完成后：
   - 保存命盘（走现有 `POST /api/v1/bazi/chart` 接口）
   - 调用 `setCurrentChartId(newChartId)`
   - 根据 `returnTo` 参数返回小佩主页
   - 当前命盘组件自动刷新为「有命盘状态」

---

### 1.3 场景卡片点击逻辑

**位置**: `src/screens/Xiaopei/HomeScreen.tsx`（修改现有组件）

**伪代码**:
```typescript
const handleCardClick = (topic: TopicKey) => {
  const { currentChartId } = useChartStore.getState();
  
  if (!currentChartId) {
    // 无命盘：弹窗提示
    showModal({
      title: '需要先创建命盘',
      message: '需要先创建命盘才能开始解读',
      buttons: [
        { text: '取消', onPress: () => {} },
        { 
          text: '去创建命盘', 
          onPress: () => navigation.navigate('/chart/create', { returnTo: '/xiaopei' })
        }
      ]
    });
    return;
  }
  
  // 有命盘：跳转到场景聊天页，携带 currentChartId
  navigation.navigate('/xiaopei/chat', {
    topic,
    chartId: currentChartId
  });
};
```

**场景卡片映射**:
```typescript
// topic 枚举（前端内部映射）
const TOPIC_MAP = {
  '恋爱·桃花': 'LOVE',
  '考研·考公': 'EXAM',
  '结婚·婚姻': 'MARRIAGE',
  '工作·跳槽': 'JOB',
  '婆媳·关系': 'FAMILY',
  '投资·理财': 'WEALTH',
} as const;

type TopicKey = keyof typeof TOPIC_MAP;
type TopicEnum = typeof TOPIC_MAP[TopicKey];
```

---

### 1.4 复用逻辑说明

#### 1.4.1 排盘功能复用

- **组件复用**: 直接跳转到现有排盘页面路由 `/chart/create`
- **API 复用**: 使用现有 `POST /api/v1/bazi/chart` 接口
- **路由复用**: 通过 `returnTo` 参数控制返回路径

#### 1.4.2 命盘列表复用

- **API 复用**: 切换命盘选择器直接调用现有 `GET /api/v1/bazi/charts` 接口
- **组件复用**（可选）: 如「我的」页面已有命盘列表组件，可抽取为共享组件

---

## 二、后端接口约定（v1 最简版）

### 2.1 接口路径

```http
POST /api/v1/xiaopei/analyze
```

**遵循**: `API接口统一规范.md` 的路径规范（`/api/v1/...`）

---

### 2.2 请求体（v1 最简版）

**方案 A：极简版（推荐 v1 使用）**
```json
{
  "topic": "LOVE",
  "chart_id": "chart_123",
  "question": "最近桃花运怎么样，会不会有新的暧昧？"
}
```

**方案 B：预留扩展版（如果希望一次设计好结构）**
```json
{
  "topic": "LOVE",
  "main_chart_id": "chart_123",
  "related_chart_ids": [],
  "relationship_type": null,
  "extra": {
    "user_question": "最近桃花运怎么样，会不会有新的暧昧？"
  }
}
```

**建议**: v1 使用方案 A，v2 合盘时再扩展为方案 B（向后兼容）

---

### 2.3 字段说明

| 字段 | 类型 | 必填 | 说明 | 示例 |
|------|------|------|------|------|
| `topic` | string | ✅ 是 | 场景枚举值（英文） | `"LOVE"` / `"EXAM"` / `"MARRIAGE"` / `"JOB"` / `"FAMILY"` / `"WEALTH"` |
| `chart_id` | string | ✅ 是 | 当前命盘 ID | `"chart_123"` |
| `question` | string | ❌ 否 | 用户自定义问题（可选） | `"最近桃花运怎么样？"` |

**topic 枚举值**:
- `LOVE` ←→ 恋爱·桃花
- `EXAM` ←→ 考研·考公
- `MARRIAGE` ←→ 结婚·婚姻
- `JOB` ←→ 工作·跳槽
- `FAMILY` ←→ 婆媳·关系
- `WEALTH` ←→ 投资·理财

---

### 2.4 响应体（v1 建议）

```json
{
  "success": true,
  "data": {
    "answer": "这里是一段给用户看的完整解读文案",
    "suggested_questions": [
      "我适合怎样认识新的人？",
      "今年适合开始稳定关系吗？"
    ]
  }
}
```

**字段说明**:
- `answer`: 完整的解读文案（字符串）
- `suggested_questions`: 推荐追问列表（字符串数组）

**后续扩展**（v2+）:
- 可增加 `sections`（分段结构）
- 可增加 `tags`（标签）
- 可增加 `metadata`（元数据）

---

### 2.5 后端处理流程

```
接收请求
    ↓
校验 topic 是否为有效枚举值
    ↓
校验 chart_id 是否存在且属于当前用户
    ↓
查询命盘数据（复用现有 GET /api/v1/bazi/charts/:chartId 逻辑）
    ↓
根据 topic 选择对应的 system prompt 模板
    ↓
组装 LLM 请求：
  - system: 对应 topic 的 prompt
  - user: 命盘数据 + question（如有）
    ↓
调用 LLM（复用现有 LLM service）
    ↓
解析 LLM 返回结果
    ↓
返回统一响应格式
```

**复用点**:
- 命盘查询：复用现有 `GET /api/v1/bazi/charts/:chartId`
- LLM 调用：复用现有 LLM service
- Prompt 模板：根据 `topic` 选择对应模板（如 `XIAOPEI_PROMPT_LOVE.ts`）

---

## 三、错误与边界处理

### 3.1 当前命盘被删除

**场景**: 用户删除了当前使用的命盘

**处理逻辑**:
```typescript
// 在删除命盘的 action 中
deleteProfile: (chartId) => {
  set((state) => {
    const newProfiles = state.profiles.filter(p => p.chartId !== chartId);
    const newCurrentChartId = 
      state.currentChartId === chartId 
        ? (newProfiles.length > 0 ? newProfiles[0].chartId : null)
        : state.currentChartId;
    
    return {
      profiles: newProfiles,
      currentChartId: newCurrentChartId,
    };
  });
}
```

**UI 表现**:
- 如果删除后还有其他命盘：自动切换到第一个命盘
- 如果删除后没有命盘：`currentChartId` 置为 `null`，组件显示「无命盘状态」

---

### 3.2 命盘列表为空

**场景**: 用户首次使用，或所有命盘被删除

**处理逻辑**:
- `currentChartId` 自动为 `null`
- 当前命盘组件显示「无命盘状态」
- 所有场景卡片点击时，统一弹窗提示「需要先创建命盘」

---

### 3.3 命盘 ID 无效（本地存储与服务器不一致）

**场景**: 本地存储的 `currentChartId` 在服务器上不存在

**处理逻辑**:
```typescript
// 应用启动时
const initCurrentChartId = async () => {
  const storedChartId = localStorage.getItem('currentChartId');
  const charts = await fetchCharts(); // 从服务器获取列表
  
  if (storedChartId && charts.find(c => c.chartId === storedChartId)) {
    setCurrentChartId(storedChartId);
  } else {
    // ID 无效，置为 null 或第一个命盘
    setCurrentChartId(charts.length > 0 ? charts[0].chartId : null);
  }
};
```

---

### 3.4 后端接口错误处理

**错误码约定**（遵循 `API接口统一规范.md`）:

| 错误码 | HTTP 状态码 | 说明 | 前端处理 |
|--------|------------|------|---------|
| `INVALID_PARAMETER` | 400 | topic 或 chart_id 无效 | 提示用户「参数错误」 |
| `CHART_NOT_FOUND` | 404 | 命盘不存在 | 提示用户「命盘不存在」，清空 `currentChartId` |
| `UNAUTHORIZED` | 401 | 未授权 | 跳转登录页 |
| `RATE_LIMIT_EXCEEDED` | 429 | 限流超限 | 提示用户「今日分析次数已达上限」 |
| `INTERNAL_ERROR` | 500 | 服务器错误 | 提示用户「服务异常，请稍后重试」 |

---

## 四、合盘扩展预留（v2）

### 4.1 接口扩展说明

**v1**: 所有场景只使用 `chart_id` / `main_chart_id` 进行单人解读。

**v2**: 在恋爱 / 婚姻 / 婆媳场景中增加「合盘对象」选择，届时将扩展请求字段：`related_chart_ids` 与 `relationship_type`，但不影响现有接口兼容性。

**向后兼容保证**:
- v1 的请求体（`topic + chart_id + question`）在 v2 中仍然有效
- v2 新增字段为可选字段，v1 客户端无需修改

---

### 4.2 v2 扩展字段（预留）

```json
{
  "topic": "LOVE",
  "main_chart_id": "chart_me",
  "related_chart_ids": ["chart_partner"],  // v2 新增
  "relationship_type": "情侣",             // v2 新增
  "extra": {
    "user_question": "..."
  }
}
```

**relationship_type 枚举值**（v2）:
- `"情侣"`: 恋爱·桃花场景
- `"夫妻"`: 结婚·婚姻场景
- `"婆媳"`: 婆媳·关系场景

---

## 五、实现检查清单

### 5.1 前端检查清单

- [ ] 扩展 `useChartStore`，新增 `currentChartId` 和 `setCurrentChartId`
- [ ] 创建 `CurrentChartSelector` 组件（有命盘/无命盘两种状态）
- [ ] 实现命盘切换选择器（底部弹窗）
- [ ] 修改场景卡片点击逻辑（无命盘时弹窗提示）
- [ ] 实现新建命盘流程（复用排盘页面，带 `returnTo` 参数）
- [ ] 实现状态持久化（localStorage）
- [ ] 实现错误处理（命盘被删除、ID 无效等边界情况）

---

### 5.2 后端检查清单

- [ ] 创建 `POST /api/v1/xiaopei/analyze` 接口
- [ ] 实现 topic 枚举值校验
- [ ] 实现 chart_id 权限校验（属于当前用户）
- [ ] 复用命盘查询逻辑
- [ ] 根据 topic 选择对应的 prompt 模板
- [ ] 调用 LLM service 并解析返回结果
- [ ] 实现统一错误响应格式
- [ ] 添加接口文档注释

---

### 5.3 测试检查清单

- [ ] 有命盘时，场景卡片正常跳转并携带 `chart_id`
- [ ] 无命盘时，场景卡片点击弹窗提示
- [ ] 切换命盘后，场景分析使用新命盘
- [ ] 新建命盘后，自动设置为当前命盘
- [ ] 删除当前命盘后，自动切换到其他命盘或置为 null
- [ ] 本地存储的 `currentChartId` 无效时，自动恢复
- [ ] 后端接口错误时，前端正确提示

---

## 六、命名统一约定

### 6.1 前端命名

- **状态字段**: `currentChartId`（camelCase）
- **Action**: `setCurrentChartId`
- **组件**: `CurrentChartSelector`
- **路由参数**: `chartId`（camelCase）

### 6.2 后端命名

- **请求字段**: `chart_id`（snake_case，遵循 API 规范）
- **响应字段**: `chart_id`（snake_case）
- **数据库字段**: `chart_id`（snake_case）

**转换规则**:
- 前端发送请求时：`currentChartId` → `chart_id`
- 后端接收请求时：`chart_id` → 内部使用 `chartId`（camelCase）
- 后端返回响应时：`chartId` → `chart_id`（snake_case）
- 前端接收响应时：`chart_id` → `currentChartId`（camelCase）

---

## 七、相关文档

- **参考**: `API接口统一规范.md` - API 路径、响应格式、错误码
- **参考**: `状态管理与数据模型规范.md` - Store 结构、命名规范
- **参考**: `APP开发文档.md` - 整体架构、功能模块
- **参考**: `前端路由与页面结构设计文档.md` - 路由参数、页面结构

---

## 八、版本记录

| 版本 | 日期 | 更新内容 | 更新人 |
|------|------|---------|--------|
| v1.0 | 2024-12 | 初始版本，v1 精简版实现约定 | 开发团队 |

---

**文档版本**: v1.0  
**最后更新**: 2024年12月  
**维护者**: 开发团队  
**状态**: 待实现

