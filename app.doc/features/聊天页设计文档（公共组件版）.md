# 聊天页设计文档（公共组件版）

> **版本**: v3.0  
> **适用范围**: 小佩 App 内所有「聊天场景」  
> **文件类型**: 产品 / 开发说明（供 Cursor / 前后端参考）

---

## 页面概述

### 页面名称
聊天页 / Chat Page / ChatScreen

### 页面定位
- **页面类型**: 公共聊天组件
- **用户类型**: 所有用户
- **页面层级**: 全屏页面（不显示底部导航）
- **访问条件**: 从各个入口跳转进入

### 页面目的
作为「公共聊天组件」，被所有聊天入口复用，统一提供聊天记录展示、输入发送消息、LLM 调用、追问建议和等待状态反馈。

**重要说明**:
- **ChatPage 只负责当前会话**: 本页面仅显示和管理当前对话的消息，不管理历史对话列表
- **历史对话管理**: 采用集中管理方案，历史对话列表在「我的 → 聊天记录」页面统一管理
- **历史快捷入口**: 顶部栏右侧预留图标位置，将来作为「历史快捷入口」（第一期不实现）

### 核心理念
ChatPage 是一个统一的「对话壳」，入口只决定：话题、UI 变体、文案细节。在每次给 LLM 发出请求后，用轻量、温和的「思考中」反馈安抚用户。

---

## 功能需求

### 2.1 核心功能

#### 2.1.1 当前会话消息展示
- 显示当前会话的所有消息（用户消息 + 小佩回复）
- 支持滚动查看当前会话的历史消息
- 新消息自动滚动到底部
- **注意**: 本页面不显示历史对话列表，历史对话管理在「我的 → 聊天记录」页面

#### 2.1.2 消息输入与发送
- 支持多行文本输入
- 发送消息到 LLM
- 清空输入框

#### 2.1.3 LLM 调用
- 首轮调用（页面进入时）
- 多轮调用（用户发送新消息）
- 错误处理和重试

#### 2.1.4 追问建议
- 显示推荐问题
- 点击追问按钮快速发送

#### 2.1.5 等待状态反馈
- 显示「思考中」气泡
- 温和的等待文案
- 避免系统化的 loading 提示

---

## 状态与数据模型

### 3.1 关键枚举

#### 3.1.1 TopicKey（与小佩主页统一）

```typescript
type TopicKey =
  | 'peach'      // 桃花 · 恋爱
  | 'marriage'   // 婚姻 · 关系经营
  | 'career'     // 事业与选择
  | 'wealth'     // 财富与钱路
  | 'family'     // 家庭与亲子
  | 'rhythm';    // 节奏与运势
```

#### 3.1.2 入口来源（ChatEntrySource）

```typescript
type ChatEntrySource =
  | 'xiaopei_topic_button'      // 小佩主页：话题按钮
  | 'xiaopei_common_question'   // 小佩主页：大家常问
  | 'xiaopei_free_input'        // 小佩主页：自由输入
  | 'overview_card'             // 命盘总览：一键解读
  | 'shen_sha_popup'            // 神煞解读弹窗
  | 'special_topic'             // 专题入口（桃花、婚姻等）
  | 'history';                  // 历史对话入口
```

#### 3.1.3 UI 变体（ChatUiVariant）

```typescript
type ChatUiVariant =
  | 'default'    // 通用聊天
  | 'love'       // 桃花 · 恋爱
  | 'marriage'   // 婚姻 · 关系经营
  | 'career'     // 事业
  | 'wealth'     // 财富
  | 'family'     // 家庭
  | 'rhythm'     // 节奏与运势
  | 'synastry';  // 合盘（预留）
```

#### 3.1.4 聊天状态（ChatStatus）

```typescript
type ChatStatus = 'idle' | 'loading' | 'error';
```

- **idle**: 没有请求在 flight，用户可以正常发送
- **loading**: 已向 LLM 发出请求，尚未返回 → 需要展示「思考中」反馈
- **error**: 请求失败，展示轻量错误提示

---

### 3.2 数据接口

#### 3.2.1 ChatPage Props

```typescript
interface ChatPageProps {
  navigation: NavigationProp<RootStackParamList>;
  route: RouteProp<RootStackParamList, 'Chat'>;
}

interface ChatRouteParams {
  topic?: TopicKey | null;          // 入口话题，null 表示通用
  question?: string;                // 用户问题原文（首轮问题）
  source?: ChatEntrySource;         // 入口来源
  masterId?: string;                // 当前命主 ID
  uiVariant?: ChatUiVariant;        // UI 变体（可选）
  conversationId?: string | null;   // 会话 ID（历史对话时传入）
  sectionKey?: string;              // 命盘总览一键解读的 sectionKey
  shenShaCode?: string;             // 神煞代码（神煞解读时传入）
  pillarType?: 'year' | 'month' | 'day' | 'hour';  // 柱位类型
}
```

#### 3.2.2 会话与消息

```typescript
interface Conversation {
  id: string;
  userId: string;
  masterId: string;
  topic: TopicKey | null;
  title: string;
  lastMessagePreview: string;
  createdAt: string;
  updatedAt: string;
}

interface ChatMessage {
  id: string;
  conversationId: string;
  role: 'user' | 'assistant';
  text: string;
  createdAt: string;
  meta?: {
    source?: ChatEntrySource;
    sectionKey?: string;            // 命盘总览一键解读的 sectionKey
    shenShaCode?: string;           // 神煞代码
    pillarType?: string;            // 柱位类型
  };
}

interface ChatState {
  messages: ChatMessage[];
  status: ChatStatus;
  isStreaming?: boolean;            // 是否正在流式渲染（可选）
  errorMessage?: string | null;     // 错误信息
  conversationId?: string | null;   // 当前会话 ID
}
```

---

## 页面设计

### 4.1 整体布局

页面采用垂直布局，整体背景为纯白色 `colors.bg`。从上到下依次包含：

1. 顶部栏（Header）
2. 消息列表（Message List）
3. 追问建议区（Follow-ups）
4. 底部输入框（Composer）
5. （可选）全局轻提示层（错误 / 网络问题）

---

### 4.2 详细区块设计

#### 4.2.1 顶部栏（Header）

**位置**: 页面最顶部

**样式**:
- 背景: `colors.bg`（白色）
- 高度: 约 `56dp`（包含安全区域）
- 底部边框: `colors.border`（1px）
- 内边距: 左右 `spacing.md`，上下 `spacing.sm`

**内容布局**:

```
┌─────────────────────────────────────────┐
│ [←]  旭 · 本人        [话题Tag]  [slot] │
│      [命主]                              │
│      🎯 桃花 · 恋爱                      │
└─────────────────────────────────────────┘
```

**左侧区域**:
- **返回按钮**:
  - 圆形浅色按钮
  - 背景: `colors.disabledBg`（浅灰色）
  - 图标: `ChevronLeft`（lucide-react 或自定义图标）
  - 图标大小: `20 x 20dp`
  - 图标颜色: `colors.ink`
  - 按钮大小: `40 x 40dp`
  - 圆角: `radius.pill`
  - 点击反馈: `activeOpacity: 0.7`
  - 行为:
    - 默认：返回上一页（`navigation.goBack()`）
      - 如果从小佩主页进入：返回小佩主页
      - 如果从「聊天记录」页面进入：返回「聊天记录」页面
      - 如果从其他入口进入：返回对应页面

**中间区域**:
- **命主信息**:
  - **第一行**:
    - 主标题: 「旭 · 本人」（示例）
      - 字体大小: `fontSizes.sm`
      - 字体粗细: `fontWeights.semibold`
      - 文字颜色: `colors.ink`
    - Tag: 「命主」
      - 背景: `colors.blueSoftBg`
      - 文字颜色: `colors.brandBlue`
      - 圆角: `radius.pill`
      - 内边距: 左右 `spacing.xs`，上下 `spacing.xs / 2`
      - 字体大小: `fontSizes.xs`
      - 左侧间距: `spacing.xs`
  - **第二行**:
    - 图标: 根据 `topic` 映射 `TOPICS[topic].icon`（如果 topic 存在）
    - 图标大小: `16 x 16dp`
    - 图标颜色: `colors.brandGreen`
    - 文案:
      - 有 topic：`TOPICS[topic].label`（如「桃花 · 恋爱」）
      - 无 topic：「自由聊天」
    - 字体大小: `fontSizes.xs`
    - 文字颜色: `colors.textSecondary`
    - 左侧间距: `spacing.xs`

**右侧区域**（可选 slot）:
- **历史快捷入口**（预留，第一期不实现）:
  - 图标: `History` 或 `Clock`（lucide-react）
  - 图标大小: `20 x 20dp`
  - 图标颜色: `colors.textSecondary`
  - 按钮大小: `40 x 40dp`
  - 圆角: `radius.pill`
  - 点击反馈: `activeOpacity: 0.7`
  - 行为: 点击后弹出最近会话 Bottom Sheet（后续实现）
  - 第一期: 隐藏此按钮，仅预留位置
- **合盘**（预留）: 可显示双头像 + 「我 vs 他/她」

**等待状态在 Header 的体现**:
- 不建议在 Header 出现明显「转圈圈」——避免压迫感
- Header 保持稳定，等待状态放在消息区里处理（见 4.2.2）

---

#### 4.2.2 消息列表（Message List）

**位置**: 顶部栏下方

**样式**:
- 背景: `colors.bg`（白色）
- 高度: 自适应（填充剩余空间）
- 内边距: 左右 `spacing.md`，上下 `spacing.sm`
- 滚动: 垂直滚动，新消息自动滚动到底部

**消息气泡样式**:

**用户消息气泡**:
- 对齐: 右对齐
- 背景: `colors.ink`（深色 #32343a）
- 文字颜色: 白色
- 圆角: `radius.lg`（右下角直角，其余圆角）
- 内边距: 左右 `spacing.md`，上下 `spacing.sm`
- 最大宽度: 75%
- 字体大小: `fontSizes.sm`
- 行高: `lineHeights.normal`
- 底部间距: `spacing.sm`

**小佩（assistant）消息气泡**:
- 对齐: 左对齐
- 布局: 水平排列，左侧头像，右侧气泡
- **头像**:
  - 圆形，直径 `40dp`
  - 背景: `colors.ink`（深色）
  - 文字: 「佩」（白色）
  - 字体大小: `fontSizes.sm`
  - 右侧间距: `spacing.sm`
  - 使用官方 Logo 头像版本（遵循 `UI_SPEC.md`）
- **气泡**:
  - 背景: `colors.disabledBg`（浅灰色 #f3f4f6）
  - 文字颜色: `colors.ink`
  - 圆角: `radius.lg`（左下角直角，其余圆角）
  - 内边距: 左右 `spacing.md`，上下 `spacing.sm`
  - 最大宽度: 75%
  - 字体大小: `fontSizes.sm`
  - 行高: `lineHeights.normal`
  - 底部间距: `spacing.sm`

**空状态**:
- 当 `messages.length === 0` 且未开始请求时：
- 显示说明文本：
  - 文案: 「这里会显示你和小佩的对话。真实使用中，会从你在小佩页选择的话题或输入的问题开始。」
  - 字体大小: `fontSizes.sm`
  - 文字颜色: `colors.textSecondary`
  - 文本对齐: 居中
  - 顶部间距: `spacing['2xl']`

---

#### 4.2.3 「思考中 / 等待中」气泡

**展示条件**: 当 `status === 'loading'` 时

**位置**:
- 左侧（assistant 一侧）
- 放在最后一条消息之下，追问建议之上
- 底部间距: `spacing.md`

**样式**:
- 布局: 水平排列，左侧头像，右侧气泡
- **头像**: 同小佩正常头像（深色圆，「佩」或 Logo 头像）
- **气泡**:
  - 背景: `colors.disabledBg`（浅灰色）
  - 文字颜色: `colors.textSecondary`
  - 圆角: `radius.lg`（左下角直角，其余圆角）
  - 内边距: 左右 `spacing.md`，上下 `spacing.sm`
  - 最大宽度: 75%
  - 字体大小: `fontSizes.sm`
  - 行高: `lineHeights.normal`

**文案配置**:
```typescript
interface ThinkingMessageConfig {
  default: string[];      // 通用等待文案
  byTopic: Record<TopicKey, string[]>;  // 按话题的等待文案
}

const THINKING_MESSAGES: ThinkingMessageConfig = {
  default: [
    '小佩在根据你的命盘理一理思路…',
    '我先把你刚说的和命盘对一下…',
    '我理一理你现在的情况，再给你一个完整一点的说法…',
  ],
  byTopic: {
    peach: [
      '我看看你的桃花节奏，想一想怎么说得更清楚…',
      '我把你说的这些和感情这块的命盘信息合在一起想一想…',
    ],
    marriage: [
      '我对照一下婚姻这块的运势，再慢慢跟你说…',
      '我看看你们的关系走势，整理一下再告诉你…',
    ],
    career: [
      '我对照一下事业这块的命盘，理一理思路…',
      '我把你的事业方向和命盘信息对一下…',
    ],
    wealth: [
      '我看看你的财运节奏，整理一下再告诉你…',
      '我把财富这块的命盘信息理一理…',
    ],
    family: [
      '我对照一下家庭这块的运势，再慢慢跟你说…',
      '我看看家庭关系的命盘信息，整理一下…',
    ],
    rhythm: [
      '我对照一下你最近的运势节奏，理一理思路…',
      '我把时间节点和命盘信息对一下…',
    ],
  },
};
```

**文案选择逻辑**:
```typescript
const getThinkingMessage = (topic: TopicKey | null): string => {
  if (topic && THINKING_MESSAGES.byTopic[topic]) {
    const messages = THINKING_MESSAGES.byTopic[topic];
    return messages[Math.floor(Math.random() * messages.length)];
  }
  const messages = THINKING_MESSAGES.default;
  return messages[Math.floor(Math.random() * messages.length)];
};
```

**动效**:
- 文案后面加一个轻微跳动的 `…` 动画
- 使用 `Animated` API 实现三个点的逐帧闪烁
- 节奏: 1 秒循环，不要太快
- 保持安静、不焦虑的感觉，避免「急促 loading」感

**实现示例**:
```typescript
// 思考中气泡组件
const ThinkingBubble: React.FC<{ message: string }> = ({ message }) => {
  const dotOpacity = useRef(new Animated.Value(0.3)).current;

  useEffect(() => {
    const animation = Animated.loop(
      Animated.sequence([
        Animated.timing(dotOpacity, {
          toValue: 1,
          duration: 500,
          easing: Easing.inOut(Easing.ease),
          useNativeDriver: true,
        }),
        Animated.timing(dotOpacity, {
          toValue: 0.3,
          duration: 500,
          easing: Easing.inOut(Easing.ease),
          useNativeDriver: true,
        }),
      ])
    );
    animation.start();
    return () => animation.stop();
  }, []);

  return (
    <View style={styles.thinkingBubbleContainer}>
      <Avatar size={40} />
      <View style={styles.thinkingBubble}>
        <Text style={styles.thinkingText}>
          {message}
          <Animated.Text style={{ opacity: dotOpacity }}>…</Animated.Text>
        </Text>
      </View>
    </View>
  );
};
```

**移除时机**:
- 当 LLM 返回后：
  - `status` 从 `'loading'` → `'idle'`
  - 移除思考中气泡
  - 插入真实的 assistant 消息

---

#### 4.2.4 追问建议区（Follow-ups）

**位置**: 消息列表下方，底部输入框上方

**展示条件**:
- `messages` 中至少有一条 `assistant` 消息
- `status !== 'loading'`（等待状态时不显示，或显示但按钮禁用）

**样式**:
- 背景: `colors.bg`（白色）
- 内边距: 左右 `spacing.md`，上下 `spacing.sm`
- 顶部间距: `spacing.md`

**标题**:
- 文案: 「你可以接着问：」
- 字体大小: `fontSizes.xs`
- 文字颜色: `colors.textSecondary`
- 底部间距: `spacing.sm`

**问题列表**:
- 布局: 水平滚动或换行布局
- 问题项样式:
  - 背景: `colors.blueSoftBg`
  - 文字颜色: `colors.ink`
  - 圆角: `radius.pill`
  - 内边距: 左右 `spacing.md`，上下 `spacing.xs`
  - 字体大小: `fontSizes.sm`
  - 右侧间距: `spacing.sm`
  - 底部间距: `spacing.sm`
  - 点击反馈: `activeOpacity: 0.7`
  - 禁用状态:
    - 背景: `colors.disabledBg`
    - 文字颜色: `colors.disabledText`
    - 不可点击

**问题来源**:
- 优先使用 LLM 返回的 `follow_ups`
- 如果没有，使用前端配置的 `FOLLOW_UP_BY_TOPIC[topic]` 模板

**追问配置**:
```typescript
const FOLLOW_UP_BY_TOPIC: Record<TopicKey, string[]> = {
  peach: [
    '最近桃花运怎么样？',
    '我适合怎样的恋爱节奏？',
    '这一两年适合多社交吗？',
  ],
  marriage: [
    '我和伴侣的关系未来会如何发展？',
    '如何改善我们的沟通方式？',
    '这段关系需要注意什么？',
  ],
  career: [
    '我适合什么样的工作方向？',
    '最近适合换工作吗？',
    '事业发展有什么需要注意的？',
  ],
  wealth: [
    '最近财运如何，有没有赚钱机会？',
    '投资理财需要注意什么？',
    '什么时候容易破财？',
  ],
  family: [
    '和家人相处需要注意什么？',
    '亲子关系如何改善？',
    '家庭氛围会如何变化？',
  ],
  rhythm: [
    '最近几年的运势节奏如何？',
    '什么时候是关键转折点？',
    '需要注意哪些时间节点？',
  ],
};
```

**交互**:
- 点击追问按钮：
  - 新增 `user` 消息（问题文本）
  - 更新状态为 `loading`
  - 展示「思考中」气泡
  - 调用 LLM
  - 清空追问建议区（等待新回复）

**等待状态下的行为**:
- 方案 A（推荐，简单可控）:
  - 当 `status === 'loading'` 时：
    - 追问按钮 `disabled`
    - 按钮样式变为禁用状态
- 方案 B（后续迭代）:
  - 发送消息进入「队列」，允许连续提问
  - 首版不建议，先用方案 A

---

#### 4.2.5 底部输入框（Composer）

**位置**: 页面最底部

**样式**:
- 背景: `colors.bg`（白色）
- 顶部边框: `colors.border`（1px）
- 内边距: 左右 `spacing.md`，上下 `spacing.sm`
- 安全区域: 底部 `safeArea.bottom`

**布局**:
- 水平排列，输入框在左，发送按钮在右
- 输入框和发送按钮垂直居中对齐

**输入框样式**:
- 背景: `colors.cardBg`（白色）
- 圆角: `radius.pill`
- 边框: `colors.border`（1px）
- 内边距: 左右 `spacing.md`，上下 `spacing.sm`
- 最小高度: `44dp`
- 最大高度: `120dp`（约 5 行）
- 多行支持: 是（`multiline: true`）
- 字体大小: `fontSizes.sm`
- 文字颜色: `colors.ink`
- 占位符颜色: `colors.textSecondary`
- 占位符文案: 「输入你的问题…」
- 聚焦状态:
  - 边框颜色: `colors.brandBlue`
  - 键盘正常弹出

**发送按钮样式**:
- 背景: `colors.brandBlue`
- 文字颜色: 白色
- 图标: `Send` 或 `MessageCircle`（lucide-react）
- 图标大小: `20 x 20dp`
- 按钮大小: `44 x 44dp`（圆形）
- 圆角: `radius.pill`
- 左侧间距: `spacing.sm`
- 点击反馈: `activeOpacity: 0.8`
- 禁用状态:
  - 背景: `colors.disabledBg`
  - 图标颜色: `colors.disabledText`
  - 不可点击

**交互**:
- 用户输入时：
  - 支持多行（自动换行）
  - 输入框高度自适应（最多 5 行，超出滚动）
- 点击发送按钮：
  - 校验：文本不能为空
  - 若为空：不执行任何操作（可选：轻微震动提示）
  - 若非空：
    - 追加 `user` 消息
    - 设置 `status = 'loading'`
    - 展示「思考中」气泡
    - 调用 LLM
    - 清空输入框
    - 收起键盘（可选）

**等待状态下的输入行为**:
- 方案 A（推荐，简单可控）:
  - 当 `status === 'loading'` 时：
    - 发送按钮 `disabled`
    - 输入框仍可输入（先打草稿）
    - 点击发送无效（可选：轻微震动提示）
- 方案 B（后续迭代）:
  - 发送消息进入「队列」，允许连续提问
  - 首版不建议，先用方案 A

---

#### 4.2.6 错误提示（Error Toast）

**展示条件**: 当 `status === 'error'` 时

**位置**: 页面底部，输入框上方

**样式**:
- 背景: `colors.orangeSoftBg`（浅橘底）
- 文字颜色: `colors.ink`
- 圆角: `radius.md`
- 内边距: 左右 `spacing.md`，上下 `spacing.sm`
- 左右边距: `spacing.md`
- 底部间距: `spacing.sm`
- 字体大小: `fontSizes.sm`
- 行高: `lineHeights.normal`

**文案配置**:
```typescript
const ERROR_MESSAGES = [
  '刚刚连线有点不稳定，小佩这次没接上，再试一次好吗？',
  '这一次没有成功拿到结果，你可以稍后再问我一次。',
  '网络有点波动，小佩暂时没收到，再发一次试试？',
];
```

**交互**:
- 显示错误提示
- 提供「重试」按钮（可选）:
  - 文案: 「重试」
  - 样式: 小按钮，`colors.brandBlue` 背景，白色文字
  - 点击行为: 将上一条 `user` 消息再次发送
- 自动恢复: 3 秒后自动将 `status` 恢复为 `'idle'`，允许用户自由操作

---

## 交互流程

### 5.1 页面进入流程（首轮调用）

1. **从入口跳转**
   - 小佩主页 / 命盘总览 / 神煞弹窗等入口跳转
   - 传递路由参数：`topic`, `question`, `source`, `masterId` 等

2. **ChatPage 初始化**
   - 读取路由参数
   - 获取当前命主信息（如果需要）
   - 如果有 `conversationId`，加载历史消息
   - 如果没有 `conversationId`，创建新会话

3. **首轮消息处理**
   - 如果有 `question` 参数：
     - 写入第一条 `user` 消息（入口问题）
     - 将 `status` 置为 `'loading'`
     - 展示「思考中」气泡
     - 调用 LLM：
       ```typescript
       callChatLLM({
         masterId,
         topic,
         conversationId,
         messages: [{ role: 'user', content: question }],
         entrySource: source,
         sectionKey,      // 可选
         shenShaCode,     // 可选
         pillarType,      // 可选
       });
       ```
   - 如果没有 `question` 参数：
     - 显示空状态
     - 等待用户输入

4. **LLM 响应处理**
   - **成功**:
     - 写入新的 `assistant` 消息（answer）
     - 更新追问建议（优先用 LLM 返回的 `follow_ups`）
     - `status = 'idle'`
     - 移除「思考中」气泡
   - **失败**:
     - `status = 'error'`
     - 显示错误提示
     - 移除「思考中」气泡

---

### 5.2 多轮对话流程

1. **用户发送新消息**
   - 用户输入问题
   - 点击发送按钮

2. **消息处理**
   - 追加 `user` 消息到列表
   - 设置 `status = 'loading'`
   - 展示「思考中」气泡
   - 清空输入框
   - 禁用发送按钮和追问按钮

3. **调用 LLM**
   - 带上最近 N 条历史消息（建议最近 10 条）
   - 带上命主信息
   - 调用 LLM API

4. **响应处理**
   - 同首轮调用的响应处理

---

### 5.3 追问按钮点击流程

1. **用户点击追问按钮**
   - 获取问题文本

2. **消息处理**
   - 追加 `user` 消息（问题文本）
   - 设置 `status = 'loading'`
   - 展示「思考中」气泡
   - 清空追问建议区（等待新回复）

3. **调用 LLM**
   - 同多轮对话流程

---

### 5.4 错误处理流程

1. **LLM 调用失败**
   - `status = 'error'`
   - 移除「思考中」气泡
   - 显示错误提示

2. **用户操作**
   - 点击「重试」按钮（如果提供）:
     - 将上一条 `user` 消息再次发送
     - 重新调用 LLM
   - 或手动输入新问题:
     - 自动恢复 `status = 'idle'`
     - 允许正常发送

---

## 技术实现

### 6.1 组件结构

```
src/
  screens/
    Chat/
      index.tsx                    # 主组件导出
      ChatScreen.tsx               # 聊天页主组件
      components/
        ChatHeader.tsx             # 顶部栏组件
        MessageList.tsx            # 消息列表组件
        MessageBubble.tsx          # 消息气泡组件
        UserBubble.tsx             # 用户消息气泡
        AssistantBubble.tsx        # 小佩消息气泡
        ThinkingBubble.tsx         # 思考中气泡组件
        FollowUpSuggestions.tsx    # 追问建议组件
        ChatComposer.tsx           # 底部输入框组件
        ErrorToast.tsx             # 错误提示组件
      hooks/
        useChatMessages.ts         # 消息管理 Hook
        useChatLLM.ts              # LLM 调用 Hook
        useThinkingMessage.ts      # 思考中文案 Hook
      constants/
        thinkingMessages.ts        # 思考中文案配置
        followUpQuestions.ts       # 追问问题配置
      types.ts                     # 类型定义
```

---

### 6.2 组件接口

#### 6.2.1 ChatScreen 主组件

```typescript
interface ChatScreenProps {
  navigation: NavigationProp<RootStackParamList>;
  route: RouteProp<RootStackParamList, 'Chat'>;
}
```

#### 6.2.2 消息气泡组件

```typescript
interface MessageBubbleProps {
  message: ChatMessage;
  isUser: boolean;
}

interface ThinkingBubbleProps {
  message: string;
  topic: TopicKey | null;
}
```

#### 6.2.3 追问建议组件

```typescript
interface FollowUpSuggestionsProps {
  questions: string[];
  onQuestionClick: (question: string) => void;
  disabled?: boolean;
}
```

#### 6.2.4 输入框组件

```typescript
interface ChatComposerProps {
  onSend: (text: string) => void;
  disabled?: boolean;
  placeholder?: string;
}
```

---

### 6.3 状态管理

#### 6.3.1 本地状态

```typescript
const [messages, setMessages] = useState<ChatMessage[]>([]);
const [status, setStatus] = useState<ChatStatus>('idle');
const [inputText, setInputText] = useState('');
const [conversationId, setConversationId] = useState<string | null>(null);
const [followUps, setFollowUps] = useState<string[]>([]);
```

#### 6.3.2 状态更新逻辑

```typescript
// 发送消息
const handleSendMessage = async (text: string) => {
  if (!text.trim() || status === 'loading') return;

  // 1. 添加用户消息
  const userMessage: ChatMessage = {
    id: generateId(),
    conversationId: conversationId || 'temp',
    role: 'user',
    text: text.trim(),
    createdAt: new Date().toISOString(),
  };
  setMessages(prev => [...prev, userMessage]);

  // 2. 设置加载状态
  setStatus('loading');

  // 3. 调用 LLM
  try {
    const response = await callChatLLM({
      masterId: route.params?.masterId || currentMasterId,
      topic: route.params?.topic || null,
      conversationId,
      messages: [...messages, userMessage].slice(-10), // 最近 10 条
      entrySource: route.params?.source || 'xiaopei_free_input',
    });

    // 4. 添加助手消息
    const assistantMessage: ChatMessage = {
      id: generateId(),
      conversationId: response.conversationId,
      role: 'assistant',
      text: response.answer,
      createdAt: new Date().toISOString(),
    };
    setMessages(prev => [...prev, assistantMessage]);

    // 5. 更新追问建议
    setFollowUps(response.follow_ups || []);

    // 6. 更新会话 ID
    if (response.conversationId) {
      setConversationId(response.conversationId);
    }

    // 7. 恢复空闲状态
    setStatus('idle');
  } catch (error) {
    // 8. 错误处理
    setStatus('error');
    setErrorMessage(error.message || '请求失败');
  }
};
```

---

### 6.4 API 接口

#### 6.4.1 调用 LLM

**接口**: `POST /api/chat/message`

**请求参数**:
```typescript
interface CallChatLLMRequest {
  masterId: string;                // 命主 ID
  topic?: TopicKey | null;         // 话题
  conversationId?: string | null;  // 会话 ID（新会话时为 null）
  messages: Array<{                // 消息历史（最近 N 条）
    role: 'user' | 'assistant';
    content: string;
  }>;
  entrySource: ChatEntrySource;    // 入口来源
  sectionKey?: string;             // 命盘总览一键解读的 sectionKey
  shenShaCode?: string;            // 神煞代码
  pillarType?: string;             // 柱位类型
}
```

**响应**:
```typescript
interface CallChatLLMResponse {
  conversationId: string;          // 会话 ID
  answer: string;                  // LLM 回复
  follow_ups?: string[];           // 追问建议（可选）
  meta?: {
    tokens?: number;               // Token 使用量（可选）
    model?: string;                // 使用的模型（可选）
  };
}
```

---

### 6.5 路由配置

**路由名称**: `Chat`（驼峰命名，与现有文档一致）

**路由参数**: 见 3.2.1 节 `ChatRouteParams`

**导航示例**:
```typescript
// 从小佩主页跳转
navigation.navigate('Chat', {
  topic: 'peach',
  question: '想从「桃花 · 恋爱」这个角度，先帮我整体看看好吗？',
  source: 'xiaopei_topic_button',
  masterId: currentMasterId,
  uiVariant: 'love',
});

// 从命盘总览一键解读跳转
navigation.navigate('Chat', {
  topic: null,
  question: '幫我解讀一下這張命盤的整體體質、起伏感。',
  source: 'overview_card',
  masterId: currentMasterId,
  sectionKey: 'body',
});

// 从神煞弹窗跳转
navigation.navigate('Chat', {
  topic: null,
  question: '亡神對我的影響是什麼？',
  source: 'shen_sha_popup',
  masterId: currentMasterId,
  shenShaCode: 'wang_shen',
  pillarType: 'month',
});
```

---

## 设计规范

### 7.1 遵循 UI 设计系统

本页面严格遵循 `UI_SPEC.md` 中定义的设计规范：

- **颜色**: 使用 `colors` Design Tokens
- **字体**: 使用 `typography` Design Tokens
- **间距**: 使用 `layout.spacing` Design Tokens
- **圆角**: 使用 `layout.radius` Design Tokens
- **阴影**: 使用 `layout.shadows` Design Tokens

---

### 7.2 消息气泡样式规范

**用户消息气泡**:
- 背景: `colors.ink`（深色）
- 文字颜色: 白色
- 对齐: 右对齐
- 圆角: 右下角直角，其余圆角

**小佩消息气泡**:
- 背景: `colors.disabledBg`（浅灰色）
- 文字颜色: `colors.ink`
- 对齐: 左对齐
- 圆角: 左下角直角，其余圆角
- 头像: 使用官方 Logo 头像版本（遵循 `UI_SPEC.md`）

---

### 7.3 等待状态设计原则

- **安静、不焦虑**: 避免急促的 loading 动画
- **拟人化表达**: 使用「小佩在想」「我对一下命盘」等表达
- **避免系统化**: 不使用「请稍候」「正在加载」等系统化提示
- **节奏慢**: 动画节奏 1 秒循环，不要太快

---

### 7.4 错误处理设计原则

- **温和提示**: 不吓人、不打断体验
- **可恢复**: 提供重试机制或允许用户继续操作
- **不阻塞**: 错误状态自动恢复，不阻塞用户

---

## 不同入口下的 UI 差异

### 8.1 小佩主页 → 话题按钮

**Props**:
- `topic = 'peach'`
- `source = 'xiaopei_topic_button'`
- `uiVariant = 'love'`

**等待文案**: 从 `THINKING_MESSAGES.byTopic.peach` 随机选择

---

### 8.2 小佩主页 → 大家常问

**Props**:
- `topic = 'peach'`（默认话题）
- `source = 'xiaopei_common_question'`
- `uiVariant = 'love'`

**等待文案**: 从 `THINKING_MESSAGES.byTopic.peach` 随机选择

---

### 8.3 小佩主页 → 自由输入

**Props**:
- `topic = null`
- `source = 'xiaopei_free_input'`
- `uiVariant = 'default'`

**等待文案**: 从 `THINKING_MESSAGES.default` 随机选择

---

### 8.4 命盘总览 → 一键解读

**Props**:
- `topic = null`
- `source = 'overview_card'`
- `sectionKey = 'body' | 'pattern' | 'useful_god' | ...`
- `uiVariant = 'default'`

**等待文案**: 从 `THINKING_MESSAGES.default` 随机选择

**特殊处理**:
- 首轮问题自动发送（不需要用户点击发送）
- 问题文本来自 `OverviewCardConfig.defaultQuestion`

---

### 8.5 神煞弹窗 → 推荐提问

**Props**:
- `topic = null`
- `source = 'shen_sha_popup'`
- `shenShaCode = 'wang_shen'`
- `pillarType = 'month'`
- `uiVariant = 'default'`

**等待文案**: 从 `THINKING_MESSAGES.default` 随机选择

**特殊处理**:
- 首轮问题自动发送（不需要用户点击发送）
- 问题文本来自用户点击的推荐提问

---

## 语气与体验

### 9.1 等待状态语气

**原则**:
- 等待态不能做成「系统报错」感觉（红色、高度警示）
- 安静、节奏慢
- 让用户知道：「我听见了，正在认真想」，而不是「系统卡住了」

**避免的文案**:
- 「请稍候」
- 「正在加载」
- 「请求中」
- 「网络异常」
- 「系统忙」

**倾向的文案**:
- 「小佩在想」
- 「我对一下命盘」
- 「我理一理」
- 「我看看你的…」
- 「我对照一下…」

---

### 9.2 错误状态语气

**原则**:
- 温和、不吓人
- 提供解决方案
- 保持小佩的人设

**错误文案示例**:
- 「刚刚连线有点不稳定，小佩这次没接上，再试一次好吗？」
- 「这一次没有成功拿到结果，你可以稍后再问我一次。」
- 「网络有点波动，小佩暂时没收到，再发一次试试？」

---

## 与入口页面的对接

### 10.1 从小佩主页进入

**参数传递**:
```typescript
navigation.navigate('Chat', {
  topic: payload.topic,
  question: payload.question,
  source: payload.source,
  masterId: payload.masterId,
  uiVariant: payload.topic ? TOPICS[payload.topic].uiVariant : 'default',
});
```

**首轮处理**:
- 自动添加用户消息
- 自动调用 LLM
- 自动显示「思考中」气泡

---

### 10.2 从命盘总览进入

**参数传递**:
```typescript
navigation.navigate('Chat', {
  topic: null,
  question: cardConfig.defaultQuestion,
  source: 'overview_card',
  masterId: currentChartId,
  sectionKey: cardConfig.sectionKey,
  uiVariant: 'default',
});
```

**首轮处理**:
- 自动添加用户消息
- 自动调用 LLM（使用 `sectionKey` 对应的 prompt）
- 自动显示「思考中」气泡

---

### 10.3 从神煞弹窗进入

**参数传递**:
```typescript
navigation.navigate('Chat', {
  topic: null,
  question: selectedQuestion,
  source: 'shen_sha_popup',
  masterId: currentChartId,
  shenShaCode: currentShenSha.code,
  pillarType: currentShenSha.pillarType,
  uiVariant: 'default',
});
```

**首轮处理**:
- 自动添加用户消息
- 自动调用 LLM（使用神煞相关的 prompt）
- 自动显示「思考中」气泡

---

## 历史对话管理方案

### 10.1 管理策略

**采用集中管理方案（方案 A）**:

- **历史对话列表**: 统一放在「我的 → 聊天记录」页面管理
- **ChatPage 职责**: 只负责当前会话的消息展示和交互，不管理历史对话列表
- **第一期实现**: 仅实现集中管理页面，支持查看和删除历史对话

---

### 10.2 第一期实现（MVP）

#### 10.2.1 「我的 → 聊天记录」页面

**功能**:
- 展示所有历史对话列表
- 支持点击进入历史对话（跳转到 ChatPage，加载对应会话）
- 支持删除历史对话（左滑删除或长按删除）

**实现位置**: 参考 `我的-二级-内容查看页面设计文档.md` 中的「聊天记录页面」设计

**与 ChatPage 的关系**:
- 从「聊天记录」页面点击某条历史对话 → 跳转到 ChatPage
- 传递参数: `conversationId`（会话 ID）
- ChatPage 根据 `conversationId` 加载历史消息

---

#### 10.2.2 ChatPage 的实现

**不实现的功能**:
- ❌ 不实现抽屉或侧边栏
- ❌ 不实现历史对话列表展示
- ❌ 不实现左滑打开历史列表

**只负责**:
- ✅ 当前会话的消息展示
- ✅ 当前会话的消息发送和接收
- ✅ 当前会话的追问建议

**顶部栏右侧预留**:
- 预留图标位置（隐藏，不显示）
- 为后续扩展做准备

---

### 10.3 后续扩展计划（第二期）

**如果用户对历史会话的需求增加，再实现以下功能**:

#### 10.3.1 历史快捷入口

**位置**: ChatPage 顶部栏右侧

**功能**:
- 显示历史图标按钮
- 点击后弹出 Bottom Sheet
- 显示最近 5-10 条会话（简化版）
- 支持快速切换会话

**实现时机**: 根据用户反馈和数据分析决定是否实现

---

### 10.4 与「我的 → 聊天记录」页面的对接

**从「聊天记录」页面进入 ChatPage**:

```typescript
// 在「聊天记录」页面
navigation.navigate('Chat', {
  conversationId: conversation.id,  // 历史会话 ID
  masterId: conversation.masterId,
  topic: conversation.topic,
  source: 'history',
});
```

**ChatPage 接收历史会话**:

```typescript
// 在 ChatPage 中
useEffect(() => {
  const { conversationId } = route.params || {};
  
  if (conversationId) {
    // 加载历史会话消息
    loadConversation(conversationId);
  } else {
    // 新会话，不加载历史消息
  }
}, [route.params?.conversationId]);
```

---

## 后续扩展点（预留）

### 11.1 流式渲染

- 支持 LLM 流式返回
- 实时更新消息内容
- 「思考中」气泡在流式开始时移除

---

### 11.2 消息队列

- 支持连续发送多条消息
- 消息排队处理
- 显示队列状态

---

### 11.3 消息操作

- 复制消息
- 重新发送
- 删除消息（可选）

---

### 11.4 语音输入

- 支持语音转文字
- 语音输入按钮
- 语音播放（小佩回复）

---

### 11.5 历史快捷入口（第二期）

- 在 ChatPage 顶部栏右侧显示历史图标
- 点击后弹出最近会话 Bottom Sheet
- 支持快速切换会话
- 详见「历史对话管理方案」章节

---

### 11.6 消息搜索（预留）

- 在当前会话内搜索消息
- 按时间筛选
- 按关键词搜索

---

## 待确认事项

- [ ] 思考中气泡的动画效果（三个点闪烁 vs 其他动画）
- [ ] 等待状态下是否允许输入（方案 A vs 方案 B）
- [ ] 追问建议的数量（3 个 vs 4 个）
- [ ] 错误提示的显示时长（3 秒 vs 其他）
- [ ] 是否需要支持消息编辑
- [ ] 是否需要支持消息删除
- [ ] 是否需要支持语音输入
- [x] 历史对话管理方案（已确认：采用集中管理，第一期只实现「我的 → 聊天记录」页面）
- [ ] 是否需要支持消息搜索（当前会话内）
- [ ] 是否需要支持消息分享
- [ ] 第二期是否实现历史快捷入口（根据用户反馈决定）

---

## 更新记录

- **创建日期**: 2024年11月
- **文档版本**: v3.1.0
- **最后更新**: 2024年11月
- **更新内容**: 
  - v3.0.0: 初始版本，完成聊天页的完整设计，包含等待状态、错误处理、多入口支持等全部内容
  - v3.1.0: 明确历史对话管理方案（集中管理），明确 ChatPage 只负责当前会话，顶部栏右侧预留历史快捷入口位置，明确与「我的 → 聊天记录」页面的对接约定
- **维护者**: 开发团队

