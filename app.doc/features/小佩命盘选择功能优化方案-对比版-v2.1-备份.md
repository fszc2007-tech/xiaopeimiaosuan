# å°ä½©å‘½ç›˜é€‰æ‹©åŠŸèƒ½ä¼˜åŒ–æ–¹æ¡ˆï¼ˆå¯¹æ¯”ç‰ˆï¼‰

> **ç‰ˆæœ¬**: v2.0  
> **åˆ›å»ºæ—¥æœŸ**: 2024å¹´12æœˆ  
> **çŠ¶æ€**: å¾…å®ç°  
> **é€‚ç”¨èŒƒå›´**: å°ä½© App ä¸»é¡µåœºæ™¯å¡ç‰‡åˆ†æåŠŸèƒ½ä¼˜åŒ–

---

## ğŸ“‹ æ–¹æ¡ˆæ‘˜è¦

åŸºäºæ–°æ–¹æ¡ˆè¦æ±‚ï¼Œå¯¹å½“å‰å°ä½©ä¸»é¡µçš„6ä¸ªåœºæ™¯å¡ç‰‡è¿›è¡Œä¼˜åŒ–ï¼Œä¸»è¦æ¶‰åŠï¼š

1. **æ–°å¢ã€Œå½“å‰å‘½ç›˜ã€ç»„ä»¶**ï¼ˆæ›¿æ¢ç°æœ‰çš„ã€Œå½“å‰å‘½ä¸»ä¿¡æ¯å¡ç‰‡ã€ï¼‰
2. **ä¼˜åŒ– topic æšä¸¾æ˜ å°„**ï¼ˆä»ä¸­æ–‡ key â†’ è‹±æ–‡æšä¸¾ï¼‰
3. **ä¼˜åŒ–é»˜è®¤é—®é¢˜æ–‡æ¡ˆ**ï¼ˆæ›´å…·ä½“ã€æ›´ç¬¦åˆåœºæ™¯ï¼‰
4. **ç»Ÿä¸€çŠ¶æ€ç®¡ç†**ï¼ˆä½¿ç”¨ `currentChartId` è€Œéå®Œæ•´å¯¹è±¡ï¼‰
5. **ç»Ÿä¸€æ¥å£è°ƒç”¨**ï¼ˆæ‰€æœ‰åœºæ™¯å¡ç‰‡ç»Ÿä¸€è°ƒç”¨ `/api/v1/xiaopei/analyze`ï¼‰

---

## ä¸€ã€å½“å‰å®ç° vs æ–°æ–¹æ¡ˆå¯¹æ¯”

### 1.1 çŠ¶æ€ç®¡ç†å¯¹æ¯”

| ç»´åº¦ | å½“å‰å®ç° | æ–°æ–¹æ¡ˆ | ä¼˜åŒ–å»ºè®® |
|------|---------|--------|---------|
| **çŠ¶æ€å­—æ®µ** | `currentChart: ChartProfile \| null`ï¼ˆå®Œæ•´å¯¹è±¡ï¼‰ | `currentChartId: string \| null`ï¼ˆä»…IDï¼‰ | âœ… **å•ä¸€çœŸç›¸ï¼šåªæŒä¹…åŒ– `currentChartId`** |
| **å­˜å‚¨ä½ç½®** | `useChartStore` | `useChartStore` | âœ… æ‰©å±•ç°æœ‰ store |
| **æŒä¹…åŒ–** | âŒ æœªæŒä¹…åŒ– | âœ… éœ€è¦æŒä¹…åŒ– | âœ… ä½¿ç”¨ `persist` middleware |

**ä¼˜åŒ–ç­–ç•¥ï¼ˆé‡è¦ï¼‰**:
- **å•ä¸€çœŸç›¸æº**ï¼šå…¨å±€çŠ¶æ€åªå­˜ `currentChartId` å’Œ `charts` åˆ—è¡¨
- **è®¡ç®—å±æ€§**ï¼š`currentChart` é€šè¿‡ `charts + currentChartId` åŠ¨æ€è®¡ç®—ï¼Œä¸å•ç‹¬å­˜å‚¨
- **é¿å…åŒæ­¥é—®é¢˜**ï¼šä¸ä¼šå‡ºç°ã€ŒID æ”¹äº†ã€å¯¹è±¡æ²¡æ”¹ã€è¿™ç§ä¸åŒæ­¥é—®é¢˜
- **ç®€åŒ–æŒä¹…åŒ–**ï¼šlocalStorage åªå­˜ä¸€ä¸ª stringï¼Œç®€å•ç›´æ¥
- **ç®€åŒ–æ“ä½œ**ï¼šåˆ é™¤å‘½ç›˜ / åˆ‡æ¢å‘½ç›˜æ—¶ï¼Œåªæ”¹ä¸€ä¸ªå­—æ®µï¼Œä¸ç”¨åˆ°å¤„åŒæ­¥

**å®ç°æ–¹å¼**:
```typescript
// âŒ é”™è¯¯ï¼šåŒæ—¶ç»´æŠ¤ä¸¤ä»½çœŸç›¸
interface ChartState {
  currentChart: ChartProfile | null;  // ä¸è¦å•ç‹¬å­˜å‚¨
  currentChartId: string | null;
}

// âœ… æ­£ç¡®ï¼šå•ä¸€çœŸç›¸æº
interface ChartState {
  charts: ChartProfile[];
  currentChartId: string | null;  // åªå­˜ ID
  // currentChart é€šè¿‡è®¡ç®—å±æ€§è·å–
}

// åœ¨ç»„ä»¶ä¸­ä½¿ç”¨
const currentChart = useMemo(
  () => charts.find(c => c.chartProfileId === currentChartId) ?? null,
  [charts, currentChartId]
);
```

---

### 1.2 Topic æšä¸¾å¯¹æ¯”

| ç»´åº¦ | å½“å‰å®ç° | æ–°æ–¹æ¡ˆ | ä¼˜åŒ–å»ºè®® |
|------|---------|--------|---------|
| **å‰ç«¯ key** | `'peach' \| 'marriage' \| 'career' \| 'wealth' \| 'family' \| 'rhythm'` | `'LOVE' \| 'EXAM' \| 'MARRIAGE' \| 'JOB' \| 'FAMILY' \| 'WEALTH'` | âœ… å»ºç«‹æ˜ å°„è¡¨ï¼Œå‰ç«¯ä»ç”¨ä¸­æ–‡ keyï¼Œå‘é€æ—¶è½¬æ¢ä¸ºè‹±æ–‡ |
| **åç«¯æšä¸¾** | æœªç»Ÿä¸€ | `LOVE / EXAM / MARRIAGE / JOB / FAMILY / WEALTH` | âœ… åç«¯ç»Ÿä¸€ä½¿ç”¨è‹±æ–‡æšä¸¾ |
| **æ˜ å°„å…³ç³»** | æ—  | éœ€è¦æ˜ å°„ | âœ… åˆ›å»º `TOPIC_META` é…ç½®è¡¨ |

**æ—§ key â†’ æ–°æšä¸¾å¯¹åº”è¡¨ï¼ˆç¡¬çº¦å®šï¼‰**:

| æ—§ keyï¼ˆå½“å‰ä»£ç é‡Œçš„ï¼‰ | æ–°æšä¸¾ï¼ˆå‘ç»™åç«¯ï¼‰ | ä¸­æ–‡æ ‡é¢˜ | è¯´æ˜ |
|---------------------|-----------------|---------|------|
| `peach` | `LOVE` | æ‹çˆ±Â·æ¡ƒèŠ± | ä¿æŒç°æœ‰ key |
| `rhythm` | `EXAM` | è€ƒç ”Â·è€ƒå…¬ | ä¿æŒç°æœ‰ key |
| `marriage` | `MARRIAGE` | ç»“å©šÂ·å©šå§» | ä¿æŒç°æœ‰ key |
| `career` | `JOB` | å·¥ä½œÂ·è·³æ§½ | ä¿æŒç°æœ‰ key |
| `family` | `FAMILY` | å©†åª³Â·å…³ç³» | ä¿æŒç°æœ‰ key |
| `wealth` | `WEALTH` | æŠ•èµ„Â·ç†è´¢ | ä¿æŒç°æœ‰ key |

**æ³¨æ„**: æ­¤æ˜ å°„è¡¨ä¸ºç¡¬çº¦å®šï¼Œä¸å…è®¸éšæ„ä¿®æ”¹ã€‚å¦‚éœ€æ–°å¢ topicï¼Œå¿…é¡»åŒæ—¶æ›´æ–°æ­¤è¡¨å’Œ `TOPIC_META` é…ç½®ã€‚

**æ˜ å°„è¡¨è®¾è®¡**:
```typescript
// å‰ç«¯å†…éƒ¨ä»ä½¿ç”¨ä¸­æ–‡ keyï¼ˆä¿æŒç°æœ‰ä»£ç å…¼å®¹ï¼‰
type TopicKey = 'peach' | 'marriage' | 'career' | 'wealth' | 'family' | 'rhythm';

// åç«¯æšä¸¾ï¼ˆè‹±æ–‡ï¼‰
type TopicEnum = 'LOVE' | 'EXAM' | 'MARRIAGE' | 'JOB' | 'FAMILY' | 'WEALTH';

// æ˜ å°„é…ç½®ï¼ˆå•ä¸€çœŸç›¸æºï¼‰
const TOPIC_META: Record<TopicKey, {
  enum: TopicEnum;
  title: string;
  subtitleTags: string[];
  defaultQuestion: string;
}> = {
  peach: {
    enum: 'LOVE',
    title: 'æ‹çˆ±Â·æ¡ƒèŠ±',
    subtitleTags: ['å¿ƒåŠ¨', 'æš§æ˜§', 'å†·æˆ˜'],
    defaultQuestion: 'åŸºäºå½“å‰å‘½ç›˜ï¼Œå¸®æˆ‘è§£è¯»ä¸€ä¸‹æœ€è¿‘çš„æ‹çˆ±æ¡ƒèŠ±å’Œæ„Ÿæƒ…è¿åŠ¿ã€‚'
  },
  rhythm: {
    enum: 'EXAM',
    title: 'è€ƒç ”Â·è€ƒå…¬',
    subtitleTags: ['æ‹©æ ¡', 'å¤‡è€ƒ', 'ä¸Šå²¸'],
    defaultQuestion: 'åŸºäºå½“å‰å‘½ç›˜ï¼Œå¸®æˆ‘çœ‹çœ‹è€ƒç ”/è€ƒå…¬ç›¸å…³çš„æ•´ä½“å­¦ä¸šå’Œè€ƒè¯•è¿åŠ¿ã€‚'
  },
  marriage: {
    enum: 'MARRIAGE',
    title: 'ç»“å©šÂ·å©šå§»',
    subtitleTags: ['å©šæœŸ', 'å½©ç¤¼', 'çŸ›ç›¾'],
    defaultQuestion: 'åŸºäºå½“å‰å‘½ç›˜ï¼Œå¸®æˆ‘çœ‹çœ‹å©šå§»ç›¸å…³çš„è¿åŠ¿ï¼Œæ¯”å¦‚ç»“å©šèŠ‚å¥ã€å©šå§»ç¨³å®šåº¦ã€‚'
  },
  career: {
    enum: 'JOB',
    title: 'å·¥ä½œÂ·è·³æ§½',
    subtitleTags: ['æ¶¨è–ª', 'ç¦»èŒ', 'æ–¹å‘'],
    defaultQuestion: 'åŸºäºå½“å‰å‘½ç›˜ï¼Œå¸®æˆ‘çœ‹çœ‹å·¥ä½œå’Œè·³æ§½æ–¹é¢çš„è¿åŠ¿ä¸æœºä¼šã€‚'
  },
  family: {
    enum: 'FAMILY',
    title: 'å©†åª³Â·å…³ç³»',
    subtitleTags: ['å¸¦å¨ƒ', 'çŸ›ç›¾', 'åŒä½'],
    defaultQuestion: 'åŸºäºå½“å‰å‘½ç›˜ï¼Œå¸®æˆ‘çœ‹çœ‹ä¸é•¿è¾ˆ/å©†åª³å…³ç³»çš„ç›¸å¤„å’ŒçŸ›ç›¾æƒ…å†µã€‚'
  },
  wealth: {
    enum: 'WEALTH',
    title: 'æŠ•èµ„Â·ç†è´¢',
    subtitleTags: ['è‚¡ç¥¨', 'åŸºé‡‘', 'ä¹°æˆ¿'],
    defaultQuestion: 'åŸºäºå½“å‰å‘½ç›˜ï¼Œå¸®æˆ‘çœ‹çœ‹è¿‘æœŸçš„è´¢å¯Œã€æŠ•èµ„å’Œç†è´¢è¿åŠ¿ã€‚'
  }
};
```

---

### 1.3 é»˜è®¤é—®é¢˜å¯¹æ¯”

| ç»´åº¦ | å½“å‰å®ç° | æ–°æ–¹æ¡ˆ | ä¼˜åŒ–å»ºè®® |
|------|---------|--------|---------|
| **æ ¼å¼** | `'æƒ³ä»ã€Œxxxã€è¿™ä¸ªè§’åº¦ï¼Œå…ˆå¸®æˆ‘æ•´ä½“çœ‹çœ‹å¥½å—ï¼Ÿ'` | `'åŸºäºå½“å‰å‘½ç›˜ï¼Œå¸®æˆ‘è§£è¯»ä¸€ä¸‹...'` | âœ… ä½¿ç”¨æ–°æ–¹æ¡ˆæ ¼å¼ï¼Œæ›´å…·ä½“ã€æ›´ç¬¦åˆåœºæ™¯ |
| **å†…å®¹** | é€šç”¨æ¨¡æ¿ | æ¯ä¸ªåœºæ™¯æœ‰ä¸“é—¨çš„é—®é¢˜ | âœ… ä½¿ç”¨ `TOPIC_META` ä¸­çš„ `defaultQuestion` |

**ä¼˜åŒ–ç¤ºä¾‹**:
```typescript
// âŒ å½“å‰å®ç°
defaultQuestion: 'æƒ³ä»ã€Œæ‹çˆ±Â·æ¡ƒèŠ±ã€è¿™ä¸ªè§’åº¦ï¼Œå…ˆå¸®æˆ‘æ•´ä½“çœ‹çœ‹å¥½å—ï¼Ÿ'

// âœ… æ–°æ–¹æ¡ˆ
defaultQuestion: 'åŸºäºå½“å‰å‘½ç›˜ï¼Œå¸®æˆ‘è§£è¯»ä¸€ä¸‹æœ€è¿‘çš„æ‹çˆ±æ¡ƒèŠ±å’Œæ„Ÿæƒ…è¿åŠ¿ã€‚'
```

---

### 1.4 å¡ç‰‡ç‚¹å‡»é€»è¾‘å¯¹æ¯”

| ç»´åº¦ | å½“å‰å®ç° | æ–°æ–¹æ¡ˆ | ä¼˜åŒ–å»ºè®® |
|------|---------|--------|---------|
| **å‘½ç›˜æ£€æŸ¥** | æ£€æŸ¥ `currentChart` æ˜¯å¦å­˜åœ¨ | æ£€æŸ¥ `currentChartId` æ˜¯å¦å­˜åœ¨ | âœ… æ”¹ä¸ºæ£€æŸ¥ `currentChartId` |
| **æ— å‘½ç›˜å¤„ç†** | `console.warn`ï¼ˆä»…æ—¥å¿—ï¼‰ | å¼¹çª—æç¤º + å¼•å¯¼åˆ›å»º | âœ… **ç¡¬çº¦å®šï¼šå¿…é¡»å¼¹çª—æ‹¦æˆª** |
| **å‚æ•°ä¼ é€’** | `topic, question, source, masterId` | `topic, chart_id, question` | âœ… ç»Ÿä¸€ä¸º `topic, chart_id, question` |
| **æ¥å£è°ƒç”¨** | æœªç»Ÿä¸€ï¼ˆå¯èƒ½èµ°ä¸åŒæ¥å£ï¼‰ | ç»Ÿä¸€è°ƒç”¨ `/api/v1/xiaopei/analyze` | âœ… ç»Ÿä¸€æ¥å£è°ƒç”¨ |

**ç¡¬çº¦å®šï¼ˆå¿…é¡»éµå®ˆï¼‰**:
> å½“ `currentChartId` ä¸ºç©ºæ—¶ï¼Œç‚¹å‡»ä»»æ„å°ä½©å¡ç‰‡ï¼š
> - âŒ **ä¸å…è®¸**å‘åˆ†æè¯·æ±‚
> - âœ… **å¿…é¡»**å¼¹å‡º"å»åˆ›å»ºå‘½ç›˜"çš„æç¤ºå¼¹çª—
> - âŒ **ä¸å…è®¸**ä½¿ç”¨ `console.warn` ç­‰ä»…æ—¥å¿—æ–¹å¼å¤„ç†

**å½“å‰å®ç°ä»£ç **:
```typescript
// âŒ å½“å‰å®ç°
const handleTopicPress = (topicConfig: TopicConfig) => {
  if (!currentChart) {
    console.warn('No current chart, redirect to create chart');
    return;
  }

  navigation.navigate(SCREEN_NAMES.CHAT as any, {
    topic: topicConfig.key,  // 'peach' | 'marriage' ç­‰
    question: topicConfig.defaultQuestion,
    source: 'topic_button',
    masterId: currentChart.chartProfileId,
  });
};
```

**ä¼˜åŒ–åä»£ç **:
```typescript
// âœ… æ–°æ–¹æ¡ˆ
const handleTopicPress = (topicConfig: TopicConfig) => {
  const { currentChartId } = useChartStore.getState();
  
  if (!currentChartId) {
    // å¼¹çª—æç¤º
    showModal({
      title: 'éœ€è¦å…ˆåˆ›å»ºå‘½ç›˜',
      message: 'éœ€è¦å…ˆåˆ›å»ºå‘½ç›˜æ‰èƒ½å¼€å§‹è§£è¯»',
      buttons: [
        { text: 'å–æ¶ˆ', onPress: () => {} },
        { 
          text: 'å»åˆ›å»ºå‘½ç›˜', 
          onPress: () => navigation.navigate(SCREEN_NAMES.MANUAL_BAZI as any, { 
            returnTo: SCREEN_NAMES.XIAOPEI_HOME 
          })
        }
      ]
    });
    return;
  }

  // è½¬æ¢ä¸ºåç«¯æšä¸¾
  const topicEnum = TOPIC_META[topicConfig.key].enum;
  
  // ç»Ÿä¸€è°ƒç”¨åˆ†ææ¥å£
  navigation.navigate(SCREEN_NAMES.CHAT as any, {
    topic: topicEnum,  // 'LOVE' | 'EXAM' ç­‰
    chart_id: currentChartId,
    question: TOPIC_META[topicConfig.key].defaultQuestion,
    source: 'xiaopei_topic_card',
  });
};
```

---

### 1.5 UI ç»„ä»¶å¯¹æ¯”

| ç»´åº¦ | å½“å‰å®ç° | æ–°æ–¹æ¡ˆ | ä¼˜åŒ–å»ºè®® |
|------|---------|--------|---------|
| **å‘½ç›˜å±•ç¤º** | ã€Œå½“å‰å‘½ä¸»ä¿¡æ¯å¡ç‰‡ã€ï¼ˆä»…å±•ç¤ºï¼‰ | ã€Œå½“å‰å‘½ç›˜ç»„ä»¶ã€ï¼ˆå¯åˆ‡æ¢ï¼‰ | âœ… æ›¿æ¢ä¸ºæ–°çš„ã€Œå½“å‰å‘½ç›˜ç»„ä»¶ã€ |
| **åˆ‡æ¢åŠŸèƒ½** | ç‚¹å‡»ã€Œåˆ‡æ¢ã€è·³è½¬åˆ° Cases é¡µ | åº•éƒ¨å¼¹çª—é€‰æ‹©å™¨ | âœ… å®ç°åº•éƒ¨å¼¹çª—é€‰æ‹©å™¨ |
| **æ— å‘½ç›˜çŠ¶æ€** | ä¸æ˜¾ç¤ºå¡ç‰‡ | æ˜¾ç¤ºã€Œæ— å‘½ç›˜çŠ¶æ€ã€å¡ç‰‡ | âœ… æ–°å¢æ— å‘½ç›˜çŠ¶æ€ UI |
| **ç®¡ç†å…¥å£** | ç‚¹å‡»ã€Œåˆ‡æ¢ã€è·³è½¬åˆ° Cases é¡µ | åº•éƒ¨å¼¹çª—é€‰æ‹©å™¨ | âœ… **ä¿ç•™ã€Œç®¡ç†å…¨éƒ¨å‘½ç›˜ã€å…¥å£** |

**é‡è¦æé†’**:
- åŸæœ‰çš„ã€Œå‘½ç›˜ç®¡ç†å…¥å£ã€ï¼ˆè·³è½¬ Cases é¡µï¼‰å¿…é¡»ä¿ç•™
- å¯åœ¨å‘½ç›˜é€‰æ‹©å™¨åº•éƒ¨æ·»åŠ ã€Œç®¡ç†å…¨éƒ¨å‘½ç›˜ã€æŒ‰é’®ï¼Œè·³è½¬åˆ° Cases é¡µ
- é¿å…åŸæœ‰å…¥å£æ¶ˆå¤±ï¼Œè®©è€ç”¨æˆ·è¿·èŒ«

**å½“å‰ UI ç»“æ„**:
```typescript
// âŒ å½“å‰å®ç°
{currentChart && (
  <Card style={styles.masterCard}>
    {/* ä»…å±•ç¤ºï¼Œæ— åˆ‡æ¢åŠŸèƒ½ */}
    <View style={styles.masterCardHeader}>
      {/* å¤´åƒã€ä¿¡æ¯ã€åˆ‡æ¢æŒ‰é’®ï¼ˆè·³è½¬åˆ° Casesï¼‰ */}
    </View>
  </Card>
)}
```

**ä¼˜åŒ–å UI ç»“æ„**:
```typescript
// âœ… æ–°æ–¹æ¡ˆ
<CurrentChartSelector 
  currentChartId={currentChartId}
  charts={charts}
  onSwitchChart={(chartId) => setCurrentChartId(chartId)}
  onCreateChart={() => navigation.navigate(SCREEN_NAMES.MANUAL_BAZI, { 
    returnTo: SCREEN_NAMES.XIAOPEI_HOME 
  })}
/>
```

---

## äºŒã€è¯¦ç»†ä¼˜åŒ–æ–¹æ¡ˆ

### 2.1 çŠ¶æ€ç®¡ç†ä¼˜åŒ–

#### 2.1.1 æ‰©å±• `useChartStore`ï¼ˆå•ä¸€çœŸç›¸æºï¼‰

**ä½ç½®**: `app/src/store/chartStore.ts`

**æ–°å¢å­—æ®µ**:
```typescript
interface ChartState {
  // ... ç°æœ‰å­—æ®µ ...
  
  // æ–°å¢ï¼šå½“å‰å‘½ç›˜ IDï¼ˆç”¨äºå°ä½©åœºæ™¯åˆ†æï¼‰- å•ä¸€çœŸç›¸æº
  currentChartId: string | null;
  
  // æ–°å¢ï¼šè®¾ç½®å½“å‰å‘½ç›˜ ID
  setCurrentChartId: (chartId: string | null) => void;
  
  // âš ï¸ æ³¨æ„ï¼šä¸æ–°å¢ setCurrentChartById
  // currentChart é€šè¿‡è®¡ç®—å±æ€§è·å–ï¼Œä¸å•ç‹¬å­˜å‚¨
}
```

**å®ç°é€»è¾‘ï¼ˆå•ä¸€çœŸç›¸æºï¼‰**:
```typescript
// âœ… æ­£ç¡®ï¼šåªå­˜å‚¨ currentChartIdï¼Œä¸å­˜å‚¨ currentChart
setCurrentChartId: (chartId) => {
  set({ currentChartId: chartId });
  // ä¸åœ¨è¿™é‡Œæ›´æ–° currentChartï¼Œç”±ç»„ä»¶é€šè¿‡è®¡ç®—å±æ€§è·å–
},

// âŒ é”™è¯¯ï¼šä¸è¦åŒæ—¶ç»´æŠ¤ä¸¤ä»½çœŸç›¸
// setCurrentChartId: (chartId) => {
//   set({ currentChartId: chartId });
//   // åŒæ­¥æ›´æ–° currentChart - ä¸è¦è¿™æ ·åšï¼
//   const chart = get().charts.find(c => c.chartProfileId === chartId);
//   if (chart) {
//     set({ currentChart: chart });
//   }
// },
```

**åœ¨ç»„ä»¶ä¸­ä½¿ç”¨ï¼ˆè®¡ç®—å±æ€§ï¼‰**:
```typescript
// åœ¨ç»„ä»¶ä¸­ï¼Œé€šè¿‡ useMemo è®¡ç®— currentChart
const { charts, currentChartId } = useChartStore();

const currentChart = useMemo(
  () => charts.find(c => c.chartProfileId === currentChartId) ?? null,
  [charts, currentChartId]
);
```

**æŒä¹…åŒ–é…ç½®**:
```typescript
import { persist, createJSONStorage } from 'zustand/middleware';
import AsyncStorage from '@react-native-async-storage/async-storage';

export const useChartStore = create<ChartState>()(
  persist(
    (set, get) => ({
      // ... ç°æœ‰å®ç° ...
    }),
    {
      name: 'xiaopei-chart-storage',
      storage: createJSONStorage(() => AsyncStorage),
      // åªæŒä¹…åŒ– currentChartIdï¼ˆå•ä¸€çœŸç›¸æºï¼‰
      partialize: (state) => ({
        currentChartId: state.currentChartId,
        // ä¸æŒä¹…åŒ– chartsï¼Œä»æœåŠ¡å™¨è·å–
        // ä¸æŒä¹…åŒ– currentChartï¼Œé€šè¿‡è®¡ç®—å±æ€§è·å–
      }),
    }
  )
);
```

**å¯åŠ¨æ—¶æ¢å¤ç­–ç•¥ï¼ˆç¡¬çº¦å®šï¼‰**:
```typescript
// åº”ç”¨å¯åŠ¨æ—¶ï¼Œæ¢å¤ currentChartId
useEffect(() => {
  const { currentChartId, charts } = useChartStore.getState();
  
  // å¦‚æœ localStorage ä¸­çš„ currentChartId ä¸åœ¨å‘½ç›˜åˆ—è¡¨ä¸­ï¼š
  if (currentChartId && !charts.find(c => c.chartProfileId === currentChartId)) {
    if (charts.length > 0) {
      // è‹¥å‘½ç›˜åˆ—è¡¨éç©ºï¼Œåˆ™ä½¿ç”¨åˆ—è¡¨ç¬¬ä¸€é¡¹çš„ id
      useChartStore.getState().setCurrentChartId(charts[0].chartProfileId);
    } else {
      // è‹¥å‘½ç›˜åˆ—è¡¨ä¸ºç©ºï¼Œåˆ™ç½®ä¸º nullï¼Œè¿›å…¥ã€Œæ— å‘½ç›˜ã€çŠ¶æ€
      useChartStore.getState().setCurrentChartId(null);
    }
  }
}, []);
```

---

### 2.2 Topic é…ç½®ä¼˜åŒ–

#### 2.2.1 åˆ›å»º `TOPIC_META` é…ç½®è¡¨

**ä½ç½®**: `app/src/constants/xiaopeiTopics.ts`ï¼ˆæ–°å»ºæ–‡ä»¶ï¼‰

**å®Œæ•´é…ç½®**:
```typescript
export type TopicKey = 'peach' | 'marriage' | 'career' | 'wealth' | 'family' | 'rhythm';
export type TopicEnum = 'LOVE' | 'EXAM' | 'MARRIAGE' | 'JOB' | 'FAMILY' | 'WEALTH';

export interface TopicMeta {
  enum: TopicEnum;
  title: string;
  subtitleTags: string[];
  defaultQuestion: string;
  icon: React.ComponentType<{ color: string; size: number }>;
}

export const TOPIC_META: Record<TopicKey, TopicMeta> = {
  peach: {
    enum: 'LOVE',
    title: 'æ‹çˆ±Â·æ¡ƒèŠ±',
    subtitleTags: ['å¿ƒåŠ¨', 'æš§æ˜§', 'å†·æˆ˜'],
    defaultQuestion: 'åŸºäºå½“å‰å‘½ç›˜ï¼Œå¸®æˆ‘è§£è¯»ä¸€ä¸‹æœ€è¿‘çš„æ‹çˆ±æ¡ƒèŠ±å’Œæ„Ÿæƒ…è¿åŠ¿ã€‚',
    icon: Sparkles,
  },
  rhythm: {
    enum: 'EXAM',
    title: 'è€ƒç ”Â·è€ƒå…¬',
    subtitleTags: ['æ‹©æ ¡', 'å¤‡è€ƒ', 'ä¸Šå²¸'],
    defaultQuestion: 'åŸºäºå½“å‰å‘½ç›˜ï¼Œå¸®æˆ‘çœ‹çœ‹è€ƒç ”/è€ƒå…¬ç›¸å…³çš„æ•´ä½“å­¦ä¸šå’Œè€ƒè¯•è¿åŠ¿ã€‚',
    icon: GraduationCap,
  },
  marriage: {
    enum: 'MARRIAGE',
    title: 'ç»“å©šÂ·å©šå§»',
    subtitleTags: ['å©šæœŸ', 'å½©ç¤¼', 'çŸ›ç›¾'],
    defaultQuestion: 'åŸºäºå½“å‰å‘½ç›˜ï¼Œå¸®æˆ‘çœ‹çœ‹å©šå§»ç›¸å…³çš„è¿åŠ¿ï¼Œæ¯”å¦‚ç»“å©šèŠ‚å¥ã€å©šå§»ç¨³å®šåº¦ã€‚',
    icon: HeartHandshake,
  },
  career: {
    enum: 'JOB',
    title: 'å·¥ä½œÂ·è·³æ§½',
    subtitleTags: ['æ¶¨è–ª', 'ç¦»èŒ', 'æ–¹å‘'],
    defaultQuestion: 'åŸºäºå½“å‰å‘½ç›˜ï¼Œå¸®æˆ‘çœ‹çœ‹å·¥ä½œå’Œè·³æ§½æ–¹é¢çš„è¿åŠ¿ä¸æœºä¼šã€‚',
    icon: BriefcaseBusiness,
  },
  family: {
    enum: 'FAMILY',
    title: 'å©†åª³Â·å…³ç³»',
    subtitleTags: ['å¸¦å¨ƒ', 'çŸ›ç›¾', 'åŒä½'],
    defaultQuestion: 'åŸºäºå½“å‰å‘½ç›˜ï¼Œå¸®æˆ‘çœ‹çœ‹ä¸é•¿è¾ˆ/å©†åª³å…³ç³»çš„ç›¸å¤„å’ŒçŸ›ç›¾æƒ…å†µã€‚',
    icon: HomeIcon,
  },
  wealth: {
    enum: 'WEALTH',
    title: 'æŠ•èµ„Â·ç†è´¢',
    subtitleTags: ['è‚¡ç¥¨', 'åŸºé‡‘', 'ä¹°æˆ¿'],
    defaultQuestion: 'åŸºäºå½“å‰å‘½ç›˜ï¼Œå¸®æˆ‘çœ‹çœ‹è¿‘æœŸçš„è´¢å¯Œã€æŠ•èµ„å’Œç†è´¢è¿åŠ¿ã€‚',
    icon: Wallet,
  },
};

// âš ï¸ ç¡¬çº¦å®šï¼šæ‰€æœ‰ä»å¡ç‰‡è¿›å…¥çš„å°ä½©å¯¹è¯ï¼Œå¦‚æœç”¨æˆ·æ²¡æœ‰ä¸»åŠ¨è¾“å…¥é—®é¢˜ï¼Œ
// å¿…é¡»ä» TOPIC_META[topic].defaultQuestion é‡Œå–æ–‡æ¡ˆï¼Œä½œä¸º question ä¼ ç»™åç«¯ã€‚
// ä¸å…è®¸åœ¨è°ƒç”¨æ¥å£çš„åœ°æ–¹æ‰‹å†™ stringï¼Œè¿™æ ·ä»¥åæƒ³å¾®è°ƒæ–‡æ¡ˆï¼Œæ”¹ä¸€å¤„å³å¯ã€‚

// å·¥å…·å‡½æ•°ï¼šæ ¹æ® key è·å–æšä¸¾å€¼
export const getTopicEnum = (key: TopicKey): TopicEnum => {
  return TOPIC_META[key].enum;
};

// å·¥å…·å‡½æ•°ï¼šæ ¹æ®æšä¸¾å€¼è·å– key
export const getTopicKey = (enumValue: TopicEnum): TopicKey | null => {
  const entry = Object.entries(TOPIC_META).find(([_, meta]) => meta.enum === enumValue);
  return entry ? (entry[0] as TopicKey) : null;
};
```

---

### 2.3 å½“å‰å‘½ç›˜ç»„ä»¶å®ç°

#### 2.3.1 åˆ›å»º `CurrentChartSelector` ç»„ä»¶

**ä½ç½®**: `app/src/screens/XiaoPeiHome/components/CurrentChartSelector.tsx`ï¼ˆæ–°å»ºï¼‰

**ç»„ä»¶æ¥å£**:
```typescript
interface CurrentChartSelectorProps {
  currentChartId: string | null;
  charts: ChartProfile[];
  onSwitchChart: (chartId: string) => void;
  onCreateChart: () => void;
}
```

**ç»„ä»¶ç»“æ„**:
```typescript
export const CurrentChartSelector: React.FC<CurrentChartSelectorProps> = ({
  currentChartId,
  charts,
  onSwitchChart,
  onCreateChart,
}) => {
  const [showSelector, setShowSelector] = useState(false);
  
  const currentChart = charts.find(c => c.chartProfileId === currentChartId);
  
  if (!currentChart) {
    // æ— å‘½ç›˜çŠ¶æ€
    return (
      <Card style={styles.container}>
        <Text style={styles.title}>å½“å‰å‘½ç›˜</Text>
        <View style={styles.emptyState}>
          <Icon name="chart-placeholder" size={48} color={colors.textSecondary} />
          <Text style={styles.emptyTitle}>ä½ è¿˜æ²¡æœ‰å‘½ç›˜ï½</Text>
          <Text style={styles.emptyHint}>
            å…ˆåˆ›å»ºä¸€ä¸ªå‘½ç›˜ï¼Œåé¢çš„è§£è¯»æ‰ä¼šæ›´å‡†
          </Text>
          <Button onPress={onCreateChart} style={styles.createButton}>
            ä¸€é”®æ–°å»ºå‘½ç›˜
          </Button>
        </View>
      </Card>
    );
  }
  
  // æœ‰å‘½ç›˜çŠ¶æ€
  return (
    <>
      <Card style={styles.container}>
        <Text style={styles.title}>å½“å‰å‘½ç›˜</Text>
        <View style={styles.content}>
          <View style={styles.info}>
            <Text style={styles.mainInfo}>
              {currentChart.name} Â· {currentChart.gender === 'male' ? 'ç”·' : 'å¥³'} Â· {formatDate(currentChart.birthday)} Â· ç”Ÿè‚–{getZodiac(currentChart.birthday)}
            </Text>
            <Text style={styles.hint}>
              å½“å‰ä»¥ã€Œ{currentChart.name}ã€ä¸ºå‡†ï¼Œåˆ‡æ¢åä¸‹é¢çš„åˆ†æä¹Ÿä¼šè·Ÿç€æ”¹å˜
            </Text>
          </View>
          <Button 
            onPress={() => setShowSelector(true)}
            variant="text"
            style={styles.switchButton}
          >
            åˆ‡æ¢å‘½ç›˜ â†’
          </Button>
        </View>
      </Card>
      
      {/* å‘½ç›˜é€‰æ‹©å™¨ï¼ˆåº•éƒ¨å¼¹çª—ï¼‰ */}
      <BottomSheet
        visible={showSelector}
        onClose={() => setShowSelector(false)}
      >
        <View style={styles.selectorHeader}>
          <Text style={styles.selectorTitle}>é€‰æ‹©å‘½ç›˜</Text>
          <Pressable onPress={() => setShowSelector(false)}>
            <Icon name="close" size={24} />
          </Pressable>
        </View>
        
        <ScrollView style={styles.selectorList}>
          {charts.map((chart) => (
            <Pressable
              key={chart.chartProfileId}
              style={styles.selectorItem}
              onPress={() => {
                onSwitchChart(chart.chartProfileId);
                setShowSelector(false);
                Toast.show('å·²åˆ‡æ¢åˆ°ã€Œ' + chart.name + 'ã€');
              }}
            >
              <View style={styles.selectorItemInfo}>
                <Text style={styles.selectorItemName}>{chart.name}</Text>
                <Text style={styles.selectorItemDetail}>
                  {chart.gender === 'male' ? 'ç”·' : 'å¥³'} Â· {formatDate(chart.birthday)} Â· {getZodiac(chart.birthday)}
                </Text>
              </View>
              {chart.chartProfileId === currentChartId && (
                <View style={styles.currentTag}>
                  <Text style={styles.currentTagText}>å½“å‰ä½¿ç”¨</Text>
                </View>
              )}
            </Pressable>
          ))}
        </ScrollView>
        
        <Button 
          onPress={() => {
            setShowSelector(false);
            onCreateChart();
          }}
          style={styles.createButtonInSelector}
        >
          + æ–°å»ºå‘½ç›˜
        </Button>
        
        {/* ä¿ç•™ç®¡ç†å‘½ç›˜å…¥å£ */}
        <Button 
          onPress={() => {
            setShowSelector(false);
            navigation.navigate(SCREEN_NAMES.CASES);
          }}
          variant="text"
          style={styles.manageButton}
        >
          ç®¡ç†å…¨éƒ¨å‘½ç›˜
        </Button>
      </BottomSheet>
    </>
  );
};
```

---

### 2.4 å°ä½©ä¸»é¡µä¼˜åŒ–

#### 2.4.1 ä¿®æ”¹ `XiaoPeiHomeScreen`

**ä¸»è¦æ”¹åŠ¨**:

1. **å¼•å…¥æ–°ç»„ä»¶å’Œé…ç½®**:
```typescript
import { CurrentChartSelector } from './components/CurrentChartSelector';
import { TOPIC_META, getTopicEnum } from '@/constants/xiaopeiTopics';
import { useChartStore } from '@/store';
```

2. **æ›¿æ¢å‘½ç›˜å±•ç¤ºç»„ä»¶**:
```typescript
// âŒ åˆ é™¤ç°æœ‰çš„ã€Œå½“å‰å‘½ä¸»ä¿¡æ¯å¡ç‰‡ã€
{currentChart && (
  <Card style={styles.masterCard}>
    {/* ... */}
  </Card>
)}

// âœ… æ›¿æ¢ä¸ºæ–°çš„ã€Œå½“å‰å‘½ç›˜ç»„ä»¶ã€
// æ³¨æ„ï¼šcurrentChart é€šè¿‡è®¡ç®—å±æ€§è·å–
const { charts, currentChartId } = useChartStore();
const currentChart = useMemo(
  () => charts.find(c => c.chartProfileId === currentChartId) ?? null,
  [charts, currentChartId]
);

<CurrentChartSelector
  currentChartId={currentChartId}
  charts={charts}
  currentChart={currentChart}  // ä¼ å…¥è®¡ç®—å±æ€§
  onSwitchChart={(chartId) => {
    useChartStore.getState().setCurrentChartId(chartId);
  }}
  onCreateChart={() => {
    navigation.navigate(SCREEN_NAMES.MANUAL_BAZI as any, {
      returnTo: SCREEN_NAMES.XIAOPEI_HOME,
    });
  }}
/>
```

3. **ä¼˜åŒ–å¡ç‰‡ç‚¹å‡»é€»è¾‘**:
```typescript
const handleTopicPress = (topicKey: TopicKey) => {
  const { currentChartId } = useChartStore.getState();
  
  if (!currentChartId) {
    // å¼¹çª—æç¤º
    Alert.alert(
      'éœ€è¦å…ˆåˆ›å»ºå‘½ç›˜',
      'éœ€è¦å…ˆåˆ›å»ºå‘½ç›˜æ‰èƒ½å¼€å§‹è§£è¯»',
      [
        { text: 'å–æ¶ˆ', style: 'cancel' },
        {
          text: 'å»åˆ›å»ºå‘½ç›˜',
          onPress: () => {
            navigation.navigate(SCREEN_NAMES.MANUAL_BAZI as any, {
              returnTo: SCREEN_NAMES.XIAOPEI_HOME,
            });
          },
        },
      ]
    );
    return;
  }

  // è·å– topic é…ç½®
  const topicMeta = TOPIC_META[topicKey];
  
  // âš ï¸ ç¡¬çº¦å®šï¼šquestion å¿…é¡»ä» TOPIC_META é…ç½®è¡¨è·å–ï¼Œä¸å…è®¸æ‰‹å†™
  const question = topicMeta.defaultQuestion;
  
  // è·³è½¬åˆ°èŠå¤©é¡µï¼Œæºå¸¦ç»Ÿä¸€å‚æ•°
  navigation.navigate(SCREEN_NAMES.CHAT as any, {
    topic: topicMeta.enum,  // åç«¯æšä¸¾å€¼
    chart_id: currentChartId,
    question: question,  // ä»é…ç½®è¡¨è·å–ï¼Œç¡®ä¿éç©º
    source: 'xiaopei_topic_card',
  });
};
```

4. **æ›´æ–° TOPICS é…ç½®**:
```typescript
// ä½¿ç”¨ TOPIC_META ç”Ÿæˆ TOPICS æ•°ç»„
const TOPICS = Object.entries(TOPIC_META).map(([key, meta]) => ({
  key: key as TopicKey,
  label: meta.title,
  desc: meta.subtitleTags.join('ã€'),
  icon: meta.icon,
  defaultQuestion: meta.defaultQuestion,
}));
```

---

### 2.5 èŠå¤©é¡µå‚æ•°æ¥æ”¶ä¼˜åŒ–

#### 2.5.1 ä¿®æ”¹ `ChatScreen` å‚æ•°æ¥æ”¶

**å½“å‰å‚æ•°**:
```typescript
// âŒ å½“å‰å®ç°
{
  topic: 'peach' | 'marriage' | ...,
  question: string,
  source: string,
  masterId: string,
}
```

**ä¼˜åŒ–åå‚æ•°**:
```typescript
// âœ… æ–°æ–¹æ¡ˆ
{
  topic: 'LOVE' | 'EXAM' | 'MARRIAGE' | 'JOB' | 'FAMILY' | 'WEALTH',
  chart_id: string,
  question: string,
  source?: string,
}
```

**æ¥å£è°ƒç”¨**:
```typescript
// åœ¨ ChatScreen ä¸­ï¼Œç»Ÿä¸€è°ƒç”¨åˆ†ææ¥å£
const response = await apiClient.post('/api/v1/xiaopei/analyze', {
  topic: route.params.topic,
  chart_id: route.params.chart_id,
  question: route.params.question,
});
```

---

## ä¸‰ã€è¿ç§»ç­–ç•¥

### 3.1 å‘åå…¼å®¹

**ç­–ç•¥**: ä¿æŒç°æœ‰ä»£ç ç»“æ„ï¼Œé€æ­¥è¿ç§»

1. **ç¬¬ä¸€é˜¶æ®µ**: æ–°å¢ `currentChartId` å’Œ `CurrentChartSelector` ç»„ä»¶
2. **ç¬¬äºŒé˜¶æ®µ**: æ›´æ–°å¡ç‰‡ç‚¹å‡»é€»è¾‘ï¼Œä½¿ç”¨æ–°çš„ topic æšä¸¾
3. **ç¬¬ä¸‰é˜¶æ®µ**: ç»Ÿä¸€æ¥å£è°ƒç”¨ï¼Œç§»é™¤æ—§çš„å‚æ•°ä¼ é€’æ–¹å¼

---

### 3.2 æ•°æ®è¿ç§»

**å¯åŠ¨æ—¶åˆå§‹åŒ–ï¼ˆç¡¬çº¦å®šï¼‰**:
```typescript
// åœ¨ App å¯åŠ¨æ—¶ï¼Œæ¢å¤å¹¶æ ¡éªŒ currentChartId
useEffect(() => {
  const { currentChartId, charts } = useChartStore.getState();
  
  // å¦‚æœ localStorage ä¸­çš„ currentChartId ä¸åœ¨å‘½ç›˜åˆ—è¡¨ä¸­ï¼š
  if (currentChartId && !charts.find(c => c.chartProfileId === currentChartId)) {
    if (charts.length > 0) {
      // è‹¥å‘½ç›˜åˆ—è¡¨éç©ºï¼Œåˆ™ä½¿ç”¨åˆ—è¡¨ç¬¬ä¸€é¡¹çš„ id
      useChartStore.getState().setCurrentChartId(charts[0].chartProfileId);
    } else {
      // è‹¥å‘½ç›˜åˆ—è¡¨ä¸ºç©ºï¼Œåˆ™ç½®ä¸º nullï¼Œè¿›å…¥ã€Œæ— å‘½ç›˜ã€çŠ¶æ€
      useChartStore.getState().setCurrentChartId(null);
    }
  }
}, []);
```

---

## å››ã€å®ç°æ£€æŸ¥æ¸…å•

### 4.1 å‰ç«¯æ£€æŸ¥æ¸…å•

- [ ] æ‰©å±• `useChartStore`ï¼Œæ–°å¢ `currentChartId` å’Œ `setCurrentChartId`ï¼ˆå•ä¸€çœŸç›¸æºï¼‰
- [ ] **ä¸æ–°å¢ `setCurrentChartById`**ï¼Œ`currentChart` é€šè¿‡è®¡ç®—å±æ€§è·å–
- [ ] é…ç½® `persist` middlewareï¼ŒåªæŒä¹…åŒ– `currentChartId`
- [ ] åœ¨ç»„ä»¶ä¸­å®ç° `currentChart` è®¡ç®—å±æ€§ï¼ˆuseMemoï¼‰
- [ ] åˆ›å»º `TOPIC_META` é…ç½®è¡¨ï¼ˆ`xiaopeiTopics.ts`ï¼‰
- [ ] åˆ›å»º `CurrentChartSelector` ç»„ä»¶ï¼ˆæœ‰å‘½ç›˜/æ— å‘½ç›˜ä¸¤ç§çŠ¶æ€ï¼‰
- [ ] å®ç°å‘½ç›˜åˆ‡æ¢é€‰æ‹©å™¨ï¼ˆåº•éƒ¨å¼¹çª—ï¼‰
- [ ] ä¿®æ”¹ `XiaoPeiHomeScreen`ï¼Œæ›¿æ¢å‘½ç›˜å±•ç¤ºç»„ä»¶
- [ ] ä¼˜åŒ–å¡ç‰‡ç‚¹å‡»é€»è¾‘ï¼ˆæ£€æŸ¥ `currentChartId`ï¼Œ**ç¡¬çº¦å®šï¼šå¿…é¡»å¼¹çª—æ‹¦æˆª**ï¼Œç»Ÿä¸€å‚æ•°ï¼‰
- [ ] **ç¡¬çº¦å®šï¼šquestion å¿…é¡»ä» `TOPIC_META` é…ç½®è¡¨è·å–ï¼Œä¸å…è®¸æ‰‹å†™**
- [ ] æ›´æ–° `ChatScreen` å‚æ•°æ¥æ”¶ï¼ˆä½¿ç”¨ `chart_id` è€Œé `masterId`ï¼‰
- [ ] å®ç°å¯åŠ¨æ—¶æ•°æ®æ¢å¤é€»è¾‘ï¼ˆç¡¬çº¦å®šï¼šcurrentChartId ä¸åœ¨åˆ—è¡¨ä¸­æ—¶çš„å¤„ç†ï¼‰
- [ ] åœ¨å‘½ç›˜é€‰æ‹©å™¨ä¸­æ·»åŠ ã€Œç®¡ç†å…¨éƒ¨å‘½ç›˜ã€å…¥å£ï¼ˆä¿ç•™åŸæœ‰åŠŸèƒ½ï¼‰

---

### 4.2 åç«¯æ£€æŸ¥æ¸…å•

- [ ] åˆ›å»º `POST /api/v1/xiaopei/analyze` æ¥å£
- [ ] å®ç° topic æšä¸¾å€¼æ ¡éªŒï¼ˆ`LOVE` / `EXAM` / `MARRIAGE` / `JOB` / `FAMILY` / `WEALTH`ï¼‰
- [ ] å®ç° `chart_id` æƒé™æ ¡éªŒï¼ˆå±äºå½“å‰ç”¨æˆ·ï¼‰
- [ ] å®ç° `question` å¿…å¡«æ ¡éªŒï¼ˆéç©ºï¼‰
- [ ] å¤ç”¨å‘½ç›˜æŸ¥è¯¢é€»è¾‘ï¼ˆ`GET /api/v1/bazi/charts/:chartId`ï¼‰
- [ ] æ ¹æ® topic é€‰æ‹©å¯¹åº”çš„ prompt æ¨¡æ¿
- [ ] è°ƒç”¨ LLM service å¹¶è§£æè¿”å›ç»“æœ
- [ ] è¿”å›ç»Ÿä¸€å“åº”æ ¼å¼ï¼ˆ`answer + suggested_questions`ï¼‰

---

### 4.3 æµ‹è¯•æ£€æŸ¥æ¸…å•

- [ ] æœ‰å‘½ç›˜æ—¶ï¼Œåœºæ™¯å¡ç‰‡æ­£å¸¸è·³è½¬å¹¶æºå¸¦ `chart_id`
- [ ] æ— å‘½ç›˜æ—¶ï¼Œåœºæ™¯å¡ç‰‡ç‚¹å‡»å¼¹çª—æç¤º
- [ ] åˆ‡æ¢å‘½ç›˜åï¼Œåœºæ™¯åˆ†æä½¿ç”¨æ–°å‘½ç›˜
- [ ] æ–°å»ºå‘½ç›˜åï¼Œè‡ªåŠ¨è®¾ç½®ä¸ºå½“å‰å‘½ç›˜
- [ ] åˆ é™¤å½“å‰å‘½ç›˜åï¼Œè‡ªåŠ¨åˆ‡æ¢åˆ°å…¶ä»–å‘½ç›˜æˆ–ç½®ä¸º null
- [ ] æœ¬åœ°å­˜å‚¨çš„ `currentChartId` æ— æ•ˆæ—¶ï¼Œè‡ªåŠ¨æ¢å¤
- [ ] æ¯ä¸ª topic çš„é»˜è®¤é—®é¢˜éƒ½èƒ½æˆåŠŸå‘èµ·è§£è¯»
- [ ] **ç¡¬çº¦å®šï¼š`question` ä¸èƒ½ä¸ºç©ºçš„æ ¡éªŒï¼ˆå‰åç«¯ï¼‰**
- [ ] **ç¡¬çº¦å®šï¼šquestion å¿…é¡»ä» `TOPIC_META` é…ç½®è¡¨è·å–ï¼Œä¸å…è®¸æ‰‹å†™**
- [ ] topic æšä¸¾å€¼æ­£ç¡®æ˜ å°„ï¼ˆå‰ç«¯ key â†’ åç«¯ enumï¼‰
- [ ] å¯åŠ¨æ—¶ currentChartId æ¢å¤ç­–ç•¥æ­£ç¡®æ‰§è¡Œ

---

## äº”ã€å…³é”®å†³ç­–ç‚¹ä¸å¼ºè§„åˆ™

### 5.1 çŠ¶æ€ç®¡ç†ç­–ç•¥ï¼ˆå•ä¸€çœŸç›¸æºï¼‰

**å†³ç­–**: **åªå­˜å‚¨ `currentChartId`ï¼Œ`currentChart` é€šè¿‡è®¡ç®—å±æ€§è·å–**

**ç†ç”±**:
- âœ… **é¿å…åŒæ­¥é—®é¢˜**ï¼šä¸ä¼šå‡ºç°ã€ŒID æ”¹äº†ã€å¯¹è±¡æ²¡æ”¹ã€è¿™ç§ä¸åŒæ­¥é—®é¢˜
- âœ… **ç®€åŒ–æŒä¹…åŒ–**ï¼šlocalStorage åªå­˜ä¸€ä¸ª stringï¼Œç®€å•ç›´æ¥
- âœ… **ç®€åŒ–æ“ä½œ**ï¼šåˆ é™¤å‘½ç›˜ / åˆ‡æ¢å‘½ç›˜æ—¶ï¼Œåªæ”¹ä¸€ä¸ªå­—æ®µï¼Œä¸ç”¨åˆ°å¤„åŒæ­¥
- âœ… **æ•°æ®ä¸€è‡´æ€§**ï¼š`currentChart` å§‹ç»ˆä¸ `charts` åˆ—è¡¨å’Œ `currentChartId` ä¿æŒä¸€è‡´

**å¼ºè§„åˆ™**:
> å…¨å±€çŠ¶æ€åªå­˜ `currentChartId` å’Œ `charts` åˆ—è¡¨ï¼Œ`currentChart` é€šè¿‡ `charts + currentChartId` åŠ¨æ€è®¡ç®—ï¼Œä¸å•ç‹¬å­˜å‚¨ã€‚

---

### 5.2 Topic æšä¸¾ç­–ç•¥

**å†³ç­–**: å‰ç«¯ä»ä½¿ç”¨ä¸­æ–‡ keyï¼Œå‘é€æ—¶è½¬æ¢ä¸ºè‹±æ–‡æšä¸¾

**ç†ç”±**:
- ä¿æŒç°æœ‰ä»£ç å…¼å®¹æ€§
- å‰ç«¯å±•ç¤ºä½¿ç”¨ä¸­æ–‡æ›´ç›´è§‚
- åç«¯ç»Ÿä¸€ä½¿ç”¨è‹±æ–‡æšä¸¾ï¼Œä¾¿äºæ‰©å±•

---

### 5.3 é»˜è®¤é—®é¢˜ç­–ç•¥ï¼ˆç¡¬çº¦å®šï¼‰

**å†³ç­–**: ä½¿ç”¨æ–°æ–¹æ¡ˆçš„å…·ä½“é—®é¢˜ï¼Œä¸”**å¿…é¡»ä»é…ç½®è¡¨è·å–**

**å¼ºè§„åˆ™**:
> æ‰€æœ‰ä»å¡ç‰‡è¿›å…¥çš„å°ä½©å¯¹è¯ï¼Œå¦‚æœç”¨æˆ·æ²¡æœ‰ä¸»åŠ¨è¾“å…¥é—®é¢˜ï¼Œå¿…é¡»ä» `TOPIC_META[topic].defaultQuestion` é‡Œå–æ–‡æ¡ˆï¼Œä½œä¸º `question` ä¼ ç»™åç«¯ã€‚ä¸å…è®¸åœ¨è°ƒç”¨æ¥å£çš„åœ°æ–¹æ‰‹å†™ stringã€‚

**ç†ç”±**:
- âœ… æ›´ç¬¦åˆç”¨æˆ·éœ€æ±‚
- âœ… æ›´ä¾¿äº LLM ç†è§£åœºæ™¯
- âœ… æå‡è§£è¯»è´¨é‡
- âœ… **ç»Ÿä¸€ç®¡ç†**ï¼šä»¥åæƒ³å¾®è°ƒæ–‡æ¡ˆï¼Œæ”¹ä¸€å¤„å³å¯ï¼Œä¸ä¼šå‡ºç°ã€Œæœ‰çš„åœ°æ–¹ç”¨è€æ¨¡æ¿ï¼Œæœ‰çš„åœ°æ–¹ç”¨æ–°æ¨¡æ¿ã€çš„æƒ…å†µ

### 5.4 Question å­—æ®µè§„åˆ™ï¼ˆç¡¬çº¦å®šï¼‰

**å¼ºè§„åˆ™**:
> æ¥å£å­—æ®µ `question` ä¸º**å¿…å¡«å­—æ®µ**ï¼Œå¿…é¡»ä¸ºéç©ºå­—ç¬¦ä¸²ã€‚æ‰€æœ‰ä»å°ä½©å¡ç‰‡è¿›å…¥çš„ä¼šè¯ï¼Œè‹¥ç”¨æˆ·æœªè¾“å…¥é—®é¢˜ï¼Œåˆ™ç”±å‰ç«¯æ ¹æ® `topic` ä½¿ç”¨é»˜è®¤é—®é¢˜å¡«å……ã€‚

### 5.5 CurrentChartId æ¢å¤ç­–ç•¥ï¼ˆç¡¬çº¦å®šï¼‰

**å¼ºè§„åˆ™**:
> å¯åŠ¨æ—¶å¦‚å‘ç° localStorage ä¸­çš„ `currentChartId` ä¸åœ¨å‘½ç›˜åˆ—è¡¨ä¸­ï¼š
> - è‹¥å‘½ç›˜åˆ—è¡¨éç©ºï¼Œåˆ™ä½¿ç”¨åˆ—è¡¨ç¬¬ä¸€é¡¹çš„ id
> - è‹¥å‘½ç›˜åˆ—è¡¨ä¸ºç©ºï¼Œåˆ™ç½®ä¸º nullï¼Œè¿›å…¥ã€Œæ— å‘½ç›˜ã€çŠ¶æ€

---

## å…­ã€ç›¸å…³æ–‡æ¡£

- **å‚è€ƒ**: `å°ä½©å‘½ç›˜é€‰æ‹©åŠŸèƒ½è®¾è®¡æ–¹æ¡ˆ-v1.md` - æ–°æ–¹æ¡ˆè¯¦ç»†è¯´æ˜
- **å‚è€ƒ**: `APIæ¥å£ç»Ÿä¸€è§„èŒƒ.md` - API è·¯å¾„ã€å“åº”æ ¼å¼ã€é”™è¯¯ç 
- **å‚è€ƒ**: `çŠ¶æ€ç®¡ç†ä¸æ•°æ®æ¨¡å‹è§„èŒƒ.md` - Store ç»“æ„ã€å‘½åè§„èŒƒ
- **å‚è€ƒ**: `APPå¼€å‘æ–‡æ¡£.md` - æ•´ä½“æ¶æ„ã€åŠŸèƒ½æ¨¡å—

---

## ä¸ƒã€ç‰ˆæœ¬è®°å½•

| ç‰ˆæœ¬ | æ—¥æœŸ | æ›´æ–°å†…å®¹ | æ›´æ–°äºº |
|------|------|---------|--------|
| v2.1 | 2024-12 | æ•´åˆä¼˜åŒ–å»ºè®®ï¼šå•ä¸€çœŸç›¸æºã€ç¡¬çº¦å®šã€å¼ºè§„åˆ™ | å¼€å‘å›¢é˜Ÿ |
| v2.0 | 2024-12 | å¯¹æ¯”ç‰ˆä¼˜åŒ–æ–¹æ¡ˆï¼ŒåŒ…å«å½“å‰å®ç° vs æ–°æ–¹æ¡ˆå¯¹æ¯” | å¼€å‘å›¢é˜Ÿ |

---

**æ–‡æ¡£ç‰ˆæœ¬**: v2.1  
**æœ€åæ›´æ–°**: 2024å¹´12æœˆ  
**ç»´æŠ¤è€…**: å¼€å‘å›¢é˜Ÿ  
**çŠ¶æ€**: âœ… å¯ä»¥å¼€å‘

---

## å…«ã€å¼ºè§„åˆ™æ±‡æ€»ï¼ˆå¼€å‘å‰å¿…è¯»ï¼‰

### 8.1 çŠ¶æ€ç®¡ç†å¼ºè§„åˆ™

1. **å•ä¸€çœŸç›¸æº**ï¼šå…¨å±€çŠ¶æ€åªå­˜ `currentChartId` å’Œ `charts` åˆ—è¡¨
2. **è®¡ç®—å±æ€§**ï¼š`currentChart` é€šè¿‡ `charts + currentChartId` åŠ¨æ€è®¡ç®—ï¼Œä¸å•ç‹¬å­˜å‚¨
3. **æŒä¹…åŒ–**ï¼šåªæŒä¹…åŒ– `currentChartId`ï¼Œä¸æŒä¹…åŒ– `currentChart`

### 8.2 Question å­—æ®µå¼ºè§„åˆ™

1. **å¿…å¡«å­—æ®µ**ï¼šæ¥å£å­—æ®µ `question` ä¸ºå¿…å¡«å­—æ®µï¼Œå¿…é¡»ä¸ºéç©ºå­—ç¬¦ä¸²
2. **é…ç½®è¡¨è·å–**ï¼šæ‰€æœ‰ä»å¡ç‰‡è¿›å…¥çš„å°ä½©å¯¹è¯ï¼Œè‹¥ç”¨æˆ·æœªè¾“å…¥é—®é¢˜ï¼Œå¿…é¡»ä» `TOPIC_META[topic].defaultQuestion` é‡Œå–
3. **ç¦æ­¢æ‰‹å†™**ï¼šä¸å…è®¸åœ¨è°ƒç”¨æ¥å£çš„åœ°æ–¹æ‰‹å†™ string

### 8.3 å¡ç‰‡ç‚¹å‡»å¼ºè§„åˆ™

1. **æ‹¦æˆªè¡Œä¸º**ï¼šå½“ `currentChartId` ä¸ºç©ºæ—¶ï¼Œç‚¹å‡»ä»»æ„å°ä½©å¡ç‰‡ï¼š
   - âŒ **ä¸å…è®¸**å‘åˆ†æè¯·æ±‚
   - âœ… **å¿…é¡»**å¼¹å‡º"å»åˆ›å»ºå‘½ç›˜"çš„æç¤ºå¼¹çª—
   - âŒ **ä¸å…è®¸**ä½¿ç”¨ `console.warn` ç­‰ä»…æ—¥å¿—æ–¹å¼å¤„ç†

### 8.4 CurrentChartId æ¢å¤å¼ºè§„åˆ™

1. **å¯åŠ¨æ ¡éªŒ**ï¼šå¯åŠ¨æ—¶å¦‚å‘ç° localStorage ä¸­çš„ `currentChartId` ä¸åœ¨å‘½ç›˜åˆ—è¡¨ä¸­ï¼š
   - è‹¥å‘½ç›˜åˆ—è¡¨éç©ºï¼Œåˆ™ä½¿ç”¨åˆ—è¡¨ç¬¬ä¸€é¡¹çš„ id
   - è‹¥å‘½ç›˜åˆ—è¡¨ä¸ºç©ºï¼Œåˆ™ç½®ä¸º nullï¼Œè¿›å…¥ã€Œæ— å‘½ç›˜ã€çŠ¶æ€

### 8.5 Topic æ˜ å°„å¼ºè§„åˆ™

1. **ç¡¬çº¦å®šè¡¨**ï¼šæ—§ key â†’ æ–°æšä¸¾å¯¹åº”è¡¨ä¸ºç¡¬çº¦å®šï¼Œä¸å…è®¸éšæ„ä¿®æ”¹
2. **ç»Ÿä¸€ç®¡ç†**ï¼šæ‰€æœ‰ topic é…ç½®å¿…é¡»åœ¨ `TOPIC_META` ä¸­ç»Ÿä¸€ç®¡ç†

### 8.6 UI å…¥å£å¼ºè§„åˆ™

1. **ä¿ç•™ç®¡ç†å…¥å£**ï¼šåŸæœ‰çš„ã€Œå‘½ç›˜ç®¡ç†å…¥å£ã€ï¼ˆè·³è½¬ Cases é¡µï¼‰å¿…é¡»ä¿ç•™
2. **å»ºè®®ä½ç½®**ï¼šå¯åœ¨å‘½ç›˜é€‰æ‹©å™¨åº•éƒ¨æ·»åŠ ã€Œç®¡ç†å…¨éƒ¨å‘½ç›˜ã€æŒ‰é’®

