# 小佩會員中心設計方案（最終版）

> **設計時間**：2025-01-XX  
> **設計理念**：未開通 = 銷售頁，已開通 = 會員中心  
> **目標**：將「小佩服務」頁面從銷售頁轉換為會員控制台

---

## 📋 設計原則

### 核心邏輯
- **未開通會員**：顯示銷售頁（現有 `ProSubscriptionScreen`）
- **已開通會員**：顯示會員中心（新建 `ProMemberCenterScreen`）

### 導航邏輯
- `MeScreen` → 點擊「小佩服務」
  - 如果 `!isPro` → 跳轉到 `ProSubscriptionScreen`（銷售頁）
  - 如果 `isPro` → 跳轉到 `ProMemberCenterScreen`（會員中心）

### 重要說明
- ✅ **此頁面只針對已經訂閱了的用戶**
- ✅ **沒有訂閱的用戶還是使用已經設計好的小佩pro頁面裡面訂閱服務**
- ✅ **已經訂閱的用戶在進入到小佩pro是現在開發的會員中心頁面**

---

## 🎨 頁面結構設計

### 1️⃣ 頂部狀態卡：告訴他「你現在是誰」

#### 設計要素
- **會員標籤**：月付 / 季付 / 年付
- **狀態**：已開通 / 即將到期（7天內）
- **到期日或下一次扣款日**

#### UI 結構
```
┌─────────────────────────────────┐
│  小佩會員 · 使用中              │  ← 標題
│                                  │
│  [季付會員]                     │  ← 標籤（Badge）
│                                  │
│  感謝支持，小佩會長期陪你看懂   │  ← 主文案
│  自己的節奏。                    │
│                                  │
│  本期至 2025-03-12 · 自動續訂中  │  ← 小字
│                                  │
│  [管理訂閱]  [恢復購買]          │  ← 按鈕（右上角或卡片下方）
└─────────────────────────────────┘
```

#### 數據來源
- `status.proPlan` → 轉換為「月付會員」「季付會員」「年付會員」
- `status.proExpiresAt` → 計算到期日
- 判斷是否即將到期（7天內）→ 顯示警告提示

#### 按鈕功能
- **管理訂閱**：複用現有的 iOS 訂閱管理邏輯
- **恢復購買**：沿用現在的訂閱邏輯，但需要設計好訂購時間邏輯

---

### 2️⃣ 使用情況卡：讓他感覺「買得值得」

#### 設計要素
- 顯示今日 AI 使用次數
- 進度條視覺化
- 引導下一步行動

#### UI 結構
```
┌─────────────────────────────────┐
│  今日使用情況                    │  ← 標題
│                                  │
│  今日已使用 23 / 100 次 AI 解讀  │  ← 主數據
│                                  │
│  [████████░░░░░░░░░░] 23%        │  ← 進度條
│                                  │
│  問得越多，小佩越懂你。          │  ← 鼓勵文案
│                                  │
│  每日 00:00 自動重置             │  ← 小字說明
│                                  │
│  [去提問]                        │  ← 按鈕
└─────────────────────────────────┘
```

#### 數據來源
- `status.aiCallsToday` → 已使用次數
- `status.aiDailyLimit` → 每日限制（會員：100次）
- `status.aiRemaining` → 剩餘次數

#### 按鈕功能
- **去提問**：跳轉到主要聊天/解讀入口（`ChatScreen` 或 `HomeScreen`）

---

### 3️⃣ 會員權益卡：不是推銷，而是「已解鎖」

#### 設計要素
- 語氣從「你可以得到什麼」→「你已解鎖什麼」
- 使用 ✅ 標記已解鎖
- 強調肯定和獎勵感

#### UI 結構
```
┌─────────────────────────────────┐
│  會員權益                        │  ← 標題
│                                  │
│  ✅ 每天 100 次 AI 解讀與問答    │
│  ✅ 可使用全部八字功能與工具      │
│  ✅ 可保存 50 個命盤              │
│  ✅ 優先處理之後上線的新功能      │
│                                  │
│  後續有新功能會優先開放給小佩會員。│  ← 小字提示
└─────────────────────────────────┘
```

#### 權益列表（固定數據）
- ✅ 每天 100 次 AI 解讀與問答
- ✅ 可使用全部八字功能與工具
- ✅ 可保存 50 個命盤（或更寬鬆的數量）
- ✅ 優先處理之後上線的新功能

#### 可選按鈕
- 如果要做詳情頁：`會員權益` 按鈕
- 如果純展示：不需要按鈕

---

### 4️⃣ 管理區：給他「掌控感」

#### 設計要素
- 透明展示扣款信息
- 清晰的訂閱管理入口
- 減少退訂焦慮

#### UI 結構
```
┌─────────────────────────────────┐
│  訂閱管理                        │  ← 區塊標題
│                                  │
│  當前方案                        │
│  目前為 季付方案 · HK$ 99 / 季   │  ← 方案信息
│                                  │
│  下一次扣款                      │
│  下一次扣款日：2025-03-12        │  ← 扣款日期
│                                  │
│  扣款平台                        │
│  由 App Store 代扣款             │  ← 扣款平台
│                                  │
│  [管理訂閱]  [恢復購買]           │  ← 按鈕
│  [升級方案]（可選）               │
└─────────────────────────────────┘
```

#### 數據來源
- `status.proPlan` → 轉換為方案名稱和價格
- `status.proExpiresAt` → 計算下一次扣款日
- 扣款平台：固定為「App Store」（iOS）

#### 價格映射
- `monthly` → HK$ 39 / 月
- `quarterly` → HK$ 99 / 季
- `yearly` → HK$ 348 / 年

#### 按鈕功能
- **管理訂閱**：複用現有的 iOS 訂閱管理邏輯
- **恢復購買**：沿用現在的訂閱邏輯，但需要設計好訂購時間邏輯
- **升級方案**：❌ 不需要（用戶訂閱到期再升級）

---

### 5️⃣ ~~行為引導卡：下一步做什麼？~~ ❌ 不需要

**決定**：根據需求確認，此模組不需要實現。

---

### 6️⃣ 特殊狀態處理

#### 6.1 即將到期（7天內）

#### UI 結構
```
┌─────────────────────────────────┐
│  小佩會員 · 即將到期            │  ← 標題（黃色警告）
│                                  │
│  ⚠️ 距離本期到期還有 5 天，      │  ← 警告提示（黃色背景）
│     別忘了留意訂閱狀態。          │
│                                  │
│  [管理訂閱]  [續訂說明]          │  ← 按鈕
└─────────────────────────────────┘
```

#### 邏輯
- 計算 `proExpiresAt` 與當前日期的差值
- 如果 ≤ 7 天 → 顯示警告提示
- 按鈕顯示「管理訂閱」
- **續訂說明**：❓ 待確認是否需要（見下方問題）

---

#### 6.2 已過期但還停留在此頁

#### UI 結構
```
┌─────────────────────────────────┐
│  ⚠️ 你的會員已於 2025-03-12 到期  │  ← 過期提示（紅色背景）
│                                  │
│  [重新訂閱]                      │  ← 按鈕
└─────────────────────────────────┘
```

#### 邏輯
- 如果 `proExpiresAt < 當前日期` → 顯示過期提示
- 自動跳轉回銷售頁（`ProSubscriptionScreen`）
- 或在會員中心頂部顯示過期提示 + 「重新訂閱」按鈕

---

## 🔧 技術實現方案

### 頁面路由
```typescript
// MeScreen.tsx
{profile?.isPro ? (
  <Cell
    icon={Crown}
    iconBg={colors.greenSoftBg}
    iconColor={colors.primary}
    label={t('me.xiaopeiService')}
    desc="查看會員狀態與權益"
    onPress={() => handleNavigate(SCREEN_NAMES.PRO_MEMBER_CENTER)}
  />
) : (
  <Cell
    icon={Crown}
    iconBg="#FFF8F0"
    iconColor={colors.brandOrange}
    label={t('me.upgradePro')}
    desc={t('me.upgradeProDesc')}
    badge={t('me.recommended')}
    onPress={() => handleNavigate(SCREEN_NAMES.PRO_SUBSCRIPTION)}
  />
)}
```

### 數據接口
- 使用現有 `proService.getStatus()` 獲取會員狀態
- 需要新增接口獲取訂閱詳情（扣款日期、訂閱狀態等）

### 組件結構
```
ProMemberCenterScreen
├── StatusCard (頂部狀態卡)
├── UsageCard (使用情況卡)
├── BenefitsCard (會員權益卡)
├── ManagementCard (管理區)
└── ExpiryWarning (特殊狀態提示)
```

**注意**：不包含 `ActionCard`（行為引導卡），因為不需要。

---

## ✅ 已確認的設計決策

### 1. 訂閱詳情數據
**方案**：使用現有接口
- `proService.getStatus()` → 獲取會員狀態和 AI 使用情況
- `proService.getSubscriptionHistory()` → 獲取訂閱歷史（包含 `startedAt`、`expiresAt`）
- **下一次扣款日** = `expiresAt`（對於自動續訂的情況）

**數據結構**：
```typescript
interface MembershipStatus {
  isPro: boolean;
  proPlan: 'monthly' | 'quarterly' | 'yearly' | null;
  proExpiresAt: string | null;
  aiCallsToday: number;
  aiDailyLimit: number;
  aiRemaining: number;
}

interface SubscriptionDto {
  subscriptionId: number;
  plan: 'monthly' | 'quarterly' | 'yearly';
  status: 'active' | 'canceled' | 'expired';
  startedAt: string; // ISO 8601
  expiresAt?: string; // ISO 8601（下一次扣款日）
}
```

---

### 2. iOS 訂閱管理跳轉
**方案**：複用現有的 iOS 訂閱管理邏輯

**需要確認**：現有的 iOS 訂閱管理邏輯在哪裡？如何調用？

**可能的實現方式**：
- 如果已有 `react-native-iap` 或類似庫 → 直接調用現有方法
- 如果沒有 → 使用 `Linking.openURL('https://apps.apple.com/account/subscriptions')`

---

### 3. iOS 恢復購買
**方案**：沿用現在的訂閱邏輯，但需要設計好訂購時間邏輯

#### 時間邏輯設計

**場景 1：用戶之前有訂閱記錄（未過期）**
```
用戶最後一次訂閱：2025-01-01 開始，2025-03-01 到期
當前時間：2025-02-15
恢復購買：從 2025-03-01 開始累加（因為未過期）
```

**場景 2：用戶之前有訂閱記錄（已過期）**
```
用戶最後一次訂閱：2025-01-01 開始，2025-02-01 到期
當前時間：2025-02-15（已過期 14 天）
恢復購買：從當前時間 2025-02-15 開始計算（因為已過期）
```

**場景 3：用戶沒有訂閱記錄**
```
用戶從未訂閱過
恢復購買：從當前時間開始計算
```

#### 實現邏輯（後端）

```typescript
// 偽代碼
async function restorePurchase(userId: string, plan: PlanType) {
  // 1. 查詢用戶最後一條訂閱記錄
  const lastSubscription = await getLastSubscription(userId);
  
  // 2. 計算開始時間
  let baseDate: Date;
  if (lastSubscription && lastSubscription.expiresAt) {
    const expiresAt = new Date(lastSubscription.expiresAt);
    const now = new Date();
    
    // 如果未過期，從到期日開始累加
    if (expiresAt > now) {
      baseDate = expiresAt;
    } else {
      // 如果已過期，從當前時間開始
      baseDate = now;
    }
  } else {
    // 沒有訂閱記錄，從當前時間開始
    baseDate = new Date();
  }
  
  // 3. 計算到期時間
  const expiresAt = calculateExpiresAt(baseDate, plan);
  
  // 4. 創建新訂閱記錄
  await createSubscription(userId, plan, baseDate, expiresAt);
}
```

#### 前端調用

```typescript
// 恢復購買按鈕點擊
const handleRestorePurchase = async () => {
  try {
    // 調用恢復購買接口（需要後端實現）
    await proService.restorePurchase();
    // 重新加載狀態
    await loadStatus();
    Alert.alert('恢復成功', '已恢復您的訂閱');
  } catch (error) {
    Alert.alert('恢復失敗', error.message);
  }
};
```

#### 後端接口需求

**需要新增接口**：
- `POST /api/v1/pro/restore-purchase`
- 或擴展現有的訂閱接口，支持恢復購買邏輯

---

### 4. 升級方案功能
**決定**：❌ 不需要實現

**說明**：用戶訂閱到期後再升級，不需要在會員中心提供升級功能。

---

### 5. 行為引導卡
**決定**：❌ 不需要實現

**說明**：根據需求確認，此模組不需要。

---

### 6. 命盤數量限制
**需要確認**：會員的命盤數量限制是多少？

**當前信息**：
- 免費版：10 個命盤（從現有代碼看到）
- 會員版：需要確認後端實際限制

**建議**：在權益卡中顯示實際的限制數量。

---

### 7. 續訂說明功能
**問題**：是否需要「續訂說明」功能？

**選項**：
- A. 需要 → 顯示簡單對話框說明續訂流程
- B. 不需要 → 只顯示「管理訂閱」按鈕

**待確認**：請告知是否需要此功能。

---

## 📝 實施計劃

### Phase 1: 基礎結構（必須）
1. ✅ 創建 `ProMemberCenterScreen` 組件
2. ✅ 實現頂部狀態卡
3. ✅ 實現使用情況卡
4. ✅ 實現會員權益卡
5. ✅ 實現管理區（基礎版）

### Phase 2: 特殊狀態（必須）
6. ✅ 實現即將到期提示（7天內）
7. ✅ 實現已過期處理（自動跳轉回銷售頁）

### Phase 3: 功能完善（必須）
8. ✅ 實現 iOS 訂閱管理跳轉（複用現有邏輯）
9. ✅ 實現 iOS 恢復購買（設計好訂購時間邏輯）
10. ❓ 續訂說明功能（待確認是否需要）

### Phase 4: 不需要的功能
- ❌ 行為引導卡（不需要）
- ❌ 升級方案功能（不需要，到期再升級）

---

## 🎯 下一步行動

### 待確認事項
1. **續訂說明功能**：是否需要？如果需要，顯示方式是什麼？
2. **iOS 訂閱管理邏輯**：現有的邏輯在哪裡？如何調用？
3. **命盤數量限制**：會員版的實際限制是多少？

### 已確認事項
- ✅ 此頁面只針對已經訂閱了的用戶
- ✅ 不需要行為引導卡
- ✅ 不需要升級方案功能（到期再升級）
- ✅ iOS 恢復購買需要設計好訂購時間邏輯

### 實施順序
1. **Phase 1**：實現基礎結構（頂部狀態卡、使用情況卡、會員權益卡、管理區）
2. **Phase 2**：實現特殊狀態處理（即將到期、已過期）
3. **Phase 3**：實現 iOS 訂閱管理和恢復購買功能

---

## 📚 參考資料

- 現有組件：`ProSubscriptionScreen.tsx`
- API 服務：`proService.ts`
- 設計規範：`UI_SPEC.md`（如果有的話）

