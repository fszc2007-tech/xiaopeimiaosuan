# å…«å­—å¼•æ“ CPU å¼€é”€ç°çŠ¶åˆ†æ

**åˆ†ææ—¶é—´**: 2025-01-XX  
**å¼•æ“ç‰ˆæœ¬**: v6.0  
**ç›®æ ‡**: è¯„ä¼°å½“å‰æ’ç›˜é€»è¾‘çš„ CPU å¼€é”€ï¼Œä¸ºåç»­ä¼˜åŒ–æä¾›ä¾æ®

---

## ä¸€ã€å½“å‰æ¶æ„æ¦‚è§ˆ

### 1.1 è°ƒç”¨é“¾è·¯

```
å‰ç«¯è¯·æ±‚
  â†“
baziService.computeChart()
  â†“
æ£€æŸ¥ bazi_charts è¡¨ç¼“å­˜ï¼ˆâœ… å·²æœ‰æŒä¹…åŒ–ï¼‰
  â†“
computeBaziChart() â†’ spawn('node', ['runner.mjs'])  // âš ï¸ æ¯æ¬¡å¯åŠ¨å­è¿›ç¨‹
  â†“
BaziEngine.compute()  // æ ¸å¿ƒè®¡ç®—é€»è¾‘
  â†“
ä¿å­˜åˆ° bazi_charts è¡¨
```

### 1.2 å…³é”®å‘ç°

**âœ… å·²æœ‰ç¼“å­˜æœºåˆ¶**ï¼š
- `bazi_charts` è¡¨å­˜å‚¨å®Œæ•´è®¡ç®—ç»“æœï¼ˆ`result_json` LONGTEXTï¼‰
- é¦–æ¬¡æ’ç›˜åå†™å…¥æ•°æ®åº“ï¼Œåç»­ç›¸åŒå‘½ç›˜ç›´æ¥è¯»å–
- ç¼“å­˜å‘½ä¸­æ—¶**ä¸ä¼šè°ƒç”¨å¼•æ“**ï¼ŒCPU å¼€é”€ä¸º 0

**âš ï¸ è®¡ç®—æ—¶çš„å¼€é”€**ï¼š
- æ¯æ¬¡è®¡ç®—éƒ½ä¼š `spawn` ä¸€ä¸ªæ–°çš„ Node å­è¿›ç¨‹
- å­è¿›ç¨‹å¯åŠ¨å¼€é”€ + è®¡ç®—å¼€é”€

---

## äºŒã€è®¡ç®—å¤æ‚åº¦åˆ†æ

### 2.1 æ ¸å¿ƒè®¡ç®—æ­¥éª¤ï¼ˆ`BaziEngine.compute()`ï¼‰

æ ¹æ® `core/engine/index.js` åˆ†æï¼Œå•æ¬¡æ’ç›˜åŒ…å«ä»¥ä¸‹æ­¥éª¤ï¼š

| æ­¥éª¤ | æ¨¡å— | å¤æ‚åº¦ | è¯´æ˜ |
|------|------|--------|------|
| 1. æ—¶é—´å¤„ç† | `lunarToSolar` / `parseTZFlexible` | O(1) | ç®€å•è½¬æ¢ |
| 2. å››æŸ±è®¡ç®— | `yearPillarByLichun` / `monthPillar` / `dayPillar` / `hourPillar` | O(1) | æŸ¥è¡¨ä¸ºä¸» |
| 3. ä¸°å¯Œå››æŸ± | `enrichPillar()` Ã— 4 | O(1) | è—å¹²ã€çº³éŸ³ã€åç¥ç­‰æŸ¥è¡¨ |
| 4. ç¥ç…è®¡ç®— | `computeShensha()` | **O(N)** | N = ç¥ç…è§„åˆ™æ•°ï¼ˆ~30+ï¼‰ |
| 5. å¤§è¿æµå¹´ | `computeAllFortunes()` | **O(M)** | M = å¤§è¿å‘¨æœŸæ•°ï¼ˆ~10ï¼‰ |
| 6. æ—¥ä¸»å¼ºå¼± | `computeDayMasterStrength()` | O(1) | æŸ¥è¡¨è®¡ç®— |
| 7. äº”è¡Œåˆ†å¸ƒ | `computeWuXing()` | O(1) | ç®€å•ç»Ÿè®¡ |
| 8. ç”¨ç¥å–œå¿Œ | `computeFavoredAvoid()` | O(1) | æŸ¥è¡¨ |
| 9. æ ¼å±€åˆ¤æ–­ | `judgeStructure()` | **O(K)** | K = æ ¼å±€å€™é€‰æ•°ï¼ˆ~20+ï¼‰ï¼ŒåŒ…å«å¾ªç¯éå†æ‰€æœ‰å¤©å¹² |
| 10. åšåŠŸåˆ†æ | `analyzeDogong()` | **O(P)** | P = å…³ç³»å›¾èŠ‚ç‚¹æ•°ï¼ŒåŒ…å«å›¾éå† |
| 11. ä½“ç”¨åˆ†æ | `analyzeTiyong()` | O(1) | åŸºäºåšåŠŸç»“æœ |
| 12. ç»¼åˆçº¯åº¦ | `calculatePurity()` | **O(Q)** | Q = å¤šä¸ªå­æ¨¡å—ï¼ŒåŒ…å«äº¤å‰éªŒè¯å¾ªç¯ |
| 13. è°ƒå€™åˆ†æ | `getTiaohouRules()` | O(1) | æŸ¥è¡¨ |
| 14. å®«ä½è®¡ç®— | `calculateAllPalaces()` | O(1) | æŸ¥è¡¨ |

### 2.2 å¾ªç¯æ“ä½œç»Ÿè®¡

åœ¨ `core/engine/analysis/` ç›®å½•ä¸‹å‘ç°ï¼š
- **183 ä¸ªå¾ªç¯æ“ä½œ**ï¼ˆ`for` / `forEach` / `map` / `filter` / `reduce`ï¼‰
- ä¸»è¦é›†ä¸­åœ¨ï¼š
  - `purity.js`: 70 ä¸ªå¾ªç¯
  - `structure.js`: 13 ä¸ªå¾ªç¯
  - `dogong.js`: 11 ä¸ªå¾ªç¯
  - `patternPurity.js`: 20 ä¸ªå¾ªç¯
  - `tiyong.js`: 13 ä¸ªå¾ªç¯

### 2.3 æŸ¥è¡¨æ“ä½œ

å¤§é‡æŸ¥è¡¨æ“ä½œï¼ˆMap/Set/å¯¹è±¡æŸ¥æ‰¾ï¼‰ï¼š
- ç¥ç…è§„åˆ™è¡¨ï¼š~30+ ä¸ªè§„åˆ™å‡½æ•°
- æ ¼å±€å€™é€‰è¡¨ï¼š~20+ ä¸ªæ ¼å±€æ¨¡å¼
- äº”è¡Œå…³ç³»è¡¨ï¼šç”Ÿå…‹å…³ç³»ã€åç¥å…³ç³»ç­‰
- è—å¹²è¡¨ã€çº³éŸ³è¡¨ã€åäºŒé•¿ç”Ÿè¡¨ç­‰

**æŸ¥è¡¨å¤æ‚åº¦**: O(1)ï¼Œä½†**æ•°é‡å¤š**ï¼ˆç´¯è®¡å¼€é”€ä¸å¯å¿½è§†ï¼‰

---

## ä¸‰ã€æ€§èƒ½ç“¶é¢ˆè¯†åˆ«

### 3.1 ğŸ”´ æ½œåœ¨é«˜å¼€é”€æ¨¡å—

#### 1. **ç¥ç…è®¡ç®—** (`computeShensha`)
```javascript
// core/engine/index.js:3101
for(const name of Object.keys(RULES)){  // ~30+ æ¬¡å¾ªç¯
  const hits = RULES[name](ctx);
  for(const pillar in hits){            // æœ€å¤š 4 æ¬¡ï¼ˆå¹´/æœˆ/æ—¥/æ—¶ï¼‰
    uniqPush(out, pillar, name);
  }
}
```
- **å¤æ‚åº¦**: O(30 Ã— 4) = O(120) æ¬¡æŸ¥è¡¨/æ¯”è¾ƒ
- **å¼€é”€**: ä¸­ç­‰ï¼ˆä¸»è¦æ˜¯æŸ¥è¡¨ï¼Œæ— æ·±åº¦å¾ªç¯ï¼‰

#### 2. **æ ¼å±€åˆ¤æ–­** (`judgeStructure`)
```javascript
// core/engine/analysis/structure.js:54-74
const all = ['year', 'month', 'day', 'hour']
  .filter(k => pillars[k])
  .flatMap(k => {
    return collectAllStems(p).map(h => {  // éå†æ‰€æœ‰å¤©å¹²ï¼ˆå«è—å¹²ï¼‰
      // è®¡ç®—æƒé‡ã€å­£èŠ‚æ”¯æŒç­‰
    });
  });
```
- **å¤æ‚åº¦**: O(4 æŸ± Ã— 3-4 è—å¹²) = O(12-16) æ¬¡éå†
- **å¼€é”€**: ä¸­ç­‰ï¼ˆéœ€è¦éå†æ‰€æœ‰å¤©å¹²å¹¶è®¡ç®—æƒé‡ï¼‰

#### 3. **ç»¼åˆçº¯åº¦è®¡ç®—** (`calculatePurity`)
```javascript
// core/engine/analysis/purity.js
// åŒ…å«å¤šä¸ªå­æ¨¡å—ï¼š
// - æ ¼å±€çº¯åº¦è®¡ç®—
// - ç”¨ç¥å¾—åŠ›è®¡ç®—
// - äº”è¡Œæµé€šè®¡ç®—ï¼ˆå›¾éå†ï¼‰
// - åç¥é…åˆè®¡ç®—
// - è°ƒå€™å¾—å¤±è®¡ç®—
// - äº¤å‰éªŒè¯å¾ªç¯
```
- **å¤æ‚åº¦**: O(å¤šä¸ªå­æ¨¡å— Ã— äº¤å‰éªŒè¯)
- **å¼€é”€**: **è¾ƒé«˜**ï¼ˆ70 ä¸ªå¾ªç¯æ“ä½œï¼ŒåŒ…å«å›¾éå†å’Œäº¤å‰éªŒè¯ï¼‰

#### 4. **å¤§è¿æµå¹´è®¡ç®—** (`computeAllFortunes`)
```javascript
// core/engine/fortune/index.js
// éœ€è¦è®¡ç®—ï¼š
// - èµ·è¿æ—¶é—´ï¼ˆæ¶‰åŠå¤ªé˜³é»„ç»è¿­ä»£è®¡ç®—ï¼Œæœ€å¤š 40 æ¬¡è¿­ä»£ï¼‰
// - å¤šä¸ªå¤§è¿å‘¨æœŸï¼ˆ~10 ä¸ªï¼‰
// - æµå¹´ï¼ˆæ¯å¹´ä¸€ä¸ªï¼‰
// - æµæœˆï¼ˆæ¯æœˆä¸€ä¸ªï¼‰
```
- **å¤æ‚åº¦**: O(10 å¤§è¿ + N æµå¹´ + 12Ã—N æµæœˆ)
- **å¼€é”€**: **è¾ƒé«˜**ï¼ˆå¤ªé˜³é»„ç»è®¡ç®—æ¶‰åŠæ•°å€¼è¿­ä»£ï¼Œ`solveSolarLongitude` æœ€å¤š 40 æ¬¡è¿­ä»£ï¼‰

#### 5. **åšåŠŸåˆ†æ** (`analyzeDogong`)
```javascript
// core/engine/analysis/dogong.js
// æ„å»ºå…³ç³»å›¾ + å›¾éå†
function buildRelationshipGraph(pillars, dayMaster) {
  // éå†æ‰€æœ‰å¤©å¹²åœ°æ”¯ï¼Œæ„å»ºå›¾
  // ç„¶åè¿›è¡Œå›¾éå†ï¼ˆDFS/BFSï¼‰
}
```
- **å¤æ‚åº¦**: O(èŠ‚ç‚¹æ•° Ã— è¾¹æ•°)
- **å¼€é”€**: ä¸­ç­‰ï¼ˆå›¾éå†ï¼‰

### 3.2 âš ï¸ å­è¿›ç¨‹å¯åŠ¨å¼€é”€

**å½“å‰å®ç°** (`core/src/modules/bazi/engine.ts`):
```typescript
const child = spawn('node', [runnerPath], {
  stdio: ['pipe', 'pipe', 'pipe'],
});
```

**é—®é¢˜**ï¼š
- æ¯æ¬¡è®¡ç®—éƒ½å¯åŠ¨æ–°çš„ Node è¿›ç¨‹
- è¿›ç¨‹å¯åŠ¨å¼€é”€ï¼š~10-50msï¼ˆå–å†³äºç³»ç»Ÿï¼‰
- å¦‚æœå¹¶å‘ 100 æ¬¡æ’ç›˜ï¼Œä¼šå¯åŠ¨ 100 ä¸ªå­è¿›ç¨‹

**å½±å“**ï¼š
- å†…å­˜å¼€é”€ï¼šæ¯ä¸ªè¿›ç¨‹ ~30-50MB
- CPU å¼€é”€ï¼šè¿›ç¨‹åˆ›å»º/é”€æ¯
- æ–‡ä»¶æè¿°ç¬¦ï¼šæ¯ä¸ªè¿›ç¨‹å ç”¨ 3 ä¸ªï¼ˆstdin/stdout/stderrï¼‰

---

## å››ã€å¹¶å‘åœºæ™¯åˆ†æ

### 4.1 å½“å‰å¹¶å‘èƒ½åŠ›

**å‡è®¾åœºæ™¯**ï¼šè¿ç»­æ’ 100 æ¬¡å‘½ç›˜

**å½“å‰è¡Œä¸º**ï¼š
1. å¦‚æœéƒ½æ˜¯**æ–°å‘½ç›˜**ï¼ˆæ— ç¼“å­˜ï¼‰ï¼š
   - å¯åŠ¨ 100 ä¸ªå­è¿›ç¨‹
   - æ¯ä¸ªè¿›ç¨‹æ‰§è¡Œå®Œæ•´è®¡ç®—ï¼ˆ~200-500msï¼‰
   - **CPU å¯èƒ½é£™åˆ° 100%**ï¼ˆç‰¹åˆ«æ˜¯å¤šæ ¸ CPU æ—¶ï¼‰

2. å¦‚æœéƒ½æ˜¯**å·²ç¼“å­˜å‘½ç›˜**ï¼š
   - ç›´æ¥æŸ¥æ•°æ®åº“ï¼Œ**CPU å¼€é”€æ¥è¿‘ 0**

### 4.2 é£é™©ç‚¹

**ğŸ”´ é«˜é£é™©åœºæ™¯**ï¼š
- **æ‰¹é‡å¯¼å…¥**ï¼šä¸€æ¬¡æ€§å¯¼å…¥ 100+ ä¸ªæ–°å‘½ç›˜
- **é«˜å¹¶å‘è¯·æ±‚**ï¼šå¤šä¸ªç”¨æˆ·åŒæ—¶æ’ç›˜
- **å¼ºåˆ¶é‡ç®—**ï¼š`forceRecompute=true` æ—¶å¿½ç•¥ç¼“å­˜

**å½±å“**ï¼š
- Node ä¸»è¿›ç¨‹ CPU å¯èƒ½è¾¾åˆ° 100%
- å­è¿›ç¨‹åˆ›å»ºè¿‡å¤šï¼Œç³»ç»Ÿèµ„æºè€—å°½
- æ•°æ®åº“è¿æ¥æ± å¯èƒ½è¢«å æ»¡ï¼ˆå½“å‰ `connectionLimit: 10`ï¼‰

---

## äº”ã€ç¼“å­˜æœºåˆ¶ç°çŠ¶

### 5.1 ç¼“å­˜å®ç°

**ä½ç½®**: `core/src/modules/bazi/baziService.ts:58-73`

```typescript
// 2. æ£€æŸ¥æ˜¯å¦å·²æœ‰è®¡ç®—ç»“æœï¼ˆä¸”ç‰ˆæœ¬åŒ¹é…ï¼‰
if (!forceRecompute) {
  const [chartRows]: any = await pool.execute(
    `SELECT * FROM bazi_charts 
     WHERE chart_profile_id = ? AND engine_version = ? AND needs_update = FALSE
     ORDER BY created_at DESC LIMIT 1`,
    [profileId, CURRENT_ENGINE_VERSION]
  );
  
  if (chartRows.length > 0) {
    return {
      chartId: chartRows[0].chart_id,
      chartProfileId: profileId,
      result: JSON.parse(chartRows[0].result_json),  // âœ… ç›´æ¥è¿”å›ç¼“å­˜
    };
  }
}
```

**âœ… ä¼˜ç‚¹**ï¼š
- é¦–æ¬¡æ’ç›˜åæŒä¹…åŒ–åˆ°æ•°æ®åº“
- åç»­ç›¸åŒå‘½ç›˜ç›´æ¥è¯»å–ï¼Œ**ä¸è°ƒç”¨å¼•æ“**
- æ”¯æŒç‰ˆæœ¬æ§åˆ¶ï¼ˆ`engine_version`ï¼‰

**âš ï¸ æ½œåœ¨é—®é¢˜**ï¼š
- ç¼“å­˜æŸ¥è¯¢ä¾èµ–æ•°æ®åº“ï¼ˆå¦‚æœæ•°æ®åº“æ…¢ï¼Œç¼“å­˜ä¹Ÿæ…¢ï¼‰
- æ²¡æœ‰å†…å­˜ç¼“å­˜å±‚ï¼ˆRedis/å†…å­˜ç¼“å­˜ï¼‰
- ç›¸åŒ `chart_profile_id` ä½†ä¸åŒ `birth` å‚æ•°å¯èƒ½å‘½ä¸­é”™è¯¯ç¼“å­˜ï¼ˆä½†å½“å‰å®ç°ä¸­ `chart_profile_id` åº”è¯¥å·²ç»åŒ…å«å‡ºç”Ÿä¿¡æ¯ï¼‰

---

## å…­ã€å‹æµ‹å»ºè®®

### 6.1 æœ¬åœ°å‹æµ‹æ–¹æ¡ˆ

**ç›®æ ‡**: è¿ç»­æ’ 100 æ¬¡å‘½ç›˜ï¼Œè§‚å¯Ÿ CPU ä½¿ç”¨ç‡

**æµ‹è¯•è„šæœ¬**ï¼ˆå»ºè®®åˆ›å»ºï¼‰:
```javascript
// scripts/stress-test-bazi.js
const { computeChart } = require('../core/src/modules/bazi/baziService');

async function stressTest() {
  const startTime = Date.now();
  const promises = [];
  
  // ç”Ÿæˆ 100 ä¸ªä¸åŒçš„å‡ºç”Ÿä¿¡æ¯
  for (let i = 0; i < 100; i++) {
    const birth = {
      year: 1990 + (i % 30),
      month: 1 + (i % 12),
      day: 1 + (i % 28),
      hour: i % 24,
      minute: 0,
      tz: '+08:00'
    };
    
    promises.push(
      computeChart({
        userId: 'test-user',
        name: `æµ‹è¯•${i}`,
        gender: i % 2 === 0 ? 'male' : 'female',
        birth,
        forceRecompute: true  // å¼ºåˆ¶é‡ç®—ï¼Œä¸ä½¿ç”¨ç¼“å­˜
      }).catch(err => {
        console.error(`[${i}] å¤±è´¥:`, err.message);
        return null;
      })
    );
  }
  
  const results = await Promise.all(promises);
  const endTime = Date.now();
  
  console.log(`\nâœ… å®Œæˆ 100 æ¬¡æ’ç›˜`);
  console.log(`æ€»è€—æ—¶: ${endTime - startTime}ms`);
  console.log(`å¹³å‡è€—æ—¶: ${(endTime - startTime) / 100}ms`);
  console.log(`æˆåŠŸ: ${results.filter(r => r !== null).length} / 100`);
}

stressTest();
```

**ç›‘æ§æŒ‡æ ‡**ï¼š
- CPU ä½¿ç”¨ç‡ï¼ˆ`top` / `htop`ï¼‰
- å†…å­˜ä½¿ç”¨ï¼ˆ`ps aux`ï¼‰
- è¿›ç¨‹æ•°ï¼ˆ`ps aux | grep node | wc -l`ï¼‰
- å“åº”æ—¶é—´åˆ†å¸ƒ

### 6.2 é¢„æœŸç»“æœ

**å¦‚æœ CPU é£™åˆ° 100%**ï¼š
- âœ… ç¡®è®¤éœ€è¦ä¼˜åŒ–
- å»ºè®®ï¼šæŒä¹…åŒ–ç¼“å­˜ + é™æµ + worker_threads

**å¦‚æœ CPU < 50%**ï¼š
- âœ… å½“å‰æ€§èƒ½å¯æ¥å—
- å»ºè®®ï¼šä¿æŒç°çŠ¶ï¼Œç›‘æ§å³å¯

---

## ä¸ƒã€ä¼˜åŒ–å»ºè®®ï¼ˆæŒ‰ä¼˜å…ˆçº§ï¼‰

### 7.1 P0 - ç«‹å³ä¼˜åŒ–ï¼ˆå¦‚æœå‹æµ‹å‘ç° CPU 100%ï¼‰

#### æ–¹æ¡ˆ 1: ä¼˜åŒ–å­è¿›ç¨‹å¯åŠ¨ï¼ˆæ”¹ä¸ºç›´æ¥è°ƒç”¨ï¼‰

**å½“å‰é—®é¢˜**ï¼š
- æ¯æ¬¡è®¡ç®—éƒ½ `spawn` æ–°è¿›ç¨‹

**ä¼˜åŒ–æ–¹æ¡ˆ**ï¼š
```typescript
// æ”¹ä¸ºç›´æ¥å¯¼å…¥å¼•æ“ï¼ˆå¦‚æœå¼•æ“æ˜¯çº¯ JSï¼Œæ— å‰¯ä½œç”¨ï¼‰
import { BaziEngine } from '../../../engine/index.js';

export async function computeBaziChart(birthInfo: BirthInfo): Promise<any> {
  const engine = new BaziEngine();
  return await engine.compute(birthInfo);
}
```

**é¢„æœŸæ•ˆæœ**ï¼š
- æ¶ˆé™¤å­è¿›ç¨‹å¯åŠ¨å¼€é”€ï¼ˆ~10-50msï¼‰
- å‡å°‘å†…å­˜å ç”¨ï¼ˆæ¯ä¸ªè¿›ç¨‹ ~30-50MBï¼‰
- æå‡å¹¶å‘èƒ½åŠ›

**é£é™©**ï¼š
- éœ€è¦ç¡®ä¿å¼•æ“ä»£ç æ— å‰¯ä½œç”¨ï¼Œå¯å®‰å…¨åœ¨ä¸»è¿›ç¨‹è¿è¡Œ
- å¦‚æœå¼•æ“æœ‰å…¨å±€çŠ¶æ€ï¼Œå¯èƒ½å½±å“å¹¶å‘

#### æ–¹æ¡ˆ 2: æ·»åŠ å†…å­˜ç¼“å­˜å±‚

**å½“å‰é—®é¢˜**ï¼š
- ç¼“å­˜åªå­˜åœ¨æ•°æ®åº“ï¼ŒæŸ¥è¯¢æœ‰å»¶è¿Ÿ

**ä¼˜åŒ–æ–¹æ¡ˆ**ï¼š
```typescript
import NodeCache from 'node-cache';

const chartCache = new NodeCache({
  stdTTL: 3600,  // 1 å°æ—¶
  maxKeys: 1000  // æœ€å¤šç¼“å­˜ 1000 ä¸ª
});

export async function computeChart(params) {
  // 1. å…ˆæŸ¥å†…å­˜ç¼“å­˜
  const cacheKey = `${params.chartProfileId}_${params.birth.year}-${params.birth.month}-${params.birth.day}`;
  const cached = chartCache.get(cacheKey);
  if (cached) {
    return cached;
  }
  
  // 2. å†æŸ¥æ•°æ®åº“ç¼“å­˜
  // ... ç°æœ‰é€»è¾‘ ...
  
  // 3. è®¡ç®—åå†™å…¥å†…å­˜ç¼“å­˜
  chartCache.set(cacheKey, result);
  return result;
}
```

**é¢„æœŸæ•ˆæœ**ï¼š
- ç¼“å­˜å‘½ä¸­æ—¶å»¶è¿Ÿï¼šæ•°æ®åº“æŸ¥è¯¢ï¼ˆ~10msï¼‰â†’ å†…å­˜è¯»å–ï¼ˆ<1msï¼‰
- å‡å°‘æ•°æ®åº“å‹åŠ›

### 7.2 P1 - é‡è¦ä¼˜åŒ–ï¼ˆå¦‚æœå¹¶å‘å‹åŠ›å¤§ï¼‰

#### æ–¹æ¡ˆ 3: ä½¿ç”¨ worker_threadsï¼ˆçœŸæ­£æ‰›ä¸ä½æ—¶ï¼‰

**é€‚ç”¨åœºæ™¯**ï¼š
- å‹æµ‹å‘ç° CPU 100%ï¼Œä¸”ä¼˜åŒ–å­è¿›ç¨‹åä»ä¸å¤Ÿ

**å®ç°æ–¹æ¡ˆ**ï¼š
```typescript
import { Worker } from 'worker_threads';

const workerPool = new Map();

function getWorker() {
  // å¤ç”¨ workerï¼Œé¿å…é¢‘ç¹åˆ›å»º
  if (workerPool.size < 4) {  // æœ€å¤š 4 ä¸ª workerï¼ˆå¯¹åº” 4 æ ¸ CPUï¼‰
    const worker = new Worker(path.resolve(__dirname, './bazi-worker.js'));
    workerPool.set(worker.threadId, worker);
    return worker;
  }
  // å¦‚æœ worker æ± æ»¡äº†ï¼Œç­‰å¾…æˆ–æ’é˜Ÿ
  // ...
}
```

**é¢„æœŸæ•ˆæœ**ï¼š
- åˆ©ç”¨å¤šæ ¸ CPUï¼Œå¹¶è¡Œè®¡ç®—
- éš”ç¦»è®¡ç®—é€»è¾‘ï¼Œä¸å½±å“ä¸»è¿›ç¨‹

**å®æ–½æˆæœ¬**: â­â­â­ é«˜ï¼ˆéœ€è¦é‡æ„ï¼‰

### 7.3 P2 - é•¿æœŸä¼˜åŒ–

#### æ–¹æ¡ˆ 4: ç‹¬ç«‹è®¡ç®—æœåŠ¡ï¼ˆå¾®æœåŠ¡åŒ–ï¼‰

**é€‚ç”¨åœºæ™¯**ï¼š
- çœŸæ­£é«˜å¹¶å‘ï¼ˆ10,000+ QPSï¼‰
- éœ€è¦ç‹¬ç«‹æ‰©ç¼©å®¹

**æ¶æ„**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Core  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  Bazi Serviceâ”‚  (ç‹¬ç«‹æœåŠ¡ï¼Œå¯æ°´å¹³æ‰©å±•)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  HTTP  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å®æ–½æˆæœ¬**: â­â­â­â­ å¾ˆé«˜

---

## å…«ã€æ€»ç»“

### 8.1 å½“å‰çŠ¶æ€

**âœ… å·²æœ‰æœºåˆ¶**ï¼š
- æ•°æ®åº“æŒä¹…åŒ–ç¼“å­˜ï¼ˆ`bazi_charts` è¡¨ï¼‰
- ç¼“å­˜å‘½ä¸­æ—¶ä¸è°ƒç”¨å¼•æ“

**âš ï¸ æ½œåœ¨é—®é¢˜**ï¼š
- æ¯æ¬¡è®¡ç®—å¯åŠ¨å­è¿›ç¨‹ï¼ˆå¼€é”€ ~10-50msï¼‰
- è®¡ç®—é€»è¾‘åŒ…å«å¤§é‡å¾ªç¯å’ŒæŸ¥è¡¨ï¼ˆ183 ä¸ªå¾ªç¯æ“ä½œï¼‰
- é«˜å¹¶å‘æ—¶å¯èƒ½ CPU 100%

### 8.2 å»ºè®®è¡ŒåŠ¨

1. **ç«‹å³è¡ŒåŠ¨**ï¼š
   - âœ… åˆ›å»ºå‹æµ‹è„šæœ¬ï¼Œè¿ç»­æ’ 100 æ¬¡å‘½ç›˜
   - âœ… è§‚å¯Ÿ CPU ä½¿ç”¨ç‡

2. **å¦‚æœ CPU 100%**ï¼š
   - âœ… ä¼˜åŒ–å­è¿›ç¨‹å¯åŠ¨ï¼ˆæ”¹ä¸ºç›´æ¥è°ƒç”¨ï¼‰
   - âœ… æ·»åŠ å†…å­˜ç¼“å­˜å±‚
   - âœ… è€ƒè™‘ worker_threadsï¼ˆå¦‚æœä»ä¸å¤Ÿï¼‰

3. **å¦‚æœ CPU < 50%**ï¼š
   - âœ… ä¿æŒç°çŠ¶
   - âœ… ç›‘æ§å³å¯

### 8.3 å…³é”®æŒ‡æ ‡

| æŒ‡æ ‡ | å½“å‰ | ç›®æ ‡ | å¤‡æ³¨ |
|------|------|------|------|
| **å•æ¬¡æ’ç›˜è€—æ—¶** | ~200-500ms | < 300ms | åŒ…å«å­è¿›ç¨‹å¯åŠ¨ |
| **100 æ¬¡å¹¶å‘ CPU** | å¾…å‹æµ‹ | < 80% | éœ€è¦éªŒè¯ |
| **ç¼“å­˜å‘½ä¸­ç‡** | æœªçŸ¥ | > 80% | éœ€è¦ç›‘æ§ |
| **å­è¿›ç¨‹æ•°** | æ¯æ¬¡ 1 ä¸ª | 0ï¼ˆæ”¹ä¸ºç›´æ¥è°ƒç”¨ï¼‰ | ä¼˜åŒ–æ–¹å‘ |

---

## ä¹ã€ä¸‹ä¸€æ­¥

1. **åˆ›å»ºå‹æµ‹è„šæœ¬**ï¼ˆ`scripts/stress-test-bazi.js`ï¼‰
2. **è¿è¡Œå‹æµ‹**ï¼Œè§‚å¯Ÿ CPU ä½¿ç”¨ç‡
3. **æ ¹æ®ç»“æœå†³å®šä¼˜åŒ–æ–¹æ¡ˆ**ï¼š
   - CPU 100% â†’ ç«‹å³ä¼˜åŒ–ï¼ˆP0 æ–¹æ¡ˆï¼‰
   - CPU < 50% â†’ ä¿æŒç°çŠ¶ï¼Œç›‘æ§å³å¯

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2025-01-XX




