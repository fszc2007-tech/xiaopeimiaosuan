# è¡Œè¿èŠ‚å¥å¡ç‰‡å®æ–½æ–¹æ¡ˆ V1.0

## ğŸ“‹ æ–¹æ¡ˆæ¦‚è¿°

**ç›®æ ‡**ï¼šå®ç°ã€Œè¡Œè¿èŠ‚å¥ã€å¡ç‰‡ï¼Œèšç„¦ã€Œæ—¶é—´ç»´åº¦çš„é˜¶æ®µæ„Ÿã€ï¼Œå›ç­”ã€Œæˆ‘ç°åœ¨åœ¨äººç”Ÿçš„å“ªä¸ªèŠ‚å¥ï¼Ÿè¿™æ®µå¤§æ¦‚åœ¨ç»ƒä»€ä¹ˆï¼Ÿè¿‘æœŸå‡ å¹´æ˜¯åŠ é€Ÿè¿˜æ˜¯è°ƒæ•´ï¼Ÿã€

**å¡ç‰‡åç§°**ï¼š`è¡Œè¿èŠ‚å¥`ï¼ˆå››å­—ï¼‰

**æ ¸å¿ƒè¦å›ç­”çš„é—®é¢˜**ï¼š
- æˆ‘**ç°åœ¨**åœ¨äººç”Ÿçš„å“ªä¸ªèŠ‚å¥ï¼Ÿ
- è¿™æ®µå¤§æ¦‚åœ¨**ç»ƒä»€ä¹ˆ**ï¼Ÿ
- è¿‘æœŸå‡ å¹´æ˜¯**åŠ é€Ÿè¿˜æ˜¯è°ƒæ•´**ï¼Ÿ

**å®šä½ä¸è¾¹ç•Œ**ï¼š
- ä¸é‡å¤ã€Šå‘½å±€æ€»è§ˆã€‹ï¼šæ•´ä½“æ°”è±¡ï¼‹æ€§æ ¼ä¸»åŸºè°ƒ
- ä¸é‡å¤ã€Šç”¨ç¥æ ¼å±€ã€‹ï¼šå‘½å±€ç»“æ„ & ç”¨ç¥å–œå¿Œ
- ä¸é‡å¤ã€Šå®˜è´¢æ ¼å±€ã€‹ï¼šäº‹ä¸š/è´¢å¯Œçš„ç»“æ„å’Œæ¨¡å¼
- ä¸é‡å¤ã€Šèƒ½é‡æµé€šã€‹ï¼šäº”è¡Œ/åç¥æ€ä¹ˆåšåŠŸ

ğŸ‘‰ **è¡Œè¿èŠ‚å¥**ï¼šåªè®²ã€Œæ—¶é—´ç»´åº¦çš„é˜¶æ®µæ„Ÿã€

**è¾“å‡ºå½¢å¼**ï¼š
- 4 æ®µæ–‡å­—ï¼ˆstagePositionã€luckThemeã€yearTrendã€adviceï¼‰
- å¡ç‰‡å¤´éƒ¨å±•ç¤ºï¼šé˜¶æ®µæ ‡ç­¾ã€èŠ‚å¥å¼ºåº¦ã€ä¸»é¢†åŸŸ chips

---

## ä¸€ã€æ•°æ®ç»“æ„è®¾è®¡ï¼ˆä¸ç³»ç»Ÿå‚æ•°å¯¹é½ï¼‰

### 1.1 åç«¯æ•°æ®ç»“æ„ï¼ˆå¼•æ“å±‚ï¼‰

ç»Ÿä¸€æŒ‚åœ¨ `analysis.luckRhythm` ä¸‹é¢ï¼š

```typescript
// é˜¶æ®µç±»å‹
export type RhythmStage = 'æ‰“åŸºç¡€æœŸ' | 'æ‹“å±•å†²åˆºæœŸ' | 'è°ƒæ•´è½¬æŠ˜æœŸ' | 'æ²‰æ·€æ”¶è·æœŸ';

// èŠ‚å¥å¼ºåº¦
export type RhythmIntensity = 'åå¹³ç¨³' | 'èµ·ä¼æ„Ÿè¾ƒå¼º' | 'å˜åŠ¨æ˜æ˜¾';

// ä¸»é¢†åŸŸ
export type MainDomain = 'å­¦ä¹ ' | 'äº‹ä¸š' | 'è´¢å¯Œ' | 'å…³ç³»' | 'å®¶åº­' | 'è‡ªæˆ‘ä¿®ç‚¼';

// åŸºè°ƒ
export type RhythmTone = 'åä¸»åŠ¨' | 'åè¢«åŠ¨' | 'å†…ä¿®å‹' | 'å¤–æ‹“å‹';

// æµå¹´ä½œç”¨
export type YearEffect = 'æ¨åŠ¨' | 'å‡é€Ÿ' | 'æé†’è°ƒæ•´';

// æœªæ¥è¶‹åŠ¿
export type ComingYearsTendency = 'æ•´ä½“åé¡º' | 'æœ‰èµ·ä¼çš„å°å¡é“' | 'ä»¥è°ƒæ•´ä¸ºä¸»';

// å½“å‰å¤§è¿å…ƒæ•°æ®
export interface LuckStageMeta {
  stage: RhythmStage;
  intensity: RhythmIntensity;
  mainDomains: MainDomain[];
  tone: RhythmTone;
}

// å½“å‰æµå¹´å…ƒæ•°æ®
export interface CurrentYearMeta {
  year: number;
  effect: YearEffect;
  description: string; // ç®€å•ä¸­æ–‡æ‘˜è¦
}

// æœªæ¥è¶‹åŠ¿
export interface ComingYearsTrend {
  summary: string;   // è‡ªç„¶è¯­è¨€æ€»ç»“
  tendency: ComingYearsTendency;
}

// è¡Œè¿èŠ‚å¥æŒ‡æ ‡ï¼ˆæ ¸å¿ƒæ•°æ®ç»“æ„ï¼‰
export interface LuckRhythmMetrics {
  // åŸºç¡€ä¿¡æ¯
  startAge: number;                 // èµ·è¿å¹´é¾„
  luckDirection: 'é¡ºè¡Œ' | 'é€†è¡Œ';
  currentAge: number;                // å½“å‰å¹´é¾„ï¼ˆä»å‡ºç”Ÿæ—¥æœŸè®¡ç®—ï¼‰
  
  // å½“å‰å¤§è¿ä¿¡æ¯
  currentLuck: {
    index: number;                   // ç¬¬å‡ æ­¥å¤§è¿ï¼ˆ0-basedï¼‰
    label: string;                   // å¦‚ã€Œä¸™å­å¤§è¿ã€
    ageRange: string;                // ã€Œçº¦ X å²åˆ° Y å²ã€
    stem: string;                    // å¤§è¿å¤©å¹²
    branch: string;                  // å¤§è¿åœ°æ”¯
    tenGod: string;                  // å¯¹æ—¥ä¸»çš„åç¥
    element: string;                 // äº”è¡Œ
    favourLevel: 'ç”¨ç¥' | 'ä¸­æ€§' | 'å¿Œç¥';
    stage: RhythmStage;              // ç®—å¥½çš„é˜¶æ®µ
    intensity: RhythmIntensity;
    mainDomains: MainDomain[];
    tone: RhythmTone;
    strengthScore: number;           // 0-1ï¼Œä½œç”¨åŠ›åº¦
    clashHarmPunish: string[];      // ä¸åŸå±€é‡è¦å®«ä½çš„å†²åˆåˆ‘å®³
  };
  
  // ä¸Šä¸€è¿/ä¸‹ä¸€è¿æ‘˜è¦
  prevNextLuckSummary: {
    prev?: {
      label: string;
      shortComment: string;          // ä¸€å¥è¯æ¦‚æ‹¬ä¸Šä¸€è¿
    };
    next?: {
      label: string;
      shortComment: string;          // ä¸€å¥è¯æ¦‚æ‹¬ä¸‹ä¸€è¿
    };
    stageShiftHint: string;          // å¦‚ã€Œæ•´ä½“ä»æ‰“åŸºç¡€èµ°å‘æ‹“å±•ã€ä¹‹ç±»
  };
  
  // å½“å‰æµå¹´
  currentYear: CurrentYearMeta;
  
  // æœªæ¥ 2-3 å¹´è¶‹åŠ¿
  comingYearsTrend: ComingYearsTrend;
  
  // è¡¥å……æç¤ºï¼ˆç»™ LLM ç”¨ï¼‰
  notes: string[];                   // å¦‚ã€Œå½“å‰å¤§è¿é…åˆç”¨ç¥ã€ã€Œå¤šå†²äº‹ä¸šå®«ã€ç­‰
}
```

### 1.2 å‰ç«¯å¡ç‰‡æ¥å£ï¼ˆä¸å…¶ä»–å¡ç‰‡å¯¹é½ï¼‰

```typescript
export interface LuckRhythmCard {
  type: 'luckRhythm';
  title: 'è¡Œè¿èŠ‚å¥';
  stage: RhythmStage;                // å½“å‰é˜¶æ®µ
  intensity: RhythmIntensity;         // èŠ‚å¥å¼ºåº¦
  mainDomains: MainDomain[];         // ä¸»é¢†åŸŸæ ‡ç­¾
  content: {
    stagePosition: string;            // é˜¶æ®µå®šä½ï¼ˆ1 æ®µï¼‰
    luckTheme: string;                // å½“å‰å¤§è¿ä¸»é¢˜ï¼ˆ1-2 æ®µï¼‰
    yearTrend: string;                // å½“å‰æµå¹´ + æœªæ¥è¶‹åŠ¿ï¼ˆ1 æ®µï¼‰
    advice: string;                   // è¡ŒåŠ¨å»ºè®®ï¼ˆ1 æ®µï¼‰
  };
  tags: string[];                     // å¦‚ ["æ‰“åŸºç¡€æœŸ", "èŠ‚å¥èµ·ä¼æ„Ÿè¾ƒå¼º", "é€‚åˆç¨³æ‰ç¨³æ‰“"]
}
```

---

## äºŒã€å­—æ®µæ˜ å°„è¡¨ï¼ˆä¸ç³»ç»Ÿå‚æ•°å¯¹é½ï¼‰

| æ–°å­—æ®µ                          | æ¥æºæ¨¡å—                       | ç°æœ‰æ•°æ®è·¯å¾„ï¼ˆç³»ç»Ÿå‚æ•°ï¼‰                                                      | è½¬æ¢é€»è¾‘                                                    | çŠ¶æ€ |
| ---------------------------- | -------------------------- | --------------------------------------------------------------- | ------------------------------------------------------- | ---- |
| `startAge`                   | `fortune.js`               | `derived.qi_yun.years`                                         | ç›´æ¥ä½¿ç”¨                                                      | âœ… ä¸€è‡´ |
| `luckDirection`              | `fortune.js`               | `derived.yun_direction`                                         | `'shun' â†’ 'é¡ºè¡Œ'`, `'ni' â†’ 'é€†è¡Œ'`                            | âœ… ä¸€è‡´ |
| `currentAge`                  | `birthJson`                 | ä»å‡ºç”Ÿæ—¥æœŸè®¡ç®—åˆ°å½“å‰æ—¥æœŸçš„å¹´é¾„                                          | `Math.floor((Date.now() - birthDate) / (365.25 * 24 * 60 * 60 * 1000))` | âš ï¸ éœ€è®¡ç®— |
| `currentLuck.index`          | `derived.luck_cycle`       | æ ¹æ® `currentAge` å’Œ `startAge` è®¡ç®—å½“å‰åœ¨ç¬¬å‡ æ­¥å¤§è¿                      | `Math.floor((currentAge - startAge) / 10)`                  | âš ï¸ éœ€è®¡ç®— |
| `currentLuck.label`          | `derived.luck_cycle`       | `currentLuck.stem + currentLuck.branch`                        | å¦‚ã€Œä¸™å­å¤§è¿ã€                                                  | âœ… ä¸€è‡´ |
| `currentLuck.ageRange`       | `derived.luck_cycle`       | `currentLuck.startAge` å’Œ `currentLuck.endAge`                 | `"çº¦ ${startAge} å²åˆ° ${endAge} å²"`                        | âœ… ä¸€è‡´ |
| `currentLuck.stem`           | `derived.luck_cycle`       | `currentLuck.stem`                                              | ç›´æ¥ä½¿ç”¨                                                      | âœ… ä¸€è‡´ |
| `currentLuck.branch`          | `derived.luck_cycle`       | `currentLuck.branch`                                            | ç›´æ¥ä½¿ç”¨                                                      | âœ… ä¸€è‡´ |
| `currentLuck.tenGod`          | `derived.luck_cycle`       | `currentLuck.shishen`                                           | ç›´æ¥ä½¿ç”¨                                                      | âœ… ä¸€è‡´ |
| `currentLuck.element`         | `derived.luck_cycle`       | ä» `currentLuck.stem` å’Œ `currentLuck.branch` è®¡ç®—äº”è¡Œ              | ä½¿ç”¨äº”è¡Œè®¡ç®—å‡½æ•°                                                | âš ï¸ éœ€è®¡ç®— |
| `currentLuck.favourLevel`     | `favored.js` + å¤§è¿äº”è¡Œ      | `favoredAvoid.favored` å’Œ `favoredAvoid.avoid`                  | åˆ¤æ–­å¤§è¿äº”è¡Œæ˜¯å¦åœ¨ç”¨ç¥/å¿Œç¥åˆ—è¡¨ä¸­                                    | âš ï¸ éœ€è®¡ç®— |
| `currentLuck.stage`           | **éœ€è®¡ç®—**                  | æ ¹æ®åç¥+å–œå¿Œ+å¼ºåº¦è®¡ç®—é˜¶æ®µ                                          | ä½¿ç”¨ `evaluateStageMeta()` å‡½æ•°                                | âš ï¸ éœ€è®¡ç®— |
| `currentLuck.intensity`       | **éœ€è®¡ç®—**                  | æ ¹æ® `strengthScore` å’Œ `clashHarmPunish` è®¡ç®—å¼ºåº¦                | ä½¿ç”¨ `evaluateStageMeta()` å‡½æ•°                                | âš ï¸ éœ€è®¡ç®— |
| `currentLuck.mainDomains`     | **éœ€è®¡ç®—**                  | æ ¹æ®åç¥ç±»å‹è®¡ç®—ä¸»é¢†åŸŸ                                            | ä½¿ç”¨ `evaluateStageMeta()` å‡½æ•°                                | âš ï¸ éœ€è®¡ç®— |
| `currentLuck.tone`            | **éœ€è®¡ç®—**                  | æ ¹æ®åç¥ç±»å‹è®¡ç®—åŸºè°ƒ                                              | ä½¿ç”¨ `evaluateStageMeta()` å‡½æ•°                                | âš ï¸ éœ€è®¡ç®— |
| `currentLuck.strengthScore`   | **éœ€è®¡ç®—**                  | æ ¹æ®å¤§è¿å¯¹åŸå±€çš„å½±å“åŠ›è®¡ç®—                                          | ä½¿ç”¨ `calculateLuckStrength()` å‡½æ•°                           | âš ï¸ éœ€è®¡ç®— |
| `currentLuck.clashHarmPunish` | `branchRelationships.js`   | å¤§è¿åœ°æ”¯ä¸åŸå±€åœ°æ”¯çš„å†²åˆåˆ‘å®³å…³ç³»                                        | ä½¿ç”¨ `analyzeBranchRelationships()` å‡½æ•°                       | âš ï¸ éœ€è®¡ç®— |
| `prevNextLuckSummary.prev`    | `derived.luck_cycle`       | `currentLuck.index - 1` çš„å¤§è¿ä¿¡æ¯                                | ç”Ÿæˆä¸Šä¸€è¿çš„ç®€è¦æ¦‚æ‹¬                                            | âš ï¸ éœ€è®¡ç®— |
| `prevNextLuckSummary.next`    | `derived.luck_cycle`       | `currentLuck.index + 1` çš„å¤§è¿ä¿¡æ¯                                | ç”Ÿæˆä¸‹ä¸€è¿çš„ç®€è¦æ¦‚æ‹¬                                            | âš ï¸ éœ€è®¡ç®— |
| `prevNextLuckSummary.stageShiftHint` | **éœ€è®¡ç®—**        | æ¯”è¾ƒå½“å‰è¿å’Œä¸Šä¸€è¿/ä¸‹ä¸€è¿çš„é˜¶æ®µå˜åŒ–                                    | ç”Ÿæˆé˜¶æ®µè½¬æ¢æç¤º                                                | âš ï¸ éœ€è®¡ç®— |
| `currentYear.year`            | `derived.flow_years`       | `flow_years[0].year`                                            | ç›´æ¥ä½¿ç”¨                                                      | âœ… ä¸€è‡´ |
| `currentYear.effect`          | **éœ€è®¡ç®—**                  | æ ¹æ®æµå¹´åç¥ã€å–œå¿Œã€ä¸å¤§è¿å…³ç³»è®¡ç®—ä½œç”¨å€¾å‘                                | ä½¿ç”¨ `evaluateYearEffect()` å‡½æ•°                               | âš ï¸ éœ€è®¡ç®— |
| `currentYear.description`    | **éœ€è®¡ç®—**                  | æ ¹æ® `effect` ç”Ÿæˆç®€å•æè¿°                                          | ä½¿ç”¨ `generateYearDescription()` å‡½æ•°                          | âš ï¸ éœ€è®¡ç®— |
| `comingYearsTrend.summary`   | **éœ€è®¡ç®—**                  | æ ¹æ®æœªæ¥ 2-3 å¹´æµå¹´çš„ `effect` ç”Ÿæˆæ€»ç»“                              | ä½¿ç”¨ `generateComingYearsTrend()` å‡½æ•°                         | âš ï¸ éœ€è®¡ç®— |
| `comingYearsTrend.tendency`  | **éœ€è®¡ç®—**                  | æ ¹æ®æœªæ¥ 2-3 å¹´æµå¹´çš„ `effect` ç»Ÿè®¡å€¾å‘                              | ä½¿ç”¨ `generateComingYearsTrend()` å‡½æ•°                         | âš ï¸ éœ€è®¡ç®— |
| `notes`                       | **éœ€è®¡ç®—**                  | æ ¹æ®å„ç§æ¡ä»¶ç”Ÿæˆè¡¥å……æç¤º                                            | ä½¿ç”¨ `generateNotes()` å‡½æ•°                                    | âš ï¸ éœ€è®¡ç®— |

---

## ä¸‰ã€ç®—æ³•ä¾§å®ç°æµç¨‹ï¼ˆå¦‚ä½•ç®—å‡ºè¿™äº›å‚æ•°ï¼‰

### 3.1 é˜¶æ®µ/èŠ‚å¥æ ‡ç­¾ç®—æ³•ï¼ˆ`evaluateStageMeta`ï¼‰

è¿™æ˜¯è¡Œè¿èŠ‚å¥å¡æœ€å…³é”®çš„æŠ½è±¡å±‚ï¼š**å…ˆç”¨ç®—æ³•æŠŠã€ŒèŠ‚å¥ã€å®šæ€§ï¼Œå†äº¤ç»™ LLM ç”¨äººè¯å†™å‡ºæ¥**ã€‚

```typescript
/**
 * è¯„ä¼°å½“å‰å¤§è¿çš„é˜¶æ®µå…ƒæ•°æ®
 * @param {Object} currentLuck - å½“å‰å¤§è¿ä¿¡æ¯
 * @param {Object} context - ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼ˆæ—¥ä¸»å¼ºå¼±ã€ç”¨ç¥ã€åç¥åˆ†å¸ƒç­‰ï¼‰
 * @returns {LuckStageMeta} é˜¶æ®µå…ƒæ•°æ®
 */
function evaluateStageMeta(currentLuck, context) {
  const { dmStrength, usefulGods, avoidGods, tenGodDistribution } = context;
  const { tenGod, favourLevel, clashHarmPunish, strengthScore } = currentLuck;
  
  // æ³¨æ„ï¼šusefulGods å’Œ avoidGods æ˜¯äº”è¡Œæ•°ç»„ï¼ˆå¦‚ ["ç«", "åœŸ"]ï¼‰ï¼Œä¸æ˜¯åç¥
  
  let stage: RhythmStage;
  let intensity: RhythmIntensity;
  const mainDomains: MainDomain[] = [];
  let tone: RhythmTone = 'åä¸»åŠ¨';
  
  // 1ï¼‰æ ¹æ®åç¥ & å–œå¿Œå®šå¤§é˜¶æ®µ
  if (['æ­£å°', 'åå°', 'æ¯”è‚©', 'åŠ«è´¢'].includes(tenGod) && favourLevel === 'ç”¨ç¥') {
    stage = 'æ‰“åŸºç¡€æœŸ';
  } else if (['æ­£è´¢', 'åè´¢', 'æ­£å®˜', 'ä¸ƒæ€'].includes(tenGod) && favourLevel === 'ç”¨ç¥') {
    stage = 'æ‹“å±•å†²åˆºæœŸ';
  } else if (['é£Ÿç¥', 'ä¼¤å®˜'].includes(tenGod) && favourLevel === 'ç”¨ç¥') {
    // è¾“å‡º+ç”¨ç¥ï¼Œå¤šæ˜¯ã€Œè¡¨è¾¾ã€äº§å‡ºã€è½¬åŒ–ã€â†’ æ”¶è· or è½¬å‹
    stage = 'æ²‰æ·€æ”¶è·æœŸ';
  } else {
    // å–œå¿Œå†²çªã€åˆ‘å†²å¤šæ—¶ï¼Œä¼˜å…ˆå½’ä¸ºã€Œè°ƒæ•´è½¬æŠ˜æœŸã€
    if (clashHarmPunish.length >= 2 || favourLevel === 'å¿Œç¥') {
      stage = 'è°ƒæ•´è½¬æŠ˜æœŸ';
    } else {
      // é»˜è®¤ï¼šçœ‹æ•´ä½“ç»“æ„ï¼Œåç¨³åˆ™ã€Œæ²‰æ·€æ”¶è·ã€ï¼Œåå¼±åˆ™ã€Œæ‰“åŸºç¡€ã€
      stage = dmStrength < 0.8 ? 'æ‰“åŸºç¡€æœŸ' : 'æ²‰æ·€æ”¶è·æœŸ';
    }
  }
  
  // 2ï¼‰å¼ºåº¦ï¼ˆèŠ‚å¥å¿«æ…¢ï¼‰
  if (strengthScore >= 0.7 || clashHarmPunish.length >= 2) {
    intensity = 'å˜åŠ¨æ˜æ˜¾';
  } else if (strengthScore >= 0.4) {
    intensity = 'èµ·ä¼æ„Ÿè¾ƒå¼º';
  } else {
    intensity = 'åå¹³ç¨³';
  }
  
  // 3ï¼‰ä¸»é¢†åŸŸ
  if (['æ­£è´¢', 'åè´¢'].includes(tenGod)) {
    mainDomains.push('è´¢å¯Œ', 'äº‹ä¸š');
  }
  if (['æ­£å®˜', 'ä¸ƒæ€'].includes(tenGod)) {
    mainDomains.push('äº‹ä¸š', 'å®¶åº­');
  }
  if (['é£Ÿç¥', 'ä¼¤å®˜'].includes(tenGod)) {
    mainDomains.push('å­¦ä¹ ', 'è‡ªæˆ‘ä¿®ç‚¼');
  }
  if (['æ­£å°', 'åå°'].includes(tenGod)) {
    mainDomains.push('å­¦ä¹ ', 'è‡ªæˆ‘ä¿®ç‚¼');
  }
  // ä½¿ç”¨ W å¯¹è±¡çš„ keyï¼ˆcai è€Œä¸æ˜¯ 'è´¢'ï¼‰
  if (tenGodDistribution.cai > 0.3 && !mainDomains.includes('è´¢å¯Œ')) {
    mainDomains.push('è´¢å¯Œ');
  }
  
  // 4ï¼‰åŸºè°ƒï¼ˆå†…ä¿®/å¤–æ‹“ï¼‰
  if (['æ­£å°', 'åå°', 'æ¯”è‚©', 'åŠ«è´¢'].includes(tenGod)) tone = 'å†…ä¿®å‹';
  if (['æ­£è´¢', 'åè´¢', 'æ­£å®˜', 'ä¸ƒæ€'].some(k => tenGod.includes(k))) tone = 'å¤–æ‹“å‹';
  
  return { stage, intensity, mainDomains: Array.from(new Set(mainDomains)), tone };
}
```

### 3.2 æµå¹´ä½œç”¨è¯„ä¼°ï¼ˆ`evaluateYearEffect`ï¼‰

```typescript
/**
 * è¯„ä¼°æµå¹´ä½œç”¨å€¾å‘
 * @param {Object} currentYear - å½“å‰æµå¹´ä¿¡æ¯
 * @param {Object} currentLuck - å½“å‰å¤§è¿ä¿¡æ¯
 * @param {Object} context - ä¸Šä¸‹æ–‡ä¿¡æ¯
 * @returns {YearEffect} æµå¹´ä½œç”¨
 */
function evaluateYearEffect(currentYear, currentLuck, context) {
  const { tenGod: yearTenGod, favourLevel: yearFavourLevel } = currentYear;
  const { tenGod: luckTenGod, favourLevel: luckFavourLevel } = currentLuck;
  
  // è‹¥æµå¹´ç”¨ç¥ä¸”åç¥è·Ÿå½“å‰å¤§è¿åŒé˜µè¥ï¼ˆæ¯”å¦‚ä¹Ÿæ˜¯è´¢å®˜ã€ä¹Ÿæ˜¯ç”¨ç¥ï¼‰â†’ æ¨åŠ¨
  if (yearFavourLevel === 'ç”¨ç¥') {
    const sameCamp = 
      (['æ­£è´¢', 'åè´¢', 'æ­£å®˜', 'ä¸ƒæ€'].includes(yearTenGod) && 
       ['æ­£è´¢', 'åè´¢', 'æ­£å®˜', 'ä¸ƒæ€'].includes(luckTenGod)) ||
      (['æ­£å°', 'åå°', 'æ¯”è‚©', 'åŠ«è´¢'].includes(yearTenGod) && 
       ['æ­£å°', 'åå°', 'æ¯”è‚©', 'åŠ«è´¢'].includes(luckTenGod)) ||
      (['é£Ÿç¥', 'ä¼¤å®˜'].includes(yearTenGod) && 
       ['é£Ÿç¥', 'ä¼¤å®˜'].includes(luckTenGod));
    
    if (sameCamp && luckFavourLevel === 'ç”¨ç¥') {
      return 'æ¨åŠ¨';
    }
  }
  
  // è‹¥å¿Œç¥ä¸”å†²å…‹å½“å‰å¤§è¿/å‘½ç›˜è¦å®³ â†’ æé†’è°ƒæ•´
  if (yearFavourLevel === 'å¿Œç¥') {
    // æ£€æŸ¥æ˜¯å¦æœ‰å†²å…‹å…³ç³»ï¼ˆä» clashHarmPunish ä¸­åˆ¤æ–­ï¼‰
    if (currentYear.clashHarmPunish && currentYear.clashHarmPunish.length > 0) {
      return 'æé†’è°ƒæ•´';
    }
    // å…œåº•ï¼šå¿Œç¥ç›´æ¥è¿”å›æé†’è°ƒæ•´
    return 'æé†’è°ƒæ•´';
  }
  
  // è‹¥ä¸­æ€§æˆ–ç”¨ç¥ä½†èµ°å°æ¯”è€Œå¤§è¿æ˜¯è´¢å®˜è¿™ç§ã€Œè¸©åˆ¹è½¦ã€ç»„åˆ â†’ å‡é€Ÿ
  if (yearFavourLevel === 'ä¸­æ€§' || 
      (yearFavourLevel === 'ç”¨ç¥' && 
       ['æ­£å°', 'åå°', 'æ¯”è‚©', 'åŠ«è´¢'].includes(yearTenGod) && 
       ['æ­£è´¢', 'åè´¢', 'æ­£å®˜', 'ä¸ƒæ€'].includes(luckTenGod))) {
    return 'å‡é€Ÿ';
  }
  
  // å…œåº•ï¼šç”¨ç¥é»˜è®¤æ¨åŠ¨ï¼Œå…¶ä»–æƒ…å†µå‡é€Ÿ
  if (yearFavourLevel === 'ç”¨ç¥') {
    return 'æ¨åŠ¨';
  }
  
  return 'å‡é€Ÿ';
}
```

### 3.3 æœªæ¥è¶‹åŠ¿ç”Ÿæˆï¼ˆ`generateComingYearsTrend`ï¼‰

```typescript
/**
 * ç”Ÿæˆæœªæ¥ 2-3 å¹´è¶‹åŠ¿
 * @param {Object[]} comingYears - æœªæ¥ 2-3 å¹´æµå¹´æ•°ç»„
 * @param {Object} currentLuck - å½“å‰å¤§è¿ä¿¡æ¯ï¼ˆå¯é€‰ï¼Œç”¨äºä¸Šä¸‹æ–‡ï¼‰
 * @param {Object} context - ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰
 * @returns {ComingYearsTrend} æœªæ¥è¶‹åŠ¿
 */
function generateComingYearsTrend(comingYears, currentLuck, context) {
  const effects = comingYears.map(year => year.effect);
  const pushCount = effects.filter(e => e === 'æ¨åŠ¨').length;
  const adjustCount = effects.filter(e => e === 'æé†’è°ƒæ•´').length;
  const slowCount = effects.filter(e => e === 'å‡é€Ÿ').length;
  
  let tendency: ComingYearsTendency;
  if (pushCount >= 2) {
    tendency = 'æ•´ä½“åé¡º';
  } else if (adjustCount >= 2) {
    tendency = 'ä»¥è°ƒæ•´ä¸ºä¸»';
  } else {
    tendency = 'æœ‰èµ·ä¼çš„å°å¡é“';
  }
  
  // ç”Ÿæˆè‡ªç„¶è¯­è¨€æ€»ç»“
  const summary = generateTrendSummary(effects, tendency);
  
  return { summary, tendency };
}

/**
 * ç”Ÿæˆè¶‹åŠ¿æ€»ç»“æ–‡æœ¬
 */
function generateTrendSummary(effects, tendency) {
  if (tendency === 'æ•´ä½“åé¡º') {
    return 'æœªæ¥å‡ å¹´æ•´ä½“åƒä¸€æ®µç¼“æ…¢æŠ¬å‡çš„å¡é“ï¼Œé€‚åˆåœ¨ç°æœ‰åŸºç¡€ä¸Šç¨³æ­¥æ¨è¿›ã€‚';
  } else if (tendency === 'ä»¥è°ƒæ•´ä¸ºä¸»') {
    return 'æœªæ¥å‡ å¹´ä»¥è°ƒæ•´å’Œé€‚åº”ä¸ºä¸»ï¼Œéœ€è¦å¤šç•™æ„èŠ‚å¥å˜åŒ–ï¼Œé€‚æ—¶è¸©åˆ¹è½¦ã€‚';
  } else {
    return 'æœªæ¥å‡ å¹´åƒä¸€æ®µæœ‰èµ·ä¼çš„å°å¡é“ï¼Œæœ‰æ¨åŠ¨ä¹Ÿæœ‰å‡é€Ÿï¼Œéœ€è¦çµæ´»åº”å¯¹ã€‚';
  }
}
```

### 3.4 å¤§è¿å¼ºåº¦è®¡ç®—ï¼ˆ`calculateLuckStrength`ï¼‰

```typescript
/**
 * è®¡ç®—å¤§è¿å¯¹åŸå±€çš„ä½œç”¨åŠ›åº¦
 * @param {Object} currentLuck - å½“å‰å¤§è¿ä¿¡æ¯
 * @param {Object} context - ä¸Šä¸‹æ–‡ä¿¡æ¯
 * @returns {number} 0-1 çš„å¼ºåº¦åˆ†æ•°
 */
function calculateLuckStrength(currentLuck, context) {
  const { favourLevel, clashHarmPunish } = currentLuck;
  const { dmStrength } = context;
  
  let strength = 0.5; // åŸºç¡€å¼ºåº¦
  
  // ç”¨ç¥å¤§è¿å¼ºåº¦æ›´é«˜
  if (favourLevel === 'ç”¨ç¥') {
    strength += 0.2;
  } else if (favourLevel === 'å¿Œç¥') {
    strength -= 0.1;
  }
  
  // åˆ‘å†²å¤šæ—¶å¼ºåº¦æ›´é«˜ï¼ˆå˜åŠ¨å¤§ï¼‰
  if (clashHarmPunish.length >= 2) {
    strength += 0.2;
  } else if (clashHarmPunish.length === 1) {
    strength += 0.1;
  }
  
  // æ—¥ä¸»å¼ºå¼±å½±å“
  if (dmStrength < 0.5) {
    strength += 0.1; // èº«å¼±æ—¶å¤§è¿å½±å“æ›´æ˜æ˜¾
  }
  
  return Math.max(0, Math.min(1, strength));
}
```

### 3.5 ä¸Šä¸€è¿/ä¸‹ä¸€è¿æ‘˜è¦ç”Ÿæˆ

```typescript
/**
 * ç”Ÿæˆä¸Šä¸€è¿/ä¸‹ä¸€è¿æ‘˜è¦
 * @param {Object} prevLuck - ä¸Šä¸€è¿ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰
 * @param {Object} nextLuck - ä¸‹ä¸€è¿ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰
 * @param {string} currentStage - å½“å‰é˜¶æ®µ
 * @param {Object} context - ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼ˆç”¨äºè¯„ä¼°é˜¶æ®µï¼‰
 * @returns {Object} ä¸Šä¸€è¿/ä¸‹ä¸€è¿æ‘˜è¦
 */
function generatePrevNextSummary(prevLuck, nextLuck, currentStage, context) {
  const result = {
    prev: undefined,
    next: undefined,
    stageShiftHint: '',
  };
  
  // ä¸Šä¸€è¿æ‘˜è¦
  if (prevLuck) {
    // éœ€è¦å…ˆç»„è£… prevLuck çš„å®Œæ•´ä¿¡æ¯æ‰èƒ½è¯„ä¼°é˜¶æ®µ
    const prevLuckInfo = {
      tenGod: prevLuck.shishen,
      favourLevel: determineFavourLevel(getElementFromPillar(prevLuck), context.usefulGods, context.avoidGods),
      clashHarmPunish: analyzeClashHarmPunish(prevLuck, pillars),
      strengthScore: calculateLuckStrength({ favourLevel, clashHarmPunish }, context),
    };
    const prevStage = evaluateStageMeta(prevLuckInfo, context).stage;
    result.prev = {
      label: `${prevLuck.stem}${prevLuck.branch}å¤§è¿`,
      shortComment: `ä¸Šä¸€è¿æ˜¯${prevStage}ï¼Œ${generateShortComment(prevLuck, prevLuckInfo.favourLevel)}`,
    };
  }
  
  // ä¸‹ä¸€è¿æ‘˜è¦
  if (nextLuck) {
    const nextLuckInfo = {
      tenGod: nextLuck.shishen,
      favourLevel: determineFavourLevel(getElementFromPillar(nextLuck), context.usefulGods, context.avoidGods),
      clashHarmPunish: analyzeClashHarmPunish(nextLuck, pillars),
      strengthScore: calculateLuckStrength({ favourLevel, clashHarmPunish }, context),
    };
    const nextStage = evaluateStageMeta(nextLuckInfo, context).stage;
    result.next = {
      label: `${nextLuck.stem}${nextLuck.branch}å¤§è¿`,
      shortComment: `ä¸‹ä¸€è¿æ˜¯${nextStage}ï¼Œ${generateShortComment(nextLuck, nextLuckInfo.favourLevel)}`,
    };
  }
  
  // é˜¶æ®µè½¬æ¢æç¤º
  if (prevLuck && nextLuck) {
    const prevStage = evaluateStageMeta(prevLuck, context).stage;
    const nextStage = evaluateStageMeta(nextLuck, context).stage;
    if (prevStage !== currentStage && nextStage !== currentStage) {
      result.stageShiftHint = `æ•´ä½“ä»${prevStage}èµ°å‘${nextStage}`;
    } else if (prevStage !== currentStage) {
      result.stageShiftHint = `ä»${prevStage}è½¬å…¥${currentStage}`;
    } else if (nextStage !== currentStage) {
      result.stageShiftHint = `ä»${currentStage}å°†è½¬å…¥${nextStage}`;
    }
  }
  
  return result;
}

/**
 * ç”Ÿæˆç®€çŸ­è¯„è®º
 * @param {Object} luck - å¤§è¿ä¿¡æ¯
 * @param {string} favourLevel - å–œå¿Œç­‰çº§
 */
function generateShortComment(luck, favourLevel) {
  const tenGod = luck.shishen || 'æœªçŸ¥';
  if (favourLevel === 'ç”¨ç¥') {
    return `èµ°${tenGod}ç”¨ç¥ï¼Œæ•´ä½“åé¡º`;
  } else if (favourLevel === 'å¿Œç¥') {
    return `èµ°${tenGod}å¿Œç¥ï¼Œéœ€è¦å¤šç•™æ„`;
  } else {
    return `èµ°${tenGod}ï¼Œä¸­æ€§`;
  }
}
```

---

## å››ã€ç»„è£…å‡½æ•°è®¾è®¡ï¼ˆä¸å®˜è´¢æ ¼å±€å¯¹é½ï¼‰

### 4.1 å‡½æ•°ç­¾å

```typescript
/**
 * ç»„è£…ã€Œè¡Œè¿èŠ‚å¥ã€æ•°æ®ï¼ˆçº¯å‡½æ•°ï¼‰
 * 
 * çº¯å‡½æ•°è®¾è®¡ï¼š
 * - åªåšå–å€¼ + æ˜ å°„ + è§„åˆ™åˆ¤æ–­
 * - ä¸è°ƒç”¨ async å‡½æ•°
 * - ä¸æ“ä½œå…¨å±€çŠ¶æ€
 * - æ‰€æœ‰å¼‚æ­¥è®¡ç®—åœ¨ä¸Šæ¸¸å®Œæˆ
 * 
 * @param {Object} derived - æ´¾ç”Ÿä¿¡æ¯ï¼ˆå¤§è¿ã€æµå¹´ç­‰ï¼‰
 * @param {Object} birthJson - å‡ºç”Ÿä¿¡æ¯ï¼ˆç”¨äºè®¡ç®—å½“å‰å¹´é¾„ï¼‰
 * @param {Object} strengthResult - æ—¥ä¸»å¼ºå¼±ç»“æœ
 * @param {Object} favoredAvoid - å–œç”¨ç¥ç»“æœ
 * @param {Object} structureResult - æ ¼å±€åˆ†æç»“æœï¼ˆåŒ…å« W å¯¹è±¡ï¼‰
 * @param {Object} pillars - å››æŸ±æ•°æ®ï¼ˆç”¨äºåˆ†æå†²åˆåˆ‘å®³ï¼‰
 * @returns {LuckRhythmMetrics} è¡Œè¿èŠ‚å¥æŒ‡æ ‡
 */
function buildLuckRhythmMetrics(
  derived,
  birthJson,
  strengthResult,
  favoredAvoid,
  structureResult,
  pillars
) {
  // å®ç°è§ä¸‹æ–‡
}
```

### 4.2 å®ç°ä½ç½®

åœ¨ `core/engine/index.js` çš„ `BaziEngine` ç±»ä¸­æ·»åŠ ï¼š

```javascript
/**
 * ç»„è£…ã€Œè¡Œè¿èŠ‚å¥ã€æ•°æ®
 */
buildLuckRhythmMetrics(
  derived,
  birthJson,
  strengthResult,
  favoredAvoid,
  structureResult,
  pillars
) {
  // 1. æå–åŸºç¡€ä¿¡æ¯
  const startAge = derived.qi_yun?.years || 0;
  const luckDirection = derived.yun_direction === 'shun' ? 'é¡ºè¡Œ' : 'é€†è¡Œ';
  const currentAge = this.calculateCurrentAge(birthJson);
  
  // 2. ç¡®å®šå½“å‰å¤§è¿ï¼ˆä½¿ç”¨å¹´é¾„åŒºé—´æŸ¥æ‰¾ï¼Œæ›´å®‰å…¨ï¼‰
  const luckCycle = derived.luck_cycle || [];
  const currentLuckIndex = luckCycle.findIndex(l =>
    currentAge >= l.startAge && currentAge < l.endAge
  );
  
  // å¤„ç†æœªå…¥å¤§è¿çš„æƒ…å†µ
  if (currentLuckIndex === -1) {
    if (currentAge < startAge) {
      // æœªå…¥å¤§è¿ï¼šè¿”å›ç‰¹æ®Šé˜¶æ®µ
      return this.getPreLuckRhythmMetrics(startAge, luckDirection, currentAge);
    }
    // è¶…å‡ºå¤§è¿èŒƒå›´ï¼šè¿”å›é»˜è®¤å€¼
    return this.getDefaultLuckRhythmMetrics(startAge, luckDirection, currentAge);
  }
  
  const currentLuckRaw = luckCycle[currentLuckIndex];
  
  // 3. è®¡ç®—å½“å‰å¤§è¿çš„è¯¦ç»†ä¿¡æ¯
  // æ³¨æ„ï¼šfavoredAvoid.favored å’Œ favoredAvoid.avoid æ˜¯äº”è¡Œæ•°ç»„ï¼ˆå¦‚ ["ç«", "åœŸ"]ï¼‰
  // W å¯¹è±¡çš„ key æ˜¯ï¼šcai, guan, yin, bi, shi ç­‰
  const context = {
    dmStrength: strengthResult?.score || 0.5,
    usefulGods: favoredAvoid?.favored || [],  // äº”è¡Œæ•°ç»„
    avoidGods: favoredAvoid?.avoid || [],      // äº”è¡Œæ•°ç»„
    tenGodDistribution: structureResult?.W || {},  // { cai, guan, yin, bi, shi, ... }
  };
  
  // 4. åˆ¤æ–­å¤§è¿å–œå¿Œ
  const luckElement = this.getElementFromPillar(currentLuckRaw);
  const favourLevel = this.determineFavourLevel(luckElement, context.usefulGods, context.avoidGods);
  
  // 5. è®¡ç®—å¤§è¿å¼ºåº¦
  const clashHarmPunish = this.analyzeClashHarmPunish(currentLuckRaw, pillars);
  const strengthScore = this.calculateLuckStrength({
    favourLevel,
    clashHarmPunish,
  }, context);
  
  // 6. è¯„ä¼°é˜¶æ®µå…ƒæ•°æ®
  const stageMeta = this.evaluateStageMeta({
    tenGod: currentLuckRaw.shishen,
    favourLevel,
    clashHarmPunish,
    strengthScore,
  }, context);
  
  // 7. ç»„è£…å½“å‰å¤§è¿ä¿¡æ¯
  const currentLuck = {
    index: currentLuckIndex,
    label: `${currentLuckRaw.stem}${currentLuckRaw.branch}å¤§è¿`,
    ageRange: `çº¦ ${currentLuckRaw.startAge} å²åˆ° ${currentLuckRaw.endAge} å²`,
    stem: currentLuckRaw.stem,
    branch: currentLuckRaw.branch,
    tenGod: currentLuckRaw.shishen,
    element: luckElement,
    favourLevel,
    stage: stageMeta.stage,
    intensity: stageMeta.intensity,
    mainDomains: stageMeta.mainDomains,
    tone: stageMeta.tone,
    strengthScore,
    clashHarmPunish,
  };
  
  // 8. ç”Ÿæˆä¸Šä¸€è¿/ä¸‹ä¸€è¿æ‘˜è¦
  const prevLuck = luckCycle[currentLuckIndex - 1];
  const nextLuck = luckCycle[currentLuckIndex + 1];
  const prevNextSummary = this.generatePrevNextSummary(prevLuck, nextLuck, stageMeta.stage, context);
  
  // 9. è®¡ç®—å½“å‰æµå¹´
  const flowYear = derived.flow_years?.[0];
  const currentYear = this.evaluateCurrentYear(flowYear, currentLuck, context);
  
  // 10. ç”Ÿæˆæœªæ¥ 2-3 å¹´è¶‹åŠ¿
  const comingYears = this.generateComingYears(derived, currentAge, 3);
  const comingYearsTrend = this.generateComingYearsTrend(comingYears, currentLuck, context);
  
  // 11. ç”Ÿæˆè¡¥å……æç¤º
  const notes = this.generateNotes(currentLuck, context, favoredAvoid);
  
  // 12. ç»„è£…è¿”å›å¯¹è±¡
  return {
    startAge,
    luckDirection,
    currentAge,
    currentLuck,
    prevNextLuckSummary: prevNextSummary,
    currentYear,
    comingYearsTrend,
    notes,
  };
}

/**
 * è®¡ç®—å½“å‰å¹´é¾„
 * æ³¨æ„ï¼šè¿™é‡Œç”¨ç®€åŒ–å¹´é¾„è®¡ç®—ï¼Œè¡Œè¿èŠ‚å¥å¡ä¸åšå…·ä½“å¹´ä»½äº‹ä»¶é¢„æµ‹ï¼Œæ‰€ä»¥å®¹è®¸ 1 å¹´å·¦å³åå·®
 * ä¸¥æ ¼ä»å‘½ç†æ¥è¯´åº”è¯¥ä»¥ç«‹æ˜¥/èŠ‚æ°”ä¸ºç•Œï¼Œä½†æ­¤å¡åªè®²ã€Œé˜¶æ®µæ„Ÿã€ï¼Œç”¨å…¬å†ç”Ÿæ—¥+å¹´å·®å¯æ¥å—
 */
calculateCurrentAge(birthJson) {
  const { year, month, day, hour, minute } = birthJson;
  const birthDate = new Date(year, month - 1, day, hour || 0, minute || 0);
  const now = new Date();
  const ageMs = now.getTime() - birthDate.getTime();
  const ageYears = ageMs / (365.25 * 24 * 60 * 60 * 1000);
  return Math.floor(ageYears);
}

/**
 * ä»æŸ±ä¿¡æ¯ä¸­æå–äº”è¡Œ
 */
getElementFromPillar(pillar) {
  // ç®€åŒ–ç‰ˆï¼šä»å¤©å¹²æå–äº”è¡Œ
  const stemElements = {
    'ç”²': 'æœ¨', 'ä¹™': 'æœ¨',
    'ä¸™': 'ç«', 'ä¸': 'ç«',
    'æˆŠ': 'åœŸ', 'å·±': 'åœŸ',
    'åºš': 'é‡‘', 'è¾›': 'é‡‘',
    'å£¬': 'æ°´', 'ç™¸': 'æ°´',
  };
  return stemElements[pillar.stem] || 'æœªçŸ¥';
}

/**
 * åˆ¤æ–­å–œå¿Œç­‰çº§
 * @param {string} element - äº”è¡Œï¼ˆå¦‚ "ç«", "åœŸ"ï¼‰
 * @param {string[]} usefulGods - ç”¨ç¥äº”è¡Œæ•°ç»„ï¼ˆå¦‚ ["ç«", "åœŸ"]ï¼‰
 * @param {string[]} avoidGods - å¿Œç¥äº”è¡Œæ•°ç»„ï¼ˆå¦‚ ["é‡‘", "æ°´"]ï¼‰
 * @returns {'ç”¨ç¥' | 'ä¸­æ€§' | 'å¿Œç¥'}
 */
determineFavourLevel(element, usefulGods, avoidGods) {
  // æ³¨æ„ï¼šelementã€usefulGodsã€avoidGods éƒ½æ˜¯äº”è¡Œï¼Œä¸æ˜¯åç¥
  if (usefulGods.includes(element)) {
    return 'ç”¨ç¥';
  } else if (avoidGods.includes(element)) {
    return 'å¿Œç¥';
  } else {
    return 'ä¸­æ€§';
  }
}

/**
 * åˆ†æå†²åˆåˆ‘å®³
 */
analyzeClashHarmPunish(luckPillar, pillars) {
  // ç®€åŒ–ç‰ˆï¼šæ£€æŸ¥å¤§è¿åœ°æ”¯ä¸åŸå±€åœ°æ”¯çš„å…³ç³»
  const results = [];
  const luckBranch = luckPillar.branch;
  
  // æ£€æŸ¥ä¸å¹´æŸ±ã€æœˆæŸ±ã€æ—¥æŸ±ã€æ—¶æŸ±çš„å…³ç³»
  ['year', 'month', 'day', 'hour'].forEach(pillarKey => {
    const pillar = pillars[pillarKey];
    if (!pillar) return;
    
    const branch = pillar.branch;
    // è¿™é‡Œå¯ä»¥è°ƒç”¨ç°æœ‰çš„ branchRelationships.js ä¸­çš„å‡½æ•°
    // ç®€åŒ–ç‰ˆï¼šåªæ£€æŸ¥å…­å†²
    if (this.isChong(luckBranch, branch)) {
      results.push(`${pillarKey}æŸ±å†²`);
    }
  });
  
  return results;
}

/**
 * åˆ¤æ–­æ˜¯å¦å…­å†²
 */
isChong(branch1, branch2) {
  const chongPairs = [
    ['å­', 'åˆ'], ['ä¸‘', 'æœª'], ['å¯…', 'ç”³'],
    ['å¯', 'é…‰'], ['è¾°', 'æˆŒ'], ['å·³', 'äº¥'],
  ];
  return chongPairs.some(([a, b]) => 
    (a === branch1 && b === branch2) || (a === branch2 && b === branch1)
  );
}

/**
 * è¯„ä¼°å½“å‰æµå¹´
 */
evaluateCurrentYear(flowYear, currentLuck, context) {
  if (!flowYear) {
    return {
      year: new Date().getFullYear(),
      effect: 'æ¨åŠ¨',
      description: 'å½“å‰æµå¹´æ•´ä½“åé¡º',
    };
  }
  
  const yearElement = this.getElementFromPillar(flowYear);
  const yearFavourLevel = this.determineFavourLevel(
    yearElement,
    context.usefulGods,
    context.avoidGods
  );
  
  const effect = this.evaluateYearEffect({
    tenGod: flowYear.shishen,
    favourLevel: yearFavourLevel,
  }, currentLuck, context);
  
  const description = this.generateYearDescription(effect, flowYear);
  
  return {
    year: flowYear.year || new Date().getFullYear(),
    effect,
    description,
  };
}

/**
 * ç”Ÿæˆæµå¹´æè¿°
 */
generateYearDescription(effect, flowYear) {
  if (effect === 'æ¨åŠ¨') {
    return `å½“å‰æµå¹´${flowYear.ganzhi}ï¼Œæ•´ä½“åé¡ºï¼Œé€‚åˆæ¨è¿›`;
  } else if (effect === 'å‡é€Ÿ') {
    return `å½“å‰æµå¹´${flowYear.ganzhi}ï¼ŒèŠ‚å¥åç¼“ï¼Œé€‚åˆè°ƒæ•´`;
  } else {
    return `å½“å‰æµå¹´${flowYear.ganzhi}ï¼Œéœ€è¦å¤šç•™æ„å˜åŒ–`;
  }
}

/**
 * ç”Ÿæˆæœªæ¥ 2-3 å¹´æµå¹´æ•°ç»„ï¼ˆç®€åŒ–ç‰ˆï¼‰
 */
generateComingYears(derived, currentAge, count) {
  // ç®€åŒ–ç‰ˆï¼šåŸºäºå½“å‰æµå¹´ï¼Œç”Ÿæˆæœªæ¥å‡ å¹´çš„æµå¹´ä¿¡æ¯
  // å®é™…åº”è¯¥æ ¹æ®ç«‹æ˜¥æ—¶é—´è®¡ç®—å‡†ç¡®çš„æµå¹´å¹²æ”¯
  const currentYear = new Date().getFullYear();
  const years = [];
  
  for (let i = 1; i <= count; i++) {
    const year = currentYear + i;
    // è¿™é‡Œåº”è¯¥è®¡ç®—è¯¥å¹´çš„æµå¹´å¹²æ”¯ï¼Œç®€åŒ–ç‰ˆå…ˆè¿”å›ç©ºå¯¹è±¡
    years.push({
      year,
      effect: 'æ¨åŠ¨', // ç®€åŒ–ç‰ˆï¼Œå®é™…åº”è¯¥è®¡ç®—
    });
  }
  
  return years;
}

/**
 * ç”Ÿæˆè¡¥å……æç¤º
 */
generateNotes(currentLuck, context, favoredAvoid) {
  const notes = [];
  
  if (currentLuck.favourLevel === 'ç”¨ç¥') {
    notes.push('å½“å‰å¤§è¿é…åˆç”¨ç¥ï¼Œæ•´ä½“åé¡º');
  }
  
  if (currentLuck.clashHarmPunish.length > 0) {
    notes.push(`å¤šå†²${currentLuck.clashHarmPunish.join('ã€')}`);
  }
  
  if (currentLuck.stage === 'è°ƒæ•´è½¬æŠ˜æœŸ') {
    notes.push('å½“å‰å¤„äºè°ƒæ•´è½¬æŠ˜æœŸï¼Œéœ€è¦å¤šç•™æ„èŠ‚å¥å˜åŒ–');
  }
  
  return notes;
}

/**
 * è·å–é»˜è®¤å€¼ï¼ˆå½“å¤§è¿ä¸å­˜åœ¨æ—¶ï¼‰
 * æ³¨æ„ï¼šå¿…é¡»è¡¥é½æ‰€æœ‰å­—æ®µï¼Œé¿å…å‰ç«¯/LLM è®¿é—® undefined
 */
getDefaultLuckRhythmMetrics(startAge, luckDirection, currentAge) {
  return {
    startAge,
    luckDirection,
    currentAge,
    currentLuck: {
      index: 0,
      label: 'æœªçŸ¥å¤§è¿',
      ageRange: 'æœªçŸ¥',
      stem: '',
      branch: '',
      tenGod: 'æœªçŸ¥',
      element: 'æœªçŸ¥',
      favourLevel: 'ä¸­æ€§',
      stage: 'æ‰“åŸºç¡€æœŸ',
      intensity: 'åå¹³ç¨³',
      mainDomains: [],
      tone: 'åä¸»åŠ¨',
      strengthScore: 0.3,
      clashHarmPunish: [],
    },
    prevNextLuckSummary: {
      stageShiftHint: '',
    },
    currentYear: {
      year: new Date().getFullYear(),
      effect: 'æ¨åŠ¨',
      description: 'å½“å‰æµå¹´æ•´ä½“åé¡º',
    },
    comingYearsTrend: {
      summary: 'æœªæ¥å‡ å¹´æ•´ä½“åé¡º',
      tendency: 'æ•´ä½“åé¡º',
    },
    notes: [],
  };
}

/**
 * è·å–æœªå…¥å¤§è¿æ—¶çš„ç‰¹æ®Šå€¼
 * ç”¨äº 0-10 å²ç”¨æˆ·ï¼ˆç»™å­©å­çœ‹ç›˜ï¼‰æ—¶ä¼šå¾ˆè‡ªç„¶
 */
getPreLuckRhythmMetrics(startAge, luckDirection, currentAge) {
  return {
    startAge,
    luckDirection,
    currentAge,
    currentLuck: {
      index: -1,
      label: 'æœªå…¥å¤§è¿',
      ageRange: `çº¦ 0 å²åˆ° ${startAge} å²`,
      stem: '',
      branch: '',
      tenGod: 'æœªçŸ¥',
      element: 'æœªçŸ¥',
      favourLevel: 'ä¸­æ€§',
      stage: 'æ‰“åŸºç¡€æœŸ',  // æœªå…¥å¤§è¿æ—¶è§†ä¸ºæ‰“åŸºç¡€æœŸ
      intensity: 'åå¹³ç¨³',
      mainDomains: ['å­¦ä¹ ', 'å®¶åº­'],
      tone: 'åä¸»åŠ¨',
      strengthScore: 0.2,
      clashHarmPunish: [],
    },
    prevNextLuckSummary: {
      stageShiftHint: `æœªæ­£å¼å…¥å¤§è¿ Â· ä»¥åŸå±€ä¸æµå¹´ä¸ºä¸»çš„å‡†å¤‡æœŸ`,
    },
    currentYear: {
      year: new Date().getFullYear(),
      effect: 'æ¨åŠ¨',
      description: 'å½“å‰æµå¹´æ•´ä½“åé¡º',
    },
    comingYearsTrend: {
      summary: 'æœªæ¥å‡ å¹´æ•´ä½“åé¡º',
      tendency: 'æ•´ä½“åé¡º',
    },
    notes: ['æœªå…¥å¤§è¿ï¼Œä»¥åŸå±€ä¸æµå¹´ä¸ºä¸»'],
  };
}
```

### 4.3 åœ¨ `BaziEngine.compute()` ä¸­è°ƒç”¨

```javascript
// åœ¨ analysis å¯¹è±¡ä¸­æ·»åŠ 
analysis: {
  // ... å…¶ä»–å­—æ®µ
  luckRhythm: this.buildLuckRhythmMetrics(
    derived,
    birthJson,
    strengthResult,
    favoredAvoid,
    structureResult,
    pillars
  )
}
```

---

## äº”ã€LLM Prompt æ¨¡æ¿

### 5.1 Prompt æ¨¡æ¿ï¼ˆä¸å®˜è´¢æ ¼å±€å¯¹é½ï¼‰

```typescript
/**
 * æ„å»ºè¡Œè¿èŠ‚å¥ Promptï¼ˆæ ¸å¿ƒå‡½æ•°ï¼‰
 * @param {LuckRhythmMetrics} metrics - è¡Œè¿èŠ‚å¥æŒ‡æ ‡
 * @param {string} userQuestion - ç”¨æˆ·é—®é¢˜ï¼ˆå¯é€‰ï¼‰
 * @returns {string} Prompt æ–‡æœ¬
 */
export function buildLuckRhythmPromptCore(metrics: LuckRhythmMetrics, userQuestion?: string): string {
  const {
    startAge,
    luckDirection,
    currentAge,
    currentLuck,
    prevNextLuckSummary,
    currentYear,
    comingYearsTrend,
    notes,
  } = metrics;
  
  // å°† metrics è½¬æ¢ä¸º JSON å­—ç¬¦ä¸²
  const luckRhythmInputJson = JSON.stringify({
    startAge,
    luckDirection,
    currentAge,
    currentLuck: {
      label: currentLuck.label,
      ageRange: currentLuck.ageRange,
      tenGod: currentLuck.tenGod,
      element: currentLuck.element,
      favourLevel: currentLuck.favourLevel,
      stage: currentLuck.stage,
      intensity: currentLuck.intensity,
      mainDomains: currentLuck.mainDomains,
      tone: currentLuck.tone,
    },
    prevNextLuckSummary,
    currentYear,
    comingYearsTrend,
    notes,
  }, null, 2);
  
  return `ä½ æ˜¯ã€Œå°ä½©ã€ï¼Œä¸€ä½ä¸“ä¸šçš„å…«å­—å‘½ç† AI åŠ©æ‰‹ã€‚

ç°åœ¨è¦ä¸ºç”¨æˆ·ç”Ÿæˆä¸€æ®µã€Œè¡Œè¿èŠ‚å¥ã€è§£è¯»ï¼Œç”¨åœ¨å‘½ç›˜æŠ¥å‘Šä¸­çš„ã€Šè¡Œè¿èŠ‚å¥ã€‹å¡ç‰‡é‡Œã€‚

ã€å†™ä½œç›®æ ‡ã€‘

1. ç”¨ã€ŒèŠ‚å¥ã€å’Œã€Œé˜¶æ®µã€çš„è§†è§’ï¼Œæ¦‚æ‹¬å½“å‰ä¸è¿‘æœŸçš„å¤§è¿ã€æµå¹´æ°›å›´ã€‚

2. å¸®åŠ©ç”¨æˆ·ç†è§£ï¼šè‡ªå·±æ­£å¤„åœ¨äººç”Ÿçš„å“ªä¸€æ®µèŠ‚å¥ï¼Œæ˜¯æ‰“åŸºç¡€ã€çªç ´ã€è°ƒæ•´è¿˜æ˜¯æ”¶è·æœŸã€‚

3. ç»™å‡ºé¡ºåŠ¿è€Œä¸ºçš„å»ºè®®ï¼Œä½†é¿å…å…·ä½“å¹´ä»½çš„å±è¨€è€¸å¬é¢„æµ‹ã€‚

ã€å¯ç”¨æ•°æ®ã€‘

ä»¥ä¸‹æ˜¯å·²ç»ä¸ºä½ æ•´ç†å¥½çš„è¡Œè¿å‚æ•°ï¼ˆJSONï¼‰ï¼š

${luckRhythmInputJson}

å­—æ®µè¯´æ˜ï¼š

- startAge, luckDirection, currentAgeï¼šèµ·è¿å¹´é¾„ã€è¡Œè¿æ–¹å‘ä¸å½“å‰å¹´é¾„ã€‚

- currentLuckï¼šå½“å‰å¤§è¿çš„æ ¸å¿ƒä¿¡æ¯ï¼ˆåç¥ã€äº”è¡Œã€å–œå¿Œã€èŠ‚å¥é˜¶æ®µã€ä¸»é¢†åŸŸç­‰ï¼‰ã€‚

- prevNextLuckSummaryï¼šä¸Šä¸€è¿/ä¸‹ä¸€è¿çš„ç®€è¦ç‰¹ç‚¹ï¼Œä»¥åŠé˜¶æ®µè½¬æ¢æç¤ºã€‚

- currentYearï¼šå½“å‰æµå¹´çš„æ•´ä½“ä½œç”¨å€¾å‘ï¼ˆæ˜¯æ¨åŠ¨ã€å‡é€Ÿè¿˜æ˜¯æé†’è°ƒæ•´ï¼‰ã€‚

- comingYearsTrendï¼šæœªæ¥ 2â€“3 å¹´çš„æ•´ä½“è¶‹åŠ¿æè¿°ï¼ˆä¸é€å¹´ç»†ç®—ï¼‰ã€‚

- notesï¼šä¸€äº›éœ€è¦ä½ å‚è€ƒçš„è¡¥å……æç¤ºï¼Œå¦‚æ˜¯å¦ä¸ç”¨ç¥å‘¼åº”ã€æ˜¯å¦å¤šå†²æŸäº›å®«ä½ç­‰ã€‚

ã€å†…å®¹ç»“æ„è¦æ±‚ã€‘

è¯·ä¸¥æ ¼æŒ‰ç…§ä¸‹é¢ 4 éƒ¨åˆ†æ¥ç»„ç»‡å†…å®¹ï¼š

1. å¼€å¤´ï¼šé˜¶æ®µå®šä½ï¼ˆstagePositionï¼‰

   - è¯´æ˜ç›®å‰æ‰€å¤„çš„å¤§è¿é˜¶æ®µå¤§è‡´å±äºå“ªç§èŠ‚å¥ï¼š

     - å¦‚ã€Œæ‰“åŸºç¡€æœŸã€ã€Œæ‹“å±•å†²åˆºæœŸã€ã€Œè°ƒæ•´ä¸è½¬æŠ˜æœŸã€ã€Œæ²‰æ·€ä¸æ”¶è·æœŸã€ã€‚

   - å¯ä»¥ç»“åˆèµ·è¿æ—©æ™šã€è¡Œè¿æ–¹å‘ï¼Œç‚¹ä¸€ä¸‹èŠ‚å¥ç‰¹ç‚¹ï¼š

     - å¦‚ã€Œè¾ƒæ—©æ¥è§¦ç¤¾ä¼šè®®é¢˜ã€ã€ŒèŠ‚å¥å˜åŒ–ä¼šæ¯”åŒé¾„äººæ›´æ—©/æ›´æ™šæ„Ÿå—åˆ°ã€ã€‚

2. ä¸­æ®µï¼šå½“å‰å¤§è¿ä¸»é¢˜ï¼ˆluckThemeï¼‰

   - æè¿°å½“å‰å¤§è¿åé‡çš„é¢†åŸŸï¼ˆå­¦ä¹ ã€äº‹ä¸šã€å…³ç³»ã€è´¢å¯Œã€å†…åœ¨ä¿®ç‚¼ç­‰ï¼‰ã€‚

   - ç»“åˆåç¥ä¸ç”¨ç¥å–œå¿Œï¼Œè¯´æ¸…æ¥šï¼š

     - å“ªäº›æ–¹å‘é¡ºåŠ¿è€Œä¸ºï¼Œæ›´å®¹æ˜“æ¨ç€ä½ å¾€å‰èµ°ã€‚

     - å“ªäº›åšæ³•ä¼šæ”¾å¤§å‹åŠ›æˆ–æ¶ˆè€—ï¼Œéœ€è¦åœ¨èŠ‚å¥ä¸Šå¤šç•™æ„ã€‚

   - ç”¨è¯ä¿æŒä¸­æ€§ï¼Œå»ºè®®ä½¿ç”¨ã€Œé€‚åˆå¤šå°è¯•ã€ã€Œé€‚åˆç¨³æ‰ç¨³æ‰“ã€

     ã€Œéœ€è¦æ³¨æ„èŠ‚å¥å¤±è¡¡ã€ã€Œä¸è¦ä¸€å‘³åŠ é€Ÿã€ä¹‹ç±»çš„è¡¨è¿°ã€‚

3. ä¸­æ®µï¼šå½“å‰æµå¹´ä¸è¿‘å¹´è¶‹åŠ¿ï¼ˆyearTrendï¼‰

   - ç®€è¦è¯´æ˜å½“å‰æµå¹´çš„æ°›å›´ï¼š

     - åœ¨å½“å‰å¤§è¿ä¸»é¢˜ä¸Šï¼Œæ˜¯ã€Œå†æ¨ä½ ä¸€æŠŠã€ã€Œæé†’ä½ è¸©åˆ¹è½¦ã€è¿˜æ˜¯ã€Œæç¤ºä½ è°ƒæ•´æ­¥ä¼ã€ã€‚

   - å†ç”¨ 2â€“3 å¥è¯æ¦‚æ‹¬æœªæ¥ä¸€ä¸¤å¹´çš„å¤§è‡´èµ·ä¼æ„Ÿï¼š

     - å¯ä»¥å†™æˆã€Œæ•´ä½“åƒä¸€æ®µæœ‰èµ·ä¼çš„å°å¡é“ã€ã€Œå¤§è‡´æ˜¯åœ¨ç°æœ‰åŸºç¡€ä¸Šç¼“æ…¢æŠ¬å‡ã€ç­‰ã€‚

   - ä¸è¦é€å¹´é¢„æµ‹ï¼Œä¹Ÿä¸è¦å†™å…·ä½“å¹´ä»½å¯¹åº”çš„å…·ä½“å¤§äº‹ã€‚

4. ç»“å°¾ï¼šè¡ŒåŠ¨å»ºè®®ï¼ˆadviceï¼‰

   - æ€»ç»“ä¸€å¥ï¼šè¿™ä¸ªé˜¶æ®µæœ€é€‚åˆç»ƒä¹ æˆ–å®Œæˆçš„äº‹æƒ…æ˜¯ä»€ä¹ˆã€‚

   - ç»™å‡º 2â€“3 æ¡é€šç”¨ä½†æœ‰é’ˆå¯¹æ€§çš„æé†’ï¼Œä¾‹å¦‚ï¼š

     - ä»€ä¹ˆæ—¶å€™è¦æ•¢äºè¿ˆæ­¥ï¼Œä»€ä¹ˆæ—¶å€™è¦å­¦ä¼šåœä¸‹æ¥æ•´ç†è‡ªå·±ã€‚

     - å¦‚ä½•åœ¨èŠ‚å¥å˜åŒ–ä¸­ç…§é¡¾å¥½èº«å¿ƒï¼Œè€Œä¸æ˜¯è¢«èŠ‚å¥æ¨ç€èµ°ã€‚

   - å¼ºè°ƒï¼šå‘½è¿æœ‰èŠ‚å¥ï¼Œä½†é€‰æ‹©ä»åœ¨è‡ªå·±æ‰‹é‡Œã€‚

ã€é£æ ¼è¦æ±‚ã€‘

- ä½¿ç”¨ç®€ä½“ä¸­æ–‡ï¼Œä¸ç”¨ emojiã€‚

- ä¸å†™ã€ŒæŸå¹´ä¸€å®šå‘ç”Ÿå¤§äº‹ã€ã€Œå¿…æœ‰å¤§ç—…å¤§ç¾ã€è¿™ç±»ç»å¯¹åŒ–è¯­å¥ã€‚

- å°½é‡èšç„¦ã€ŒèŠ‚å¥æ„Ÿã€ã€Œé˜¶æ®µæ„Ÿã€ï¼Œé¿å…é‡å¤ã€Œå‘½å±€æ€»è§ˆã€ã€Œç”¨ç¥æ ¼å±€ã€ã€Œå®˜è´¢æ ¼å±€ã€å·²ç»è¯´è¿‡çš„å‘½å±€ç»“æ„å†…å®¹ã€‚

- è¯­æ°”å¹³å’Œã€ç†æ€§ï¼Œæ—¢èƒ½è®©äººçœ‹åˆ°æœºä¼šï¼Œä¹Ÿèƒ½æ¸©å’Œæé†’é£é™©ã€‚

ã€ç‰¹åˆ«è¯´æ˜ã€‘

- ä¸è¦é‡å¤ç”¨æˆ·å‘½ç›˜çš„åŸºç¡€ç»“æ„ï¼ˆå¦‚æ—¥ä¸»æ€§æ ¼ã€äº”è¡Œå¼ºå¼±ï¼‰ï¼Œè¿™äº›åœ¨ã€Šå‘½å±€æ€»è§ˆã€‹ä¸­å·²ç»è¯´æ˜ã€‚

- ä¸è¦è¯¦ç»†å±•å¼€ç”¨ç¥å–œå¿Œçš„åŸç†ï¼Œåªåœ¨éœ€è¦æ—¶ç®€çŸ­æä¸€å¥ï¼Œç”¨äºè§£é‡ŠèŠ‚å¥æ„Ÿå³å¯ã€‚

- ä¸è¦å¯¹å…·ä½“å¹´ä»½åšäº‹ä»¶é¢„æµ‹ï¼Œåªæè¿°èŠ‚å¥å’Œé˜¶æ®µã€‚

ã€è¾“å‡ºæ ¼å¼ã€‘

è¯·åªè¾“å‡ºä¸€ä¸ª JSON å¯¹è±¡ï¼Œæ ¼å¼å¦‚ä¸‹ï¼ˆä¸è¦åŒ…å«å¤šä½™æ–‡å­—ï¼‰ï¼š

{
  "stagePosition": "â€¦â€¦",
  "luckTheme": "â€¦â€¦",
  "yearTrend": "â€¦â€¦",
  "advice": "â€¦â€¦",
  "tags": ["â€¦â€¦", "â€¦â€¦"]
}

${userQuestion ? `\nã€ç”¨æˆ·é—®é¢˜ã€‘\n${userQuestion}\n` : ''}`;
}
```

### 5.2 åœ¨ Prompt æœåŠ¡ä¸­ä½¿ç”¨

```typescript
// åœ¨ core/src/modules/prompt/promptTemplates.ts ä¸­æ·»åŠ 
import { buildLuckRhythmPromptCore } from './luckRhythmPromptCore.js';

function buildLuckRhythmPrompt(params: {
  userQuestion: string;
  baziData: any;
}): string {
  const { userQuestion, baziData } = params;
  
  const luckRhythm = baziData?.analysis?.luckRhythm;
  
  if (!luckRhythm) {
    return `ä½ ç°åœ¨è¦è§£è¯»ç”¨æˆ·å‘½ç›˜çš„ã€Œè¡Œè¿èŠ‚å¥ã€éƒ¨åˆ†ï¼Œä½†æ•°æ®å°šæœªç”Ÿæˆã€‚è¯·å‘ŠçŸ¥ç”¨æˆ·ç¨åå†è¯•ã€‚`;
  }
  
  return buildLuckRhythmPromptCore(luckRhythm, userQuestion);
}

// åœ¨ buildOverviewPrompt ä¸­æ·»åŠ ç‰¹æ®Šå¤„ç†
export function buildOverviewPrompt(params: {
  sectionKey: string;
  userQuestion: string;
  baziData: any;
}): string {
  const { sectionKey, userQuestion, baziData } = params;
  
  // ç‰¹æ®Šå¤„ç†ï¼šè¡Œè¿èŠ‚å¥ä½¿ç”¨ä¸“ç”¨æ¨¡æ¿
  if (sectionKey === 'luckRhythm') {
    return buildLuckRhythmPrompt({
      userQuestion,
      baziData,
    });
  }
  
  // ... å…¶ä»–å¤„ç†
}
```

---

## å…­ã€å‰ç«¯é€‚é…

### 6.1 ç±»å‹å®šä¹‰ï¼ˆ`app/src/types/chart.ts`ï¼‰

```typescript
// åœ¨ BaziChartDto çš„ analysis ä¸­æ·»åŠ 
luckRhythm?: {
  startAge: number;
  luckDirection: 'é¡ºè¡Œ' | 'é€†è¡Œ';
  currentAge: number;
  currentLuck: {
    index: number;
    label: string;
    ageRange: string;
    stem: string;
    branch: string;
    tenGod: string;
    element: string;
    favourLevel: 'ç”¨ç¥' | 'ä¸­æ€§' | 'å¿Œç¥';
    stage: 'æ‰“åŸºç¡€æœŸ' | 'æ‹“å±•å†²åˆºæœŸ' | 'è°ƒæ•´è½¬æŠ˜æœŸ' | 'æ²‰æ·€æ”¶è·æœŸ';
    intensity: 'åå¹³ç¨³' | 'èµ·ä¼æ„Ÿè¾ƒå¼º' | 'å˜åŠ¨æ˜æ˜¾';
    mainDomains: ('å­¦ä¹ ' | 'äº‹ä¸š' | 'è´¢å¯Œ' | 'å…³ç³»' | 'å®¶åº­' | 'è‡ªæˆ‘ä¿®ç‚¼')[];
    tone: 'åä¸»åŠ¨' | 'åè¢«åŠ¨' | 'å†…ä¿®å‹' | 'å¤–æ‹“å‹';
    strengthScore: number;
    clashHarmPunish: string[];
  };
  prevNextLuckSummary: {
    prev?: {
      label: string;
      shortComment: string;
    };
    next?: {
      label: string;
      shortComment: string;
    };
    stageShiftHint: string;
  };
  currentYear: {
    year: number;
    effect: 'æ¨åŠ¨' | 'å‡é€Ÿ' | 'æé†’è°ƒæ•´';
    description: string;
  };
  comingYearsTrend: {
    summary: string;
    tendency: 'æ•´ä½“åé¡º' | 'æœ‰èµ·ä¼çš„å°å¡é“' | 'ä»¥è°ƒæ•´ä¸ºä¸»';
  };
  notes: string[];
};
```

### 6.2 UI ç»„ä»¶ï¼ˆ`app/src/screens/ChartDetail/ChartOverviewTab.tsx`ï¼‰

```typescript
{/* è¡Œè¿èŠ‚å¥å¡ */}
<TouchableOpacity
  style={styles.card}
  activeOpacity={0.7}
  onPress={() => handleOneClickRead('luckRhythm', 'è«‹è©³ç´°è§£è®€æˆ‘çš„è¡Œé‹ç¯€å¥')}
>
  <View style={styles.cardHeader}>
    <Text style={styles.cardTitle}>è¡Œè¿èŠ‚å¥</Text>
    <Text style={styles.oneClickReadTag}>{t('chartDetail.overview.oneClickRead')}</Text>
  </View>
  {result?.analysis?.luckRhythm ? (
    <View style={styles.indicatorContainer}>
      {/* å½“å‰é˜¶æ®µ */}
      <View style={styles.indicatorRow}>
        <Text style={styles.indicatorLabel}>å½“å‰é˜¶æ®µï¼š</Text>
        <Text style={styles.indicatorValue}>
          {result.analysis.luckRhythm.currentLuck.stage}
        </Text>
      </View>
      
      {/* èŠ‚å¥å¼ºåº¦ */}
      <View style={styles.indicatorRow}>
        <Text style={styles.indicatorLabel}>èŠ‚å¥å¼ºåº¦ï¼š</Text>
        <Text style={styles.indicatorValue}>
          {result.analysis.luckRhythm.currentLuck.intensity}
        </Text>
      </View>
      
      {/* ä¸»é¢†åŸŸ */}
      {result.analysis.luckRhythm.currentLuck.mainDomains.length > 0 && (
        <View style={styles.indicatorRow}>
          <Text style={styles.indicatorLabel}>ä¸»é¢†åŸŸï¼š</Text>
          <View style={styles.tagContainer}>
            {result.analysis.luckRhythm.currentLuck.mainDomains.map((domain, idx) => (
              <View key={idx} style={styles.tag}>
                <Text style={styles.tagText}>{domain}</Text>
              </View>
            ))}
          </View>
        </View>
      )}
      
      {/* å½“å‰å¤§è¿ */}
      <View style={styles.indicatorRow}>
        <Text style={styles.indicatorLabel}>å½“å‰å¤§è¿ï¼š</Text>
        <Text style={styles.indicatorValue}>
          {result.analysis.luckRhythm.currentLuck.label} Â· {result.analysis.luckRhythm.currentLuck.ageRange}
        </Text>
      </View>
      
      {/* å½“å‰æµå¹´ */}
      <View style={styles.indicatorRow}>
        <Text style={styles.indicatorLabel}>å½“å‰æµå¹´ï¼š</Text>
        <Text style={styles.indicatorValue}>
          {result.analysis.luckRhythm.currentYear.year}å¹´ Â· {result.analysis.luckRhythm.currentYear.effect}
        </Text>
      </View>
      
      {/* æœªæ¥è¶‹åŠ¿ */}
      <View style={styles.indicatorRow}>
        <Text style={styles.indicatorLabel}>æœªæ¥è¶‹åŠ¿ï¼š</Text>
        <Text style={styles.indicatorValue}>
          {result.analysis.luckRhythm.comingYearsTrend.tendency}
        </Text>
      </View>
      
      {/* é˜¶æ®µè½¬æ¢æç¤ºï¼ˆå¯é€‰ï¼‰ */}
      {result.analysis.luckRhythm.prevNextLuckSummary.stageShiftHint ? (
        <View style={styles.indicatorRow}>
          <Text style={styles.indicatorLabel}>é˜¶æ®µè½¬æ¢ï¼š</Text>
          <Text style={styles.indicatorValue}>
            {result.analysis.luckRhythm.prevNextLuckSummary.stageShiftHint}
          </Text>
        </View>
      ) : null}
    </View>
  ) : (
    <Text style={styles.placeholderText}>è¡Œè¿èŠ‚å¥ï¼ˆå¾…å¯¦ç¾ï¼‰</Text>
  )}
</TouchableOpacity>
```

---

## ä¸ƒã€å®æ–½æ­¥éª¤

### Phase 1: å¼•æ“å±‚å®ç° âœ…ï¼ˆå¾…å®æ–½ï¼‰

1. âœ… åœ¨ `core/engine/index.js` ä¸­æ·»åŠ  `buildLuckRhythmMetrics` å‡½æ•°
2. âœ… å®ç°æ‰€æœ‰è¾…åŠ©å‡½æ•°ï¼ˆ`evaluateStageMeta`ã€`evaluateYearEffect`ã€`generateComingYearsTrend` ç­‰ï¼‰
3. âœ… åœ¨ `BaziEngine.compute()` ä¸­è°ƒç”¨å¹¶ç»„è£…æ•°æ®
4. âœ… æµ‹è¯•æ•°æ®ç»„è£…é€»è¾‘

### Phase 2: Prompt æ¨¡æ¿ âœ…ï¼ˆå¾…å®æ–½ï¼‰

1. âœ… åœ¨ `core/src/modules/prompt/promptTemplates.ts` ä¸­æ·»åŠ  `buildLuckRhythmPrompt` å‡½æ•°
2. âœ… åœ¨ `buildOverviewPrompt` ä¸­æ·»åŠ  `luckRhythm` çš„ç‰¹æ®Šå¤„ç†
3. âœ… æµ‹è¯• Prompt ç”Ÿæˆ

### Phase 3: ç±»å‹å®šä¹‰ âœ…ï¼ˆå¾…å®æ–½ï¼‰

1. âœ… åœ¨ `app/src/types/chart.ts` ä¸­æ·»åŠ  `luckRhythm` ç±»å‹å®šä¹‰

### Phase 4: å‰ç«¯UI âœ…ï¼ˆå¾…å®æ–½ï¼‰

1. âœ… åœ¨ `ChartOverviewTab.tsx` ä¸­æ·»åŠ "è¡Œè¿èŠ‚å¥å¡"
2. âœ… æµ‹è¯•UIæ˜¾ç¤ºæ•ˆæœ

---

## å…«ã€æ³¨æ„äº‹é¡¹

### 8.1 å‘åå…¼å®¹

- ä¿ç•™åŸæœ‰çš„ `analysis.luckAnalysis`ã€`analysis.flowYearAnalysis` ç­‰å­—æ®µï¼Œä¸åˆ é™¤
- å‰ç«¯å¯ä»¥åŒæ—¶æ”¯æŒå¤šç§å¡ç‰‡ï¼ˆé€šè¿‡é…ç½®åˆ‡æ¢ï¼Œæˆ–é€æ­¥è¿ç§»ï¼‰

### 8.2 æ•°æ®å®Œæ•´æ€§

- å¦‚æœæŸä¸ªæ¨¡å—çš„è®¡ç®—ç»“æœç¼ºå¤±ï¼Œä½¿ç”¨é»˜è®¤å€¼æˆ–ç©ºæ•°ç»„ï¼Œé¿å…å‰ç«¯æŠ¥é”™
- æ‰€æœ‰å¯é€‰å­—æ®µï¼ˆå¦‚ `prevNextLuckSummary.prev`ã€`notes`ï¼‰éƒ½è¦åšç©ºå€¼æ£€æŸ¥

### 8.3 æ€§èƒ½è€ƒè™‘

- `evaluateStageMeta` å‡½æ•°éœ€è¦éå†åç¥å’Œç”¨ç¥åˆ—è¡¨ï¼Œä½†æ•°æ®é‡å°ï¼Œæ€§èƒ½å½±å“å¯å¿½ç•¥
- `analyzeClashHarmPunish` éœ€è¦æ£€æŸ¥å››æŸ±å…³ç³»ï¼Œä½†è®¡ç®—ç®€å•ï¼Œæ€§èƒ½å½±å“å¯å¿½ç•¥

### 8.4 ä¸ç³»ç»Ÿå‚æ•°å¯¹é½

- âœ… æ‰€æœ‰æ•°æ®æ¥æºéƒ½æ¥è‡ªç°æœ‰ç³»ç»Ÿå‚æ•°ï¼Œä¸æ–°å¢è®¡ç®—æ¨¡å—
- âœ… å¤ç”¨ç°æœ‰çš„ `favoredAvoid`ã€`strengthResult`ã€`structureResult` ç­‰
- âœ… ä¸ã€Œå®˜è´¢æ ¼å±€ã€ã€Œèƒ½é‡æµé€šã€å¡ç‰‡ä¿æŒç»“æ„å¯¹é½ï¼Œæ–¹ä¾¿ç»´æŠ¤

---

## ä¹ã€å¾…ç¡®è®¤äº‹é¡¹

1. **é˜¶æ®µåˆ†ç±»è§„åˆ™**ï¼šå½“å‰è§„åˆ™è¾ƒç®€å•ï¼Œæ˜¯å¦éœ€è¦å¢åŠ æ›´å¤šè§„åˆ™ï¼Ÿå»ºè®®å…ˆå®ç°åŸºç¡€ç‰ˆæœ¬ï¼Œåç»­æ ¹æ®ç”¨æˆ·åé¦ˆæ‰©å±•ã€‚

2. **æµå¹´ä½œç”¨è¯„ä¼°**ï¼šå½“å‰é€»è¾‘è¾ƒç®€å•ï¼Œæ˜¯å¦éœ€è¦è€ƒè™‘æ›´å¤šå› ç´ ï¼ˆå¦‚æµå¹´ä¸å¤§è¿çš„åˆåŒ–ã€å†²å…‹ç­‰ï¼‰ï¼Ÿå»ºè®®å…ˆå®ç°åŸºç¡€ç‰ˆæœ¬ï¼Œåç»­æ ¹æ®å®é™…æ•ˆæœä¼˜åŒ–ã€‚

3. **æœªæ¥è¶‹åŠ¿è®¡ç®—**ï¼šå½“å‰ç®€åŒ–ç‰ˆåªç”Ÿæˆæœªæ¥ 2-3 å¹´ï¼Œæ˜¯å¦éœ€è¦é€å¹´è®¡ç®—ï¼Ÿå»ºè®®å…ˆç”¨ç®€åŒ–ç‰ˆï¼Œåç»­å¯ä¼˜åŒ–ä¸ºé€å¹´è®¡ç®—ã€‚

4. **å†²åˆåˆ‘å®³åˆ†æ**ï¼šå½“å‰åªæ£€æŸ¥å…­å†²ï¼Œæ˜¯å¦éœ€è¦æ£€æŸ¥å…­åˆã€ä¸‰åˆã€ä¸‰ä¼šã€åˆ‘ã€å®³ç­‰ï¼Ÿå»ºè®®å…ˆå®ç°å…­å†²ï¼Œåç»­å¯æ‰©å±•ã€‚

---

## åã€æ€»ç»“

### âœ… ä¸ç³»ç»Ÿå‚æ•°ä¸€è‡´çš„éƒ¨åˆ†

- èµ·è¿å¹´é¾„ï¼šä½¿ç”¨ `derived.qi_yun.years`
- å¤§è¿æ–¹å‘ï¼šä½¿ç”¨ `derived.yun_direction`
- å¤§è¿åºåˆ—ï¼šä½¿ç”¨ `derived.luck_cycle`
- æµå¹´ä¿¡æ¯ï¼šä½¿ç”¨ `derived.flow_years`
- æ—¥ä¸»å¼ºå¼±ï¼šä½¿ç”¨ `strengthResult.score`
- ç”¨ç¥ç»“æœï¼šä½¿ç”¨ `favoredAvoid.favored` å’Œ `favoredAvoid.avoid`
- åç¥æƒé‡ï¼šä½¿ç”¨ `structureResult.W`

### âš ï¸ éœ€è¦è¡¥å……/é€‚é…çš„éƒ¨åˆ†

- å½“å‰å¹´é¾„è®¡ç®—ï¼šéœ€è¦ä»å‡ºç”Ÿæ—¥æœŸè®¡ç®—
- å½“å‰å¤§è¿ç´¢å¼•ï¼šéœ€è¦æ ¹æ®å½“å‰å¹´é¾„å’Œèµ·è¿å¹´é¾„è®¡ç®—
- å¤§è¿äº”è¡Œæå–ï¼šéœ€è¦ä»å¤©å¹²åœ°æ”¯è®¡ç®—äº”è¡Œ
- å¤§è¿å–œå¿Œåˆ¤æ–­ï¼šéœ€è¦æ ¹æ®ç”¨ç¥åˆ—è¡¨åˆ¤æ–­
- é˜¶æ®µ/èŠ‚å¥æ ‡ç­¾ï¼šéœ€è¦å®ç° `evaluateStageMeta` ç®—æ³•
- æµå¹´ä½œç”¨è¯„ä¼°ï¼šéœ€è¦å®ç° `evaluateYearEffect` ç®—æ³•
- æœªæ¥è¶‹åŠ¿ç”Ÿæˆï¼šéœ€è¦å®ç° `generateComingYearsTrend` ç®—æ³•
- å†²åˆåˆ‘å®³åˆ†æï¼šéœ€è¦å®ç° `analyzeClashHarmPunish` å‡½æ•°

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0  
**åˆ›å»ºæ—¶é—´**ï¼š2024å¹´12æœˆ  
**æœ€åæ›´æ–°**ï¼š2024å¹´12æœˆ  
**ç»´æŠ¤è€…**ï¼šå¼€å‘å›¢é˜Ÿ

