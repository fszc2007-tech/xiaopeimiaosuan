# 小佩 App 快速开始指南

> **最后更新**: 2024-11-18  
> **当前进度**: Core 后端基础功能已完成 (40%)

---

## 🎯 当前状态

### ✅ 已完成
- **项目初始化**: 100%
- **文档整理**: 100%
- **Core 后端基础**: 40%
  - ✅ 数据库初始化脚本
  - ✅ 认证模块（登录/注册/验证码）
  - ✅ 命盘模块（计算/查询/删除）
  - ✅ 八字引擎接口封装

### 🚧 进行中
- **Core 后端**: 准备测试 API
- **App 前端**: 准备开始开发

---

## 📦 环境要求

- **Node.js**: 18+ (推荐 20+)
- **MySQL**: 8.0+ (已安装)
- **npm**: 9+
- **Expo CLI**: 最新版

---

## 🚀 快速启动

### 1. 初始化数据库

```bash
# 进入项目目录
cd /Users/gaoxuxu/Desktop/小佩APP

# 登录 MySQL（使用 root 或其他有权限的账户）
mysql -u root -p

# 创建数据库
CREATE DATABASE xiaopei CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

# 退出 MySQL
exit

# 初始化表结构
mysql -u root -p xiaopei < core/src/database/migrations/001_create_tables.sql
```

### 2. 配置环境变量

#### Core 后端
```bash
cd core
cp .env.example .env

# 编辑 .env，填写数据库配置
# XIAOPEI_MYSQL_HOST=localhost
# XIAOPEI_MYSQL_PORT=3306
# XIAOPEI_MYSQL_USER=root
# XIAOPEI_MYSQL_PASSWORD=your_password
# XIAOPEI_MYSQL_DATABASE=xiaopei
```

#### App 前端
```bash
cd app
cp .env.example .env

# 编辑 .env
# EXPO_PUBLIC_API_URL=http://localhost:3000
```

### 3. 启动 Core 后端

```bash
cd core
npm run dev

# 服务器将在 http://localhost:3000 启动
# 健康检查: http://localhost:3000/health
```

### 4. 启动 App 前端

```bash
cd app
npm start

# 按照提示操作：
# - 按 'i' 启动 iOS 模拟器
# - 按 'a' 启动 Android 模拟器
# - 或扫描二维码在真机上运行
```

### 5. 启动 Admin 后台（可选）

```bash
cd admin
npm run dev

# 访问 http://localhost:5173
```

---

## 📝 测试 API

### 1. 健康检查

```bash
curl http://localhost:3000/health
```

**预期响应**:
```json
{
  "success": true,
  "data": {
    "status": "ok",
    "timestamp": "2024-11-18T06:00:00.000Z",
    "version": "1.0.0"
  }
}
```

### 2. 请求验证码

```bash
# CN 区域（手机号）
curl -X POST http://localhost:3000/api/v1/auth/request-otp \
  -H "Content-Type: application/json" \
  -d '{
    "phone": "13800138000",
    "region": "cn"
  }'

# HK 区域（邮箱）
curl -X POST http://localhost:3000/api/v1/auth/request-otp \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@example.com",
    "region": "hk"
  }'
```

**预期响应**:
```json
{
  "success": true,
  "data": {
    "message": "验证码已发送"
  }
}
```

**注意**: 验证码会打印在服务器控制台（开发模式）

### 3. 登录/注册

```bash
# 使用上一步获取的验证码
curl -X POST http://localhost:3000/api/v1/auth/login_or_register \
  -H "Content-Type: application/json" \
  -d '{
    "phone": "13800138000",
    "code": "123456",
    "channel": "cn"
  }'
```

**预期响应**:
```json
{
  "success": true,
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "user": {
      "user_id": "uuid-here",
      "nickname": "用户8000",
      "phone": "13800138000",
      "app_region": "cn",
      "is_pro": false,
      "created_at": "2024-11-18T06:00:00.000Z"
    }
  }
}
```

### 4. 计算命盘

```bash
# 使用上一步获取的 token
curl -X POST http://localhost:3000/api/v1/bazi/chart \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN_HERE" \
  -d '{
    "name": "张三",
    "gender": "male",
    "birth": {
      "sex": "male",
      "calendar_type": "公历",
      "year": 1990,
      "month": 1,
      "day": 1,
      "hour": 12,
      "minute": 0,
      "tz": "Asia/Shanghai"
    }
  }'
```

**预期响应**:
```json
{
  "success": true,
  "data": {
    "chartId": "uuid-here",
    "chartProfileId": "uuid-here",
    "result": {
      "pillars": { /* 八字结果 */ },
      "dayMaster": { /* 日主信息 */ },
      "shensha": { /* 神煞 */ },
      // ... 其他 400+ 字段
    }
  }
}
```

### 5. 获取命盘列表

```bash
curl -X GET "http://localhost:3000/api/v1/bazi/charts?page=1&pageSize=10" \
  -H "Authorization: Bearer YOUR_TOKEN_HERE"
```

---

## 🐛 常见问题

### 1. 数据库连接失败
- 检查 MySQL 是否运行：`mysql.server status`
- 检查 `.env` 中的数据库配置
- 检查数据库是否存在：`SHOW DATABASES LIKE 'xiaopei';`

### 2. 验证码未发送
- 开发模式下，验证码会打印在服务器控制台
- 生产环境需要配置短信/邮件服务

### 3. Token 无效
- Token 默认有效期为 7 天
- 检查 `XIAOPEI_JWT_SECRET` 是否配置

### 4. 八字计算失败
- 检查 `core/engine/` 目录是否完整
- 检查出生信息格式是否正确

---

## 📚 相关文档

- **开发进度**: `开发进度总览.md`
- **项目结构**: `项目目录结构说明.md`
- **API 规范**: `app.doc/API接口统一规范.md`
- **数据库设计**: `core.doc/数据库与API设计方案.md`
- **安全规范**: `app.doc/security/` 目录

---

## 🎯 下一步

1. **测试所有 API 接口**
2. **实现 LLM 服务集成**
3. **开发 App 前端登录页面**
4. **实现解读和对话功能**

---

## 💡 提示

- 使用 Postman 或 Insomnia 进行 API 测试更方便
- 开发模式下服务器会自动重启（nodemon）
- 修改代码后 App 会自动刷新（热重载）

---

**祝开发顺利！** 🚀

