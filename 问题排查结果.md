# 问题排查结果

## 问题1：神煞乱码

### 根本原因
**数据库中的数据本身已经是乱码**（之前插入时使用了错误的字符集）

### 证据
从生产环境 API 返回的数据：
```json
{
  "name": "\u00e6\u2013\u2021\u00e6\u02dc\u0152\u00e8\u00b2\u00b4\u00e4\u00ba\u00ba",
  "nameLength": 12,
  "nameBytes": 26
}
```

- `nameLength: 12` 但 `nameBytes: 26`：说明数据存储的是 UTF-8 字节序列，但被错误地解释为 Unicode 转义序列
- 正确的 "文昌貴人" 应该是 4 个字符，UTF-8 编码应该是 12 字节
- 但返回的数据显示为 12 个 Unicode 转义序列，说明数据在插入时就已经是乱码

### 解决方案
**需要重新插入数据**，而不是只修改表字符集。

Migration 044 只修改了表的字符集，但无法修复已经乱码的数据。

### 修复步骤
1. 从开发环境导出正确的数据（UTF-8 编码）
2. 在生产环境重新插入数据
3. 或者使用脚本从开发环境同步数据到生产环境

## 问题2：DeepSeek API 未配置

### 根本原因
**生产环境的 `llm_api_configs` 表中 DeepSeek 配置不正确**

可能的情况：
1. `is_enabled = FALSE`
2. `api_key_encrypted = NULL`
3. 或者记录不存在

### 证据
`getDefaultModel()` 的查询条件：
```sql
SELECT model FROM llm_api_configs 
WHERE is_enabled = TRUE AND api_key_encrypted IS NOT NULL
ORDER BY FIELD(model, 'deepseek', 'chatgpt', 'qwen')
LIMIT 1
```

如果查询结果为空，会抛出：
```
没有可用的 LLM 模型，请先配置 API Key
```

### 解决方案
1. 检查生产环境的 `llm_api_configs` 表
2. 确保 DeepSeek 记录的 `is_enabled = TRUE`
3. 确保 `api_key_encrypted` 字段有值
4. 如果记录不存在，需要初始化配置

### 修复步骤
1. 查询生产环境数据库：`SELECT * FROM llm_api_configs WHERE model = 'deepseek'`
2. 如果记录不存在或配置不正确，需要：
   - 从开发环境导出配置
   - 在生产环境插入/更新配置
   - 或者通过 Admin 后台配置

## 下一步行动

1. **神煞乱码**：
   - 创建数据迁移脚本，从开发环境同步正确的数据到生产环境
   - 或者手动重新插入数据

2. **DeepSeek API 配置**：
   - 等待部署完成后，通过 API 检查生产环境的 LLM 配置
   - 如果配置不正确，通过 Admin 后台或直接更新数据库

