# Token é—®é¢˜å®Œæ•´ä¿®å¤æ€»ç»“

## ğŸ” é—®é¢˜å›é¡¾

ç”¨æˆ·æŠ¥å‘Šäº†ä¸‰ä¸ªä¸»è¦é—®é¢˜ï¼š
1. âŒ **Token ä¸¢å¤±**ï¼šç™»å½•æˆåŠŸåï¼Œé‡å¯ App Token ä¸¢å¤±
2. âŒ **æœªç™»å½•æ—¶æ˜¾ç¤ºé”™è¯¯å¼¹çª—**ï¼šåº”è¯¥ç›´æ¥è¿›å…¥ç™»å½•é¡µ
3. âŒ **æœªç™»å½•æ—¶æ˜¾ç¤ºé€€å‡ºæŒ‰é’®**ï¼šæœªç™»å½•çŠ¶æ€ä¸åº”è¯¥æœ‰é€€å‡ºé€‰é¡¹

---

## ğŸ¯ æ ¹æœ¬åŸå› 

### é—®é¢˜ 1ï¼šToken Storage Key ä¸ä¸€è‡´

**ç—‡çŠ¶**ï¼š
- ç™»å½•æ—¶ token ä¿å­˜æˆåŠŸï¼ˆæ—¥å¿—æ˜¾ç¤º"âœ… Token ä¿å­˜æˆåŠŸå¹¶éªŒè¯é€šè¿‡"ï¼‰
- ä½† API è¯·æ±‚æ—¶æç¤º"æœªæä¾›è®¤è¯ Token"
- é‡å¯å token ä¸¢å¤±

**æ ¹æœ¬åŸå› **ï¼š
- âŒ `tokenStorage.ts` ä¿å­˜ token åˆ°ï¼š`xiaopei-token-v2`
- âŒ `client.ts` è¯»å– token ä»ï¼š`@xiaopei/auth_token`
- ğŸ”¥ **ä¸¤ä¸ª key ä¸ä¸€è‡´ï¼Œå¯¼è‡´è¯»å†™ä¸åŒçš„å­˜å‚¨ä½ç½®ï¼**

**ä¿®å¤**ï¼š
```typescript
// tokenStorage.ts
- const TOKEN_STORAGE_KEY = 'xiaopei-token-v2';
+ const TOKEN_STORAGE_KEY = '@xiaopei/auth_token';
```

---

### é—®é¢˜ 2 & 3ï¼šç¼ºå°‘è®¤è¯çŠ¶æ€æ£€æŸ¥

**ç—‡çŠ¶**ï¼š
- æœªç™»å½•ç”¨æˆ·è¿›å…¥ä¸»é¡µåï¼ŒCasesScreen å’Œ MeScreen è‡ªåŠ¨è¯·æ±‚ API
- API è¿”å› 401 é”™è¯¯ï¼Œæ˜¾ç¤ºé”™è¯¯å¼¹çª—
- æœªç™»å½•çŠ¶æ€ä¹Ÿæ˜¾ç¤º"é€€å‡ºç™»å½•"æŒ‰é’®

**æ ¹æœ¬åŸå› **ï¼š
- é¡µé¢æ²¡æœ‰æ£€æŸ¥ `isAuthenticated` å°±ç›´æ¥å‘èµ· API è¯·æ±‚
- "é€€å‡ºç™»å½•"æŒ‰é’®æ²¡æœ‰æ¡ä»¶æ¸²æŸ“

**ä¿®å¤**ï¼š
1. âœ… `MeScreen.tsx`ï¼šåªæœ‰åœ¨ `isAuthenticated` æ—¶æ‰è¯·æ±‚ API
2. âœ… `CasesScreen.tsx`ï¼šåªæœ‰åœ¨ `isAuthenticated` æ—¶æ‰è¯·æ±‚ API
3. âœ… `SettingsScreen.tsx`ï¼šåªæœ‰åœ¨ `isAuthenticated` æ—¶æ‰æ˜¾ç¤ºé€€å‡ºæŒ‰é’®

---

## ğŸ“ å®Œæ•´ä¿®å¤æ¸…å•

### 1. Token Storage Key ç»Ÿä¸€
**æ–‡ä»¶**ï¼š`app/src/utils/tokenStorage.ts`

```typescript
// âœ… ä½¿ç”¨ä¸ client.ts ä¸€è‡´çš„ key
const TOKEN_STORAGE_KEY = '@xiaopei/auth_token';
```

### 2. MeScreen è®¤è¯æ£€æŸ¥
**æ–‡ä»¶**ï¼š`app/src/screens/Me/MeScreen.tsx`

```typescript
useFocusEffect(
  useCallback(() => {
    // âœ… åªæœ‰åœ¨å·²è®¤è¯ä¸”æœ‰ token æ—¶æ‰è·å–æ•°æ®
    if (isAuthenticated && token && token.length > 0) {
      console.log('[MeScreen] é¡µé¢èšç„¦ï¼Œå¼€å§‹è·å–æ•°æ®');
      fetchProfile();
    } else {
      console.log('[MeScreen] æœªç™»å½•çŠ¶æ€ï¼Œè·³è¿‡æ•°æ®è·å–');
    }
  }, [fetchProfile, token, isAuthenticated])
);
```

### 3. CasesScreen è®¤è¯æ£€æŸ¥
**æ–‡ä»¶**ï¼š`app/src/screens/Cases/CasesScreen.tsx`

```typescript
useFocusEffect(
  useCallback(() => {
    const checkAndFetch = async () => {
      const { useAuthStore } = await import('@/store');
      const isAuthenticated = useAuthStore.getState().isAuthenticated;
      
      if (isAuthenticated) {
        fetchProfiles();
      } else {
        console.log('[CasesScreen] æœªç™»å½•çŠ¶æ€ï¼Œè·³è¿‡æ•°æ®è·å–');
      }
    };
    
    checkAndFetch();
  }, [fetchProfiles])
);
```

### 4. é€€å‡ºç™»å½•æŒ‰é’®æ¡ä»¶æ¸²æŸ“
**æ–‡ä»¶**ï¼š`app/src/screens/Settings/SettingsScreen.tsx`

```typescript
// è·å–è®¤è¯çŠ¶æ€
const isAuthenticated = useAuthStore((state) => state.isAuthenticated);

// åªåœ¨å·²ç™»å½•æ—¶æ˜¾ç¤ºé€€å‡ºæŒ‰é’®
{isAuthenticated && (
  <Pressable style={styles.logoutButton} onPress={handleLogout}>
    <LogOut color={colors.brandRed} size={20} />
    <Text style={styles.logoutButtonText}>é€€å‡ºç™»éŒ„</Text>
  </Pressable>
)}
```

### 5. InitializeAuth è®¾ç½® _hasHydrated
**æ–‡ä»¶**ï¼š`app/src/utils/initializeAuth.ts`

```typescript
// æ¢å¤æˆåŠŸåè®¾ç½® _hasHydrated
useAuthStore.setState({
  token,
  isAuthenticated: true,
  _hasHydrated: true, // âœ… æ ‡è®°å·²æ¢å¤
});
```

---

## âœ… ä¿®å¤æ•ˆæœ

### Token æŒä¹…åŒ–æµç¨‹ï¼ˆä¿®å¤åï¼‰

```
ç™»å½•æˆåŠŸ
  â†“
tokenStorage.save(token)
  â†’ ä¿å­˜åˆ° @xiaopei/auth_token âœ…
  â†“
é‡å¯ App
  â†“
initializeAuth()
  â†’ ä» @xiaopei/auth_token è¯»å– âœ…
  â†’ æ›´æ–° authStore.isAuthenticated = true âœ…
  â†“
client.ts æ‹¦æˆªå™¨
  â†’ ä» @xiaopei/auth_token è¯»å– âœ…
  â†’ æ·»åŠ åˆ° Authorization header âœ…
  â†“
API è¯·æ±‚æˆåŠŸ âœ…
```

### ç”¨æˆ·ä½“éªŒï¼ˆä¿®å¤åï¼‰

#### åœºæ™¯ 1ï¼šé¦–æ¬¡æ‰“å¼€ Appï¼ˆæœªç™»å½•ï¼‰
```
æ‰“å¼€ App
  â†“
initializeAuth(): æ²¡æœ‰ token
  â†“
RootNavigator: isAuthenticated = false
  â†“
æ˜¾ç¤ºç™»å½•é¡µ âœ…ï¼ˆä¸æ˜¾ç¤ºé”™è¯¯ï¼‰
```

#### åœºæ™¯ 2ï¼šå·²ç™»å½•åé‡å¯ App
```
æ‰“å¼€ App
  â†“
initializeAuth(): æ‰¾åˆ° token
  â†’ æ¢å¤ isAuthenticated = true âœ…
  â†“
RootNavigator: isAuthenticated = true
  â†“
æ˜¾ç¤ºä¸»é¡µ
  â†“
API è¯·æ±‚è‡ªåŠ¨æºå¸¦ token âœ…
  â†“
æ•°æ®æ­£å¸¸æ˜¾ç¤º âœ…
```

#### åœºæ™¯ 3ï¼šæœªç™»å½•çŠ¶æ€
```
è¿›å…¥è®¾ç½®é¡µ
  â†“
isAuthenticated = false
  â†“
ä¸æ˜¾ç¤º"é€€å‡ºç™»å½•"æŒ‰é’® âœ…
```

---

## ğŸ§ª æµ‹è¯•æ¸…å•

### âœ… Token æŒä¹…åŒ–æµ‹è¯•
- [x] ç™»å½•æˆåŠŸåï¼Œtoken è¢«ä¿å­˜
- [x] é‡å¯ Appï¼Œtoken è¢«æ­£ç¡®æ¢å¤
- [x] API è¯·æ±‚è‡ªåŠ¨æºå¸¦ Authorization header
- [x] "æˆ‘çš„"å’Œ"æ¡£æ¡ˆ"é¡µé¢æ­£å¸¸æ˜¾ç¤ºæ•°æ®

### âœ… æœªç™»å½•çŠ¶æ€æµ‹è¯•
- [x] é¦–æ¬¡æ‰“å¼€ Appï¼Œç›´æ¥æ˜¾ç¤ºç™»å½•é¡µ
- [x] æœªç™»å½•æ—¶ï¼Œ"æ¡£æ¡ˆ"å’Œ"æˆ‘çš„"é¡µé¢ä¸å‘èµ· API è¯·æ±‚
- [x] æœªç™»å½•æ—¶ï¼Œè®¾ç½®é¡µé¢ä¸æ˜¾ç¤º"é€€å‡ºç™»å½•"æŒ‰é’®

### âœ… é€€å‡ºç™»å½•æµ‹è¯•
- [x] ç‚¹å‡»"é€€å‡ºç™»å½•"ï¼Œtoken è¢«æ¸…é™¤
- [x] é€€å‡ºåï¼Œè‡ªåŠ¨è·³è½¬åˆ°ç™»å½•é¡µ

---

## ğŸ“Š æŠ€æœ¯ç»†èŠ‚

### Token å­˜å‚¨æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           AsyncStorage                   â”‚
â”‚  Key: @xiaopei/auth_token                â”‚
â”‚  Value: "eyJhbGciOiJIUzI1NiIsInR..."    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†‘                    â†“
           â”‚                    â”‚
       ä¿å­˜ â”‚                    â”‚ è¯»å–
           â”‚                    â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚tokenStorage  â”‚    â”‚  client.ts   â”‚
    â”‚   .save()    â”‚    â”‚ interceptor  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†‘                    â†“
           â”‚                    â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  authStore   â”‚    â”‚ API Request  â”‚
    â”‚   .login()   â”‚    â”‚ + Auth Headerâ”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### è®¤è¯æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              App å¯åŠ¨                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        initializeAuth()                  â”‚
â”‚  - ä» AsyncStorage è¯»å– token            â”‚
â”‚  - æ›´æ–° authStore.isAuthenticated        â”‚
â”‚  - è®¾ç½® _hasHydrated = true              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         RootNavigator                    â”‚
â”‚  - æ£€æŸ¥ isAuthenticated                  â”‚
â”‚  - true â†’ æ˜¾ç¤ºä¸»é¡µ                       â”‚
â”‚  - false â†’ æ˜¾ç¤ºç™»å½•é¡µ                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         é¡µé¢ç»„ä»¶                         â”‚
â”‚  - æ£€æŸ¥ isAuthenticated                  â”‚
â”‚  - true â†’ å‘èµ· API è¯·æ±‚                  â”‚
â”‚  - false â†’ è·³è¿‡è¯·æ±‚                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ‰ æ€»ç»“

æ‰€æœ‰é—®é¢˜å·²ä¿®å¤ï¼š
1. âœ… Token æ­£ç¡®æŒä¹…åŒ–å’Œæ¢å¤
2. âœ… æœªç™»å½•ç”¨æˆ·ç›´æ¥è¿›å…¥ç™»å½•é¡µï¼ˆä¸æ˜¾ç¤ºé”™è¯¯ï¼‰
3. âœ… æœªç™»å½•çŠ¶æ€ä¸æ˜¾ç¤ºé€€å‡ºæŒ‰é’®
4. âœ… ç”¨æˆ·ä½“éªŒæµç•…ï¼Œæ— ä¸å¿…è¦çš„é”™è¯¯æç¤º

**å…³é”®ç»éªŒ**ï¼š
- ç»Ÿä¸€ Storage Key è‡³å…³é‡è¦
- æ‰€æœ‰ API è¯·æ±‚å‰éƒ½è¦æ£€æŸ¥è®¤è¯çŠ¶æ€
- UI å…ƒç´ è¦æ ¹æ®è®¤è¯çŠ¶æ€æ¡ä»¶æ¸²æŸ“

