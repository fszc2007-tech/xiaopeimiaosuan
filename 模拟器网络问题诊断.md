# 模拟器网络问题诊断

## 问题描述

错误信息：
```
No script URL provided. Make sure the packager is running or you have embedded a JS bundle in your application bundle.
unsanitizedScriptURLString = (null)
```

这是 **Metro Bundler 连接问题**，不是后端 API 连接问题。

---

## 当前网络配置状态

### 1. 电脑当前 IP 地址
```
172.20.10.2
```

### 2. API 配置（硬编码）
- `app/src/config/env.ts`: `http://192.168.3.61:3000`
- `app/src/services/api/apiClient.ts`: `http://192.168.3.61:3000`

**⚠️ 问题**：代码中硬编码的 IP `192.168.3.61` 与当前电脑 IP `172.20.10.2` 不匹配。

### 3. iOS 模拟器网络配置
- `NSAllowsLocalNetworking = true` ✅（已允许本地网络）
- `NSAllowsArbitraryLoads = false` ✅（已禁用任意加载，安全）

---

## 诊断步骤

### 步骤 1：检查 Metro Bundler 是否运行

```bash
# 在 app 目录下运行
cd /Users/gaoxuxu/Desktop/xiaopei-app/app
npm start
# 或
expo start
```

**预期输出**：
- Metro bundler 应该启动在 `http://localhost:8081`
- 显示二维码和连接信息

**如果 Metro bundler 没有运行**：
- 这就是问题根源
- 需要先启动 Metro bundler，然后才能在模拟器中运行 App

### 步骤 2：检查模拟器是否能访问 Metro Bundler

iOS 模拟器应该能直接访问 `localhost:8081`，因为模拟器运行在本地。

**如果无法连接**，可能原因：
1. 防火墙阻止了 8081 端口
2. Metro bundler 绑定到了错误的地址

### 步骤 3：检查后端 API 服务是否运行

```bash
# 检查 Core 服务是否在运行
curl http://localhost:3000/health
# 或
curl http://172.20.10.2:3000/health
```

**如果后端服务没有运行**：
- 需要先启动 Core 服务
- 但这不是导致当前错误的原因（当前错误是 Metro bundler 问题）

---

## 解决方案

### 方案 1：启动 Metro Bundler（最可能的问题）

```bash
cd /Users/gaoxuxu/Desktop/xiaopei-app/app
npm start
```

然后在模拟器中：
1. 摇一摇设备（或按 `Cmd + D`）
2. 选择 "Reload"
3. 或选择 "Configure Bundler" 并输入正确的地址

### 方案 2：使用正确的 IP 地址（如果 Metro bundler 需要）

如果 Metro bundler 需要从模拟器访问，可能需要使用电脑的实际 IP：

```bash
# 获取电脑 IP
ifconfig | grep "inet " | grep -v 127.0.0.1

# 当前 IP: 172.20.10.2
```

然后在 Expo 启动时指定：
```bash
expo start --host tunnel
# 或
expo start --host lan
```

### 方案 3：清除缓存并重启

```bash
cd /Users/gaoxuxu/Desktop/xiaopei-app/app

# 清除 Metro bundler 缓存
npx expo start --clear

# 或清除所有缓存
rm -rf node_modules/.cache
npm start -- --reset-cache
```

### 方案 4：检查防火墙设置

确保防火墙允许：
- 端口 8081（Metro bundler）
- 端口 3000（后端 API，如果需要）

---

## 快速检查清单

- [ ] Metro bundler 是否在运行？（`npm start` 或 `expo start`）
- [ ] 模拟器是否能访问 `localhost:8081`？
- [ ] 后端 API 服务是否在运行？（`http://localhost:3000/health`）
- [ ] 防火墙是否阻止了相关端口？
- [ ] 是否尝试过清除缓存并重启？

---

## 常见问题

### Q: 为什么会出现 "No script URL provided"？

**A**: 这表示 App 无法连接到 Metro bundler 来加载 JavaScript 代码。可能原因：
1. Metro bundler 没有运行
2. 模拟器无法访问 Metro bundler 的地址
3. 网络配置问题

### Q: iOS 模拟器应该使用 localhost 还是实际 IP？

**A**: iOS 模拟器可以直接使用 `localhost`，因为它运行在本地。但如果使用真机测试，需要使用电脑的实际 IP 地址。

### Q: API_BASE_URL 的 IP 不匹配会影响 Metro bundler 吗？

**A**: 不会。API_BASE_URL 是后端 API 的地址，与 Metro bundler 无关。但如果不匹配，App 启动后无法调用后端 API。

---

## 下一步操作建议

1. **立即检查**：运行 `cd app && npm start`，确认 Metro bundler 是否在运行
2. **如果 Metro bundler 在运行**：在模拟器中摇一摇设备，选择 "Reload"
3. **如果仍然失败**：尝试清除缓存并重启
4. **如果问题持续**：检查防火墙和网络设置

---

## 网络配置建议（未来优化）

虽然当前不改代码，但建议未来优化：

1. **使用环境变量**：将 API_BASE_URL 改为从环境变量读取
2. **自动检测 IP**：在开发环境自动检测电脑 IP
3. **支持 localhost**：iOS 模拟器优先使用 localhost

---

**诊断时间**：2024-12-XX  
**当前电脑 IP**：172.20.10.2  
**代码中硬编码 IP**：192.168.3.61



