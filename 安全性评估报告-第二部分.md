# å°ä½© App å®‰å…¨æ€§è¯„ä¼°æŠ¥å‘Š - ç¬¬äºŒéƒ¨åˆ†

## ç›®å½•
1. [æ•°æ®åº“ Schema ä¸è¿ç§»](#æ•°æ®åº“-schema-ä¸è¿ç§»)
2. [React Native App ç«¯ä»£ç ](#react-native-app-ç«¯ä»£ç )
3. [iOS é…ç½®](#ios-é…ç½®)
4. [Android é…ç½®](#android-é…ç½®)
5. [å®‰å…¨é£é™©æ€»ç»“ä¸æ”¹å–„å»ºè®®](#å®‰å…¨é£é™©æ€»ç»“ä¸æ”¹å–„å»ºè®®)

---

## æ•°æ®åº“ Schema ä¸è¿ç§»

### ä¸»è¦æ•°æ®è¡¨ç»“æ„

#### 1. ç”¨æˆ·è¡¨ (`users`)

```1:23:core/src/database/migrations/001_create_tables.sql
-- ===== 1. ç”¨æˆ·è¡¨ =====
CREATE TABLE IF NOT EXISTS users (
  user_id VARCHAR(36) PRIMARY KEY,
  nickname VARCHAR(50),
  phone VARCHAR(20),
  email VARCHAR(100),
  password_hash VARCHAR(255),
  avatar VARCHAR(255),
  app_region ENUM('cn', 'hk') NOT NULL DEFAULT 'cn',
  is_pro BOOLEAN DEFAULT FALSE,
  pro_expire_at DATETIME,
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_phone (phone),
  INDEX idx_email (email),
  INDEX idx_app_region (app_region),
  INDEX idx_is_pro (is_pro)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

**å®‰å…¨è§‚å¯Ÿç‚¹ï¼š**
- âœ… ä½¿ç”¨ UUID ä½œä¸ºä¸»é”®ï¼ˆé¿å…æšä¸¾æ”»å‡»ï¼‰
- âœ… æ‰‹æœºå·å’Œé‚®ç®±æœ‰ç´¢å¼•ï¼ˆæŸ¥è¯¢æ€§èƒ½ï¼‰
- âš ï¸ **`password_hash` å­—æ®µå­˜åœ¨ä½†æœªä½¿ç”¨**ï¼ˆå½“å‰ä½¿ç”¨éªŒè¯ç ç™»å½•ï¼‰
- âš ï¸ **`phone` å’Œ `email` æœªè®¾ç½®å”¯ä¸€çº¦æŸ**ï¼ˆå¯èƒ½é‡å¤æ³¨å†Œï¼‰

#### 2. éªŒè¯ç è¡¨ (`verification_codes`)

```25:38:core/src/database/migrations/001_create_tables.sql
-- ===== 2. éªŒè¯ç è¡¨ =====
CREATE TABLE IF NOT EXISTS verification_codes (
  code_id VARCHAR(36) PRIMARY KEY,
  phone VARCHAR(20),
  email VARCHAR(100),
  code VARCHAR(10) NOT NULL,
  code_type ENUM('login', 'register', 'reset_password') NOT NULL,
  expires_at DATETIME NOT NULL,
  is_used BOOLEAN DEFAULT FALSE,
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  INDEX idx_phone (phone),
  INDEX idx_email (email),
  INDEX idx_expires_at (expires_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

**å®‰å…¨è§‚å¯Ÿç‚¹ï¼š**
- âœ… éªŒè¯ç æœ‰è¿‡æœŸæ—¶é—´
- âœ… æœ‰ `is_used` æ ‡è®°ï¼ˆé˜²æ­¢é‡å¤ä½¿ç”¨ï¼‰
- âš ï¸ **éªŒè¯ç æœªåŠ å¯†å­˜å‚¨**ï¼ˆæ˜æ–‡å­˜å‚¨ï¼Œæ•°æ®åº“æ³„éœ²é£é™©ï¼‰
- âš ï¸ **è¿‡æœŸéªŒè¯ç æœªè‡ªåŠ¨æ¸…ç†**ï¼ˆå¯èƒ½ç§¯ç´¯å¤§é‡æ•°æ®ï¼‰

#### 3. è®¢é˜…è¡¨ (`subscriptions`)

```190:206:core/src/database/migrations/001_create_tables.sql
-- ===== 13. Pro è®¢é˜…è¡¨ =====
CREATE TABLE IF NOT EXISTS subscriptions (
  subscription_id VARCHAR(36) PRIMARY KEY,
  user_id VARCHAR(36) NOT NULL,
  plan ENUM('yearly', 'monthly', 'lifetime') NOT NULL,
  status ENUM('active', 'canceled', 'expired') NOT NULL DEFAULT 'active',
  started_at DATETIME NOT NULL,
  expires_at DATETIME COMMENT 'æ°¸ä¹…ä¼šå‘˜ä¸ºNULL',
  external_order_id VARCHAR(100) COMMENT 'å¤–éƒ¨è®¢å•å·',
  payment_provider ENUM('none', 'apple', 'google', 'stripe') DEFAULT 'none',
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE,
  INDEX idx_user_id (user_id),
  INDEX idx_status (status),
  INDEX idx_expires_at (expires_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

**å®‰å…¨è§‚å¯Ÿç‚¹ï¼š**
- âœ… å¤–é”®çº¦æŸï¼ˆæ•°æ®ä¸€è‡´æ€§ï¼‰
- âœ… ç´¢å¼•ä¼˜åŒ–ï¼ˆæŸ¥è¯¢æ€§èƒ½ï¼‰
- âš ï¸ **`external_order_id` æœªè®¾ç½®å”¯ä¸€çº¦æŸ**ï¼ˆå¯èƒ½é‡å¤ï¼‰

#### 4. Admin ç”¨æˆ·è¡¨ (`admin_users`)

```14:28:core/src/database/migrations/002_phase4_tables.sql
-- ===== 1. Admin ç”¨æˆ·è¡¨ =====

CREATE TABLE IF NOT EXISTS admin_users (
  admin_id VARCHAR(36) PRIMARY KEY,
  username VARCHAR(50) UNIQUE NOT NULL COMMENT 'ç®¡ç†å‘˜ç”¨æˆ·å',
  password_hash VARCHAR(255) NOT NULL COMMENT 'å¯†ç å“ˆå¸Œï¼ˆbcrypt/argon2ï¼‰',
  email VARCHAR(255) COMMENT 'ç®¡ç†å‘˜é‚®ç®±',
  role ENUM('super_admin', 'admin') DEFAULT 'admin' COMMENT 'è§’è‰²ï¼šè¶…çº§ç®¡ç†å‘˜/æ™®é€šç®¡ç†å‘˜',
  is_active BOOLEAN DEFAULT TRUE COMMENT 'æ˜¯å¦æ¿€æ´»',
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  last_login_at DATETIME COMMENT 'æœ€åç™»å½•æ—¶é—´',
  INDEX idx_username (username),
  INDEX idx_email (email),
  INDEX idx_role (role)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='Admin ç”¨æˆ·è¡¨';
```

**å®‰å…¨è§‚å¯Ÿç‚¹ï¼š**
- âœ… å¯†ç ä½¿ç”¨å“ˆå¸Œå­˜å‚¨
- âœ… æœ‰è§’è‰²æƒé™æ§åˆ¶
- âœ… æœ‰ `is_active` æ ‡è®°ï¼ˆå¯ç¦ç”¨è´¦æˆ·ï¼‰
- âœ… è®°å½•æœ€åç™»å½•æ—¶é—´ï¼ˆå®¡è®¡ï¼‰

#### 5. LLM API é…ç½®è¡¨ (`llm_api_configs`)

```166:176:core/src/database/migrations/001_create_tables.sql
-- ===== 11. LLM API é…ç½®è¡¨ =====
CREATE TABLE IF NOT EXISTS llm_api_configs (
  config_id VARCHAR(36) PRIMARY KEY,
  model VARCHAR(50) NOT NULL UNIQUE COMMENT 'æ¨¡å‹åç§°ï¼ˆdeepseek/chatgpt/qwenï¼‰',
  api_key_encrypted TEXT COMMENT 'API Keyï¼ˆåŠ å¯†å­˜å‚¨ï¼‰',
  api_url VARCHAR(255) NOT NULL,
  is_enabled BOOLEAN DEFAULT TRUE,
  thinking_mode BOOLEAN DEFAULT FALSE COMMENT 'DeepSeekä¸“ç”¨ï¼šæ˜¯å¦å¯ç”¨æ€è€ƒæ¨¡å¼',
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

**å®‰å…¨è§‚å¯Ÿç‚¹ï¼š**
- âœ… API Key å­—æ®µåä¸º `api_key_encrypted`ï¼ˆæš—ç¤ºåŠ å¯†ï¼‰
- âš ï¸ **éœ€ç¡®è®¤æ˜¯å¦çœŸæ­£åŠ å¯†å­˜å‚¨**ï¼ˆæŸ¥çœ‹ä»£ç å®ç°ï¼‰

### æ•°æ®åº“è¿æ¥é…ç½®

```1:53:core/src/database/connection.ts
/**
 * æ•°æ®åº“è¿æ¥ç®¡ç†
 */

import mysql from 'mysql2/promise';

let pool: mysql.Pool | null = null;

export async function createConnection(): Promise<mysql.Pool> {
  if (pool) {
    return pool;
  }

  pool = mysql.createPool({
    host: process.env.XIAOPEI_MYSQL_HOST || 'localhost',
    port: parseInt(process.env.XIAOPEI_MYSQL_PORT || '3306'),
    user: process.env.XIAOPEI_MYSQL_USER || 'root',
    password: process.env.XIAOPEI_MYSQL_PASSWORD || '',
    database: process.env.XIAOPEI_MYSQL_DATABASE || 'xiaopei',
    charset: 'utf8mb4',
    waitForConnections: true,
    connectionLimit: 10,
    queueLimit: 0,
  });

  // æµ‹è¯•è¿æ¥
  try {
    const connection = await pool.getConnection();
    console.log('[Database] MySQL connection pool created');
    connection.release();
  } catch (error) {
    console.error('[Database] Failed to create connection pool:', error);
    throw error;
  }

  return pool;
}

export function getPool(): mysql.Pool {
  if (!pool) {
    throw new Error('[Database] Connection pool not initialized. Call createConnection() first.');
  }
  return pool;
}

export async function closeConnection(): Promise<void> {
  if (pool) {
    await pool.end();
    pool = null;
    console.log('[Database] Connection pool closed');
  }
}
```

**å®‰å…¨è§‚å¯Ÿç‚¹ï¼š**
- âœ… ä½¿ç”¨è¿æ¥æ± ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰
- âœ… ä½¿ç”¨ç¯å¢ƒå˜é‡é…ç½®ï¼ˆä¸ç¡¬ç¼–ç ï¼‰
- âš ï¸ **æ•°æ®åº“å¯†ç æœ‰é»˜è®¤ç©ºå€¼**ï¼ˆéœ€ç¡®ä¿ç”Ÿäº§ç¯å¢ƒè®¾ç½®ï¼‰
- âš ï¸ **è¿æ¥æ± å¤§å°å›ºå®šä¸º 10**ï¼ˆé«˜å¹¶å‘å¯èƒ½ä¸å¤Ÿï¼‰

---

## React Native App ç«¯ä»£ç 

### 1. App å…¥å£ (`app/App.tsx`)

```1:73:app/App.tsx
/**
 * å°ä½© App ä¸»å…¥å£
 * 
 * èŒè´£ï¼š
 * 1. åˆå§‹åŒ– i18n
 * 2. æŒ‚è½½å¯¼èˆªå™¨
 * 3. æä¾›å…¨å±€ SafeAreaProvider
 */

import React, { useEffect, useState } from 'react';
import { View, ActivityIndicator } from 'react-native';
import { StatusBar } from 'expo-status-bar';
import { SafeAreaProvider } from 'react-native-safe-area-context';
import { NavigationContainer } from '@react-navigation/native';
import { RootNavigator } from './src/navigation/RootNavigator';
import { initializeAuth } from './src/utils/initializeAuth';
import './src/i18n'; // åˆå§‹åŒ– i18n

export default function App() {
  const [isInitialized, setIsInitialized] = useState(false);

  useEffect(() => {
    async function prepare() {
      try {
        console.log('[App] ==================== App å¯åŠ¨ ====================');
        
        // ğŸ”¥ğŸ”¥ğŸ”¥ ä¸´æ—¶ï¼šå¼ºåˆ¶æ¸…é™¤é—®é¢˜æ•°æ®ï¼ˆåªæ‰§è¡Œä¸€æ¬¡ï¼‰
        const AsyncStorage = (await import('@react-native-async-storage/async-storage')).default;
        const clearFlag = await AsyncStorage.getItem('__xiaopei_v4_cleared__');
        if (clearFlag !== 'true') {
          console.log('[App] ğŸ”¥ é¦–æ¬¡è¿è¡Œ v4ï¼Œæ¸…é™¤æ‰€æœ‰æ—§æ•°æ®...');
          await AsyncStorage.removeItem('xiaopei-auth-storage');
          await AsyncStorage.setItem('__xiaopei_v4_cleared__', 'true');
          console.log('[App] âœ… æ—§æ•°æ®å·²æ¸…é™¤');
        }
        
        // 1. åˆå§‹åŒ–è®¤è¯ï¼ˆä» AsyncStorage æ¢å¤ Tokenï¼‰
        await initializeAuth();
        
        console.log('[App] ==================== åˆå§‹åŒ–å®Œæˆ ====================');
        setIsInitialized(true);
      } catch (error) {
        console.error('[App] åˆå§‹åŒ–å¤±è´¥:', error);
        setIsInitialized(true); // å³ä½¿å¤±è´¥ä¹Ÿè¦ç»§ç»­
      }
    }

    prepare();
  }, []);

  // ç­‰å¾…è®¤è¯åˆå§‹åŒ–å®Œæˆ
  if (!isInitialized) {
    return (
      <SafeAreaProvider>
        <View style={{ flex: 1, justifyContent: 'center', alignItems: 'center', backgroundColor: '#f5f7fa' }}>
          <ActivityIndicator size="large" color="#667eea" />
        </View>
      </SafeAreaProvider>
    );
  }

  return (
    <SafeAreaProvider>
      <NavigationContainer>
        <View testID="app-root" style={{ flex: 1 }}>
        <RootNavigator />
        </View>
      </NavigationContainer>
      <StatusBar style="auto" />
    </SafeAreaProvider>
  );
}
```

**å®‰å…¨è§‚å¯Ÿç‚¹ï¼š**
- âœ… è®¤è¯çŠ¶æ€åœ¨å¯åŠ¨æ—¶æ¢å¤
- âš ï¸ **æ§åˆ¶å°æ—¥å¿—å¯èƒ½æ³„éœ²æ•æ„Ÿä¿¡æ¯**ï¼ˆç”Ÿäº§ç¯å¢ƒåº”ç¦ç”¨ï¼‰

### 2. API å®¢æˆ·ç«¯ (`app/src/services/api/apiClient.ts`)

```1:230:app/src/services/api/apiClient.ts
/**
 * API Client ç»Ÿä¸€é…ç½®
 * 
 * åŠŸèƒ½ï¼š
 * - è‡ªåŠ¨æ·»åŠ  Authorizationã€X-App-Regionã€X-Request-ID ç­‰ header
 * - ç»Ÿä¸€é”™è¯¯å¤„ç†ï¼ˆ401 è·³ç™»å½•ã€403 æç¤ºå‡çº§ Proã€429 é™æµç­‰ï¼‰
 * - ç»Ÿä¸€å“åº”æ ¼å¼å¤„ç†
 */

import axios, { AxiosError, AxiosRequestConfig, AxiosResponse } from 'axios';
import { ENV } from '@/config/env';
import { useAuthStore } from '@/store';
import { generateRequestId } from '@/utils/requestId';

// ===== å“åº”ç±»å‹å®šä¹‰ =====
export interface ApiResponse<T> {
  success: true;
  data: T;
}

export interface ErrorResponse {
  success: false;
  error: {
    code: string;
    message: string;
    details?: any;
  };
}

// ===== åˆ›å»º axios å®ä¾‹ =====
// å¼ºåˆ¶ä½¿ç”¨æ­£ç¡®çš„ IPï¼ˆé¿å…ç¼“å­˜é—®é¢˜ï¼‰
// å½“å‰æ£€æµ‹åˆ°çš„IP: 192.168.3.61ï¼ˆå¦‚æœIPå˜åŒ–ï¼Œè¯·æ›´æ–°ç¯å¢ƒå˜é‡ EXPO_PUBLIC_API_BASE_URLï¼‰
const API_BASE_URL = process.env.EXPO_PUBLIC_API_BASE_URL || process.env.EXPO_PUBLIC_API_URL || 'http://192.168.3.61:3000';

// å¯åŠ¨æ—¶æ‰“å°ï¼ˆç”¨äºè°ƒè¯•ï¼‰
if (__DEV__) {
  console.log('[apiClient] ğŸ”— åˆ›å»º axios å®ä¾‹ï¼ŒbaseURL:', API_BASE_URL);
  console.log('[apiClient] ğŸ“ ENV.API_BASE_URL:', ENV.API_BASE_URL);
  console.log('[apiClient] ğŸ“ process.env.EXPO_PUBLIC_API_BASE_URL:', process.env.EXPO_PUBLIC_API_BASE_URL || 'æœªè®¾ç½®');
}

export const apiClient = axios.create({
  baseURL: API_BASE_URL, // ç›´æ¥ä½¿ç”¨ï¼Œä¸ä¾èµ– ENVï¼ˆé¿å…æ¨¡å—åŠ è½½é¡ºåºé—®é¢˜ï¼‰
  timeout: ENV.API_TIMEOUT,
  headers: {
    'Content-Type': 'application/json',
  },
});

// ===== è¯·æ±‚æ‹¦æˆªå™¨ =====
apiClient.interceptors.request.use(
  (config) => {
    // 1. è‡ªåŠ¨æ·»åŠ  Authorizationï¼ˆä»…åœ¨æœ‰ token æ—¶ï¼‰
    const { token, isAuthenticated } = useAuthStore.getState();
    
    if (token) {
      // æœ‰ tokenï¼šæ­£å¸¸æ·»åŠ 
      config.headers.Authorization = `Bearer ${token}`;
      console.log('[API Client] âœ… Token å·²æ·»åŠ åˆ°è¯·æ±‚å¤´');
    } else {
      // æ²¡æœ‰ tokenï¼šåˆ¤æ–­æ˜¯å¦åº”è¯¥æœ‰
      if (isAuthenticated) {
        // ğŸ”¥ å·²ç™»å½•ä½†è¯»ä¸åˆ° token = çœŸæ­£çš„å¼‚å¸¸
        console.error('[API Client] âŒ å·²ç™»å½•ä½†æœªè¯»åˆ° Tokenï¼', {
          url: config.url,
          method: config.method,
          isAuthenticated,
        });
      } else {
        // âœ… æœªç™»å½•é˜¶æ®µçš„è¯·æ±‚ï¼ˆç™»å½•ã€æ³¨å†Œã€éªŒè¯ç ç­‰ï¼‰= æ­£å¸¸
        console.log('[API Client] ğŸ“ æœªç™»å½•çŠ¶æ€è¯·æ±‚:', config.url);
      }
    }
    
    // 2. è‡ªåŠ¨æ·»åŠ  X-App-Region
    const appRegion = useAuthStore.getState().appRegion;
    if (appRegion) {
      config.headers['X-App-Region'] = appRegion;
    }
    
    // 3. è‡ªåŠ¨æ·»åŠ  X-Request-ID
    config.headers['X-Request-ID'] = generateRequestId();
    
    // 4. æ—¥å¿—ï¼ˆä»…å¼€å‘ç¯å¢ƒï¼‰
    if (ENV.ENABLE_LOG) {
      const fullUrl = config.baseURL + config.url;
      console.log('[API Request]', config.method?.toUpperCase(), fullUrl, {
        hasToken: !!token,
        hasAuthHeader: !!config.headers.Authorization,
        data: config.data,
      });
    }
    
    return config;
  },
  (error) => {
    console.error('[API Request Error]', error);
    return Promise.reject(error);
  }
);

// ===== å“åº”æ‹¦æˆªå™¨ =====
apiClient.interceptors.response.use(
  (response: AxiosResponse<ApiResponse<any>>) => {
    // æ—¥å¿—ï¼ˆä»…å¼€å‘ç¯å¢ƒï¼‰
    if (ENV.ENABLE_LOG) {
      console.log('[API Response]', response.config.url, response.data);
    }
    
    // ç»Ÿä¸€å¤„ç†æˆåŠŸå“åº”
    if (response.data.success) {
      return response;
    }
    
    // å¦‚æœ success: falseï¼Œè§†ä¸ºä¸šåŠ¡é”™è¯¯
    return Promise.reject(response.data.error);
  },
  async (error: AxiosError<ErrorResponse>) => {
    // è¯¦ç»†é”™è¯¯æ—¥å¿—
    const errorInfo = {
      message: error.message,
      code: error.code,
      url: error.config?.url || error.response?.config?.url,
      baseURL: error.config?.baseURL || error.response?.config?.baseURL,
      method: error.config?.method || error.response?.config?.method,
      status: error.response?.status,
      statusText: error.response?.statusText,
      data: error.response?.data,
      isNetworkError: !error.response, // ç½‘ç»œé”™è¯¯ï¼ˆæ— å“åº”ï¼‰
    };
    
    console.error('[API Response Error]', errorInfo);
    
    // å¦‚æœæ˜¯ç½‘ç»œé”™è¯¯ï¼Œæä¾›æ›´è¯¦ç»†çš„è¯Šæ–­ä¿¡æ¯
    if (!error.response) {
      console.error('[API Network Error] ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ï¼š');
      console.error('  1. API Base URL:', error.config?.baseURL || ENV.API_BASE_URL);
      console.error('  2. è¯·æ±‚ URL:', error.config?.url);
      console.error('  3. å®Œæ•´ URL:', `${error.config?.baseURL || ENV.API_BASE_URL}${error.config?.url || ''}`);
      console.error('  4. é”™è¯¯ä»£ç :', error.code);
      console.error('  5. é”™è¯¯æ¶ˆæ¯:', error.message);
    }
    
    // ç»Ÿä¸€é”™è¯¯å¤„ç†
    await handleApiError(error);
    
    return Promise.reject(error);
  }
);

// ===== ç»Ÿä¸€é”™è¯¯å¤„ç†å‡½æ•° =====
async function handleApiError(error: AxiosError<ErrorResponse>) {
  const { response } = error;
  
  // 1. ç½‘ç»œé”™è¯¯ï¼ˆæ— å“åº”ï¼‰
  if (!response) {
    showToast('ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ‚¨çš„ç½‘ç»œè®¾ç½®', 'error');
    return;
  }
  
  const { status, data } = response;
  
  // 2. 401 æœªæˆæƒ â†’ è·³è½¬ç™»å½•
  if (status === 401) {
    showToast('ç™»å…¥å·²éæœŸï¼Œè«‹é‡æ–°ç™»å…¥', 'warning');
    useAuthStore.getState().logout();
    // TODO: å¯¼èˆªåˆ°ç™»å½•é¡µ
    return;
  }
  
  // 3. 403 æƒé™ä¸è¶³ â†’ æç¤ºå‡çº§ Pro
  if (status === 403 && data?.error?.code === 'PRO_REQUIRED') {
    showToast('æ­¤åŠŸèƒ½éœ€è¦å‡ç´š Pro æ‰èƒ½ä½¿ç”¨', 'warning');
    return;
  }
  
  // 4. 429 é¢‘ç‡é™åˆ¶
  if (status === 429 || data?.error?.code === 'RATE_LIMIT_EXCEEDED') {
    const message = data?.error?.message || 'æ“ä½œéæ–¼é »ç¹ï¼Œè«‹ç¨å¾Œå†è©¦';
    showToast(message, 'warning');
    return;
  }
  
  // 5. 422 éªŒè¯é”™è¯¯
  if (status === 422) {
    const message = data?.error?.message || 'è¼¸å…¥æ•¸æ“šæœ‰èª¤ï¼Œè«‹æª¢æŸ¥';
    showToast(message, 'error');
    return;
  }
  
  // 6. 500 æœåŠ¡å™¨é”™è¯¯
  if (status >= 500) {
    showToast('ä¼ºæœå™¨é–‹å°å·®äº†ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
    return;
  }
  
  // 7. å…¶ä»–é”™è¯¯
  const message = data?.error?.message || 'è«‹æ±‚å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦';
  showToast(message, 'error');
}

// ===== Toast æ˜¾ç¤ºå‡½æ•°ï¼ˆä¸´æ—¶å®ç°ï¼‰=====
function showToast(message: string, type: 'success' | 'error' | 'warning' | 'info') {
  // TODO: é›†æˆ Toast ç»„ä»¶
  console.log(`[Toast ${type.toUpperCase()}]`, message);
  // Alert.alert(type.toUpperCase(), message);
}

// ===== å¯¼å‡ºç±»å‹åŒ–çš„è¯·æ±‚æ–¹æ³• =====
export async function get<T>(url: string, config?: AxiosRequestConfig): Promise<T> {
  const response = await apiClient.get<ApiResponse<T>>(url, config);
  return response.data.data;
}

export async function post<T>(url: string, data?: any, config?: AxiosRequestConfig): Promise<T> {
  const response = await apiClient.post<ApiResponse<T>>(url, data, config);
  return response.data.data;
}

export async function put<T>(url: string, data?: any, config?: AxiosRequestConfig): Promise<T> {
  const response = await apiClient.put<ApiResponse<T>>(url, data, config);
  return response.data.data;
}

export async function del<T>(url: string, config?: AxiosRequestConfig): Promise<T> {
  const response = await apiClient.delete<ApiResponse<T>>(url, config);
  return response.data.data;
}
```

**å®‰å…¨è§‚å¯Ÿç‚¹ï¼š**
- âœ… è‡ªåŠ¨æ·»åŠ  Authorization header
- âœ… ç»Ÿä¸€é”™è¯¯å¤„ç†
- âš ï¸ **API Base URL ç¡¬ç¼–ç  IP**ï¼ˆåº”ä½¿ç”¨ç¯å¢ƒå˜é‡æˆ–é…ç½®æœåŠ¡ï¼‰
- âš ï¸ **å¼€å‘ç¯å¢ƒæ—¥å¿—å¯èƒ½æ³„éœ² Token**ï¼ˆç”Ÿäº§ç¯å¢ƒéœ€ç¦ç”¨ï¼‰
- âš ï¸ **Token åœ¨æ—¥å¿—ä¸­æ‰“å°**ï¼ˆå³ä½¿åªæ˜¯é¢„è§ˆï¼Œä¹Ÿåº”é¿å…ï¼‰

### 3. Token å­˜å‚¨ (`app/src/utils/tokenStorage.ts`)

```1:96:app/src/utils/tokenStorage.ts
/**
 * Token å­˜å‚¨ç®¡ç†
 * 
 * ä½¿ç”¨ç‹¬ç«‹çš„ AsyncStorage ç®¡ç†ï¼Œå®Œå…¨ç»•è¿‡ Zustand persist çš„æ½œåœ¨é—®é¢˜
 * 
 * èŒè´£ï¼š
 * - ä¿å­˜ Token åˆ° AsyncStorage
 * - æ¢å¤ Token ä» AsyncStorage
 * - æ¸…é™¤ Token
 * - è¯¦ç»†æ—¥å¿—è¿½è¸ª
 */

import AsyncStorage from '@react-native-async-storage/async-storage';

// âœ… ä½¿ç”¨ä¸ client.ts ä¸€è‡´çš„ key
const TOKEN_STORAGE_KEY = '@xiaopei/auth_token';

export const tokenStorage = {
  /**
   * ä¿å­˜ Token
   */
  async save(token: string): Promise<void> {
    try {
      console.log('[TokenStorage] å¼€å§‹ä¿å­˜ Token:', {
        tokenLength: token.length,
        tokenPreview: token.substring(0, 30) + '...',
      });
      
      await AsyncStorage.setItem(TOKEN_STORAGE_KEY, token);
      
      // ç«‹å³éªŒè¯ä¿å­˜ç»“æœ
      const saved = await AsyncStorage.getItem(TOKEN_STORAGE_KEY);
      if (saved === token) {
        console.log('[TokenStorage] âœ… Token ä¿å­˜æˆåŠŸå¹¶éªŒè¯é€šè¿‡');
      } else {
        console.error('[TokenStorage] âŒ Token ä¿å­˜åéªŒè¯å¤±è´¥ï¼');
      }
    } catch (error) {
      console.error('[TokenStorage] âŒ ä¿å­˜ Token å¤±è´¥:', error);
      throw error;
    }
  },

  /**
   * è¯»å– Token
   */
  async load(): Promise<string | null> {
    try {
      console.log('[TokenStorage] å¼€å§‹è¯»å– Token...');
      
      const token = await AsyncStorage.getItem(TOKEN_STORAGE_KEY);
      
      if (token) {
        console.log('[TokenStorage] âœ… Token è¯»å–æˆåŠŸ:', {
          tokenLength: token.length,
          tokenPreview: token.substring(0, 30) + '...',
        });
      } else {
        console.log('[TokenStorage] âš ï¸ Token ä¸å­˜åœ¨');
      }
      
      return token;
    } catch (error) {
      console.error('[TokenStorage] âŒ è¯»å– Token å¤±è´¥:', error);
      return null;
    }
  },

  /**
   * æ¸…é™¤ Token
   */
  async clear(): Promise<void> {
    try {
      console.log('[TokenStorage] å¼€å§‹æ¸…é™¤ Token...');
      await AsyncStorage.removeItem(TOKEN_STORAGE_KEY);
      console.log('[TokenStorage] âœ… Token å·²æ¸…é™¤');
    } catch (error) {
      console.error('[TokenStorage] âŒ æ¸…é™¤ Token å¤±è´¥:', error);
      throw error;
    }
  },

  /**
   * æ£€æŸ¥ Token æ˜¯å¦å­˜åœ¨
   */
  async exists(): Promise<boolean> {
    try {
      const token = await AsyncStorage.getItem(TOKEN_STORAGE_KEY);
      return token !== null;
    } catch (error) {
      console.error('[TokenStorage] âŒ æ£€æŸ¥ Token å¤±è´¥:', error);
      return false;
    }
  },
};
```

**å®‰å…¨è§‚å¯Ÿç‚¹ï¼š**
- âœ… ä½¿ç”¨ AsyncStorageï¼ˆReact Native æ ‡å‡†å­˜å‚¨ï¼‰
- âš ï¸ **Token æ˜æ–‡å­˜å‚¨**ï¼ˆæœªåŠ å¯†ï¼Œè®¾å¤‡ root/jailbreak å¯è¯»å–ï¼‰
- âš ï¸ **æ—¥å¿—æ‰“å° Token é¢„è§ˆ**ï¼ˆå³ä½¿éƒ¨åˆ†ï¼Œä¹Ÿåº”é¿å…ï¼‰

### 4. æœ¬åœ°å­˜å‚¨æœåŠ¡ (`app/src/services/storage/StorageService.ts`)

```1:78:app/src/services/storage/StorageService.ts
/**
 * æœ¬åœ°å­˜å‚¨æœåŠ¡
 * 
 * å°è£… AsyncStorageï¼Œæä¾›ç±»å‹å®‰å…¨çš„å­˜å‚¨æ¥å£
 */

import AsyncStorage from '@react-native-async-storage/async-storage';

class StorageService {
  /**
   * å­˜å‚¨æ•°æ®
   */
  async set(key: string, value: any): Promise<void> {
    try {
      const stringValue = JSON.stringify(value);
      await AsyncStorage.setItem(key, stringValue);
    } catch (error) {
      console.error(`[Storage] Failed to set ${key}:`, error);
      throw error;
    }
  }

  /**
   * è·å–æ•°æ®
   */
  async get<T = any>(key: string): Promise<T | null> {
    try {
      const stringValue = await AsyncStorage.getItem(key);
      if (stringValue === null) {
        return null;
      }
      return JSON.parse(stringValue) as T;
    } catch (error) {
      console.error(`[Storage] Failed to get ${key}:`, error);
      return null;
    }
  }

  /**
   * åˆ é™¤æ•°æ®
   */
  async remove(key: string): Promise<void> {
    try {
      await AsyncStorage.removeItem(key);
    } catch (error) {
      console.error(`[Storage] Failed to remove ${key}:`, error);
      throw error;
    }
  }

  /**
   * æ¸…ç©ºæ‰€æœ‰æ•°æ®
   */
  async clear(): Promise<void> {
    try {
      await AsyncStorage.clear();
    } catch (error) {
      console.error('[Storage] Failed to clear:', error);
      throw error;
    }
  }

  /**
   * è·å–æ‰€æœ‰ keys
   */
  async getAllKeys(): Promise<string[]> {
    try {
      return await AsyncStorage.getAllKeys();
    } catch (error) {
      console.error('[Storage] Failed to get all keys:', error);
      return [];
    }
  }
}

export const storage = new StorageService();
export default storage;
```

**å®‰å…¨è§‚å¯Ÿç‚¹ï¼š**
- âœ… ç±»å‹å®‰å…¨çš„å­˜å‚¨æ¥å£
- âš ï¸ **æ‰€æœ‰æ•°æ®æ˜æ–‡å­˜å‚¨**ï¼ˆæ•æ„Ÿæ•°æ®åº”åŠ å¯†ï¼‰

---

## iOS é…ç½®

### 1. Info.plist

```1:76:app/ios/app/Info.plist
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
  <dict>
    <key>CADisableMinimumFrameDurationOnPhone</key>
    <true/>
    <key>CFBundleDevelopmentRegion</key>
    <string>$(DEVELOPMENT_LANGUAGE)</string>
    <key>CFBundleDisplayName</key>
    <string>å°ä½©å‘½ç†</string>
    <key>CFBundleExecutable</key>
    <string>$(EXECUTABLE_NAME)</string>
    <key>CFBundleIdentifier</key>
    <string>$(PRODUCT_BUNDLE_IDENTIFIER)</string>
    <key>CFBundleInfoDictionaryVersion</key>
    <string>6.0</string>
    <key>CFBundleName</key>
    <string>$(PRODUCT_NAME)</string>
    <key>CFBundlePackageType</key>
    <string>$(PRODUCT_BUNDLE_PACKAGE_TYPE)</string>
    <key>CFBundleShortVersionString</key>
    <string>1.0.1</string>
    <key>CFBundleSignature</key>
    <string>????</string>
    <key>CFBundleURLTypes</key>
    <array>
      <dict>
        <key>CFBundleURLSchemes</key>
        <array>
          <string>com.xiaopei.app</string>
        </array>
      </dict>
    </array>
    <key>CFBundleVersion</key>
    <string>1</string>
    <key>LSMinimumSystemVersion</key>
    <string>12.0</string>
    <key>LSRequiresIPhoneOS</key>
    <true/>
    <key>NSAppTransportSecurity</key>
    <dict>
      <key>NSAllowsArbitraryLoads</key>
      <false/>
      <key>NSAllowsLocalNetworking</key>
      <true/>
    </dict>
    <key>RCTNewArchEnabled</key>
    <true/>
    <key>UILaunchStoryboardName</key>
    <string>SplashScreen</string>
    <key>UIRequiredDeviceCapabilities</key>
    <array>
      <string>arm64</string>
    </array>
    <key>UIRequiresFullScreen</key>
    <false/>
    <key>UIStatusBarStyle</key>
    <string>UIStatusBarStyleDefault</string>
    <key>UISupportedInterfaceOrientations</key>
    <array>
      <string>UIInterfaceOrientationPortrait</string>
      <string>UIInterfaceOrientationPortraitUpsideDown</string>
    </array>
    <key>UISupportedInterfaceOrientations~ipad</key>
    <array>
      <string>UIInterfaceOrientationPortrait</string>
      <string>UIInterfaceOrientationPortraitUpsideDown</string>
      <string>UIInterfaceOrientationLandscapeLeft</string>
      <string>UIInterfaceOrientationLandscapeRight</string>
    </array>
    <key>UIUserInterfaceStyle</key>
    <string>Light</string>
    <key>UIViewControllerBasedStatusBarAppearance</key>
    <false/>
  </dict>
</plist>
```

**å®‰å…¨è§‚å¯Ÿç‚¹ï¼š**
- âœ… `NSAllowsArbitraryLoads = false`ï¼ˆå¼ºåˆ¶ HTTPSï¼‰
- âœ… `NSAllowsLocalNetworking = true`ï¼ˆå…è®¸æœ¬åœ°ç½‘ç»œï¼Œå¼€å‘éœ€è¦ï¼‰
- âš ï¸ **ç”Ÿäº§ç¯å¢ƒåº”ç§»é™¤ `NSAllowsLocalNetworking`**ï¼ˆé™¤éæœ‰ç‰¹æ®Šéœ€æ±‚ï¼‰

### 2. Entitlements (`app/ios/app/app.entitlements`)

```1:5:app/ios/app/app.entitlements
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
  <dict/>
</plist>
```

**å®‰å…¨è§‚å¯Ÿç‚¹ï¼š**
- âœ… å½“å‰æ— ç‰¹æ®Šæƒé™ï¼ˆæœ€å°æƒé™åŸåˆ™ï¼‰
- âš ï¸ **å¦‚éœ€ Keychain è®¿é—®ï¼Œåº”æ·»åŠ ç›¸åº”é…ç½®**

---

## Android é…ç½®

### 1. build.gradle

```1:183:app/android/app/build.gradle
apply plugin: "com.android.application"
apply plugin: "org.jetbrains.kotlin.android"
apply plugin: "com.facebook.react"

def projectRoot = rootDir.getAbsoluteFile().getParentFile().getAbsolutePath()

/**
 * This is the configuration block to customize your React Native Android app.
 * By default you don't need to apply any configuration, just uncomment the lines you need.
 */
react {
    entryFile = file(["node", "-e", "require('expo/scripts/resolveAppEntry')", projectRoot, "android", "absolute"].execute(null, rootDir).text.trim())
    reactNativeDir = new File(["node", "--print", "require.resolve('react-native/package.json')"].execute(null, rootDir).text.trim()).getParentFile().getAbsoluteFile()
    hermesCommand = new File(["node", "--print", "require.resolve('react-native/package.json')"].execute(null, rootDir).text.trim()).getParentFile().getAbsolutePath() + "/sdks/hermesc/%OS-BIN%/hermesc"
    codegenDir = new File(["node", "--print", "require.resolve('@react-native/codegen/package.json', { paths: [require.resolve('react-native/package.json')] })"].execute(null, rootDir).text.trim()).getParentFile().getAbsoluteFile()

    enableBundleCompression = (findProperty('android.enableBundleCompression') ?: false).toBoolean()
    // Use Expo CLI to bundle the app, this ensures the Metro config
    // works correctly with Expo projects.
    cliFile = new File(["node", "--print", "require.resolve('@expo/cli', { paths: [require.resolve('expo/package.json')] })"].execute(null, rootDir).text.trim())
    bundleCommand = "export:embed"

    /* Folders */
     //   The root of your project, i.e. where "package.json" lives. Default is '../..'
    // root = file("../../")
    //   The folder where the react-native NPM package is. Default is ../../node_modules/react-native
    // reactNativeDir = file("../../node_modules/react-native")
    //   The folder where the react-native Codegen package is. Default is ../../node_modules/@react-native/codegen
    // codegenDir = file("../../node_modules/@react-native/codegen")

    /* Variants */
    //   The list of variants to that are debuggable. For those we're going to
    //   skip the bundling of the JS bundle and the assets. By default is just 'debug'.
    //   If you add flavors like lite, prod, etc. you'll have to list your debuggableVariants.
    // debuggableVariants = ["liteDebug", "prodDebug"]

    /* Bundling */
    //   A list containing the node command and its flags. Default is just 'node'.
    // nodeExecutableAndArgs = ["node"]
    //
    //   The path to the CLI configuration file. Default is empty.
    // bundleConfig = file(../rn-cli.config.js)
    //
    //   The name of the generated asset file containing your JS bundle
    // bundleAssetName = "MyApplication.android.bundle"
    //
    //   The entry file for bundle generation. Default is 'index.android.js' or 'index.js'
    // entryFile = file("../js/Application.android.js")
    //
    //   The list of extra flags to pass to the 'bundle' commands.
    //   See https://github.com/react-native-community/cli/blob/main/docs/commands.md#bundle
    // extraPackagerArgs = []

    /* Hermes Commands */
    //   The hermes compiler command to run. By default it is 'hermesc'
    // hermesCommand = "$rootDir/my-custom-hermesc/bin/hermesc"
    //
    //   //   The list of flags to pass to the Hermes compiler. By default is "-O", "-output-source-map"
    // hermesFlags = ["-O", "-output-source-map"]

    /* Autolinking */
    autolinkLibrariesWithApp()
}

/**
 * Set this to true in release builds to optimize the app using [R8](https://developer.android.com/topic/performance/app-optimization/enable-app-optimization).
 */
def enableMinifyInReleaseBuilds = (findProperty('android.enableMinifyInReleaseBuilds') ?: false).toBoolean()

/**
 * The preferred build flavor of JavaScriptCore (JSC)
 *
 * For example, to use the international variant, you can use:
 * `def jscFlavor = 'org.webkit:android-jsc-intl:+'`
 *
 * The international variant includes ICU i18n library and necessary data
 * allowing to use e.g. `Date.toLocaleString` and `String.localeCompare` that
 * give correct results when using with locales other than en-US. Note that
 * this variant is about 6MiB larger per architecture than default.
 */
def jscFlavor = 'io.github.react-native-community:jsc-android:2026004.+'

android {
    ndkVersion rootProject.ext.ndkVersion

    buildToolsVersion rootProject.ext.buildToolsVersion
    compileSdk rootProject.ext.compileSdkVersion

    namespace 'com.xiaopei.app'
    defaultConfig {
        applicationId 'com.xiaopei.app'
        minSdkVersion rootProject.ext.minSdkVersion
        targetSdkVersion rootProject.ext.targetSdkVersion
        versionCode 1
        versionName "1.0.0"

        buildConfigField "String", "REACT_NATIVE_RELEASE_LEVEL", "\"${findProperty('reactNativeReleaseLevel') ?: 'stable'}\""
    }
    signingConfigs {
        debug {
            storeFile file('debug.keystore')
            storePassword 'android'
            keyAlias 'androiddebugkey'
            keyPassword 'android'
        }
    }
    buildTypes {
        debug {
            signingConfig signingConfigs.debug
        }
        release {
            // Caution! In production, you need to generate your own keystore file.
            // see https://reactnative.dev/docs/signed-apk-android.
            signingConfig signingConfigs.debug
            def enableShrinkResources = findProperty('android.enableShrinkResourcesInReleaseBuilds') ?: 'false'
            shrinkResources enableShrinkResources.toBoolean()
            minifyEnabled enableMinifyInReleaseBuilds
            proguardFiles getDefaultProguardFile("proguard-android.txt"), "proguard-rules.pro"
            def enablePngCrunchInRelease = findProperty('android.enablePngCrunchInReleaseBuilds') ?: 'true'
            crunchPngs enablePngCrunchInRelease.toBoolean()
        }
    }
    packagingOptions {
        jniLibs {
            def enableLegacyPackaging = useLegacyPackaging.toBoolean()
            useLegacyPackaging enableLegacyPackaging.toBoolean()
        }
    }
    androidResources {
        ignoreAssetsPattern '!.svn:!.git:!.ds_store:!*.scc:!CVS:!thumbs.db:!picasa.ini:!*~'
    }
}

// Apply static values from `gradle.properties` to the `android.packagingOptions`
// Accepts values in comma delimited lists, example:
// android.packagingOptions.pickFirsts=/LICENSE,**/picasa.ini
["pickFirsts", "excludes", "merges", "doNotStrip"].each { prop ->
    // Split option: 'foo,bar' -> ['foo', 'bar']
    def options = (findProperty("android.packagingOptions.$prop") ?: "").split(",");
    // Trim all elements in place.
    for (i in 0..<options.size()) rootProject.ext.ndkVersion

    buildToolsVersion rootProject.ext.buildToolsVersion
    compileSdk rootProject.ext.compileSdkVersion

    namespace 'com.xiaopei.app'
    defaultConfig {
        applicationId 'com.xiaopei.app'
        minSdkVersion rootProject.ext.minSdkVersion
        targetSdkVersion rootProject.ext.targetSdkVersion
        versionCode 1
        versionName "1.0.0"

        buildConfigField "String", "REACT_NATIVE_RELEASE_LEVEL", "\"${findProperty('reactNativeReleaseLevel') ?: 'stable'}\""
    }
    signingConfigs {
        debug {
            storeFile file('debug.keystore')
            storePassword 'android'
            keyAlias 'androiddebugkey'
            keyPassword 'android'
        }
    }
    buildTypes {
        debug {
            signingConfig signingConfigs.debug
        }
        release {
            // Caution! In production, you need to generate your own keystore file.
            // see https://reactnative.dev/docs/signed-apk-android.
            signingConfig signingConfigs.debug
            def enableShrinkResources = findProperty('android.enableShrinkResourcesInReleaseBuilds') ?: 'false'
            shrinkResources enableShrinkResources.toBoolean()
            minifyEnabled enableMinifyInReleaseBuilds
            proguardFiles getDefaultProguardFile("proguard-android.txt"), "proguard-rules.pro"
            def enablePngCrunchInRelease = findProperty('android.enablePngCrunchInReleaseBuilds') ?: 'true'
            crunchPngs enablePngCrunchInRelease.toBoolean()
        }
    }
    packagingOptions {
        jniLibs {
            def enableLegacyPackaging = (findProperty('expo.useLegacyPackaging') ?: 'false').toBoolean()
            useLegacyPackaging enableLegacyPackaging.toBoolean()
        }
    }
    androidResources {
        ignoreAssetsPattern '!.svn:!.git:!.ds_store:!*.scc:!CVS:!thumbs.db:!picasa.ini:!*~'
    }
}

// Apply static values from `gradle.properties` to the `android.packagingOptions`
// Accepts values in comma delimited lists, example:
// android.packagingOptions.pickFirsts=/LICENSE,**/picasa.ini
["pickFirsts", "excludes", "merges", "doNotStrip"].each { prop ->
    // Split option: 'foo,bar' -> ['foo', 'bar']
    def options = (findProperty("android.packagingOptions.$prop") ?: "").split(",");
    // Trim all elements in place.
    for (i in 0..<options.size()) options[i] = options[i].trim();
    // `[] - ""` is essentially `[""].filter(Boolean)` removing all empty strings.
    options -= ""

    if (options.length > 0) {
        println "android.packagingOptions.$prop += $options ($options.length)"
        // Ex: android.packagingOptions.pickFirsts += '**/SCCS/**'
        options.each {
            android.packagingOptions[prop] += it
        }
    }
}

dependencies {
    // The version of react-native is set by the React Native Gradle Plugin
    implementation("com.facebook.react:react-android")

    def isGifEnabled = (findProperty('expo.gif.enabled') ?: "") == "true";
    def isWebpEnabled = (findProperty('expo.webp.enabled') ?: "") == "true";
    def isWebpAnimatedEnabled = (findProperty('expo.webp.animated') ?: "") == "true";

    if (isGifEnabled) {
        // For animated gif support
        implementation("com.facebook.fresco:animated-gif:${expoLibs.versions.fresco.get()}")
    }

    if (isWebpEnabled) {
        // For webp support
        implementation("com.facebook.fresco:webpsupport:${expoLibs.versions.fresco.get()}")
        if (isWebpAnimatedEnabled) {
            // Animated webp support
            implementation("com.facebook.fresco:animated-webp:${expoLibs.versions.fresco.get()}")
        }
    }

    if (hermesEnabled.toBoolean()) {
        implementation("com.facebook.react:hermes-android")
    } else {
        implementation jscFlavor
    }
}
```

**å®‰å…¨è§‚å¯Ÿç‚¹ï¼š**
- ğŸ”´ **Release æ„å»ºä½¿ç”¨ debug keystore**ï¼ˆç¬¬ 115 è¡Œï¼Œç”Ÿäº§ç¯å¢ƒå¿…é¡»ä½¿ç”¨æ­£å¼ç­¾åï¼‰
- âš ï¸ **ProGuard è§„åˆ™ä¸ºç©º**ï¼ˆä»£ç æ··æ·†ä¸è¶³ï¼Œå®¹æ˜“è¢«åç¼–è¯‘ï¼‰
- âœ… æ”¯æŒä»£ç å‹ç¼©å’Œèµ„æºå‹ç¼©

### 2. ProGuard è§„åˆ™ (`app/android/app/proguard-rules.pro`)

```1:15:app/android/app/proguard-rules.pro
# Add project specific ProGuard rules here.
# By default, the flags in this file are appended to flags specified
# in /usr/local/Cellar/android-sdk/24.3.3/tools/proguard/proguard-android.txt
# You can edit the include path and order by changing the proguardFiles
# directive in build.gradle.
#
# For more details, see
#   http://developer.android.com/guide/developing/tools/proguard.html

# react-native-reanimated
-keep class com.swmansion.reanimated.** { *; }
-keep class com.facebook.react.turbomodule.** { *; }

# Add any project specific keep options here:
```

**å®‰å…¨è§‚å¯Ÿç‚¹ï¼š**
- âš ï¸ **ProGuard è§„åˆ™æå°‘**ï¼ˆä»…ä¿ç•™ React Native ç›¸å…³ç±»ï¼Œä¸šåŠ¡ä»£ç æœªæ··æ·†ï¼‰
- âš ï¸ **æœªæ·»åŠ ä»£ç æ··æ·†è§„åˆ™**ï¼ˆå®¹æ˜“è¢«åç¼–è¯‘ï¼‰

### 3. AndroidManifest.xml

```1:25:app/android/app/src/main/AndroidManifest.xml
<manifest xmlns:android="http://schemas.android.com/apk/res/android">
  <uses-permission android:name="android.permission.INTERNET"/>
  <uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE"/>
  <uses-permission android:name="android.permission.SYSTEM_ALERT_WINDOW"/>
  <uses-permission android:name="android.permission.VIBRATE"/>
  <uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE"/>
  <queries>
    <intent>
      <action android:name="android.intent.action.VIEW"/>
      <category android:name="android.intent.category.BROWSABLE"/>
      <data android:scheme="https"/>
    </intent>
  </queries>
  <application android:name=".MainApplication" android:label="@string/app_name" android:icon="@mipmap/ic_launcher" android:roundIcon="@mipmap/ic_launcher_round" android:allowBackup="true" android:theme="@style/AppTheme" android:supportsRtl="true" android:enableOnBackInvokedCallback="false">
    <meta-data android:name="expo.modules.updates.ENABLED" android:value="false"/>
    <meta-data android:name="expo.modules.updates.EXPO_UPDATES_CHECK_ON_LAUNCH" android:value="ALWAYS"/>
    <meta-data android:name="expo.modules.updates.EXPO_UPDATES_LAUNCH_WAIT_MS" android:value="0"/>
    <activity android:name=".MainActivity" android:configChanges="keyboard|keyboardHidden|orientation|screenSize|screenLayout|uiMode" android:launchMode="singleTask" android:windowSoftInputMode="adjustResize" android:theme="@style/Theme.App.SplashScreen" android:exported="true" android:screenOrientation="portrait">
      <intent-filter>
        <action android:name="android.intent.action.MAIN"/>
        <category android:name="android.intent.category.LAUNCHER"/>
      </intent-filter>
    </activity>
  </application>
</manifest>
```

**å®‰å…¨è§‚å¯Ÿç‚¹ï¼š**
- âš ï¸ **`allowBackup="true"`**ï¼ˆå…è®¸å¤‡ä»½ï¼Œå¯èƒ½æ³„éœ²æ•°æ®ï¼‰
- âš ï¸ **`READ_EXTERNAL_STORAGE` å’Œ `WRITE_EXTERNAL_STORAGE`**ï¼ˆAndroid 10+ å·²åºŸå¼ƒï¼Œåº”ä½¿ç”¨ Scoped Storageï¼‰
- âœ… æƒé™æœ€å°åŒ–ï¼ˆä»…ç”³è¯·å¿…è¦æƒé™ï¼‰

---

## å®‰å…¨é£é™©æ€»ç»“ä¸æ”¹å–„å»ºè®®

### ğŸ”´ é«˜ä¼˜å…ˆçº§ï¼ˆå¿…é¡»ç«‹å³ä¿®å¤ï¼‰

#### 1. JWT Secret ä½¿ç”¨é»˜è®¤å€¼
- **ä½ç½®**ï¼š`core/src/modules/auth/authService.ts:19`
- **é£é™©**ï¼šToken å¯è¢«ä¼ªé€ ï¼Œæ”»å‡»è€…å¯å†’å……ä»»ä½•ç”¨æˆ·
- **å»ºè®®**ï¼š
  ```bash
  # ç”Ÿæˆå¼ºéšæœºå¯†é’¥ï¼ˆè‡³å°‘ 32 å­—ç¬¦ï¼‰
  node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
  ```
  - è®¾ç½®ç¯å¢ƒå˜é‡ `XIAOPEI_JWT_SECRET`
  - ç”Ÿäº§ç¯å¢ƒå¿…é¡»ä½¿ç”¨å¼ºéšæœºå¯†é’¥

#### 2. å›ºå®šéªŒè¯ç  `123456`
- **ä½ç½®**ï¼š`core/src/modules/auth/authService.ts:140`
- **é£é™©**ï¼šä»»ä½•äººéƒ½å¯ä»¥ç™»å½•ï¼Œå®Œå…¨ç»•è¿‡éªŒè¯
- **å»ºè®®**ï¼š
  - ç«‹å³æ¥å…¥çœŸå®çŸ­ä¿¡/é‚®ä»¶æœåŠ¡ï¼ˆé˜¿é‡Œäº‘ã€è…¾è®¯äº‘ç­‰ï¼‰
  - ç§»é™¤å›ºå®šéªŒè¯ç é€»è¾‘
  - éªŒè¯ç éªŒè¯æ”¹ä¸ºæŸ¥è¯¢æ•°æ®åº“

#### 3. Android Release ä½¿ç”¨ Debug Keystore
- **ä½ç½®**ï¼š`app/android/app/build.gradle:115`
- **é£é™©**ï¼šåº”ç”¨æ— æ³•æ›´æ–°ï¼Œä¸”ç­¾åä¸å®‰å…¨
- **å»ºè®®**ï¼š
  ```bash
  # ç”Ÿæˆæ­£å¼ keystore
  keytool -genkeypair -v -storetype PKCS12 -keystore xiaopei-release.keystore \
    -alias xiaopei -keyalg RSA -keysize 2048 -validity 10000
  ```
  - é…ç½® `signingConfigs.release` ä½¿ç”¨æ­£å¼ keystore
  - å¦¥å–„ä¿ç®¡ keystore æ–‡ä»¶å’Œå¯†ç 

#### 4. Token æ˜æ–‡å­˜å‚¨
- **ä½ç½®**ï¼š`app/src/utils/tokenStorage.ts`
- **é£é™©**ï¼šè®¾å¤‡ root/jailbreak åå¯è¯»å– Token
- **å»ºè®®**ï¼š
  - ä½¿ç”¨ `react-native-keychain` åŠ å¯†å­˜å‚¨ Token
  - æˆ–ä½¿ç”¨ `expo-secure-store`ï¼ˆExpo é¡¹ç›®ï¼‰

### âš ï¸ ä¸­ä¼˜å…ˆçº§ï¼ˆå»ºè®®å°½å¿«ä¿®å¤ï¼‰

#### 5. éªŒè¯ç æ˜æ–‡å­˜å‚¨
- **ä½ç½®**ï¼šæ•°æ®åº“ `verification_codes` è¡¨
- **é£é™©**ï¼šæ•°æ®åº“æ³„éœ²æ—¶éªŒè¯ç æš´éœ²
- **å»ºè®®**ï¼š
  - ä½¿ç”¨ bcrypt æˆ– SHA-256 å“ˆå¸Œå­˜å‚¨éªŒè¯ç 
  - éªŒè¯æ—¶æ¯”è¾ƒå“ˆå¸Œå€¼

#### 6. å¼€å‘ç¯å¢ƒ CORS å®Œå…¨å¼€æ”¾
- **ä½ç½®**ï¼š`core/src/server.ts:31-34`
- **é£é™©**ï¼šå¼€å‘ç¯å¢ƒå¯èƒ½è¢«æ»¥ç”¨
- **å»ºè®®**ï¼š
  - å³ä½¿å¼€å‘ç¯å¢ƒä¹Ÿåº”é™åˆ¶å…è®¸çš„ origin
  - ä½¿ç”¨ç™½åå•æœºåˆ¶

#### 7. ProGuard è§„åˆ™ä¸è¶³
- **ä½ç½®**ï¼š`app/android/app/proguard-rules.pro`
- **é£é™©**ï¼šä»£ç å®¹æ˜“è¢«åç¼–è¯‘
- **å»ºè®®**ï¼š
  ```proguard
  # æ··æ·†æ‰€æœ‰ç±»
  -keepattributes SourceFile,LineNumberTable
  -renamesourcefileattribute SourceFile
  
  # æ··æ·†ä¸šåŠ¡ä»£ç 
  -keep class com.xiaopei.** { *; }
  -dontwarn com.xiaopei.**
  ```

#### 8. é™æµåŸºäºæ—¥æœŸï¼Œå¯èƒ½è¢«æ—¶åŒºç»•è¿‡
- **ä½ç½®**ï¼š`core/src/middleware/rateLimit.ts:74`
- **é£é™©**ï¼šç”¨æˆ·å¯èƒ½é€šè¿‡ä¿®æ”¹æ—¶åŒºç»•è¿‡é™æµ
- **å»ºè®®**ï¼š
  - ä½¿ç”¨ UTC æ—¶é—´
  - æˆ–ä½¿ç”¨ Redis å®ç°åˆ†å¸ƒå¼é™æµ

#### 9. éªŒè¯ç æ¥å£æ— é¢å¤–é™æµä¿æŠ¤
- **ä½ç½®**ï¼š`core/src/routes/auth.ts:84`
- **é£é™©**ï¼šå¯èƒ½è¢«æ»¥ç”¨å‘é€å¤§é‡éªŒè¯ç 
- **å»ºè®®**ï¼š
  - æ·»åŠ  IP é™æµï¼ˆå¦‚ 5 æ¬¡/åˆ†é’Ÿï¼‰
  - ä½¿ç”¨ Redis å®ç°åˆ†å¸ƒå¼é™æµ

#### 10. ç™»å‡ºæ¥å£æœªå®ç° Token é»‘åå•
- **ä½ç½®**ï¼š`core/src/routes/auth.ts:223`
- **é£é™©**ï¼šç™»å‡ºå Token ä»å¯ä½¿ç”¨ç›´åˆ°è¿‡æœŸ
- **å»ºè®®**ï¼š
  - å®ç° Token é»‘åå•ï¼ˆRedisï¼‰
  - éªŒè¯ Token æ—¶æ£€æŸ¥é»‘åå•

### ğŸ“‹ ä½ä¼˜å…ˆçº§ï¼ˆå¯é€æ­¥ä¼˜åŒ–ï¼‰

#### 11. æ•°æ®åº“è¿æ¥æ± å¤§å°å›ºå®š
- **ä½ç½®**ï¼š`core/src/database/connection.ts:22`
- **å»ºè®®**ï¼šæ ¹æ®å¹¶å‘é‡åŠ¨æ€è°ƒæ•´

#### 12. é”™è¯¯ä¿¡æ¯å¯èƒ½æ³„éœ²å †æ ˆ
- **ä½ç½®**ï¼š`core/src/server.ts:122`
- **å»ºè®®**ï¼šç”Ÿäº§ç¯å¢ƒå®Œå…¨éšè—é”™è¯¯è¯¦æƒ…

#### 13. æ—¥å¿—å¯èƒ½æ³„éœ²æ•æ„Ÿä¿¡æ¯
- **ä½ç½®**ï¼šå¤šå¤„ `console.log` æ‰“å° Token/éªŒè¯ç 
- **å»ºè®®**ï¼šç”Ÿäº§ç¯å¢ƒç¦ç”¨è¯¦ç»†æ—¥å¿—

#### 14. API Base URL ç¡¬ç¼–ç 
- **ä½ç½®**ï¼š`app/src/services/api/apiClient.ts:33`
- **å»ºè®®**ï¼šä½¿ç”¨é…ç½®æœåŠ¡æˆ–ç¯å¢ƒå˜é‡

#### 15. Android allowBackup å¼€å¯
- **ä½ç½®**ï¼š`app/android/app/src/main/AndroidManifest.xml:14`
- **å»ºè®®**ï¼šè®¾ç½®ä¸º `false`ï¼Œæˆ–ä½¿ç”¨åŠ å¯†å¤‡ä»½

---

## é˜²åç¼–è¯‘å»ºè®®

### iOS
1. **å¯ç”¨ Bitcode**ï¼ˆXcode Build Settingsï¼‰
2. **ä»£ç æ··æ·†**ï¼ˆä½¿ç”¨ Swift ç¼–è¯‘å™¨ä¼˜åŒ–ï¼‰
3. **å­—ç¬¦ä¸²åŠ å¯†**ï¼ˆæ•æ„Ÿå­—ç¬¦ä¸²ä½¿ç”¨åŠ å¯†å­˜å‚¨ï¼‰
4. **å¯ç”¨ App Transport Security**ï¼ˆå·²é…ç½® âœ…ï¼‰

### Android
1. **å¯ç”¨ R8 ä»£ç å‹ç¼©**ï¼ˆå·²é…ç½® âœ…ï¼‰
2. **å®Œå–„ ProGuard è§„åˆ™**ï¼ˆéœ€åŠ å¼º âš ï¸ï¼‰
3. **ä½¿ç”¨ DexGuard**ï¼ˆå•†ä¸šæ–¹æ¡ˆï¼Œå¯é€‰ï¼‰
4. **å­—ç¬¦ä¸²åŠ å¯†**ï¼ˆæ•æ„Ÿå­—ç¬¦ä¸²åŠ å¯†å­˜å‚¨ï¼‰
5. **Native ä»£ç ä¿æŠ¤**ï¼ˆå¦‚æœ‰ JNI ä»£ç ï¼‰

---

## æ•°æ®æ³„éœ²é˜²æŠ¤å»ºè®®

### åç«¯
1. **æ•°æ®åº“åŠ å¯†**ï¼ˆæ•æ„Ÿå­—æ®µåŠ å¯†å­˜å‚¨ï¼‰
2. **API Key åŠ å¯†**ï¼ˆç¡®è®¤ `llm_api_configs.api_key_encrypted` æ˜¯å¦çœŸæ­£åŠ å¯†ï¼‰
3. **æ—¥å¿—è„±æ•**ï¼ˆç§»é™¤æ•æ„Ÿä¿¡æ¯ï¼‰
4. **å®šæœŸå®‰å…¨å®¡è®¡**ï¼ˆæ£€æŸ¥å¼‚å¸¸è®¿é—®ï¼‰

### å‰ç«¯
1. **Token åŠ å¯†å­˜å‚¨**ï¼ˆä½¿ç”¨ Keychain/SecureStoreï¼‰
2. **æ•æ„Ÿæ•°æ®ä¸è½ç›˜**ï¼ˆå†…å­˜ä¸­å¤„ç†ï¼‰
3. **ç¦ç”¨è°ƒè¯•æ—¥å¿—**ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
4. **ä»£ç æ··æ·†**ï¼ˆé˜²æ­¢åç¼–è¯‘ï¼‰

---

## æ€»ç»“

### å½“å‰å®‰å…¨çŠ¶æ€
- âœ… **åŸºç¡€å®‰å…¨æªæ–½å·²å®æ–½**ï¼ˆJWTã€é™æµã€æƒé™æ§åˆ¶ï¼‰
- ğŸ”´ **å­˜åœ¨ä¸¥é‡å®‰å…¨éšæ‚£**ï¼ˆJWT Secretã€å›ºå®šéªŒè¯ç ã€Android ç­¾åï¼‰
- âš ï¸ **å¤šå¤„éœ€è¦åŠ å›º**ï¼ˆå­˜å‚¨åŠ å¯†ã€ä»£ç æ··æ·†ã€æ—¥å¿—è„±æ•ï¼‰

### ä¼˜å…ˆçº§è¡ŒåŠ¨æ¸…å•

**ç«‹å³æ‰§è¡Œï¼ˆP0ï¼‰ï¼š**
1. æ›´æ¢ JWT Secret ä¸ºå¼ºéšæœºå¯†é’¥
2. æ¥å…¥çœŸå®çŸ­ä¿¡/é‚®ä»¶æœåŠ¡ï¼Œç§»é™¤å›ºå®šéªŒè¯ç 
3. ç”Ÿæˆæ­£å¼ Android keystore å¹¶é…ç½®
4. Token ä½¿ç”¨åŠ å¯†å­˜å‚¨ï¼ˆKeychain/SecureStoreï¼‰

**æœ¬å‘¨å†…å®Œæˆï¼ˆP1ï¼‰ï¼š**
5. éªŒè¯ç ä½¿ç”¨å“ˆå¸Œå­˜å‚¨
6. å®Œå–„ ProGuard è§„åˆ™
7. æ·»åŠ éªŒè¯ç æ¥å£ IP é™æµ
8. å®ç° Token é»‘åå•

**æœ¬æœˆå†…å®Œæˆï¼ˆP2ï¼‰ï¼š**
9. ä½¿ç”¨ UTC æ—¶é—´å®ç°é™æµ
10. ç§»é™¤ç”Ÿäº§ç¯å¢ƒè¯¦ç»†æ—¥å¿—
11. é…ç½®æ•°æ®åº“å­—æ®µåŠ å¯†
12. å®Œå–„é”™è¯¯å¤„ç†ï¼ˆä¸æ³„éœ²å †æ ˆï¼‰

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0  
**è¯„ä¼°æ—¥æœŸ**ï¼š2024-12-XX  
**è¯„ä¼°èŒƒå›´**ï¼šåç«¯ Coreã€React Native Appã€iOS/Android é…ç½®




