# 重新构建与测试指南

**构建时间**: 2025-12-24  
**版本**: 1.0.1  
**修复内容**:
1. ✅ 用户协议 PDF 无法查看问题（添加错误处理和备用方案）
2. ✅ 华为 Mate 40 适配问题（SafeAreaView 和动态高度）

---

## 📦 构建步骤

### 1. 确认修改内容

**已修改的文件**:
- ✅ `app/src/screens/Auth/PolicyViewerScreen.tsx` - 用户协议查看页面
- ✅ `app/src/components/auth/GoogleLoginSheet.tsx` - Google 登录弹窗
- ✅ `app/src/config/env.ts` - 添加了诊断日志（之前已修改）

### 2. 构建生产包

#### 选项 A：构建 APK（用于测试）

```bash
cd app
eas build --platform android --profile production
```

#### 选项 B：构建 AAB（用于 Google Play 发布）

```bash
cd app
eas build --platform android --profile productionAab
```

#### 选项 C：同时构建 iOS 和 Android

```bash
cd app
eas build --platform all --profile production
```

---

## 🧪 测试清单

### 1. 用户协议查看功能测试

#### 测试步骤：
1. 打开 App
2. 进入登录页面
3. 点击"用户协议"链接
4. 观察是否正常加载

#### 预期结果：
- ✅ PDF 文档正常加载显示
- ✅ 如果加载失败，显示错误提示
- ✅ 可以点击"在浏览器中打开"备用方案

#### 测试场景：
- [ ] 正常网络环境下加载
- [ ] 弱网环境下加载（测试加载提示）
- [ ] 断网环境下加载（测试错误提示和备用方案）
- [ ] 点击"在浏览器中打开"是否正常工作

### 2. 华为 Mate 40 适配测试

#### 测试步骤：
1. 打开 App
2. 进入登录页面
3. 点击"通过 Google 登录"按钮
4. 观察弹窗显示

#### 预期结果：
- ✅ 弹窗从底部正常弹出
- ✅ 弹窗高度适中（不超过屏幕 50%）
- ✅ 底部内容不被安全区域遮挡
- ✅ 所有按钮和文字完整显示
- ✅ 可以正常关闭弹窗

#### 测试场景：
- [ ] 华为 Mate 40 设备测试
- [ ] 其他 Android 设备测试（不同屏幕尺寸）
- [ ] 检查弹窗动画是否流畅
- [ ] 检查弹窗内容是否完整显示

### 3. 环境变量诊断测试

#### 测试步骤：
1. 安装新构建的 APK
2. 打开 App
3. 查看启动日志（使用 `adb logcat` 或 React Native Debugger）
4. 搜索 `[ENV DIAGNOSTIC]`

#### 预期结果：
- ✅ 打印 `API_BASE_URL: https://xiaopei-core-343578696044.asia-east2.run.app`
- ✅ 打印 `EXPO_PUBLIC_API_BASE_URL: https://xiaopei-core-343578696044.asia-east2.run.app`
- ✅ 打印 `APP_ENV: production`

#### 验证命令：
```bash
# Android 设备日志
adb logcat | grep "ENV DIAGNOSTIC"

# 或使用 React Native Debugger
# 在 Console 中搜索 "ENV DIAGNOSTIC"
```

---

## 🔍 问题排查

### 如果用户协议仍然无法查看

1. **检查网络连接**
   ```bash
   # 测试 PDF 文件是否可以访问
   curl -I https://xiaopei-core-343578696044.asia-east2.run.app/public/docs/miaosuan_user_agreement_zh-HK.pdf
   ```

2. **检查 WebView 错误日志**
   - 在 App 中打开用户协议
   - 查看 React Native Debugger 或 `adb logcat` 中的错误信息
   - 搜索 "WebView" 或 "PDF" 相关错误

3. **测试备用方案**
   - 点击"在浏览器中打开"
   - 确认是否能在浏览器中正常打开 PDF

### 如果华为 Mate 40 仍然有适配问题

1. **检查设备信息**
   ```bash
   # 获取设备屏幕信息
   adb shell wm size
   adb shell wm density
   ```

2. **检查 SafeAreaView 配置**
   - 确认 `react-native-safe-area-context` 已正确安装
   - 检查 `SafeAreaProvider` 是否在 App 根组件中

3. **测试不同屏幕尺寸**
   - 在模拟器中测试不同屏幕尺寸
   - 检查弹窗高度是否动态调整

---

## 📝 构建命令参考

### EAS Build 常用命令

```bash
# 查看构建配置
eas build:configure

# 查看构建历史
eas build:list

# 查看构建详情
eas build:view [BUILD_ID]

# 取消构建
eas build:cancel [BUILD_ID]

# 下载构建产物
eas build:download [BUILD_ID]
```

### 本地构建（开发测试）

```bash
# Android 本地构建
cd app
npm run android

# iOS 本地构建
cd app
npm run ios
```

---

## ✅ 构建前检查清单

- [ ] 代码已提交到 Git
- [ ] 所有修改已测试通过
- [ ] `eas.json` 配置正确
- [ ] 环境变量配置正确（`EXPO_PUBLIC_API_BASE_URL`）
- [ ] 版本号已更新（如需要）

---

## 🚀 快速构建命令

```bash
# 进入 app 目录
cd app

# 构建 Android APK（生产环境）
eas build --platform android --profile production

# 构建完成后，下载 APK 并安装测试
```

---

## 📱 安装测试

### Android 设备

```bash
# 方法 1：通过 adb 安装
adb install path/to/app.apk

# 方法 2：通过 EAS 下载链接安装
# 构建完成后，EAS 会提供下载链接
# 在设备浏览器中打开链接下载安装
```

### 测试设备要求

- ✅ Android 5.0+ (API 21+)
- ✅ 华为 Mate 40（主要测试设备）
- ✅ 其他 Android 设备（兼容性测试）

---

## 📊 测试报告模板

### 测试结果记录

```
设备型号: 华为 Mate 40
Android 版本: [版本号]
测试时间: [日期时间]

[ ] 用户协议查看 - 正常
[ ] 用户协议查看 - 错误处理正常
[ ] 用户协议查看 - 备用方案正常
[ ] Google 登录弹窗 - 显示正常
[ ] Google 登录弹窗 - 高度适配正常
[ ] Google 登录弹窗 - 安全区域处理正常
[ ] 环境变量诊断 - API_BASE_URL 正确
[ ] 环境变量诊断 - 日志输出正常

问题记录:
1. [如有问题，记录 here]
2. [如有问题，记录 here]
```

---

## 🎯 下一步

构建完成后：
1. ✅ 下载并安装 APK
2. ✅ 按照测试清单逐项测试
3. ✅ 记录测试结果
4. ✅ 如有问题，查看日志并修复
5. ✅ 确认无误后，可以发布到 Google Play

