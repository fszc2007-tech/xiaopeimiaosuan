# Cloud Run 扩容方案总结

## 一、当前配置分析

### 当前 Cloud Run 配置
- **内存**: 256Mi ❌（严重不足）
- **CPU**: 1 vCPU ✅（符合建议）
- **超时**: 300s ❌（需要增加）
- **并发**: 30 ❌（需要降低）
- **Min instances**: 0 ✅（默认，符合建议）
- **Max instances**: 未设置 ❌（需要设置）

### 当前数据库连接池配置
- **生产环境**: 3 个连接 ❌（严重不足）
- **开发环境**: 10 个连接 ✅

## 二、代码分析

### SSE 流式响应特点
- **持续时间**: 60 秒以上
- **maxTokens**: 2000-4000（默认 2000，数据库配置 4000）
- **响应内容**: 可能较大（几千到上万字符）
- **内存占用**: 每个 SSE 连接需要保持响应流在内存中

### 结论
- ✅ **建议使用 2GiB 内存**（而不是 1GiB），因为：
  1. SSE 流式响应持续时间长（60秒+）
  2. 响应内容可能较大（2000-4000 tokens）
  3. 多个并发请求会累积内存占用

## 三、扩容方案

### 目标配置（内测/小范围 APK 定向测试）

| 资源 | 当前值 | 目标值 | 说明 |
|------|--------|--------|------|
| **CPU** | 1 vCPU | 1 vCPU | 保持不变 |
| **内存** | 256Mi | **2GiB** | 支持 SSE 流式响应 |
| **超时** | 300s | **600s** | 覆盖完整 LLM 流式输出 + 重试 |
| **并发** | 30 | **10** | 有 SSE 时建议偏低 |
| **Min instances** | 0 | 0 | 允许冷启动，省钱 |
| **Max instances** | 未设置 | **10** | 防止被刷把数据库打爆 |
| **数据库连接池** | 3 | **15** | 支持 concurrency 5-10 |

### 代码修改

**文件**: `core/src/database/connection.ts`

```typescript
// 连接池限制：生产环境默认 15（支持 concurrency 5-10），开发环境默认 10
const connectionLimit = parseInt(
  process.env.MYSQL_CONNECTION_LIMIT || 
  (process.env.NODE_ENV === 'production' ? '15' : '10')
);
```

## 四、执行扩容

### 方法 1：使用脚本（推荐）

```bash
./扩容Cloud-Run.sh
```

### 方法 2：手动执行

```bash
gcloud run services update xiaopei-core \
  --region=asia-east2 \
  --project=xiaopei-app \
  --memory=2Gi \
  --cpu=1 \
  --timeout=600 \
  --concurrency=10 \
  --min-instances=0 \
  --max-instances=10 \
  --set-env-vars="MYSQL_CONNECTION_LIMIT=15"
```

## 五、验证扩容结果

### 检查配置

```bash
gcloud run services describe xiaopei-core \
  --region=asia-east2 \
  --project=xiaopei-app \
  --format="yaml" | grep -E "memory|cpu|timeout|concurrency|minInstances|maxInstances"
```

### 检查环境变量

```bash
gcloud run services describe xiaopei-core \
  --region=asia-east2 \
  --project=xiaopei-app \
  --format="value(spec.template.spec.containers[0].env)" | grep MYSQL_CONNECTION_LIMIT
```

## 六、预期效果

### 资源容量提升

1. **内存**: 256Mi → 2GiB（**8倍提升**）
   - 可以支持更多并发 SSE 流式响应
   - 减少内存不足导致的 502 错误

2. **超时**: 300s → 600s（**2倍提升**）
   - 可以覆盖完整的 LLM 流式输出（60秒）+ 重试
   - 减少超时导致的 502 错误

3. **并发**: 30 → 10（**降低**）
   - 有 SSE 时建议偏低，避免资源竞争
   - 配合 Max instances 10，总并发上限：10 × 10 = 100

4. **数据库连接池**: 3 → 15（**5倍提升**）
   - 支持更多并发数据库操作
   - 减少连接耗尽导致的 502 错误

5. **Max instances**: 未设置 → 10
   - 防止被刷把数据库打爆
   - 总并发上限：10 × 10 = 100

### 成本估算

- **内存成本**: 256Mi → 2GiB（约 8倍）
- **实例数限制**: Max 10（防止意外高成本）
- **总体成本**: 预计增加 5-8倍（但更稳定）

## 七、注意事项

1. **数据库连接池**: 已通过代码修改，默认值从 3 增加到 15
   - 如果通过环境变量 `MYSQL_CONNECTION_LIMIT` 设置，会覆盖默认值
   - 扩容脚本会设置环境变量 `MYSQL_CONNECTION_LIMIT=15`

2. **需要重新部署代码**: 
   - 数据库连接池的代码修改需要重新部署才能生效
   - 或者直接通过环境变量设置（扩容脚本已包含）

3. **监控建议**:
   - 监控内存使用率（目标 < 80%）
   - 监控数据库连接数（目标 < 80%）
   - 监控 502 错误率（目标 < 1%）

## 八、下一步

1. ✅ 执行扩容脚本
2. ✅ 重新部署代码（包含数据库连接池修改）
3. ⏳ 监控资源使用情况
4. ⏳ 根据实际使用情况调整配置

