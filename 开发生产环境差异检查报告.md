# 开发生产环境差异检查报告

## 检查时间
2025-12-25

## 1. 验证码存储方式 ✅ 无问题

### 检查结果
- **存储位置**: MySQL 数据库 (`verification_codes` 表)
- **存储方式**: 数据库 INSERT/UPDATE，不依赖内存
- **代码位置**: `core/src/modules/auth/authService.ts:135-139`

```typescript
// 6. 保存验证码到数据库（MySQL）
await pool.execute(
  `INSERT INTO verification_codes (code_id, phone, code, code_type, expires_at, is_used) 
   VALUES (?, ?, ?, 'login', ?, FALSE)`,
  [codeId, normalizedPhone, code, expiresAt]
);
```

### 结论
✅ **验证码存储在数据库，支持多实例部署**
- 发送验证码和校验验证码可以在不同实例上执行
- 不依赖进程内存或全局变量
- Cloud Run 多实例不会导致"第一次输入正确也提示错误"

---

## 2. 验证码生成与处理 ✅ 无问题

### 检查结果
- **生成函数**: `generateCode(): string` (返回字符串)
- **字符集**: `'0123456789'` (纯数字)
- **代码位置**: `core/src/modules/auth/authService.ts:31-38`

```typescript
function generateCode(): string {
  const { length, charset } = otpConfig;
  let code = '';
  for (let i = 0; i < length; i++) {
    code += charset.charAt(Math.floor(Math.random() * charset.length));
  }
  return code; // 返回字符串，不是数字
}
```

### 校验方式
- **查询方式**: 直接字符串比较 (`WHERE code = ?`)
- **代码位置**: `core/src/modules/auth/authService.ts:220-230`

```typescript
const [codeRows]: any = await pool.execute(
  `SELECT * FROM verification_codes 
   WHERE phone = ? 
   AND code = ?  // 字符串比较，不是 parseInt
   AND code_type = 'login'
   AND is_used = FALSE
   AND expires_at > NOW()
   ORDER BY created_at DESC
   LIMIT 1`,
  [normalizedPhone, code]
);
```

### 结论
✅ **验证码是字符串类型，不会丢失前导0**
- 生成：字符串拼接
- 存储：字符串存储
- 校验：字符串比较
- 不会出现 `parseInt('012345')` 导致前导0丢失的问题

---

## 3. 字体与渲染问题 ⚠️ 潜在问题

### 检查结果
- **组件**: `app/src/components/auth/OtpInput.tsx`
- **字体设置**: 未显式指定 `fontFamily`
- **代码位置**: `app/src/components/auth/OtpInput.tsx:277-284`

```typescript
input: {
  width: '100%',
  height: '100%',
  textAlign: 'center',
  fontSize: fontSizes['2xl'],
  fontWeight: fontWeights.bold,
  color: '#1A1A1A',
  // ⚠️ 缺少 fontFamily 显式设置
},
```

### 潜在问题
1. **继承全局字体**: 可能继承到 icon font 或其他字体
2. **生产环境资源加载顺序**: 生产包可能更早注入全局样式
3. **字体覆盖**: icon font 可能覆盖到 TextInput，导致数字显示成图标

### 建议（不改代码）
- 如果验证码显示异常（显示成图标），需要显式设置 `fontFamily: 'System'` 或系统默认字体

---

## 4. Cloud Run 配置检查

### 当前配置
- **Max instances**: 10（多实例）
- **Min instances**: 0（允许冷启动）
- **并发**: 10
- **内存**: 2GiB
- **超时**: 600s

### 结论
✅ **多实例配置不影响验证码功能**
- 验证码存储在共享数据库，不依赖实例本地状态
- 多实例不会导致验证码校验失败

---

## 5. 环境变量配置差异

### 需要检查的环境变量
- `XIAOPEI_JWT_SECRET`
- `XIAOPEI_MYSQL_HOST`
- `XIAOPEI_MYSQL_USER`
- `XIAOPEI_MYSQL_PASSWORD`
- `XIAOPEI_MYSQL_DATABASE`
- `TENCENT_SMS_SECRET_ID`
- `TENCENT_SMS_SECRET_KEY`
- `GOOGLE_CLIENT_ID`
- `GOOGLE_CLIENT_SECRET`

### 建议
- 比对开发环境和生产环境的所有关键环境变量
- 确认 OTP 相关配置一致

---

## 6. 总结

### ✅ 无问题的部分
1. **验证码存储**: 使用数据库，支持多实例
2. **验证码生成**: 字符串类型，不会丢失前导0
3. **验证码校验**: 字符串比较，不会类型转换问题

### ⚠️ 潜在问题
1. **字体渲染**: OTP 输入框未显式设置字体，可能被 icon font 覆盖
   - **症状**: 验证码显示成图标而不是数字
   - **原因**: 生产环境字体加载顺序不同，icon font 覆盖了 TextInput

### 🔍 需要进一步检查
1. **环境变量配置**: 比对开发和生产环境的所有关键配置
2. **字体问题**: 如果验证码显示异常，需要显式设置 `fontFamily`
3. **数据库连接**: 确认生产环境数据库连接正常

---

## 7. 快速诊断建议

### 如果验证码显示异常（显示成图标）
**临时测试**: 在 `OtpInput.tsx` 的 `input` 样式中添加：
```typescript
fontFamily: Platform.OS === 'ios' ? 'System' : 'Roboto',
```

### 如果验证码第一次就校验失败
1. **检查数据库连接**: 确认生产环境能正常连接数据库
2. **检查 phone 规范化**: 确认发送和校验时 phone 格式一致
3. **检查环境变量**: 确认所有配置正确

### 如果 Google 登录失败
1. **检查 OAuth 配置**: 确认包名、签名证书、回调 URL 匹配
2. **检查环境变量**: 确认 `GOOGLE_CLIENT_ID` 和 `GOOGLE_CLIENT_SECRET` 正确

