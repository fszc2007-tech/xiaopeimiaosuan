# 小佩 H5 版本測試指南

## 📋 測試前準備

### 1. 環境要求
- Node.js >= 18
- MongoDB 運行中
- Redis 運行中（如果使用）

### 2. 啟動 Core 後端
```bash
cd /Users/gaoxuxu/Desktop/xiaopei-app/core
npm install
npm run dev
```

**確認**: Core 後端應該運行在 `http://localhost:3000`

### 3. 執行數據庫遷移
```bash
cd /Users/gaoxuxu/Desktop/xiaopei-app/core

# 連接到 MongoDB
mongosh xiaopei

# 執行遷移 SQL（手動執行）
# 或者如果有遷移腳本：
npm run migrate
```

**遷移內容**:
```sql
use xiaopei;

db.users.updateMany(
  {},
  {
    $set: {
      username: null,
      password_hash: null,
      password_set: false
    }
  }
);

# 創建索引
db.users.createIndex(
  { username: 1 },
  { unique: true, sparse: true }
);
```

### 4. 啟動 H5 前端
```bash
cd /Users/gaoxuxu/Desktop/xiaopei-app/web
npm install
npm run dev
```

**確認**: H5 前端應該運行在 `http://localhost:5173`

---

## ✅ 測試清單

### 一、後端接口測試

#### 1. 用戶名註冊接口
```bash
curl -X POST http://localhost:3000/api/v1/auth/register_username \
  -H "Content-Type: application/json" \
  -d '{
    "username": "testuser001",
    "password": "Test1234",
    "confirmPassword": "Test1234"
  }'
```

**預期結果**:
```json
{
  "success": true,
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "user": {
      "userId": "...",
      "username": "testuser001",
      "passwordSet": true,
      ...
    }
  }
}
```

**測試點**:
- ✅ 返回 Token
- ✅ 用戶名保存正確
- ✅ `passwordSet` 為 `true`
- ✅ 密碼已哈希（不是明文）

#### 2. 用戶名登錄接口
```bash
curl -X POST http://localhost:3000/api/v1/auth/login_username \
  -H "Content-Type: application/json" \
  -d '{
    "username": "testuser001",
    "password": "Test1234"
  }'
```

**預期結果**:
```json
{
  "success": true,
  "data": {
    "token": "...",
    "user": { ... }
  }
}
```

**測試點**:
- ✅ 正確密碼可以登錄
- ✅ 錯誤密碼返回 401
- ✅ 不存在的用戶名返回 401

#### 3. 驗證 App 端不受影響
```bash
# 手機號登錄（App 端現有接口）
curl -X POST http://localhost:3000/api/v1/auth/login_or_register \
  -H "Content-Type: application/json" \
  -d '{
    "phone": "+8613800138000",
    "code": "123456"
  }'
```

**測試點**:
- ✅ App 端手機號登錄仍然正常
- ✅ 現有用戶的 `username` 字段為 `null`（不影響現有數據）

---

### 二、H5 前端測試

#### 1. 用戶註冊流程
**操作步驟**:
1. 打開 `http://localhost:5173/register`
2. 輸入用戶名：`h5test001`（4-20 字符）
3. 輸入密碼：`Test1234`（至少 8 位）
4. 確認密碼：`Test1234`
5. 點擊「註冊」

**預期結果**:
- ✅ 註冊成功
- ✅ 自動跳轉到命盤列表（`/charts`）
- ✅ LocalStorage 中存在 `XIAOPEI_TOKEN`

**錯誤測試**:
- 用戶名重複 → 提示「用戶名已存在」
- 密碼不一致 → 提示「兩次密碼不一致」
- 用戶名過短 → 提示「用戶名長度 4-20 字符」

#### 2. 用戶名登錄流程
**操作步驟**:
1. 打開 `http://localhost:5173/login`
2. 切換到「用戶名登錄」Tab
3. 輸入用戶名：`h5test001`
4. 輸入密碼：`Test1234`
5. 點擊「登錄」

**預期結果**:
- ✅ 登錄成功
- ✅ 跳轉到命盤列表
- ✅ 顯示用戶信息

#### 3. 手機號登錄流程（復用 App 接口）
**操作步驟**:
1. 打開 `http://localhost:5173/login`
2. 保持在「手機號登錄」Tab
3. 輸入手機號：`+8613800138000`
4. 點擊「獲取驗證碼」
5. 輸入驗證碼（從後端日誌或短信獲取）
6. 點擊「登錄」

**預期結果**:
- ✅ 登錄成功
- ✅ 跳轉到命盤列表
- ✅ 與 App 端共享用戶數據

#### 4. 命盤列表頁面
**操作步驟**:
1. 登錄後自動進入 `/charts`
2. 測試搜索功能（輸入姓名搜索）
3. 測試篩選功能
   - 選擇關係類型（本人/伴侶等）
   - 選擇排序方式（最近查看/創建時間）
4. 點擊命盤卡片

**預期結果**:
- ✅ 顯示命盤列表（如有數據）
- ✅ 搜索實時生效
- ✅ 篩選實時生效
- ✅ 點擊跳轉到命盤詳情

#### 5. 命盤詳情頁面
**操作步驟**:
1. 從列表點擊進入 `/chart/:chartId`
2. 測試三個 Tab 切換
   - 基本資訊
   - 命盤總覽
   - 大運流年
3. 在「命盤總覽」點擊「一鍵解讀」
4. 在「大運流年」點擊大運卡片

**預期結果**:
- ✅ 顯示命盤數據
- ✅ 三個 Tab 都有內容
- ✅ 點擊「一鍵解讀」跳轉到對話頁面並自動發送問題
- ✅ 四柱八字顯示正確
- ✅ 大運時間軸顯示正確

#### 6. AI 對話頁面（SSE 流式）
**操作步驟**:
1. 從命盤詳情點擊「一鍵解讀」，或直接訪問 `/chat`
2. 在輸入框輸入問題：「我的命盤有什麼特點？」
3. 點擊「發送」
4. 觀察流式內容展示
5. 測試「停止生成」按鈕
6. 點擊追問建議（如有）

**預期結果**:
- ✅ 實時打字效果（SSE 流式接收）
- ✅ Markdown 正確渲染
- ✅ 「停止生成」可中斷對話
- ✅ 追問建議可點擊發送
- ✅ 消息自動滾動到底部

**關鍵測試**:
- 打開瀏覽器開發者工具 → Network
- 發送消息時應該看到 `messages` 請求
- Type: `fetch`
- Transfer: `chunked`（流式傳輸）

#### 7. 個人中心頁面
**操作步驟**:
1. 點擊頭部「個人中心」或訪問 `/me`
2. 查看用戶信息
3. 點擊各個菜單項
4. 點擊「登出」

**預期結果**:
- ✅ 顯示用戶信息（用戶名/手機號）
- ✅ 菜單可點擊
- ✅ 登出成功，跳轉到登錄頁
- ✅ LocalStorage 清空

---

### 三、App 兼容性測試

#### 1. App 端登錄
**操作步驟**:
1. 打開 App（iOS 或 Android）
2. 使用手機號 + 驗證碼登錄
3. 查看命盤列表

**預期結果**:
- ✅ App 端登錄流程不受影響
- ✅ 命盤列表正常顯示
- ✅ AI 對話正常工作

#### 2. 數據互通測試
**操作步驟**:
1. 在 App 端創建一個命盤
2. 在 H5 端刷新命盤列表

**預期結果**:
- ✅ H5 端可以看到 App 端創建的命盤
- ✅ 數據完全一致

#### 3. 現有用戶數據驗證
**操作步驟**:
1. 使用現有 App 用戶的手機號登錄 H5
2. 查看用戶信息

**預期結果**:
- ✅ `username` 字段為 `null`
- ✅ `passwordSet` 字段為 `false`
- ✅ 其他字段不受影響

---

## 🐛 常見問題排查

### 1. 後端接口 404
**原因**: Core 後端未啟動或端口不對

**解決**:
```bash
cd core
npm run dev
# 確認日誌中有 "Server running on port 3000"
```

### 2. CORS 錯誤
**原因**: Core 後端 CORS 配置問題

**解決**: 檢查 `core/src/app.ts` 中的 CORS 配置
```typescript
app.use(cors({
  origin: ['http://localhost:5173', 'http://localhost:3001'],
  credentials: true,
}));
```

### 3. Token 未保存
**原因**: LocalStorage 訪問問題

**排查**:
1. 打開瀏覽器開發者工具
2. Application → Local Storage
3. 查看是否有 `XIAOPEI_TOKEN`

### 4. SSE 流式不工作
**原因**: 後端未正確返回 SSE 格式

**排查**:
1. 打開 Network 面板
2. 查看 `messages` 請求的 Response Headers
3. 應該包含 `Content-Type: text/event-stream`

### 5. 命盤數據顯示不完整
**原因**: 後端返回數據結構與前端不一致

**排查**:
1. 打開 Console 面板
2. 查看 `console.log('命盤詳情響應:', response)`
3. 對比數據結構是否正確

---

## 📊 測試報告模板

### 測試環境
- Node.js 版本: ___________
- 瀏覽器: ___________
- Core 後端版本: ___________

### 測試結果

| 測試項 | 狀態 | 備註 |
|--------|------|------|
| 用戶名註冊接口 | ⬜ 通過 / ⬜ 失敗 | |
| 用戶名登錄接口 | ⬜ 通過 / ⬜ 失敗 | |
| App 端手機號登錄 | ⬜ 通過 / ⬜ 失敗 | |
| H5 用戶註冊流程 | ⬜ 通過 / ⬜ 失敗 | |
| H5 用戶名登錄 | ⬜ 通過 / ⬜ 失敗 | |
| H5 手機號登錄 | ⬜ 通過 / ⬜ 失敗 | |
| 命盤列表頁面 | ⬜ 通過 / ⬜ 失敗 | |
| 命盤詳情頁面 | ⬜ 通過 / ⬜ 失敗 | |
| AI 對話（SSE 流式） | ⬜ 通過 / ⬜ 失敗 | |
| 個人中心頁面 | ⬜ 通過 / ⬜ 失敗 | |
| App 與 H5 數據互通 | ⬜ 通過 / ⬜ 失敗 | |

### 發現的問題
1. ___________
2. ___________
3. ___________

---

## 🚀 快速啟動命令

**一鍵啟動所有服務**（推薦）:
```bash
# 終端 1: Core 後端
cd /Users/gaoxuxu/Desktop/xiaopei-app/core && npm run dev

# 終端 2: H5 前端
cd /Users/gaoxuxu/Desktop/xiaopei-app/web && npm run dev
```

**訪問地址**:
- H5 前端: http://localhost:5173
- Core API: http://localhost:3000
- API 文檔: http://localhost:3000/api-docs（如有）

---

**測試負責人**: ___________  
**測試日期**: ___________  
**測試狀態**: ⬜ 通過 / ⬜ 部分通過 / ⬜ 失敗  
**下一步**: ___________


