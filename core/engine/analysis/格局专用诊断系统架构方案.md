# 格局专用诊断系统架构方案

## 一、系统概述

### 1.1 设计目标

建立一套完整的格局纯度诊断系统，用于判断每个格局的成败高低（真/假/一般/破格），这是传统命理中的标准概念。

### 1.2 核心架构

```javascript
class PatternPuritySystem {
  constructor(bazi) {
    this.bazi = bazi;
    this.通用病理 = poge系统.诊断(bazi); // 使用现有poge.js，不修改
  }
  
  // 主入口函数
  诊断格局纯度(格局类型) {
    const 诊断结果 = {
      格局: 格局类型,
      专用破格因素: [],
      救应因素: [],
      通用病理: this.通用病理.破格因素,
      最终纯度: '',
      得分: 100, // 基础分
      描述: ''
    };
    
    // 调用具体格局的诊断函数
    const 诊断函数 = 格局诊断映射[格局类型];
    if (诊断函数) {
      诊断函数(this, 诊断结果);
    }
    
    // 计算最终纯度
    this.计算最终纯度(诊断结果);
    return 诊断结果;
  }
}
```

### 1.3 系统特点

- **不修改破格因素系统**：仅读取 `poge.js` 的结果，不修改其逻辑
- **格局专用诊断**：每个格局有独立的诊断规则
- **救应因素分析**：检查是否有救应因素化解破格
- **综合评分**：基于破格和救应计算最终纯度等级

---

## 二、格局诊断映射表

### 2.1 月令主格（11个）

| 格局名称 | 诊断函数 | 状态 |
|---------|---------|------|
| 正官格 | `诊断正官格` | ✅ 已覆盖 |
| 七杀格 | `诊断七杀格` | ✅ 已覆盖 |
| 正财格 | `诊断正财格` | ✅ 已覆盖 |
| 偏财格 | `诊断偏财格` | ✅ 已覆盖 |
| 正印格 | `诊断正印格` | ✅ 已覆盖 |
| 偏印格 | `诊断偏印格` | ✅ 已覆盖 |
| 食神格 | `诊断食神格` | ✅ 已覆盖 |
| 伤官格 | `诊断伤官格` | ✅ 已覆盖 |
| 建禄格 | `诊断建禄格` | ✅ 已覆盖 |
| 阳刃格 | `诊断阳刃格` | ✅ 已覆盖 |
| 月劫格 | `诊断月劫格` | ✅ 已覆盖 |

### 2.2 特殊格局（15个）

#### 专旺格（5个）

| 格局名称 | 诊断函数 | 状态 |
|---------|---------|------|
| 曲直仁寿格 | `诊断专旺格(结果, '木')` | ✅ 已覆盖 |
| 炎上格 | `诊断专旺格(结果, '火')` | ✅ 已覆盖 |
| 稼穑格 | `诊断专旺格(结果, '土')` | ✅ 已覆盖 |
| 从革格 | `诊断专旺格(结果, '金')` | ✅ 已覆盖 |
| 润下格 | `诊断专旺格(结果, '水')` | ✅ 已覆盖 |

#### 从弱格（4个）

| 格局名称 | 诊断函数 | 状态 |
|---------|---------|------|
| 从财格 | `诊断从弱格(结果, '从财格')` | ✅ 已覆盖 |
| 从杀格 | `诊断从弱格(结果, '从杀格')` | ✅ 已覆盖 |
| 从儿格 | `诊断从弱格(结果, '从儿格')` | ✅ 已覆盖 |
| 从势格 | `诊断从弱格(结果, '从势格')` | ✅ 已覆盖 |

#### 化气格（5个）

| 格局名称 | 诊断函数 | 状态 |
|---------|---------|------|
| 甲己化土格 | `诊断化气格(结果, '甲己化土格')` | ✅ 已覆盖 |
| 乙庚化金格 | `诊断化气格(结果, '乙庚化金格')` | ✅ 已覆盖 |
| 丙辛化水格 | `诊断化气格(结果, '丙辛化水格')` | ✅ 已覆盖 |
| 丁壬化木格 | `诊断化气格(结果, '丁壬化木格')` | ✅ 已覆盖 |
| 戊癸化火格 | `诊断化气格(结果, '戊癸化火格')` | ✅ 已覆盖 |

### 2.3 十神组合格局（8个）

**说明**：十神组合格局通常与月令主格并存，作为辅助判断。系统提供独立的诊断规则。

| 格局名称 | 诊断函数 | 状态 |
|---------|---------|------|
| 食神制杀 | `诊断食神制杀` | ✅ 已覆盖 |
| 伤官配印 | `诊断伤官配印` | ✅ 已覆盖 |
| 食神生财 | `诊断食神生财` | ✅ 已覆盖 |
| 伤官生财 | `诊断伤官生财` | ✅ 已覆盖 |
| 官印相生 | `诊断官印相生` | ✅ 已覆盖 |
| 杀印相生 | `诊断杀印相生` | ✅ 已覆盖 |
| 羊刃驾杀 | `诊断羊刃驾杀` | ✅ 已覆盖 |
| 财官双美 | `诊断财官双美` | ✅ 已覆盖 |
| 伤官伤尽 | `诊断伤官伤尽` | ✅ 已覆盖 |
| 枭神夺食 | `诊断枭神夺食` | ✅ 已覆盖 |

### 2.4 普通格局（1个）

| 格局名称 | 诊断函数 | 状态 |
|---------|---------|------|
| 平格 | - | ⚠️ 可选实现（通常不需要诊断） |

---

## 三、破格因素权重体系

### 3.1 正官格专用破格因素

| 破格因素 | 权重 | 描述 |
|---------|------|------|
| 伤官见官 | 10 | 伤官直接克制正官 |
| 官杀混杂 | 8 | 正官七杀并存，格局不清 |
| 官星被合 | 7 | 官星被合化失用 |
| 官星无根 | 6 | 官星在地支无根气 |

### 3.2 七杀格专用破格因素

| 破格因素 | 权重 | 描述 |
|---------|------|------|
| 杀重无制 | 10 | 七杀旺而无制化 |
| 制杀太过 | 8 | 制化七杀太过反失威权 |
| 杀弱身强 | 6 | 七杀太弱无法显威 |

### 3.3 财格专用破格因素

| 破格因素 | 权重 | 适用格局 | 描述 |
|---------|------|---------|------|
| 比劫夺财 | 10 | 正财格、偏财格 | 比劫争夺财星 |
| 财多身弱 | 8 | 正财格、偏财格 | 财星过旺日主不堪 |
| 财星被合 | 7 | 正财格、偏财格 | 财星被合化失用 |

### 3.4 印格专用破格因素

| 破格因素 | 权重 | 适用格局 | 描述 |
|---------|------|---------|------|
| 财星坏印 | 10 | 正印格、偏印格 | 财星克制印星 |
| 印重身埋 | 8 | 正印格、偏印格 | 印星过重反埋没日主 |
| 印星被合 | 6 | 正印格、偏印格 | 印星被合化失用 |

### 3.5 食伤格专用破格因素

| 破格因素 | 权重 | 适用格局 | 描述 |
|---------|------|---------|------|
| 枭神夺食 | 10 | 食神格 | 偏印克制食神 |
| 伤官见官 | 10 | 伤官格 | 伤官克制正官 |
| 食伤过旺 | 7 | 食神格、伤官格 | 食伤过旺泄身太过 |

### 3.6 建禄/阳刃/月劫格专用破格因素

| 破格因素 | 权重 | 适用格局 | 描述 |
|---------|------|---------|------|
| 比劫夺财 | 9 | 月劫格 | 比劫争夺财星 |
| 比劫成群 | 8 | 建禄格、阳刃格、月劫格 | 比劫过多争夺资源 |
| 官杀混杂 | 7 | 建禄格、阳刃格、月劫格 | 官杀并存格局不清 |

### 3.7 专旺格专用破格因素

| 破格因素 | 权重 | 适用格局 | 描述 |
|---------|------|---------|------|
| 格局不纯 | 10 | 专旺格 | 专旺格局不纯粹 |
| 金星破格 | 8 | 曲直仁寿格 | 金星破坏木专旺 |
| 水星破格 | 8 | 炎上格 | 水星破坏火专旺 |
| 木星破格 | 8 | 稼穑格 | 木星破坏土专旺 |
| 火星破格 | 8 | 从革格 | 火星破坏金专旺 |
| 土星破格 | 8 | 润下格 | 土星破坏水专旺 |

### 3.8 从弱格专用破格因素

| 破格因素 | 权重 | 适用格局 | 描述 |
|---------|------|---------|------|
| 日主有根 | 10 | 从弱格 | 日主有根气不从弱 |
| 所从不强 | 8 | 从弱格 | 所从十神力量不足 |

### 3.9 化气格专用破格因素

| 破格因素 | 权重 | 适用格局 | 描述 |
|---------|------|---------|------|
| 化气不成 | 10 | 化气格 | 化气条件不满足 |
| 破格五行 | 8 | 化气格 | 有克制化气五行的力量 |

### 3.10 十神组合格局专用破格因素

#### 食神制杀专用

| 破格因素 | 权重 | 描述 |
|---------|------|------|
| 七杀无力 | 8 | 七杀力量不足无需制伏 |
| 制杀不力 | 9 | 食神力量不足制杀无力 |
| 身弱不任 | 7 | 日主弱不能承受制杀之劳 |
| 印星化杀 | 6 | 印星化解七杀，食神制杀意义减弱 |
| 财星党杀 | 8 | 财星生七杀增强杀力 |

#### 伤官配印专用

| 破格因素 | 权重 | 描述 |
|---------|------|------|
| 伤官无力 | 7 | 伤官力量不足无需配印 |
| 印星不足 | 9 | 印星力量不足制约无力 |
| 身强印重 | 6 | 身强印重埋没才华 |
| 财星坏印 | 8 | 财星克制印星破坏配合 |

#### 通用组合破格因素

| 破格因素 | 权重 | 适用格局 | 描述 |
|---------|------|---------|------|
| 身弱不任 | 7 | 所有组合格局 | 日主弱不能承担格局 |
| 用神无力 | 8 | 所有组合格局 | 关键十神力量不足 |
| 忌神干扰 | 6 | 所有组合格局 | 忌神破坏组合格局 |

---

## 四、救应因素权重体系

### 4.1 通用救应因素

| 救应因素 | 权重 | 对应破格 | 描述 |
|---------|------|---------|------|
| 印星制伤 | 10 | 伤官见官 | 印星制约伤官保护官星 |
| 合杀留官 | 9 | 官杀混杂 | 合去七杀保留正官 |
| 比劫护财 | 8 | 比劫夺财 | 比劫保护财星不被过度争夺 |
| 官星护财 | 8 | 比劫夺财 | 官星制约比劫保护财星 |
| 食伤生财 | 7 | 财多身弱 | 食伤转化生财减轻压力 |

### 4.2 特殊救应因素

| 救应因素 | 权重 | 对应破格 | 描述 |
|---------|------|---------|------|
| 食神制杀 | 10 | 杀重无制 | 食神有效制约七杀 |
| 伤官合杀 | 9 | 杀重无制 | 伤官合住七杀化解压力 |
| 印星化杀 | 8 | 杀重无制 | 印星转化七杀压力 |
| 财星破印 | 8 | 印重身埋 | 财星适当制约过重印星 |
| 官星生印 | 7 | 财星坏印 | 官星生印增强印星力量 |

### 4.3 十神组合格局专用救应因素

#### 通用组合救应

| 救应因素 | 权重 | 对应破格 | 描述 |
|---------|------|---------|------|
| 比劫帮身 | 7 | 身弱不任 | 比劫增强日主力量 |
| 官杀生印 | 8 | 印星不足 | 官杀生印增强印星 |
| 食伤生财 | 7 | 财星无力 | 食伤转化生财 |

#### 专用组合救应

| 救应因素 | 权重 | 对应破格 | 适用组合 | 描述 |
|---------|------|---------|---------|------|
| 合杀留官 | 9 | 官杀混杂 | 食神制杀 | 合去七杀保留正官 |
| 印星制伤 | 8 | 伤官见官 | 伤官配印 | 印星制约伤官 |
| 官星制劫 | 8 | 比劫夺财 | 月劫格 | 官星制约比劫保护财星 |
| 食伤泄秀 | 7 | 比劫成群 | 月劫格 | 食伤转化比劫能量 |
| 印星化杀 | 6 | 官杀混杂 | 月劫格 | 印星化解官杀混杂 |

---

## 五、纯度计算算法

### 5.1 评分计算

```javascript
计算最终纯度(诊断结果) {
  let 扣分 = 0;
  let 加分 = 0;
  
  // 计算破格扣分
  诊断结果.专用破格因素.forEach(破格 => {
    扣分 += 破格.权重;
  });
  
  // 计算救应加分（只针对有对应破格的救应）
  诊断结果.救应因素.forEach(救应 => {
    const 对应破格 = 诊断结果.专用破格因素.find(p => p.因素 === 救应.对应破格);
    if (对应破格) {
      加分 += Math.min(救应.权重, 对应破格.权重); // 加分不超过扣分
    }
  });
  
  // 最终得分
  诊断结果.得分 = Math.max(0, 100 - 扣分 + 加分);
  
  // 确定纯度等级
  if (诊断结果.得分 >= 90) {
    诊断结果.最终纯度 = '真';
  } else if (诊断结果.得分 >= 70) {
    诊断结果.最终纯度 = '假';
  } else if (诊断结果.得分 >= 50) {
    诊断结果.最终纯度 = '一般';
  } else {
    诊断结果.最终纯度 = '破格';
  }
}
```

### 5.2 纯度等级标准

| 等级 | 得分范围 | 特征 | 描述 |
|------|---------|------|------|
| **真** | ≥ 90 | 格局纯粹，用神有力，无破格因素 | 大富大贵，成就显著 |
| **假** | 70-89 | 格局成立但有瑕疵，用神受制 | 小富小贵，起伏较大 |
| **一般** | 50-69 | 格局勉强成立，纯度不高 | 平凡普通，难有大成 |
| **破格** | < 50 | 格局被严重破坏 | 贫贱困苦，多灾多难 |

---

## 六、十神组合格局诊断系统

### 6.1 系统架构

```javascript
class ShishenPatternSystem {
  constructor(bazi) {
    this.bazi = bazi;
    this.通用病理 = poge系统.诊断(bazi);
  }
  
  // 主入口：诊断所有存在的十神组合格局
  诊断所有组合格局(月令主格 = null) {
    const 所有组合 = [];
    
    // 基础组合格局
    if (this.符合食神制杀()) {
      所有组合.push(this.诊断食神制杀(月令主格));
    }
    
    if (this.符合伤官配印()) {
      所有组合.push(this.诊断伤官配印(月令主格));
    }
    
    if (this.符合伤官生财()) {
      所有组合.push(this.诊断伤官生财(月令主格));
    }
    
    if (this.符合食神生财()) {
      所有组合.push(this.诊断食神生财(月令主格));
    }
    
    if (this.符合官印相生()) {
      所有组合.push(this.诊断官印相生(月令主格));
    }
    
    if (this.符合杀印相生()) {
      所有组合.push(this.诊断杀印相生(月令主格));
    }
    
    if (this.符合羊刃驾杀()) {
      所有组合.push(this.诊断羊刃驾杀(月令主格));
    }
    
    if (this.符合财官双美()) {
      所有组合.push(this.诊断财官双美(月令主格));
    }
    
    // 特殊组合
    if (this.符合伤官伤尽()) {
      所有组合.push(this.诊断伤官伤尽(月令主格));
    }
    
    if (this.符合枭神夺食()) {
      所有组合.push(this.诊断枭神夺食(月令主格));
    }
    
    return 所有组合;
  }
}
```

### 6.2 主要组合格局诊断规则

#### 6.2.1 食神制杀诊断

**核心逻辑**：
- 检查七杀力量、食神力量、日主强弱
- 破格因素：七杀无力、制杀不力、身弱不任、印星化杀、财星党杀
- 救应因素：比劫帮身

**诊断函数**：
```javascript
诊断食神制杀(月令主格) {
  const 诊断结果 = {
    组合格局: '食神制杀',
    专用破格因素: [],
    救应因素: [],
    得分: 100,
    纯度: '',
    描述: '',
    与主格关系: this.分析与主格关系(月令主格, '食神制杀')
  };
  
  // 检查成立条件
  if (七杀力量 < 0.3) {
    诊断结果.专用破格因素.push({
      因素: '七杀无力',
      权重: 8,
      描述: '七杀力量不足，无需制伏'
    });
  }
  
  if (食神力量 < 七杀力量 * 0.7) {
    诊断结果.专用破格因素.push({
      因素: '制杀不力',
      权重: 9,
      描述: '食神力量不足，制杀无力'
    });
  }
  
  if (日主力量 < 0.3) {
    诊断结果.专用破格因素.push({
      因素: '身弱不任',
      权重: 7,
      描述: '日主弱不能承受制杀之劳'
    });
  }
  
  // 检查破格因素
  if (this.有印星化杀(this.bazi)) {
    诊断结果.专用破格因素.push({
      因素: '印星化杀',
      权重: 6,
      描述: '印星化解七杀，食神制杀意义减弱'
    });
  }
  
  if (this.有财星党杀(this.bazi)) {
    诊断结果.专用破格因素.push({
      因素: '财星党杀',
      权重: 8,
      描述: '财星生七杀，增强七杀力量'
    });
  }
  
  // 检查救应因素
  if (this.有比劫帮身(this.bazi)) {
    诊断结果.救应因素.push({
      因素: '比劫帮身',
      权重: 7,
      描述: '比劫增强日主力量',
      对应破格: '身弱不任'
    });
  }
  
  this.计算组合纯度(诊断结果);
  return 诊断结果;
}
```

#### 6.2.2 伤官配印诊断

**核心逻辑**：
- 检查伤官力量、印星力量、日主强弱
- 破格因素：伤官无力、印星不足、身强印重、财星坏印
- 救应因素：官杀生印

**诊断函数**：
```javascript
诊断伤官配印(月令主格) {
  const 诊断结果 = {
    组合格局: '伤官配印',
    专用破格因素: [],
    救应因素: [],
    得分: 100,
    纯度: '',
    描述: '',
    与主格关系: this.分析与主格关系(月令主格, '伤官配印')
  };
  
  // 检查成立条件
  if (伤官力量 < 0.3) {
    诊断结果.专用破格因素.push({
      因素: '伤官无力',
      权重: 7,
      描述: '伤官力量不足，无需配印'
    });
  }
  
  if (印星力量 < 伤官力量 * 0.6) {
    诊断结果.专用破格因素.push({
      因素: '印星不足',
      权重: 9,
      描述: '印星力量不足，制约伤官无力'
    });
  }
  
  if (日主力量 > 0.7 && 印星力量 > 伤官力量) {
    诊断结果.专用破格因素.push({
      因素: '身强印重',
      权重: 6,
      描述: '身强印重反埋没才华'
    });
  }
  
  // 检查破格因素
  if (this.有财星坏印(this.bazi)) {
    诊断结果.专用破格因素.push({
      因素: '财星坏印',
      权重: 8,
      描述: '财星克制印星，破坏伤官配印'
    });
  }
  
  // 检查救应因素
  if (this.有官杀生印(this.bazi)) {
    诊断结果.救应因素.push({
      因素: '官杀生印',
      权重: 8,
      描述: '官杀生印增强印星力量',
      对应破格: '印星不足'
    });
  }
  
  this.计算组合纯度(诊断结果);
  return 诊断结果;
}
```

#### 6.2.3 其他组合格局诊断

- **伤官生财**：检查伤官力量、财星力量、日主强弱；破格：伤官无力、财星无力、身弱不任、枭神夺食；救应：比劫帮身、官星护财
- **食神生财**：检查食神力量、财星力量、日主强弱；破格：食神无力、财星无力、身弱不任、枭神夺食；救应：比劫帮身、官星护财
- **羊刃驾杀**：检查羊刃力量、七杀力量、日主强弱；破格：羊刃无力、七杀无力、身弱不任、官杀混杂；救应：食神制杀、印星化杀
- **伤官伤尽**：检查是否完全无官杀；破格：见官杀、身弱不任；救应：有财星转化、有印星制约

### 6.3 与月令主格的关联分析

```javascript
分析与主格关系(月令主格, 组合格局) {
  const 关系映射 = {
    // 食神制杀与各主格的关系
    '食神制杀': {
      '七杀格': '完美配合，化杀为权',
      '正官格': '官杀混杂需处理', 
      '伤官格': '伤官见官不利',
      '食神格': '食神过多泄身',
      'default': '辅助主格发挥'
    },
    
    // 伤官配印与各主格的关系
    '伤官配印': {
      '伤官格': '完美配合，才华得展',
      '正官格': '伤官见官破格',
      '七杀格': '杀印相生更佳',
      '印格': '印重埋没才华',
      'default': '制约伤官保护主格'
    }
  };
  
  const 格局关系 = 关系映射[组合格局] || {};
  return 格局关系[月令主格] || 格局关系['default'] || '与主格配合一般';
}
```

---

## 七、格局覆盖情况分析

### 7.1 系统已有格局（35个）

#### ✅ 已覆盖的格局（35个）

**月令主格（11/11）**：
- ✅ 正官格
- ✅ 七杀格
- ✅ 正财格
- ✅ 偏财格
- ✅ 正印格
- ✅ 偏印格
- ✅ 食神格
- ✅ 伤官格
- ✅ 建禄格
- ✅ 阳刃格
- ✅ 月劫格

**特殊格局（15/15）**：
- ✅ 曲直仁寿格
- ✅ 炎上格
- ✅ 稼穑格
- ✅ 从革格
- ✅ 润下格
- ✅ 从财格
- ✅ 从杀格
- ✅ 从儿格
- ✅ 从势格
- ✅ 甲己化土格
- ✅ 乙庚化金格
- ✅ 丙辛化水格
- ✅ 丁壬化木格
- ✅ 戊癸化火格

**十神组合格局（10/10）**：
- ✅ 食神制杀
- ✅ 伤官配印
- ✅ 食神生财
- ✅ 伤官生财
- ✅ 财官双美
- ✅ 杀印相生
- ✅ 官印相生
- ✅ 羊刃驾杀
- ✅ 伤官伤尽
- ✅ 枭神夺食

**普通格局（1/1）**：
- ⚠️ 平格（可选，通常不需要诊断）

#### ❌ 未覆盖的格局（0个）

**全部格局已覆盖！**

### 7.2 架构中有但系统没有的格局

**无** - 架构中所有格局都在系统中有对应实现。

### 7.3 系统中有但架构未覆盖的格局

**无** - 所有格局都已覆盖。

---

## 八、月劫格诊断规则

### 8.1 诊断函数

```javascript
诊断月劫格(诊断结果) {
  const { bazi } = this;
  
  // 检查专用破格因素
  if (this.比劫过重(bazi)) {
    诊断结果.专用破格因素.push({
      因素: '比劫成群',
      权重: 8,
      描述: '比劫过多争夺资源'
    });
  }
  
  if (this.官杀混杂(bazi)) {
    诊断结果.专用破格因素.push({
      因素: '官杀混杂',
      权重: 7,
      描述: '官杀并存格局不清'
    });
  }
  
  if (this.财星被夺(bazi)) {
    诊断结果.专用破格因素.push({
      因素: '比劫夺财',
      权重: 9,
      描述: '比劫争夺财星'
    });
  }
  
  // 检查救应因素
  if (this.有官星制劫(bazi)) {
    诊断结果.救应因素.push({
      因素: '官星制劫',
      权重: 8,
      描述: '官星制约比劫保护财星',
      对应破格: '比劫夺财'
    });
  }
  
  if (this.有食伤泄秀(bazi)) {
    诊断结果.救应因素.push({
      因素: '食伤泄秀',
      权重: 7,
      描述: '食伤转化比劫能量',
      对应破格: '比劫成群'
    });
  }
  
  if (this.有印星化杀(bazi)) {
    诊断结果.救应因素.push({
      因素: '印星化杀',
      权重: 6,
      描述: '印星化解官杀混杂',
      对应破格: '官杀混杂'
    });
  }
  
  this.筛选通用病理(诊断结果, '月劫格');
}
```

### 8.2 破格因素权重

| 破格因素 | 权重 | 描述 |
|---------|------|------|
| 比劫夺财 | 9 | 比劫争夺财星 |
| 比劫成群 | 8 | 比劫过多争夺资源 |
| 官杀混杂 | 7 | 官杀并存格局不清 |

### 8.3 救应因素权重

| 救应因素 | 权重 | 对应破格 | 描述 |
|---------|------|---------|------|
| 官星制劫 | 8 | 比劫夺财 | 官星制约比劫保护财星 |
| 食伤泄秀 | 7 | 比劫成群 | 食伤转化比劫能量 |
| 印星化杀 | 6 | 官杀混杂 | 印星化解官杀混杂 |

---

## 九、需要补充的内容

### 9.1 已全部覆盖

所有格局的诊断规则都已设计完成，无需补充。

### 9.2 可选补充

1. **平格诊断**（通常不需要，但可以添加基础判断）

---

## 十、实现优先级

### 10.1 第一阶段：核心格局（必须）
1. ✅ 正官格、七杀格、财格、印格、食伤格
2. ✅ 建禄格、阳刃格、月劫格

### 10.2 第二阶段：特殊格局（必须）
1. ✅ 专旺格（5个）
2. ✅ 从弱格（4个）
3. ✅ 化气格（5个）

### 10.3 第三阶段：十神组合格局（必须）
1. ✅ 食神制杀、伤官配印
2. ✅ 食神生财、伤官生财
3. ✅ 官印相生、杀印相生
4. ✅ 羊刃驾杀、财官双美
5. ✅ 伤官伤尽、枭神夺食

### 10.4 第四阶段：可选格局（按需）
1. ⚠️ 平格（1个）

---

## 十一、数据结构设计

### 11.1 月令主格诊断结果格式

```javascript
{
  格局: "正官格",
  最终纯度: "假",  // '真' | '假' | '一般' | '破格'
  得分: 75,        // 0-100分
  专用破格因素: [
    {
      因素: "伤官见官",
      权重: 10,
      描述: "伤官直接克制正官，严重破格"
    }
  ],
  救应因素: [
    {
      因素: "印星制伤",
      权重: 10,
      描述: "印星制约伤官保护官星",
      对应破格: "伤官见官"
    }
  ],
  通用病理: [...],  // 从poge.js获取
  描述: "格局成立但有瑕疵，有救应但不够完美。破格因素：伤官见官、官星被合；救应因素：印星制伤"
}
```

### 11.2 十神组合格局诊断结果格式

```javascript
{
  组合格局: "食神制杀",
  最终纯度: "真",  // '真' | '假' | '一般' | '破格'
  得分: 88,        // 0-100分
  专用破格因素: [],
  救应因素: [
    {
      因素: "比劫帮身",
      权重: 7,
      描述: "比劫增强日主力量",
      对应破格: "身弱不任"
    }
  ],
  与主格关系: "完美配合，化杀为权",  // 与月令主格的关系
  描述: "七杀有制，食神有力，日主强旺，为大贵之格"
}
```

### 11.3 完整输出格式

```javascript
{
  月令主格: {
    格局: "七杀格",
    纯度: "真",
    得分: 85,
    // ... 其他主格信息
  },
  
  十神组合格局: [
    {
      组合格局: "食神制杀",
      纯度: "真", 
      得分: 88,
      专用破格因素: [],
      救应因素: [
        {因素: "比劫帮身", 权重: 7, 描述: "比劫增强日主力量"}
      ],
      与主格关系: "完美配合，化杀为权",
      描述: "七杀有制，食神有力，日主强旺，为大贵之格"
    },
    {
      组合格局: "官印相生",
      纯度: "假",
      得分: 72,
      专用破格因素: [
        {因素: "印星不足", 权重: 9, 描述: "印星力量不足生官无力"}
      ],
      救应因素: [],
      与主格关系: "辅助主格发挥",
      描述: "官印相生但印星不足，格局层次降低"
    }
  ],
  
  综合评估: {
    整体纯度: "中清·略有瑕疵",
    主要特质: "权威胆识，管理能力强",
    发展建议: "宜从事管理、武职、技术领导岗位"
  }
}
```

---

## 十二、总结

### 12.1 覆盖情况

- **已覆盖**：35个格局（月令主格11个 + 特殊格局15个 + 十神组合10个）
- **未覆盖**：0个
- **可选补充**：1个（平格）

### 12.2 下一步行动

1. ✅ 确认架构方案（本文档）
2. ⏳ 实现所有诊断函数
3. ⏳ 集成到 `patternPurity.js` 和 `shishenPatternSystem.js`
4. ⏳ 测试验证

---

**文档版本**：v1.0  
**创建日期**：2024年  
**最后更新**：2024年

