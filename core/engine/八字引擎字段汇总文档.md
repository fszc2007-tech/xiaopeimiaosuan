# 八字引擎字段汇总文档

## 概述

本文档汇总了 `engine/` 目录下八字引擎能够计算的所有字段和功能模块。

**引擎版本**: v6.0  
**最后更新**: 2024年11月

---

## 一、基础四柱信息（Core Pillars）

### 1.1 四柱干支
- **年柱** (`pillars.year`)
  - `stem`: 年干（天干）
  - `branch`: 年支（地支）
- **月柱** (`pillars.month`)
  - `stem`: 月干
  - `branch`: 月支
- **日柱** (`pillars.day`)
  - `stem`: 日干（日主）
  - `branch`: 日支
- **时柱** (`pillars.hour`)
  - `stem`: 时干
  - `branch`: 时支

### 1.2 四柱扩展信息（每柱）
- `nayin`: 纳音（如"大林木"、"石榴木"）
- `canggan`: 藏干列表（纯文本数组）
- `hidden_tagged`: 藏干带标签（如 `[["庚","本"],["壬","中"],["戊","余"]]`）
- `shishen`: 主星（十神，日柱为"元男"/"元女"）
- `sub_stars`: 副星（藏干对应的十神数组）
- `zizuo`: 自坐（十二长生表述）
- `self_sit`: 自坐（同 zizuo）
- `xingyun`: 星运（预留字段）
- `shensha`: 神煞列表（数组）

---

## 二、命理基础（Mingli）

### 2.1 十神（Ten Gods）
- **主星**：正官、七杀、正印、偏印、正财、偏财、食神、伤官、比肩、劫财
- **计算方式**：基于日主天干与其他天干/藏干的关系
- **位置**：每柱的主星和副星

### 2.2 藏干（Hidden Stems）
- **本气**：地支主气（权重最高）
- **中气**：地支中气（权重中等）
- **余气**：地支余气（权重最低）
- **计算模块**：`engine/mingli/hidden.js`

### 2.3 纳音（Na Yin）
- **计算方式**：基于天干地支组合
- **示例**：甲子→海中金、乙丑→海中金
- **计算模块**：`engine/mingli/nayin.js`

### 2.4 十二长生（Stage 12）
- **状态**：长生、沐浴、冠带、临官、帝旺、衰、病、死、墓、绝、胎、养
- **计算方式**：基于日主天干与地支的关系
- **应用**：自坐、星运等
- **计算模块**：`engine/mingli/stage12.js`

### 2.5 地支关系（Branch Relationships）
- **六合**：子丑合、寅亥合、卯戌合、辰酉合、巳申合、午未合
- **三合**：申子辰、寅午戌、亥卯未、巳酉丑
- **三会**：寅卯辰、巳午未、申酉戌、亥子丑
- **六冲**：子午冲、丑未冲、寅申冲、卯酉冲、辰戌冲、巳亥冲
- **三刑**：无恩之刑、恃势之刑、无礼之刑
- **六害**：子未害、丑午害、寅巳害、卯辰害、申亥害、酉戌害
- **相破**：子酉破、寅亥破、卯午破、辰丑破、巳申破、未戌破
- **计算模块**：`engine/mingli/branchRelationships.js`

### 2.6 天干关系（Stem Relationships）
- **天干五合**：甲己合、乙庚合、丙辛合、丁壬合、戊癸合
- **天干四冲**：甲庚冲、乙辛冲、丙壬冲、丁癸冲
- **计算模块**：`engine/mingli/stemRelationships.js`

### 2.7 宫位（Palaces）
- **命宫** (`mingGong`)
  - `stem`: 命宫天干
  - `branch`: 命宫地支
  - `ganzhi`: 干支组合
  - `palaceName`: 宫位名称
  - `interpretation`: 解读
  - `calculationSteps`: 计算步骤
- **胎元** (`taiYuan`)
  - 同上结构
- **身宫** (`shenGong`)
  - 同上结构
- **命身关系** (`mingShenRelation`): 关系描述
- **计算模块**：`engine/mingli/palaces.js`

---

## 三、神煞（Shen Sha）

### 3.1 基础神煞
- **天乙贵人** (`checkTianYi`)
- **文昌贵人** (`checkWenChang`)
- **计算模块**：`engine/shensha/basic.js`

### 3.2 扩展神煞
- **太极贵人**
- **月德贵人**
- **天德贵人**
- **红鸾**
- **天喜**
- **计算模块**：`engine/shensha/extended.js`

### 3.3 组合神煞（基于三合局）
- **桃花**（咸池）
- **驿马**
- **将星**
- **华盖**
- **孤辰**
- **寡宿**
- **亡神**
- **丧门**
- **吊客**
- **披麻**
- **德秀贵人**
- **龙德贵人**
- **流霞**
- **月德合**
- **天德合**
- **国印贵人**
- **天厨贵人**
- **计算模块**：`engine/shensha/group.js`、`engine/index.js` (computeShensha)

### 3.4 空亡（Kong Wang）
- **年空亡**：基于年柱干支索引
- **月空亡**：基于月柱干支索引
- **日空亡**：基于日柱干支索引
- **计算模块**：`engine/shensha/kongwang.js`

### 3.5 流年神煞
- **亡神**（流年）
- **劫煞**（流年）
- **计算模块**：`engine/shensha/liunian.js`

### 3.6 神煞数据结构
```typescript
{
  hits_by_pillar: {
    "年柱": ["天乙贵人", "太极贵人", ...],
    "月柱": ["亡神", "文昌", ...],
    "日柱": ["红鸾", "桃花", ...],
    "时柱": ["天乙贵人", ...]
  }
}
```

---

## 四、分析模块（Analysis）

### 4.1 日主强弱（Day Master Strength）
- **分数** (`score`): 0.0 - 1.0
- **等级** (`band`): 
  - `从弱` (0.0 - 0.22)
  - `身弱` (0.22 - 0.35)
  - `身偏弱` (0.35 - 0.45，当耗身 > 1.2 × 帮身)
  - `平衡` (0.45 - 0.50)
  - `身偏强` (0.50 - 0.62，当帮身 > 1.2 × 耗身)
  - `身强` (0.62 - 0.85)
  - `从强` (0.85 - 1.0)
- **详细分解** (`detail`):
  - `w_month`: 得令（月令权重，0.0 - 1.0）
  - `root`: 得地（通根权重，0.0 - 1.0）
  - `help`: 得助（比劫+印星总力量）
  - `drain`: 耗身（财官食伤有效力量，已扣除印星化杀）
  - `biPower`: 比劫力量
  - `printPower`: 印星力量
- **从格闸门条件（V3.1）**:
  - **从强闸门**：
    1. 印比力量 ≥ 1.6 × 财官食伤
    2. 财官食伤 ≤ 0.55
    3. 得令 ≥ 0.7 或 得地 ≥ 0.9
    4. **✅ 官杀无通根**（有官杀根气则降档为"身强"）
  - **从弱闸门**：
    1. 财官食伤 ≥ 1.6 × 印比
    2. 印比 ≤ 0.45
    3. 不得令（w_month ≤ 0.4）且无强根（root ≤ 0.6）
- **学派支持**：子平、盲派
- **计算模块**：`engine/analysis/daymaster.js`

### 4.2 五行分布（Wu Xing）
- **五行占比** (`wuxingPercent`):
  - `木`: 百分比
  - `火`: 百分比
  - `土`: 百分比
  - `金`: 百分比
  - `水`: 百分比
- **计算方式**：天干 + 藏干（加权）+ 地支本气（环境加权）
- **总和**：100%
- **计算模块**：`engine/analysis/wuxing.js`

### 4.3 喜用神/忌神（Favored/Avoid）
- **喜用神** (`favored`): 五行数组（按稀缺度排序）
- **忌神** (`avoid`): 五行数组（按稀缺度排序）
- **十神提示** (`tenGodsHint`): 文字说明
- **判断规则**：

| 档位 | 喜用神 | 忌神 | 原理 |
|-----|-------|------|------|
| **身强** | 食伤（泄）、财星（耗）、官杀（克） | 印星、比劫 | 需制化多余能量 |
| **身弱** | 印星、比劫 | 食伤、财星、官杀 | 需生扶日主 |
| **从强** | 印星、比劫 | 食伤、财星、官杀 | 顺势而为，不可逆 |
| **从弱** | 食伤、财星、官杀 | 印星、比劫 | 顺势而为，不可逆 |

- **⚠️ 注意**：「从强」与「身强」喜忌**完全相反**！
  - **从强**：极旺到成格，顺从势力，喜印比继续强
  - **身强**：普通身强，需要制化平衡，喜食伤财官
- **计算模块**：`engine/analysis/favored.js`

### 4.4 格局判断（Structure）
- **格局名称** (`structure`): 如"正官格"、"偏印格"、"食神制杀"等
- **置信度** (`confidence`): 0.0 - 1.0
- **判断理由** (`reasons`): 数组
- **十神权重** (`W`):
  - `guan`: 官杀总权重
  - `zGuan`: 正官权重
  - `sha`: 七杀权重
  - `yin`: 印星总权重
  - `zYin`: 正印权重
  - `pYin`: 偏印权重
  - `cai`: 财星总权重
  - `shi`: 食伤总权重
  - `shishen`: 食神权重
  - `shang`: 伤官权重
  - `bi`: 比劫总权重
- **格局判断规则（V3.1 更新）**：
  - **月令主格**（正八格）：
    - 正官格、七杀格、正财格、偏财格、食神格、伤官格
    - **正印格**：正印权重 > 0.30 或（正印透干且权重 > 0.25）
    - **枭印格**：偏印权重 > 0.30 或（偏印透干且权重 > 0.25）
  - **外格**：
    - 建禄格：月干在月支禄位
    - 阳刃格：月支为日主帝旺且为劫财
    - **月劫格**：月支藏干透出为比肩/劫财（非建禄非阳刃）
  - **特殊格局**：
    - 专旺格/从强格：印比极旺，财官食伤无根
    - 从弱格：财官食伤极旺，印比无根
- **学派支持**：子平、盲派
- **计算模块**：`engine/analysis/structure.js`

### 4.5 清浊等级（Purity）
- **分数** (`score`): 0 - 100
- **等级** (`level`): 如"中清"、"清"、"浊"等
- **详细分解** (`details`):
  - `yongshenPurity`: 用神纯度 (40%)
  - `wuxingFlow`: 五行流通 (30%)
  - `shishenMatch`: 十神配合 (20%)
  - `seasonBalance`: 调候得失 (10%)
- **计算模块**：`engine/analysis/purity.js`

### 4.6 体用分析（Ti Yong）
- **承载度** (`carryingCapacity`): 0.0 - 1.0
- **体势** (`bodyStrength`): 自我能力基础
- **用势** (`useStrength`): 用神力量
- **通关度** (`passThroughDegree`): 体用流通程度
- **破坏扣分** (`destructionPenalty`): 破坏模式扣分
- **等级** (`capacityLevel`): 极高/高/中上/中等/中下/低/极低
- **解读** (`interpretation`): 文字说明
- **计算模块**：`engine/analysis/tiyong.js`

### 4.7 做功分析（Do Gong）
- **十神关系图** (`graph`): 生、克、合、冲、刑、害关系
- **强度映射** (`strengthMap`): 各十神强度
- **最强做功路径** (`strongestPaths`): 路径数组
- **做功类型统计** (`workTypeSummary`): 克制、化用、生助、合取
- **核心做功线** (`coreLine`): 主要做功路径
- **计算模块**：`engine/analysis/dogong.js`

### 4.8 宫位分析（Palaces Analysis）
- **命宫** (`mingGong`): 同 mingli/palaces.js
- **胎元** (`taiYuan`): 同 mingli/palaces.js
- **身宫** (`shenGong`): 同 mingli/palaces.js
- **命身关系** (`mingShenRelation`): 关系描述
- **计算模块**：`engine/analysis/palaces.js`（重新导出）

### 4.9 时间线分析（Timeline）
- **大运分析** (`luckAnalysis`):
  - `yunInfo`: 大运信息
  - `yunData`: 大运数据
  - `comprehensiveScore`: 综合评分
  - `scoreLevel`: 评分等级
  - `chongHeEffects`: 冲合效果
  - `wangShuaiChanges`: 旺衰变化
  - `workPathsAnalysis`: 做功路径分析
  - `bodyUseBalance`: 体用平衡
  - `suggestions`: 建议
- **流年分析** (`flowYearAnalysis`): 同上结构
- **流月分析** (`flowMonthAnalysis`): 同上结构
- **计算模块**：`engine/analysis/timeline.js`

### 4.10 破格因素（Po Ge）
- **破格检查** (`poGeFactors`): 破格因素列表
- **计算模块**：`engine/analysis/poge.js`

---

## 五、大运流年（Fortune）

### 5.1 起运信息（Qi Yun）
- **起运年龄** (`qi.years`): 岁数
- **起运月数** (`qi.months`): 月数
- **起运时间** (`qi.startTime`): UTC 时间

### 5.2 大运方向（Yun Direction）
- **方向** (`dir`): `'shun'` (顺) 或 `'ni'` (逆)
- **判断规则**：阳男阴女顺行，阴男阳女逆行

### 5.3 大运序列（Luck Cycle）
- **大运列表** (`luck_cycle`): 数组
  - 每个大运包含：
    - `stem`: 大运天干
    - `branch`: 大运地支
    - `ganzhi`: 干支组合
    - `shishen`: 十神
    - `sub_stars`: 副星
    - `nayin`: 纳音
    - `canggan`: 藏干
    - `hidden_tagged`: 藏干带标签
    - `zizuo`: 自坐
    - `shensha`: 神煞列表
    - `startAge`: 起始年龄（整岁）
    - `endAge`: 结束年龄（整岁）
    - `ageRange`: 年龄区间字符串
    - `startUTC`: 实际起运时间（精确到月）
    - `endUTC`: 结束时间

### 5.4 流年（Flow Years）
- **当前流年** (`flow_years`): 数组
  - 结构同大运，但基于流年干支

### 5.5 流月（Flow Months）
- **当前流月** (`flow_months`): 数组
  - 结构同大运，但基于流月干支

### 5.6 计算模块
- **主模块**：`engine/fortune/index.js`
- **功能**：
  - `computeAllFortunes`: 计算所有大运流年信息
  - `luckPillars`: 生成大运序列

---

## 六、天文计算（Astronomy）

### 6.1 太阳黄经
- **太阳黄经** (`solarLongitude`): 度数（0-360°）
- **计算模块**：`engine/astronomy/solar.js`

### 6.2 节气
- **24 节气**：春分、清明、谷雨、立夏、小满、芒种、夏至、小暑、大暑、立秋、处暑、白露、秋分、寒露、霜降、立冬、小雪、大雪、冬至、小寒、大寒、立春、雨水、惊蛰
- **节气窗口** (`solarWindow`): 上一个/下一个节气
- **计算模块**：`engine/astronomy/terms.js`

### 6.3 真太阳时（True Solar Time）
- **真太阳时修正** (`applyTrueSolarTime`): 基于经度的时差修正
- **计算模块**：`engine/astronomy/tst.js`

---

## 七、干支计算（Gan Zhi）

### 7.1 年柱
- **年柱计算** (`yearPillarByLichun`): 基于立春
- **计算模块**：`engine/ganzhi/index.js`

### 7.2 月柱
- **月柱计算** (`monthPillar`): 基于节气
- **计算模块**：`engine/ganzhi/index.js`

### 7.3 日柱
- **日柱计算** (`dayPillar`): 基于公历日期
- **计算模块**：`engine/ganzhi/index.js`

### 7.4 时柱
- **时柱计算** (`hourPillar`): 基于日干和时辰
- **计算模块**：`engine/ganzhi/index.js`、`engine/ganzhi/hour.js`

### 7.5 日历转换
- **公历转农历** (`solarToLunar`)
- **农历转公历** (`lunarToSolar`)
- **计算模块**：`engine/ganzhi/calendar.js`

---

## 八、农历（Lunar）

### 8.1 农历转换
- **公历转农历** (`solarToLunar`)
- **农历转公历** (`lunarToSolar`)
- **闰月处理** (`isLeap`)
- **计算模块**：`engine/lunar/index.js`、`engine/lunar/converter.js`

### 8.2 农历数据
- **农历数据表** (`LUNAR_DATA`): 1900-2100 年农历数据
- **计算模块**：`engine/lunar/data.js`

---
## 九、工具函数（Utils）

### 9.1 时区处理
- **时区解析** (`parseTZFlexible`): 解析灵活的时区格式
  - 支持格式：`+08:00`、`+8`、`+0800`、`UTC+8`、`GMT+0800`
  - 返回：时区偏移（分钟数）
- **时区格式化** (`formatTZ`): 格式化为 `+HH:MM` 格式
- **日期差计算** (`daysBetweenUTC`): 计算两个 UTC 日期之间的天数差
- **计算模块**：`engine/utils/timezone.js`

### 9.2 性别处理
- **性别标准化** (`normalizeGender`): 统一处理各种性别输入格式
  - 支持：中文（男/女）、英文（male/female）、数字（1/0）、布尔值等
  - 返回：`'male'` | `'female'` | `'unknown'`
- **性别判断** (`isMale`): 判断是否为男性
- **性别判断** (`isFemale`): 判断是否为女性
- **计算模块**：`engine/utils/gender.js`

### 9.3 数学工具
- **数学计算函数**：各种辅助计算函数
- **计算模块**：`engine/utils/math.js`

### 9.4 常量定义
- **天干地支** (`STEMS`, `BRANCHES`): 天干地支数组
- **节气名称** (`SOLAR_NAMES`): 24 节气名称数组
- **月干起法表** (`MONTH_STEM_BY_YEAR_STEM`): 年上起月表
- **时干起法表** (`HOUR_START_WUSHU`, `HOUR_START_ALT`): 五鼠遁时表
- **天干五行** (`STEM_ELEMENT`): 天干对应的五行
- **天干阴阳** (`STEM_YY`): 天干对应的阴阳属性
- **地支五行** (`BRANCH_ELEMENT`): 地支对应的五行
- **地支阴阳** (`BRANCH_YY`): 地支对应的阴阳属性
- **五行生克** (`GENERATES`, `CONTROLS`): 五行相生相克关系
- **藏干表** (`HIDDEN_STEMS`): 地支藏干数据
- **季节权重** (`SEASON_WEIGHT`): 季节对五行的支持权重
- **月份索引** (`MONTH_INDEX`): 地支对应的月份索引
- **计算模块**：`engine/utils/constants.js`

---

## 十、主引擎接口（BaziEngine）

### 10.1 引擎类
- **类名**：`BaziEngine`
- **版本**：v6.0
- **主模块**：`engine/index.js`

### 10.2 核心方法

#### 10.2.1 compute(birthJson)
**功能**：计算完整的八字命盘

**输入参数** (`birthJson`):
```typescript
{
  sex: string;              // 性别（支持多种格式）
  calendar_type: string;    // 日历类型："公历" | "农历"
  year: number;             // 年份
  month: number;            // 月份
  day: number;              // 日期
  hour: number | string;    // 小时（支持数字或字符串）
  minute: number | string;  // 分钟（支持数字或字符串）
  tz: string;               // 时区（如 "+08:00"）
  use_tst?: boolean;        // 是否使用真太阳时（默认 false）
  hour_ref?: string;        // 时辰参考："midnight" | "prev_zi"（默认 "midnight"）
  place?: string;           // 出生地点（可选）
  longitude?: number;       // 经度（真太阳时必需）
  std_meridian?: number;    // 标准子午线（默认 120）
  isLeap?: boolean;         // 是否为闰月（农历输入时）
}
```

**返回结果**:
```typescript
{
  pillars: {                // 四柱信息
    year: PillarInfo,       // 年柱（包含所有扩展信息）
    month: PillarInfo,      // 月柱
    day: PillarInfo,        // 日柱
    hour: PillarInfo        // 时柱
  },
  derived: {                // 衍生信息
    luck_cycle: LuckInfo[], // 大运序列（8 步大运）
    flow_years: FlowInfo[], // 当前流年
    flow_months: FlowInfo[],// 当前流月
    qi_yun: {               // 起运信息
      years: number,        // 起运年龄（岁）
      months: number,       // 起运月数
      startTime: Date       // 起运时间
    },
    yun_direction: string,  // 大运方向："shun" | "ni"
    start_age: number       // 起运年龄（整岁）
  },
  shensha: {                // 神煞汇总
    hits_by_pillar: {
      "年柱": string[],
      "月柱": string[],
      "日柱": string[],
      "时柱": string[]
    }
  },
  meta: {                   // 元数据
    version: string,        // 引擎版本
    calendar_from: string,  // 日历来源说明
    lichun_time: string     // 立春时间（ISO 格式）
  }
}
```

### 10.3 辅助方法

#### 10.3.1 enrichPillar(pillar, dayStem, sex, isDay, calculateShensha, allPillars)
**功能**：丰富柱信息，添加纳音、藏干、十神、神煞等

#### 10.3.2 calculateShensha(pillars)
**功能**：计算四柱神煞并设置到各柱

#### 10.3.3 computeShensha(pillars)
**功能**：完整的神煞计算函数（内部方法）

#### 10.3.4 addYearsMonthsUTC(dateUTC, years, months)
**功能**：在 UTC 日期上加"岁/月"（精确到月）

---

## 十一、数据结构示例

### 11.1 PillarInfo（柱信息）
```typescript
{
  stem: string;              // 天干（如 "甲"）
  branch: string;            // 地支（如 "子"）
  nayin: string;             // 纳音（如 "海中金"）
  canggan: string[];         // 藏干列表（如 ["癸", "辛"]）
  hidden_tagged: [string, string][]; // 藏干带标签（如 [["癸","本"],["辛","中"]]）
  shishen: string;           // 主星（十神，如 "正官"）
  sub_stars: string[];       // 副星（藏干十神，如 ["正印", "偏财"]）
  zizuo: string;             // 自坐（十二长生，如 "长生"）
  self_sit: string;          // 自坐（同 zizuo）
  xingyun: string;           // 星运（预留）
  shensha: string[]          // 神煞列表（如 ["天乙贵人", "太极贵人"]）
}
```

### 11.2 LuckInfo（大运信息）
```typescript
{
  stem: string;              // 大运天干
  branch: string;            // 大运地支
  ganzhi: string;            // 干支组合
  shishen: string;           // 十神
  sub_stars: string[];       // 副星
  nayin: string;             // 纳音
  canggan: string[];         // 藏干
  hidden_tagged: [string, string][]; // 藏干带标签
  zizuo: string;             // 自坐
  shensha: string[];         // 神煞列表
  startAge: number;          // 起始年龄（整岁）
  endAge: number;            // 结束年龄（整岁）
  ageRange: string;          // 年龄区间（如 "8-18岁"）
  startUTC: Date;            // 实际起运时间（精确到月）
  endUTC: Date               // 结束时间
}
```

### 11.3 分析结果数据结构

#### 11.3.1 日主强弱结果（strengthAnalysis）
```typescript
{
  score: number;             // 0 - 100（百分制）
  label: string;             // "从弱" | "身弱" | "身偏弱" | "平衡" | "身偏强" | "身强" | "从强"
  factors: {
    得令: boolean;           // w_month > 0.4
    得地: boolean;           // root > 0.3
    得生: boolean;           // help > 0.2
    得助: boolean;           // help > 0.15
  };
  // ✅ V3.1 新增：返回完整数值数据
  detail: {
    w_month: number;         // 得令（0.0 - 1.0）
    root: number;            // 得地（0.0 - 1.0+）
    help: number;            // 得助（比劫+印星总力量）
    drain: number;           // 耗身（有效力量，已扣除印星化杀）
    biPower: number;         // 比劫力量
    printPower: number;      // 印星力量
  }
}
```

#### 11.3.2 五行分布结果
```typescript
{
  木: number;                // 百分比（0-100）
  火: number;
  土: number;
  金: number;
  水: number;
}
```

#### 11.3.3 喜用神结果
```typescript
{
  favored: string[];         // 喜用神五行数组（如 ["水", "木"]）
  avoid: string[];           // 忌神五行数组（如 ["火", "土"]）
  tenGodsHint: string[]      // 十神提示（如 ["用印、比劫"]）
}
```


