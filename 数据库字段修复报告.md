# 数据库字段修复报告

## 📋 修复时间
2025-12-25

## 🔴 发现的问题

根据 migration 008 (`008_optimize_indexes_phone_only.sql`)，`users` 表和 `verification_codes` 表的 `email` 字段已被删除，但代码中仍有多处使用这些字段，导致数据库操作失败。

## ✅ 已修复的文件和位置

### 1. `core/src/modules/auth/authService.ts`
- **行 286**: `INSERT INTO users` - 移除 `email` 字段
- **行 134**: `INSERT INTO verification_codes` - 已正确（之前已修复）

### 2. `core/src/modules/auth/thirdPartyAuthService.ts`
- **行 247**: `INSERT INTO users` - 移除 `email` 字段

### 3. `core/src/modules/admin/adminUserService.ts`
- **行 66**: `WHERE` 条件 - 移除 `email LIKE` 搜索
- **行 170-178**: 移除 `email` 重复检查逻辑
- **行 188**: `INSERT INTO users` - 移除 `email` 字段
- **行 223**: `SELECT * FROM users WHERE email = ?` - 改为 `WHERE phone = ?`
- **行 250**: `INSERT INTO users` - 移除 `email`，改用 `phone`
- **行 230, 277**: 返回对象 - 移除 `email`，改用 `phone`
- **行 297**: `SELECT * FROM users WHERE email = ?` - 改为 `WHERE phone = ?`
- **常量 CURSOR_TEST_ACCOUNT**: 从 `email: 'cursor_test@xiaopei.com'` 改为 `phone: '+8613800000000'`

### 4. `core/src/jobs/accountDeletionJob.ts`
- **行 324**: `UPDATE users SET` - 移除 `email = ?` 字段

### 5. `core/src/routes/dev.ts`
- **行 96**: `SELECT` 语句 - 移除 `email` 字段

### 6. `core/src/types/database.ts`
- **行 17**: `UserRow` 接口 - 移除 `email?: string` 字段，添加注释说明

## 📝 修复说明

### Migration 008 变更
根据 `008_optimize_indexes_phone_only.sql`：
- ✅ `users` 表：删除 `email` 字段和 `idx_email` 索引
- ✅ `verification_codes` 表：删除 `email` 字段和 `idx_email` 索引
- ✅ `phone` 字段扩展为 `VARCHAR(32)`，支持 E.164 格式
- ✅ `phone` 设为唯一索引（登录凭证）

### 修复策略
1. **INSERT 语句**：移除 `email` 字段和对应的参数
2. **UPDATE 语句**：移除 `email = ?` 字段
3. **SELECT 语句**：移除 `email` 字段（如果使用 `SELECT *`，数据库会自动处理）
4. **WHERE 条件**：移除 `email` 相关的查询条件
5. **类型定义**：更新 `UserRow` 接口，移除 `email` 字段
6. **常量配置**：`CURSOR_TEST_ACCOUNT` 改用 `phone` 代替 `email`

## ⚠️ 注意事项

1. **第三方登录**：`auth_identities` 表仍然保留 `email` 字段（用于存储第三方平台的邮箱），这是正确的。
2. **管理员用户**：`admin_users` 表仍然保留 `email` 字段，这是正确的。
3. **Cursor 测试账号**：已从使用 `email` 改为使用 `phone` (`+8613800000000`) 作为唯一标识。

## ✅ 验证

- ✅ 所有 TypeScript 编译通过（无 linter 错误）
- ✅ 所有 SQL 语句已更新
- ✅ 类型定义已同步更新
- ✅ 常量配置已更新

## 🚀 后续步骤

1. **重新部署后端**：确保修复生效
2. **测试验证**：
   - 测试用户注册/登录
   - 测试第三方登录（Google）
   - 测试管理员创建用户
   - 测试 Cursor 测试账号功能
3. **监控日志**：观察是否有数据库字段错误

## 📊 修复统计

- **修复文件数**: 6 个
- **修复位置数**: 10+ 处
- **类型定义更新**: 1 处
- **常量配置更新**: 1 处

所有数据库字段错误已修复完成！

