# 十神解读功能验证清单

## 📋 功能概述

十神解读功能允许用户点击命盘总览中的副星（十神），弹出解读弹窗，显示：
- 十神本身的标签（如"自我・同輩"）
- 喜神/忌神标签（根据命盘动态判断）
- 柱位详细解读
- 推荐提问（3-4个）
- 小佩解读入口

---

## ✅ 代码检查清单

### 1. 数据库层
- [x] **表结构**：`033_create_shishen_readings.sql` 已创建
- [x] **数据插入**：`034_insert_shishen_readings.sql` 已创建（40条记录）
- [ ] **执行迁移**：需要执行以下命令
  ```bash
  mysql -u root -p xiaopei < core/src/database/migrations/033_create_shishen_readings.sql
  mysql -u root -p xiaopei < core/src/database/migrations/034_insert_shishen_readings.sql
  ```

### 2. 后端服务层
- [x] **服务文件**：`core/src/modules/shishen/shishenReadingService.ts` 已创建
- [x] **API路由**：`core/src/routes/bazi.ts` 已添加 `/shishen/:code` 路由
- [x] **Prompt模板**：`core/src/modules/prompt/promptTemplates.ts` 已添加 `buildShishenPrompt`
- [x] **解读服务**：`core/src/modules/reading/readingService.ts` 已添加 `readShishen`
- [x] **路由注册**：`core/src/routes/reading.ts` 已添加 `/shishen` 路由
- [x] **FeatureKey**：`core/src/middleware/requireProFeature.ts` 已添加 `'shishen'`

### 3. 前端服务层
- [x] **API服务**：`app/src/services/api/shishenService.ts` 已创建
- [x] **API端点**：`app/src/services/api/endpoints.ts` 已添加 `SHI_SHEN`
- [x] **映射工具**：`app/src/utils/shishenMapping.ts` 已创建（包含 `toTraditional`）

### 4. 前端组件层
- [x] **弹窗组件**：`app/src/components/ShishenPopup/index.tsx` 已创建
- [x] **表格组件**：`app/src/components/bazi/FourPillarsTable.tsx` 已添加点击事件
- [x] **总览页面**：`app/src/screens/ChartDetail/ChartOverviewTab.tsx` 已集成弹窗

---

## 🧪 功能测试步骤

### 步骤1：执行数据库迁移
```bash
cd /Users/gaoxuxu/Desktop/xiaopei-app
mysql -u root -p xiaopei < core/src/database/migrations/033_create_shishen_readings.sql
mysql -u root -p xiaopei < core/src/database/migrations/034_insert_shishen_readings.sql
```

### 步骤2：验证数据库
```sql
-- 检查表是否存在
SHOW TABLES LIKE 'shishen_readings';

-- 检查数据数量（应该返回 40）
SELECT COUNT(*) FROM shishen_readings WHERE is_active = TRUE;

-- 检查每个十神的数据（每个应该有4条）
SELECT shishen_code, COUNT(*) as count 
FROM shishen_readings 
WHERE is_active = TRUE 
GROUP BY shishen_code;
```

### 步骤3：重启服务
```bash
# 重启 Core 服务
cd core && npm run dev

# 重启 App 服务（如果需要）
cd app && npm start
```

### 步骤4：测试API（使用 curl 或 Postman）
```bash
# 测试获取比肩在年柱的解读（需要先登录获取 token）
curl -X GET "http://localhost:3000/api/v1/bazi/shishen/bi_jian?pillarType=year&gender=male" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### 步骤5：前端测试
1. 打开 App
2. 进入命盘详情页面
3. 切换到"命盤總覽" Tab
4. 找到"四柱總表"中的"副星"行
5. 点击任意副星（如"比肩"、"劫财"等）
6. 应该弹出十神解读弹窗

---

## 🔍 关键检查点

### 1. 十神代码映射
- ✅ 比肩 → `bi_jian`
- ✅ 劫财 → `jie_cai`
- ✅ 食神 → `shi_shen`
- ✅ 伤官 → `shang_guan`
- ✅ 正财 → `zheng_cai`
- ✅ 偏财 → `pian_cai`
- ✅ 正官 → `zheng_guan`
- ✅ 七杀 → `qi_sha`
- ✅ 正印 → `zheng_yin`
- ✅ 偏印 → `pian_yin`

### 2. 柱位映射
- ✅ 年柱 → `year`
- ✅ 月柱 → `month`
- ✅ 日柱 → `day`
- ✅ 时柱 → `hour`

### 3. 喜神/忌神判断逻辑
- ✅ 检查 `yongshenPattern.mainYongshen.tenGods`（主用神十神列表）
- ✅ 根据十神对应的五行检查 `tabooElements`（忌神五行）
- ✅ 根据十神对应的五行检查 `mainYongshen.elements`（主用神五行）
- ✅ 根据十神对应的五行检查 `assistElements`（辅喜五行）

### 4. 弹窗显示内容
- ✅ 十神名称
- ✅ 柱位标签（年柱/月柱/日柱/时柱）
- ✅ 第一个标签：十神本身的标签（如"自我・同輩"）
- ✅ 第二个标签：喜神/忌神（动态，如果不在用神/忌神列表中则不显示）
- ✅ 柱位详细解读
- ✅ 推荐提问（3-4个）
- ✅ 小佩解读按钮

---

## ⚠️ 常见问题排查

### 问题1：点击副星没有反应
- 检查 `FourPillarsTable` 是否传递了 `onShishenPress` 回调
- 检查 `ChartOverviewTab` 是否实现了 `handleShishenPress` 函数

### 问题2：弹窗显示"暫無解讀資料"
- 检查数据库表是否存在
- 检查数据是否已插入
- 检查十神代码映射是否正确
- 检查柱位映射是否正确

### 问题3：API 返回 404
- 检查数据库迁移是否已执行
- 检查十神代码是否正确（如 `bi_jian` 而不是 `bi_jian`）
- 检查性别参数是否正确传递

### 问题4：喜神/忌神标签不显示
- 检查是否传递了 `chartId` 参数
- 检查命盘数据中是否有 `analysis.yongshenPattern`
- 检查判断逻辑是否正确

---

## 📝 测试用例

### 测试用例1：比肩在年柱
- **输入**：十神="比肩"，柱位="年柱"，性别="male"
- **预期**：
  - 弹窗显示"比肩"
  - 显示标签"自我・同輩"
  - 显示年柱解读内容
  - 显示3-4个推荐提问
  - 如果比肩在用神列表中，显示"喜神"标签

### 测试用例2：劫财在月柱
- **输入**：十神="劫财"，柱位="月柱"，性别="female"
- **预期**：
  - 弹窗显示"劫財"（繁体）
  - 显示标签"競爭・突破"
  - 显示月柱解读内容
  - 如果劫财在忌神列表中，显示"忌神"标签

### 测试用例3：不存在的十神
- **输入**：十神="不存在"，柱位="年柱"
- **预期**：显示错误提示"暫無解讀資料"

---

## 🎯 完成标准

功能被认为"成功"需要满足：
1. ✅ 数据库表已创建
2. ✅ 40条数据已插入
3. ✅ API 能正常返回数据
4. ✅ 前端能正常调用 API
5. ✅ 弹窗能正常显示
6. ✅ 点击推荐提问能跳转到聊天页
7. ✅ 点击小佩解读能跳转到聊天页
8. ✅ 喜神/忌神标签能正确显示（如果命盘数据完整）

---

## 📌 下一步行动

1. **执行数据库迁移**（如果还未执行）
2. **重启 Core 服务**
3. **在 App 中测试点击副星功能**
4. **验证弹窗显示是否正确**
5. **验证喜神/忌神标签是否正确显示**


