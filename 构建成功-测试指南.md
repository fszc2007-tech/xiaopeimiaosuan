# 构建成功 - 测试指南

**构建时间**: 约1小时前  
**版本**: 1.0.1 (1)  
**构建类型**: Android Play Store build  
**状态**: ✅ 成功

---

## 📥 下载 APK

### 方法 1：直接下载链接

```
https://expo.dev/artifacts/eas/uVFEatgqAq5YTNVGBNR8Xj.apk
```

在浏览器中打开此链接即可下载 APK 文件。

### 方法 2：通过 EAS CLI 下载

```bash
cd /Users/gaoxuxu/Desktop/xiaopei-app/app
eas build:download
```

然后选择对应的构建 ID。

---

## 📱 安装到设备

### 方法 1：通过 adb 安装（推荐）

```bash
# 连接设备（华为 Mate 40）
adb devices

# 安装 APK
adb install path/to/app.apk
```

### 方法 2：直接传输安装

1. 将 APK 文件传输到手机（通过 USB、AirDrop 或云盘）
2. 在手机上打开 APK 文件
3. 允许"未知来源"安装（如需要）
4. 点击安装

---

## 🧪 测试清单

### 1. 环境变量诊断测试 ⚠️ 重要

**目的**: 确认生产包的 API_BASE_URL 是否正确

**步骤**:
1. 安装新构建的 APK
2. 打开 App
3. 查看启动日志

**查看日志方法**:

```bash
# 方法 1: 使用 adb logcat
adb logcat | grep "ENV DIAGNOSTIC"

# 方法 2: 使用 React Native Debugger
# 打开 React Native Debugger，在 Console 中搜索 "ENV DIAGNOSTIC"
```

**预期输出**:
```
[ENV DIAGNOSTIC] 🔍 API_BASE_URL: https://xiaopei-core-343578696044.asia-east2.run.app
[ENV DIAGNOSTIC] 🔍 EXPO_PUBLIC_API_BASE_URL: https://xiaopei-core-343578696044.asia-east2.run.app
[ENV DIAGNOSTIC] 🔍 APP_ENV: production
```

**如果输出不正确**:
- ❌ 如果显示 `http://localhost:3000` → EAS 环境变量未正确注入
- ❌ 如果显示 `未设置` → 需要检查 `eas.json` 配置

---

### 2. 用户协议查看功能测试

**测试步骤**:
1. 打开 App
2. 进入登录页面
3. 点击"用户协议"链接
4. 观察是否正常加载

**预期结果**:
- ✅ PDF 文档正常加载显示
- ✅ 如果加载失败，显示错误提示："無法載入文檔，請檢查網絡連接"
- ✅ 可以点击"點擊此處在瀏覽器中打開"备用方案

**测试场景**:
- [ ] 正常网络环境下加载
- [ ] 弱网环境下加载（测试加载提示）
- [ ] 断网环境下加载（测试错误提示和备用方案）
- [ ] 点击"在浏览器中打开"是否正常工作

---

### 3. 华为 Mate 40 适配测试

**测试步骤**:
1. 打开 App
2. 进入登录页面
3. 点击"通过 Google 登录"按钮
4. 观察弹窗显示

**预期结果**:
- ✅ 弹窗从底部正常弹出（动画流畅）
- ✅ 弹窗高度适中（不超过屏幕 50%）
- ✅ 底部内容不被安全区域遮挡
- ✅ 所有按钮和文字完整显示
- ✅ Logo 正常显示
- ✅ "使用 Google 賬戶為「小佩妙算」創建賬戶" 文字完整显示
- ✅ Google 登录按钮正常显示
- ✅ 可以正常关闭弹窗（点击 X 或遮罩）

**测试场景**:
- [ ] 华为 Mate 40 设备测试（主要测试设备）
- [ ] 其他 Android 设备测试（不同屏幕尺寸）
- [ ] 检查弹窗动画是否流畅
- [ ] 检查弹窗内容是否完整显示
- [ ] 检查底部安全区域处理

---

### 4. 短信验证码功能测试

**测试步骤**:
1. 打开 App
2. 进入登录页面
3. 输入手机号（香港号码：+852）
4. 点击"发送验证码"
5. 观察是否收到短信

**预期结果**:
- ✅ 验证码发送成功
- ✅ 收到短信验证码
- ✅ 可以正常输入验证码并登录

**如果失败**:
- 查看 Cloud Run 日志，检查是否有短信发送请求
- 检查错误信息（模板未审核、密钥错误等）

---

### 5. Google 登录功能测试

**测试步骤**:
1. 打开 App
2. 进入登录页面
3. 点击"通过 Google 登录"
4. 选择 Google 账号
5. 观察是否登录成功

**预期结果**:
- ✅ 弹窗正常显示
- ✅ Google 登录流程正常
- ✅ 登录成功后跳转到主页面

**如果失败**:
- 查看 Cloud Run 日志，检查是否有 Google 登录请求
- 检查错误信息（aud mismatch、Client ID 错误等）

---

## 🔍 问题排查

### 如果 API_BASE_URL 不正确

1. **检查 eas.json 配置**
   ```json
   {
     "production": {
       "env": {
         "EXPO_PUBLIC_API_BASE_URL": "https://xiaopei-core-343578696044.asia-east2.run.app"
       }
     }
   }
   ```

2. **检查 EAS Secrets**
   ```bash
   eas secret:list
   ```
   确认没有覆盖 `EXPO_PUBLIC_API_BASE_URL`

3. **重新构建**
   ```bash
   eas build --platform android --profile production --clear-cache
   ```

### 如果用户协议无法查看

1. **检查网络连接**
   ```bash
   curl -I https://xiaopei-core-343578696044.asia-east2.run.app/public/docs/miaosuan_user_agreement_zh-HK.pdf
   ```

2. **查看 WebView 错误日志**
   - 在 React Native Debugger 中查看 Console
   - 搜索 "WebView" 或 "PDF" 相关错误

3. **测试备用方案**
   - 点击"在浏览器中打开"
   - 确认是否能在浏览器中正常打开

### 如果华为 Mate 40 仍有适配问题

1. **检查设备信息**
   ```bash
   adb shell wm size
   adb shell wm density
   ```

2. **检查 SafeAreaView 配置**
   - 确认 `react-native-safe-area-context` 已正确安装
   - 检查 `SafeAreaProvider` 是否在 App 根组件中

---

## 📊 测试报告模板

```
设备型号: 华为 Mate 40
Android 版本: [版本号]
测试时间: [日期时间]
APK 版本: 1.0.1 (1)

[ ] 环境变量诊断 - API_BASE_URL 正确
[ ] 环境变量诊断 - 日志输出正常
[ ] 用户协议查看 - 正常加载
[ ] 用户协议查看 - 错误处理正常
[ ] 用户协议查看 - 备用方案正常
[ ] Google 登录弹窗 - 显示正常
[ ] Google 登录弹窗 - 高度适配正常
[ ] Google 登录弹窗 - 安全区域处理正常
[ ] Google 登录弹窗 - 动画流畅
[ ] 短信验证码 - 发送成功
[ ] 短信验证码 - 收到短信
[ ] Google 登录 - 流程正常
[ ] Google 登录 - 登录成功

问题记录:
1. [如有问题，记录 here]
2. [如有问题，记录 here]

截图:
- [用户协议查看页面]
- [Google 登录弹窗]
- [环境变量诊断日志]
```

---

## ✅ 下一步

测试完成后：
1. ✅ 记录测试结果
2. ✅ 如有问题，查看日志并修复
3. ✅ 确认无误后，可以发布到 Google Play
4. ✅ 或继续构建 AAB 版本用于正式发布

---

## 📝 注意事项

1. **这是 Play Store build**，如果需要 APK 版本，可以使用 `--profile production`（不是 productionAab）
2. **版本号**: 当前是 1.0.1 (1)，下次构建会自动递增为 1.0.1 (2)
3. **环境变量**: 已确认从 `eas.json` 正确注入
4. **构建时间**: 约1小时前完成，可以直接下载测试

