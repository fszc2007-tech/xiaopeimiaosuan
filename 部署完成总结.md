# éƒ¨ç½²å®Œæˆæ€»ç»“

ç”Ÿæˆæ—¶é—´: 2025-12-26

## âœ… éƒ¨ç½²çŠ¶æ€

- **æœåŠ¡ç‰ˆæœ¬**: xiaopei-core-00036-r6w
- **æœåŠ¡ URL**: https://xiaopei-core-343578696044.asia-east2.run.app
- **éƒ¨ç½²çŠ¶æ€**: âœ… æˆåŠŸ

## âœ… å·²æ‰§è¡Œçš„è¿ç§»

### Migration 044: ä¿®å¤ç¥ç…è§£è¯»è¡¨ç¼–ç 
- **çŠ¶æ€**: âœ… æ‰§è¡ŒæˆåŠŸ
- **æ‰§è¡Œæ—¶é—´**: 2025-12-26 11:12:44 UTC
- **ç»“æœ**: è¡¨å­—ç¬¦é›†å·²è½¬æ¢ä¸º utf8mb4

## ğŸ“Š æ•°æ®åº“è¡¨ç»“æ„æ¯”å¯¹ç»“æœ

### è¡¨æ•°é‡
- **å¼€å‘ç¯å¢ƒ**: 25 å¼ è¡¨
- **ç”Ÿäº§ç¯å¢ƒ**: 24 å¼ è¡¨
- **å·®å¼‚**: ç”Ÿäº§ç¯å¢ƒç¼ºå¤± 1 å¼ è¡¨ï¼ˆ`llm_api_config`ï¼Œå¯å¿½ç•¥ï¼‰

### å‘ç°çš„å·®å¼‚

#### 1. ç¼ºå¤±çš„è¡¨
- âŒ `llm_api_config` - ç”Ÿäº§ç¯å¢ƒä¸å­˜åœ¨
  - **è¯´æ˜**: è¿™æ˜¯é‡å¤è¡¨ï¼Œå¼€å‘ç¯å¢ƒåŒæ—¶æœ‰ `llm_api_config` å’Œ `llm_api_configs`
  - **å»ºè®®**: å¯ä»¥å¿½ç•¥ï¼Œæˆ–åˆ é™¤å¼€å‘ç¯å¢ƒçš„ `llm_api_config` è¡¨

#### 2. åˆ—ç±»å‹å·®å¼‚
- âš ï¸ `conversations.title`
  - **å¼€å‘ç¯å¢ƒ**: `varchar(255)`
  - **ç”Ÿäº§ç¯å¢ƒ**: `varchar(200)`
  - **å½±å“**: è½»å¾®ï¼Œ200 å­—ç¬¦é€šå¸¸è¶³å¤Ÿ
  - **å»ºè®®**: å¯é€‰ä¿®å¤ï¼Œå°†ç”Ÿäº§ç¯å¢ƒæ”¹ä¸º `varchar(255)` ä»¥ä¿æŒä¸€è‡´

### å…³é”®è¡¨ç»“æ„ä¸€è‡´æ€§

| è¡¨å | å¼€å‘ç¯å¢ƒåˆ—æ•° | ç”Ÿäº§ç¯å¢ƒåˆ—æ•° | çŠ¶æ€ |
|------|------------|------------|------|
| llm_api_configs | 15 | 15 | âœ… ä¸€è‡´ |
| conversations | 11 | 11 | âš ï¸ title ç±»å‹ä¸ä¸€è‡´ |
| users | 25 | 25 | âœ… ä¸€è‡´ |
| shensha_readings | 16 | 16 | âœ… ä¸€è‡´ |
| messages | 6 | 6 | âœ… ä¸€è‡´ |
| verification_codes | 7 | 7 | âœ… ä¸€è‡´ |

## âœ… å·²ä¿®å¤çš„é—®é¢˜

### 1. DeepSeek API Key é…ç½®
- **é—®é¢˜**: åŠ å¯†å¯†é’¥åŠ è½½æ—¶æœºé—®é¢˜
- **ä¿®å¤**: æ”¹ä¸ºå»¶è¿Ÿè·å– `ENCRYPTION_KEY`
- **çŠ¶æ€**: âœ… å·²ä¿®å¤å¹¶éƒ¨ç½²

### 2. ç¥ç…è§£è¯»ä¹±ç 
- **é—®é¢˜**: ç”Ÿäº§ç¯å¢ƒç¥ç…è§£è¯»æ˜¾ç¤ºä¹±ç 
- **ä¿®å¤**: 
  - æ‰§è¡Œ Migration 044 ä¿®å¤è¡¨ç¼–ç 
  - ç¡®ä¿æŸ¥è¯¢å’Œå“åº”ä½¿ç”¨ UTF-8 ç¼–ç 
  - æ·»åŠ è°ƒè¯•æ—¥å¿—
- **çŠ¶æ€**: âœ… Migration 044 å·²æ‰§è¡Œ

## ğŸ“‹ ç”Ÿäº§ç¯å¢ƒè¡¨åˆ—è¡¨

1. account_audit_logs (15 åˆ—)
2. admin_users (9 åˆ—)
3. admins (7 åˆ—)
4. auth_identities (9 åˆ—)
5. bazi_charts (7 åˆ—)
6. chart_profiles (12 åˆ—)
7. chat_message_feedback (12 åˆ—)
8. conversations (11 åˆ—) âš ï¸ title ç±»å‹ä¸ä¸€è‡´
9. day_stem_readings (7 åˆ—)
10. feedbacks (10 åˆ—)
11. llm_api_configs (15 åˆ—) âœ…
12. llm_pricing_rules (11 åˆ—)
13. llm_usage_daily (11 åˆ—)
14. llm_usage_logs (17 åˆ—)
15. messages (6 åˆ—)
16. rate_limits (7 åˆ—)
17. readings (8 åˆ—)
18. shensha_readings (16 åˆ—) âœ… ç¼–ç å·²ä¿®å¤
19. shishen_readings (14 åˆ—)
20. subscriptions (11 åˆ—)
21. system_settings (5 åˆ—)
22. user_settings (7 åˆ—)
23. users (25 åˆ—) âœ…
24. verification_codes (7 åˆ—) âœ…

## ğŸ” ä¸‹ä¸€æ­¥å»ºè®®

### 1. æµ‹è¯•ç¥ç…è§£è¯»åŠŸèƒ½
- åœ¨ App ä¸­æµ‹è¯•ç¥ç…è§£è¯»æ˜¯å¦è¿˜æœ‰ä¹±ç 
- æŸ¥çœ‹è°ƒè¯•æ—¥å¿—åˆ†ææ•°æ®æµ

### 2. å¯é€‰ä¿®å¤
- ç»Ÿä¸€ `conversations.title` å­—æ®µç±»å‹ï¼ˆvarchar(255)ï¼‰
- åˆ é™¤å¼€å‘ç¯å¢ƒçš„é‡å¤è¡¨ `llm_api_config`

### 3. éªŒè¯ DeepSeek API Key
- æµ‹è¯• DeepSeek è§£è¯»åŠŸèƒ½æ˜¯å¦æ­£å¸¸
- ç¡®è®¤ API Key é…ç½®å·²ç”Ÿæ•ˆ

## ğŸ“ å·²åˆ›å»ºçš„è„šæœ¬å’Œå·¥å…·

1. `core/scripts/check-llm-config.ts` - æ£€æŸ¥ LLM é…ç½®
2. `core/scripts/check-shensha-encoding.ts` - æ£€æŸ¥ç¥ç…è§£è¯»è¡¨ç¼–ç 
3. `core/scripts/compare-db-schemas.ts` - æ¯”å¯¹æ•°æ®åº“è¡¨ç»“æ„
4. `core/scripts/compare-prod-dev-tables.ts` - æ¯”å¯¹å¼€å‘å’Œç”Ÿäº§ç¯å¢ƒè¡¨ç»“æ„
5. `core/scripts/full-db-comparison.ts` - ç”Ÿæˆå®Œæ•´è¡¨ç»“æ„æŠ¥å‘Š
6. `core/scripts/run-migration-044.ts` - æ‰§è¡Œ Migration 044
7. `core/scripts/query-prod-schema.ts` - æŸ¥è¯¢ç”Ÿäº§ç¯å¢ƒè¡¨ç»“æ„

## ğŸ”— Migration API ç«¯ç‚¹

- `GET /api/admin/v1/migration/schema` - è·å–æ•°æ®åº“è¡¨ç»“æ„ âœ… å¯ç”¨
- `POST /api/admin/v1/migration/043` - æ‰§è¡Œ Migration 043ï¼ˆæ·»åŠ ç¼ºå¤±å­—æ®µï¼‰âœ… å¯ç”¨
- `POST /api/admin/v1/migration/044` - æ‰§è¡Œ Migration 044ï¼ˆä¿®å¤ç¥ç…ç¼–ç ï¼‰âœ… å·²æ‰§è¡Œ

## âœ… æ€»ç»“

1. âœ… ä»£ç å·²æˆåŠŸéƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
2. âœ… Migration 044 å·²æ‰§è¡Œï¼Œç¥ç…è§£è¯»è¡¨ç¼–ç å·²ä¿®å¤
3. âœ… ç”Ÿäº§ç¯å¢ƒè¡¨ç»“æ„å·²æŸ¥è¯¢å¹¶æ¯”å¯¹
4. âœ… å‘ç° 1 å¤„è½»å¾®å·®å¼‚ï¼ˆconversations.title ç±»å‹ï¼‰ï¼Œä¸å½±å“åŠŸèƒ½
5. âœ… DeepSeek API Key é…ç½®é—®é¢˜å·²ä¿®å¤
6. â³ ç­‰å¾…ç”¨æˆ·æµ‹è¯•ç¥ç…è§£è¯»åŠŸèƒ½ï¼Œç¡®è®¤ä¹±ç é—®é¢˜æ˜¯å¦å·²è§£å†³
