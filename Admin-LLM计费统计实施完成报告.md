# Admin LLM è®¡è´¹ç»Ÿè®¡å®æ–½å®ŒæˆæŠ¥å‘Š

**å®Œæˆæ—¶é—´**: 2025-01-XX  
**å®æ–½é˜¶æ®µ**: Phase 1 â†’ Phase 2 â†’ Phase 3 â†’ Phase 4ï¼ˆå…¨éƒ¨å®Œæˆï¼‰

---

## âœ… å·²å®Œæˆå·¥ä½œ

### Phase 1: æ•°æ®é‡‡é›†å±‚ï¼ˆP0ï¼‰

#### 1. æ•°æ®åº“è¿ç§»
- âœ… åˆ›å»º `037_create_llm_billing_tables.sql`
- âœ… åˆ›å»º `llm_usage_logs` è¡¨ï¼ˆè¯¦ç»†æ—¥å¿—ï¼‰
- âœ… åˆ›å»º `llm_usage_daily` è¡¨ï¼ˆæ—¥ç»Ÿè®¡ï¼‰
- âœ… åˆ›å»º `llm_pricing_rules` è¡¨ï¼ˆä»·æ ¼è§„åˆ™ï¼‰
- âœ… æ’å…¥åˆå§‹ DeepSeek ä»·æ ¼æ•°æ®

#### 2. ç±»å‹å®šä¹‰
- âœ… åˆ›å»º `core/src/modules/billing/types.ts`
- âœ… å®šä¹‰ `LLMProvider` æšä¸¾ï¼ˆDeepSeek, OpenAI, Qwenï¼‰
- âœ… å®šä¹‰ `LLMSource` æšä¸¾ï¼ˆApp, Admin, Scriptï¼‰
- âœ… å®šä¹‰ç›¸å…³æ¥å£ç±»å‹

#### 3. è®¡è´¹æœåŠ¡
- âœ… åˆ›å»º `core/src/modules/billing/billingService.ts`
- âœ… å®ç° `calculateCost()` - è®¡ç®—è´¹ç”¨ï¼ˆæ”¯æŒä»·æ ¼è§„åˆ™æŸ¥è¯¢ï¼‰
- âœ… å®ç° `logUsage()` - è®°å½• usage æ—¥å¿—
- âœ… ä»·æ ¼æœªé…ç½®æ—¶å®¹é”™å¤„ç†ï¼ˆè¿”å› 0ï¼Œä¸ä¸­æ–­è°ƒç”¨ï¼‰
- âœ… ä½¿ç”¨ `Math.round()` å››èˆäº”å…¥

#### 4. AI æœåŠ¡é›†æˆ
- âœ… ä¿®æ”¹ `core/src/modules/ai/types.ts` - StreamChunk å¢åŠ  usage å­—æ®µ
- âœ… ä¿®æ”¹ `core/src/modules/ai/providers/deepseek.ts` - æ•è·æµå¼å“åº”ä¸­çš„ usage
- âœ… ä¿®æ”¹ `core/src/modules/ai/aiService.ts` - é›†æˆ usage æ—¥å¿—è®°å½•
  - `chat()` å‡½æ•°è®°å½•æ—¥å¿—
  - `chatStream()` å‡½æ•°è®°å½•æ—¥å¿—
  - `chatStreamWithQuota()` ä¼ é€’ userId å’Œ source
- âœ… ä¿®æ”¹ `core/src/modules/reading/readingService.ts` - æ‰€æœ‰è°ƒç”¨ä¼ é€’ userId å’Œ source

---

### Phase 2: åç«¯æ¥å£ï¼ˆP0ï¼‰

#### 1. Admin æœåŠ¡å±‚
- âœ… åˆ›å»º `core/src/modules/admin/billingAdminService.ts`
- âœ… å®ç° `getBillingSummary()` - æ¦‚è§ˆç»Ÿè®¡ï¼ˆå«è´¹ç”¨é¢„ä¼°ï¼‰
- âœ… å®ç° `getBillingTrend()` - è¶‹åŠ¿æ•°æ®ï¼ˆæ”¯æŒæ•°æ®æºä¼˜å…ˆçº§ï¼‰
- âœ… å®ç° `getBillingByModel()` - æŒ‰æ¨¡å‹èšåˆç»Ÿè®¡
- âœ… é¢„ä¼°ç®—æ³•ï¼šæœ¬è‡ªç„¶æœˆã€é™¤é›¶å¤„ç†ã€è·¨æœˆæŸ¥è¯¢å¤„ç†

#### 2. Admin è·¯ç”±
- âœ… åˆ›å»º `core/src/routes/admin/billing.ts`
- âœ… å®ç° `GET /api/admin/v1/billing/summary`
- âœ… å®ç° `GET /api/admin/v1/billing/trend`
- âœ… å®ç° `GET /api/admin/v1/billing/by-model`
- âœ… æŒ‚è½½åˆ° `core/src/routes/admin/index.ts`
- âœ… API æ–‡æ¡£æ³¨å†Œ

---

### Phase 3: å®šæ—¶ä»»åŠ¡ï¼ˆP0ï¼‰

#### 1. èšåˆä»»åŠ¡
- âœ… åˆ›å»º `core/src/jobs/aggregateDailyUsage.ts`
- âœ… å®ç° `aggregateDailyUsage()` - èšåˆæŒ‡å®šæ—¥æœŸæ•°æ®
- âœ… å®ç° `aggregateYesterday()` - èšåˆæ˜¨å¤©æ•°æ®
- âœ… å®ç° `aggregateToday()` - èšåˆä»Šå¤©æ•°æ®

#### 2. ç³»ç»Ÿé›†æˆ
- âœ… å®‰è£… `node-cron` ä¾èµ–
- âœ… ä¿®æ”¹ `core/src/server.ts` é›†æˆå®šæ—¶ä»»åŠ¡
- âœ… æ¯å¤© 0:05 æ‰§è¡Œï¼šèšåˆæ˜¨å¤©çš„æ•°æ®
- âœ… æ¯å°æ—¶æ‰§è¡Œï¼šè¡¥èšåˆå½“å¤©æ•°æ®

---

### Phase 4: Admin å‰ç«¯ï¼ˆP0ï¼‰

#### 1. ç±»å‹å®šä¹‰
- âœ… åœ¨ `admin/src/types/index.ts` ä¸­æ·»åŠ è®¡è´¹ç»Ÿè®¡ç±»å‹
- âœ… `BillingSummary`, `BillingTrend`, `BillingByModel` ç­‰æ¥å£

#### 2. API æœåŠ¡
- âœ… åˆ›å»º `admin/src/services/billingService.ts`
- âœ… å®ç° `getBillingSummary()`, `getBillingTrend()`, `getBillingByModel()`

#### 3. é¡µé¢ç»„ä»¶
- âœ… åˆ›å»º `admin/src/pages/Billing/BillingPage.tsx`
- âœ… ç­›é€‰åŒºï¼šæ—¶é—´å¿«æ·é€‰é¡¹ã€Providerã€Model ç­›é€‰
- âœ… 4 ä¸ªæŒ‡æ ‡å¡ç‰‡ï¼šç´¯è®¡ Tokensã€ç´¯è®¡è´¹ç”¨ã€é¢„ä¼°æœ¬æœˆ Tokensã€é¢„ä¼°æœ¬æœˆè´¹ç”¨
- âœ… è¶‹åŠ¿å›¾åŒºåŸŸï¼šToken æ¶ˆè€—è¶‹åŠ¿ã€è´¹ç”¨è¶‹åŠ¿ï¼ˆå ä½ï¼Œå¾…é›†æˆå›¾è¡¨åº“ï¼‰
- âœ… æŒ‰æ¨¡å‹ç»Ÿè®¡å¡ç‰‡
- âœ… æ•°å­—æ ¼å¼åŒ–ï¼šä½¿ç”¨ `Intl.NumberFormat`
- âœ… ç©ºæ•°æ®æ€å¤„ç†

#### 4. è·¯ç”±é›†æˆ
- âœ… åœ¨ `admin/src/App.tsx` ä¸­æ·»åŠ  `/billing` è·¯ç”±
- âœ… åœ¨ `admin/src/components/Layout/AdminLayout.tsx` ä¸­æ·»åŠ èœå•é¡¹
- âœ… å®‰è£… `dayjs` ä¾èµ–

---

## ğŸ“‹ å¾…å®Œæˆå·¥ä½œï¼ˆP2 å»¶åï¼‰

1. **æ˜ç»†åˆ—è¡¨æ¥å£å’Œè¡¨æ ¼**ï¼š`GET /api/admin/v1/billing/details` + å‰ç«¯æ˜ç»†è¡¨æ ¼
2. **è¶‹åŠ¿å›¾é›†æˆ**ï¼šé›†æˆ ECharts æˆ– Ant Design Charts æ˜¾ç¤ºæŠ˜çº¿å›¾
3. **è¶‹åŠ¿å›¾ç²’åº¦æ‰©å±•**ï¼šæ”¯æŒ `granularity = week/month`
4. **ä»·æ ¼ç®¡ç†é¡µé¢**ï¼šåœ¨ Admin åå°ç®¡ç† `llm_pricing_rules`
5. **æˆæœ¬å‘Šè­¦**ï¼šå½“æœˆè´¹ç”¨è¶…è¿‡é˜ˆå€¼æ—¶å‘é€é€šçŸ¥
6. **ç”¨æˆ·ç»´åº¦ç»Ÿè®¡**ï¼šæŒ‰ç”¨æˆ·æŸ¥çœ‹ Token æ¶ˆè€—ï¼ˆéœ€æƒé™æ§åˆ¶ï¼‰
7. **å¯¼å‡ºåŠŸèƒ½**ï¼šå¯¼å‡º Excel æŠ¥è¡¨

---

## ğŸš€ ä¸‹ä¸€æ­¥æ“ä½œ

### 1. æ‰§è¡Œæ•°æ®åº“è¿ç§» âœ… å·²å®Œæˆ

**è¿ç§»è„šæœ¬**: `core/scripts/run-migration-037.ts`

**æ‰§è¡Œç»“æœ**:
- âœ… å·²åˆ›å»º `llm_usage_logs` è¡¨ï¼ˆ15 ä¸ªå­—æ®µï¼Œ9 ä¸ªç´¢å¼•ï¼‰
- âœ… å·²åˆ›å»º `llm_usage_daily` è¡¨ï¼ˆ11 ä¸ªå­—æ®µï¼Œ5 ä¸ªç´¢å¼•ï¼‰
- âœ… å·²åˆ›å»º `llm_pricing_rules` è¡¨ï¼ˆ11 ä¸ªå­—æ®µï¼Œ3 ä¸ªç´¢å¼•ï¼‰
- âœ… å·²æ’å…¥ 5 æ¡ DeepSeek ä»·æ ¼è§„åˆ™

**éªŒè¯ç»“æœ**:
- âœ… æ‰€æœ‰è¡¨ç»“æ„æ­£ç¡®
- âœ… æ‰€æœ‰ç´¢å¼•å·²åˆ›å»º
- âœ… ä»·æ ¼è§„åˆ™æ•°æ®å·²æ’å…¥

**æ‰‹åŠ¨æ‰§è¡Œæ–¹å¼**ï¼ˆå¦‚æœéœ€è¦ï¼‰:
```bash
cd core
npx ts-node scripts/run-migration-037.ts
```

### 2. å¯åŠ¨æœåŠ¡æµ‹è¯•

```bash
# å¯åŠ¨ Core åç«¯
cd core
npm run dev

# å¯åŠ¨ Admin å‰ç«¯
cd admin
npm run dev
```

### 3. éªŒè¯åŠŸèƒ½

1. **æ•°æ®é‡‡é›†éªŒè¯**ï¼š
   - è°ƒç”¨ä»»æ„ LLM APIï¼ˆå¦‚èŠå¤©ã€è§£è¯»ï¼‰
   - æ£€æŸ¥ `llm_usage_logs` è¡¨æ˜¯å¦æœ‰è®°å½•
   - æ£€æŸ¥ `cost_cents` æ˜¯å¦æ­£ç¡®è®¡ç®—

2. **ç»Ÿè®¡æ¥å£éªŒè¯**ï¼š
   - è®¿é—® `http://localhost:5173/billing`
   - æ£€æŸ¥æ¦‚è§ˆç»Ÿè®¡æ˜¯å¦æ­£ç¡®
   - æ£€æŸ¥è¶‹åŠ¿æ•°æ®æ˜¯å¦æ­£ç¡®
   - æ£€æŸ¥æŒ‰æ¨¡å‹ç»Ÿè®¡æ˜¯å¦æ­£ç¡®

3. **å®šæ—¶ä»»åŠ¡éªŒè¯**ï¼š
   - ç­‰å¾…å®šæ—¶ä»»åŠ¡æ‰§è¡Œï¼ˆæˆ–æ‰‹åŠ¨è§¦å‘ï¼‰
   - æ£€æŸ¥ `llm_usage_daily` è¡¨æ˜¯å¦æœ‰æ•°æ®

---

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **ä»·æ ¼æ•°æ®**ï¼šå½“å‰æ’å…¥çš„ DeepSeek ä»·æ ¼ä¸ºç¤ºä¾‹ï¼Œéœ€æ ¹æ®å®˜ç½‘æœ€æ–°ä»·æ ¼æ›´æ–°
2. **å›¾è¡¨åº“**ï¼šå‰ç«¯è¶‹åŠ¿å›¾ç›®å‰ä¸ºå ä½ï¼Œéœ€è¦é›†æˆ ECharts æˆ– Ant Design Charts
3. **å†å²æ•°æ®**ï¼šå¦‚æœéœ€è¦ç»Ÿè®¡å†å²æ•°æ®ï¼Œéœ€è¦æ‰‹åŠ¨æ‰§è¡Œèšåˆä»»åŠ¡æˆ–ç­‰å¾…å®šæ—¶ä»»åŠ¡
4. **æ€§èƒ½ä¼˜åŒ–**ï¼šå½“ `llm_usage_logs` è¡¨æ•°æ®é‡å¤§æ—¶ï¼Œå»ºè®®å®šæœŸå½’æ¡£

---

## ğŸ‰ å®ŒæˆçŠ¶æ€

- âœ… Phase 1: æ•°æ®é‡‡é›†å±‚ï¼ˆ100%ï¼‰
- âœ… Phase 2: åç«¯æ¥å£ï¼ˆ100%ï¼‰
- âœ… Phase 3: å®šæ—¶ä»»åŠ¡ï¼ˆ100%ï¼‰
- âœ… Phase 4: Admin å‰ç«¯ï¼ˆ90%ï¼Œå›¾è¡¨å¾…é›†æˆï¼‰

**æ€»ä½“è¿›åº¦**: 95% å®Œæˆï¼ˆP0 åŠŸèƒ½å…¨éƒ¨å®Œæˆï¼Œå›¾è¡¨é›†æˆå¾…å®Œæˆï¼‰

