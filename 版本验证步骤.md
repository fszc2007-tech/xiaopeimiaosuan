# 版本验证步骤

## 方法 1: 使用 adb 命令（推荐）

### 1. 连接设备
```bash
adb devices
```
应该看到你的设备已连接。

### 2. 检查已安装的包
```bash
adb shell pm list packages | grep xiaopei
```
应该显示：`package:tech.dawnai.xiaopei.app`

### 3. 查看详细版本信息
```bash
adb shell dumpsys package tech.dawnai.xiaopei.app | grep -E "versionCode|versionName"
```

**预期输出**：
```
versionCode=3
versionName=1.0.3
```

### 4. 查看完整包信息（可选）
```bash
adb shell dumpsys package tech.dawnai.xiaopei.app | head -30
```

---

## 方法 2: 在手机上查看

### Android 系统设置
1. 打开 **设置** → **应用** → **应用管理**
2. 找到 **小佩妙算**
3. 点击进入应用详情
4. 查看 **版本号** 和 **版本代码**

**应该显示**：
- 版本号：`1.0.3`
- 版本代码：`3`

---

## 方法 3: 通过 App 内查看（如果 App 有显示）

如果 App 有"关于"或"设置"页面显示版本信息，也可以在那里查看。

---

## 验证诊断日志（确认代码是否执行）

### 1. 清空日志缓存
```bash
adb logcat -c
```

### 2. 启动实时日志监控
```bash
adb logcat -v time | grep -E "ENV DIAGNOSTIC|API CLIENT DIAGNOSTIC|BUILD|938c675"
```

### 3. 打开 App
在手机上打开"小佩妙算"App

### 4. 查看日志输出

**应该看到**：
```
12-24 22:30:15.123  I  ReactNativeJS: [ENV DIAGNOSTIC] 🔍 API_BASE_URL: https://xiaopei-core-343578696044.asia-east2.run.app
12-24 22:30:15.124  I  ReactNativeJS: [ENV DIAGNOSTIC] 🔍 EXPO_PUBLIC_API_BASE_URL: https://xiaopei-core-343578696044.asia-east2.run.app
12-24 22:30:15.125  I  ReactNativeJS: [ENV DIAGNOSTIC] 🔍 APP_ENV: production
12-24 22:30:15.126  I  ReactNativeJS: [API CLIENT DIAGNOSTIC] 🔗 baseURL: https://xiaopei-core-343578696044.asia-east2.run.app
12-24 22:30:15.127  I  ReactNativeJS: [API CLIENT DIAGNOSTIC] 🌍 环境: production
```

**如果看不到这些日志**：
- ❌ 说明运行的不是新构建（可能是旧版本或 OTA 覆盖）
- ❌ 需要重新安装或清除应用数据

---

## 快速验证脚本

创建一个脚本文件 `verify-version.sh`：

```bash
#!/bin/bash

echo "=== 检查设备连接 ==="
adb devices

echo ""
echo "=== 检查包名 ==="
adb shell pm list packages | grep xiaopei

echo ""
echo "=== 检查版本信息 ==="
adb shell dumpsys package tech.dawnai.xiaopei.app | grep -E "versionCode|versionName"

echo ""
echo "=== 开始监控诊断日志（按 Ctrl+C 停止）==="
adb logcat -c
adb logcat -v time | grep -E "ENV DIAGNOSTIC|API CLIENT DIAGNOSTIC|SMS REQUEST DIAGNOSTIC|GOOGLE CONFIG DIAGNOSTIC"
```

运行：
```bash
chmod +x verify-version.sh
./verify-version.sh
```

---

## 常见问题

### Q: 显示 versionCode=2 或更小？
**A**: 说明安装的是旧版本，需要：
1. 卸载：`adb uninstall tech.dawnai.xiaopei.app`
2. 重新安装新 APK

### Q: 看不到诊断日志？
**A**: 可能原因：
1. 装错了 APK（不是最新构建）
2. OTA 更新覆盖了 JS bundle
3. 应用数据缓存问题

**解决方法**：
```bash
# 清除应用数据
adb shell pm clear tech.dawnai.xiaopei.app

# 重新打开 App 并查看日志
```

### Q: 看到诊断日志但值不对？
**A**: 说明代码执行了，但环境变量配置有问题。检查：
- `EXPO_PUBLIC_API_BASE_URL` 是否正确
- `EXPO_PUBLIC_ENV` 是否为 `production`

