# 登录/退出日志系统

## 已完成

### 1. 创建统一日志工具 (`app/src/utils/logger.ts`)

- ✅ 支持多个日志级别：info, warn, error, debug
- ✅ 支持多个日志类别：auth, api, navigation, user_action, system
- ✅ 自动添加时间戳
- ✅ 控制台输出带表情符号（✅ ⚠️ ❌ 🔍）
- ✅ 内存保存最近 500 条日志
- ✅ 支持导出日志
- ✅ 全局错误捕获

### 2. 登录流程日志

```typescript
// 开始登录
logger.auth('开始登录', { userId, phone, hasToken, tokenLength });

// Token 为空
logger.error('auth', 'Token 为空，登录失败', { token });

// 登录成功
logger.auth('登录成功，状态已更新', { userId, isAuthenticated, tokenLength });

// 验证登录状态
logger.auth('验证登录状态', { hasUser, hasToken, tokenLength, isAuthenticated });
```

### 3. 退出登录流程日志

```typescript
// 点击退出按钮
logger.userAction('点击退出登录按钮', { isAuthenticated, hasUser, hasToken });

// 未登录时尝试退出
logger.warn('auth', '尝试退出但未登录', currentState);

// 取消退出
logger.userAction('取消退出登录');

// 确认退出
logger.userAction('确认退出登录');

// 开始退出
logger.auth('开始退出登录', { wasAuthenticated, hadUser, hadToken });

// 退出完成
logger.auth('退出登录完成', { isAuthenticated: false, clearedUser, clearedToken });
```

### 4. 导航状态日志

```typescript
logger.navigation('认证状态变化', { 
  hasHydrated, 
  isAuthenticated, 
  isLoggedIn,
  type: typeof isAuthenticated 
});
```

### 5. 退出登录保护

- ✅ 检查 `isAuthenticated` 状态
- ✅ 检查 `user` 是否存在
- ✅ 检查 `token` 是否存在
- ✅ 未登录时弹窗提示："您尚未登录"
- ✅ 记录所有操作（包括取消）

## 日志格式

```
[时间] [类别] 操作描述 {详细数据JSON}
```

示例：
```
[23:45:12.345] [AUTH] 开始登录 {
  "userId": "xxx",
  "phone": "13636602202",
  "hasToken": true,
  "tokenLength": 192
}
```

## 使用方法

### 查看日志

1. 打开 Expo 控制台（运行 `npx expo start` 的终端）
2. 所有操作都会实时输出日志
3. 日志带有表情符号，便于快速识别：
   - ✅ 正常操作
   - ⚠️ 警告
   - ❌ 错误
   - 🔍 调试

### 导出日志

```typescript
import { logger } from '@/utils/logger';

// 获取最近 50 条日志
const recent = logger.getRecentLogs(50);

// 导出所有日志为文本
const logs = logger.export();
console.log(logs);
```

## 问题排查

### 1. "未登录也能点击退出"

**已修复**：
- 添加登录状态检查
- 未登录时弹窗提示
- 记录详细日志

### 2. "不知道 token 是否存在"

**已修复**：
- 所有关键操作都记录 `hasToken` 和 `tokenLength`
- 登录后验证 token 是否真的保存了
- API 请求拦截器记录 token 状态

### 3. "操作顺序不清楚"

**已修复**：
- 每条日志都有精确到毫秒的时间戳
- 可以按时间顺序追踪整个流程

## 测试步骤

1. **按 `Cmd + R`** 重新加载 App
2. **登录**：`13636602202` / `123456`
   - 查看控制台日志
   - 应该看到完整的登录流程日志
3. **点击"我的" → "设置" → "退出登录"**
   - 如果已登录：弹出确认框
   - 如果未登录：弹出"您尚未登录"
4. **所有操作都有详细日志**

## 下一步优化

- [ ] 添加 API 请求日志
- [ ] 添加页面跳转日志
- [ ] 添加用户交互日志（点击、滑动等）
- [ ] 日志持久化到文件
- [ ] 日志上传到服务器（错误监控）

