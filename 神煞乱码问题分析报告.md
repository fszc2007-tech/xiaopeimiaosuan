# 神煞乱码问题分析报告

## 问题现象
- **十神解读**: ✅ 正常显示（包含正确的中文）
- **神煞解读**: ❌ 显示乱码（UTF-8 字节被错误解释为 Latin-1）

## 根本原因分析

### 1. 数据库数据验证
- ✅ 开发环境数据库：数据正确（"文昌貴人"，4个字符，12字节）
- ✅ 生产环境数据库：数据正确（"文昌貴人"，HEX: `E69687E6988CE8B2B4E4BABA`）
- ✅ 表字符集：utf8mb4
- ✅ 列字符集：utf8mb4

### 2. 代码差异对比

**十神服务** (`shishenReadingService.ts`):
- ❌ **没有**执行 `SET NAMES utf8mb4`
- ✅ 直接使用连接池的 `charset: 'utf8mb4'` 配置
- ✅ 显示正常

**神煞服务** (`shenshaReadingService.ts`):
- ✅ **有**执行 `SET NAMES utf8mb4`（已移除）
- ✅ 使用连接池的 `charset: 'utf8mb4'` 配置
- ❌ 显示乱码

### 3. 问题定位

从 hexdump 分析，API 返回的 JSON 中 name 字段值是：
```
"c3 a6 e2 80 93 e2 80 a1 c3 a6 cb 9c c5 92 c3 a8 c2 b2 c2 b4 c3 a4 c2 ba c2 ba"
```

这是 UTF-8 字节序列被错误地解释为 Latin-1 字符。

**可能的原因**：
1. mysql2 驱动在某些情况下返回的数据已经是双重编码
2. 或者数据在传输过程中被错误编码

### 4. 解决方案

在神煞服务中添加 `fixEncoding` 函数，检测并修复可能的双重编码问题：
- 如果字符串长度异常（> 10）或包含乱码字符
- 尝试将 Latin-1 字节重新解释为 UTF-8
- 如果修复后包含中文，使用修复后的值

## 修复步骤

1. ✅ 移除神煞服务中的 `SET NAMES utf8mb4`（与十神服务保持一致）
2. ✅ 添加 `fixEncoding` 函数修复双重编码
3. ✅ 在所有返回点应用编码修复
4. ⏳ 部署并验证

## 验证方法

部署后，通过 API 验证：
```bash
curl "https://xiaopei-core-343578696044.asia-east2.run.app/api/admin/v1/migration/shensha-sample"
```

期望结果：name 字段应显示 "文昌貴人"（4个字符），而不是乱码。

