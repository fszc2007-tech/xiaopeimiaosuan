# 账号注销宽限期显示修复报告

## 问题描述

用户注销账号后再次登录，应该看到账号待删除提示页面（`AccountDeletionPendingScreen`），显示7天宽限期并提供撤销选项。但实际情况是用户登录后直接进入主应用，没有看到任何提示。

## 问题分析

### 预期行为（设计文档）

根据账号注销功能设计：
1. 用户申请注销后，账号状态变为 `PENDING_DELETE`
2. 设置7天宽限期（`delete_scheduled_at`）
3. 7天内用户再次登录，应该：
   - 显示 `AccountDeletionPendingScreen` 页面
   - 提示计划删除时间
   - 提供"撤销注销"和"继续注销"选项

### 实际问题

**根本原因**：`UserDto` 接口和 `FieldMapper.mapUser` 方法**没有映射数据库中的 `status` 和 `delete_scheduled_at` 字段**，导致前端无法判断用户是否处于待删除状态。

### 详细分析

1. **前端判断逻辑**（`RootNavigator.tsx` 第48行）：
```typescript
const isPendingDelete = isLoggedIn && user?.status === 'PENDING_DELETE';
```

2. **后端数据映射**（`fieldMapper.ts` 第78-98行）：
```typescript
static mapUser(row: UserRow): UserDto {
  return {
    userId: row.user_id,
    phone: row.phone,
    // ... 其他字段
    // ❌ 缺少：status 字段
    // ❌ 缺少：deleteScheduledAt 字段
  };
}
```

3. **流程说明**：
   - 用户登录 → 调用 `/api/v1/auth/login_or_register`
   - 后端查询数据库，用户记录中 `status = 'PENDING_DELETE'`
   - 通过 `FieldMapper.mapUser` 转换为 `UserDto`
   - **但 `status` 字段未被映射**，返回给前端的 `user` 对象中没有 `status`
   - 前端判断 `user?.status === 'PENDING_DELETE'` 失败
   - 用户被导航到主应用而不是待删除提示页面

## 修复方案

### 1. 后端修复

#### 1.1 更新 `UserDto` 接口

**文件**：`core/src/types/dto.ts`

添加 `status` 和 `deleteScheduledAt` 字段：

```typescript
export interface UserDto {
  userId: string;
  // ... 其他字段
  status?: 'ACTIVE' | 'PENDING_DELETE' | 'DELETED';  // 賬號狀態（註銷功能）
  deleteScheduledAt?: string;     // 計劃刪除時間（ISO 8601）
}
```

#### 1.2 更新 `FieldMapper.mapUser` 方法

**文件**：`core/src/utils/fieldMapper.ts`

映射 `status` 和 `delete_scheduled_at` 字段：

```typescript
static mapUser(row: UserRow): UserDto {
  return {
    userId: row.user_id,
    // ... 其他字段
    status: row.status || 'ACTIVE',  // 賬號狀態（註銷功能）
    deleteScheduledAt: formatDate(row.delete_scheduled_at),  // 計劃刪除時間
  };
}
```

### 2. 前端修复

#### 2.1 更新 `User` 接口

**文件**：`app/src/types/user.ts`

添加 `deleteScheduledAt` 字段（`status` 已存在）：

```typescript
export interface User {
  userId: string;
  // ... 其他字段
  status?: UserStatus; // 帳號狀態：ACTIVE | PENDING_DELETE | DELETED
  deleteScheduledAt?: string; // 計劃刪除時間（ISO 8601）
}
```

## 修复后的流程

1. 用户申请注销 → 数据库 `status = 'PENDING_DELETE'`，`delete_scheduled_at` 设置为 7 天后
2. 用户退出登录
3. 用户再次登录：
   - 后端查询用户信息
   - `FieldMapper.mapUser` 映射 `status` 和 `deleteScheduledAt` 字段
   - 返回给前端的 `UserDto` 包含完整的状态信息
4. 前端 `RootNavigator`：
   - 检测到 `user.status === 'PENDING_DELETE'`
   - 显示 `AccountDeletionPendingScreen` 页面
   - 用户看到删除时间和撤销选项

## 相关文件

### 后端

- `core/src/types/dto.ts` - DTO 类型定义
- `core/src/utils/fieldMapper.ts` - 字段映射工具
- `core/src/modules/account/accountService.ts` - 账号管理服务
- `core/src/middleware/accountStatus.ts` - 账号状态中间件

### 前端

- `app/src/types/user.ts` - 用户类型定义
- `app/src/navigation/RootNavigator.tsx` - 根导航器（包含状态判断）
- `app/src/screens/AccountDeletionPending/AccountDeletionPendingScreen.tsx` - 待删除提示页面
- `app/src/services/api/accountService.ts` - 账号管理 API

## 测试步骤

1. **准备测试账号**：
   - 使用一个测试账号登录
   - 进入设置 → 注销账号
   - 确认注销申请

2. **验证待删除状态**：
   - 退出登录
   - 使用相同账号重新登录
   - **预期**：看到账号待删除提示页面
   - **显示内容**：
     - 警告图标
     - 标题："賬號待刪除"
     - 删除时间：显示具体日期
     - 两个按钮："撤銷註銷" 和 "繼續註銷"

3. **测试撤销功能**：
   - 点击"撤銷註銷"按钮
   - **预期**：显示撤销成功提示
   - 账号恢复正常使用

4. **测试继续注销**：
   - 如果点击"繼續註銷"
   - **预期**：退出登录
   - 账号按计划时间删除

## 相关设计文档

- `app.doc/features/註銷賬號功能設計方案.md` - 账号注销功能完整设计
- 7天宽限期设计（`accountService.ts` 第83行）：
  ```sql
  delete_scheduled_at = DATE_ADD(UTC_TIMESTAMP(), INTERVAL 7 DAY)
  ```

## 完成状态

- ✅ 后端 `UserDto` 添加 `status` 和 `deleteScheduledAt` 字段
- ✅ 后端 `FieldMapper.mapUser` 映射 `status` 和 `delete_scheduled_at`
- ✅ 前端 `User` 接口添加 `deleteScheduledAt` 字段
- ✅ 无 lint 错误

**状态**：✅ 已完成，请重新测试注销功能

