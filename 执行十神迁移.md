# 执行十神解读数据库迁移

## 📋 迁移步骤

### 方法1：使用 MySQL 命令行（推荐）

打开终端，执行以下命令：

```bash
cd /Users/gaoxuxu/Desktop/xiaopei-app

# 步骤1: 创建表
mysql -u root -p xiaopei < core/src/database/migrations/033_create_shishen_readings.sql

# 步骤2: 插入数据（40条记录）
mysql -u root -p xiaopei < core/src/database/migrations/034_insert_shishen_readings.sql
```

**注意**：执行时会提示输入数据库密码。

### 方法2：使用迁移脚本

```bash
cd /Users/gaoxuxu/Desktop/xiaopei-app
./run-shishen-migration.sh
```

脚本会提示输入数据库密码。

---

## ✅ 验证迁移是否成功

执行以下命令验证数据：

```bash
mysql -u root -p xiaopei -e "
SELECT 
  COUNT(*) as total_count,
  COUNT(DISTINCT shishen_code) as shishen_count,
  COUNT(DISTINCT pillar_type) as pillar_count
FROM shishen_readings 
WHERE is_active = TRUE;
"
```

**预期结果**：
- `total_count`: 40（10个十神 × 4个柱位）
- `shishen_count`: 10（10个不同的十神）
- `pillar_count`: 4（年、月、日、时）

---

## 🔍 检查每个十神的数据

```bash
mysql -u root -p xiaopei -e "
SELECT 
  shishen_code,
  COUNT(*) as count
FROM shishen_readings 
WHERE is_active = TRUE 
GROUP BY shishen_code
ORDER BY shishen_code;
"
```

**预期结果**：每个十神应该有 4 条记录（对应 4 个柱位）。

---

## ⚠️ 常见问题

### 问题1：Access denied
- 检查数据库密码是否正确
- 检查用户是否有权限访问 `xiaopei` 数据库

### 问题2：Table already exists
- 如果表已存在，迁移脚本会跳过创建（使用了 `CREATE TABLE IF NOT EXISTS`）
- 如果数据已存在，插入可能会失败（有唯一索引）
- 可以手动删除表后重新执行：
  ```sql
  DROP TABLE IF EXISTS shishen_readings;
  ```

### 问题3：数据库不存在
- 先创建数据库：
  ```sql
  CREATE DATABASE IF NOT EXISTS xiaopei CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
  ```

---

## 📝 迁移完成后

1. ✅ 验证数据是否正确插入
2. ✅ 重启 Core 服务
3. ✅ 在 App 中测试十神解读功能

---

## 🎯 快速验证命令

```bash
# 一键验证（需要输入密码）
mysql -u root -p xiaopei << EOF
SELECT 
  '总记录数' as metric,
  COUNT(*) as value
FROM shishen_readings 
WHERE is_active = TRUE
UNION ALL
SELECT 
  '十神种类数',
  COUNT(DISTINCT shishen_code)
FROM shishen_readings 
WHERE is_active = TRUE
UNION ALL
SELECT 
  '柱位种类数',
  COUNT(DISTINCT pillar_type)
FROM shishen_readings 
WHERE is_active = TRUE;
EOF
```


