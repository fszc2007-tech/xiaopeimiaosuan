# 生产环境诊断与修复方案

## 📋 问题概述

**症状**：生产包（EAS Build + Cloud Run）中：
- ❌ 短信验证码收不到
- ❌ Google 登录不成功

**根因分析**：根据你的排查思路，最可能的原因是：
1. **生产包 API_BASE_URL 配置错误**（最高概率）
2. **Cloud Run 后端环境变量缺失**（Tencent SMS / Google OAuth 密钥）

---

## 🔍 第一步：诊断生产包 API_BASE_URL

### 当前问题
- `app/src/config/env.ts` 中，生产环境（`ENV.ENABLE_LOG = false`）**不会打印** API_BASE_URL
- 无法确认生产包是否真的使用了 `eas.json` 中配置的地址

### 修复方案

**修改 `app/src/config/env.ts`**：添加**强制诊断打印**（即使生产环境也打印一次）

```typescript
// 启动时打印环境配置（用于调试）
if (ENV.ENABLE_LOG) {
  console.log('[ENV Config] 🌍 当前环境:', ENV.APP_ENV);
  console.log('[ENV Config] 🔗 API Base URL:', ENV.API_BASE_URL);
  console.log('[ENV Config] 📝 EXPO_PUBLIC_API_BASE_URL:', process.env.EXPO_PUBLIC_API_BASE_URL || '未设置');
  console.log('[ENV Config] 🎭 Mock iOS 订阅:', ENV.MOCK_IOS_SUBSCRIPTION ? '✅ 开启' : '❌ 关闭');
}

// ⚠️ P0 诊断：生产环境也强制打印一次（用于排查）
// 使用 console.warn 确保在 React Native 日志中可见
console.warn('[ENV DIAGNOSTIC] 🔍 API_BASE_URL:', ENV.API_BASE_URL);
console.warn('[ENV DIAGNOSTIC] 🔍 EXPO_PUBLIC_API_BASE_URL:', process.env.EXPO_PUBLIC_API_BASE_URL || '❌ 未设置');
console.warn('[ENV DIAGNOSTIC] 🔍 APP_ENV:', ENV.APP_ENV);
```

**预期结果**：
- 如果打印的是 `https://xiaopei-core-343578696044.asia-east2.run.app` → ✅ 配置正确
- 如果打印的是 `http://localhost:3000` 或空字符串 → ❌ **配置错误，需要修复 EAS 构建配置**

---

## 🔍 第二步：检查 Cloud Run 环境变量

### 必需的环境变量清单

#### 1. 短信服务（Tencent SMS）

```bash
# 腾讯云 API 密钥（必须）
XIAOPEI_TENCENT_SECRET_ID=your_secret_id
XIAOPEI_TENCENT_SECRET_KEY=your_secret_key

# 腾讯云短信配置（必须）
XIAOPEI_TENCENT_SMS_APP_ID=2400003800
XIAOPEI_TENCENT_SMS_TEMPLATE_ID=2929187
XIAOPEI_TENCENT_SMS_REGION=ap-guangzhou  # 或 ap-singapore（海外账户）

# 验证码安全配置（必须）
XIAOPEI_SMS_CODE_SALT=your_random_salt_32_chars_min
```

**⚠️ 注意**：
- 当前代码（`core/src/config/sms.ts`）有硬编码的 fallback，但**生产环境必须使用环境变量**
- 如果 Cloud Run 没有设置这些变量，会使用硬编码的值（可能不是生产环境的密钥）

#### 2. Google OAuth

```bash
# Google OAuth Client IDs（必须，逗号分隔）
GOOGLE_ALLOWED_CLIENT_IDS=343578696044-gfrfdivav9muhaosdsf01fib85b9ep6q.apps.googleusercontent.com,343578696044-gjrucpeateqd8gln9fev4u3bqc5ime0q.apps.googleusercontent.com,343578696044-rtabgtpti1lpn1hhe5pqccljoac8d7ns.apps.googleusercontent.com
```

**⚠️ 注意**：
- 如果 `GOOGLE_ALLOWED_CLIENT_IDS` 为空，`GOOGLE_ALLOWED_CLIENT_IDS.length === 0`，会导致验证失败
- 当前代码（`core/src/modules/auth/thirdPartyAuthService.ts:24`）会打印日志，可以在 Cloud Run Logs 中查看

#### 3. 其他必需配置

```bash
# JWT 密钥（必须）
XIAOPEI_JWT_SECRET=your_jwt_secret_min_32_chars

# 数据库配置（必须）
XIAOPEI_MYSQL_HOST=your_db_host
XIAOPEI_MYSQL_PORT=3306
XIAOPEI_MYSQL_USER=your_db_user
XIAOPEI_MYSQL_PASSWORD=your_db_password
XIAOPEI_MYSQL_DATABASE=xiaopei

# Redis 配置（用于限流，必须）
XIAOPEI_REDIS_URL=redis://your_redis_host:6379
```

---

## 🔧 第三步：修复方案

### 方案 A：修复 EAS 构建配置（如果 API_BASE_URL 错误）

**检查 `app/eas.json`**：
```json
{
  "build": {
    "production": {
      "env": {
        "EXPO_PUBLIC_ENV": "production",
        "EXPO_PUBLIC_API_BASE_URL": "https://xiaopei-core-343578696044.asia-east2.run.app",
        "EXPO_PUBLIC_APP_ENV_HEADER": "production"
      }
    }
  }
}
```

**如果配置正确但生产包仍然不对**：
1. 检查是否使用了正确的 EAS profile（`eas build --profile production`）
2. 检查 EAS Secrets 是否覆盖了环境变量（`eas secret:list`）
3. 重新构建：`eas build --platform android --profile production`

### 方案 B：配置 Cloud Run 环境变量

#### 方法 1：使用 gcloud CLI

```bash
# 设置短信配置
gcloud run services update xiaopei-core \
  --region=asia-east2 \
  --set-env-vars="XIAOPEI_TENCENT_SECRET_ID=your_secret_id" \
  --set-env-vars="XIAOPEI_TENCENT_SECRET_KEY=your_secret_key" \
  --set-env-vars="XIAOPEI_TENCENT_SMS_APP_ID=2400003800" \
  --set-env-vars="XIAOPEI_TENCENT_SMS_TEMPLATE_ID=2929187" \
  --set-env-vars="XIAOPEI_TENCENT_SMS_REGION=ap-guangzhou" \
  --set-env-vars="XIAOPEI_SMS_CODE_SALT=your_random_salt"

# 设置 Google OAuth
gcloud run services update xiaopei-core \
  --region=asia-east2 \
  --set-env-vars="GOOGLE_ALLOWED_CLIENT_IDS=343578696044-gfrfdivav9muhaosdsf01fib85b9ep6q.apps.googleusercontent.com,343578696044-gjrucpeateqd8gln9fev4u3bqc5ime0q.apps.googleusercontent.com,343578696044-rtabgtpti1lpn1hhe5pqccljoac8d7ns.apps.googleusercontent.com"
```

#### 方法 2：使用 Secret Manager（推荐，更安全）

```bash
# 1. 创建 Secret
echo -n "your_secret_id" | gcloud secrets create xiaopei-tencent-secret-id --data-file=-
echo -n "your_secret_key" | gcloud secrets create xiaopei-tencent-secret-key --data-file=-

# 2. 授予 Cloud Run 服务账号访问权限
gcloud secrets add-iam-policy-binding xiaopei-tencent-secret-id \
  --member="serviceAccount:PROJECT_NUMBER-compute@developer.gserviceaccount.com" \
  --role="roles/secretmanager.secretAccessor"

# 3. 在 Cloud Run 中挂载 Secret
gcloud run services update xiaopei-core \
  --region=asia-east2 \
  --set-secrets="XIAOPEI_TENCENT_SECRET_ID=xiaopei-tencent-secret-id:latest"
```

#### 方法 3：使用 GCP Console

1. 打开 [Cloud Run Console](https://console.cloud.google.com/run)
2. 选择服务 `xiaopei-core`
3. 点击「编辑和部署新版本」
4. 在「变量和密钥」标签页中添加环境变量
5. 部署新版本

---

## 🔍 第四步：验证修复

### 1. 验证 API_BASE_URL

**在 App 中查看日志**：
- 打开 React Native Debugger 或查看设备日志
- 搜索 `[ENV DIAGNOSTIC]`，确认打印的 API_BASE_URL 是否正确

**使用 curl 测试后端**：
```bash
curl https://xiaopei-core-343578696044.asia-east2.run.app/health
```

### 2. 验证短信服务

**查看 Cloud Run Logs**：
```bash
gcloud logging read "resource.type=cloud_run_revision AND resource.labels.service_name=xiaopei-core" \
  --limit=50 \
  --format=json \
  --filter="textPayload=~'SMS|Tencent|验证码'"
```

**预期日志**：
- ✅ 如果看到 `[SMS] 发送成功` → 短信服务正常
- ❌ 如果看到 `[SMS] 发送失败` 或 `鉴权失败` → 检查 Tencent 密钥配置
- ❌ 如果看到 `模板未审核` → 检查模板 ID 和审核状态

### 3. 验证 Google OAuth

**查看 Cloud Run Logs**：
```bash
gcloud logging read "resource.type=cloud_run_revision AND resource.labels.service_name=xiaopei-core" \
  --limit=50 \
  --format=json \
  --filter="textPayload=~'Google|GOOGLE_ALLOWED_CLIENT_IDS|aud mismatch'"
```

**预期日志**：
- ✅ 如果看到 `GOOGLE_ALLOWED_CLIENT_IDS loaded` 且 `count > 0` → 配置正确
- ❌ 如果看到 `Invalid audience` 或 `aud mismatch` → 检查 Client ID 配置
- ❌ 如果看到 `GOOGLE_ALLOWED_CLIENT_IDS loaded` 且 `count === 0` → **环境变量未设置**

---

## 📝 快速诊断清单

### ✅ 检查项 1：生产包 API_BASE_URL

- [ ] 在 App 启动日志中查看 `[ENV DIAGNOSTIC]` 输出
- [ ] 确认打印的 URL 是 `https://xiaopei-core-343578696044.asia-east2.run.app`
- [ ] 如果不是，检查 `eas.json` 并重新构建

### ✅ 检查项 2：Cloud Run 环境变量

- [ ] 检查 `XIAOPEI_TENCENT_SECRET_ID` 是否设置
- [ ] 检查 `XIAOPEI_TENCENT_SECRET_KEY` 是否设置
- [ ] 检查 `GOOGLE_ALLOWED_CLIENT_IDS` 是否设置且不为空
- [ ] 检查 Cloud Run Logs 中是否有相关错误

### ✅ 检查项 3：短信服务

- [ ] 查看 Cloud Run Logs 中是否有短信发送请求
- [ ] 如果没有请求 → **问题在 App 端（API_BASE_URL 错误）**
- [ ] 如果有请求但失败 → **问题在后端（密钥/模板/网络）**

### ✅ 检查项 4：Google OAuth

- [ ] 查看 Cloud Run Logs 中是否有 Google 登录请求
- [ ] 如果没有请求 → **问题在 App 端（API_BASE_URL 错误或 idToken 为空）**
- [ ] 如果有请求但 `aud mismatch` → **检查 GOOGLE_ALLOWED_CLIENT_IDS 配置**

---

## 🚨 常见错误与解决方案

### 错误 1：生产包 API_BASE_URL 是 localhost

**原因**：EAS Build 时环境变量未正确注入

**解决**：
1. 检查 `eas.json` 配置
2. 检查 EAS Secrets 是否覆盖了环境变量
3. 重新构建：`eas build --platform android --profile production --clear-cache`

### 错误 2：短信发送失败，错误码 401/403

**原因**：Tencent 密钥错误或未设置

**解决**：
1. 检查 Cloud Run 环境变量 `XIAOPEI_TENCENT_SECRET_ID` 和 `XIAOPEI_TENCENT_SECRET_KEY`
2. 确认密钥是生产环境的密钥（不是测试密钥）
3. 检查腾讯云控制台中密钥是否有效

### 错误 3：短信发送失败，错误码 1001（模板未审核）

**原因**：短信模板未通过审核

**解决**：
1. 登录腾讯云控制台 → 短信服务 → 模板管理
2. 确认模板 ID `2929187` 状态为「已审核」
3. 如果未审核，提交审核或使用已审核的模板

### 错误 4：Google 登录失败，`Invalid audience` 或 `aud mismatch`

**原因**：`GOOGLE_ALLOWED_CLIENT_IDS` 未设置或配置错误

**解决**：
1. 检查 Cloud Run 环境变量 `GOOGLE_ALLOWED_CLIENT_IDS`
2. 确认包含所有 Client ID（Web/Android/iOS），用逗号分隔，无空格
3. 确认 Client ID 格式正确（以 `.apps.googleusercontent.com` 结尾）

### 错误 5：后端完全收不到请求（Cloud Run Logs 中没有任何相关日志）

**原因**：App 没有打到正确的后端（API_BASE_URL 错误）

**解决**：
1. 在 App 中打印 API_BASE_URL（使用上面的诊断代码）
2. 确认 URL 正确
3. 检查网络连接（是否在 VPC 中，是否有防火墙规则）

---

## 📞 下一步行动

1. **立即执行**：添加诊断代码（修改 `app/src/config/env.ts`）
2. **重新构建**：`eas build --platform android --profile production`
3. **安装测试**：在设备上安装新构建的包，查看启动日志
4. **检查 Cloud Run**：查看环境变量和日志
5. **根据诊断结果**：按照上面的方案修复

---

## 📚 参考文档

- [Expo Environment Variables](https://docs.expo.dev/guides/environment-variables/)
- [EAS Build Configuration](https://docs.expo.dev/build/eas-json/)
- [Cloud Run Environment Variables](https://cloud.google.com/run/docs/configuring/environment-variables)
- [Cloud Run Secret Manager](https://cloud.google.com/run/docs/configuring/secrets)
- [腾讯云短信错误码](https://cloud.tencent.com/document/product/382/3771)
- [Google OAuth Token Verification](https://developers.google.com/identity/sign-in/web/backend-auth)

