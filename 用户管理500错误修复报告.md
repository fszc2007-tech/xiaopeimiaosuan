# ç”¨æˆ·ç®¡ç† 500 é”™è¯¯ä¿®å¤æŠ¥å‘Š

## âŒ é—®é¢˜ç°è±¡

ç”¨æˆ·åœ¨ Admin åå°è®¿é—®"ç”¨æˆ·ç®¡ç†"é¡µé¢æ—¶é‡åˆ°ï¼š

```
Failed to load resource: the server responded with a status of 500 (Internal Server Error)
/api/admin/v1/users?page=1&pageSize=20
/api/admin/v1/users/test
```

## ğŸ” é—®é¢˜åŸå› 

**åç«¯ä»£ç ä½¿ç”¨äº†æœªå®šä¹‰çš„ `db` å˜é‡**ï¼Œåº”è¯¥ä½¿ç”¨ `getPool()` è·å–æ•°æ®åº“è¿æ¥æ± ã€‚

### é”™è¯¯ä»£ç 
```typescript
// core/src/modules/admin/adminUserService.ts

export async function getUserList(...) {
  // âŒ é”™è¯¯ï¼šdb æœªå®šä¹‰
  const [countRows] = await db.query<any[]>(
    `SELECT COUNT(*) as total FROM users WHERE ${whereClause}`,
    params
  );
  
  const [rows] = await db.query<UserRow[]>(
    `SELECT * FROM users WHERE ${whereClause} ORDER BY created_at DESC LIMIT ? OFFSET ?`,
    [...params, pageSize, offset]
  );
  ...
}
```

### ä¸ºä»€ä¹ˆä¼šæœ‰è¿™ä¸ªé—®é¢˜ï¼Ÿ

ä¸ä¹‹å‰ `llmConfigService.ts` çš„é—®é¢˜ä¸€æ ·ï¼Œå¼€å‘æ—¶ä½¿ç”¨äº† `db` å˜é‡ä½†å¿˜è®°å¯¼å…¥æˆ–å®šä¹‰ï¼Œå¯¼è‡´è¿è¡Œæ—¶æŠ¥é”™ã€‚

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### æ‰¹é‡æ›¿æ¢æ‰€æœ‰ `db.query` ä¸º `getPool().query`

```bash
cd core/src/modules/admin
sed -i.bak 's/await db\.query</await getPool().query</g' adminUserService.ts
```

### ä¿®å¤ç»Ÿè®¡

ä¸€å…±ä¿®å¤äº† **16 å¤„** `db.query` è°ƒç”¨ï¼š

1. `getUserList()` - 2 å¤„
2. `getUserDetail()` - 5 å¤„
3. `createTestUser()` - 3 å¤„
4. `getOrCreateCursorTestAccount()` - 3 å¤„
5. `resetCursorTestAccountPassword()` - 2 å¤„
6. å…¶ä»–è¾…åŠ©å‡½æ•° - 1 å¤„

---

## ğŸ¨ UI ä¼˜åŒ–

### é—®é¢˜

ç”¨æˆ·åé¦ˆï¼š**"æˆªå›¾çš„ UI å¯ä»¥ç¼©å°ä¸€ç‚¹ï¼Œä¸ç”¨é‚£ä¹ˆå¤§"**

### ä¼˜åŒ–å†…å®¹

#### 1. **æ•´ä½“é—´è·ç¼©å°**
```typescript
// ä¿®æ”¹å‰
<div>  // æ—  padding

// ä¿®æ”¹å
<div style={{ padding: '12px 16px' }}>  // ç´§å‡‘ padding
```

#### 2. **Card ç»„ä»¶ç¼©å°**
```typescript
<Card 
  title={<span style={{ fontSize: 14 }}>ç”¨æˆ·åˆ—è¡¨</span>}  // å­—ä½“ 14px
  size="small"  // ç´§å‡‘æ¨¡å¼
  style={{ marginBottom: 12 }}  // å‡å°é—´è·
>
```

#### 3. **Table ç»„ä»¶ç¼©å°**
```typescript
<Table
  size="small"  // ç´§å‡‘æ¨¡å¼
  columns={columns}  // åˆ—å®½ä¼˜åŒ–
  pagination={{
    size: 'small',  // åˆ†é¡µå™¨ç´§å‡‘æ¨¡å¼
    showTotal: (total) => <span style={{ fontSize: 12 }}>å…± {total} æ¡</span>
  }}
/>
```

#### 4. **è¡¨æ ¼åˆ—å®½ä¼˜åŒ–**
```typescript
columns: [
  { title: 'ç”¨æˆ· ID', width: 220 },  // å‡å°
  { title: 'æ‰‹æœºå·', width: 120 },   // å‡å°
  { title: 'é‚®ç®±', width: 180 },     // å‡å°
  { title: 'åœ°åŒº', width: 70 },      // å‡å°
  { title: 'Pro çŠ¶æ€', width: 80 },  // å‡å°
  { title: 'æ“ä½œ', width: 80 },      // å‡å°
]
```

#### 5. **æ–‡å­—å¤§å°ç¼©å°**
```typescript
// ID é“¾æ¥
<a style={{ fontSize: 12 }}>{id}</a>

// æ™®é€šæ–‡å­—
<span style={{ fontSize: 12 }}>{phone || '-'}</span>

// æ ‡ç­¾
<Tag style={{ fontSize: 11 }}>å¤§é™†</Tag>

// æŒ‰é’®
<Button style={{ fontSize: 12 }}>è¯¦æƒ…</Button>
```

#### 6. **æœç´¢æ¡†ç¼©å°**
```typescript
<Search
  style={{ width: 200 }}  // å‡å°å®½åº¦
  size="small"            // ç´§å‡‘æ¨¡å¼
  placeholder="æœç´¢æ‰‹æœºå·/é‚®ç®±"
/>
```

---

## ğŸ“Š ä¼˜åŒ–å‰åå¯¹æ¯”

| ç»„ä»¶ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å |
|-----|-------|--------|
| é¡µé¢ padding | æ—  | `12px 16px` |
| Card size | default | **small** |
| Card æ ‡é¢˜å­—ä½“ | 16px | **14px** |
| Table size | default | **small** |
| è¡¨æ ¼å†…å®¹å­—ä½“ | 14px | **12px** |
| æ ‡ç­¾å­—ä½“ | 12px | **11px** |
| æœç´¢æ¡†å®½åº¦ | 300px | **200px** |
| ç”¨æˆ· ID åˆ—å®½ | 280px | **220px** |
| æ‰‹æœºå·åˆ—å®½ | 150px | **120px** |
| é‚®ç®±åˆ—å®½ | 200px | **180px** |
| åˆ†é¡µå™¨ size | default | **small** |

---

## ğŸ§ª æµ‹è¯•æ­¥éª¤

### 1. å¼ºåˆ¶åˆ·æ–°æµè§ˆå™¨
æŒ‰ **Ctrl/Cmd + Shift + R**

### 2. è®¿é—®ç”¨æˆ·ç®¡ç†
å¯¼èˆªåˆ° Admin åå° â†’ **ç”¨æˆ·ç®¡ç†**

### 3. éªŒè¯åŠŸèƒ½
- âœ… é¡µé¢æ­£å¸¸åŠ è½½ï¼ˆä¸å† 500 é”™è¯¯ï¼‰
- âœ… æ˜¾ç¤ºç”¨æˆ·åˆ—è¡¨
- âœ… æœç´¢åŠŸèƒ½æ­£å¸¸
- âœ… åˆ†é¡µåŠŸèƒ½æ­£å¸¸
- âœ… ç‚¹å‡»"è¯¦æƒ…"å¯æŸ¥çœ‹ç”¨æˆ·è¯¦æƒ…

### 4. éªŒè¯ UI
- âœ… é¡µé¢æ›´ç´§å‡‘ï¼Œä¸å†å ç”¨è¿‡å¤šç©ºé—´
- âœ… å­—ä½“é€‚ä¸­ï¼Œæ˜“äºé˜…è¯»
- âœ… è¡¨æ ¼å†…å®¹ä¸€å±å¯è§æ›´å¤š

### 5. æµ‹è¯•åˆ›å»ºç”¨æˆ·
- ç‚¹å‡»"åˆ›å»ºæµ‹è¯•ç”¨æˆ·"
- å¡«å†™æ‰‹æœºå·/é‚®ç®±ã€å¯†ç 
- ç‚¹å‡»æäº¤
- âœ… åº”è¯¥æˆåŠŸåˆ›å»ºï¼ˆä¸å† 500 é”™è¯¯ï¼‰

---

## ğŸ“ ä¿®æ”¹çš„æ–‡ä»¶

### åç«¯
1. **`core/src/modules/admin/adminUserService.ts`**
   - æ‰¹é‡æ›¿æ¢ 16 å¤„ `db.query` â†’ `getPool().query`

### å‰ç«¯
2. **`admin/src/pages/Users/UserList.tsx`**
   - ç¼©å°æ•´ä½“ padding
   - Card æ”¹ä¸º `size="small"`
   - Table æ”¹ä¸º `size="small"`
   - ä¼˜åŒ–åˆ—å®½
   - ç¼©å°å­—ä½“
   - ç¼©å°æœç´¢æ¡†

---

## âœ… ä¿®å¤å®Œæˆæ¸…å•

| é—®é¢˜ | çŠ¶æ€ | è¯´æ˜ |
|-----|------|------|
| `/api/admin/v1/users` 500 é”™è¯¯ | âœ… å·²ä¿®å¤ | 16 å¤„ db.query ä¿®å¤ |
| `/api/admin/v1/users/test` 500 é”™è¯¯ | âœ… å·²ä¿®å¤ | åŒä¸Š |
| UI å°ºå¯¸è¿‡å¤§ | âœ… å·²ä¼˜åŒ– | ç´§å‡‘æ¨¡å¼ + å­—ä½“ç¼©å° |
| è¡¨æ ¼åˆ—å®½è¿‡å¤§ | âœ… å·²ä¼˜åŒ– | åˆ—å®½å‡å° 20-40px |
| æœç´¢æ¡†è¿‡å¤§ | âœ… å·²ä¼˜åŒ– | 300px â†’ 200px |

---

## ğŸ¯ é¢„æœŸæ•ˆæœ

### åŠŸèƒ½æ­£å¸¸
```
GET /api/admin/v1/users?page=1&pageSize=20
â†’ 200 OK
{
  "success": true,
  "data": {
    "users": [...],
    "pagination": { "total": 0, "page": 1, "pageSize": 20 }
  }
}
```

### UI æ›´ç´§å‡‘
- é¡µé¢å†…å®¹æ›´é›†ä¸­
- ä¸€å±å¯è§æ›´å¤šä¿¡æ¯
- å­—ä½“é€‚ä¸­ï¼Œä¸ä¼šå¤ªå¤§æˆ–å¤ªå°
- äº¤äº’ä½“éªŒæ›´æµç•…

---

**ä¿®å¤æ—¶é—´**: 2025-11-18 12:00  
**ä¿®å¤æ–¹å¼**: æ‰¹é‡æ›¿æ¢ + UI ä¼˜åŒ–  
**å½±å“èŒƒå›´**: Admin ç”¨æˆ·ç®¡ç†æ¨¡å—

