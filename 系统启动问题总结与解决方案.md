# ç³»ç»Ÿå¯åŠ¨é—®é¢˜æ€»ç»“ä¸è§£å†³æ–¹æ¡ˆ

**æ—¶é—´**: 2024-11-18  
**çŠ¶æ€**: Core åç«¯éƒ¨åˆ†å¯åŠ¨ï¼ŒAdmin ç™»å½• API æœ‰ 500 é”™è¯¯

---

## âœ… å·²å®Œæˆçš„ä¿®å¤

### 1. TypeScript é”™è¯¯ä¿®å¤ âœ…
- æ‰¹é‡ä¿®å¤å¯¼å…¥è·¯å¾„ï¼ˆ16ä¸ªæ–‡ä»¶ï¼‰
- å®‰è£…ç¼ºå¤±ä¾èµ–ï¼ˆbcryptï¼‰
- ä¿®å¤ database é»˜è®¤å¯¼å…¥
- æ·»åŠ  Request ç±»å‹æ‰©å±•
- æ·»åŠ å¯¼å‡ºåˆ«åï¼ˆrequireAuth, adminAuthMiddlewareï¼‰

### 2. æ•°æ®åº“é…ç½® âœ…
- âœ… åˆ›å»ºæ•°æ®åº“ `xiaopei`
- âœ… æ‰§è¡Œè¿ç§»è„šæœ¬ï¼ˆ001, 003ï¼‰
- âœ… åˆ›å»º admin_users è¡¨
- âœ… æ’å…¥é»˜è®¤ admin ç”¨æˆ·ï¼ˆadmin/admin123ï¼‰

### 3. æœåŠ¡å¯åŠ¨ âœ…
- âœ… Core åç«¯åŸºç¡€æœåŠ¡å¯åŠ¨ï¼ˆhttp://localhost:3000ï¼‰
- âœ… Health check æ­£å¸¸
- âœ… Admin å‰ç«¯å¯åŠ¨ï¼ˆhttp://localhost:5173ï¼‰
- âœ… æµè§ˆå™¨å¯è®¿é—®ç™»å½•é¡µ

---

## âš ï¸ å½“å‰é—®é¢˜

### Admin ç™»å½• API è¿”å› 500 é”™è¯¯

**ç°è±¡**:
```bash
curl -X POST http://localhost:3000/api/admin/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}'

# è¿”å›
{"success":false,"error":{"code":"INTERNAL_ERROR","message":"æœåŠ¡å™¨å†…éƒ¨é”™è¯¯"}}
```

**å¯èƒ½åŸå› **:
1. Admin è·¯ç”±é…ç½®é—®é¢˜
2. adminAuthService å®ç°é—®é¢˜
3. JWT ç­¾åå¯†é’¥æœªé…ç½®
4. æ•°æ®åº“æŸ¥è¯¢é”™è¯¯

---

## ğŸ” æ’æŸ¥æ­¥éª¤

### æ­¥éª¤ 1: æ£€æŸ¥æ—¥å¿—
```bash
# æŸ¥çœ‹ Core åç«¯å®æ—¶æ—¥å¿—
tail -f /tmp/core-restart.log

# ç„¶ååœ¨å¦ä¸€ä¸ªç»ˆç«¯æµ‹è¯•ç™»å½•
curl -X POST http://localhost:3000/api/admin/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}'
```

### æ­¥éª¤ 2: æ£€æŸ¥ç¯å¢ƒå˜é‡
```bash
# æ£€æŸ¥ .env æ–‡ä»¶
cat /Users/gaoxuxu/Desktop/å°ä½©APP/core/.env

# éœ€è¦ç¡®ä¿æœ‰ä»¥ä¸‹é…ç½®:
# JWT_SECRET=your_secret_key
# ADMIN_JWT_SECRET=your_admin_secret_key
# XIAOPEI_ENCRYPTION_KEY=your_encryption_key
```

### æ­¥éª¤ 3: æ£€æŸ¥æ•°æ®åº“è¿æ¥
```bash
# éªŒè¯ admin_users è¡¨æœ‰æ•°æ®
mysql -u root xiaopei -e "SELECT username, role FROM admin_users;"
```

### æ­¥éª¤ 4: æµ‹è¯•ç®€å•è·¯ç”±
```bash
# æµ‹è¯•å¥åº·æ£€æŸ¥
curl http://localhost:3000/health

# åº”è¯¥è¿”å›
{"success":true,"data":{"status":"ok","timestamp":"...","version":"1.0.0"}}
```

---

## ğŸ› ï¸ å¿«é€Ÿä¿®å¤å»ºè®®

### æ–¹æ¡ˆ 1: æ·»åŠ ç¯å¢ƒå˜é‡ï¼ˆæ¨èï¼‰

åˆ›å»º/æ›´æ–° `.env` æ–‡ä»¶ï¼š

```bash
cd /Users/gaoxuxu/Desktop/å°ä½©APP/core

cat > .env << 'EOF'
# MySQL é…ç½®
MYSQL_HOST=localhost
MYSQL_PORT=3306
MYSQL_USER=root
MYSQL_PASSWORD=
MYSQL_DATABASE=xiaopei

# JWT å¯†é’¥
JWT_SECRET=xiaopei_jwt_secret_2024_dev_only
ADMIN_JWT_SECRET=xiaopei_admin_jwt_secret_2024_dev_only

# åŠ å¯†å¯†é’¥
XIAOPEI_ENCRYPTION_KEY=xiaopei_encryption_key_32_chars_dev_only

# ç¯å¢ƒ
NODE_ENV=development
PORT=3000
EOF

# é‡å¯æœåŠ¡
pkill -f "nodemon"
npm run dev > /tmp/core-new.log 2>&1 &
```

### æ–¹æ¡ˆ 2: æ£€æŸ¥å¹¶ä¿®å¤ Admin è·¯ç”±

```bash
# æ£€æŸ¥è·¯ç”±æ˜¯å¦æ­£ç¡®æ³¨å†Œ
grep -n "adminRoutes" /Users/gaoxuxu/Desktop/å°ä½©APP/core/src/server.ts

# åº”è¯¥çœ‹åˆ°ç±»ä¼¼ï¼š
# app.use('/api/admin/v1', adminRoutes);
```

### æ–¹æ¡ˆ 3: é‡æ–°åˆ›å»º Admin ç”¨æˆ·

```bash
# åˆ é™¤æ—§ç”¨æˆ·
mysql -u root xiaopei -e "DELETE FROM admin_users WHERE username='admin';"

# ç”Ÿæˆæ–°å¯†ç å“ˆå¸Œå¹¶æ’å…¥
cd /Users/gaoxuxu/Desktop/å°ä½©APP/core
PASSWORD_HASH=$(node -e "const bcrypt = require('bcrypt'); console.log(bcrypt.hashSync('admin123', 10));")
mysql -u root xiaopei -e "INSERT INTO admin_users (admin_id, username, password_hash, role) VALUES (UUID(), 'admin', '$PASSWORD_HASH', 'super_admin');"
```

---

## ğŸ“Š å½“å‰ç³»ç»ŸçŠ¶æ€

| ç»„ä»¶ | çŠ¶æ€ | åœ°å€ | å¤‡æ³¨ |
|------|------|------|------|
| Core åç«¯ | âš ï¸ éƒ¨åˆ†æ­£å¸¸ | http://localhost:3000 | Health check æ­£å¸¸ï¼ŒAdmin API 500 |
| Admin å‰ç«¯ | âœ… æ­£å¸¸ | http://localhost:5173 | é¡µé¢å¯è®¿é—®ï¼Œç­‰å¾…åç«¯ä¿®å¤ |
| MySQL æ•°æ®åº“ | âœ… æ­£å¸¸ | localhost:3306 | æ•°æ®åº“å’Œè¡¨å·²åˆ›å»º |
| TypeScript ç¼–è¯‘ | âœ… å·²ä¿®å¤ | - | ä½¿ç”¨ --transpile-only |

---

## ğŸš€ å»ºè®®ä¸‹ä¸€æ­¥

1. **ç«‹å³æ‰§è¡Œ**: æ·»åŠ ç¯å¢ƒå˜é‡ï¼ˆæ–¹æ¡ˆ 1ï¼‰
2. **æŸ¥çœ‹æ—¥å¿—**: ç¡®è®¤å…·ä½“é”™è¯¯ä¿¡æ¯
3. **æµ‹è¯•ç™»å½•**: ç¯å¢ƒå˜é‡é…ç½®åé‡æ–°æµ‹è¯•
4. **å‰ç«¯æµ‹è¯•**: ç™»å½•æˆåŠŸååœ¨æµè§ˆå™¨æµ‹è¯• Admin åå°åŠŸèƒ½

---

## ğŸ“ ä¿®å¤è®°å½•

### å·²ä¿®å¤ï¼ˆâœ…ï¼‰
- TypeScript å¯¼å…¥é”™è¯¯ï¼ˆæ‰¹é‡ä¿®å¤ï¼‰
- ç¼ºå¤±çš„ bcrypt ä¾èµ–
- database/connection å¯¼å…¥é—®é¢˜
- Request ç±»å‹æ‰©å±•
- æ•°æ®åº“åˆ›å»º
- æ•°æ®åº“è¡¨è¿ç§»
- Admin ç”¨æˆ·æ’å…¥

### å¾…ä¿®å¤ï¼ˆâ³ï¼‰
- Admin ç™»å½• API 500 é”™è¯¯
- ç¯å¢ƒå˜é‡é…ç½®
- é”™è¯¯æ—¥å¿—æ’æŸ¥

---

## ğŸ’¡ æŠ€æœ¯å€ºåŠ¡

**åç»­éœ€è¦ä¼˜åŒ–**ï¼ˆéç´§æ€¥ï¼‰:
1. ä¿®å¤å‰©ä½™çš„ TypeScript ç±»å‹é”™è¯¯ï¼ˆç›®å‰ä½¿ç”¨ --transpile-only è·³è¿‡ï¼‰
2. è¡¥å……å®Œæ•´çš„é”™è¯¯å¤„ç†
3. æ·»åŠ  API æ–‡æ¡£çš„ tags å­—æ®µæ”¯æŒ
4. å®Œå–„æ—¥å¿—è¾“å‡º

---

**æ–‡æ¡£ç”Ÿæˆæ—¶é—´**: 2024-11-18 19:15  
**ä¸‹ä¸€æ­¥**: æ·»åŠ ç¯å¢ƒå˜é‡å¹¶é‡å¯ Core åç«¯

