# 项目目录结构说明

> **版本**: v1.0  
> **创建日期**: 2024年11月  
> **状态**: 开发前确认

---

## 一、三大核心目录说明

### 1.1 `app/` - App 前端代码（React Native）

**用途**: 小佩 App 的移动端前端代码

**技术栈**:
- React Native 0.73+
- TypeScript
- Expo (Managed Workflow)

**目录结构**（待创建）:
```
app/
├── src/
│   ├── screens/              # 页面组件（只负责 UI）
│   │   ├── Auth/             # 登录/注册页
│   │   ├── Home/             # 用户引导页
│   │   ├── ManualBazi/       # 手动排盘页
│   │   ├── ChartDetail/      # 命盘详情页（三大 Tab）
│   │   ├── Cases/            # 檔案 - 命盘列表页
│   │   ├── XiaoPeiHome/      # 小佩主页
│   │   ├── Chat/             # 聊天页（公共组件）
│   │   └── Me/               # 我的页面
│   ├── components/           # UI 组件（只负责展示）
│   │   ├── common/           # 通用组件（Button、Card、Input 等）
│   │   ├── chat/             # 聊天相关组件（ChatBubble、InputComposer 等）
│   │   └── chart/            # 命盘相关组件（ChartTable、ShenShaCard 等）
│   ├── navigation/           # 路由导航
│   │   ├── AppNavigator.tsx  # 主导航器
│   │   ├── types.ts          # 导航类型定义
│   │   └── routes.ts         # 路由常量
│   ├── store/                # 状态管理（只管理 UI 状态）
│   │   ├── userStore.ts      # 用户状态
│   │   ├── chartStore.ts     # 命盘状态
│   │   └── chatStore.ts      # 聊天状态
│   ├── services/
│   │   └── api/              # API 调用层（统一封装）
│   │       ├── client.ts     # HTTP 客户端
│   │       ├── authService.ts
│   │       ├── chartService.ts
│   │       ├── readingService.ts
│   │       └── endpoints.ts  # API 路径常量
│   ├── types/                # TypeScript 类型定义（只定义 API 返回的数据类型）
│   ├── theme/                # UI 主题（Design Tokens）
│   │   ├── colors.ts
│   │   ├── typography.ts
│   │   ├── layout.ts
│   │   └── index.ts
│   ├── i18n/                 # 国际化
│   │   ├── zh-CN.json
│   │   ├── zh-HK.json
│   │   └── index.ts
│   └── utils/                # 工具函数（仅展示层格式化，不包含业务逻辑）
├── assets/                   # 静态资源
│   ├── images/
│   │   └── logo/             # Logo 和头像
│   └── fonts/
├── App.tsx                   # App 入口
├── package.json
├── tsconfig.json
├── .eslintrc.js              # ESLint 配置（禁止导入 core/engine）
└── app.json                  # Expo 配置
```

**关键原则**:
- ❌ **禁止**引入 `core/engine`
- ❌ **禁止**包含 prompt 模板
- ❌ **禁止**进行计费判断（业务逻辑）
- ✅ 只负责 UI 渲染和用户交互
- ✅ 所有业务逻辑通过 API 调用

---

### 1.2 `admin/` - Admin 管理后台代码

**用途**: Admin 管理后台的前端代码

**技术栈**（待确定）:
- React / Vue / 其他前端框架
- TypeScript
- 或使用 Next.js / 其他全栈框架

**目录结构**（待创建）:
```
admin/
├── src/
│   ├── pages/                # 页面组件
│   │   ├── Login/            # 管理员登录页
│   │   ├── Users/            # 用户管理页
│   │   │   ├── UserList.tsx  # 用户列表
│   │   │   └── UserDetail.tsx # 用户详情
│   │   ├── LLMConfig/        # 大模型配置页
│   │   │   ├── DeepSeekConfig.tsx
│   │   │   ├── ChatGPTConfig.tsx
│   │   │   └── QwenConfig.tsx
│   │   └── Settings/         # 系统设置页
│   ├── components/           # UI 组件
│   ├── services/
│   │   └── api/              # API 调用层
│   │       ├── adminAuthService.ts
│   │       ├── userService.ts
│   │       └── llmConfigService.ts
│   ├── types/                # TypeScript 类型定义
│   └── utils/                # 工具函数
├── package.json
└── ...
```

**功能模块**:
- 管理员登录
- 用户管理（列表、详情、创建测试用户、Cursor 测试账号）
- 大模型 API 配置（DeepSeek、ChatGPT、Qwen）
- 系统设置

---

### 1.3 `core/` - Core 后端核心服务代码

**用途**: 后端核心服务，包含所有业务逻辑、算法、prompt 模板

**技术栈**（待确定）:
- Node.js / Express / 其他后端框架
- TypeScript
- MySQL（数据存储）

**目录结构**:
```
core/
├── src/
│   ├── modules/              # 业务模块
│   │   ├── auth/             # 鉴权模块
│   │   │   ├── login.ts      # 登录/注册逻辑
│   │   │   ├── token.ts      # Token 管理
│   │   │   └── middleware.ts # 鉴权中间件
│   │   ├── user/             # 用户模块
│   │   │   ├── userService.ts
│   │   │   └── profileService.ts
│   │   ├── bazi/             # 命盘模块
│   │   │   ├── engine/       # 调用 core/engine
│   │   │   │   └── baziEngine.ts
│   │   │   ├── blocks/       # Blocks 计算
│   │   │   │   └── blocksEngine.ts
│   │   │   └── chartService.ts
│   │   ├── intent/           # 意图识别
│   │   │   └── intentEngine.ts
│   │   ├── reading/          # 解读编排
│   │   │   └── readingEngine.ts
│   │   ├── prompt/           # Prompt 模板管理（不对外暴露）
│   │   │   ├── templates.ts  # Prompt 模板
│   │   │   └── builder.ts    # Prompt 拼接
│   │   ├── billing/          # 计费模块
│   │   │   └── entitlementService.ts
│   │   └── ai/               # LLM 服务网关
│   │       ├── aiService.ts  # 统一 LLM 调用接口
│   │       ├── deepseek.ts   # DeepSeek 实现
│   │       ├── chatgpt.ts    # ChatGPT 实现
│   │       └── qwen.ts       # Qwen 实现
│   ├── routes/               # API 路由
│   │   ├── auth.ts           # 认证路由
│   │   ├── bazi.ts           # 命盘路由
│   │   ├── reading.ts        # 解读路由
│   │   ├── chat.ts           # 对话路由
│   │   └── admin.ts          # Admin 路由
│   ├── middleware/           # 中间件
│   │   ├── auth.ts           # 鉴权中间件
│   │   ├── entitlement.ts    # 权限检查中间件
│   │   ├── rateLimit.ts      # 限流中间件
│   │   └── errorHandler.ts   # 错误处理中间件
│   ├── database/             # 数据库相关
│   │   ├── connection.ts     # 数据库连接
│   │   └── models/           # 数据模型
│   └── utils/                # 工具函数
│       └── encryption.ts     # API Key 加密
├── engine/                   # 八字引擎（算法）
│   ├── analysis/
│   ├── astronomy/
│   ├── fortune/
│   ├── ganzhi/
│   ├── lunar/
│   ├── mingli/
│   ├── shensha/
│   ├── utils/
│   └── index.js
├── system_prompt/            # 系统 Prompt（小佩人设）
│   └── ...                   # 待创建 Prompt 文件
├── config/                   # 配置文件
│   └── prompts/              # Prompt 模板配置（不对外暴露）
├── package.json
└── server.ts                 # 服务器入口
```

**关键原则**:
- ✅ 包含所有业务逻辑
- ✅ 包含所有算法（调用 `core/engine`）
- ✅ 包含所有 prompt 模板（不对外暴露）
- ✅ 包含所有计费判断
- ✅ 所有 API 返回统一格式（包含 `success` 字段）

---

## 二、开发前检查清单确认

### ✅ 已确认的检查项

- [x] **所有 API 路径使用 `/api/v1/...` 前缀**
  - 统一使用 `/api/v1/...` 前缀
  - 示例：`POST /api/v1/bazi/chart`、`GET /api/v1/bazi/charts/:chartId`

- [x] **所有路径参数使用 `chartId` 而不是 `id`**
  - 统一使用 `chartId` 作为路径参数
  - 示例：`/api/v1/bazi/charts/:chartId`（不是 `:id` 或 `:mingpanId`）

- [x] **登录支持手机号（CN）和邮箱（HK）**
  - CN 区域：手机号登录
  - HK 区域：邮箱登录
  - 根据 `app_region` 自动选择登录方式

- [x] **错误响应格式包含 `success` 字段**
  - 成功：`{ success: true, data: T }`
  - 错误：`{ success: false, error: { code, message, details? } }`

- [x] **模型配置仅支持三个模型（DeepSeek、ChatGPT、Qwen）**
  - 仅支持三个模型，没有其他模型
  - 如有需要再另外增加（先不开发）

- [x] **遵循安全规范（前端不引入 `core/engine`）**
  - `app/` 目录禁止引入 `core/engine`
  - `app/` 目录禁止包含 prompt 模板
  - `app/` 目录禁止进行计费判断（业务逻辑）
  - 所有业务逻辑通过 API 调用

---

## 三、目录职责划分

### 3.1 `app/` 目录职责

**负责**:
- ✅ UI 渲染和用户交互
- ✅ 状态管理（UI 状态）
- ✅ 路由导航
- ✅ API 调用（通过统一的 `apiService`）
- ✅ 数据展示和格式化（仅展示层）

**不负责**:
- ❌ 命盘算法计算
- ❌ Prompt 模板存储或拼接
- ❌ Blocks_json 计算
- ❌ 计费判断（业务逻辑）
- ❌ 意图识别（业务逻辑）

---

### 3.2 `admin/` 目录职责

**负责**:
- ✅ Admin 后台 UI 渲染
- ✅ 用户管理界面
- ✅ 大模型配置界面
- ✅ API 调用（调用 `core` 的 Admin API）

**不负责**:
- ❌ 业务逻辑（在 `core` 中实现）
- ❌ 数据存储（在 `core` 中实现）

---

### 3.3 `core/` 目录职责

**负责**:
- ✅ 所有业务逻辑
- ✅ 用户鉴权
- ✅ 命盘算法计算（调用 `core/engine`）
- ✅ Blocks_json 计算
- ✅ Prompt 模板管理和拼接
- ✅ 意图识别
- ✅ LLM 调用
- ✅ 计费判断
- ✅ 数据存储（MySQL）
- ✅ API 接口实现

**不负责**:
- ❌ UI 渲染（由 `app/` 和 `admin/` 负责）

---

## 四、目录间关系

```
┌─────────────┐         ┌─────────────┐
│    app/     │────────▶│    core/    │
│  (前端 App) │  HTTP   │  (后端服务) │
└─────────────┘  API    └─────────────┘
                            ▲
                            │
┌─────────────┐             │
│   admin/    │─────────────┘
│ (管理后台)  │    HTTP API
└─────────────┘

core/
├── engine/          # 八字引擎（算法）
└── system_prompt/   # 系统 Prompt（小佩人设）
```

**说明**:
- `app/` 和 `admin/` 都通过 HTTP API 调用 `core/`
- `core/` 包含所有业务逻辑和算法
- `core/engine/` 是算法库，被 `core/` 调用
- `core/system_prompt/` 存储小佩的系统人设和 Prompt 模板

---

## 五、开发前准备

### 5.1 目录创建

**待创建**:
- `app/src/` 及其子目录
- `admin/src/` 及其子目录
- `core/src/` 及其子目录（`engine/` 和 `system_prompt/` 已存在）

### 5.2 配置文件

**待创建**:
- `app/package.json`
- `app/tsconfig.json`
- `app/.eslintrc.js`（已创建，需要确认）
- `admin/package.json`
- `core/package.json`
- `core/tsconfig.json`

### 5.3 环境变量

**待配置**:
- `core/.env` - 数据库连接、加密密钥等
- `app/.env` - API 基础 URL 等

---

## 六、关键注意事项

### 6.1 安全规范

- ❌ `app/` 目录**绝不**引入 `core/engine`
- ❌ `app/` 目录**绝不**包含 prompt 模板
- ✅ 所有业务逻辑在 `core/` 中实现
- ✅ 所有 API 调用通过统一的 service

### 6.2 API 规范

- ✅ 所有 API 路径使用 `/api/v1/...` 前缀
- ✅ 所有路径参数使用 `chartId`（不是 `id`）
- ✅ 所有响应包含 `success` 字段
- ✅ 错误响应统一格式

### 6.3 模型配置

- ✅ 仅支持三个模型（DeepSeek、ChatGPT、Qwen）
- ✅ 通过 Admin 后台配置
- ✅ API Key 加密存储

---

**文档版本**: v1.0  
**最后更新**: 2024年11月  
**维护者**: 开发团队  
**状态**: ✅ 已确认，等待最终开发指令

