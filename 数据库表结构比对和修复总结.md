# 数据库表结构比对和修复总结

生成时间: 2025-12-26

## 已完成的工作

### 1. DeepSeek API Key 配置问题 ✅

**问题**: 加密密钥在模块加载时获取，环境变量可能未加载，导致解密失败

**修复**:
- 修改 `core/src/utils/encryption.ts`，改为延迟获取 `ENCRYPTION_KEY`
- 添加参数验证，确保传入值有效

**验证结果**:
- ✅ DeepSeek API Key 解密成功
- ✅ ChatGPT API Key 解密成功
- ⚠️ Qwen API Key 未配置（正常）

### 2. 神煞解读乱码问题 🔄

**开发环境检查结果**:
- ✅ 表字符集: utf8mb4
- ✅ 列字符集: utf8mb4
- ✅ 连接字符集: utf8mb4
- ✅ 实际数据正常（无乱码）

**已添加的修复**:
1. Migration 044: 修复神煞解读表编码问题
2. 在 `shenshaReadingService.ts` 中确保使用 utf8mb4 字符集查询
3. 在 `bazi.ts` 路由中确保响应使用 UTF-8 编码
4. 添加调试日志以诊断生产环境乱码问题

**下一步**:
- 在生产环境执行 Migration 044
- 通过调试日志分析生产环境乱码原因

### 3. 数据库表结构比对 🔄

**开发环境**:
- 25 张表
- 关键表已记录在 `数据库表结构比对报告.md`

**生产环境**:
- ⚠️ 无法通过 Migration API 查询（返回 404，需要部署新代码）
- 需要等待新代码部署后再次查询

**发现的问题**:
1. 重复表: `llm_api_config` 和 `llm_api_configs` 同时存在
2. 已添加字段:
   - `conversations`: `source`, `title`, `last_message_at` ✅
   - `users`: `pro_expires_at`, `pro_plan` ✅
   - `verification_codes`: `phone` 字段已扩展为 `VARCHAR(32)` ✅

## 待执行的任务

### 1. 生产环境表结构查询
- [ ] 部署包含 Migration API 的新代码
- [ ] 通过 `/api/admin/v1/migration/schema` 查询生产环境表结构
- [ ] 比对开发和生产环境的差异

### 2. 执行必要的迁移
- [ ] 在生产环境执行 Migration 044（修复神煞解读乱码）
- [ ] 检查并处理重复表 `llm_api_config` 和 `llm_api_configs`
- [ ] 确保所有表结构一致

### 3. 神煞解读乱码诊断
- [ ] 用户测试神煞解读功能
- [ ] 查看调试日志分析乱码原因
- [ ] 根据日志结果进一步修复

## 已创建的脚本和工具

1. `core/scripts/check-llm-config.ts` - 检查 LLM 配置
2. `core/scripts/check-shensha-encoding.ts` - 检查神煞解读表编码
3. `core/scripts/compare-db-schemas.ts` - 比对数据库表结构
4. `core/scripts/compare-prod-dev-tables.ts` - 比对开发和生产环境表结构
5. `core/scripts/full-db-comparison.ts` - 生成完整表结构报告
6. `core/scripts/run-migration-044.ts` - 执行 Migration 044
7. `core/scripts/query-prod-schema.ts` - 查询生产环境表结构

## Migration API 端点

- `GET /api/admin/v1/migration/schema` - 获取数据库表结构
- `POST /api/admin/v1/migration/043` - 执行 Migration 043（添加缺失字段）
- `POST /api/admin/v1/migration/044` - 执行 Migration 044（修复神煞编码）

## 下一步行动

1. 等待 gcloud 认证问题解决后部署新代码
2. 通过 Migration API 查询生产环境表结构
3. 执行必要的数据库迁移
4. 用户测试神煞解读功能并查看日志

