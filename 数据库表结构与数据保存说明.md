# æ•°æ®åº“è¡¨ç»“æ„ä¸æ•°æ®ä¿å­˜è¯´æ˜

## ğŸ“Š ä¸å¼•æ“è®¡ç®—ç»“æœç›¸å…³çš„è¡¨

### å…±æœ‰ **2å¼ è¡¨** å­˜å‚¨å¼•æ“è®¡ç®—ç»“æœç›¸å…³æ•°æ®ï¼š

---

## 1. `bazi_charts` è¡¨ï¼ˆå…«å­—ç»“æœè¡¨ï¼‰

### è¡¨ç»“æ„
```sql
CREATE TABLE IF NOT EXISTS bazi_charts (
  chart_id VARCHAR(36) PRIMARY KEY,
  chart_profile_id VARCHAR(36) NOT NULL,
  result_json LONGTEXT NOT NULL COMMENT 'å®Œæ•´å…«å­—ç»“æœï¼ˆ400+å­—æ®µï¼‰',
  engine_version VARCHAR(10) NOT NULL,
  needs_update BOOLEAN DEFAULT FALSE,
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  FOREIGN KEY (chart_profile_id) REFERENCES chart_profiles(chart_profile_id) ON DELETE CASCADE,
  INDEX idx_chart_profile_id (chart_profile_id),
  INDEX idx_engine_version (engine_version),
  INDEX idx_needs_update (needs_update)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

### å­˜å‚¨å†…å®¹
- **`result_json` (LONGTEXT)**: å­˜å‚¨å¼•æ“è¿”å›çš„**å®Œæ•´è®¡ç®—ç»“æœ**ï¼ˆJSONæ ¼å¼ï¼‰
  - âœ… **æ‰€æœ‰æ•°æ®éƒ½ä¿å­˜åœ¨è¿™é‡Œ**ï¼ŒåŒ…æ‹¬ï¼š
    - `pillars` - å››æŸ±æ•°æ®ï¼ˆå¹´ã€æœˆã€æ—¥ã€æ—¶ï¼‰
    - `analysis` - åˆ†æç»“æœ
      - `dayMaster` - æ—¥ä¸»ä¿¡æ¯
      - `wuxingPercent` - äº”è¡Œåˆ†å¸ƒ
      - `strengthAnalysis` - æ—¥ä¸»å¼ºå¼±åˆ†æ
      - `structure` - æ ¼å±€åˆ†æï¼ˆåŒ…å«ç ´æ ¼å› ç´ ã€æ ¼å±€çº¯åº¦ã€æ•‘åº”åˆ†æï¼‰
      - `purity` - ç»¼åˆçº¯åº¦
      - `tiyong` - ä½“ç”¨åˆ†æ
      - `dogong` - åšåŠŸåˆ†æ
      - `palaces` - å®«ä½åˆ†æ
    - `derived` - å¤§è¿æµå¹´æ•°æ®
      - `luck_cycle` - å¤§è¿å‘¨æœŸ
      - `flow_years` - æµå¹´
      - `flow_months` - æµæœˆ
      - `qi_yun` - èµ·è¿ä¿¡æ¯
    - `shensha` - ç¥ç…æ•°æ®
      - `hits_by_pillar` - æŒ‰æŸ±åˆ†ç±»çš„ç¥ç…
    - `meta` - å…ƒæ•°æ®
      - `version` - å¼•æ“ç‰ˆæœ¬
      - `calendar_from` - å†æ³•æ¥æº
      - `lichun_time` - ç«‹æ˜¥æ—¶é—´

- **`engine_version`**: å¼•æ“ç‰ˆæœ¬å·ï¼ˆå½“å‰ä¸º '6.0'ï¼‰
- **`needs_update`**: æ˜¯å¦éœ€è¦æ›´æ–°ï¼ˆå¼•æ“å‡çº§åæ ‡è®°ï¼‰
- **`chart_profile_id`**: å…³è”åˆ°å‘½ç›˜æ¡£æ¡ˆè¡¨

### ä¿å­˜æ–¹å¼
```typescript
// core/src/modules/bazi/baziService.ts:107-111
await pool.execute(
  `INSERT INTO bazi_charts (chart_id, chart_profile_id, result_json, engine_version)
   VALUES (?, ?, ?, ?)`,
  [chartId, profileId, JSON.stringify(result), CURRENT_ENGINE_VERSION]
);
```

**âœ… ç»“è®ºï¼šå¼•æ“è¿”å›çš„æ‰€æœ‰æ•°æ®ï¼ˆåŒ…æ‹¬ç»¼åˆçº¯åº¦ã€æ ¼å±€ã€ç ´æ ¼å› ç´ ã€æ•‘åº”åˆ†æã€æ ¼å±€çº¯åº¦ç­‰ï¼‰éƒ½å®Œæ•´ä¿å­˜åœ¨ `result_json` å­—æ®µä¸­ã€‚**

---

## 2. `chart_profiles` è¡¨ï¼ˆå‘½ç›˜æ¡£æ¡ˆè¡¨ï¼‰

### è¡¨ç»“æ„
```sql
CREATE TABLE IF NOT EXISTS chart_profiles (
  chart_profile_id VARCHAR(36) PRIMARY KEY,
  user_id VARCHAR(36) NOT NULL,
  name VARCHAR(50) NOT NULL,
  relation_type VARCHAR(20) NOT NULL,
  gender ENUM('male', 'female') NOT NULL,
  gregorian_birth DATE NOT NULL,
  birth_time TIME NOT NULL,
  birth_place VARCHAR(100),
  timezone VARCHAR(50),
  is_default BOOLEAN DEFAULT FALSE,
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE,
  INDEX idx_user_id (user_id),
  INDEX idx_is_default (is_default)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

### å­˜å‚¨å†…å®¹
- **åŸºæœ¬ä¿¡æ¯**ï¼ˆéå¼•æ“è®¡ç®—ç»“æœï¼‰ï¼š
  - `name` - å‘½ä¸»å§“å
  - `relation_type` - å…³ç³»ç±»å‹ï¼ˆself/partner/parentç­‰ï¼‰
  - `gender` - æ€§åˆ«
  - `gregorian_birth` - å…¬å†å‡ºç”Ÿæ—¥æœŸ
  - `birth_time` - å‡ºç”Ÿæ—¶é—´
  - `birth_place` - å‡ºç”Ÿåœ°
  - `timezone` - æ—¶åŒº
  - `is_default` - æ˜¯å¦ä¸ºé»˜è®¤å‘½ç›˜

**âš ï¸ æ³¨æ„ï¼šæ­¤è¡¨åªå­˜å‚¨å‘½ç›˜æ¡£æ¡ˆçš„åŸºæœ¬ä¿¡æ¯ï¼Œä¸å­˜å‚¨å¼•æ“è®¡ç®—ç»“æœã€‚**

---

## ğŸ“‹ æ•°æ®æµè½¬è¿‡ç¨‹

### 1. å¼•æ“è®¡ç®—
```
ç”¨æˆ·è¾“å…¥ï¼ˆå‡ºç”Ÿä¿¡æ¯ï¼‰
  â†“
BaziEngine.compute()
  â†“
è¿”å›å®Œæ•´ç»“æœå¯¹è±¡ï¼š
{
  pillars: {...},
  analysis: {
    structure: {
      name: "æ­£å°æ ¼",
      pogeFactors: [...],      // âœ… ç ´æ ¼å› ç´ 
      patternPurity: {          // âœ… æ ¼å±€çº¯åº¦
        level: "ä¸€èˆ¬",
        score: 92,
        pogeFactors: [...],
        rescueFactors: [...]    // âœ… æ•‘åº”åˆ†æ
      }
    },
    purity: {...},             // âœ… ç»¼åˆçº¯åº¦
    ...
  },
  derived: {...},
  shensha: {...},
  meta: {...}
}
```

### 2. ä¿å­˜åˆ°æ•°æ®åº“
```
å®Œæ•´ç»“æœå¯¹è±¡
  â†“
JSON.stringify(result)
  â†“
ä¿å­˜åˆ° bazi_charts.result_json (LONGTEXT)
```

### 3. è¯»å–æ•°æ®
```
ä»æ•°æ®åº“è¯»å– result_json
  â†“
JSON.parse(result_json)
  â†“
è¿”å›ç»™å‰ç«¯ï¼ˆç»è¿‡ DTO è½¬æ¢ï¼‰
```

---

## âœ… æ€»ç»“

### é—®é¢˜1ï¼šè¿™äº›æ•°æ®éƒ½ä¼ ç»™æ•°æ®åº“çš„è¡¨äº†å—ï¼Ÿ

**ç­”æ¡ˆï¼šæ˜¯çš„ï¼Œæ‰€æœ‰æ•°æ®éƒ½ä¿å­˜äº†ï¼**

- âœ… **ç»¼åˆçº¯åº¦** (`analysis.purity`) - ä¿å­˜åœ¨ `result_json` ä¸­
- âœ… **æ ¼å±€** (`analysis.structure`) - ä¿å­˜åœ¨ `result_json` ä¸­
- âœ… **ç ´æ ¼å› ç´ ** (`analysis.structure.pogeFactors`) - ä¿å­˜åœ¨ `result_json` ä¸­
- âœ… **æ•‘åº”åˆ†æ** (`analysis.structure.patternPurity.rescueFactors`) - ä¿å­˜åœ¨ `result_json` ä¸­
- âœ… **æ ¼å±€çº¯åº¦** (`analysis.structure.patternPurity`) - ä¿å­˜åœ¨ `result_json` ä¸­
- âœ… **ç¥ç…æ•°æ®** (`shensha`) - ä¿å­˜åœ¨ `result_json` ä¸­
- âœ… **å¤§è¿æµå¹´** (`derived`) - ä¿å­˜åœ¨ `result_json` ä¸­
- âœ… **æ‰€æœ‰å…¶ä»–åˆ†æç»“æœ** - éƒ½ä¿å­˜åœ¨ `result_json` ä¸­

### é—®é¢˜2ï¼šç°åœ¨æ•°æ®åº“çš„è¡¨å…³äºengineä¼ è¿‡æ¥çš„è®¡ç®—ç»“æœæœ‰å‡ å¼ è¡¨ï¼Ÿ

**ç­”æ¡ˆï¼š1å¼ è¡¨**

- **`bazi_charts`** - å­˜å‚¨å¼•æ“çš„å®Œæ•´è®¡ç®—ç»“æœï¼ˆJSONæ ¼å¼ï¼‰

**æ³¨æ„ï¼š**
- `chart_profiles` è¡¨å­˜å‚¨çš„æ˜¯å‘½ç›˜æ¡£æ¡ˆåŸºæœ¬ä¿¡æ¯ï¼Œä¸æ˜¯å¼•æ“è®¡ç®—ç»“æœ
- æ‰€æœ‰å¼•æ“è®¡ç®—ç»“æœéƒ½ç»Ÿä¸€ä¿å­˜åœ¨ `bazi_charts.result_json` å­—æ®µä¸­
- é‡‡ç”¨ JSON æ ¼å¼å­˜å‚¨ï¼Œä¾¿äºæ‰©å±•å’Œç»´æŠ¤

---

## ğŸ” æ•°æ®éªŒè¯

å¯ä»¥é€šè¿‡ä»¥ä¸‹ SQL æŸ¥è¯¢éªŒè¯æ•°æ®ï¼š

```sql
-- æŸ¥çœ‹æœ€è¿‘åˆ›å»ºçš„å‘½ç›˜
SELECT 
  chart_id,
  engine_version,
  LENGTH(result_json) as json_size,
  JSON_EXTRACT(result_json, '$.analysis.structure.name') as structure_name,
  JSON_EXTRACT(result_json, '$.analysis.purity.score') as purity_score,
  JSON_EXTRACT(result_json, '$.analysis.structure.pogeFactors') as poge_factors,
  JSON_EXTRACT(result_json, '$.analysis.structure.patternPurity') as pattern_purity,
  created_at
FROM bazi_charts
ORDER BY created_at DESC
LIMIT 5;
```

---

## ğŸ’¡ è®¾è®¡ä¼˜åŠ¿

1. **ç»Ÿä¸€å­˜å‚¨**ï¼šæ‰€æœ‰è®¡ç®—ç»“æœä¿å­˜åœ¨ä¸€ä¸ª JSON å­—æ®µä¸­ï¼Œä¾¿äºç®¡ç†
2. **ç‰ˆæœ¬æ§åˆ¶**ï¼šé€šè¿‡ `engine_version` å­—æ®µè·Ÿè¸ªå¼•æ“ç‰ˆæœ¬
3. **çµæ´»æ‰©å±•**ï¼šJSON æ ¼å¼ä¾¿äºæ·»åŠ æ–°å­—æ®µï¼Œæ— éœ€ä¿®æ”¹è¡¨ç»“æ„
4. **å®Œæ•´ä¿å­˜**ï¼šæ‰€æœ‰è®¡ç®—ç»“æœéƒ½å®Œæ•´ä¿å­˜ï¼Œä¸ä¼šä¸¢å¤±æ•°æ®
5. **æ€§èƒ½ä¼˜åŒ–**ï¼šé€šè¿‡ `needs_update` å­—æ®µæ ‡è®°éœ€è¦æ›´æ–°çš„è®°å½•





