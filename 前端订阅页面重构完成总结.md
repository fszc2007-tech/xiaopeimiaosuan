# 前端訂閱頁面重構完成總結

> **完成時間**：2024-12-02  
> **任務**：根據優化方案重構訂閱頁面

---

## ✅ 已完成項目

### 1. proService API 服務（新建）

**文件**：`app/src/services/api/proService.ts`

**功能**：
- ✅ `getStatus()`: 獲取會員狀態（包含 AI 次數信息）
- ✅ `fakeSubscribe()`: 假支付訂閱（測試用）

**類型定義**：
```typescript
export interface MembershipStatus {
  isPro: boolean;
  proPlan: 'monthly' | 'quarterly' | 'yearly' | null;
  proExpiresAt: string | null;
  features: string[];
  aiCallsToday: number;
  aiDailyLimit: number;
  aiRemaining: number;
}
```

**重要說明**：
- ✅ 方法直接返回數據對象，不需要再 `.data`
- ✅ 使用 `get<T>()` 和 `post<T>()` 封裝，自動解包 `ApiResponse<T>`

---

### 2. 訂閱頁面完全重構

**文件**：`app/src/screens/ProSubscription/ProSubscriptionScreen.tsx`

#### 2.1 頁面結構（按優化方案）

**信息結構**：
1. **上面**：情緒價值（小佩可以陪你怎麼樣）
2. **中間**：理性對比（免費 vs 會員）
3. **下面**：具體價格（怎麼買）

**具體布局**：
```
┌─────────────────────────────────┐
│  頭部：小佩 Pro + Crown 圖標     │
├─────────────────────────────────┤
│  當前狀態卡片                    │
│  - 免費用戶/小佩會員             │
│  - 今日解讀：X / Y 次            │
│  - 載入中… (loading 狀態)       │
├─────────────────────────────────┤
│  綠色介紹卡片（僅非會員顯示）     │
│  - 情緒價值文案                  │
│  - 無權益細節                    │
├─────────────────────────────────┤
│  權益對比表（僅非會員顯示）       │
│  - AI 解讀 / 問答（第一行）      │
│  - 功能（第二行）                │
│  - 命盤數量（第三行）            │
│  - CTA 文案                      │
├─────────────────────────────────┤
│  訂閱計劃（僅非會員顯示）         │
│  - 月：NT$ 39                    │
│  - 季：NT$ 99（早鳥價）          │
│  - 年：NT$ 348（早鳥價）         │
├─────────────────────────────────┤
│  底部按鈕（僅非會員顯示）         │
│  - 立即訂閱 - NT$ XXX           │
└─────────────────────────────────┘
```

#### 2.2 當前狀態卡片（分兩種文案）

**免費用戶**：
```
免費用戶
已解鎖基礎排盤與簡要解讀
────────────────────
今日解讀：3 / 5 次
```

**小佩會員**：
```
小佩會員 👑
已解鎖全部解讀與高額 AI 問答
────────────────────
今日解讀：15 / 100 次
```

**載入狀態**：
```
⏳ 載入中…
```

#### 2.3 綠色介紹卡片（情緒價值）

**內容**：
```
❤️ 小佩會陪你慢慢看懂自己的節奏，適合長期追蹤、反覆提問。
```

**特點**：
- ✅ 只保留情緒價值
- ✅ 刪除所有權益細節
- ✅ 僅非會員顯示

#### 2.4 權益對比表（精簡版）

**順序調整**（按優化建議）：
1. **AI 解讀 / 問答**（核心賣點，放第一）
2. **功能**（次要）
3. **命盤數量**（補充，放最後）

**文案優化**：

| | 非會員 | 小佩會員 |
|---|---|---|
| AI 解讀 / 問答 | 首日 10 次，之後每天 5 次 | **每天 100 次，日常幾乎不會用完** |
| 功能 | 可體驗全部功能 | **全功能 + 高額度，適合長期追蹤與反覆提問** |
| 命盤數量 | 最多 10 個 | 更寬鬆，適合長期使用 |

**CTA 文案**：
```
想要更自由地問小佩，就升級成小佩會員吧。
```

**重要說明**：
- ✅ 命盤數量**只在文案層面提示**，後端暫時不做硬限制
- ✅ 文案更 punch，強調「不會被卡住」

#### 2.5 訂閱計劃（三個方案）

**價格調整**（按優化方案）：

| 方案 | 價格 | 標籤 | 月均 |
|------|------|------|------|
| 按月訂閱 | NT$ 39 / 月 | - | - |
| 按季訂閱 | NT$ 99 / 季 | 早鳥價 | 約 33 / 月 |
| 按年訂閱 | NT$ 348 / 年 | 早鳥價 | 約 29 / 月 |

**變更說明**：
- ✅ 從原來的 68/588 改為 39/99/348
- ✅ 新增「按季訂閱」選項
- ✅ 標籤改為「早鳥價」（不是「省 28%」）

#### 2.6 已是會員的提示

**內容**：
```
您已是小佩會員，感謝您的支持！
到期時間：2025/12/31
```

**特點**：
- ✅ 替代訂閱計劃和底部按鈕
- ✅ 顯示到期時間

---

### 3. 數據加載與狀態管理

#### 3.1 加載流程

```typescript
useEffect(() => {
  loadStatus(); // 頁面進入時自動加載
}, []);

const loadStatus = async () => {
  try {
    setLoading(true);
    const data = await proService.getStatus();
    setStatus(data); // 直接使用，不需要 .data
  } catch (error) {
    // 失敗時不顯示錯誤，只是不顯示狀態信息
  } finally {
    setLoading(false);
  }
};
```

#### 3.2 訂閱流程

```typescript
const handleSubscribe = async () => {
  try {
    setSubscribing(true);
    
    // 1. 調用假支付 API
    await proService.fakeSubscribe({ plan: selectedPlan });
    
    // 2. 成功後重新加載狀態
    await loadStatus();
    
    // 3. 顯示成功提示
    Alert.alert('訂閱成功', '恭喜您成為小佩會員！...');
  } catch (error) {
    Alert.alert('訂閱失敗', error.message || '請稍後再試');
  } finally {
    setSubscribing(false);
  }
};
```

#### 3.3 錯誤處理

**載入失敗**：
- ✅ 不顯示錯誤彈窗
- ✅ 顯示「載入中…」或「無法載入狀態信息」
- ✅ 不渲染 `0 / undefined 次`

**訂閱失敗**：
- ✅ 顯示 Alert 提示
- ✅ 保持在當前頁面

---

## 📋 與優化建議的對應

### ✅ 1. 權益比對表順序調整

**建議**：
> 先講「今天痛點」，再講命盤數量。順序改成：AI 解讀 / 問答 → 功能 → 命盤數量

**實施**：
```typescript
const BENEFITS = [
  { title: 'AI 解讀 / 問答', ... },  // 第一行
  { title: '功能', ... },            // 第二行
  { title: '命盤數量', ... },        // 第三行
];
```

### ✅ 2. 文案更 punch

**建議**：
> 非會員：首日 10 次，之後每天 5 次  
> 會員：每天 100 次，日常幾乎不會用完

**實施**：
```typescript
{
  title: 'AI 解讀 / 問答',
  free: '首日 10 次，之後每天 5 次',
  pro: '每天 100 次，日常幾乎不會用完',
}
```

### ✅ 3. 當前狀態卡片分兩種

**建議**：
> 免費用戶：免費用戶 · 已解鎖基礎排盤與簡要解讀  
> 小佩會員：小佩會員 · 已解鎖全部解讀與高額 AI 問答

**實施**：
```typescript
<Text style={styles.statusDesc}>
  {status.isPro
    ? '已解鎖全部解讀與高額 AI 問答'
    : '已解鎖基礎排盤與簡要解讀'}
</Text>
```

### ✅ 4. 綠色卡片只保留情緒價值

**建議**：
> 保留「情緒價值」那段（陪伴、節奏、長期追蹤），但把裡面任何跟「權益細節」的句子都刪掉

**實施**：
```typescript
<View style={styles.introCard}>
  <Heart color={colors.primary} size={24} />
  <Text style={styles.introText}>
    小佩會陪你慢慢看懂自己的節奏，適合長期追蹤、反覆提問。
  </Text>
</View>
```

### ✅ 5. 命盤數量不做硬限制

**建議**：
> 命盤數量目前只在文案層面提示，後端暫時不做硬限制

**實施**：
- ✅ 在優化方案文檔中添加註解
- ✅ 前端只顯示文案，不做任何限制邏輯

### ✅ 6. API 回傳型別說清楚

**建議**：
> 希望 getStatus() 回傳的就是 MembershipStatus 本體

**實施**：
```typescript
// proService.ts
export const proService = {
  /**
   * 獲取會員狀態（包含 AI 次數信息）
   * 
   * 注意：此方法直接返回 MembershipStatus 對象，不需要再 .data
   */
  async getStatus(): Promise<MembershipStatus> {
    return await get<MembershipStatus>('/api/v1/pro/status');
  },
};

// 使用時
const status = await proService.getStatus(); // status: MembershipStatus
setStatus(status); // 直接使用，不需要 .data
```

### ✅ 7. Loading / Error 顯示細節

**建議**：
> 讀取失敗時，不顯示這一行或顯示「載入中…」；不要在 undefined 的狀態下渲染 0 / undefined 次

**實施**：
```typescript
{loading ? (
  <View style={styles.statusLoading}>
    <ActivityIndicator size="small" color={colors.primary} />
    <Text style={styles.statusLoadingText}>載入中…</Text>
  </View>
) : status ? (
  <Text style={styles.statusUsage}>
    今日解讀：{status.aiCallsToday} / {status.aiDailyLimit} 次
  </Text>
) : (
  <Text style={styles.statusError}>無法載入狀態信息</Text>
)}
```

---

## 🎨 UI/UX 優化

### 1. 視覺層次

**信息結構**（從上到下）：
1. **情緒價值**（綠色卡片）
2. **理性對比**（權益表格）
3. **具體價格**（訂閱方案）

**優點**：
- ✅ 避免重複說同一件事
- ✅ 信息結構清晰
- ✅ 用起來比較順

### 2. 會員狀態區分

**非會員**：
- 顯示綠色介紹卡片
- 顯示權益對比表
- 顯示訂閱計劃
- 顯示底部按鈕

**小佩會員**：
- 只顯示狀態卡片
- 顯示「已是會員」提示
- 隱藏所有訂閱相關內容

### 3. 交互反饋

**訂閱中狀態**：
```typescript
{subscribing ? (
  <ActivityIndicator size="small" color="#FFFFFF" />
) : (
  <Text>立即訂閱 - NT$ {price}</Text>
)}
```

**按鈕禁用**：
```typescript
<Pressable
  style={[styles.subscribeButton, subscribing && styles.subscribeButtonDisabled]}
  disabled={subscribing}
>
```

---

## 🧪 測試要點

### 1. 狀態加載

**測試場景**：
- [ ] 非會員進入頁面
- [ ] 小佩會員進入頁面
- [ ] 網絡失敗時進入頁面

**預期結果**：
- 非會員：顯示完整訂閱流程
- 小佩會員：只顯示狀態卡片和「已是會員」提示
- 網絡失敗：顯示「載入中…」或「無法載入狀態信息」

### 2. 訂閱流程

**測試步驟**：
1. 選擇訂閱計劃（月/季/年）
2. 點擊「立即訂閱」按鈕
3. 等待假支付完成
4. 查看成功提示
5. 確認狀態更新

**預期結果**：
- 按鈕顯示 loading 狀態
- 成功後顯示 Alert
- 狀態卡片更新為「小佩會員」
- AI 次數上限變為 100

### 3. 權益對比表

**檢查項**：
- [ ] 順序：AI 解讀 → 功能 → 命盤數量
- [ ] 文案：「日常幾乎不會用完」、「適合長期追蹤與反覆提問」
- [ ] CTA：「想要更自由地問小佩，就升級成小佩會員吧。」

### 4. 價格顯示

**檢查項**：
- [ ] 月：NT$ 39
- [ ] 季：NT$ 99（早鳥價）+ 約 33 / 月
- [ ] 年：NT$ 348（早鳥價）+ 約 29 / 月

---

## 📝 注意事項

### 1. 命名一致性

**UI 層**：
- 標題：「小佩 Pro」
- 其他地方：「小佩會員」

**技術層**：
- 變數名：`isPro`, `proPlan`, `proExpiresAt`
- API：`/api/v1/pro/status`, `/api/v1/pro/fake-subscribe`

### 2. 命盤數量限制

**重要**：
- ✅ 只在文案層面提示
- ✅ 後端暫時不做硬限制
- ✅ 之後如果真的要控，再開新任務

### 3. 假支付 API

**當前狀態**：
- ✅ 使用 `/api/v1/pro/fake-subscribe`
- ✅ 測試用，不需要真實支付

**未來升級**：
- 集成 Apple IAP
- 集成 Google Play Billing
- 添加 Webhook 處理

---

## 📊 文件變更總結

| 文件 | 變更類型 | 說明 |
|------|---------|------|
| `app/src/services/api/proService.ts` | 新建 | Pro 會員 API 服務 |
| `app/src/screens/ProSubscription/ProSubscriptionScreen.tsx` | 重構 | 完全重寫訂閱頁面 |
| `会员订阅与AI解读次数限制-优化方案.md` | 修改 | 更新權益表順序、文案、注意事項 |

---

## ✅ 任務完成檢查清單

### 後端（已完成）
- [x] DB Migration: users 表新增 ai_calls_today、ai_calls_date
- [x] 新增 aiQuotaService.ts 工具函式
- [x] 封裝 LLM 調用：callDeepSeekStreamWithQuota
- [x] 改造所有 LLM 調用入口使用新封裝
- [x] 改造 /api/v1/pro/status API 返回 AI 次數信息
- [x] 新增假支付 API: /api/v1/pro/fake-subscribe
- [x] 修改 pro_plan ENUM 支援 quarterly

### 前端（已完成）
- [x] 統一處理 AI_DAILY_LIMIT_REACHED 錯誤
- [x] 創建 proService API 服務
- [x] 重構訂閱頁面
  - [x] 當前狀態卡片（分兩種文案）
  - [x] 綠色介紹卡片（情緒價值）
  - [x] 權益對比表（順序調整 + 文案優化）
  - [x] 訂閱計劃（三個方案 + 早鳥價）
  - [x] 假支付流程
  - [x] Loading / Error 狀態處理

### 測試（待執行）
- [ ] 測試：非會員進入頁面
- [ ] 測試：小佩會員進入頁面
- [ ] 測試：網絡失敗時進入頁面
- [ ] 測試：訂閱流程（月/季/年）
- [ ] 測試：權益對比表顯示
- [ ] 測試：價格顯示

---

## 🚀 下一步

1. **執行後端 Migration**
   ```bash
   cd core
   npm run migrate
   ```

2. **重啟後端服務**
   ```bash
   cd core
   npm run dev
   ```

3. **測試前端功能**
   - 啟動 App
   - 進入訂閱頁面
   - 測試所有場景

4. **確認路由名稱**
   - 檢查 `navigationRef.current.navigate('ProSubscription')` 是否正確
   - 如需要，修改為實際路由名稱

---

**文檔結束**


