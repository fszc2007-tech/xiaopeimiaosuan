# å°ä½©æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–æ–¹æ¡ˆï¼ˆå®Œæ•´ç‰ˆï¼‰

**æ–¹æ¡ˆç‰ˆæœ¬**: v2.1ï¼ˆä¼˜åŒ–ç‰ˆï¼‰  
**åˆ›å»ºæ—¶é—´**: 2025-01-XX  
**æœ€åæ›´æ–°**: 2025-01-XX  
**ç›®æ ‡**: åªä¿ç•™æ‰‹æœºå·ç™»å½•ï¼Œåˆ é™¤é‚®ç®±ï¼Œæ”¯æŒ HK æ‰‹æœºå·ï¼ˆE.164 æ ¼å¼ï¼‰ï¼Œä¼˜åŒ–æ‰€æœ‰è¡¨ç´¢å¼•  
**MySQL ç‰ˆæœ¬è¦æ±‚**: 5.7+ / 8.0+ï¼ˆæ¨è 8.0+ï¼‰

---

## ä¸€ã€æ–¹æ¡ˆæ¦‚è¿°

### 1.1 æ ¸å¿ƒå˜æ›´

1. **åˆ é™¤ email å­—æ®µ**
   - `users` è¡¨ï¼šåˆ é™¤ `email` å­—æ®µåŠç›¸å…³ç´¢å¼•
   - `verification_codes` è¡¨ï¼šåˆ é™¤ `email` å­—æ®µåŠç›¸å…³ç´¢å¼•

2. **æ‰‹æœºå·æ ‡å‡†åŒ–**
   - æ”¯æŒ E.164 æ ¼å¼ï¼ˆå¦‚ï¼š`+8613812345678`ã€`+85291234567`ï¼‰
   - `phone` å­—æ®µé•¿åº¦ï¼š`VARCHAR(32)`ï¼ˆè¶³å¤Ÿæ”¯æŒå›½é™…å·ç ï¼‰
   - `phone` è®¾ä¸ºå”¯ä¸€ç´¢å¼•ï¼ˆç™»å½•å‡­è¯ï¼‰

3. **ç´¢å¼•ä¼˜åŒ–**
   - ç»„åˆç´¢å¼•æ›¿ä»£å•åˆ—ç´¢å¼•
   - åˆ é™¤å†—ä½™ç´¢å¼•
   - é’ˆå¯¹å®é™…æŸ¥è¯¢åœºæ™¯ä¼˜åŒ–

### 1.2 ä¸šåŠ¡å½±å“

- **CN ç”¨æˆ·**ï¼šç»§ç»­ä½¿ç”¨æ‰‹æœºå·ç™»å½•ï¼ˆæ ¼å¼ï¼š`+8613812345678`ï¼‰
- **HK ç”¨æˆ·**ï¼šä»é‚®ç®±ç™»å½•æ”¹ä¸ºæ‰‹æœºå·ç™»å½•ï¼ˆæ ¼å¼ï¼š`+85291234567`ï¼‰
- **å†å²æ•°æ®**ï¼šéœ€è¦è¿ç§»ç­–ç•¥ï¼ˆè§ä¸‹æ–‡ï¼‰

---

## äºŒã€æ•°æ®è¿ç§»å‰æ£€æŸ¥

### 2.1 æ‰§è¡Œå‰å¿…é¡»æ£€æŸ¥

```sql
-- 1. æ£€æŸ¥ users è¡¨æ•°æ®è´¨é‡
-- 1.1 æ£€æŸ¥æ˜¯å¦æœ‰ phone ä¸º NULL çš„è®°å½•
SELECT COUNT(*) as null_phone_count 
FROM users 
WHERE phone IS NULL;

-- 1.2 æ£€æŸ¥æ˜¯å¦æœ‰é‡å¤æ‰‹æœºå·
SELECT phone, COUNT(*) as count 
FROM users 
WHERE phone IS NOT NULL 
GROUP BY phone 
HAVING COUNT(*) > 1;

-- 1.3 æ£€æŸ¥ HK ç”¨æˆ·æœ‰å¤šå°‘åªæœ‰ email æ²¡æœ‰ phone
SELECT COUNT(*) as hk_email_only_count
FROM users 
WHERE app_region = 'hk' 
  AND phone IS NULL 
  AND email IS NOT NULL;

-- 1.4 æŸ¥çœ‹éœ€è¦è¿ç§»çš„ HK ç”¨æˆ·è¯¦æƒ…
SELECT user_id, nickname, phone, email, app_region, created_at
FROM users 
WHERE app_region = 'hk' 
  AND phone IS NULL 
  AND email IS NOT NULL
LIMIT 10;

-- 2. æ£€æŸ¥ verification_codes è¡¨
-- 2.1 æ£€æŸ¥æ˜¯å¦æœ‰ email ä¸º NULL ä½† phone ä¹Ÿä¸º NULL çš„è®°å½•
SELECT COUNT(*) as both_null_count
FROM verification_codes 
WHERE phone IS NULL AND email IS NULL;

-- 2.2 æ£€æŸ¥æœ€è¿‘ä½¿ç”¨çš„éªŒè¯ç åˆ†å¸ƒ
SELECT 
  CASE 
    WHEN phone IS NOT NULL THEN 'phone'
    WHEN email IS NOT NULL THEN 'email'
    ELSE 'both_null'
  END as type,
  COUNT(*) as count
FROM verification_codes 
WHERE created_at > DATE_SUB(NOW(), INTERVAL 7 DAY)
GROUP BY type;
```

### 2.2 æ•°æ®è¿ç§»ç­–ç•¥

**å¯¹äº HK ç”¨æˆ·ï¼ˆåªæœ‰ emailï¼Œæ²¡æœ‰ phoneï¼‰çš„å¤„ç†æ–¹æ¡ˆï¼š**

**æ–¹æ¡ˆ Aï¼šæ ‡è®°ä¸ºå¾…è¿ç§»ï¼ˆæ¨èï¼‰**
```sql
-- æ·»åŠ ä¸´æ—¶å­—æ®µæ ‡è®°
ALTER TABLE users 
ADD COLUMN migration_status ENUM('pending', 'completed') DEFAULT 'completed'
AFTER app_region;

-- æ ‡è®°éœ€è¦è¿ç§»çš„ç”¨æˆ·
UPDATE users 
SET migration_status = 'pending'
WHERE app_region = 'hk' 
  AND phone IS NULL 
  AND email IS NOT NULL;
```

**æ–¹æ¡ˆ Bï¼šè¦æ±‚ç”¨æˆ·è¡¥æ‰‹æœºå·**
- åœ¨åº”ç”¨å±‚æ‹¦æˆªï¼Œè¦æ±‚è¿™äº›ç”¨æˆ·å…ˆè¡¥æ‰‹æœºå·æ‰èƒ½ç™»å½•
- é€šè¿‡å®¢æœæˆ–é‚®ä»¶é€šçŸ¥ç”¨æˆ·

**æ–¹æ¡ˆ Cï¼šåˆ é™¤æ— æ•ˆç”¨æˆ·ï¼ˆè°¨æ…ï¼‰**
- ä»…é€‚ç”¨äºæµ‹è¯•æ•°æ®æˆ–æ˜ç¡®æ— æ•ˆçš„ç”¨æˆ·

---

## ä¸‰ã€å®Œæ•´è¿ç§» SQL è„šæœ¬

### 3.1 ç¬¬ä¸€é˜¶æ®µï¼šæ•°æ®è´¨é‡æ£€æŸ¥ä¸å‡†å¤‡

```sql
-- ============================================
-- é˜¶æ®µ 1ï¼šæ•°æ®è´¨é‡æ£€æŸ¥ä¸å‡†å¤‡
-- ============================================

-- 1. å¤‡ä»½æé†’ï¼ˆæ‰§è¡Œå‰æ‰‹åŠ¨å¤‡ä»½ï¼‰
-- mysqldump -u root -p xiaopei > backup_before_index_optimization.sql

-- 2. æ£€æŸ¥å¹¶ä¿®å¤ phone å­—æ®µ
-- 2.1 ç¡®ä¿ phone å­—æ®µé•¿åº¦è¶³å¤Ÿï¼ˆæ”¯æŒ E.164 æ ¼å¼ï¼‰
ALTER TABLE users 
MODIFY COLUMN phone VARCHAR(32) NULL COMMENT 'æ‰‹æœºå·ï¼ˆE.164æ ¼å¼ï¼Œå¦‚+8613812345678ï¼‰';

-- 2.2 æ£€æŸ¥æ˜¯å¦æœ‰é‡å¤æ‰‹æœºå·ï¼ˆå¦‚æœæœ‰ï¼Œéœ€è¦å…ˆå¤„ç†ï¼‰
-- SELECT phone, COUNT(*) FROM users WHERE phone IS NOT NULL GROUP BY phone HAVING COUNT(*) > 1;

-- 3. å¤„ç† verification_codes è¡¨
-- 3.1 ç¡®ä¿ phone å­—æ®µé•¿åº¦è¶³å¤Ÿ
ALTER TABLE verification_codes 
MODIFY COLUMN phone VARCHAR(32) NULL COMMENT 'æ‰‹æœºå·ï¼ˆE.164æ ¼å¼ï¼‰';
```

### 3.2 ç¬¬äºŒé˜¶æ®µï¼šåˆ é™¤ email å­—æ®µï¼ˆæ ¸å¿ƒå˜æ›´ï¼‰

```sql
-- ============================================
-- é˜¶æ®µ 2ï¼šåˆ é™¤ email å­—æ®µ
-- ============================================

-- âš ï¸ æ‰§è¡Œå‰ç¡®ä¿ï¼š
-- 1. å·²å¤‡ä»½æ•°æ®åº“
-- 2. å·²æ£€æŸ¥æ•°æ®è´¨é‡ï¼ˆè§é˜¶æ®µ 1ï¼‰
-- 3. åº”ç”¨å±‚ä»£ç å·²å‡†å¤‡å¥½ï¼ˆä¸å†ä½¿ç”¨ email ç™»å½•ï¼‰

-- âš ï¸ æ³¨æ„ï¼šMySQL 5.7 ä¸æ”¯æŒ IF EXISTSï¼Œéœ€è¦å…ˆæ£€æŸ¥ç´¢å¼•æ˜¯å¦å­˜åœ¨
-- æ‰§è¡Œå‰å»ºè®®å…ˆæŸ¥è¯¢ï¼šSELECT INDEX_NAME FROM information_schema.statistics 
--   WHERE table_schema = 'xiaopei' AND table_name = 'users' AND INDEX_NAME = 'idx_email';

-- 1. users è¡¨ï¼šåˆ é™¤ email ç›¸å…³ç´¢å¼•å’Œå­—æ®µ
-- å¦‚æœç´¢å¼•ä¸å­˜åœ¨ä¼šæŠ¥é”™ï¼Œéœ€è¦å…ˆç¡®è®¤
ALTER TABLE users
  DROP INDEX idx_email,
  DROP COLUMN email;

-- 2. verification_codes è¡¨ï¼šåˆ é™¤ email ç›¸å…³ç´¢å¼•å’Œå­—æ®µ
ALTER TABLE verification_codes
  DROP INDEX idx_email,
  DROP COLUMN email;
```

### 3.3 ç¬¬ä¸‰é˜¶æ®µï¼šä¼˜åŒ– users è¡¨ç´¢å¼•

```sql
-- ============================================
-- é˜¶æ®µ 3ï¼šä¼˜åŒ– users è¡¨ç´¢å¼•
-- ============================================

-- âš ï¸ ä¼˜åŒ–ï¼šåˆå¹¶ä¸ºå•æ¡ ALTER TABLEï¼Œå‡å°‘è¡¨é‡å»ºæ¬¡æ•°ï¼ˆå¯¹å¤§è¡¨å¾ˆé‡è¦ï¼‰
-- æ‰§è¡Œå‰ç¡®ä¿ phone æ— é‡å¤ï¼ˆå…ˆæ‰§è¡Œæ£€æŸ¥ SQLï¼‰

-- åˆå¹¶æ“ä½œï¼šåˆ é™¤æ—§ç´¢å¼• + æ·»åŠ æ–°ç´¢å¼•ï¼ˆä¸€æ¬¡æ€§å®Œæˆï¼‰
ALTER TABLE users
  DROP INDEX idx_phone,
  DROP INDEX idx_app_region,
  DROP INDEX idx_is_pro,
  ADD UNIQUE KEY uniq_phone (phone),
  ADD INDEX idx_region_pro (app_region, is_pro);
```

### 3.4 ç¬¬å››é˜¶æ®µï¼šä¼˜åŒ– verification_codes è¡¨ç´¢å¼•

```sql
-- ============================================
-- é˜¶æ®µ 4ï¼šä¼˜åŒ– verification_codes è¡¨ç´¢å¼•
-- ============================================

-- 1. åˆ é™¤æ—§çš„å•åˆ—ç´¢å¼•
-- 2. æ·»åŠ ç»„åˆç´¢å¼•ï¼ˆè¦†ç›–éªŒè¯ç æŸ¥è¯¢åœºæ™¯ï¼‰
-- å…¸å‹æŸ¥è¯¢ï¼šWHERE phone = ? AND code = ? AND is_used = 0 AND expires_at > NOW()
-- 3. æ·»åŠ é¢‘æ§æŸ¥è¯¢ç´¢å¼•ï¼ˆç”¨äºé£æ§ç»Ÿè®¡ï¼‰
-- å…¸å‹æŸ¥è¯¢ï¼šWHERE phone = ? AND created_at > NOW() - INTERVAL 1 HOUR

ALTER TABLE verification_codes
  DROP INDEX idx_phone,
  ADD INDEX idx_phone_verify (phone, code, is_used, expires_at),
  ADD INDEX idx_phone_created (phone, created_at);

-- 4. ä¿ç•™ expires_at ç´¢å¼•ï¼ˆç”¨äºæ¸…ç†è¿‡æœŸéªŒè¯ç ï¼‰
-- idx_expires_at å·²å­˜åœ¨ï¼Œæ— éœ€ä¿®æ”¹
```

### 3.5 ç¬¬äº”é˜¶æ®µï¼šä¼˜åŒ–å…¶ä»–è¡¨ç´¢å¼•

```sql
-- ============================================
-- é˜¶æ®µ 5ï¼šä¼˜åŒ–å…¶ä»–è¡¨ç´¢å¼•
-- ============================================

-- 1. chart_profiles è¡¨
-- 1.1 ä¼˜åŒ–ç”¨æˆ·æŸ¥è¯¢ï¼ˆè·å–ç”¨æˆ·çš„é»˜è®¤å‘½ç›˜ï¼‰
-- åˆå¹¶æ“ä½œï¼Œå‡å°‘è¡¨é‡å»º
ALTER TABLE chart_profiles
  DROP INDEX idx_user_id,
  DROP INDEX idx_is_default,
  ADD INDEX idx_user_default (user_id, is_default);

-- 2. bazi_charts è¡¨
-- 2.1 ä¼˜åŒ–å¼•æ“ç‰ˆæœ¬æ›´æ–°æŸ¥è¯¢
-- åˆå¹¶æ“ä½œ
ALTER TABLE bazi_charts
  DROP INDEX idx_needs_update,
  DROP INDEX idx_engine_version,
  ADD INDEX idx_needs_update_engine (needs_update, engine_version);

-- 3. conversations è¡¨
-- 3.1 ä¼˜åŒ–ç”¨æˆ·å¯¹è¯åˆ—è¡¨æŸ¥è¯¢ï¼ˆæŒ‰æ—¶é—´æ’åºï¼‰
-- åˆå¹¶æ“ä½œ
ALTER TABLE conversations
  DROP INDEX idx_user_id,
  DROP INDEX idx_created_at,
  ADD INDEX idx_user_created (user_id, created_at);

-- 4. messages è¡¨
-- 4.1 ä¼˜åŒ–å¯¹è¯æ¶ˆæ¯æŸ¥è¯¢ï¼ˆæŒ‰æ—¶é—´æ’åºï¼‰
-- æ³¨æ„ï¼šå¦‚æœå­˜åœ¨ idx_follow_ups ç´¢å¼•ï¼ˆMySQL 8.0+ è¡¨è¾¾å¼ç´¢å¼•ï¼‰ï¼Œå¯é€‰æ‹©æ€§åˆ é™¤
-- åˆå¹¶æ“ä½œ
ALTER TABLE messages
  DROP INDEX idx_conversation_id,
  DROP INDEX idx_created_at,
  ADD INDEX idx_conv_created (conversation_id, created_at);
  
-- 4.2 å¯é€‰ï¼šåˆ é™¤ follow_ups ç›¸å…³ç´¢å¼•ï¼ˆå¦‚æœä¸å†éœ€è¦ï¼‰
-- ALTER TABLE messages DROP INDEX IF EXISTS idx_follow_ups;

-- 5. readings è¡¨
-- 5.1 ä¼˜åŒ–ç”¨æˆ·è§£è¯»è®°å½•æŸ¥è¯¢ï¼ˆåˆå¹¶æ“ä½œï¼‰
ALTER TABLE readings
  DROP INDEX idx_user_id,
  DROP INDEX IF EXISTS idx_created_at,
  ADD INDEX idx_user_created (user_id, created_at);

-- 5.2 ä¼˜åŒ–å‘½ç›˜åœºæ™¯æŸ¥è¯¢ï¼ˆåˆå¹¶æ“ä½œï¼‰
ALTER TABLE readings
  DROP INDEX idx_chart_id,
  DROP INDEX idx_scene,
  ADD INDEX idx_chart_scene_created (chart_id, scene, created_at);

-- 6. feedbacks è¡¨
-- 6.1 ä¼˜åŒ–ç”¨æˆ·åé¦ˆæŸ¥è¯¢å’ŒçŠ¶æ€æŸ¥è¯¢ï¼ˆåˆå¹¶æ“ä½œï¼‰
ALTER TABLE feedbacks
  DROP INDEX idx_user_id,
  DROP INDEX idx_created_at,
  DROP INDEX idx_status,
  ADD INDEX idx_user_created (user_id, created_at),
  ADD INDEX idx_status_created (status, created_at);

-- 7. rate_limits è¡¨
-- 7.1 åˆ é™¤å†—ä½™ç´¢å¼•ï¼ˆunique_user_api_date å‰ç¼€å·²è¦†ç›– user_idï¼‰
ALTER TABLE rate_limits
  DROP INDEX IF EXISTS idx_user_id;

-- 8. subscriptions è¡¨
-- 8.1 ä¼˜åŒ–ç”¨æˆ·è®¢é˜…æŸ¥è¯¢å’Œè¿‡æœŸæ¸…ç†æŸ¥è¯¢ï¼ˆåˆå¹¶æ“ä½œï¼‰
ALTER TABLE subscriptions
  DROP INDEX idx_user_id,
  DROP INDEX idx_status,
  DROP INDEX idx_expires_at,
  ADD INDEX idx_user_status_expire (user_id, status, expires_at),
  ADD INDEX idx_status_expire (status, expires_at);

-- 9. admins è¡¨
-- 9.1 åˆ é™¤å†—ä½™ç´¢å¼•ï¼ˆUNIQUE KEY å·²åŒ…å«ç´¢å¼•ï¼‰
ALTER TABLE admins
  DROP INDEX IF EXISTS idx_username;

-- 10. shensha_readings è¡¨
-- 10.1 ä¼˜åŒ–ç¥ç…æŸ¥è¯¢
-- æ³¨æ„ï¼šå¦‚æœä¸šåŠ¡æ¨¡å‹æ˜¯ã€Œæ¯ä¸ª (shensha_code, pillar_type) åªæœ‰ä¸€æ¡è®°å½•ã€ï¼Œ
--      ä¸”ä¸éœ€è¦æŒ‰ is_active æ‰¹é‡æŸ¥è¯¢ï¼Œå¯ä»¥åªä¿ç•™ unique_shensha_pillar
--      è¿™é‡Œä¿ç•™ idx_shensha_active æ˜¯ä¸ºäº†æ”¯æŒã€ŒæŸ¥è¯¢å½“å‰ç”Ÿæ•ˆçš„ç¥ç…ã€åœºæ™¯
ALTER TABLE shensha_readings
  DROP INDEX idx_shensha_code,
  DROP INDEX idx_pillar_type,
  DROP INDEX idx_is_active,
  ADD INDEX idx_shensha_active (shensha_code, pillar_type, is_active);
```

### 3.6 ç¬¬å…­é˜¶æ®µï¼šéªŒè¯ä¸æ”¶å°¾

```sql
-- ============================================
-- é˜¶æ®µ 6ï¼šéªŒè¯ä¸æ”¶å°¾
-- ============================================

-- 1. éªŒè¯ç´¢å¼•åˆ›å»ºæˆåŠŸ
SHOW INDEX FROM users;
SHOW INDEX FROM verification_codes;
SHOW INDEX FROM conversations;
SHOW INDEX FROM messages;

-- 2. éªŒè¯ phone å”¯ä¸€çº¦æŸ
SELECT phone, COUNT(*) as count 
FROM users 
WHERE phone IS NOT NULL 
GROUP BY phone 
HAVING COUNT(*) > 1;
-- åº”è¯¥è¿”å› 0 è¡Œ

-- 3. æ£€æŸ¥è¡¨ç»“æ„
DESCRIBE users;
DESCRIBE verification_codes;

-- 4. éªŒè¯æŸ¥è¯¢æ€§èƒ½ï¼ˆå¯é€‰ï¼Œä½¿ç”¨ EXPLAINï¼‰
EXPLAIN SELECT * FROM users WHERE phone = '+8613812345678';
EXPLAIN SELECT * FROM verification_codes 
  WHERE phone = '+8613812345678' 
    AND code = '123456' 
    AND is_used = 0 
    AND expires_at > NOW();
```

---

## å››ã€æœ€ç»ˆç´¢å¼•è®¾è®¡ï¼ˆå®Œæ•´ç‰ˆï¼‰

### 4.1 users è¡¨

**å­—æ®µå˜æ›´**:
- âœ… ä¿ç•™ï¼š`phone VARCHAR(32)`ï¼ˆæ”¯æŒ E.164 æ ¼å¼ï¼‰
- âŒ åˆ é™¤ï¼š`email VARCHAR(100)`

**æœ€ç»ˆç´¢å¼•**:
```sql
PRIMARY KEY (user_id)
UNIQUE KEY uniq_phone (phone)                    -- ç™»å½•å‡­è¯ï¼Œå”¯ä¸€
INDEX idx_region_pro (app_region, is_pro)        -- åœ°åŒº+Proç»Ÿè®¡
```

**æŸ¥è¯¢åœºæ™¯è¦†ç›–**:
- âœ… æ‰‹æœºå·ç™»å½•ï¼š`WHERE phone = ?` â†’ `uniq_phone`
- âœ… åœ°åŒº+Proç»Ÿè®¡ï¼š`WHERE app_region = ? AND is_pro = ?` â†’ `idx_region_pro`

---

### 4.2 verification_codes è¡¨

**å­—æ®µå˜æ›´**:
- âœ… ä¿ç•™ï¼š`phone VARCHAR(32)`
- âŒ åˆ é™¤ï¼š`email VARCHAR(100)`

**æœ€ç»ˆç´¢å¼•**:
```sql
PRIMARY KEY (code_id)
INDEX idx_phone_verify (phone, code, is_used, expires_at)  -- éªŒè¯ç æ ¡éªŒæŸ¥è¯¢
INDEX idx_phone_created (phone, created_at)                -- é¢‘æ§ç»Ÿè®¡æŸ¥è¯¢ï¼ˆæ–°å¢ï¼‰
INDEX idx_expires_at (expires_at)                          -- è¿‡æœŸæ¸…ç†
```

**æŸ¥è¯¢åœºæ™¯è¦†ç›–**:
- âœ… éªŒè¯ç æ ¡éªŒï¼š`WHERE phone = ? AND code = ? AND is_used = 0 AND expires_at > NOW()` â†’ `idx_phone_verify`
- âœ… é¢‘æ§ç»Ÿè®¡ï¼š`WHERE phone = ? AND created_at > NOW() - INTERVAL 1 HOUR` â†’ `idx_phone_created`ï¼ˆæ–°å¢ï¼‰
- âœ… è¿‡æœŸæ¸…ç†ï¼š`WHERE expires_at < NOW()` â†’ `idx_expires_at`

---

### 4.3 chart_profiles è¡¨

**æœ€ç»ˆç´¢å¼•**:
```sql
PRIMARY KEY (chart_profile_id)
INDEX idx_user_default (user_id, is_default)    -- ç”¨æˆ·é»˜è®¤å‘½ç›˜æŸ¥è¯¢
FOREIGN KEY (user_id) â†’ users(user_id) ON DELETE CASCADE
```

**æŸ¥è¯¢åœºæ™¯è¦†ç›–**:
- âœ… ç”¨æˆ·é»˜è®¤å‘½ç›˜ï¼š`WHERE user_id = ? AND is_default = 1` â†’ `idx_user_default`

---

### 4.4 bazi_charts è¡¨

**æœ€ç»ˆç´¢å¼•**:
```sql
PRIMARY KEY (chart_id)
INDEX idx_chart_profile_id (chart_profile_id)
INDEX idx_needs_update_engine (needs_update, engine_version)  -- å¼•æ“æ›´æ–°æŸ¥è¯¢
FOREIGN KEY (chart_profile_id) â†’ chart_profiles(chart_profile_id) ON DELETE CASCADE
```

**æŸ¥è¯¢åœºæ™¯è¦†ç›–**:
- âœ… éœ€è¦æ›´æ–°çš„å‘½ç›˜ï¼š`WHERE needs_update = 1 AND engine_version < ?` â†’ `idx_needs_update_engine`

---

### 4.5 conversations è¡¨

**æœ€ç»ˆç´¢å¼•**:
```sql
PRIMARY KEY (conversation_id)
INDEX idx_user_created (user_id, created_at)     -- ç”¨æˆ·å¯¹è¯åˆ—è¡¨ï¼ˆæŒ‰æ—¶é—´æ’åºï¼‰
INDEX idx_chart_profile_id (chart_profile_id)
FOREIGN KEY (user_id) â†’ users(user_id) ON DELETE CASCADE
FOREIGN KEY (chart_profile_id) â†’ chart_profiles(chart_profile_id) ON DELETE SET NULL
```

**æŸ¥è¯¢åœºæ™¯è¦†ç›–**:
- âœ… ç”¨æˆ·å¯¹è¯åˆ—è¡¨ï¼š`WHERE user_id = ? ORDER BY created_at DESC` â†’ `idx_user_created`

---

### 4.6 messages è¡¨

**æœ€ç»ˆç´¢å¼•**:
```sql
PRIMARY KEY (message_id)
INDEX idx_conv_created (conversation_id, created_at)  -- å¯¹è¯æ¶ˆæ¯åˆ—è¡¨ï¼ˆæŒ‰æ—¶é—´æ’åºï¼‰
FOREIGN KEY (conversation_id) â†’ conversations(conversation_id) ON DELETE CASCADE
```

**æŸ¥è¯¢åœºæ™¯è¦†ç›–**:
- âœ… å¯¹è¯æ¶ˆæ¯åˆ—è¡¨ï¼š`WHERE conversation_id = ? ORDER BY created_at ASC` â†’ `idx_conv_created`

---

### 4.7 readings è¡¨

**æœ€ç»ˆç´¢å¼•**:
```sql
PRIMARY KEY (reading_id)
INDEX idx_user_created (user_id, created_at)           -- ç”¨æˆ·è§£è¯»è®°å½•ï¼ˆæŒ‰æ—¶é—´æ’åºï¼‰
INDEX idx_chart_scene_created (chart_id, scene, created_at)  -- å‘½ç›˜åœºæ™¯æŸ¥è¯¢
FOREIGN KEY (user_id) â†’ users(user_id) ON DELETE CASCADE
FOREIGN KEY (chart_id) â†’ bazi_charts(chart_id) ON DELETE SET NULL
```

**æŸ¥è¯¢åœºæ™¯è¦†ç›–**:
- âœ… ç”¨æˆ·è§£è¯»è®°å½•ï¼š`WHERE user_id = ? ORDER BY created_at DESC` â†’ `idx_user_created`
- âœ… å‘½ç›˜åœºæ™¯æŸ¥è¯¢ï¼š`WHERE chart_id = ? AND scene = ? ORDER BY created_at DESC` â†’ `idx_chart_scene_created`

---

### 4.8 user_settings è¡¨

**æœ€ç»ˆç´¢å¼•**:
```sql
PRIMARY KEY (setting_id)
UNIQUE KEY (user_id)  -- å·²å­˜åœ¨ï¼Œæ— éœ€ä¿®æ”¹
FOREIGN KEY (user_id) â†’ users(user_id) ON DELETE CASCADE
```

**è¯´æ˜**: ä¸€ä¸ªç”¨æˆ·åªæœ‰ä¸€æ¡è®¾ç½®ï¼Œ`UNIQUE (user_id)` å·²è¶³å¤Ÿã€‚

---

### 4.9 feedbacks è¡¨

**æœ€ç»ˆç´¢å¼•**:
```sql
PRIMARY KEY (feedback_id)
INDEX idx_user_created (user_id, created_at)     -- ç”¨æˆ·åé¦ˆåˆ—è¡¨
INDEX idx_status_created (status, created_at)    -- çŠ¶æ€æŸ¥è¯¢ï¼ˆæŒ‰æ—¶é—´æ’åºï¼‰
FOREIGN KEY (user_id) â†’ users(user_id) ON DELETE SET NULL
```

**æŸ¥è¯¢åœºæ™¯è¦†ç›–**:
- âœ… ç”¨æˆ·åé¦ˆåˆ—è¡¨ï¼š`WHERE user_id = ? ORDER BY created_at DESC` â†’ `idx_user_created`
- âœ… å¾…å¤„ç†åé¦ˆï¼š`WHERE status = 'pending' ORDER BY created_at ASC` â†’ `idx_status_created`

---

### 4.10 rate_limits è¡¨

**æœ€ç»ˆç´¢å¼•**:
```sql
PRIMARY KEY (limit_id)
UNIQUE KEY unique_user_api_date (user_id, api_type, date)  -- é™æµè®°å½•å”¯ä¸€çº¦æŸ
INDEX idx_date (date)                                       -- è¿‡æœŸæ¸…ç†
FOREIGN KEY (user_id) â†’ users(user_id) ON DELETE CASCADE
```

**è¯´æ˜**: 
- âŒ åˆ é™¤ `idx_user_id`ï¼ˆå†—ä½™ï¼Œ`unique_user_api_date` å‰ç¼€å·²è¦†ç›–ï¼‰
- âœ… ä¿ç•™ `idx_date`ï¼ˆç”¨äºæ¸…ç†è¿‡æœŸè®°å½•ï¼‰

---

### 4.11 llm_api_configs è¡¨

**æœ€ç»ˆç´¢å¼•**:
```sql
PRIMARY KEY (config_id)
UNIQUE KEY (model)  -- å·²å­˜åœ¨ï¼Œæ— éœ€ä¿®æ”¹
```

---

### 4.12 admins è¡¨

**æœ€ç»ˆç´¢å¼•**:
```sql
PRIMARY KEY (admin_id)
UNIQUE KEY (username)  -- å·²å­˜åœ¨ï¼Œæ— éœ€ä¿®æ”¹
```

**è¯´æ˜**: 
- âŒ åˆ é™¤ `idx_username`ï¼ˆå†—ä½™ï¼Œ`UNIQUE KEY` å·²åŒ…å«ç´¢å¼•ï¼‰

---

### 4.13 subscriptions è¡¨

**æœ€ç»ˆç´¢å¼•**:
```sql
PRIMARY KEY (subscription_id)
INDEX idx_user_status_expire (user_id, status, expires_at)  -- ç”¨æˆ·è®¢é˜…æŸ¥è¯¢
INDEX idx_status_expire (status, expires_at)                 -- è¿‡æœŸè®¢é˜…æ¸…ç†
FOREIGN KEY (user_id) â†’ users(user_id) ON DELETE CASCADE
```

**æŸ¥è¯¢åœºæ™¯è¦†ç›–**:
- âœ… ç”¨æˆ·æœ‰æ•ˆè®¢é˜…ï¼š`WHERE user_id = ? AND status = 'active' AND expires_at > NOW()` â†’ `idx_user_status_expire`
- âœ… è¿‡æœŸè®¢é˜…æ¸…ç†ï¼š`WHERE status = 'active' AND expires_at < NOW()` â†’ `idx_status_expire`

---

### 4.14 shensha_readings è¡¨

**æœ€ç»ˆç´¢å¼•**:
```sql
PRIMARY KEY (reading_id)
UNIQUE KEY unique_shensha_pillar (shensha_code, pillar_type)  -- å·²å­˜åœ¨
INDEX idx_shensha_active (shensha_code, pillar_type, is_active)  -- ä¼˜åŒ–æŸ¥è¯¢
```

**è¯´æ˜**: 
- âŒ åˆ é™¤å•åˆ—ç´¢å¼•ï¼š`idx_shensha_code`ã€`idx_pillar_type`ã€`idx_is_active`
- âœ… ç»„åˆç´¢å¼•è¦†ç›–ï¼š`WHERE shensha_code = ? AND pillar_type = ? AND is_active = 1`

---

### 4.15 system_settings è¡¨

**æœ€ç»ˆç´¢å¼•**:
```sql
PRIMARY KEY (setting_key)
INDEX idx_updated_at (updated_at)  -- å·²å­˜åœ¨ï¼Œæ— éœ€ä¿®æ”¹
```

---

## äº”ã€æ‰§è¡Œé¡ºåºä¸æ³¨æ„äº‹é¡¹

### 5.1 æ‰§è¡Œé¡ºåºï¼ˆå¿…é¡»æŒ‰é¡ºåºæ‰§è¡Œï¼‰

**âš ï¸ é‡è¦ï¼šæ‰€æœ‰æ“ä½œå¿…é¡»åœ¨ç»´æŠ¤çª—å£æœŸæ‰§è¡Œï¼Œå»ºè®®åœ¨ä½å³°æœŸè¿›è¡Œ**

#### æ­¥éª¤ 1ï¼šæ•°æ®å¤‡ä»½ï¼ˆå¿…é¡»ï¼‰
```bash
# å®Œæ•´å¤‡ä»½æ•°æ®åº“
mysqldump -u root -p xiaopei > backup_before_index_optimization_$(date +%Y%m%d_%H%M%S).sql

# éªŒè¯å¤‡ä»½æ–‡ä»¶
ls -lh backup_before_index_optimization_*.sql
```

#### æ­¥éª¤ 2ï¼šæ•°æ®è´¨é‡æ£€æŸ¥ï¼ˆå¿…é¡»ï¼‰
```sql
-- æ‰§è¡Œç¬¬äºŒç« çš„æ£€æŸ¥ SQLï¼Œç¡®è®¤æ•°æ®è´¨é‡
-- å¦‚æœæœ‰é—®é¢˜ï¼Œå…ˆå¤„ç†æ•°æ®ï¼Œå†ç»§ç»­
```

#### æ­¥éª¤ 3ï¼šåº”ç”¨å±‚å‡†å¤‡ï¼ˆå¿…é¡»ï¼‰
- âœ… ç¡®è®¤åº”ç”¨ä»£ç å·²æ›´æ–°ï¼ˆä¸å†ä½¿ç”¨ email ç™»å½•ï¼‰
- âœ… ç¡®è®¤ HK æ‰‹æœºå·ç™»å½•åŠŸèƒ½å·²å¼€å‘å®Œæˆ
- âœ… åœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯é€šè¿‡

#### æ­¥éª¤ 4ï¼šæ‰§è¡Œè¿ç§» SQLï¼ˆåˆ†é˜¶æ®µï¼‰
1. **é˜¶æ®µ 1**ï¼šæ•°æ®è´¨é‡æ£€æŸ¥ä¸å‡†å¤‡ï¼ˆ3.1ï¼‰
2. **é˜¶æ®µ 2**ï¼šåˆ é™¤ email å­—æ®µï¼ˆ3.2ï¼‰âš ï¸ **æ ¸å¿ƒå˜æ›´ï¼Œä¸å¯é€†**
3. **é˜¶æ®µ 3**ï¼šä¼˜åŒ– users è¡¨ç´¢å¼•ï¼ˆ3.3ï¼‰
4. **é˜¶æ®µ 4**ï¼šä¼˜åŒ– verification_codes è¡¨ç´¢å¼•ï¼ˆ3.4ï¼‰
5. **é˜¶æ®µ 5**ï¼šä¼˜åŒ–å…¶ä»–è¡¨ç´¢å¼•ï¼ˆ3.5ï¼‰
6. **é˜¶æ®µ 6**ï¼šéªŒè¯ä¸æ”¶å°¾ï¼ˆ3.6ï¼‰

#### æ­¥éª¤ 5ï¼šéªŒè¯ä¸ç›‘æ§
- éªŒè¯ç´¢å¼•åˆ›å»ºæˆåŠŸ
- éªŒè¯æŸ¥è¯¢æ€§èƒ½ï¼ˆEXPLAINï¼‰
- ç›‘æ§åº”ç”¨æ—¥å¿—ï¼Œç¡®è®¤æ— é”™è¯¯
- è§‚å¯Ÿæ•°æ®åº“æ€§èƒ½æŒ‡æ ‡

---

### 5.2 æ³¨æ„äº‹é¡¹

#### âš ï¸ å…³é”®é£é™©ç‚¹

1. **phone å”¯ä¸€çº¦æŸæ·»åŠ å¤±è´¥**
   - **åŸå› **ï¼šå­˜åœ¨é‡å¤æ‰‹æœºå·
   - **å¤„ç†**ï¼šå…ˆæ¸…ç†é‡å¤æ•°æ®ï¼Œæˆ–åˆå¹¶ç”¨æˆ·è´¦å·
   - **æ£€æŸ¥**ï¼šæ‰§è¡Œå‰å¿…é¡»æ£€æŸ¥ `SELECT phone, COUNT(*) FROM users WHERE phone IS NOT NULL GROUP BY phone HAVING COUNT(*) > 1;`

2. **HK ç”¨æˆ·æ•°æ®ä¸¢å¤±**
   - **åŸå› **ï¼šåªæœ‰ email æ²¡æœ‰ phone çš„ç”¨æˆ·æ— æ³•ç™»å½•
   - **å¤„ç†**ï¼šæŒ‰ 2.2 èŠ‚çš„è¿ç§»ç­–ç•¥å¤„ç†
   - **å»ºè®®**ï¼šå…ˆæ ‡è®°ä¸º `migration_status = 'pending'`ï¼Œåç»­å¼•å¯¼ç”¨æˆ·è¡¥æ‰‹æœºå·

3. **ç´¢å¼•åˆ›å»ºæ—¶é—´è¿‡é•¿**
   - **åŸå› **ï¼šå¤§è¡¨åˆ›å»ºç´¢å¼•ä¼šé”è¡¨
   - **å¤„ç†**ï¼šä½¿ç”¨ `ALGORITHM=INPLACE, LOCK=NONE`ï¼ˆMySQL 5.6+ï¼‰
   - **ç¤ºä¾‹**ï¼š
     ```sql
     ALTER TABLE users 
     ADD INDEX idx_region_pro (app_region, is_pro)
     ALGORITHM=INPLACE, LOCK=NONE;
     ```
   - **æ³¨æ„**ï¼šåˆå¹¶ ALTER TABLE æ“ä½œå¯ä»¥å‡å°‘è¡¨é‡å»ºæ¬¡æ•°ï¼Œä½†å•æ¬¡æ‰§è¡Œæ—¶é—´å¯èƒ½æ›´é•¿

4. **åº”ç”¨å±‚ä»£ç æœªåŒæ­¥**
   - **é£é™©**ï¼šåˆ é™¤ email åï¼Œåº”ç”¨å±‚ä»æŸ¥è¯¢ email å­—æ®µä¼šæŠ¥é”™
   - **å¤„ç†**ï¼šå¿…é¡»ç¡®ä¿åº”ç”¨ä»£ç å·²æ›´æ–°å¹¶æµ‹è¯•é€šè¿‡

5. **MySQL ç‰ˆæœ¬å…¼å®¹æ€§**
   - **é£é™©**ï¼š`DROP INDEX IF EXISTS` åœ¨ MySQL 5.7 ä¸­ä¸æ”¯æŒ
   - **å¤„ç†**ï¼šæ‰§è¡Œå‰å…ˆæŸ¥è¯¢ç´¢å¼•æ˜¯å¦å­˜åœ¨ï¼Œæˆ–ä½¿ç”¨ MySQL 8.0+
   - **æ£€æŸ¥è„šæœ¬**ï¼š
     ```sql
     -- æ£€æŸ¥ç´¢å¼•æ˜¯å¦å­˜åœ¨
     SELECT INDEX_NAME 
     FROM information_schema.statistics 
     WHERE table_schema = 'xiaopei'
       AND table_name = 'users'
       AND INDEX_NAME = 'idx_email';
     ```

#### ğŸ“‹ æ‰§è¡Œæ£€æŸ¥æ¸…å•

- [ ] æ•°æ®åº“å·²å®Œæ•´å¤‡ä»½
- [ ] æ•°æ®è´¨é‡æ£€æŸ¥é€šè¿‡ï¼ˆæ— é‡å¤ phoneï¼Œæ— å¼‚å¸¸æ•°æ®ï¼‰
- [ ] åº”ç”¨ä»£ç å·²æ›´æ–°ï¼ˆä¸å†ä½¿ç”¨ emailï¼‰
- [ ] HK æ‰‹æœºå·ç™»å½•åŠŸèƒ½å·²å¼€å‘å®Œæˆ
- [ ] æµ‹è¯•ç¯å¢ƒéªŒè¯é€šè¿‡
- [ ] ç»´æŠ¤çª—å£æœŸå·²å®‰æ’
- [ ] å›æ»šæ–¹æ¡ˆå·²å‡†å¤‡
- [ ] ç›‘æ§å‘Šè­¦å·²é…ç½®

---

### 5.3 å›æ»šæ–¹æ¡ˆ

#### åœºæ™¯ 1ï¼šåˆ é™¤ email åå‘ç°éœ€è¦å›æ»š

**å‰æ**ï¼šå¿…é¡»æœ‰å®Œæ•´å¤‡ä»½

```bash
# 1. åœæ­¢åº”ç”¨æœåŠ¡
# 2. æ¢å¤æ•°æ®åº“
mysql -u root -p xiaopei < backup_before_index_optimization_YYYYMMDD_HHMMSS.sql

# 3. éªŒè¯æ•°æ®æ¢å¤
SELECT COUNT(*) FROM users;
SELECT COUNT(*) FROM verification_codes;

# 4. é‡å¯åº”ç”¨æœåŠ¡
```

#### åœºæ™¯ 2ï¼šç´¢å¼•åˆ›å»ºå¤±è´¥

**å¤„ç†**ï¼šåˆ é™¤å¤±è´¥çš„ç´¢å¼•ï¼Œé‡æ–°åˆ›å»º

```sql
-- å¦‚æœç´¢å¼•åˆ›å»ºå¤±è´¥ï¼Œå…ˆåˆ é™¤
ALTER TABLE users DROP INDEX IF EXISTS idx_region_pro;

-- æ£€æŸ¥è¡¨çŠ¶æ€
SHOW TABLE STATUS LIKE 'users';

-- é‡æ–°åˆ›å»ºï¼ˆå¯èƒ½éœ€è¦ä¿®å¤è¡¨ï¼‰
REPAIR TABLE users;
ALTER TABLE users ADD INDEX idx_region_pro (app_region, is_pro);
```

#### åœºæ™¯ 3ï¼šphone å”¯ä¸€çº¦æŸæ·»åŠ å¤±è´¥

**å¤„ç†**ï¼šå…ˆå¤„ç†é‡å¤æ•°æ®ï¼Œå†æ·»åŠ çº¦æŸ

```sql
-- 1. æŸ¥çœ‹é‡å¤æ•°æ®
SELECT phone, COUNT(*) as count, GROUP_CONCAT(user_id) as user_ids
FROM users 
WHERE phone IS NOT NULL 
GROUP BY phone 
HAVING COUNT(*) > 1;

-- 2. å¤„ç†é‡å¤æ•°æ®ï¼ˆæ ¹æ®ä¸šåŠ¡é€»è¾‘å†³å®šä¿ç•™å“ªä¸ªç”¨æˆ·ï¼‰
-- é€‰é¡¹ Aï¼šåˆå¹¶ç”¨æˆ·æ•°æ®
-- é€‰é¡¹ Bï¼šæ ‡è®°é‡å¤ç”¨æˆ·ï¼Œè¦æ±‚ç”¨æˆ·è”ç³»å®¢æœ
-- é€‰é¡¹ Cï¼šåˆ é™¤é‡å¤è´¦å·ï¼ˆè°¨æ…ï¼‰

-- 3. é‡æ–°æ·»åŠ å”¯ä¸€çº¦æŸ
ALTER TABLE users ADD UNIQUE KEY uniq_phone (phone);
```

---

## å…­ã€æ€§èƒ½ä¼˜åŒ–æ•ˆæœé¢„æœŸ

### 6.1 æŸ¥è¯¢æ€§èƒ½æå‡

| æŸ¥è¯¢åœºæ™¯ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|---------|--------|--------|------|
| **ç”¨æˆ·ç™»å½•** | `WHERE phone = ? OR email = ?` | `WHERE phone = ?` | **50%+** |
| **éªŒè¯ç æ ¡éªŒ** | å¤šåˆ—ç´¢å¼•æ‰«æ | ç»„åˆç´¢å¼•è¦†ç›– | **70%+** |
| **ç”¨æˆ·å¯¹è¯åˆ—è¡¨** | ç´¢å¼• + æ’åº | ç»„åˆç´¢å¼•è¦†ç›–æ’åº | **60%+** |
| **æ¶ˆæ¯åˆ—è¡¨** | ç´¢å¼• + æ’åº | ç»„åˆç´¢å¼•è¦†ç›–æ’åº | **60%+** |
| **è®¢é˜…æŸ¥è¯¢** | å¤šç´¢å¼•æ‰«æ | ç»„åˆç´¢å¼•è¦†ç›– | **50%+** |

### 6.2 å­˜å‚¨ç©ºé—´èŠ‚çœ

- **åˆ é™¤ email å­—æ®µ**ï¼šæ¯ç”¨æˆ·èŠ‚çœ ~100 å­—èŠ‚
- **åˆ é™¤å†—ä½™ç´¢å¼•**ï¼šèŠ‚çœç´¢å¼•å­˜å‚¨ç©ºé—´ ~10-20%
- **æ€»è®¡**ï¼šé¢„è®¡èŠ‚çœå­˜å‚¨ç©ºé—´ **5-10%**

### 6.3 ç´¢å¼•ç»´æŠ¤æˆæœ¬é™ä½

- **ç´¢å¼•æ•°é‡å‡å°‘**ï¼šä» ~40 ä¸ªå‡å°‘åˆ° ~30 ä¸ª
- **ç´¢å¼•æ›´æ–°æˆæœ¬é™ä½**ï¼šç»„åˆç´¢å¼•å‡å°‘å›è¡¨æ¬¡æ•°
- **æŸ¥è¯¢ä¼˜åŒ–å™¨é€‰æ‹©æ›´ä¼˜**ï¼šç´¢å¼•è¦†ç›–æ›´å¤šæŸ¥è¯¢åœºæ™¯

---

## ä¸ƒã€åç»­ä¼˜åŒ–å»ºè®®

### 7.1 æ‰‹æœºå·æ ¼å¼æ ‡å‡†åŒ–

**å»ºè®®**ï¼šåœ¨åº”ç”¨å±‚ç»Ÿä¸€æ‰‹æœºå·æ ¼å¼ï¼ˆE.164ï¼‰

```typescript
// ç¤ºä¾‹ï¼šæ‰‹æœºå·æ ‡å‡†åŒ–å‡½æ•°
function normalizePhone(phone: string, region: 'cn' | 'hk'): string {
  // CN: +86 + 11ä½æ•°å­—ï¼ˆå»æ‰å‰å¯¼0ï¼‰
  // HK: +852 + 8ä½æ•°å­—
  // ç»Ÿä¸€è½¬æ¢ä¸º E.164 æ ¼å¼
}
```

### 7.2 å®šæœŸç´¢å¼•ç»´æŠ¤

```sql
-- 1. å®šæœŸåˆ†æè¡¨ï¼ˆæ›´æ–°ç´¢å¼•ç»Ÿè®¡ä¿¡æ¯ï¼‰
ANALYZE TABLE users, verification_codes, conversations, messages;

-- 2. æ£€æŸ¥æœªä½¿ç”¨çš„ç´¢å¼•ï¼ˆMySQL 5.7+ï¼‰
SELECT * FROM sys.schema_unused_indexes;

-- 3. æ£€æŸ¥ç´¢å¼•ç¢ç‰‡ï¼ˆInnoDBï¼‰
SELECT 
  TABLE_NAME,
  INDEX_NAME,
  ROUND(STAT_VALUE * @@innodb_page_size / 1024 / 1024, 2) AS 'Index Size (MB)'
FROM mysql.innodb_index_stats
WHERE STAT_NAME = 'size'
ORDER BY STAT_VALUE DESC;
```

### 7.3 ç›‘æ§æŒ‡æ ‡

**å»ºè®®ç›‘æ§çš„æŒ‡æ ‡**ï¼š

1. **æŸ¥è¯¢æ€§èƒ½**
   - æ…¢æŸ¥è¯¢æ•°é‡ï¼ˆ`long_query_time`ï¼‰
   - ç´¢å¼•ä½¿ç”¨ç‡ï¼ˆ`Handler_read_key`ï¼‰
   - å…¨è¡¨æ‰«ææ¬¡æ•°ï¼ˆ`Handler_read_rnd_next`ï¼‰

2. **ç´¢å¼•æ•ˆç‡**
   - ç´¢å¼•å‘½ä¸­ç‡
   - ç´¢å¼•å¤§å°
   - ç´¢å¼•ç¢ç‰‡ç‡

3. **ä¸šåŠ¡æŒ‡æ ‡**
   - ç™»å½•æˆåŠŸç‡
   - éªŒè¯ç å‘é€æˆåŠŸç‡
   - API å“åº”æ—¶é—´ï¼ˆP50, P95, P99ï¼‰

---

## å…«ã€å¸¸è§é—®é¢˜ FAQ

### Q1: ä¸ºä»€ä¹ˆ phone å­—æ®µå…è®¸ NULLï¼Ÿ

**A**: å› ä¸ºå†å²æ•°æ®ä¸­å¯èƒ½å­˜åœ¨ phone ä¸º NULL çš„ç”¨æˆ·ï¼ˆç‰¹åˆ«æ˜¯ HK ç”¨æˆ·ï¼‰ã€‚å»ºè®®ï¼š
- æ–°ç”¨æˆ·æ³¨å†Œæ—¶å¼ºåˆ¶è¦æ±‚ phone éç©º
- å†å²ç”¨æˆ·é€šè¿‡è¿ç§»ç­–ç•¥å¤„ç†
- åç»­å¯ä»¥è€ƒè™‘æ·»åŠ  `NOT NULL` çº¦æŸ

### Q2: ç»„åˆç´¢å¼•çš„å­—æ®µé¡ºåºå¦‚ä½•ç¡®å®šï¼Ÿ

**A**: éµå¾ªä»¥ä¸‹åŸåˆ™ï¼š
1. **ç­‰å€¼æŸ¥è¯¢åœ¨å‰**ï¼š`WHERE user_id = ? AND created_at > ?` â†’ `(user_id, created_at)`
2. **é€‰æ‹©æ€§é«˜çš„åœ¨å‰**ï¼šé€‰æ‹©æ€§é«˜çš„å­—æ®µæ”¾åœ¨å‰é¢ï¼Œå‡å°‘æ‰«æèŒƒå›´
3. **æ’åºå­—æ®µåœ¨å**ï¼š`ORDER BY created_at` â†’ `(user_id, created_at)`

### Q3: ä¸ºä»€ä¹ˆåˆ é™¤ `rate_limits.idx_user_id`ï¼Ÿ

**A**: å› ä¸º `unique_user_api_date (user_id, api_type, date)` çš„å‰ç¼€å°±æ˜¯ `user_id`ï¼ŒMySQL å¯ä»¥ä½¿ç”¨è¿™ä¸ªå”¯ä¸€ç´¢å¼•çš„å‰ç¼€æ¥ä¼˜åŒ– `WHERE user_id = ?` çš„æŸ¥è¯¢ï¼Œæ‰€ä»¥ `idx_user_id` æ˜¯å†—ä½™çš„ã€‚

### Q4: ç´¢å¼•åˆ›å»ºä¼šé”è¡¨å—ï¼Ÿ

**A**: 
- **MySQL 5.6+**ï¼šæ”¯æŒåœ¨çº¿ DDLï¼Œå¯ä»¥ä½¿ç”¨ `ALGORITHM=INPLACE, LOCK=NONE`
- **MySQL 5.5 åŠä»¥ä¸‹**ï¼šä¼šé”è¡¨ï¼Œå»ºè®®åœ¨ç»´æŠ¤çª—å£æœŸæ‰§è¡Œ
- **å¤§è¡¨**ï¼šå³ä½¿åœ¨çº¿ DDLï¼Œä¹Ÿå¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´ï¼Œå»ºè®®åˆ†æ‰¹æ‰§è¡Œ

### Q5: å¦‚ä½•éªŒè¯ç´¢å¼•ä¼˜åŒ–æ•ˆæœï¼Ÿ

**A**: 
1. **ä½¿ç”¨ EXPLAIN**ï¼šæŸ¥çœ‹æŸ¥è¯¢è®¡åˆ’ï¼Œç¡®è®¤ä½¿ç”¨äº†æ–°ç´¢å¼•
2. **æ…¢æŸ¥è¯¢æ—¥å¿—**ï¼šå¯¹æ¯”ä¼˜åŒ–å‰åçš„æ…¢æŸ¥è¯¢æ•°é‡
3. **æ€§èƒ½æµ‹è¯•**ï¼šå‹æµ‹å¯¹æ¯”ä¼˜åŒ–å‰åçš„ QPS å’Œå»¶è¿Ÿ
4. **ç›‘æ§æŒ‡æ ‡**ï¼šè§‚å¯Ÿæ•°æ®åº“ CPUã€IO ä½¿ç”¨ç‡å˜åŒ–

### Q6: ä¸ºä»€ä¹ˆ verification_codes éœ€è¦ä¸¤ä¸ªç´¢å¼•ï¼Ÿ

**A**: 
- `idx_phone_verify (phone, code, is_used, expires_at)`ï¼šç”¨äºéªŒè¯ç æ ¡éªŒæŸ¥è¯¢
- `idx_phone_created (phone, created_at)`ï¼šç”¨äºé¢‘æ§ç»Ÿè®¡æŸ¥è¯¢ï¼ˆå¦‚ï¼š1å°æ—¶å†…å‘é€æ¬¡æ•°ï¼‰
- ä¸¤ä¸ªç´¢å¼•è¦†ç›–ä¸åŒçš„æŸ¥è¯¢åœºæ™¯ï¼Œè™½ç„¶å†™å…¥æˆæœ¬ç•¥å¢ï¼Œä½†æŸ¥è¯¢æ€§èƒ½æå‡æ˜æ˜¾

### Q7: shensha_readings çš„ç´¢å¼•æ˜¯å¦è¿‡åº¦ä¼˜åŒ–ï¼Ÿ

**A**: 
- å¦‚æœä¸šåŠ¡æ¨¡å‹æ˜¯ã€Œæ¯ä¸ª (shensha_code, pillar_type) åªæœ‰ä¸€æ¡è®°å½•ã€ï¼Œä¸”ä¸éœ€è¦æŒ‰ `is_active` æ‰¹é‡æŸ¥è¯¢ï¼Œå¯ä»¥åªä¿ç•™ `unique_shensha_pillar`
- å¦‚æœéœ€è¦æ”¯æŒã€ŒæŸ¥è¯¢å½“å‰ç”Ÿæ•ˆçš„ç¥ç…ã€åœºæ™¯ï¼ˆ`WHERE is_active = 1`ï¼‰ï¼Œåˆ™ä¿ç•™ `idx_shensha_active` æ˜¯åˆç†çš„
- å»ºè®®æ ¹æ®å®é™…æŸ¥è¯¢åœºæ™¯å†³å®šæ˜¯å¦ä¿ç•™ `idx_shensha_active`

### Q8: ä¸ºä»€ä¹ˆè¦æŠŠå¤šä¸ª ALTER TABLE åˆå¹¶ï¼Ÿ

**A**: 
- **å‡å°‘è¡¨é‡å»ºæ¬¡æ•°**ï¼šæ¯æ¬¡ `ALTER TABLE` éƒ½å¯èƒ½è§¦å‘è¡¨é‡å»ºï¼Œåˆå¹¶æ“ä½œå¯ä»¥å‡å°‘é‡å»ºæ¬¡æ•°
- **é™ä½é”è¡¨æ—¶é—´**ï¼šè™½ç„¶ InnoDB æ”¯æŒåœ¨çº¿ DDLï¼Œä½†åˆå¹¶æ“ä½œä»ç„¶æ›´é«˜æ•ˆ
- **æ³¨æ„**ï¼šåˆå¹¶åçš„å•æ¡ SQL æ‰§è¡Œæ—¶é—´å¯èƒ½æ›´é•¿ï¼Œä½†æ€»ä½“å½±å“æ›´å°

---

## ä¹ã€æ€»ç»“

### 9.1 æ ¸å¿ƒå˜æ›´

1. âœ… **åˆ é™¤ email å­—æ®µ**ï¼šç®€åŒ–ç™»å½•é€»è¾‘ï¼Œç»Ÿä¸€ä½¿ç”¨æ‰‹æœºå·
2. âœ… **æ‰‹æœºå·æ ‡å‡†åŒ–**ï¼šæ”¯æŒ E.164 æ ¼å¼ï¼Œå…¼å®¹ CN å’Œ HK
3. âœ… **ç´¢å¼•ä¼˜åŒ–**ï¼šç»„åˆç´¢å¼•æ›¿ä»£å•åˆ—ç´¢å¼•ï¼Œæå‡æŸ¥è¯¢æ€§èƒ½
4. âœ… **åˆ é™¤å†—ä½™ç´¢å¼•**ï¼šå‡å°‘å­˜å‚¨å’Œç»´æŠ¤æˆæœ¬

### 9.2 é¢„æœŸæ•ˆæœ

- **æŸ¥è¯¢æ€§èƒ½æå‡**ï¼š50-70%
- **å­˜å‚¨ç©ºé—´èŠ‚çœ**ï¼š5-10%
- **ç´¢å¼•ç»´æŠ¤æˆæœ¬é™ä½**ï¼š10-20%
- **ç³»ç»Ÿå¹¶å‘èƒ½åŠ›æå‡**ï¼šé…åˆå…¶ä»–ä¼˜åŒ–ï¼Œæ•´ä½“æå‡ 5-10 å€

### 9.3 æ‰§è¡Œå»ºè®®

1. **åˆ†é˜¶æ®µæ‰§è¡Œ**ï¼šä¸è¦ä¸€æ¬¡æ€§æ‰§è¡Œæ‰€æœ‰å˜æ›´
2. **å……åˆ†æµ‹è¯•**ï¼šåœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯é€šè¿‡åå†ä¸Šç”Ÿäº§
3. **ç›‘æ§å‘Šè­¦**ï¼šæ‰§è¡Œåå¯†åˆ‡ç›‘æ§ç³»ç»ŸæŒ‡æ ‡
4. **ä¿ç•™å›æ»šæ–¹æ¡ˆ**ï¼šç¡®ä¿å¯ä»¥å¿«é€Ÿå›æ»š

---

**æ–‡æ¡£ç‰ˆæœ¬**: v2.0  
**æœ€åæ›´æ–°**: 2025-01-XX  
**ç»´æŠ¤è€…**: å¼€å‘å›¢é˜Ÿ

---

## é™„å½• Aï¼šå®Œæ•´è¿ç§» SQL è„šæœ¬ï¼ˆç”Ÿäº§ç¯å¢ƒç‰ˆï¼‰

> âš ï¸ **è­¦å‘Š**ï¼šæ­¤è„šæœ¬å·²ä¼˜åŒ–ä¸ºç”Ÿäº§ç¯å¢ƒç‰ˆæœ¬
> - ç§»é™¤äº† `IF EXISTS`ï¼ˆMySQL 5.7 å…¼å®¹ï¼‰
> - åˆå¹¶äº†åŒä¸€è¡¨çš„ ALTER TABLE æ“ä½œ
> - æ·»åŠ äº† verification_codes çš„é¢‘æ§ç´¢å¼•
> - **å»ºè®®åˆ†é˜¶æ®µæ‰§è¡Œï¼Œä¸è¦ä¸€æ¬¡æ€§è¿è¡Œ**

```sql
-- ============================================
-- å°ä½©æ•°æ®åº“ç´¢å¼•ä¼˜åŒ– - å®Œæ•´è¿ç§»è„šæœ¬ï¼ˆç”Ÿäº§ç¯å¢ƒç‰ˆï¼‰
-- ç‰ˆæœ¬ï¼šv2.1
-- MySQL ç‰ˆæœ¬è¦æ±‚ï¼š5.7+ / 8.0+ï¼ˆæ¨è 8.0+ï¼‰
-- æ‰§è¡Œå‰å¿…é¡»ï¼šå¤‡ä»½æ•°æ®åº“ã€æ£€æŸ¥æ•°æ®è´¨é‡ã€ç¡®è®¤åº”ç”¨ä»£ç å·²æ›´æ–°
-- ============================================

-- âš ï¸ æ³¨æ„ï¼šæ­¤è„šæœ¬å·²ä¼˜åŒ–ä¸ºç”Ÿäº§ç¯å¢ƒç‰ˆæœ¬
-- 1. ç§»é™¤äº† IF EXISTSï¼ˆMySQL 5.7 å…¼å®¹æ€§ï¼‰
-- 2. åˆå¹¶äº†åŒä¸€è¡¨çš„ ALTER TABLE æ“ä½œ
-- 3. æ·»åŠ äº† verification_codes çš„é¢‘æ§ç´¢å¼•
-- 4. æ‰§è¡Œå‰è¯·å…ˆæ£€æŸ¥ç´¢å¼•æ˜¯å¦å­˜åœ¨ï¼ˆè§ä¸‹æ–¹æ£€æŸ¥è„šæœ¬ï¼‰

-- ============================================
-- å‰ç½®æ£€æŸ¥ï¼šç¡®è®¤ç´¢å¼•æ˜¯å¦å­˜åœ¨ï¼ˆå¯é€‰ï¼‰
-- ============================================
-- SELECT INDEX_NAME 
-- FROM information_schema.statistics 
-- WHERE table_schema = 'xiaopei' 
--   AND table_name = 'users' 
--   AND INDEX_NAME IN ('idx_email', 'idx_phone', 'idx_app_region', 'idx_is_pro');

-- ============================================
-- é˜¶æ®µ 1ï¼šæ•°æ®è´¨é‡æ£€æŸ¥ä¸å‡†å¤‡
-- ============================================
ALTER TABLE users 
MODIFY COLUMN phone VARCHAR(32) NULL COMMENT 'æ‰‹æœºå·ï¼ˆE.164æ ¼å¼ï¼Œå¦‚+8613812345678ï¼‰';

ALTER TABLE verification_codes 
MODIFY COLUMN phone VARCHAR(32) NULL COMMENT 'æ‰‹æœºå·ï¼ˆE.164æ ¼å¼ï¼‰';

-- ============================================
-- é˜¶æ®µ 2ï¼šåˆ é™¤ email å­—æ®µ
-- ============================================
-- âš ï¸ å¦‚æœç´¢å¼•ä¸å­˜åœ¨ä¼šæŠ¥é”™ï¼Œéœ€è¦å…ˆç¡®è®¤
ALTER TABLE users
  DROP INDEX idx_email,
  DROP COLUMN email;

ALTER TABLE verification_codes
  DROP INDEX idx_email,
  DROP COLUMN email;

-- ============================================
-- é˜¶æ®µ 3ï¼šä¼˜åŒ– users è¡¨ç´¢å¼•ï¼ˆåˆå¹¶æ“ä½œï¼‰
-- ============================================
-- âš ï¸ æ‰§è¡Œå‰ç¡®ä¿ phone æ— é‡å¤ï¼ˆå…ˆæ‰§è¡Œæ£€æŸ¥ SQLï¼‰
ALTER TABLE users
  DROP INDEX idx_phone,
  DROP INDEX idx_app_region,
  DROP INDEX idx_is_pro,
  ADD UNIQUE KEY uniq_phone (phone),
  ADD INDEX idx_region_pro (app_region, is_pro);

-- ============================================
-- é˜¶æ®µ 4ï¼šä¼˜åŒ– verification_codes è¡¨ç´¢å¼•ï¼ˆåˆå¹¶æ“ä½œï¼‰
-- ============================================
ALTER TABLE verification_codes
  DROP INDEX idx_phone,
  ADD INDEX idx_phone_verify (phone, code, is_used, expires_at),
  ADD INDEX idx_phone_created (phone, created_at);

-- ============================================
-- é˜¶æ®µ 5ï¼šä¼˜åŒ–å…¶ä»–è¡¨ç´¢å¼•
-- ============================================

-- 5.1 chart_profiles è¡¨ï¼ˆåˆå¹¶æ“ä½œï¼‰
ALTER TABLE chart_profiles
  DROP INDEX idx_user_id,
  DROP INDEX idx_is_default,
  ADD INDEX idx_user_default (user_id, is_default);

-- 5.2 bazi_charts è¡¨ï¼ˆåˆå¹¶æ“ä½œï¼‰
ALTER TABLE bazi_charts
  DROP INDEX idx_needs_update,
  DROP INDEX idx_engine_version,
  ADD INDEX idx_needs_update_engine (needs_update, engine_version);

-- 5.3 conversations è¡¨ï¼ˆåˆå¹¶æ“ä½œï¼‰
ALTER TABLE conversations
  DROP INDEX idx_user_id,
  DROP INDEX idx_created_at,
  ADD INDEX idx_user_created (user_id, created_at);

-- 5.4 messages è¡¨ï¼ˆåˆå¹¶æ“ä½œï¼‰
ALTER TABLE messages
  DROP INDEX idx_conversation_id,
  DROP INDEX idx_created_at,
  ADD INDEX idx_conv_created (conversation_id, created_at);
-- å¯é€‰ï¼šå¦‚æœå­˜åœ¨ follow_ups ç´¢å¼•ä¸”ä¸å†éœ€è¦ï¼Œå¯åˆ é™¤
-- ALTER TABLE messages DROP INDEX idx_follow_ups;

-- 5.5 readings è¡¨ï¼ˆåˆ†ä¸¤æ­¥ï¼Œå› ä¸ºéœ€è¦ä¸¤ä¸ªä¸åŒçš„ç»„åˆç´¢å¼•ï¼‰
ALTER TABLE readings
  DROP INDEX idx_user_id,
  DROP INDEX idx_created_at,
  ADD INDEX idx_user_created (user_id, created_at);

ALTER TABLE readings
  DROP INDEX idx_chart_id,
  DROP INDEX idx_scene,
  ADD INDEX idx_chart_scene_created (chart_id, scene, created_at);

-- 5.6 feedbacks è¡¨ï¼ˆåˆå¹¶æ“ä½œï¼‰
ALTER TABLE feedbacks
  DROP INDEX idx_user_id,
  DROP INDEX idx_created_at,
  DROP INDEX idx_status,
  ADD INDEX idx_user_created (user_id, created_at),
  ADD INDEX idx_status_created (status, created_at);

-- 5.7 rate_limits è¡¨
ALTER TABLE rate_limits
  DROP INDEX idx_user_id;

-- 5.8 subscriptions è¡¨ï¼ˆåˆå¹¶æ“ä½œï¼‰
ALTER TABLE subscriptions
  DROP INDEX idx_user_id,
  DROP INDEX idx_status,
  DROP INDEX idx_expires_at,
  ADD INDEX idx_user_status_expire (user_id, status, expires_at),
  ADD INDEX idx_status_expire (status, expires_at);

-- 5.9 admins è¡¨
ALTER TABLE admins
  DROP INDEX idx_username;

-- 5.10 shensha_readings è¡¨ï¼ˆåˆå¹¶æ“ä½œï¼‰
ALTER TABLE shensha_readings
  DROP INDEX idx_shensha_code,
  DROP INDEX idx_pillar_type,
  DROP INDEX idx_is_active,
  ADD INDEX idx_shensha_active (shensha_code, pillar_type, is_active);

-- ============================================
-- å®Œæˆ
-- ============================================
SELECT 'æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–å®Œæˆï¼' AS message;

-- éªŒè¯ç´¢å¼•åˆ›å»ºæˆåŠŸ
-- SHOW INDEX FROM users;
-- SHOW INDEX FROM verification_codes;
```

---

## é™„å½• Bï¼šç´¢å¼•å¯¹æ¯”è¡¨

| è¡¨å | ä¼˜åŒ–å‰ç´¢å¼•æ•° | ä¼˜åŒ–åç´¢å¼•æ•° | å˜åŒ– |
|------|------------|------------|------|
| `users` | 4 | 2 | -2 |
| `verification_codes` | 3 | 3 | 0 |
| `chart_profiles` | 2 | 1 | -1 |
| `bazi_charts` | 3 | 2 | -1 |
| `conversations` | 3 | 2 | -1 |
| `messages` | 2 | 1 | -1 |
| `readings` | 4 | 2 | -2 |
| `feedbacks` | 3 | 2 | -1 |
| `rate_limits` | 3 | 2 | -1 |
| `subscriptions` | 3 | 2 | -1 |
| `admins` | 2 | 1 | -1 |
| `shensha_readings` | 4 | 2 | -2 |
| **æ€»è®¡** | **38** | **24** | **-14** |

**è¯´æ˜**ï¼š
- `verification_codes` è¡¨è™½ç„¶ç´¢å¼•æ•°é‡ä¸å˜ï¼Œä½†ä¼˜åŒ–ä¸ºç»„åˆç´¢å¼•ï¼ŒæŸ¥è¯¢æ€§èƒ½æå‡æ˜æ˜¾
- å…¶ä»–è¡¨ç´¢å¼•æ•°é‡å‡å°‘ï¼Œä½†æŸ¥è¯¢è¦†ç›–æ›´å…¨é¢

---

**æ–‡æ¡£ç»“æŸ**