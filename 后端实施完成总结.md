# å¾Œç«¯å¯¦æ–½å®Œæˆç¸½çµ

> **å®Œæˆæ™‚é–“**ï¼š2024-12-XX  
> **æ–¹æ¡ˆ**ï¼šå°ä½©æœƒå“¡ & AI è§£è®€æ¬¡æ•¸é™åˆ¶ â€”â€” ç²¾ç°¡æŠ€è¡“æ–¹æ¡ˆ v1

---

## âœ… å·²å®Œæˆé …ç›®

### 1. è³‡æ–™åº« Migrationï¼ˆP0ï¼‰

**æ–‡ä»¶**ï¼š`core/src/database/migrations/011_add_ai_quota_fields.sql`

**å…§å®¹**ï¼š
- âœ… æ–°å¢ `users.ai_calls_today`ï¼ˆINTï¼Œä»Šæ—¥å·²ä½¿ç”¨æ¬¡æ•¸ï¼‰
- âœ… æ–°å¢ `users.ai_calls_date`ï¼ˆVARCHAR(10)ï¼Œè¨ˆæ•¸æ—¥æœŸï¼‰
- âœ… ä¿®æ”¹ `users.pro_plan` æ”¯æ´ `quarterly`
- âœ… ä¿®æ”¹ `subscriptions.plan` æ”¯æ´ `quarterly`
- âœ… æ·»åŠ ç´¢å¼• `idx_ai_calls_date`

**åŸ·è¡Œæ–¹å¼**ï¼š
```bash
# åœ¨ MySQL ä¸­åŸ·è¡Œ
mysql -u root -p xiaopei_db < core/src/database/migrations/011_add_ai_quota_fields.sql
```

---

### 2. AI æ¬¡æ•¸é™åˆ¶æœå‹™ï¼ˆP0ï¼‰

**æ–‡ä»¶**ï¼š`core/src/modules/ai/aiQuotaService.ts`

**åŠŸèƒ½**ï¼š
- âœ… `isProValid(user)`ï¼šåˆ¤æ–· Pro æ˜¯å¦æœ‰æ•ˆ
- âœ… `isFirstDay(user)`ï¼šåˆ¤æ–·æ˜¯å¦è¨»å†Šé¦–æ—¥
- âœ… `getDailyLimit(user)`ï¼šè¨ˆç®—ä»Šæ—¥ä¸Šé™
  - Proï¼š100 æ¬¡/å¤©
  - éæœƒå“¡é¦–æ—¥ï¼š10 æ¬¡/å¤©
  - éæœƒå“¡æ¬¡æ—¥ï¼š5 æ¬¡/å¤©
- âœ… `resetAiCallsIfNeeded(user)`ï¼šè·¨å¤©é‡ç½®æ¬¡æ•¸
- âœ… `checkAndCountAIUsage(userId)`ï¼šæª¢æŸ¥ä¸¦ç´¯è¨ˆæ¬¡æ•¸
- âœ… `getAIUsageStatus(userId)`ï¼šç²å–ç•¶å‰ä½¿ç”¨ç‹€æ…‹ï¼ˆä¸ç´¯è¨ˆï¼‰
- âœ… `AiLimitReachedError`ï¼šæ¬¡æ•¸ç”¨å®ŒéŒ¯èª¤é¡å‹

---

### 3. LLM èª¿ç”¨å°è£ï¼ˆP0ï¼‰

**æ–‡ä»¶**ï¼š`core/src/modules/ai/aiService.ts`

**æ–°å¢å‡½å¼**ï¼š
- âœ… `chatStreamWithQuota(userId, params)`ï¼šå°è£æµå¼èª¿ç”¨ + AI æ¬¡æ•¸æª¢æŸ¥

**ç‰¹é»**ï¼š
- å…ˆèª¿ç”¨ `checkAndCountAIUsage(userId)` æª¢æŸ¥æ¬¡æ•¸
- å†èª¿ç”¨ `chatStream()` é€²è¡Œ LLM èª¿ç”¨
- è‡ªå‹•é¸æ“‡é»˜èªæ¨¡å‹ï¼ˆå¦‚æœæ²’æœ‰æŒ‡å®šï¼‰

---

### 4. æ”¹é€  LLM èª¿ç”¨å…¥å£ï¼ˆP0ï¼‰

**æ–‡ä»¶**ï¼š`core/src/routes/conversation.ts`

**æ”¹å‹•**ï¼š
- âœ… èŠå¤© API æ”¹ç”¨ `aiService.chatStreamWithQuota(userId, ...)`
- âœ… æ·»åŠ  `AiLimitReachedError` éŒ¯èª¤è™•ç†
- âœ… è¿”å› 429 ç‹€æ…‹ç¢¼ + çµ±ä¸€éŒ¯èª¤æ ¼å¼ï¼š
  ```json
  {
    "success": false,
    "error": {
      "code": "AI_DAILY_LIMIT_REACHED",
      "message": "ä»Šæ—¥è§£è®€æ¬¡æ•¸å·²ç”¨å®Œ",
      "details": {
        "limit": 5,
        "used": 5,
        "remaining": 0
      }
    }
  }
  ```

---

### 5. æœƒå“¡ç‹€æ…‹ API æ”¹é€ ï¼ˆP0ï¼‰

**æ–‡ä»¶**ï¼š`core/src/routes/pro.ts`

**æ”¹å‹•**ï¼š
- âœ… `GET /api/v1/pro/status` æ–°å¢è¿”å› AI æ¬¡æ•¸ä¿¡æ¯ï¼š
  ```json
  {
    "success": true,
    "data": {
      "isPro": true,
      "proPlan": "monthly",
      "proExpiresAt": "2025-01-01T00:00:00.000Z",
      "features": ["..."],
      "aiCallsToday": 3,
      "aiDailyLimit": 100,
      "aiRemaining": 97
    }
  }
  ```

---

### 6. å‡æ”¯ä»˜ APIï¼ˆP0ï¼‰

**æ–‡ä»¶**ï¼š`core/src/routes/pro.ts`

**æ–°å¢æ¥å£**ï¼š
- âœ… `POST /api/v1/pro/fake-subscribe`
  - æ”¯æ´ `monthly`ã€`quarterly`ã€`yearly` ä¸‰ç¨®æ–¹æ¡ˆ
  - ç›´æ¥èª¿ç”¨ `subscribe(userId, plan)` é–‹é€šæœƒå“¡
  - æ¸¬è©¦ç”¨ï¼Œæœªä¾†å¯æ›¿æ›ç‚ºçœŸå¯¦æ”¯ä»˜

**è«‹æ±‚æ ¼å¼**ï¼š
```json
{
  "plan": "quarterly"
}
```

**éŸ¿æ‡‰æ ¼å¼**ï¼š
```json
{
  "success": true,
  "data": {
    "subscription": { ... },
    "user": {
      "isPro": true,
      "proExpiresAt": "2025-03-XX...",
      "proPlan": "quarterly"
    }
  }
}
```

---

### 7. ä¿®æ”¹ pro_plan æ”¯æ´å­£åº¦ï¼ˆP0ï¼‰

**å·²å®Œæˆ**ï¼š
- âœ… Migration è…³æœ¬ä¸­å·²ä¿®æ”¹ ENUM
- âœ… `/api/v1/pro/subscribe` å·²æ”¯æ´ `quarterly`
- âœ… `/api/v1/pro/fake-subscribe` å·²æ”¯æ´ `quarterly`

---

## ğŸ“‹ API è®Šæ›´ç¸½çµ

### æ–°å¢ API

| æ–¹æ³• | è·¯å¾‘ | èªªæ˜ |
|------|------|------|
| POST | `/api/v1/pro/fake-subscribe` | å‡æ”¯ä»˜è¨‚é–±ï¼ˆæ¸¬è©¦ç”¨ï¼‰ |

### ä¿®æ”¹ API

| æ–¹æ³• | è·¯å¾‘ | è®Šæ›´å…§å®¹ |
|------|------|----------|
| GET | `/api/v1/pro/status` | æ–°å¢è¿”å› `aiCallsToday`ã€`aiDailyLimit`ã€`aiRemaining` |
| POST | `/api/v1/pro/subscribe` | æ”¯æ´ `quarterly` æ–¹æ¡ˆ |
| POST | `/api/v1/conversations/:id/messages` | æ·»åŠ  AI æ¬¡æ•¸æª¢æŸ¥ï¼Œè¶…é™è¿”å› 429 |

---

## ğŸ”§ éŒ¯èª¤è™•ç†

### AI_DAILY_LIMIT_REACHED

**è§¸ç™¼æ¢ä»¶**ï¼šç”¨æˆ¶é”åˆ°æ¯æ—¥ AI è§£è®€æ¬¡æ•¸ä¸Šé™

**è¿”å›æ ¼å¼**ï¼š
```json
{
  "success": false,
  "error": {
    "code": "AI_DAILY_LIMIT_REACHED",
    "message": "ä»Šæ—¥è§£è®€æ¬¡æ•¸å·²ç”¨å®Œ",
    "details": {
      "limit": 5,
      "used": 5,
      "remaining": 0
    }
  }
}
```

**HTTP ç‹€æ…‹ç¢¼**ï¼š429 (Too Many Requests)

---

## ğŸ“ å¾…å‰ç«¯å¯¦æ–½

### P0ï¼ˆå¿…åšï¼‰

1. **çµ±ä¸€è™•ç† `AI_DAILY_LIMIT_REACHED` éŒ¯èª¤**
   - æ•ç² 429 + `AI_DAILY_LIMIT_REACHED` éŒ¯èª¤ç¢¼
   - é¡¯ç¤ºå½ˆçª—æç¤º
   - å¼•å°è·³è½‰è¨‚é–±é 

2. **é‡æ§‹è¨‚é–±é é¢**
   - é¡¯ç¤ºä»Šæ—¥è§£è®€æ¬¡æ•¸ï¼ˆèª¿ç”¨ `/api/v1/pro/status`ï¼‰
   - é¡¯ç¤ºä¸‰å€‹æ–¹æ¡ˆï¼ˆ39/99/348ï¼‰
   - é¡¯ç¤ºæ¬Šç›Šå°æ¯”è¡¨ï¼ˆ3 è¡Œç²¾ç°¡ç‰ˆï¼‰
   - é¡¯ç¤º CTA æ–‡æ¡ˆ
   - èª¿ç”¨å‡æ”¯ä»˜ APIï¼ˆ`/api/v1/pro/fake-subscribe`ï¼‰

---

## ğŸ§ª æ¸¬è©¦è¦é»

### 1. AI æ¬¡æ•¸é™åˆ¶æ¸¬è©¦

**æ¸¬è©¦å ´æ™¯**ï¼š
- [ ] éæœƒå“¡é¦–æ—¥ï¼šå¯ç”¨ 10 æ¬¡
- [ ] éæœƒå“¡æ¬¡æ—¥ï¼šå¯ç”¨ 5 æ¬¡
- [ ] æœƒå“¡ï¼šå¯ç”¨ 100 æ¬¡
- [ ] è·¨å¤©é‡ç½®ï¼šç¬¬äºŒå¤©è¨ˆæ•¸æ­¸é›¶
- [ ] é”åˆ°ä¸Šé™ï¼šè¿”å› 429 éŒ¯èª¤

**æ¸¬è©¦æ–¹å¼**ï¼š
```bash
# 1. å‰µå»ºæ¸¬è©¦ç”¨æˆ¶
# 2. é€£çºŒèª¿ç”¨èŠå¤© API
# 3. æª¢æŸ¥è¿”å›çš„éŒ¯èª¤ç¢¼å’Œç‹€æ…‹
```

### 2. æœƒå“¡ç‹€æ…‹ API æ¸¬è©¦

```bash
curl -X GET http://localhost:3000/api/v1/pro/status \
  -H "Authorization: Bearer YOUR_TOKEN"
```

**é æœŸè¿”å›**ï¼šåŒ…å« `aiCallsToday`ã€`aiDailyLimit`ã€`aiRemaining`

### 3. å‡æ”¯ä»˜ API æ¸¬è©¦

```bash
curl -X POST http://localhost:3000/api/v1/pro/fake-subscribe \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"plan": "quarterly"}'
```

**é æœŸçµæœ**ï¼š
- ç”¨æˆ¶è®Šç‚º Pro
- `pro_plan` ç‚º `quarterly`
- `pro_expires_at` ç‚º 3 å€‹æœˆå¾Œ

---

## ğŸ“Œ æ³¨æ„äº‹é …

### 1. Migration åŸ·è¡Œ

- åŸ·è¡Œ Migration å‰è«‹å‚™ä»½è³‡æ–™åº«
- ç¢ºèª `users` è¡¨å’Œ `subscriptions` è¡¨éƒ½å·²æ›´æ–°

### 2. æ¬„ä½å‘½å

- è³‡æ–™åº«å±¤ï¼š`ai_calls_today`ã€`ai_calls_date`ï¼ˆsnake_caseï¼‰
- TypeScript é¡å‹ï¼šéœ€è¦åœ¨ `UserRow` ä¸­æ·»åŠ é€™å…©å€‹æ¬„ä½
- API éŸ¿æ‡‰ï¼š`aiCallsToday`ã€`aiCallsDate`ï¼ˆcamelCaseï¼‰

### 3. æ™‚å€è™•ç†

- ç•¶å‰ä½¿ç”¨å¾Œç«¯ç³»çµ±æ™‚å€
- ä½¿ç”¨ `dayjs().format('YYYY-MM-DD')` åˆ¤æ–·æ—¥æœŸ
- æœªä¾†å¦‚éœ€ç‰¹å®šæ™‚å€ï¼Œå¯ä½¿ç”¨ `dayjs.tz`

### 4. èˆ‡ç¾æœ‰ rateLimit çš„é—œä¿‚

- ç¾æœ‰ `rateLimit` ä¸­é–“ä»¶**ä¿ç•™ä¸è®Š**
- æ–°çš„ AI æ¬¡æ•¸é™åˆ¶æ˜¯**é¡å¤–é‚è¼¯**
- å…©å€‹é™åˆ¶å¯ä»¥åŒæ™‚ç”Ÿæ•ˆï¼ˆå–æ›´åš´æ ¼çš„é™åˆ¶ï¼‰

---

## ğŸ¯ ä¸‹ä¸€æ­¥

1. **åŸ·è¡Œ Migration**
   ```bash
   mysql -u root -p xiaopei_db < core/src/database/migrations/011_add_ai_quota_fields.sql
   ```

2. **é‡å•Ÿå¾Œç«¯æœå‹™**
   ```bash
   cd core
   npm run dev
   ```

3. **æ¸¬è©¦ API**
   - æ¸¬è©¦ `/api/v1/pro/status` æ˜¯å¦è¿”å› AI æ¬¡æ•¸
   - æ¸¬è©¦ `/api/v1/pro/fake-subscribe` æ˜¯å¦å¯ä»¥é–‹é€šæœƒå“¡
   - æ¸¬è©¦èŠå¤© API æ˜¯å¦æœƒæª¢æŸ¥æ¬¡æ•¸é™åˆ¶

4. **å‰ç«¯å¯¦æ–½**
   - çµ±ä¸€éŒ¯èª¤è™•ç†
   - é‡æ§‹è¨‚é–±é é¢

---

**æ–‡æª”çµæŸ**


