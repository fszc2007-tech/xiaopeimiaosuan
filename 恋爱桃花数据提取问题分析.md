# æ‹çˆ±æ¡ƒèŠ±æ•°æ®æå–é—®é¢˜åˆ†æ

## é—®é¢˜æè¿°

ä»ç”¨æˆ·æä¾›çš„æˆªå›¾å¯ä»¥çœ‹åˆ°ï¼Œç³»ç»Ÿå›å¤ä¸­å‡ºç°äº†ï¼š
- "æ— æ³•å®Œæ•´è¯»å–ä½ çš„å…·ä½“å…«å­—ä¿¡æ¯ï¼ˆæ¯”å¦‚æ—¥ä¸»äº”è¡Œã€æ ¼å±€å¼ºå¼±ã€å–œç”¨ç¥ç­‰ï¼‰"
- "çœ‹ä¸åˆ°ä½ çš„æ—¥ä¸»å’Œåç¥æƒé‡"
- "ç”±äºå¤§è¿å’Œæµå¹´ä¿¡æ¯ä¸å…¨"

ä½†å®é™…ä¸Šï¼Œæ•°æ®åº“ä¸­çš„ `result_json` å·²ç»åŒ…å«äº†å®Œæ•´çš„å…«å­—ä¿¡æ¯ã€‚è¿™è¯´æ˜ `buildLoveChatContext` å‡½æ•°ä¸­çš„æ•°æ®æå–é€»è¾‘å­˜åœ¨é—®é¢˜ã€‚

---

## æ•°æ®ç»“æ„è·¯å¾„åˆ†æ

### 1. åç«¯æ¥æ”¶çš„æ•°æ®ç»“æ„

ä» `core/src/routes/conversation.ts` ä¸­å¯ä»¥çœ‹åˆ°ï¼š

```typescript
const chartResult = JSON.parse(chartDataRows[0].result_json);
```

è¿™æ„å‘³ç€ `chartResult` å°±æ˜¯å¼•æ“è¿”å›çš„åŸå§‹ JSON å¯¹è±¡ï¼Œç»“æ„åº”è¯¥æ˜¯ï¼š

```typescript
{
  pillars: {
    year: { stem, branch, shishen, shensha, zizuo, ... },
    month: { stem, branch, shishen, shensha, zizuo, ... },
    day: { stem, branch, shishen, shensha, zizuo, ... },
    hour: { stem, branch, shishen, shensha, zizuo, ... },
  },
  analysis: {
    dayMaster: { gan, zhi, wuxing, strength, strengthLabel, description },
    wuxingPercent: { æœ¨, ç«, åœŸ, é‡‘, æ°´ },
    strengthAnalysis: { score, label, factors },
    structure: {
      name,
      confidence,
      tenGodWeights: { guan, zGuan, sha, yin, zYin, pYin, cai, shi, shishen, shang, bi },
      ...
    },
    yongshenPattern: { mainYongshen, tabooElements, ... },
    luckRhythm: {
      currentLuck: { label, ageRange, tenGod, element, favourLevel, stage, tone, ... },
      annualBrief: [{ year, ganzhi, shishen, favourLevel, ... }],
      ...
    },
    ...
  },
  derived: {
    luck_cycle: [{ stem, branch, ganzhi, startAge, endAge, ageRange, ... }],
    flow_years: [{ year, stem, branch, ganzhi, shishen, ... }],
    ...
  },
  shensha: {
    hits_by_pillar: { "å¹´æŸ±": [...], "æœˆæŸ±": [...], "æ—¥æŸ±": [...], "æ—¶æŸ±": [...] }
  },
  meta: { gender, ... }
}
```

---

## å‘ç°çš„é—®é¢˜

### é—®é¢˜ 1ï¼šå››æŸ±å­—æ®µåä¸åŒ¹é… âŒ

**ä½ç½®**ï¼š`core/src/modules/love/loveContextBuilder.ts` ç¬¬ 98 è¡Œ

**å½“å‰ä»£ç **ï¼š
```typescript
ganzhi: `${pillar.gan || ''}${pillar.zhi || ''}`,
```

**é—®é¢˜**ï¼šå¼•æ“è¿”å›çš„å­—æ®µåæ˜¯ `stem` å’Œ `branch`ï¼Œä¸æ˜¯ `gan` å’Œ `zhi`

**åº”è¯¥æ”¹ä¸º**ï¼š
```typescript
ganzhi: `${pillar.stem || ''}${pillar.branch || ''}`,
```

**å½±å“**ï¼šå¯¼è‡´å››æŸ±å¹²æ”¯æ˜¾ç¤ºä¸ºç©ºç™½ï¼ŒLLM æ— æ³•çœ‹åˆ°å…·ä½“çš„å››æŸ±ä¿¡æ¯

---

### é—®é¢˜ 2ï¼šæ—¥ä¸»å¤©å¹²æå–è·¯å¾„é”™è¯¯ âŒ

**ä½ç½®**ï¼š`core/src/modules/love/loveContextBuilder.ts` ç¬¬ 111 è¡Œ

**å½“å‰ä»£ç **ï¼š
```typescript
const dayMasterGan = chartResult.analysis?.dayMaster?.gan || '';
```

**é—®é¢˜**ï¼šè¿™ä¸ªè·¯å¾„æ˜¯å¯¹çš„ï¼Œä½†éœ€è¦ç¡®è®¤ `dayMaster.gan` æ˜¯å¦å­˜åœ¨

**æ£€æŸ¥**ï¼šä»å¼•æ“ä»£ç çœ‹ï¼Œ`dayMaster.gan` åº”è¯¥æ˜¯å­˜åœ¨çš„ï¼Œä½†éœ€è¦ç¡®è®¤å®é™…æ•°æ®ç»“æ„

---

### é—®é¢˜ 3ï¼šåç¥æƒé‡å­—æ®µè·¯å¾„å¯èƒ½ä¸å®Œæ•´ âš ï¸

**ä½ç½®**ï¼š`core/src/modules/love/loveContextBuilder.ts` ç¬¬ 60-64 è¡Œ

**å½“å‰ä»£ç **ï¼š
```typescript
weights: {
  guan: analysis.structure?.tenGodWeights?.guan || analysis.structure?.tenGodWeights?.zGuan || 0,
  cai: analysis.structure?.tenGodWeights?.cai || 0,
  shishang: (analysis.structure?.tenGodWeights?.shi || 0) + (analysis.structure?.tenGodWeights?.shang || 0),
  bijie: analysis.structure?.tenGodWeights?.bi || 0,
  yin: (analysis.structure?.tenGodWeights?.yin || 0) + (analysis.structure?.tenGodWeights?.zYin || 0) + (analysis.structure?.tenGodWeights?.pYin || 0),
},
```

**é—®é¢˜**ï¼š
- å¼•æ“è¿”å›çš„ `tenGodWeights` ä¸­ï¼Œ`guan` æ˜¯æ­£å®˜+ä¸ƒæ€çš„æ€»å’Œï¼Œ`zGuan` æ˜¯æ­£å®˜ï¼Œ`sha` æ˜¯ä¸ƒæ€
- å½“å‰é€»è¾‘ï¼š`guan` ä¼˜å…ˆå– `guan`ï¼Œå¦‚æœæ²¡æœ‰åˆ™å– `zGuan`ï¼Œä½†è¿™æ ·ä¼šä¸¢å¤±ä¸ƒæ€ä¿¡æ¯
- åº”è¯¥æ”¹ä¸ºï¼š`guan = zGuan + sha`ï¼ˆå¦‚æœ `guan` ä¸å­˜åœ¨ï¼‰

**å½±å“**ï¼šåç¥æƒé‡å¯èƒ½ä¸å‡†ç¡®

---

### é—®é¢˜ 4ï¼šæµå¹´ä¿¡æ¯å®Œå…¨ç®€åŒ–ç”Ÿæˆï¼Œæ²¡æœ‰ä»å®é™…æ•°æ®æå– âŒ

**ä½ç½®**ï¼š`core/src/modules/love/loveContextBuilder.ts` ç¬¬ 209-224 è¡Œ

**å½“å‰ä»£ç **ï¼š
```typescript
// æå–æµå¹´ä¿¡æ¯ï¼ˆç®€åŒ–ç‰ˆï¼Œå®é™…éœ€è¦ä» annualBrief æˆ–å…¶ä»–æ•°æ®æºè·å–ï¼‰
const years: LoveChatContext['fortune']['years'] = [];
const currentYear = new Date().getFullYear();

// ç”Ÿæˆæœ€è¿‘3å¹´çš„æµå¹´ä¿¡æ¯ï¼ˆç®€åŒ–ç‰ˆï¼‰
for (let i = -1; i <= 1; i++) {
  const year = currentYear + i;
  years.push({
    year,
    ganzhi: `${year}å¹´`, // ç®€åŒ–ï¼Œå®é™…éœ€è¦è®¡ç®—æµå¹´å¹²æ”¯
    tenGodToDay: 'æœªçŸ¥',
    favLevel: 0,
    branchRelationsToSpousePalace: [],
    loveShenSha: [],
  });
}
```

**é—®é¢˜**ï¼š
- å®Œå…¨æ²¡æœ‰ä»å®é™…æ•°æ®ä¸­æå–æµå¹´ä¿¡æ¯
- åº”è¯¥ä» `analysis.luckRhythm.annualBrief` ä¸­æå–
- æˆ–è€…ä» `derived.flow_years` ä¸­æå–

**åº”è¯¥æ”¹ä¸º**ï¼š
```typescript
// ä¼˜å…ˆä» annualBrief ä¸­æå–
const annualBrief = analysis.luckRhythm?.annualBrief || [];
const years = annualBrief.slice(0, 3).map(item => ({
  year: item.year,
  ganzhi: item.ganzhi,
  tenGodToDay: item.shishen || 'æœªçŸ¥',
  favLevel: mapFavourLevelToNumber(item.favourLevel), // 'good' -> 2, 'bad' -> -2, etc.
  branchRelationsToSpousePalace: [], // éœ€è¦è®¡ç®—
  loveShenSha: [], // éœ€è¦ä»ç¥ç…æ•°æ®ä¸­æå–
}));
```

**å½±å“**ï¼šLLM æ— æ³•çœ‹åˆ°çœŸå®çš„æµå¹´ä¿¡æ¯ï¼Œå¯¼è‡´å›å¤ä¸­è¯´"å¤§è¿å’Œæµå¹´ä¿¡æ¯ä¸å…¨"

---

### é—®é¢˜ 5ï¼šå¤§è¿ä¿¡æ¯æå–ä¸å®Œæ•´ âš ï¸

**ä½ç½®**ï¼š`core/src/modules/love/loveContextBuilder.ts` ç¬¬ 199-235 è¡Œ

**å½“å‰ä»£ç **ï¼š
```typescript
const currentLuckItem = luckCycle.find((luck: any) => luck.isCurrent) || luckCycle[0] || {};

return {
  currentLuck: {
    ganzhi: currentLuckItem.ganzhi || currentLuck.label || 'æœªçŸ¥',
    ageRange: currentLuck.ageRange || currentLuckItem.ageRange || '',
    favourLevel: currentLuck.favourLevel ?? 0,
    loveShenSha: currentLuck.loveShenSha || [],
    rhythmDescription: currentLuck.tone || currentLuck.rhythmDescription || '',
  },
  years,
};
```

**é—®é¢˜**ï¼š
- `currentLuck.favourLevel` å¯èƒ½æ˜¯å­—ç¬¦ä¸²ï¼ˆ'good' | 'bad' | 'neutral'ï¼‰ï¼Œéœ€è¦è½¬æ¢ä¸ºæ•°å­—ï¼ˆ-2 ~ +2ï¼‰
- `loveShenSha` éœ€è¦ä»å¤§è¿çš„ç¥ç…æ•°æ®ä¸­æå–ï¼Œè€Œä¸æ˜¯ç›´æ¥ä½¿ç”¨ï¼ˆå¯èƒ½ä¸å­˜åœ¨ï¼‰
- `rhythmDescription` å¯èƒ½éœ€è¦ç»„åˆå¤šä¸ªå­—æ®µ

**å½±å“**ï¼šå¤§è¿ä¿¡æ¯ä¸å®Œæ•´æˆ–ä¸å‡†ç¡®

---

### é—®é¢˜ 6ï¼šé…å¶æ˜Ÿä¿¡æ¯å®Œå…¨ä½¿ç”¨å ä½ç¬¦ âŒ

**ä½ç½®**ï¼š`core/src/modules/love/loveContextBuilder.ts` ç¬¬ 150-176 è¡Œ

**å½“å‰ä»£ç **ï¼š
```typescript
const spouseStarDistribution = 'é…å¶æ˜Ÿåˆ†å¸ƒéœ€è¦æ ¹æ®åç¥åˆ†æç¡®å®š';

return {
  spouseStarType,
  spouseStarDistribution,
  spouseStarStatus: {
    strength: 'ä¸­ç­‰',
    mixed: false,
    conflict: false,
    description: 'é…å¶æ˜ŸçŠ¶æ€éœ€è¦æ ¹æ®å…·ä½“å‘½ç›˜åˆ†æ',
  },
  shiShangStatus: {
    strength: 'ä¸­ç­‰',
    description: 'é£Ÿä¼¤çŠ¶æ€éœ€è¦æ ¹æ®å…·ä½“å‘½ç›˜åˆ†æ',
  },
  expressionHints: ['æ„Ÿæƒ…è¡¨è¾¾æ–¹å¼éœ€è¦æ ¹æ®å‘½ç›˜ç‰¹ç‚¹åˆ†æ'],
};
```

**é—®é¢˜**ï¼š
- æ‰€æœ‰å­—æ®µéƒ½æ˜¯å ä½ç¬¦ï¼Œæ²¡æœ‰ä»å®é™…æ•°æ®ä¸­æå–
- éœ€è¦æ ¹æ®åç¥åˆ†å¸ƒã€é…å¶æ˜Ÿä½ç½®ç­‰è®¡ç®—

**å½±å“**ï¼šLLM æ— æ³•çœ‹åˆ°çœŸå®çš„é…å¶æ˜Ÿä¿¡æ¯

---

### é—®é¢˜ 7ï¼šå®«ä½å…³ç³»ä¿¡æ¯æå–ä¸å®Œæ•´ âš ï¸

**ä½ç½®**ï¼š`core/src/modules/love/loveContextBuilder.ts` ç¬¬ 124-145 è¡Œ

**å½“å‰ä»£ç **ï¼š
```typescript
const structure = analysis.structure || {};
const clashInfo = structure.clashInfo || {};

return {
  spouseBranch: dayZhi,
  relations: {
    he: clashInfo.he || [],
    sanhe: clashInfo.sanhe || [],
    chong: clashInfo.chong || [],
    xing: clashInfo.xing || [],
    hai: clashInfo.hai || [],
  },
  loveEnvironmentNotes: 'æ‹çˆ±ç¯å¢ƒåˆ†æéœ€è¦ç»“åˆæœˆæ”¯ã€æ—¶æ”¯å’Œé…å¶å®«å…³ç³»æ¥åˆ¤æ–­',
};
```

**é—®é¢˜**ï¼š
- `clashInfo` å¯èƒ½ä¸åœ¨ `structure` ä¸­ï¼Œéœ€è¦ä»å…¶ä»–åœ°æ–¹è·å–
- éœ€è¦å®é™…è®¡ç®—æ—¥æ”¯ä¸å…¶ä»–åœ°æ”¯çš„å…³ç³»

**å½±å“**ï¼šå®«ä½å…³ç³»ä¿¡æ¯å¯èƒ½ä¸ºç©º

---

### é—®é¢˜ 8ï¼šæ¸…æµŠè°ƒå€™ä¿¡æ¯æå–ä¸å®Œæ•´ âš ï¸

**ä½ç½®**ï¼š`core/src/modules/love/loveContextBuilder.ts` ç¬¬ 181-194 è¡Œ

**å½“å‰ä»£ç **ï¼š
```typescript
const purity = analysis.purity || analysis.patternPurity || {};
const tiaohou = analysis.tiaohou || {};
const tiyong = analysis.tiyong || {};

return {
  purityLevel: purity.level || 'æœªçŸ¥',
  tiaoHouSummary: tiaohou.summary || tiaohou.label || '',
  tiYongSummary: tiyong.interpretation || yongshenPattern.tiYongSummary || '',
  riskHints: ['é£é™©æç¤ºéœ€è¦æ ¹æ®å…·ä½“å‘½ç›˜åˆ†æ'],
};
```

**é—®é¢˜**ï¼š
- `riskHints` å®Œå…¨æ˜¯å ä½ç¬¦
- éœ€è¦ä»å®é™…åˆ†æç»“æœä¸­æå–é£é™©æç¤º

**å½±å“**ï¼šé£é™©æç¤ºä¿¡æ¯ç¼ºå¤±

---

### é—®é¢˜ 9ï¼šè¾…åŠ©åˆ†æä¿¡æ¯å¯èƒ½ä¸ºç©º âš ï¸

**ä½ç½®**ï¼š`core/src/modules/love/loveContextBuilder.ts` ç¬¬ 241-249 è¡Œ

**å½“å‰ä»£ç **ï¼š
```typescript
return {
  energyFlowSummary: analysis.energyFlow?.summary || '',
  guancaiSummary: analysis.guancaiPattern?.summary || '',
  minggeSummary: analysis.minggeSummary?.summary || '',
};
```

**é—®é¢˜**ï¼š
- è¿™äº›å­—æ®µå¯èƒ½ä¸å­˜åœ¨æˆ–ä¸ºç©ºå­—ç¬¦ä¸²
- éœ€è¦ç¡®è®¤å®é™…æ•°æ®ç»“æ„ä¸­è¿™äº›å­—æ®µçš„è·¯å¾„

**å½±å“**ï¼šè¾…åŠ©åˆ†æä¿¡æ¯å¯èƒ½ä¸ºç©º

---

### é—®é¢˜ 10ï¼šæ€§åˆ«ä¿¡æ¯æå–è·¯å¾„å¯èƒ½ä¸å¯¹ âš ï¸

**ä½ç½®**ï¼š`core/src/modules/love/loveContextBuilder.ts` ç¬¬ 23-34 è¡Œ

**å½“å‰ä»£ç **ï¼š
```typescript
if (chartResult.profile?.gender) {
  return chartResult.profile.gender === 'male' ? 'male' : ...
}
if (chartResult.meta?.gender) {
  return chartResult.meta.gender === 'male' ? 'male' : ...
}
```

**é—®é¢˜**ï¼š
- ä» `conversation.ts` ä¸­çœ‹åˆ°ï¼Œ`chartResult` æ˜¯ç›´æ¥è§£æ `result_json` çš„ç»“æœ
- `result_json` ä¸­å¯èƒ½æ²¡æœ‰ `profile` å­—æ®µï¼ˆprofile ä¿¡æ¯åœ¨ `chart_profiles` è¡¨ä¸­ï¼‰
- `meta.gender` å¯èƒ½ä¹Ÿä¸å­˜åœ¨
- éœ€è¦ä»å…¶ä»–åœ°æ–¹è·å–æ€§åˆ«ä¿¡æ¯ï¼Œæˆ–è€…ä» `chart_profiles` è¡¨ä¸­æŸ¥è¯¢

**å½±å“**ï¼šæ€§åˆ«ä¿¡æ¯å¯èƒ½æ— æ³•æ­£ç¡®æå–

---

## æ•°æ®è·¯å¾„å¯¹ç…§è¡¨

| éœ€è¦æå–çš„å­—æ®µ | å½“å‰æå–è·¯å¾„ | å®é™…æ•°æ®è·¯å¾„ | çŠ¶æ€ |
|--------------|------------|------------|------|
| æ—¥ä¸»åŠäº”è¡Œ | `analysis.dayMaster.gan + wuxing` | âœ… `analysis.dayMaster.gan + wuxing` | âœ… æ­£ç¡® |
| æ—¥ä¸»å¼ºå¼± | `analysis.strengthAnalysis` | âœ… `analysis.strengthAnalysis` | âœ… æ­£ç¡® |
| æ ¼å±€åç§° | `analysis.structure.name` | âœ… `analysis.structure.name` | âœ… æ­£ç¡® |
| åç¥æƒé‡ | `analysis.structure.tenGodWeights` | âœ… `analysis.structure.tenGodWeights` | âš ï¸ é€»è¾‘éœ€ä¼˜åŒ– |
| ç”¨ç¥äº”è¡Œ | `analysis.yongshenPattern.mainYongshen.elements` | âœ… è·¯å¾„æ­£ç¡® | âœ… æ­£ç¡® |
| äº”è¡Œåˆ†å¸ƒ | `analysis.wuxingPercent` | âœ… `analysis.wuxingPercent` | âœ… æ­£ç¡® |
| å››æŸ±å¹²æ”¯ | `pillar.gan + pillar.zhi` | âŒ åº”è¯¥æ˜¯ `pillar.stem + pillar.branch` | âŒ **é”™è¯¯** |
| å››æŸ±åç¥ | `pillar.shishen` | âœ… `pillar.shishen` | âœ… æ­£ç¡® |
| å››æŸ±ç¥ç… | `pillar.shensha` | âœ… `pillar.shensha` | âœ… æ­£ç¡® |
| åäºŒé•¿ç”Ÿ | `pillar.zizuo` | âœ… `pillar.zizuo` | âœ… æ­£ç¡® |
| å½“å‰å¤§è¿ | `derived.luck_cycle` æˆ– `analysis.luckRhythm.currentLuck` | âœ… è·¯å¾„æ­£ç¡® | âš ï¸ éœ€è¦å®Œå–„ |
| æµå¹´ä¿¡æ¯ | âŒ ç®€åŒ–ç”Ÿæˆ | âœ… `analysis.luckRhythm.annualBrief` | âŒ **é”™è¯¯** |
| æ€§åˆ«ä¿¡æ¯ | `chartResult.profile.gender` æˆ– `chartResult.meta.gender` | âŒ å¯èƒ½ä¸å­˜åœ¨ | âŒ **é”™è¯¯** |

---

## å…³é”®é—®é¢˜æ€»ç»“

### ğŸ”´ ä¸¥é‡é—®é¢˜ï¼ˆå¯¼è‡´æ•°æ®å®Œå…¨ç¼ºå¤±ï¼‰

1. **å››æŸ±å¹²æ”¯å­—æ®µåé”™è¯¯**ï¼š`gan/zhi` â†’ `stem/branch`
2. **æµå¹´ä¿¡æ¯å®Œå…¨ç®€åŒ–ç”Ÿæˆ**ï¼šæ²¡æœ‰ä» `annualBrief` ä¸­æå–
3. **æ€§åˆ«ä¿¡æ¯æå–è·¯å¾„é”™è¯¯**ï¼š`chartResult` ä¸­å¯èƒ½æ²¡æœ‰ `profile` å­—æ®µ

### ğŸŸ¡ ä¸­ç­‰é—®é¢˜ï¼ˆå¯¼è‡´æ•°æ®ä¸å®Œæ•´ï¼‰

4. **åç¥æƒé‡é€»è¾‘ä¸å®Œæ•´**ï¼šéœ€è¦åˆå¹¶ `zGuan + sha` ç­‰
5. **å¤§è¿ä¿¡æ¯æå–ä¸å®Œæ•´**ï¼š`favourLevel` ç±»å‹è½¬æ¢ã€`loveShenSha` æå–
6. **é…å¶æ˜Ÿä¿¡æ¯å®Œå…¨å ä½ç¬¦**ï¼šéœ€è¦å®é™…è®¡ç®—
7. **å®«ä½å…³ç³»ä¿¡æ¯å¯èƒ½ä¸ºç©º**ï¼š`clashInfo` è·¯å¾„å¯èƒ½ä¸å¯¹

### ğŸŸ¢ è½»å¾®é—®é¢˜ï¼ˆå½±å“è¾ƒå°ï¼‰

8. **æ¸…æµŠè°ƒå€™é£é™©æç¤ºå ä½ç¬¦**ï¼šéœ€è¦ä»å®é™…æ•°æ®æå–
9. **è¾…åŠ©åˆ†æä¿¡æ¯å¯èƒ½ä¸ºç©º**ï¼šéœ€è¦ç¡®è®¤å­—æ®µè·¯å¾„

---

## ä¿®å¤ä¼˜å…ˆçº§

### P0ï¼ˆå¿…é¡»ç«‹å³ä¿®å¤ï¼‰
1. å››æŸ±å­—æ®µåï¼š`gan/zhi` â†’ `stem/branch`
2. æµå¹´ä¿¡æ¯ï¼šä» `annualBrief` ä¸­æå–
3. æ€§åˆ«ä¿¡æ¯ï¼šä»æ•°æ®åº“æŸ¥è¯¢æˆ–ä»å…¶ä»–åœ°æ–¹è·å–

### P1ï¼ˆé‡è¦ï¼Œå½±å“æ•°æ®å®Œæ•´æ€§ï¼‰
4. åç¥æƒé‡é€»è¾‘ä¼˜åŒ–
5. å¤§è¿ä¿¡æ¯å®Œå–„ï¼ˆç±»å‹è½¬æ¢ã€ç¥ç…æå–ï¼‰
6. é…å¶æ˜Ÿä¿¡æ¯å®é™…è®¡ç®—

### P2ï¼ˆä¼˜åŒ–ï¼Œæå‡æ•°æ®è´¨é‡ï¼‰
7. å®«ä½å…³ç³»ä¿¡æ¯å®Œå–„
8. æ¸…æµŠè°ƒå€™é£é™©æç¤ºæå–
9. è¾…åŠ©åˆ†æä¿¡æ¯è·¯å¾„ç¡®è®¤

---

## å»ºè®®çš„ä¿®å¤æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1ï¼šä¿®å¤å­—æ®µåå’Œè·¯å¾„ï¼ˆP0ï¼‰

```typescript
// ä¿®å¤å››æŸ±å­—æ®µå
function extractPillarLoveInfo(pillar: any, dayMasterGan: string): PillarLoveInfo {
  return {
    ganzhi: `${pillar.stem || ''}${pillar.branch || ''}`, // âœ… ä¿®å¤
    tenGodToDay: pillar.shishen || 'æœªçŸ¥',
    mainTenGod: pillar.shishen || 'æœªçŸ¥',
    shenshaLoveRelated: extractLoveShenSha(pillar.shensha || []),
    changsheng: pillar.zizuo || pillar.self_sit || 'æœªçŸ¥',
  };
}
```

### æ–¹æ¡ˆ 2ï¼šä»å®é™…æ•°æ®æå–æµå¹´ä¿¡æ¯ï¼ˆP0ï¼‰

```typescript
function extractFortuneInfo(chartResult: any): LoveChatContext['fortune'] {
  const analysis = chartResult.analysis || {};
  const luckRhythm = analysis.luckRhythm || {};
  const currentLuck = luckRhythm.currentLuck || {};
  const annualBrief = luckRhythm.annualBrief || [];
  
  // âœ… ä» annualBrief ä¸­æå–æµå¹´ä¿¡æ¯
  const years = annualBrief.slice(0, 3).map(item => ({
    year: item.year,
    ganzhi: item.ganzhi,
    tenGodToDay: item.shishen || 'æœªçŸ¥',
    favLevel: mapFavourLevel(item.favourLevel), // 'good' -> 2, 'bad' -> -2, 'neutral' -> 0
    branchRelationsToSpousePalace: calculateBranchRelations(item, chartResult),
    loveShenSha: extractYearLoveShenSha(item, chartResult),
  }));
  
  // âœ… ä» currentLuck ä¸­æå–å¤§è¿ä¿¡æ¯
  const derived = chartResult.derived || {};
  const luckCycle = derived.luck_cycle || [];
  const currentLuckItem = luckCycle.find((luck: any) => luck.isCurrent) || {};
  
  return {
    currentLuck: {
      ganzhi: currentLuckItem.ganzhi || currentLuck.label || `${currentLuck.stem || ''}${currentLuck.branch || ''}`,
      ageRange: currentLuck.ageRange || currentLuckItem.ageRange || '',
      favourLevel: mapFavourLevel(currentLuck.favourLevel) ?? 0,
      loveShenSha: extractLuckLoveShenSha(currentLuckItem, chartResult),
      rhythmDescription: currentLuck.tone || currentLuck.rhythmDescription || '',
    },
    years,
  };
}
```

### æ–¹æ¡ˆ 3ï¼šä¿®å¤æ€§åˆ«ä¿¡æ¯æå–ï¼ˆP0ï¼‰

éœ€è¦åœ¨ `conversation.ts` ä¸­ï¼Œæ„å»º `LoveChatContext` æ—¶ï¼ŒåŒæ—¶æŸ¥è¯¢ `chart_profiles` è¡¨è·å–æ€§åˆ«ä¿¡æ¯ï¼Œæˆ–è€…ä» `chartResult` çš„å…¶ä»–å­—æ®µä¸­è·å–ã€‚

---

## éªŒè¯æ–¹æ³•

ä¿®å¤åï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼éªŒè¯ï¼š

1. **æ‰“å° `chartResult` ç»“æ„**ï¼šåœ¨ `buildLoveChatContext` å‡½æ•°å¼€å¤´æ·»åŠ  `console.log(JSON.stringify(chartResult, null, 2))`
2. **æ‰“å°æå–ç»“æœ**ï¼šåœ¨å‡½æ•°è¿”å›å‰æ‰“å° `LoveChatContext`ï¼Œæ£€æŸ¥å„å­—æ®µæ˜¯å¦æœ‰çœŸå®æ•°æ®
3. **æµ‹è¯•å®é™…å‘½ç›˜**ï¼šä½¿ç”¨æµ‹è¯•å‘½ç›˜ï¼ˆ1990-01-01 ç”·ï¼‰éªŒè¯æ‰€æœ‰å­—æ®µæ˜¯å¦æ­£ç¡®æå–

---

## æ€»ç»“

ä¸»è¦é—®é¢˜æ˜¯ï¼š
1. **å­—æ®µåä¸åŒ¹é…**ï¼ˆå››æŸ±ï¼š`gan/zhi` vs `stem/branch`ï¼‰
2. **æ•°æ®è·¯å¾„é”™è¯¯**ï¼ˆæ€§åˆ«ã€æµå¹´ï¼‰
3. **æå–é€»è¾‘ç®€åŒ–**ï¼ˆæµå¹´ã€é…å¶æ˜Ÿã€å®«ä½å…³ç³»ç­‰ä½¿ç”¨å ä½ç¬¦ï¼‰

ä¿®å¤è¿™äº›é—®é¢˜åï¼ŒLLM åº”è¯¥èƒ½å¤Ÿçœ‹åˆ°å®Œæ•´çš„å‘½ç›˜ä¿¡æ¯ï¼Œä¸ä¼šå†å‡ºç°"æ— æ³•è¯»å–å…«å­—ä¿¡æ¯"çš„æç¤ºã€‚

