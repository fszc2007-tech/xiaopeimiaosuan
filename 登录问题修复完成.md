# 登录问题修复完成报告

## 问题原因

1. **IP 地址配置错误**：前端配置的 API 地址是 `localhost:3000`，iOS 模拟器无法访问宿主机的 localhost
2. **验证码逻辑依赖环境变量**：之前依赖 `__DEV__` 或 `NODE_ENV` 判断，导致不稳定

## 修复内容

### 1. Core 后端修改

#### `core/src/modules/auth/authService.ts`
- ✅ 固定验证码为 `123456`（不依赖环境变量）
- ✅ 移除开发/生产环境判断

```typescript
// ✅ 固定验证码：123456（因为未接入短信服务商）
if (code !== '123456') {
  throw new Error('验证码错误（默认验证码：123456）');
}
console.log('[Auth] 验证码校验通过（固定验证码：123456）');
```

#### `core/src/server.ts`
- ✅ 服务器监听所有网络接口 `0.0.0.0`
- ✅ 打印本地网络访问地址

```typescript
app.listen(PORT, '0.0.0.0', () => {
  console.log(`[Server] Core service is running on port ${PORT}`);
  console.log(`[Server] Local network: http://172.20.10.2:${PORT}/health`);
});
```

#### `core/src/services/chartProfileService.ts`
- ✅ 修复数据库字段名错误（`profile_id` → `chart_profile_id`）

### 2. 前端修改

#### `app/src/config/env.ts`
- ✅ 修改 API 地址为实际 IP：`http://172.20.10.2:3000`

```typescript
export const ENV = {
  API_BASE_URL: process.env.EXPO_PUBLIC_API_BASE_URL || 'http://172.20.10.2:3000',
  API_TIMEOUT: 30000,
  ENABLE_LOG: __DEV__,
};
```

#### `app/src/screens/Auth/AuthScreen.tsx`
- ✅ 点击"发送验证码"后自动填充 `123456`

```typescript
// ✅ 固定验证码为 123456（未接入短信服务商）
setOtp('123456'); // 自动填充固定验证码
```

#### 移除所有开发环境模拟逻辑
- ✅ `app/src/services/api/apiClient.ts` - 移除开发环境日志
- ✅ `app/src/services/api/authApi.ts` - 移除 `getMe()` 模拟数据
- ✅ `app/src/services/api/baziApi.ts` - 移除 `computeChart()` 和 `getCharts()` 模拟数据
- ✅ `app/src/services/api/chartService.ts` - 移除 `createChart()` 模拟数据

### 3. 退出登录修复

#### `app/src/store/authStore.ts`
- ✅ 退出登录时保持 `_hasHydrated = true`，避免卡在 Loading 页面

## 测试结果

### ✅ 后端 API 测试（通过命令行）

```bash
# 1. 健康检查
curl http://172.20.10.2:3000/health
# ✅ {"success":true,"data":{"status":"ok"}}

# 2. 登录测试
curl -X POST http://172.20.10.2:3000/api/v1/auth/login_or_register \
  -H "Content-Type: application/json" \
  -d '{"phone": "13120613771", "code": "123456", "channel": "cn"}'
# ✅ 返回 token 和用户信息

# 3. 错误验证码测试
curl -X POST http://172.20.10.2:3000/api/v1/auth/login_or_register \
  -H "Content-Type: application/json" \
  -d '{"phone": "13120613771", "code": "999999", "channel": "cn"}'
# ✅ 返回错误：验证码错误（默认验证码：123456）
```

### 测试脚本

创建了两个测试脚本：
1. `test-login.js` - 基础登录流程测试
2. `test-full-flow.js` - 完整业务流程测试（登录 → 创建命盘 → 查看详情 → 列表）

## 使用说明

### 服务器启动

```bash
# 启动 Core 后端（端口 3000）
cd /Users/gaoxuxu/Desktop/小佩APP/core
npm run dev

# 启动 Admin 管理后台（端口 5173）
cd /Users/gaoxuxu/Desktop/小佩APP/admin
npm run dev

# 启动 App 前端（Expo）
cd /Users/gaoxuxu/Desktop/小佩APP/app
npx expo start
```

### App 登录流程

1. **输入手机号**：任意手机号（如 13120613771）
2. **点击"发送验证码"**：验证码会自动填充为 `123456`
3. **点击"登入"**：系统会：
   - 调用 `http://172.20.10.2:3000/api/v1/auth/login_or_register`
   - 后端验证验证码 === '123456'
   - 查询或创建用户
   - 返回真实 JWT token
   - 前端保存用户信息并跳转到主页

### 重要说明

1. **固定验证码**：系统固定验证码为 `123456`，不需要真实短信服务
2. **IP 地址**：如果电脑 IP 地址改变，需要更新 `app/src/config/env.ts` 中的 IP
3. **网络要求**：确保电脑和手机/模拟器在同一网络
4. **不依赖开发环境**：所有 API 调用都是真实的，不区分开发/生产环境

## 当前状态

- ✅ Core 服务运行中：`http://172.20.10.2:3000`
- ✅ Admin 服务运行中：`http://localhost:5173`
- ✅ 登录接口正常
- ✅ 验证码固定为 123456
- ✅ Token 验证正常
- ✅ 数据库连接正常

## 下一步

现在请在 **iOS 模拟器中重新加载 App**（按 `Cmd + R`），然后：

1. 输入手机号：`13120613771`
2. 点击"发送验证码" - 验证码自动填充为 `123456`
3. 点击"登入" - 应该成功登录并进入主页

如果还有问题，请查看：
- Expo 控制台日志
- iOS 模拟器控制台
- Core 服务器日志

