# 测试命盘问题分析报告

## 测试命盘信息（标准测试用例）

**请记住：以后统一使用此测试命盘**
- **日期**: 2024年1月1日
- **时间**: 早上10点
- **性别**: 女
- **历法**: 公历

---

## 问题概述

### 错误信息
```
ReferenceError: tenGodOf is not defined
    at isGodRevealed (file:///Users/gaoxuxu/Desktop/xiaopei-app/core/engine/analysis/utils.js:329:21)
    at evaluateYongshenPower (file:///Users/gaoxuxu/Desktop/xiaopei-app/core/engine/analysis/purity.js:508:9)
```

### 问题位置
- **文件**: `core/engine/analysis/utils.js`
- **行号**: 329
- **函数**: `isGodRevealed`

---

## 根本原因分析

### 1. 代码结构问题

在 `utils.js` 文件中：

```javascript
// 第 19 行：导入 tenGod
import { tenGod } from '../mingli/shishen.js';

// 第 112 行：导出为 tenGodOf（别名）
export { tenGod as tenGodOf };

// 第 329 行：在 isGodRevealed 函数中使用 tenGodOf
const stemGod = tenGodOf(dayStem, pillar.stem);
```

**问题**：
- `tenGodOf` 是通过 `export` 导出的别名，不是通过 `import` 导入的
- 在**同一个文件内部**，`isGodRevealed` 函数不能直接使用 `tenGodOf`
- 应该直接使用 `tenGod`，或者先导入 `tenGodOf`

### 2. 类似问题检查

检查 `utils.js` 中其他使用 `tenGodOf` 的地方：

- **第 282 行** (`getShishenPositions`): `const stemGod = tenGodOf(dayStem, pillar.stem);`
- **第 297 行** (`getShishenPositions`): `const branchGod = tenGodOf(dayStem, h.stem);`
- **第 329 行** (`isGodRevealed`): `const stemGod = tenGodOf(dayStem, pillar.stem);`

**结论**：这三个函数都有同样的问题。

---

## 影响范围

### 受影响的函数
1. `isGodRevealed` - 检查十神是否透干
2. `getShishenPositions` - 获取十神在四柱中的位置信息

### 受影响的模块
- `purity.js` - 纯度计算（调用 `isGodRevealed`）
- `structure.js` - 格局判断（可能间接影响）
- 所有依赖这些函数的分析模块

### 测试结果
- ❌ **创建命盘失败**：引擎进程异常退出 (code 1)
- ❌ **无法完成测试**：无法验证后续流程

---

## 修复方案（仅分析，不实施）

### 方案 1：在函数内直接使用 `tenGod`
```javascript
// 修改前
const stemGod = tenGodOf(dayStem, pillar.stem);

// 修改后
const stemGod = tenGod(dayStem, pillar.stem);
```

### 方案 2：在文件顶部导入 `tenGodOf`（如果支持自引用）
```javascript
// 在文件顶部添加
import { tenGodOf } from './utils.js'; // 但这样会有循环依赖问题
```

### 方案 3：在函数内导入（推荐）
```javascript
export async function isGodRevealed(pillars, targetGod, dayStem) {
  const { tenGod } = await import('../mingli/shishen.js');
  // 或直接使用已导入的 tenGod
  const stemGod = tenGod(dayStem, pillar.stem);
}
```

**推荐方案**：方案 1（最简单直接）

---

## 其他潜在问题

### 1. 数据关联问题（CHART_NOT_FOUND）

**可能原因**：
- `chart_profiles` 和 `bazi_charts` 的关联关系
- `getChartDetail` 查询使用 `JOIN`，如果 `chartId` 不存在或 `userId` 不匹配会返回 404

**查询逻辑**：
```sql
SELECT bc.*, cp.* 
FROM bazi_charts bc
JOIN chart_profiles cp ON bc.chart_profile_id = cp.chart_profile_id
WHERE bc.chart_id = ? AND cp.user_id = ?
```

**潜在问题**：
- 如果 `chart_profiles` 中有记录，但 `bazi_charts` 中没有对应记录（LEFT JOIN 返回 null）
- `CasesScreen` 返回的 `profile.chartId` 可能为 `undefined`（见 `mapChartProfile` 第 99 行）

### 2. 数据不一致

**检查点**：
- `chart_profiles` 表中的 `chart_id` 字段（如果存在）
- `bazi_charts` 表中的 `chart_profile_id` 字段
- 两者之间的关联关系是否正确

---

## 测试建议

### 1. 修复引擎错误后
- ✅ 重新运行完整测试流程
- ✅ 验证八字计算结果
- ✅ 验证神煞数据完整性
- ✅ 验证命盘列表和详情的一致性

### 2. 数据一致性检查
- 检查数据库中 `chart_profiles` 和 `bazi_charts` 的关联
- 验证 `chartId` 和 `profileId` 的对应关系
- 检查是否有孤立数据（profile 存在但 chart 不存在）

---

## 总结

### 当前状态
- ❌ **引擎错误**：`tenGodOf is not defined`（阻止命盘创建）
- ⚠️ **数据关联**：可能存在 `CHART_NOT_FOUND` 问题（需要进一步验证）

### 优先级
1. **P0**：修复 `tenGodOf` 未定义错误（阻止所有命盘计算）
2. **P1**：验证数据关联关系（影响命盘详情查询）

### 测试命盘（请记住）
- **日期**: 2024年1月1日
- **时间**: 早上10点
- **性别**: 女
- **历法**: 公历





